<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc version="1.3" reference="TodoLists.TodoListMacro" locale="">
  <web>TodoLists</web>
  <name>TodoListMacro</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1388527200000</creationDate>
  <parent>TodoLists.WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <date>1388527200000</date>
  <contentUpdateDate>1388527200000</contentUpdateDate>
  <version>1.1</version>
  <title>Todolist Macro</title>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>
Macro to display todo-lists using emberjs. This code is based on the emberjs demo. You can see an example below

{{todolist width="50%" center="1" }}
Install todolists extension|1
Try todo list demo|0
Create a todo list|0
Close on tasks on this todo list|0
{{/todolist}}</content>
  <attachment>
    <filename>ember-data.js</filename>
    <author>XWiki.Admin</author>
    <date>1498975668000</date>
    <version>1.1</version>
    <comment/>
    <content>LyohCiAqIEBvdmVydmlldyAgRW1iZXIgRGF0YQogKiBAY29weXJpZ2h0IENvcHlyaWdodCAyMDExLTIwMTQgVGlsZGUgSW5jLiBhbmQgY29udHJpYnV0b3JzLgogKiAgICAgICAgICAgIFBvcnRpb25zIENvcHlyaWdodCAyMDExIExpdmluZ1NvY2lhbCBJbmMuCiAqIEBsaWNlbnNlICAgTGljZW5zZWQgdW5kZXIgTUlUIGxpY2Vuc2UgKHNlZSBsaWNlbnNlLmpzKQogKiBAdmVyc2lvbiAgIDEuMC4wLWJldGEuNQogKi8KCgooZnVuY3Rpb24oKSB7CnZhciBkZWZpbmUsIHJlcXVpcmVNb2R1bGU7CgooZnVuY3Rpb24oKSB7CiAgdmFyIHJlZ2lzdHJ5ID0ge30sIHNlZW4gPSB7fTsKCiAgZGVmaW5lID0gZnVuY3Rpb24obmFtZSwgZGVwcywgY2FsbGJhY2spIHsKICAgIHJlZ2lzdHJ5W25hbWVdID0geyBkZXBzOiBkZXBzLCBjYWxsYmFjazogY2FsbGJhY2sgfTsKICB9OwoKICByZXF1aXJlTW9kdWxlID0gZnVuY3Rpb24obmFtZSkgewogICAgaWYgKHNlZW5bbmFtZV0pIHsgcmV0dXJuIHNlZW5bbmFtZV07IH0KICAgIHNlZW5bbmFtZV0gPSB7fTsKCiAgICB2YXIgbW9kLCBkZXBzLCBjYWxsYmFjaywgcmVpZmllZCAsIGV4cG9ydHM7CgogICAgbW9kID0gcmVnaXN0cnlbbmFtZV07CgogICAgaWYgKCFtb2QpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJNb2R1bGUgJyIgKyBuYW1lICsgIicgbm90IGZvdW5kLiIpOwogICAgfQoKICAgIGRlcHMgPSBtb2QuZGVwczsKICAgIGNhbGxiYWNrID0gbW9kLmNhbGxiYWNrOwogICAgcmVpZmllZCA9IFtdOwogICAgZXhwb3J0czsKCiAgICBmb3IgKHZhciBpPTAsIGw9ZGVwcy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgIGlmIChkZXBzW2ldID09PSAnZXhwb3J0cycpIHsKICAgICAgICByZWlmaWVkLnB1c2goZXhwb3J0cyA9IHt9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZWlmaWVkLnB1c2gocmVxdWlyZU1vZHVsZShkZXBzW2ldKSk7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgdmFsdWUgPSBjYWxsYmFjay5hcHBseSh0aGlzLCByZWlmaWVkKTsKICAgIHJldHVybiBzZWVuW25hbWVdID0gZXhwb3J0cyB8fCB2YWx1ZTsKICB9Owp9KSgpOwooZnVuY3Rpb24oKSB7Ci8qKgogIEBtb2R1bGUgZW1iZXItZGF0YQoqLwoKLyoqCiAgQWxsIEVtYmVyIERhdGEgbWV0aG9kcyBhbmQgZnVuY3Rpb25zIGFyZSBkZWZpbmVkIGluc2lkZSBvZiB0aGlzIG5hbWVzcGFjZS4KCiAgQGNsYXNzIERTCiAgQHN0YXRpYwoqLwp2YXIgRFM7CmlmICgndW5kZWZpbmVkJyA9PT0gdHlwZW9mIERTKSB7CiAgLyoqCiAgICBAcHJvcGVydHkgVkVSU0lPTgogICAgQHR5cGUgU3RyaW5nCiAgICBAZGVmYXVsdCAnMS4wLjAtYmV0YS41JwogICAgQHN0YXRpYwogICovCiAgRFMgPSBFbWJlci5OYW1lc3BhY2UuY3JlYXRlKHsKICAgIFZFUlNJT046ICcxLjAuMC1iZXRhLjUnCiAgfSk7CgogIGlmICgndW5kZWZpbmVkJyAhPT0gdHlwZW9mIHdpbmRvdykgewogICAgd2luZG93LkRTID0gRFM7CiAgfQoKICBpZiAoRW1iZXIubGlicmFyaWVzKSB7CiAgICBFbWJlci5saWJyYXJpZXMucmVnaXN0ZXJDb3JlTGlicmFyeSgnRW1iZXIgRGF0YScsIERTLlZFUlNJT04pOwogIH0KfQoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQsIGlzTm9uZSA9IEVtYmVyLmlzTm9uZTsKCi8vIFNpbXBsZSBkaXNwYXRjaGVyIHRvIHN1cHBvcnQgb3ZlcnJpZGluZyB0aGUgYWxpYXNlZAovLyBtZXRob2QgaW4gc3ViY2xhc3Nlcy4KZnVuY3Rpb24gYWxpYXNNZXRob2QobWV0aG9kTmFtZSkgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzW21ldGhvZE5hbWVdLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKfQoKLyoqCiAgSW4gRW1iZXIgRGF0YSBhIFNlcmlhbGl6ZXIgaXMgdXNlZCB0byBzZXJpYWxpemUgYW5kIGRlc2VyaWFsaXplCiAgcmVjb3JkcyB3aGVuIHRoZXkgYXJlIHRyYW5zZmVyZWQgaW4gYW5kIG91dCBvZiBhbiBleHRlcm5hbCBzb3VyY2UuCiAgVGhpcyBwcm9jZXNzIGludm9sdmVzIG5vcm1hbGl6aW5nIHByb3BlcnR5IG5hbWVzLCB0cmFuc2Zvcm1pbmcKICBhdHRyaWJ1dGUgdmFsdWVzIGFuZCBzZXJpYWxpemVpbmcgcmVsYXRpb25zaGlwcy4KCiAgRm9yIG1heGltdW0gcGVyZm9ybWFuY2UgRW1iZXIgRGF0YSByZWNvbWVuZHMgeW91IHVzZSB0aGUKICBbUkVTVFNlcmlhbGl6ZXJdKERTLlJFU1RTZXJpYWxpemVyLmh0bWwpIG9yIG9uZSBvZiBpdHMgc3ViY2xhc3Nlcy4KCiAgYEpTT05TZXJpYWxpemVyYCBpcyB1c2VmdWwgZm9yIHNpbXBsZXIgb3IgbGVnYWN5IGJhY2tlbmRzIHRoYXQgbWF5CiAgbm90IHN1cHBvcnQgdGhlIGh0dHA6Ly9qc29uYXBpLm9yZy8gc3BlYy4KCiAgQGNsYXNzIEpTT05TZXJpYWxpemVyCiAgQG5hbWVzcGFjZSBEUwoqLwpEUy5KU09OU2VyaWFsaXplciA9IEVtYmVyLk9iamVjdC5leHRlbmQoewogIC8qKgogICAgVGhlIHByaW1hcnlLZXkgaXMgdXNlZCB3aGVuIHNlcmlhbGl6aW5nIGFuZCBkZXNlcmlhbGl6aW5nCiAgICBkYXRhLiBFbWJlciBEYXRhIGFsd2F5cyB1c2VzIHRoZSBgaWRgIHByb3BlcnkgdG8gc3RvcmUgdGhlIGlkIG9mCiAgICB0aGUgcmVjb3JkLiBUaGUgZXh0ZXJuYWwgc291cmNlIG1heSBub3QgYWx3YXlzIGZvbGxvdyB0aGlzCiAgICBjb252ZW50aW9uLiBJbiB0aGVzZSBjYXNlcyBpdCBpcyB1c2VzZnVsIHRvIG92ZXJyaWRlIHRoZQogICAgcHJpbWFyeUtleSBwcm9wZXJ0eSB0byBtYXRjaCB0aGUgcHJpbWFyeUtleSBvZiB5b3VyIGV4dGVybmFsCiAgICBzdG9yZS4KCiAgICBFeGFtcGxlCgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLkFwcGxpY2F0aW9uU2VyaWFsaXplciA9IERTLkpTT05TZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgIHByaW1hcnlLZXk6ICdfaWQnCiAgICB9KTsKICAgIGBgYAoKICAgIEBwcm9wZXJ0eSBwcmltYXJ5S2V5CiAgICBAdHlwZSB7U3RyaW5nfQogICAgQGRlZmF1bHQgJ2lkJwogICovCiAgcHJpbWFyeUtleTogJ2lkJywKCiAgLyoqCiAgIEdpdmVuIGEgc3ViY2xhc3Mgb2YgYERTLk1vZGVsYCBhbmQgYSBKU09OIG9iamVjdCB0aGlzIG1ldGhvZCB3aWxsCiAgIGl0ZXJhdGUgdGhyb3VnaCBlYWNoIGF0dHJpYnV0ZSBvZiB0aGUgYERTLk1vZGVsYCBhbmQgaW52b2tlIHRoZQogICBgRFMuVHJhbnNmb3JtI2Rlc2VyaWFsaXplYCBtZXRob2Qgb24gdGhlIG1hdGNoaW5nIHByb3BlcnR5IG9mIHRoZQogICBKU09OIG9iamVjdC4gIFRoaXMgbWV0aG9kIGlzIHR5cGljYWxseSBjYWxsZWQgYWZ0ZXIgdGhlCiAgIHNlcmlhbGl6ZXIncyBgbm9ybWFsaXplYCBtZXRob2QuCgogICBAbWV0aG9kIGFwcGx5VHJhbnNmb3JtcwogICBAcHJpdmF0ZQogICBAcGFyYW0ge3N1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgIEBwYXJhbSB7T2JqZWN0fSBkYXRhIFRoZSBkYXRhIHRvIHRyYW5zZm9ybQogICBAcmV0dXJuIHtPYmplY3R9IGRhdGEgVGhlIHRyYW5zZm9ybWVkIGRhdGEgb2JqZWN0CiAgKi8KICBhcHBseVRyYW5zZm9ybXM6IGZ1bmN0aW9uKHR5cGUsIGRhdGEpIHsKICAgIHR5cGUuZWFjaFRyYW5zZm9ybWVkQXR0cmlidXRlKGZ1bmN0aW9uKGtleSwgdHlwZSkgewogICAgICB2YXIgdHJhbnNmb3JtID0gdGhpcy50cmFuc2Zvcm1Gb3IodHlwZSk7CiAgICAgIGRhdGFba2V5XSA9IHRyYW5zZm9ybS5kZXNlcmlhbGl6ZShkYXRhW2tleV0pOwogICAgfSwgdGhpcyk7CgogICAgcmV0dXJuIGRhdGE7CiAgfSwKCiAgLyoqCiAgICBOb3JtYWxpemVzIGEgcGFydCBvZiB0aGUgSlNPTiBwYXlsb2FkIHJldHVybmVkIGJ5CiAgICB0aGUgc2VydmVyLiBZb3Ugc2hvdWxkIG92ZXJyaWRlIHRoaXMgbWV0aG9kLCBtdW5nZSB0aGUgaGFzaAogICAgYW5kIGNhbGwgc3VwZXIgaWYgeW91IGhhdmUgZ2VuZXJpYyBub3JtYWxpemF0aW9uIHRvIGRvLgoKICAgIEl0IHRha2VzIHRoZSB0eXBlIG9mIHRoZSByZWNvcmQgdGhhdCBpcyBiZWluZyBub3JtYWxpemVkCiAgICAoYXMgYSBEUy5Nb2RlbCBjbGFzcyksIHRoZSBwcm9wZXJ0eSB3aGVyZSB0aGUgaGFzaCB3YXMKICAgIG9yaWdpbmFsbHkgZm91bmQsIGFuZCB0aGUgaGFzaCB0byBub3JtYWxpemUuCgogICAgWW91IGNhbiB1c2UgdGhpcyBtZXRob2QsIGZvciBleGFtcGxlLCB0byBub3JtYWxpemUgdW5kZXJzY29yZWQga2V5cyB0byBjYW1lbGl6ZWQKICAgIG9yIG90aGVyIGdlbmVyYWwtcHVycG9zZSBub3JtYWxpemF0aW9ucy4KCiAgICBFeGFtcGxlCgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLkFwcGxpY2F0aW9uU2VyaWFsaXplciA9IERTLkpTT05TZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgIG5vcm1hbGl6ZTogZnVuY3Rpb24odHlwZSwgaGFzaCkgewogICAgICAgIHZhciBmaWVsZHMgPSBFbWJlci5nZXQodHlwZSwgJ2ZpZWxkcycpOwogICAgICAgIGZpZWxkcy5mb3JFYWNoKGZ1bmN0aW9uKGZpZWxkKSB7CiAgICAgICAgICB2YXIgcGF5bG9hZEZpZWxkID0gRW1iZXIuU3RyaW5nLnVuZGVyc2NvcmUoZmllbGQpOwogICAgICAgICAgaWYgKGZpZWxkID09PSBwYXlsb2FkRmllbGQpIHsgcmV0dXJuOyB9CgogICAgICAgICAgaGFzaFtmaWVsZF0gPSBoYXNoW3BheWxvYWRGaWVsZF07CiAgICAgICAgICBkZWxldGUgaGFzaFtwYXlsb2FkRmllbGRdOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgIEBtZXRob2Qgbm9ybWFsaXplCiAgICBAcGFyYW0ge3N1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgICBAcGFyYW0ge09iamVjdH0gaGFzaAogICAgQHJldHVybiB7T2JqZWN0fQogICovCiAgbm9ybWFsaXplOiBmdW5jdGlvbih0eXBlLCBoYXNoKSB7CiAgICBpZiAoIWhhc2gpIHsgcmV0dXJuIGhhc2g7IH0KCiAgICB0aGlzLmFwcGx5VHJhbnNmb3Jtcyh0eXBlLCBoYXNoKTsKICAgIHJldHVybiBoYXNoOwogIH0sCgogIC8vIFNFUklBTElaRQogIC8qKgogICAgQ2FsbGVkIHdoZW4gYSByZWNvcmQgaXMgc2F2ZWQgaW4gb3JkZXIgdG8gY29udmVydCB0aGUKICAgIHJlY29yZCBpbnRvIEpTT04uCgogICAgQnkgZGVmYXVsdCwgaXQgY3JlYXRlcyBhIEpTT04gb2JqZWN0IHdpdGggYSBrZXkgZm9yCiAgICBlYWNoIGF0dHJpYnV0ZSBhbmQgYmVsb25nc1RvIHJlbGF0aW9uc2hpcC4KCiAgICBGb3IgZXhhbXBsZSwgY29uc2lkZXIgdGhpcyBtb2RlbDoKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuQ29tbWVudCA9IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgIHRpdGxlOiBEUy5hdHRyKCksCiAgICAgIGJvZHk6IERTLmF0dHIoKSwKCiAgICAgIGF1dGhvcjogRFMuYmVsb25nc1RvKCd1c2VyJykKICAgIH0pOwogICAgYGBgCgogICAgVGhlIGRlZmF1bHQgc2VyaWFsaXphdGlvbiB3b3VsZCBjcmVhdGUgYSBKU09OIG9iamVjdCBsaWtlOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIHsKICAgICAgInRpdGxlIjogIlJhaWxzIGlzIHVuYWdpIiwKICAgICAgImJvZHkiOiAiUmFpbHM/IE9tYWthc2U/IE9fTyIsCiAgICAgICJhdXRob3IiOiAxMgogICAgfQogICAgYGBgCgogICAgQnkgZGVmYXVsdCwgYXR0cmlidXRlcyBhcmUgcGFzc2VkIHRocm91Z2ggYXMtaXMsIHVubGVzcwogICAgeW91IHNwZWNpZmllZCBhbiBhdHRyaWJ1dGUgdHlwZSAoYERTLmF0dHIoJ2RhdGUnKWApLiBJZgogICAgeW91IHNwZWNpZnkgYSB0cmFuc2Zvcm0sIHRoZSBKYXZhU2NyaXB0IHZhbHVlIHdpbGwgYmUKICAgIHNlcmlhbGl6ZWQgd2hlbiBpbnNlcnRlZCBpbnRvIHRoZSBKU09OIGhhc2guCgogICAgQnkgZGVmYXVsdCwgYmVsb25ncy10byByZWxhdGlvbnNoaXBzIGFyZSBjb252ZXJ0ZWQgaW50bwogICAgSURzIHdoZW4gaW5zZXJ0ZWQgaW50byB0aGUgSlNPTiBoYXNoLgoKICAgICMjIElEcwoKICAgIGBzZXJpYWxpemVgIHRha2VzIGFuIG9wdGlvbnMgaGFzaCB3aXRoIGEgc2luZ2xlIG9wdGlvbjoKICAgIGBpbmNsdWRlSWRgLiBJZiB0aGlzIG9wdGlvbiBpcyBgdHJ1ZWAsIGBzZXJpYWxpemVgIHdpbGwsCiAgICBieSBkZWZhdWx0IGluY2x1ZGUgdGhlIElEIGluIHRoZSBKU09OIG9iamVjdCBpdCBidWlsZHMuCgogICAgVGhlIGFkYXB0ZXIgcGFzc2VzIGluIGBpbmNsdWRlSWQ6IHRydWVgIHdoZW4gc2VyaWFsaXppbmcKICAgIGEgcmVjb3JkIGZvciBgY3JlYXRlUmVjb3JkYCwgYnV0IG5vdCBmb3IgYHVwZGF0ZVJlY29yZGAuCgogICAgIyMgQ3VzdG9taXphdGlvbgoKICAgIFlvdXIgc2VydmVyIG1heSBleHBlY3QgYSBkaWZmZXJlbnQgSlNPTiBmb3JtYXQgdGhhbiB0aGUKICAgIGJ1aWx0LWluIHNlcmlhbGl6YXRpb24gZm9ybWF0LgoKICAgIEluIHRoYXQgY2FzZSwgeW91IGNhbiBpbXBsZW1lbnQgYHNlcmlhbGl6ZWAgeW91cnNlbGYgYW5kCiAgICByZXR1cm4gYSBKU09OIGhhc2ggb2YgeW91ciBjaG9vc2luZy4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuUG9zdFNlcmlhbGl6ZXIgPSBEUy5KU09OU2VyaWFsaXplci5leHRlbmQoewogICAgICBzZXJpYWxpemU6IGZ1bmN0aW9uKHBvc3QsIG9wdGlvbnMpIHsKICAgICAgICB2YXIganNvbiA9IHsKICAgICAgICAgIFBPU1RfVFRMOiBwb3N0LmdldCgndGl0bGUnKSwKICAgICAgICAgIFBPU1RfQkRZOiBwb3N0LmdldCgnYm9keScpLAogICAgICAgICAgUE9TVF9DTVM6IHBvc3QuZ2V0KCdjb21tZW50cycpLm1hcFByb3BlcnR5KCdpZCcpCiAgICAgICAgfQoKICAgICAgICBpZiAob3B0aW9ucy5pbmNsdWRlSWQpIHsKICAgICAgICAgIGpzb24uUE9TVF9JRF8gPSBwb3N0LmdldCgnaWQnKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBqc29uOwogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgICMjIEN1c3RvbWl6aW5nIGFuIEFwcC1XaWRlIFNlcmlhbGl6ZXIKCiAgICBJZiB5b3Ugd2FudCB0byBkZWZpbmUgYSBzZXJpYWxpemVyIGZvciB5b3VyIGVudGlyZQogICAgYXBwbGljYXRpb24sIHlvdSdsbCBwcm9iYWJseSB3YW50IHRvIHVzZSBgZWFjaEF0dHJpYnV0ZWAKICAgIGFuZCBgZWFjaFJlbGF0aW9uc2hpcGAgb24gdGhlIHJlY29yZC4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuQXBwbGljYXRpb25TZXJpYWxpemVyID0gRFMuSlNPTlNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgc2VyaWFsaXplOiBmdW5jdGlvbihyZWNvcmQsIG9wdGlvbnMpIHsKICAgICAgICB2YXIganNvbiA9IHt9OwoKICAgICAgICByZWNvcmQuZWFjaEF0dHJpYnV0ZShmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBqc29uW3NlcnZlckF0dHJpYnV0ZU5hbWUobmFtZSldID0gcmVjb3JkLmdldChuYW1lKTsKICAgICAgICB9KQoKICAgICAgICByZWNvcmQuZWFjaFJlbGF0aW9uc2hpcChmdW5jdGlvbihuYW1lLCByZWxhdGlvbnNoaXApIHsKICAgICAgICAgIGlmIChyZWxhdGlvbnNoaXAua2luZCA9PT0gJ2hhc01hbnknKSB7CiAgICAgICAgICAgIGpzb25bc2VydmVySGFzTWFueU5hbWUobmFtZSldID0gcmVjb3JkLmdldChuYW1lKS5tYXBCeSgnaWQnKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgaWYgKG9wdGlvbnMuaW5jbHVkZUlkKSB7CiAgICAgICAgICBqc29uLklEXyA9IHJlY29yZC5nZXQoJ2lkJyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4ganNvbjsKICAgICAgfQogICAgfSk7CgogICAgZnVuY3Rpb24gc2VydmVyQXR0cmlidXRlTmFtZShhdHRyaWJ1dGUpIHsKICAgICAgcmV0dXJuIGF0dHJpYnV0ZS51bmRlcnNjb3JlKCkudG9VcHBlckNhc2UoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXJ2ZXJIYXNNYW55TmFtZShuYW1lKSB7CiAgICAgIHJldHVybiBzZXJ2ZXJBdHRyaWJ1dGVOYW1lKG5hbWUuc2luZ3VsYXJpemUoKSkgKyAiX0lEUyI7CiAgICB9CiAgICBgYGAKCiAgICBUaGlzIHNlcmlhbGl6ZXIgd2lsbCBnZW5lcmF0ZSBKU09OIHRoYXQgbG9va3MgbGlrZSB0aGlzOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIHsKICAgICAgIlRJVExFIjogIlJhaWxzIGlzIG9tYWthc2UiLAogICAgICAiQk9EWSI6ICJZZXAuIE9tYWthc2UuIiwKICAgICAgIkNPTU1FTlRfSURTIjogWyAxLCAyLCAzIF0KICAgIH0KICAgIGBgYAoKICAgICMjIFR3ZWFraW5nIHRoZSBEZWZhdWx0IEpTT04KCiAgICBJZiB5b3UganVzdCB3YW50IHRvIGRvIHNvbWUgc21hbGwgdHdlYWtzIG9uIHRoZSBkZWZhdWx0IEpTT04sCiAgICB5b3UgY2FuIGNhbGwgc3VwZXIgZmlyc3QgYW5kIG1ha2UgdGhlIHR3ZWFrcyBvbiB0aGUgcmV0dXJuZWQKICAgIEpTT04uCgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLlBvc3RTZXJpYWxpemVyID0gRFMuSlNPTlNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgc2VyaWFsaXplOiBmdW5jdGlvbihyZWNvcmQsIG9wdGlvbnMpIHsKICAgICAgICB2YXIganNvbiA9IHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgIGpzb24uc3ViamVjdCA9IGpzb24udGl0bGU7CiAgICAgICAgZGVsZXRlIGpzb24udGl0bGU7CgogICAgICAgIHJldHVybiBqc29uOwogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgIEBtZXRob2Qgc2VyaWFsaXplCiAgICBAcGFyYW0ge3N1YmNsYXNzIG9mIERTLk1vZGVsfSByZWNvcmQKICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICBAcmV0dXJuIHtPYmplY3R9IGpzb24KICAqLwogIHNlcmlhbGl6ZTogZnVuY3Rpb24ocmVjb3JkLCBvcHRpb25zKSB7CiAgICB2YXIganNvbiA9IHt9OwoKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuaW5jbHVkZUlkKSB7CiAgICAgIHZhciBpZCA9IGdldChyZWNvcmQsICdpZCcpOwoKICAgICAgaWYgKGlkKSB7CiAgICAgICAganNvbltnZXQodGhpcywgJ3ByaW1hcnlLZXknKV0gPSBpZDsKICAgICAgfQogICAgfQoKICAgIHJlY29yZC5lYWNoQXR0cmlidXRlKGZ1bmN0aW9uKGtleSwgYXR0cmlidXRlKSB7CiAgICAgIHRoaXMuc2VyaWFsaXplQXR0cmlidXRlKHJlY29yZCwganNvbiwga2V5LCBhdHRyaWJ1dGUpOwogICAgfSwgdGhpcyk7CgogICAgcmVjb3JkLmVhY2hSZWxhdGlvbnNoaXAoZnVuY3Rpb24oa2V5LCByZWxhdGlvbnNoaXApIHsKICAgICAgaWYgKHJlbGF0aW9uc2hpcC5raW5kID09PSAnYmVsb25nc1RvJykgewogICAgICAgIHRoaXMuc2VyaWFsaXplQmVsb25nc1RvKHJlY29yZCwganNvbiwgcmVsYXRpb25zaGlwKTsKICAgICAgfSBlbHNlIGlmIChyZWxhdGlvbnNoaXAua2luZCA9PT0gJ2hhc01hbnknKSB7CiAgICAgICAgdGhpcy5zZXJpYWxpemVIYXNNYW55KHJlY29yZCwganNvbiwgcmVsYXRpb25zaGlwKTsKICAgICAgfQogICAgfSwgdGhpcyk7CgogICAgcmV0dXJuIGpzb247CiAgfSwKCiAgLyoqCiAgIGBzZXJpYWxpemVBdHRyaWJ1dGVgIGNhbiBiZSB1c2VkIHRvIGN1c3RvbWl6ZSBob3cgYERTLmF0dHJgCiAgIHByb3BlcnRpZXMgYXJlIHNlcmlhbGl6ZWQKCiAgIEZvciBleGFtcGxlIGlmIHlvdSB3YW50ZWQgdG8gZW5zdXJlIGFsbCB5b3UgYXR0cmlidXRlcyB3ZXJlIGFsd2F5cwogICBzZXJpYWxpemVkIGFzIHByb3BlcnRpZXMgb24gYW4gYGF0dHJpYnV0ZXNgIG9iamVjdCB5b3UgY291bGQKICAgd3JpdGU6CgogICBgYGBqYXZhc2NyaXB0CiAgIEFwcC5BcHBsaWNhdGlvblNlcmlhbGl6ZXIgPSBEUy5KU09OU2VyaWFsaXplci5leHRlbmQoewogICAgIHNlcmlhbGl6ZUF0dHJpYnV0ZTogZnVuY3Rpb24ocmVjb3JkLCBqc29uLCBrZXksIGF0dHJpYnV0ZXMpIHsKICAgICAgIGpzb24uYXR0cmlidXRlcyA9IGpzb24uYXR0cmlidXRlcyB8fCB7fTsKICAgICAgIHRoaXMuX3N1cGVyKHJlY29yZCwganNvbi5hdHRyaWJ1dGVzLCBrZXksIGF0dHJpYnV0ZXMpOwogICAgIH0KICAgfSk7CiAgIGBgYAoKICAgQG1ldGhvZCBzZXJpYWxpemVBdHRyaWJ1dGUKICAgQHBhcmFtIHtEUy5Nb2RlbH0gcmVjb3JkCiAgIEBwYXJhbSB7T2JqZWN0fSBqc29uCiAgIEBwYXJhbSB7U3RyaW5nfSBrZXkKICAgQHBhcmFtIHtPYmplY3R9IGF0dHJpYnV0ZQogICovCiAgc2VyaWFsaXplQXR0cmlidXRlOiBmdW5jdGlvbihyZWNvcmQsIGpzb24sIGtleSwgYXR0cmlidXRlKSB7CiAgICB2YXIgYXR0cnMgPSBnZXQodGhpcywgJ2F0dHJzJyk7CiAgICB2YXIgdmFsdWUgPSBnZXQocmVjb3JkLCBrZXkpLCB0eXBlID0gYXR0cmlidXRlLnR5cGU7CgogICAgaWYgKHR5cGUpIHsKICAgICAgdmFyIHRyYW5zZm9ybSA9IHRoaXMudHJhbnNmb3JtRm9yKHR5cGUpOwogICAgICB2YWx1ZSA9IHRyYW5zZm9ybS5zZXJpYWxpemUodmFsdWUpOwogICAgfQoKICAgIC8vIGlmIHByb3ZpZGVkLCB1c2UgdGhlIG1hcHBpbmcgcHJvdmlkZWQgYnkgYGF0dHJzYCBpbgogICAgLy8gdGhlIHNlcmlhbGl6ZXIKICAgIGtleSA9IGF0dHJzICYmIGF0dHJzW2tleV0gfHwgKHRoaXMua2V5Rm9yQXR0cmlidXRlID8gdGhpcy5rZXlGb3JBdHRyaWJ1dGUoa2V5KSA6IGtleSk7CgogICAganNvbltrZXldID0gdmFsdWU7CiAgfSwKCiAgLyoqCiAgIGBzZXJpYWxpemVCZWxvbmdzVG9gIGNhbiBiZSB1c2VkIHRvIGN1c3RvbWl6ZSBob3cgYERTLmJlbG9uZ3NUb2AKICAgcHJvcGVydGllcyBhcmUgc2VyaWFsaXplZC4KCiAgIEV4YW1wbGUKCiAgIGBgYGphdmFzY3JpcHQKICAgQXBwLlBvc3RTZXJpYWxpemVyID0gRFMuSlNPTlNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICBzZXJpYWxpemVCZWxvbmdzVG86IGZ1bmN0aW9uKHJlY29yZCwganNvbiwgcmVsYXRpb25zaGlwKSB7CiAgICAgICB2YXIga2V5ID0gcmVsYXRpb25zaGlwLmtleTsKCiAgICAgICB2YXIgYmVsb25nc1RvID0gZ2V0KHJlY29yZCwga2V5KTsKCiAgICAgICBrZXkgPSB0aGlzLmtleUZvclJlbGF0aW9uc2hpcCA/IHRoaXMua2V5Rm9yUmVsYXRpb25zaGlwKGtleSwgImJlbG9uZ3NUbyIpIDoga2V5OwoKICAgICAgIGpzb25ba2V5XSA9IEVtYmVyLmlzTm9uZShiZWxvbmdzVG8pID8gYmVsb25nc1RvIDogYmVsb25nc1RvLnRvSlNPTigpOwogICAgIH0KICAgfSk7CiAgIGBgYAoKICAgQG1ldGhvZCBzZXJpYWxpemVCZWxvbmdzVG8KICAgQHBhcmFtIHtEUy5Nb2RlbH0gcmVjb3JkCiAgIEBwYXJhbSB7T2JqZWN0fSBqc29uCiAgIEBwYXJhbSB7T2JqZWN0fSByZWxhdGlvbnNoaXAKICAqLwogIHNlcmlhbGl6ZUJlbG9uZ3NUbzogZnVuY3Rpb24ocmVjb3JkLCBqc29uLCByZWxhdGlvbnNoaXApIHsKICAgIHZhciBrZXkgPSByZWxhdGlvbnNoaXAua2V5OwoKICAgIHZhciBiZWxvbmdzVG8gPSBnZXQocmVjb3JkLCBrZXkpOwoKICAgIGtleSA9IHRoaXMua2V5Rm9yUmVsYXRpb25zaGlwID8gdGhpcy5rZXlGb3JSZWxhdGlvbnNoaXAoa2V5LCAiYmVsb25nc1RvIikgOiBrZXk7CgogICAgaWYgKGlzTm9uZShiZWxvbmdzVG8pKSB7CiAgICAgIGpzb25ba2V5XSA9IGJlbG9uZ3NUbzsKICAgIH0gZWxzZSB7CiAgICAgIGpzb25ba2V5XSA9IGdldChiZWxvbmdzVG8sICdpZCcpOwogICAgfQoKICAgIGlmIChyZWxhdGlvbnNoaXAub3B0aW9ucy5wb2x5bW9ycGhpYykgewogICAgICB0aGlzLnNlcmlhbGl6ZVBvbHltb3JwaGljVHlwZShyZWNvcmQsIGpzb24sIHJlbGF0aW9uc2hpcCk7CiAgICB9CiAgfSwKCiAgLyoqCiAgIGBzZXJpYWxpemVIYXNNYW55YCBjYW4gYmUgdXNlZCB0byBjdXN0b21pemUgaG93IGBEUy5oYXNNYW55YAogICBwcm9wZXJ0aWVzIGFyZSBzZXJpYWxpemVkLgoKICAgRXhhbXBsZQoKICAgYGBgamF2YXNjcmlwdAogICBBcHAuUG9zdFNlcmlhbGl6ZXIgPSBEUy5KU09OU2VyaWFsaXplci5leHRlbmQoewogICAgIHNlcmlhbGl6ZUhhc01hbnk6IGZ1bmN0aW9uKHJlY29yZCwganNvbiwgcmVsYXRpb25zaGlwKSB7CiAgICAgICB2YXIga2V5ID0gcmVsYXRpb25zaGlwLmtleTsKICAgICAgIGlmIChrZXkgPT09ICdjb21tZW50cycpIHsKICAgICAgICAgcmV0dXJuOwogICAgICAgfSBlbHNlIHsKICAgICAgICAgdGhpcy5fc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgIH0KICAgICB9CiAgIH0pOwogICBgYGAKCiAgIEBtZXRob2Qgc2VyaWFsaXplSGFzTWFueQogICBAcGFyYW0ge0RTLk1vZGVsfSByZWNvcmQKICAgQHBhcmFtIHtPYmplY3R9IGpzb24KICAgQHBhcmFtIHtPYmplY3R9IHJlbGF0aW9uc2hpcAogICovCiAgc2VyaWFsaXplSGFzTWFueTogZnVuY3Rpb24ocmVjb3JkLCBqc29uLCByZWxhdGlvbnNoaXApIHsKICAgIHZhciBrZXkgPSByZWxhdGlvbnNoaXAua2V5OwoKICAgIHZhciByZWxhdGlvbnNoaXBUeXBlID0gRFMuUmVsYXRpb25zaGlwQ2hhbmdlLmRldGVybWluZVJlbGF0aW9uc2hpcFR5cGUocmVjb3JkLmNvbnN0cnVjdG9yLCByZWxhdGlvbnNoaXApOwoKICAgIGlmIChyZWxhdGlvbnNoaXBUeXBlID09PSAnbWFueVRvTm9uZScgfHwgcmVsYXRpb25zaGlwVHlwZSA9PT0gJ21hbnlUb01hbnknKSB7CiAgICAgIGpzb25ba2V5XSA9IGdldChyZWNvcmQsIGtleSkubWFwQnkoJ2lkJyk7CiAgICAgIC8vIFRPRE8gc3VwcG9ydCBmb3IgcG9seW1vcnBoaWMgbWFueVRvTm9uZSBhbmQgbWFueVRvTWFueSByZWxhdGlvbnNoaXBzCiAgICB9CiAgfSwKCiAgLyoqCiAgICBZb3UgY2FuIHVzZSB0aGlzIG1ldGhvZCB0byBjdXN0b21pemUgaG93IHBvbHltb3JwaGljIG9iamVjdHMgYXJlCiAgICBzZXJpYWxpemVkLiBPYmplY3RzIGFyZSBjb25zaWRlcmVkIHRvIGJlIHBvbHltb3JwaGljIGlmCiAgICBge3BvbHltb3JwaGljOiB0cnVlfWAgaXMgcGFzcyBhcyB0aGUgc2Vjb25kIGFyZ3VtZW50IHRvIHRoZQogICAgYERTLmJlbG9uZ3NUb2AgZnVuY3Rpb24uCgogICAgRXhhbXBsZQoKICAgIGBgYGphdmFzY3JpcHQKICAgIEFwcC5Db21tZW50U2VyaWFsaXplciA9IERTLkpTT05TZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgIHNlcmlhbGl6ZVBvbHltb3JwaGljVHlwZTogZnVuY3Rpb24ocmVjb3JkLCBqc29uLCByZWxhdGlvbnNoaXApIHsKICAgICAgICB2YXIga2V5ID0gcmVsYXRpb25zaGlwLmtleSwKICAgICAgICAgICAgYmVsb25nc1RvID0gZ2V0KHJlY29yZCwga2V5KTsKICAgICAgICBrZXkgPSB0aGlzLmtleUZvckF0dHJpYnV0ZSA/IHRoaXMua2V5Rm9yQXR0cmlidXRlKGtleSkgOiBrZXk7CiAgICAgICAganNvbltrZXkgKyAiX3R5cGUiXSA9IGJlbG9uZ3NUby5jb25zdHJ1Y3Rvci50eXBlS2V5OwogICAgICB9CiAgICB9KTsKICAgYGBgCgogICAgQG1ldGhvZCBzZXJpYWxpemVQb2x5bW9ycGhpY1R5cGUKICAgIEBwYXJhbSB7RFMuTW9kZWx9IHJlY29yZAogICAgQHBhcmFtIHtPYmplY3R9IGpzb24KICAgIEBwYXJhbSB7T2JqZWN0fSByZWxhdGlvbnNoaXAKICAqLwogIHNlcmlhbGl6ZVBvbHltb3JwaGljVHlwZTogRW1iZXIuSywKCiAgLy8gRVhUUkFDVAoKICAvKioKICAgIFRoZSBgZXh0cmFjdGAgbWV0aG9kIGlzIHVzZWQgdG8gZGVzZXJpYWxpemUgcGF5bG9hZCBkYXRhIGZyb20gdGhlCiAgICBzZXJ2ZXIuIEJ5IGRlZmF1bHQgdGhlIGBKU09OU2VyaWFsaXplcmAgZG9lcyBub3QgcHVzaCB0aGUgcmVjb3JkcwogICAgaW50byB0aGUgc3RvcmUuIEhvd2V2ZXIgcmVjb3JkcyB0aGF0IHN1YmNsYXNzIGBKU09OU2VyaWFsaXplcmAKICAgIHN1Y2ggYXMgdGhlIGBSRVNUU2VyaWFsaXplcmAgbWF5IHB1c2ggcmVjb3JkcyBpbnRvIHRoZSBzdG9yZSBhcwogICAgcGFydCBvZiB0aGUgZXh0cmFjdCBjYWxsLgoKICAgIFRoaXMgbWV0aG9kIGRlbGV0ZWdhdGVzIHRvIGEgbW9yZSBzcGVjaWZpYyBleHRyYWN0IG1ldGhvZCBiYXNlZCBvbgogICAgdGhlIGByZXF1ZXN0VHlwZWAuCgogICAgRXhhbXBsZQoKICAgIGBgYGphdmFzY3JpcHQKICAgIHZhciBnZXQgPSBFbWJlci5nZXQ7CiAgICBzb2NrZXQub24oJ21lc3NhZ2UnLCBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgIHZhciBtb2RlbE5hbWUgPSBtZXNzYWdlLm1vZGVsOwogICAgICB2YXIgZGF0YSA9IG1lc3NhZ2UuZGF0YTsKICAgICAgdmFyIHR5cGUgPSBzdG9yZS5tb2RlbEZvcihtb2RlbE5hbWUpOwogICAgICB2YXIgc2VyaWFsaXplciA9IHN0b3JlLnNlcmlhbGl6ZXJGb3IodHlwZS50eXBlS2V5KTsKICAgICAgdmFyIHJlY29yZCA9IHNlcmlhbGl6ZXIuZXh0cmFjdChzdG9yZSwgdHlwZSwgZGF0YSwgZ2V0KGRhdGEsICdpZCcpLCAnc2luZ2xlJyk7CiAgICAgIHN0b3JlLnB1c2gobW9kZWxOYW1lLCByZWNvcmQpOwogICAgfSk7CiAgICBgYGAKCiAgICBAbWV0aG9kIGV4dHJhY3QKICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICBAcGFyYW0ge3N1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgQHBhcmFtIHtTdHJpbmcgb3IgTnVtYmVyfSBpZAogICAgQHBhcmFtIHtTdHJpbmd9IHJlcXVlc3RUeXBlCiAgICBAcmV0dXJuIHtPYmplY3R9IGpzb24gVGhlIGRlc2VyaWFsaXplZCBwYXlsb2FkCiAgKi8KICBleHRyYWN0OiBmdW5jdGlvbihzdG9yZSwgdHlwZSwgcGF5bG9hZCwgaWQsIHJlcXVlc3RUeXBlKSB7CiAgICB0aGlzLmV4dHJhY3RNZXRhKHN0b3JlLCB0eXBlLCBwYXlsb2FkKTsKCiAgICB2YXIgc3BlY2lmaWNFeHRyYWN0ID0gImV4dHJhY3QiICsgcmVxdWVzdFR5cGUuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyByZXF1ZXN0VHlwZS5zdWJzdHIoMSk7CiAgICByZXR1cm4gdGhpc1tzcGVjaWZpY0V4dHJhY3RdKHN0b3JlLCB0eXBlLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUpOwogIH0sCgogIC8qKgogICAgYGV4dHJhY3RGaW5kQWxsYCBpcyBhIGhvb2sgaW50byB0aGUgZXh0cmFjdCBtZXRob2QgdXNlZCB3aGVuIGEKICAgIGNhbGwgaXMgbWFkZSB0byBgRFMuU3RvcmUjZmluZEFsbGAuIEJ5IGRlZmF1bHQgdGhpcyBtZXRob2QgaXMgYW4KICAgIGFsaWFzIGZvciBbZXh0cmFjdEFycmF5XSgjbWV0aG9kX2V4dHJhY3RBcnJheSkuCgogICAgQG1ldGhvZCBleHRyYWN0RmluZEFsbAogICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgIEBwYXJhbSB7c3ViY2xhc3Mgb2YgRFMuTW9kZWx9IHR5cGUKICAgIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICBAcmV0dXJuIHtBcnJheX0gYXJyYXkgQW4gYXJyYXkgb2YgZGVzZXJpYWxpemVkIG9iamVjdHMKICAqLwogIGV4dHJhY3RGaW5kQWxsOiBhbGlhc01ldGhvZCgnZXh0cmFjdEFycmF5JyksCiAgLyoqCiAgICBgZXh0cmFjdEZpbmRRdWVyeWAgaXMgYSBob29rIGludG8gdGhlIGV4dHJhY3QgbWV0aG9kIHVzZWQgd2hlbiBhCiAgICBjYWxsIGlzIG1hZGUgdG8gYERTLlN0b3JlI2ZpbmRRdWVyeWAuIEJ5IGRlZmF1bHQgdGhpcyBtZXRob2QgaXMgYW4KICAgIGFsaWFzIGZvciBbZXh0cmFjdEFycmF5XSgjbWV0aG9kX2V4dHJhY3RBcnJheSkuCgogICAgQG1ldGhvZCBleHRyYWN0RmluZFF1ZXJ5CiAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgQHBhcmFtIHtzdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICAgIEByZXR1cm4ge0FycmF5fSBhcnJheSBBbiBhcnJheSBvZiBkZXNlcmlhbGl6ZWQgb2JqZWN0cwogICovCiAgZXh0cmFjdEZpbmRRdWVyeTogYWxpYXNNZXRob2QoJ2V4dHJhY3RBcnJheScpLAogIC8qKgogICAgYGV4dHJhY3RGaW5kTWFueWAgaXMgYSBob29rIGludG8gdGhlIGV4dHJhY3QgbWV0aG9kIHVzZWQgd2hlbiBhCiAgICBjYWxsIGlzIG1hZGUgdG8gYERTLlN0b3JlI2ZpbmRNYW55YC4gQnkgZGVmYXVsdCB0aGlzIG1ldGhvZCBpcwogICAgYWxpYXMgZm9yIFtleHRyYWN0QXJyYXldKCNtZXRob2RfZXh0cmFjdEFycmF5KS4KCiAgICBAbWV0aG9kIGV4dHJhY3RGaW5kTWFueQogICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgIEBwYXJhbSB7c3ViY2xhc3Mgb2YgRFMuTW9kZWx9IHR5cGUKICAgIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICBAcmV0dXJuIHtBcnJheX0gYXJyYXkgQW4gYXJyYXkgb2YgZGVzZXJpYWxpemVkIG9iamVjdHMKICAqLwogIGV4dHJhY3RGaW5kTWFueTogYWxpYXNNZXRob2QoJ2V4dHJhY3RBcnJheScpLAogIC8qKgogICAgYGV4dHJhY3RGaW5kSGFzTWFueWAgaXMgYSBob29rIGludG8gdGhlIGV4dHJhY3QgbWV0aG9kIHVzZWQgd2hlbiBhCiAgICBjYWxsIGlzIG1hZGUgdG8gYERTLlN0b3JlI2ZpbmRIYXNNYW55YC4gQnkgZGVmYXVsdCB0aGlzIG1ldGhvZCBpcwogICAgYWxpYXMgZm9yIFtleHRyYWN0QXJyYXldKCNtZXRob2RfZXh0cmFjdEFycmF5KS4KCiAgICBAbWV0aG9kIGV4dHJhY3RGaW5kSGFzTWFueQogICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgIEBwYXJhbSB7c3ViY2xhc3Mgb2YgRFMuTW9kZWx9IHR5cGUKICAgIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICBAcmV0dXJuIHtBcnJheX0gYXJyYXkgQW4gYXJyYXkgb2YgZGVzZXJpYWxpemVkIG9iamVjdHMKICAqLwogIGV4dHJhY3RGaW5kSGFzTWFueTogYWxpYXNNZXRob2QoJ2V4dHJhY3RBcnJheScpLAoKICAvKioKICAgIGBleHRyYWN0Q3JlYXRlUmVjb3JkYCBpcyBhIGhvb2sgaW50byB0aGUgZXh0cmFjdCBtZXRob2QgdXNlZCB3aGVuIGEKICAgIGNhbGwgaXMgbWFkZSB0byBgRFMuU3RvcmUjY3JlYXRlUmVjb3JkYC4gQnkgZGVmYXVsdCB0aGlzIG1ldGhvZCBpcwogICAgYWxpYXMgZm9yIFtleHRyYWN0U2F2ZV0oI21ldGhvZF9leHRyYWN0U2F2ZSkuCgogICAgQG1ldGhvZCBleHRyYWN0Q3JlYXRlUmVjb3JkCiAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgQHBhcmFtIHtzdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICAgIEByZXR1cm4ge09iamVjdH0ganNvbiBUaGUgZGVzZXJpYWxpemVkIHBheWxvYWQKICAqLwogIGV4dHJhY3RDcmVhdGVSZWNvcmQ6IGFsaWFzTWV0aG9kKCdleHRyYWN0U2F2ZScpLAogIC8qKgogICAgYGV4dHJhY3RVcGRhdGVSZWNvcmRgIGlzIGEgaG9vayBpbnRvIHRoZSBleHRyYWN0IG1ldGhvZCB1c2VkIHdoZW4KICAgIGEgY2FsbCBpcyBtYWRlIHRvIGBEUy5TdG9yZSN1cGRhdGVgLiBCeSBkZWZhdWx0IHRoaXMgbWV0aG9kIGlzIGFsaWFzCiAgICBmb3IgW2V4dHJhY3RTYXZlXSgjbWV0aG9kX2V4dHJhY3RTYXZlKS4KCiAgICBAbWV0aG9kIGV4dHJhY3RVcGRhdGVSZWNvcmQKICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICBAcGFyYW0ge3N1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgQHJldHVybiB7T2JqZWN0fSBqc29uIFRoZSBkZXNlcmlhbGl6ZWQgcGF5bG9hZAogICovCiAgZXh0cmFjdFVwZGF0ZVJlY29yZDogYWxpYXNNZXRob2QoJ2V4dHJhY3RTYXZlJyksCiAgLyoqCiAgICBgZXh0cmFjdERlbGV0ZVJlY29yZGAgaXMgYSBob29rIGludG8gdGhlIGV4dHJhY3QgbWV0aG9kIHVzZWQgd2hlbgogICAgYSBjYWxsIGlzIG1hZGUgdG8gYERTLlN0b3JlI2RlbGV0ZVJlY29yZGAuIEJ5IGRlZmF1bHQgdGhpcyBtZXRob2QgaXMKICAgIGFsaWFzIGZvciBbZXh0cmFjdFNhdmVdKCNtZXRob2RfZXh0cmFjdFNhdmUpLgoKICAgIEBtZXRob2QgZXh0cmFjdERlbGV0ZVJlY29yZAogICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgIEBwYXJhbSB7c3ViY2xhc3Mgb2YgRFMuTW9kZWx9IHR5cGUKICAgIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICBAcmV0dXJuIHtPYmplY3R9IGpzb24gVGhlIGRlc2VyaWFsaXplZCBwYXlsb2FkCiAgKi8KICBleHRyYWN0RGVsZXRlUmVjb3JkOiBhbGlhc01ldGhvZCgnZXh0cmFjdFNhdmUnKSwKCiAgLyoqCiAgICBgZXh0cmFjdEZpbmRgIGlzIGEgaG9vayBpbnRvIHRoZSBleHRyYWN0IG1ldGhvZCB1c2VkIHdoZW4KICAgIGEgY2FsbCBpcyBtYWRlIHRvIGBEUy5TdG9yZSNmaW5kYC4gQnkgZGVmYXVsdCB0aGlzIG1ldGhvZCBpcwogICAgYWxpYXMgZm9yIFtleHRyYWN0U2luZ2xlXSgjbWV0aG9kX2V4dHJhY3RTaW5nbGUpLgoKICAgIEBtZXRob2QgZXh0cmFjdEZpbmQKICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICBAcGFyYW0ge3N1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgQHJldHVybiB7T2JqZWN0fSBqc29uIFRoZSBkZXNlcmlhbGl6ZWQgcGF5bG9hZAogICovCiAgZXh0cmFjdEZpbmQ6IGFsaWFzTWV0aG9kKCdleHRyYWN0U2luZ2xlJyksCiAgLyoqCiAgICBgZXh0cmFjdEZpbmRCZWxvbmdzVG9gIGlzIGEgaG9vayBpbnRvIHRoZSBleHRyYWN0IG1ldGhvZCB1c2VkIHdoZW4KICAgIGEgY2FsbCBpcyBtYWRlIHRvIGBEUy5TdG9yZSNmaW5kQmVsb25nc1RvYC4gQnkgZGVmYXVsdCB0aGlzIG1ldGhvZCBpcwogICAgYWxpYXMgZm9yIFtleHRyYWN0U2luZ2xlXSgjbWV0aG9kX2V4dHJhY3RTaW5nbGUpLgoKICAgIEBtZXRob2QgZXh0cmFjdEZpbmRCZWxvbmdzVG8KICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICBAcGFyYW0ge3N1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgQHJldHVybiB7T2JqZWN0fSBqc29uIFRoZSBkZXNlcmlhbGl6ZWQgcGF5bG9hZAogICovCiAgZXh0cmFjdEZpbmRCZWxvbmdzVG86IGFsaWFzTWV0aG9kKCdleHRyYWN0U2luZ2xlJyksCiAgLyoqCiAgICBgZXh0cmFjdFNhdmVgIGlzIGEgaG9vayBpbnRvIHRoZSBleHRyYWN0IG1ldGhvZCB1c2VkIHdoZW4gYSBjYWxsCiAgICBpcyBtYWRlIHRvIGBEUy5Nb2RlbCNzYXZlYC4gQnkgZGVmYXVsdCB0aGlzIG1ldGhvZCBpcyBhbGlhcwogICAgZm9yIFtleHRyYWN0U2luZ2xlXSgjbWV0aG9kX2V4dHJhY3RTaW5nbGUpLgoKICAgIEBtZXRob2QgZXh0cmFjdFNhdmUKICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICBAcGFyYW0ge3N1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgQHJldHVybiB7T2JqZWN0fSBqc29uIFRoZSBkZXNlcmlhbGl6ZWQgcGF5bG9hZAogICovCiAgZXh0cmFjdFNhdmU6IGFsaWFzTWV0aG9kKCdleHRyYWN0U2luZ2xlJyksCgogIC8qKgogICAgYGV4dHJhY3RTaW5nbGVgIGlzIHVzZWQgdG8gZGVzZXJpYWxpemUgYSBzaW5nbGUgcmVjb3JkIHJldHVybmVkCiAgICBmcm9tIHRoZSBhZGFwdGVyLgoKICAgIEV4YW1wbGUKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuUG9zdFNlcmlhbGl6ZXIgPSBEUy5KU09OU2VyaWFsaXplci5leHRlbmQoewogICAgICBleHRyYWN0U2luZ2xlOiBmdW5jdGlvbihzdG9yZSwgdHlwZSwgcGF5bG9hZCkgewogICAgICAgIHBheWxvYWQuY29tbWVudHMgPSBwYXlsb2FkLl9lbWJlZGRlZC5jb21tZW50OwogICAgICAgIGRlbGV0ZSBwYXlsb2FkLl9lbWJlZGRlZDsKCiAgICAgICAgcmV0dXJuIHRoaXMuX3N1cGVyKHN0b3JlLCB0eXBlLCBwYXlsb2FkKTsKICAgICAgfSwKICAgIH0pOwogICAgYGBgCgogICAgQG1ldGhvZCBleHRyYWN0U2luZ2xlCiAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgQHBhcmFtIHtzdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICAgIEByZXR1cm4ge09iamVjdH0ganNvbiBUaGUgZGVzZXJpYWxpemVkIHBheWxvYWQKICAqLwogIGV4dHJhY3RTaW5nbGU6IGZ1bmN0aW9uKHN0b3JlLCB0eXBlLCBwYXlsb2FkKSB7CiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemUodHlwZSwgcGF5bG9hZCk7CiAgfSwKCiAgLyoqCiAgICBgZXh0cmFjdEFycmF5YCBpcyB1c2VkIHRvIGRlc2VyaWFsaXplIGFuIGFycmF5IG9mIHJlY29yZHMKICAgIHJldHVybmVkIGZyb20gdGhlIGFkYXB0ZXIuCgogICAgRXhhbXBsZQoKICAgIGBgYGphdmFzY3JpcHQKICAgIEFwcC5Qb3N0U2VyaWFsaXplciA9IERTLkpTT05TZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgIGV4dHJhY3RBcnJheTogZnVuY3Rpb24oc3RvcmUsIHR5cGUsIHBheWxvYWQpIHsKICAgICAgICByZXR1cm4gcGF5bG9hZC5tYXAoZnVuY3Rpb24oanNvbikgewogICAgICAgICAgcmV0dXJuIHRoaXMuZXh0cmFjdFNpbmdsZShqc29uKTsKICAgICAgICB9LCB0aGlzKTsKICAgICAgfQogICAgfSk7CiAgICBgYGAKCiAgICBAbWV0aG9kIGV4dHJhY3RBcnJheQogICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgIEBwYXJhbSB7c3ViY2xhc3Mgb2YgRFMuTW9kZWx9IHR5cGUKICAgIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICBAcmV0dXJuIHtBcnJheX0gYXJyYXkgQW4gYXJyYXkgb2YgZGVzZXJpYWxpemVkIG9iamVjdHMKICAqLwogIGV4dHJhY3RBcnJheTogZnVuY3Rpb24oc3RvcmUsIHR5cGUsIHBheWxvYWQpIHsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZSh0eXBlLCBwYXlsb2FkKTsKICB9LAoKICAvKioKICAgIGBleHRyYWN0TWV0YWAgaXMgdXNlZCB0byBkZXNlcmlhbGl6ZSBhbnkgbWV0YSBpbmZvcm1hdGlvbiBpbiB0aGUKICAgIGFkYXB0ZXIgcGF5bG9hZC4gQnkgZGVmYXVsdCBFbWJlciBEYXRhIGV4cGVjdHMgbWV0YSBpbmZvcm1hdGlvbiB0bwogICAgYmUgbG9jYXRlZCBvbiB0aGUgYG1ldGFgIHByb3BlcnR5IG9mIHRoZSBwYXlsb2FkIG9iamVjdC4KCiAgICBFeGFtcGxlCgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLlBvc3RTZXJpYWxpemVyID0gRFMuSlNPTlNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgZXh0cmFjdE1ldGE6IGZ1bmN0aW9uKHN0b3JlLCB0eXBlLCBwYXlsb2FkKSB7CiAgICAgICAgaWYgKHBheWxvYWQgJiYgcGF5bG9hZC5fcGFnaW5hdGlvbikgewogICAgICAgICAgc3RvcmUubWV0YUZvclR5cGUodHlwZSwgcGF5bG9hZC5fcGFnaW5hdGlvbik7CiAgICAgICAgICBkZWxldGUgcGF5bG9hZC5fcGFnaW5hdGlvbjsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgQG1ldGhvZCBleHRyYWN0TWV0YQogICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgIEBwYXJhbSB7c3ViY2xhc3Mgb2YgRFMuTW9kZWx9IHR5cGUKICAgIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgKi8KICBleHRyYWN0TWV0YTogZnVuY3Rpb24oc3RvcmUsIHR5cGUsIHBheWxvYWQpIHsKICAgIGlmIChwYXlsb2FkICYmIHBheWxvYWQubWV0YSkgewogICAgICBzdG9yZS5tZXRhRm9yVHlwZSh0eXBlLCBwYXlsb2FkLm1ldGEpOwogICAgICBkZWxldGUgcGF5bG9hZC5tZXRhOwogICAgfQogIH0sCgogIC8qKgogICBga2V5Rm9yQXR0cmlidXRlYCBjYW4gYmUgdXNlZCB0byBkZWZpbmUgcnVsZXMgZm9yIGhvdyB0byBjb252ZXJ0IGFuCiAgIGF0dHJpYnV0ZSBuYW1lIGluIHlvdXIgbW9kZWwgdG8gYSBrZXkgaW4geW91ciBKU09OLgoKICAgRXhhbXBsZQoKICAgYGBgamF2YXNjcmlwdAogICBBcHAuQXBwbGljYXRpb25TZXJpYWxpemVyID0gRFMuUkVTVFNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICBrZXlGb3JBdHRyaWJ1dGU6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgIHJldHVybiBFbWJlci5TdHJpbmcudW5kZXJzY29yZShhdHRyKS50b1VwcGVyQ2FzZSgpOwogICAgIH0KICAgfSk7CiAgIGBgYAoKICAgQG1ldGhvZCBrZXlGb3JBdHRyaWJ1dGUKICAgQHBhcmFtIHtTdHJpbmd9IGtleQogICBAcmV0dXJuIHtTdHJpbmd9IG5vcm1hbGl6ZWQga2V5CiAgKi8KCgogIC8qKgogICBga2V5Rm9yUmVsYXRpb25zaGlwYCBjYW4gYmUgdXNlZCB0byBkZWZpbmUgYSBjdXN0b20ga2V5IHdoZW4KICAgc2VyaWFsaXplaW5nIHJlbGF0aW9uc2hpcCBwcm9wZXJ0aWVzLiBCeSBkZWZhdWx0IGBKU09OU2VyaWFsaXplcmAKICAgZG9lcyBub3QgcHJvdmlkZSBhbiBpbXBsZW1lbnRhdGlvbiBvZiB0aGlzIG1ldGhvZC4KCiAgIEV4YW1wbGUKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuUG9zdFNlcmlhbGl6ZXIgPSBEUy5KU09OU2VyaWFsaXplci5leHRlbmQoewogICAgICBrZXlGb3JSZWxhdGlvbnNoaXA6IGZ1bmN0aW9uKGtleSwgcmVsYXRpb25zaGlwKSB7CiAgICAgICAgIHJldHVybiAncmVsXycgKyBFbWJlci5TdHJpbmcudW5kZXJzY29yZShrZXkpOwogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgQG1ldGhvZCBrZXlGb3JSZWxhdGlvbnNoaXAKICAgQHBhcmFtIHtTdHJpbmd9IGtleQogICBAcGFyYW0ge1N0cmluZ30gcmVsYXRpb25zaGlwIHR5cGUKICAgQHJldHVybiB7U3RyaW5nfSBub3JtYWxpemVkIGtleQogICovCgogIC8vIEhFTFBFUlMKCiAgLyoqCiAgIEBtZXRob2QgdHJhbnNmb3JtRm9yCiAgIEBwcml2YXRlCiAgIEBwYXJhbSB7U3RyaW5nfSBhdHRyaWJ1dGVUeXBlCiAgIEBwYXJhbSB7Qm9vbGVhbn0gc2tpcEFzc2VydGlvbgogICBAcmV0dXJuIHtEUy5UcmFuc2Zvcm19IHRyYW5zZm9ybQogICovCiAgdHJhbnNmb3JtRm9yOiBmdW5jdGlvbihhdHRyaWJ1dGVUeXBlLCBza2lwQXNzZXJ0aW9uKSB7CiAgICB2YXIgdHJhbnNmb3JtID0gdGhpcy5jb250YWluZXIubG9va3VwKCd0cmFuc2Zvcm06JyArIGF0dHJpYnV0ZVR5cGUpOwogICAgRW1iZXIuYXNzZXJ0KCJVbmFibGUgdG8gZmluZCB0cmFuc2Zvcm0gZm9yICciICsgYXR0cmlidXRlVHlwZSArICInIiwgc2tpcEFzc2VydGlvbiB8fCAhIXRyYW5zZm9ybSk7CiAgICByZXR1cm4gdHJhbnNmb3JtOwogIH0KfSk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgogIEBtb2R1bGUgZW1iZXItZGF0YQoqLwp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBjYXBpdGFsaXplID0gRW1iZXIuU3RyaW5nLmNhcGl0YWxpemUsIHVuZGVyc2NvcmUgPSBFbWJlci5TdHJpbmcudW5kZXJzY29yZSwgRFMgPSB3aW5kb3cuRFMgOwoKLyoqCiAgRXh0ZW5kIGBFbWJlci5EYXRhQWRhcHRlcmAgd2l0aCBFRCBzcGVjaWZpYyBjb2RlLgoKICBAY2xhc3MgRGVidWdBZGFwdGVyCiAgQG5hbWVzcGFjZSBEUwogIEBleHRlbmRzIEVtYmVyLkRhdGFBZGFwdGVyCiAgQHByaXZhdGUKKi8KRFMuRGVidWdBZGFwdGVyID0gRW1iZXIuRGF0YUFkYXB0ZXIuZXh0ZW5kKHsKICBnZXRGaWx0ZXJzOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBbCiAgICAgIHsgbmFtZTogJ2lzTmV3JywgZGVzYzogJ05ldycgfSwKICAgICAgeyBuYW1lOiAnaXNNb2RpZmllZCcsIGRlc2M6ICdNb2RpZmllZCcgfSwKICAgICAgeyBuYW1lOiAnaXNDbGVhbicsIGRlc2M6ICdDbGVhbicgfQogICAgXTsKICB9LAoKICBkZXRlY3Q6IGZ1bmN0aW9uKGtsYXNzKSB7CiAgICByZXR1cm4ga2xhc3MgIT09IERTLk1vZGVsICYmIERTLk1vZGVsLmRldGVjdChrbGFzcyk7CiAgfSwKCiAgY29sdW1uc0ZvclR5cGU6IGZ1bmN0aW9uKHR5cGUpIHsKICAgIHZhciBjb2x1bW5zID0gW3sgbmFtZTogJ2lkJywgZGVzYzogJ0lkJyB9XSwgY291bnQgPSAwLCBzZWxmID0gdGhpczsKICAgIGdldCh0eXBlLCAnYXR0cmlidXRlcycpLmZvckVhY2goZnVuY3Rpb24obmFtZSwgbWV0YSkgewogICAgICAgIGlmIChjb3VudCsrID4gc2VsZi5hdHRyaWJ1dGVMaW1pdCkgeyByZXR1cm4gZmFsc2U7IH0KICAgICAgICB2YXIgZGVzYyA9IGNhcGl0YWxpemUodW5kZXJzY29yZShuYW1lKS5yZXBsYWNlKCdfJywgJyAnKSk7CiAgICAgICAgY29sdW1ucy5wdXNoKHsgbmFtZTogbmFtZSwgZGVzYzogZGVzYyB9KTsKICAgIH0pOwogICAgcmV0dXJuIGNvbHVtbnM7CiAgfSwKCiAgZ2V0UmVjb3JkczogZnVuY3Rpb24odHlwZSkgewogICAgcmV0dXJuIHRoaXMuZ2V0KCdzdG9yZScpLmFsbCh0eXBlKTsKICB9LAoKICBnZXRSZWNvcmRDb2x1bW5WYWx1ZXM6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgdmFyIHNlbGYgPSB0aGlzLCBjb3VudCA9IDAsCiAgICAgICAgY29sdW1uVmFsdWVzID0geyBpZDogZ2V0KHJlY29yZCwgJ2lkJykgfTsKCiAgICByZWNvcmQuZWFjaEF0dHJpYnV0ZShmdW5jdGlvbihrZXkpIHsKICAgICAgaWYgKGNvdW50KysgPiBzZWxmLmF0dHJpYnV0ZUxpbWl0KSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHZhciB2YWx1ZSA9IGdldChyZWNvcmQsIGtleSk7CiAgICAgIGNvbHVtblZhbHVlc1trZXldID0gdmFsdWU7CiAgICB9KTsKICAgIHJldHVybiBjb2x1bW5WYWx1ZXM7CiAgfSwKCiAgZ2V0UmVjb3JkS2V5d29yZHM6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgdmFyIGtleXdvcmRzID0gW10sIGtleXMgPSBFbWJlci5BKFsnaWQnXSk7CiAgICByZWNvcmQuZWFjaEF0dHJpYnV0ZShmdW5jdGlvbihrZXkpIHsKICAgICAga2V5cy5wdXNoKGtleSk7CiAgICB9KTsKICAgIGtleXMuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKICAgICAga2V5d29yZHMucHVzaChnZXQocmVjb3JkLCBrZXkpKTsKICAgIH0pOwogICAgcmV0dXJuIGtleXdvcmRzOwogIH0sCgogIGdldFJlY29yZEZpbHRlclZhbHVlczogZnVuY3Rpb24ocmVjb3JkKSB7CiAgICByZXR1cm4gewogICAgICBpc05ldzogcmVjb3JkLmdldCgnaXNOZXcnKSwKICAgICAgaXNNb2RpZmllZDogcmVjb3JkLmdldCgnaXNEaXJ0eScpICYmICFyZWNvcmQuZ2V0KCdpc05ldycpLAogICAgICBpc0NsZWFuOiAhcmVjb3JkLmdldCgnaXNEaXJ0eScpCiAgICB9OwogIH0sCgogIGdldFJlY29yZENvbG9yOiBmdW5jdGlvbihyZWNvcmQpIHsKICAgIHZhciBjb2xvciA9ICdibGFjayc7CiAgICBpZiAocmVjb3JkLmdldCgnaXNOZXcnKSkgewogICAgICBjb2xvciA9ICdncmVlbic7CiAgICB9IGVsc2UgaWYgKHJlY29yZC5nZXQoJ2lzRGlydHknKSkgewogICAgICBjb2xvciA9ICdibHVlJzsKICAgIH0KICAgIHJldHVybiBjb2xvcjsKICB9LAoKICBvYnNlcnZlUmVjb3JkOiBmdW5jdGlvbihyZWNvcmQsIHJlY29yZFVwZGF0ZWQpIHsKICAgIHZhciByZWxlYXNlTWV0aG9kcyA9IEVtYmVyLkEoKSwgc2VsZiA9IHRoaXMsCiAgICAgICAga2V5c1RvT2JzZXJ2ZSA9IEVtYmVyLkEoWydpZCcsICdpc05ldycsICdpc0RpcnR5J10pOwoKICAgIHJlY29yZC5lYWNoQXR0cmlidXRlKGZ1bmN0aW9uKGtleSkgewogICAgICBrZXlzVG9PYnNlcnZlLnB1c2goa2V5KTsKICAgIH0pOwoKICAgIGtleXNUb09ic2VydmUuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKICAgICAgdmFyIGhhbmRsZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICByZWNvcmRVcGRhdGVkKHNlbGYud3JhcFJlY29yZChyZWNvcmQpKTsKICAgICAgfTsKICAgICAgRW1iZXIuYWRkT2JzZXJ2ZXIocmVjb3JkLCBrZXksIGhhbmRsZXIpOwogICAgICByZWxlYXNlTWV0aG9kcy5wdXNoKGZ1bmN0aW9uKCkgewogICAgICAgIEVtYmVyLnJlbW92ZU9ic2VydmVyKHJlY29yZCwga2V5LCBoYW5kbGVyKTsKICAgICAgfSk7CiAgICB9KTsKCiAgICB2YXIgcmVsZWFzZSA9IGZ1bmN0aW9uKCkgewogICAgICByZWxlYXNlTWV0aG9kcy5mb3JFYWNoKGZ1bmN0aW9uKGZuKSB7IGZuKCk7IH0gKTsKICAgIH07CgogICAgcmV0dXJuIHJlbGVhc2U7CiAgfQoKfSk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgogIFRoZSBgRFMuVHJhbnNmb3JtYCBjbGFzcyBpcyB1c2VkIHRvIHNlcmlhbGl6ZSBhbmQgZGVzZXJpYWxpemUgbW9kZWwKICBhdHRyaWJ1dGVzIHdoZW4gdGhleSBhcmUgc2F2ZWQgb3IgbG9hZGVkIGZyb20gYW4KICBhZGFwdGVyLiBTdWJjbGFzc2luZyBgRFMuVHJhbnNmb3JtYCBpcyB1c2VmdWwgZm9yIGNyZWF0aW5nIGN1c3RvbQogIGF0dHJpYnV0ZXMuIEFsbCBzdWJjbGFzc2VzIG9mIGBEUy5UcmFuc2Zvcm1gIG11c3QgaW1wbGVtZW50IGEKICBgc2VyaWFsaXplYCBhbmQgYSBgZGVzZXJpYWxpemVgIG1ldGhvZC4KCiAgRXhhbXBsZQoKICBgYGBqYXZhc2NyaXB0CiAgQXBwLlJhd1RyYW5zZm9ybSA9IERTLlRyYW5zZm9ybS5leHRlbmQoewogICAgZGVzZXJpYWxpemU6IGZ1bmN0aW9uKHNlcmlhbGl6ZWQpIHsKICAgICAgcmV0dXJuIHNlcmlhbGl6ZWQ7CiAgICB9LAogICAgc2VyaWFsaXplOiBmdW5jdGlvbihkZXNlcmlhbGl6ZWQpIHsKICAgICAgcmV0dXJuIGRlc2VyaWFsaXplZDsKICAgIH0KICB9KTsKICBgYGAKCiAgVXNhZ2UKCiAgYGBgamF2YXNjcmlwdAogIHZhciBhdHRyID0gRFMuYXR0cjsKICBBcHAuUmVxdWlyZW1lbnQgPSBEUy5Nb2RlbC5leHRlbmQoewogICAgbmFtZTogYXR0cignc3RyaW5nJyksCiAgICBvcHRpb25zQXJyYXk6IGF0dHIoJ3JhdycpCiAgfSk7CiAgYGBgCgogIEBjbGFzcyBUcmFuc2Zvcm0KICBAbmFtZXNwYWNlIERTCiAqLwpEUy5UcmFuc2Zvcm0gPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICAvKioKICAgIFdoZW4gZ2l2ZW4gYSBkZXNlcmlhbGl6ZWQgdmFsdWUgZnJvbSBhIHJlY29yZCBhdHRyaWJ1dGUgdGhpcwogICAgbWV0aG9kIG11c3QgcmV0dXJuIHRoZSBzZXJpYWxpemVkIHZhbHVlLgoKICAgIEV4YW1wbGUKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBzZXJpYWxpemU6IGZ1bmN0aW9uKGRlc2VyaWFsaXplZCkgewogICAgICByZXR1cm4gRW1iZXIuaXNFbXB0eShkZXNlcmlhbGl6ZWQpID8gbnVsbCA6IE51bWJlcihkZXNlcmlhbGl6ZWQpOwogICAgfQogICAgYGBgCgogICAgQG1ldGhvZCBzZXJpYWxpemUKICAgIEBwYXJhbSBkZXNlcmlhbGl6ZWQgVGhlIGRlc2VyaWFsaXplZCB2YWx1ZQogICAgQHJldHVybiBUaGUgc2VyaWFsaXplZCB2YWx1ZQogICovCiAgc2VyaWFsaXplOiBFbWJlci5yZXF1aXJlZCgpLAoKICAvKioKICAgIFdoZW4gZ2l2ZW4gYSBzZXJpYWxpemUgdmFsdWUgZnJvbSBhIEpTT04gb2JqZWN0IHRoaXMgbWV0aG9kIG11c3QKICAgIHJldHVybiB0aGUgZGVzZXJpYWxpemVkIHZhbHVlIGZvciB0aGUgcmVjb3JkIGF0dHJpYnV0ZS4KCiAgICBFeGFtcGxlCgogICAgYGBgamF2YXNjcmlwdAogICAgZGVzZXJpYWxpemU6IGZ1bmN0aW9uKHNlcmlhbGl6ZWQpIHsKICAgICAgcmV0dXJuIGVtcHR5KHNlcmlhbGl6ZWQpID8gbnVsbCA6IE51bWJlcihzZXJpYWxpemVkKTsKICAgIH0KICAgIGBgYAoKICAgIEBtZXRob2QgZGVzZXJpYWxpemUKICAgIEBwYXJhbSBzZXJpYWxpemVkIFRoZSBzZXJpYWxpemVkIHZhbHVlCiAgICBAcmV0dXJuIFRoZSBkZXNlcmlhbGl6ZWQgdmFsdWUKICAqLwogIGRlc2VyaWFsaXplOiBFbWJlci5yZXF1aXJlZCgpCgp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKCi8qKgogIFRoZSBgRFMuQm9vbGVhblRyYW5zZm9ybWAgY2xhc3MgaXMgdXNlZCB0byBzZXJpYWxpemUgYW5kIGRlc2VyaWFsaXplCiAgYm9vbGVhbiBhdHRyaWJ1dGVzIG9uIEVtYmVyIERhdGEgcmVjb3JkIG9iamVjdHMuIFRoaXMgdHJhbnNmb3JtIGlzCiAgdXNlZCB3aGVuIGBib29sZWFuYCBpcyBwYXNzZWQgYXMgdGhlIHR5cGUgcGFyYW1ldGVyIHRvIHRoZQogIFtEUy5hdHRyXSguLi8uLi9kYXRhI21ldGhvZF9hdHRyKSBmdW5jdGlvbi4KCiAgVXNhZ2UKCiAgYGBgamF2YXNjcmlwdAogIHZhciBhdHRyID0gRFMuYXR0cjsKICBBcHAuVXNlciA9IERTLk1vZGVsLmV4dGVuZCh7CiAgICBpc0FkbWluOiBhdHRyKCdib29sZWFuJyksCiAgICBuYW1lOiBhdHRyKCdzdHJpbmcnKSwKICAgIGVtYWlsOiBhdHRyKCdzdHJpbmcnKQogIH0pOwogIGBgYAoKICBAY2xhc3MgQm9vbGVhblRyYW5zZm9ybQogIEBleHRlbmRzIERTLlRyYW5zZm9ybQogIEBuYW1lc3BhY2UgRFMKICovCkRTLkJvb2xlYW5UcmFuc2Zvcm0gPSBEUy5UcmFuc2Zvcm0uZXh0ZW5kKHsKICBkZXNlcmlhbGl6ZTogZnVuY3Rpb24oc2VyaWFsaXplZCkgewogICAgdmFyIHR5cGUgPSB0eXBlb2Ygc2VyaWFsaXplZDsKCiAgICBpZiAodHlwZSA9PT0gImJvb2xlYW4iKSB7CiAgICAgIHJldHVybiBzZXJpYWxpemVkOwogICAgfSBlbHNlIGlmICh0eXBlID09PSAic3RyaW5nIikgewogICAgICByZXR1cm4gc2VyaWFsaXplZC5tYXRjaCgvXnRydWUkfF50JHxeMSQvaSkgIT09IG51bGw7CiAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICJudW1iZXIiKSB7CiAgICAgIHJldHVybiBzZXJpYWxpemVkID09PSAxOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0sCgogIHNlcmlhbGl6ZTogZnVuY3Rpb24oZGVzZXJpYWxpemVkKSB7CiAgICByZXR1cm4gQm9vbGVhbihkZXNlcmlhbGl6ZWQpOwogIH0KfSk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgogIFRoZSBgRFMuRGF0ZVRyYW5zZm9ybWAgY2xhc3MgaXMgdXNlZCB0byBzZXJpYWxpemUgYW5kIGRlc2VyaWFsaXplCiAgZGF0ZSBhdHRyaWJ1dGVzIG9uIEVtYmVyIERhdGEgcmVjb3JkIG9iamVjdHMuIFRoaXMgdHJhbnNmb3JtIGlzIHVzZWQKICB3aGVuIGBkYXRlYCBpcyBwYXNzZWQgYXMgdGhlIHR5cGUgcGFyYW1ldGVyIHRvIHRoZQogIFtEUy5hdHRyXSguLi8uLi9kYXRhI21ldGhvZF9hdHRyKSBmdW5jdGlvbi4KCiAgYGBgamF2YXNjcmlwdAogIHZhciBhdHRyID0gRFMuYXR0cjsKICBBcHAuU2NvcmUgPSBEUy5Nb2RlbC5leHRlbmQoewogICAgdmFsdWU6IGF0dHIoJ251bWJlcicpLAogICAgcGxheWVyOiBEUy5iZWxvbmdzVG8oJ3BsYXllcicpLAogICAgZGF0ZTogYXR0cignZGF0ZScpCiAgfSk7CiAgYGBgCgogIEBjbGFzcyBEYXRlVHJhbnNmb3JtCiAgQGV4dGVuZHMgRFMuVHJhbnNmb3JtCiAgQG5hbWVzcGFjZSBEUwogKi8KRFMuRGF0ZVRyYW5zZm9ybSA9IERTLlRyYW5zZm9ybS5leHRlbmQoewoKICBkZXNlcmlhbGl6ZTogZnVuY3Rpb24oc2VyaWFsaXplZCkgewogICAgdmFyIHR5cGUgPSB0eXBlb2Ygc2VyaWFsaXplZDsKCiAgICBpZiAodHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgcmV0dXJuIG5ldyBEYXRlKEVtYmVyLkRhdGUucGFyc2Uoc2VyaWFsaXplZCkpOwogICAgfSBlbHNlIGlmICh0eXBlID09PSAibnVtYmVyIikgewogICAgICByZXR1cm4gbmV3IERhdGUoc2VyaWFsaXplZCk7CiAgICB9IGVsc2UgaWYgKHNlcmlhbGl6ZWQgPT09IG51bGwgfHwgc2VyaWFsaXplZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIC8vIGlmIHRoZSB2YWx1ZSBpcyBub3QgcHJlc2VudCBpbiB0aGUgZGF0YSwKICAgICAgLy8gcmV0dXJuIHVuZGVmaW5lZCwgbm90IG51bGwuCiAgICAgIHJldHVybiBzZXJpYWxpemVkOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgfSwKCiAgc2VyaWFsaXplOiBmdW5jdGlvbihkYXRlKSB7CiAgICBpZiAoZGF0ZSBpbnN0YW5jZW9mIERhdGUpIHsKICAgICAgdmFyIGRheXMgPSBbIlN1biIsICJNb24iLCAiVHVlIiwgIldlZCIsICJUaHUiLCAiRnJpIiwgIlNhdCJdOwogICAgICB2YXIgbW9udGhzID0gWyJKYW4iLCAiRmViIiwgIk1hciIsICJBcHIiLCAiTWF5IiwgIkp1biIsICJKdWwiLCAiQXVnIiwgIlNlcCIsICJPY3QiLCAiTm92IiwgIkRlYyJdOwoKICAgICAgdmFyIHBhZCA9IGZ1bmN0aW9uKG51bSkgewogICAgICAgIHJldHVybiBudW0gPCAxMCA/ICIwIitudW0gOiAiIitudW07CiAgICAgIH07CgogICAgICB2YXIgdXRjWWVhciA9IGRhdGUuZ2V0VVRDRnVsbFllYXIoKSwKICAgICAgICAgIHV0Y01vbnRoID0gZGF0ZS5nZXRVVENNb250aCgpLAogICAgICAgICAgdXRjRGF5T2ZNb250aCA9IGRhdGUuZ2V0VVRDRGF0ZSgpLAogICAgICAgICAgdXRjRGF5ID0gZGF0ZS5nZXRVVENEYXkoKSwKICAgICAgICAgIHV0Y0hvdXJzID0gZGF0ZS5nZXRVVENIb3VycygpLAogICAgICAgICAgdXRjTWludXRlcyA9IGRhdGUuZ2V0VVRDTWludXRlcygpLAogICAgICAgICAgdXRjU2Vjb25kcyA9IGRhdGUuZ2V0VVRDU2Vjb25kcygpOwoKCiAgICAgIHZhciBkYXlPZldlZWsgPSBkYXlzW3V0Y0RheV07CiAgICAgIHZhciBkYXlPZk1vbnRoID0gcGFkKHV0Y0RheU9mTW9udGgpOwogICAgICB2YXIgbW9udGggPSBtb250aHNbdXRjTW9udGhdOwoKICAgICAgcmV0dXJuIGRheU9mV2VlayArICIsICIgKyBkYXlPZk1vbnRoICsgIiAiICsgbW9udGggKyAiICIgKyB1dGNZZWFyICsgIiAiICsKICAgICAgICAgICAgIHBhZCh1dGNIb3VycykgKyAiOiIgKyBwYWQodXRjTWludXRlcykgKyAiOiIgKyBwYWQodXRjU2Vjb25kcykgKyAiIEdNVCI7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9IAoKfSk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7CnZhciBlbXB0eSA9IEVtYmVyLmlzRW1wdHk7Ci8qKgogIFRoZSBgRFMuTnVtYmVyVHJhbnNmb3JtYCBjbGFzcyBpcyB1c2VkIHRvIHNlcmlhbGl6ZSBhbmQgZGVzZXJpYWxpemUKICBudW1lcmljIGF0dHJpYnV0ZXMgb24gRW1iZXIgRGF0YSByZWNvcmQgb2JqZWN0cy4gVGhpcyB0cmFuc2Zvcm0gaXMKICB1c2VkIHdoZW4gYG51bWJlcmAgaXMgcGFzc2VkIGFzIHRoZSB0eXBlIHBhcmFtZXRlciB0byB0aGUKICBbRFMuYXR0cl0oLi4vLi4vZGF0YSNtZXRob2RfYXR0cikgZnVuY3Rpb24uCgogIFVzYWdlCgogIGBgYGphdmFzY3JpcHQKICB2YXIgYXR0ciA9IERTLmF0dHI7CiAgQXBwLlNjb3JlID0gRFMuTW9kZWwuZXh0ZW5kKHsKICAgIHZhbHVlOiBhdHRyKCdudW1iZXInKSwKICAgIHBsYXllcjogRFMuYmVsb25nc1RvKCdwbGF5ZXInKSwKICAgIGRhdGU6IGF0dHIoJ2RhdGUnKQogIH0pOwogIGBgYAoKICBAY2xhc3MgTnVtYmVyVHJhbnNmb3JtCiAgQGV4dGVuZHMgRFMuVHJhbnNmb3JtCiAgQG5hbWVzcGFjZSBEUwogKi8KRFMuTnVtYmVyVHJhbnNmb3JtID0gRFMuVHJhbnNmb3JtLmV4dGVuZCh7CgogIGRlc2VyaWFsaXplOiBmdW5jdGlvbihzZXJpYWxpemVkKSB7CiAgICByZXR1cm4gZW1wdHkoc2VyaWFsaXplZCkgPyBudWxsIDogTnVtYmVyKHNlcmlhbGl6ZWQpOwogIH0sCgogIHNlcmlhbGl6ZTogZnVuY3Rpb24oZGVzZXJpYWxpemVkKSB7CiAgICByZXR1cm4gZW1wdHkoZGVzZXJpYWxpemVkKSA/IG51bGwgOiBOdW1iZXIoZGVzZXJpYWxpemVkKTsKICB9Cn0pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewp2YXIgbm9uZSA9IEVtYmVyLmlzTm9uZTsKCi8qKgogIFRoZSBgRFMuU3RyaW5nVHJhbnNmb3JtYCBjbGFzcyBpcyB1c2VkIHRvIHNlcmlhbGl6ZSBhbmQgZGVzZXJpYWxpemUKICBzdHJpbmcgYXR0cmlidXRlcyBvbiBFbWJlciBEYXRhIHJlY29yZCBvYmplY3RzLiBUaGlzIHRyYW5zZm9ybSBpcwogIHVzZWQgd2hlbiBgc3RyaW5nYCBpcyBwYXNzZWQgYXMgdGhlIHR5cGUgcGFyYW1ldGVyIHRvIHRoZQogIFtEUy5hdHRyXSguLi8uLi9kYXRhI21ldGhvZF9hdHRyKSBmdW5jdGlvbi4KCiAgVXNhZ2UKCiAgYGBgamF2YXNjcmlwdAogIHZhciBhdHRyID0gRFMuYXR0cjsKICBBcHAuVXNlciA9IERTLk1vZGVsLmV4dGVuZCh7CiAgICBpc0FkbWluOiBhdHRyKCdib29sZWFuJyksCiAgICBuYW1lOiBhdHRyKCdzdHJpbmcnKSwKICAgIGVtYWlsOiBhdHRyKCdzdHJpbmcnKQogIH0pOwogIGBgYAoKICBAY2xhc3MgU3RyaW5nVHJhbnNmb3JtCiAgQGV4dGVuZHMgRFMuVHJhbnNmb3JtCiAgQG5hbWVzcGFjZSBEUwogKi8KRFMuU3RyaW5nVHJhbnNmb3JtID0gRFMuVHJhbnNmb3JtLmV4dGVuZCh7CgogIGRlc2VyaWFsaXplOiBmdW5jdGlvbihzZXJpYWxpemVkKSB7CiAgICByZXR1cm4gbm9uZShzZXJpYWxpemVkKSA/IG51bGwgOiBTdHJpbmcoc2VyaWFsaXplZCk7CiAgfSwKCiAgc2VyaWFsaXplOiBmdW5jdGlvbihkZXNlcmlhbGl6ZWQpIHsKICAgIHJldHVybiBub25lKGRlc2VyaWFsaXplZCkgPyBudWxsIDogU3RyaW5nKGRlc2VyaWFsaXplZCk7CiAgfQoKfSk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgogIEBtb2R1bGUgZW1iZXItZGF0YQoqLwoKdmFyIHNldCA9IEVtYmVyLnNldDsKCi8qCiAgVGhpcyBjb2RlIHJlZ2lzdGVycyBhbiBpbmplY3Rpb24gZm9yIEVtYmVyLkFwcGxpY2F0aW9uLgoKICBJZiBhbiBFbWJlci5qcyBkZXZlbG9wZXIgZGVmaW5lcyBhIHN1YmNsYXNzIG9mIERTLlN0b3JlIG9uIHRoZWlyIGFwcGxpY2F0aW9uLAogIHRoaXMgY29kZSB3aWxsIGF1dG9tYXRpY2FsbHkgaW5zdGFudGlhdGUgaXQgYW5kIG1ha2UgaXQgYXZhaWxhYmxlIG9uIHRoZQogIHJvdXRlci4KCiAgQWRkaXRpb25hbGx5LCBhZnRlciBhbiBhcHBsaWNhdGlvbidzIGNvbnRyb2xsZXJzIGhhdmUgYmVlbiBpbmplY3RlZCwgdGhleSB3aWxsCiAgZWFjaCBoYXZlIHRoZSBzdG9yZSBtYWRlIGF2YWlsYWJsZSB0byB0aGVtLgoKICBGb3IgZXhhbXBsZSwgaW1hZ2luZSBhbiBFbWJlci5qcyBhcHBsaWNhdGlvbiB3aXRoIHRoZSBmb2xsb3dpbmcgY2xhc3NlczoKCiAgQXBwLlN0b3JlID0gRFMuU3RvcmUuZXh0ZW5kKHsKICAgIGFkYXB0ZXI6ICdjdXN0b20nCiAgfSk7CgogIEFwcC5Qb3N0c0NvbnRyb2xsZXIgPSBFbWJlci5BcnJheUNvbnRyb2xsZXIuZXh0ZW5kKHsKICAgIC8vIC4uLgogIH0pOwoKICBXaGVuIHRoZSBhcHBsaWNhdGlvbiBpcyBpbml0aWFsaXplZCwgYEFwcC5TdG9yZWAgd2lsbCBhdXRvbWF0aWNhbGx5IGJlCiAgaW5zdGFudGlhdGVkLCBhbmQgdGhlIGluc3RhbmNlIG9mIGBBcHAuUG9zdHNDb250cm9sbGVyYCB3aWxsIGhhdmUgaXRzIGBzdG9yZWAKICBwcm9wZXJ0eSBzZXQgdG8gdGhhdCBpbnN0YW5jZS4KCiAgTm90ZSB0aGF0IHRoaXMgY29kZSB3aWxsIG9ubHkgYmUgcnVuIGlmIHRoZSBgZW1iZXItYXBwbGljYXRpb25gIHBhY2thZ2UgaXMKICBsb2FkZWQuIElmIEVtYmVyIERhdGEgaXMgYmVpbmcgdXNlZCBpbiBhbiBlbnZpcm9ubWVudCBvdGhlciB0aGFuIGEKICB0eXBpY2FsIGFwcGxpY2F0aW9uIChlLmcuLCBub2RlLmpzIHdoZXJlIG9ubHkgYGVtYmVyLXJ1bnRpbWVgIGlzIGF2YWlsYWJsZSksCiAgdGhpcyBjb2RlIHdpbGwgYmUgaWdub3JlZC4KKi8KCkVtYmVyLm9uTG9hZCgnRW1iZXIuQXBwbGljYXRpb24nLCBmdW5jdGlvbihBcHBsaWNhdGlvbikgewogIEFwcGxpY2F0aW9uLmluaXRpYWxpemVyKHsKICAgIG5hbWU6ICJzdG9yZSIsCgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oY29udGFpbmVyLCBhcHBsaWNhdGlvbikgewogICAgICBhcHBsaWNhdGlvbi5yZWdpc3Rlcignc3RvcmU6bWFpbicsIGFwcGxpY2F0aW9uLlN0b3JlIHx8IERTLlN0b3JlKTsKICAgICAgYXBwbGljYXRpb24ucmVnaXN0ZXIoJ3NlcmlhbGl6ZXI6X2RlZmF1bHQnLCBEUy5KU09OU2VyaWFsaXplcik7CiAgICAgIGFwcGxpY2F0aW9uLnJlZ2lzdGVyKCdzZXJpYWxpemVyOl9yZXN0JywgRFMuUkVTVFNlcmlhbGl6ZXIpOwogICAgICBhcHBsaWNhdGlvbi5yZWdpc3RlcignYWRhcHRlcjpfcmVzdCcsIERTLlJFU1RBZGFwdGVyKTsKCiAgICAgIC8vIEVhZ2VybHkgZ2VuZXJhdGUgdGhlIHN0b3JlIHNvIGRlZmF1bHRTdG9yZSBpcyBwb3B1bGF0ZWQuCiAgICAgIC8vIFRPRE86IERvIHRoaXMgaW4gYSBmaW5pc2hlciBob29rCiAgICAgIGNvbnRhaW5lci5sb29rdXAoJ3N0b3JlOm1haW4nKTsKICAgIH0KICB9KTsKCiAgQXBwbGljYXRpb24uaW5pdGlhbGl6ZXIoewogICAgbmFtZTogInRyYW5zZm9ybXMiLAogICAgYmVmb3JlOiAic3RvcmUiLAoKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKGNvbnRhaW5lciwgYXBwbGljYXRpb24pIHsKICAgICAgYXBwbGljYXRpb24ucmVnaXN0ZXIoJ3RyYW5zZm9ybTpib29sZWFuJywgRFMuQm9vbGVhblRyYW5zZm9ybSk7CiAgICAgIGFwcGxpY2F0aW9uLnJlZ2lzdGVyKCd0cmFuc2Zvcm06ZGF0ZScsIERTLkRhdGVUcmFuc2Zvcm0pOwogICAgICBhcHBsaWNhdGlvbi5yZWdpc3RlcigndHJhbnNmb3JtOm51bWJlcicsIERTLk51bWJlclRyYW5zZm9ybSk7CiAgICAgIGFwcGxpY2F0aW9uLnJlZ2lzdGVyKCd0cmFuc2Zvcm06c3RyaW5nJywgRFMuU3RyaW5nVHJhbnNmb3JtKTsKICAgIH0KICB9KTsKCiAgQXBwbGljYXRpb24uaW5pdGlhbGl6ZXIoewogICAgbmFtZTogImRhdGFBZGFwdGVyIiwKICAgIGJlZm9yZTogInN0b3JlIiwKCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbihjb250YWluZXIsIGFwcGxpY2F0aW9uKSB7CiAgICAgIGFwcGxpY2F0aW9uLnJlZ2lzdGVyKCdkYXRhQWRhcHRlcjptYWluJywgRFMuRGVidWdBZGFwdGVyKTsKICAgIH0KICB9KTsKCiAgQXBwbGljYXRpb24uaW5pdGlhbGl6ZXIoewogICAgbmFtZTogImluamVjdFN0b3JlIiwKICAgIGJlZm9yZTogInN0b3JlIiwKCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbihjb250YWluZXIsIGFwcGxpY2F0aW9uKSB7CiAgICAgIGFwcGxpY2F0aW9uLmluamVjdCgnY29udHJvbGxlcicsICdzdG9yZScsICdzdG9yZTptYWluJyk7CiAgICAgIGFwcGxpY2F0aW9uLmluamVjdCgncm91dGUnLCAnc3RvcmUnLCAnc3RvcmU6bWFpbicpOwogICAgICBhcHBsaWNhdGlvbi5pbmplY3QoJ3NlcmlhbGl6ZXInLCAnc3RvcmUnLCAnc3RvcmU6bWFpbicpOwogICAgICBhcHBsaWNhdGlvbi5pbmplY3QoJ2RhdGFBZGFwdGVyJywgJ3N0b3JlJywgJ3N0b3JlOm1haW4nKTsKICAgIH0KICB9KTsKCn0pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKICBAbW9kdWxlIGVtYmVyLWRhdGEKKi8KCi8qKgogIERhdGUucGFyc2Ugd2l0aCBwcm9ncmVzc2l2ZSBlbmhhbmNlbWVudCBmb3IgSVNPIDg2MDEgPGh0dHBzOi8vZ2l0aHViLmNvbS9jc25vdmVyL2pzLWlzbzg2MDE+CgogIMKpIDIwMTEgQ29saW4gU25vdmVyIDxodHRwOi8vemV0YWZsZWV0LmNvbT4KCiAgUmVsZWFzZWQgdW5kZXIgTUlUIGxpY2Vuc2UuCgogIEBjbGFzcyBEYXRlCiAgQG5hbWVzcGFjZSBFbWJlcgogIEBzdGF0aWMKKi8KRW1iZXIuRGF0ZSA9IEVtYmVyLkRhdGUgfHwge307Cgp2YXIgb3JpZ1BhcnNlID0gRGF0ZS5wYXJzZSwgbnVtZXJpY0tleXMgPSBbIDEsIDQsIDUsIDYsIDcsIDEwLCAxMSBdOwoKLyoqCiAgQG1ldGhvZCBwYXJzZQogIEBwYXJhbSBkYXRlCiovCkVtYmVyLkRhdGUucGFyc2UgPSBmdW5jdGlvbiAoZGF0ZSkgewogICAgdmFyIHRpbWVzdGFtcCwgc3RydWN0LCBtaW51dGVzT2Zmc2V0ID0gMDsKCiAgICAvLyBFUzUgwqcxNS45LjQuMiBzdGF0ZXMgdGhhdCB0aGUgc3RyaW5nIHNob3VsZCBhdHRlbXB0IHRvIGJlIHBhcnNlZCBhcyBhIERhdGUgVGltZSBTdHJpbmcgRm9ybWF0IHN0cmluZwogICAgLy8gYmVmb3JlIGZhbGxpbmcgYmFjayB0byBhbnkgaW1wbGVtZW50YXRpb24tc3BlY2lmaWMgZGF0ZSBwYXJzaW5nLCBzbyB0aGF04oCZcyB3aGF0IHdlIGRvLCBldmVuIGlmIG5hdGl2ZQogICAgLy8gaW1wbGVtZW50YXRpb25zIGNvdWxkIGJlIGZhc3RlcgogICAgLy8gICAgICAgICAgICAgIDEgWVlZWSAgICAgICAgICAgICAgICAyIE1NICAgICAgIDMgREQgICAgICAgICAgIDQgSEggICAgNSBtbSAgICAgICA2IHNzICAgICAgICA3IG1zZWMgICAgICAgIDggWiA5IMKxICAgIDEwIHR6SEggICAgMTEgdHptbQogICAgaWYgKChzdHJ1Y3QgPSAvXihcZHs0fXxbK1wtXVxkezZ9KSg/Oi0oXGR7Mn0pKD86LShcZHsyfSkpPyk/KD86VChcZHsyfSk6KFxkezJ9KSg/OjooXGR7Mn0pKD86XC4oXGR7M30pKT8pPyg/OihaKXwoWytcLV0pKFxkezJ9KSg/OjooXGR7Mn0pKT8pPyk/JC8uZXhlYyhkYXRlKSkpIHsKICAgICAgICAvLyBhdm9pZCBOYU4gdGltZXN0YW1wcyBjYXVzZWQgYnkg4oCcdW5kZWZpbmVk4oCdIHZhbHVlcyBiZWluZyBwYXNzZWQgdG8gRGF0ZS5VVEMKICAgICAgICBmb3IgKHZhciBpID0gMCwgazsgKGsgPSBudW1lcmljS2V5c1tpXSk7ICsraSkgewogICAgICAgICAgICBzdHJ1Y3Rba10gPSArc3RydWN0W2tdIHx8IDA7CiAgICAgICAgfQoKICAgICAgICAvLyBhbGxvdyB1bmRlZmluZWQgZGF5cyBhbmQgbW9udGhzCiAgICAgICAgc3RydWN0WzJdID0gKCtzdHJ1Y3RbMl0gfHwgMSkgLSAxOwogICAgICAgIHN0cnVjdFszXSA9ICtzdHJ1Y3RbM10gfHwgMTsKCiAgICAgICAgaWYgKHN0cnVjdFs4XSAhPT0gJ1onICYmIHN0cnVjdFs5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIG1pbnV0ZXNPZmZzZXQgPSBzdHJ1Y3RbMTBdICogNjAgKyBzdHJ1Y3RbMTFdOwoKICAgICAgICAgICAgaWYgKHN0cnVjdFs5XSA9PT0gJysnKSB7CiAgICAgICAgICAgICAgICBtaW51dGVzT2Zmc2V0ID0gMCAtIG1pbnV0ZXNPZmZzZXQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRpbWVzdGFtcCA9IERhdGUuVVRDKHN0cnVjdFsxXSwgc3RydWN0WzJdLCBzdHJ1Y3RbM10sIHN0cnVjdFs0XSwgc3RydWN0WzVdICsgbWludXRlc09mZnNldCwgc3RydWN0WzZdLCBzdHJ1Y3RbN10pOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgdGltZXN0YW1wID0gb3JpZ1BhcnNlID8gb3JpZ1BhcnNlKGRhdGUpIDogTmFOOwogICAgfQoKICAgIHJldHVybiB0aW1lc3RhbXA7Cn07CgppZiAoRW1iZXIuRVhURU5EX1BST1RPVFlQRVMgPT09IHRydWUgfHwgRW1iZXIuRVhURU5EX1BST1RPVFlQRVMuRGF0ZSkgewogIERhdGUucGFyc2UgPSBFbWJlci5EYXRlLnBhcnNlOwp9Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgogIEBtb2R1bGUgZW1iZXItZGF0YQoqLwoKdmFyIGdldCA9IEVtYmVyLmdldCwgc2V0ID0gRW1iZXIuc2V0OwoKLyoqCiAgQSByZWNvcmQgYXJyYXkgaXMgYW4gYXJyYXkgdGhhdCBjb250YWlucyByZWNvcmRzIG9mIGEgY2VydGFpbiB0eXBlLiBUaGUgcmVjb3JkCiAgYXJyYXkgbWF0ZXJpYWxpemVzIHJlY29yZHMgYXMgbmVlZGVkIHdoZW4gdGhleSBhcmUgcmV0cmlldmVkIGZvciB0aGUgZmlyc3QKICB0aW1lLiBZb3Ugc2hvdWxkIG5vdCBjcmVhdGUgcmVjb3JkIGFycmF5cyB5b3Vyc2VsZi4gSW5zdGVhZCwgYW4gaW5zdGFuY2Ugb2YKICBgRFMuUmVjb3JkQXJyYXlgIG9yIGl0cyBzdWJjbGFzc2VzIHdpbGwgYmUgcmV0dXJuZWQgYnkgeW91ciBhcHBsaWNhdGlvbidzIHN0b3JlCiAgaW4gcmVzcG9uc2UgdG8gcXVlcmllcy4KCiAgQGNsYXNzIFJlY29yZEFycmF5CiAgQG5hbWVzcGFjZSBEUwogIEBleHRlbmRzIEVtYmVyLkFycmF5UHJveHkKICBAdXNlcyBFbWJlci5FdmVudGVkCiovCgpEUy5SZWNvcmRBcnJheSA9IEVtYmVyLkFycmF5UHJveHkuZXh0ZW5kKEVtYmVyLkV2ZW50ZWQsIHsKICAvKioKICAgIFRoZSBtb2RlbCB0eXBlIGNvbnRhaW5lZCBieSB0aGlzIHJlY29yZCBhcnJheS4KCiAgICBAcHJvcGVydHkgdHlwZQogICAgQHR5cGUgRFMuTW9kZWwKICAqLwogIHR5cGU6IG51bGwsCgogIC8qKgogICAgVGhlIGFycmF5IG9mIGNsaWVudCBpZHMgYmFja2luZyB0aGUgcmVjb3JkIGFycmF5LiBXaGVuIGEKICAgIHJlY29yZCBpcyByZXF1ZXN0ZWQgZnJvbSB0aGUgcmVjb3JkIGFycmF5LCB0aGUgcmVjb3JkCiAgICBmb3IgdGhlIGNsaWVudCBpZCBhdCB0aGUgc2FtZSBpbmRleCBpcyBtYXRlcmlhbGl6ZWQsIGlmCiAgICBuZWNlc3NhcnksIGJ5IHRoZSBzdG9yZS4KCiAgICBAcHJvcGVydHkgY29udGVudAogICAgQHByaXZhdGUKICAgIEB0eXBlIEVtYmVyLkFycmF5CiAgKi8KICBjb250ZW50OiBudWxsLAoKICAvKioKICAgIFRoZSBmbGFnIHRvIHNpZ25hbCBhIGBSZWNvcmRBcnJheWAgaXMgY3VycmVudGx5IGxvYWRpbmcgZGF0YS4KCiAgICBFeGFtcGxlCgogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIHBlb3BsZSA9IHN0b3JlLmFsbChBcHAuUGVyc29uKTsKICAgIHBlb3BsZS5nZXQoJ2lzTG9hZGVkJyk7IC8vIHRydWUKICAgIGBgYAoKICAgIEBwcm9wZXJ0eSBpc0xvYWRlZAogICAgQHR5cGUgQm9vbGVhbgogICovCiAgaXNMb2FkZWQ6IGZhbHNlLAogIC8qKgogICAgVGhlIGZsYWcgdG8gc2lnbmFsIGEgYFJlY29yZEFycmF5YCBpcyBjdXJyZW50bHkgbG9hZGluZyBkYXRhLgoKICAgIEV4YW1wbGUKCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgcGVvcGxlID0gc3RvcmUuYWxsKEFwcC5QZXJzb24pOwogICAgcGVvcGxlLmdldCgnaXNVcGRhdGluZycpOyAvLyBmYWxzZQogICAgcGVvcGxlLnVwZGF0ZSgpOwogICAgcGVvcGxlLmdldCgnaXNVcGRhdGluZycpOyAvLyB0cnVlCiAgICBgYGAKCiAgICBAcHJvcGVydHkgaXNVcGRhdGluZwogICAgQHR5cGUgQm9vbGVhbgogICovCiAgaXNVcGRhdGluZzogZmFsc2UsCgogIC8qKgogICAgVGhlIHN0b3JlIHRoYXQgY3JlYXRlZCB0aGlzIHJlY29yZCBhcnJheS4KCiAgICBAcHJvcGVydHkgc3RvcmUKICAgIEBwcml2YXRlCiAgICBAdHlwZSBEUy5TdG9yZQogICovCiAgc3RvcmU6IG51bGwsCgogIC8qKgogICAgUmV0cmlldmVzIGFuIG9iamVjdCBmcm9tIHRoZSBjb250ZW50IGJ5IGluZGV4LgoKICAgIEBtZXRob2Qgb2JqZWN0QXRDb250ZW50CiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtOdW1iZXJ9IGluZGV4CiAgICBAcmV0dXJuIHtEUy5Nb2RlbH0gcmVjb3JkCiAgKi8KICBvYmplY3RBdENvbnRlbnQ6IGZ1bmN0aW9uKGluZGV4KSB7CiAgICB2YXIgY29udGVudCA9IGdldCh0aGlzLCAnY29udGVudCcpOwoKICAgIHJldHVybiBjb250ZW50Lm9iamVjdEF0KGluZGV4KTsKICB9LAoKICAvKioKICAgIFVzZWQgdG8gZ2V0IHRoZSBsYXRlc3QgdmVyc2lvbiBvZiBhbGwgb2YgdGhlIHJlY29yZHMgaW4gdGhpcyBhcnJheQogICAgZnJvbSB0aGUgYWRhcHRlci4KCiAgICBFeGFtcGxlCgogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIHBlb3BsZSA9IHN0b3JlLmFsbChBcHAuUGVyc29uKTsKICAgIHBlb3BsZS5nZXQoJ2lzVXBkYXRpbmcnKTsgLy8gZmFsc2UKICAgIHBlb3BsZS51cGRhdGUoKTsKICAgIHBlb3BsZS5nZXQoJ2lzVXBkYXRpbmcnKTsgLy8gdHJ1ZQogICAgYGBgCgogICAgQG1ldGhvZCB1cGRhdGUKICAqLwogIHVwZGF0ZTogZnVuY3Rpb24oKSB7CiAgICBpZiAoZ2V0KHRoaXMsICdpc1VwZGF0aW5nJykpIHsgcmV0dXJuOyB9CgogICAgdmFyIHN0b3JlID0gZ2V0KHRoaXMsICdzdG9yZScpLAogICAgICAgIHR5cGUgPSBnZXQodGhpcywgJ3R5cGUnKTsKCiAgICBzdG9yZS5mZXRjaEFsbCh0eXBlLCB0aGlzKTsKICB9LAoKICAvKioKICAgIEFkZHMgYSByZWNvcmQgdG8gdGhlIGBSZWNvcmRBcnJheWAuCgogICAgQG1ldGhvZCBhZGRSZWNvcmQKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge0RTLk1vZGVsfSByZWNvcmQKICAqLwogIGFkZFJlY29yZDogZnVuY3Rpb24ocmVjb3JkKSB7CiAgICBnZXQodGhpcywgJ2NvbnRlbnQnKS5hZGRPYmplY3QocmVjb3JkKTsKICB9LAoKICAvKioKICAgIFJlbW92ZXMgYSByZWNvcmQgdG8gdGhlIGBSZWNvcmRBcnJheWAuCgogICAgQG1ldGhvZCByZW1vdmVSZWNvcmQKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge0RTLk1vZGVsfSByZWNvcmQKICAqLwogIHJlbW92ZVJlY29yZDogZnVuY3Rpb24ocmVjb3JkKSB7CiAgICBnZXQodGhpcywgJ2NvbnRlbnQnKS5yZW1vdmVPYmplY3QocmVjb3JkKTsKICB9LAoKICAvKioKICAgIFNhdmVzIGFsbCBvZiB0aGUgcmVjb3JkcyBpbiB0aGUgYFJlY29yZEFycmF5YC4KCiAgICBFeGFtcGxlCgogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIG1lc3NhZ2VzID0gc3RvcmUuYWxsKEFwcC5NZXNzYWdlKTsKICAgIG1lc3NhZ2VzLmZvckVhY2goZnVuY3Rpb24obWVzc2FnZSkgewogICAgICBtZXNzYWdlLnNldCgnaGFzQmVlblNlZW4nLCB0cnVlKTsKICAgIH0pOwogICAgbWVzc2FnZXMuc2F2ZSgpOwogICAgYGBgCgogICAgQG1ldGhvZCBzYXZlCiAgICBAcmV0dXJuIHtEUy5Qcm9taXNlQXJyYXl9IHByb21pc2UKICAqLwogIHNhdmU6IGZ1bmN0aW9uKCkgewogICAgdmFyIHByb21pc2VMYWJlbCA9ICJEUzogUmVjb3JkQXJyYXkjc2F2ZSAiICsgZ2V0KHRoaXMsICd0eXBlJyk7CiAgICB2YXIgcHJvbWlzZSA9IEVtYmVyLlJTVlAuYWxsKHRoaXMuaW52b2tlKCJzYXZlIiksIHByb21pc2VMYWJlbCkudGhlbihmdW5jdGlvbihhcnJheSkgewogICAgICByZXR1cm4gRW1iZXIuQShhcnJheSk7CiAgICB9LCBudWxsLCAiRFM6IFJlY29yZEFycmF5I3NhdmUgYXBwbHkgRW1iZXIuTmF0aXZlQXJyYXkiKTsKCiAgICByZXR1cm4gRFMuUHJvbWlzZUFycmF5LmNyZWF0ZSh7IHByb21pc2U6IHByb21pc2UgfSk7CiAgfQp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCiAgQG1vZHVsZSBlbWJlci1kYXRhCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0OwoKLyoqCiAgUmVwcmVzZW50cyBhIGxpc3Qgb2YgcmVjb3JkcyB3aG9zZSBtZW1iZXJzaGlwIGlzIGRldGVybWluZWQgYnkgdGhlCiAgc3RvcmUuIEFzIHJlY29yZHMgYXJlIGNyZWF0ZWQsIGxvYWRlZCwgb3IgbW9kaWZpZWQsIHRoZSBzdG9yZQogIGV2YWx1YXRlcyB0aGVtIHRvIGRldGVybWluZSBpZiB0aGV5IHNob3VsZCBiZSBwYXJ0IG9mIHRoZSByZWNvcmQKICBhcnJheS4KCiAgQGNsYXNzIEZpbHRlcmVkUmVjb3JkQXJyYXkKICBAbmFtZXNwYWNlIERTCiAgQGV4dGVuZHMgRFMuUmVjb3JkQXJyYXkKKi8KRFMuRmlsdGVyZWRSZWNvcmRBcnJheSA9IERTLlJlY29yZEFycmF5LmV4dGVuZCh7CiAgLyoqCiAgICBUaGUgZmlsdGVyRnVuY3Rpb24gaXMgYSBmdW5jdGlvbiB1c2VkIHRvIHRlc3QgcmVjb3JkcyBmcm9tIHRoZSBzdG9yZSB0bwogICAgZGV0ZXJtaW5lIGlmIHRoZXkgc2hvdWxkIGJlIHBhcnQgb2YgdGhlIHJlY29yZCBhcnJheS4KCiAgICBFeGFtcGxlCgogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIGFsbFBlb3BsZSA9IHN0b3JlLmFsbCgncGVyc29uJyk7CiAgICBhbGxQZW9wbGUubWFwQnkoJ25hbWUnKTsgLy8gWyJUb20gRGFsZSIsICJZZWh1ZGEgS2F0eiIsICJUcmVrIEdsb3dhY2tpIl0KCiAgICB2YXIgcGVvcGxlID0gc3RvcmUuZmlsdGVyKCdwZXJzb24nLCBmdW5jdGlvbihwZXJzb24pIHsKICAgICAgaWYgKHBlcnNvbi5nZXQoJ25hbWUnKS5tYXRjaCgvS2F0eiQvKSkgeyByZXR1cm4gdHJ1ZTsgfQogICAgfSk7CiAgICBwZW9wbGUubWFwQnkoJ25hbWUnKTsgLy8gWyJZZWh1ZGEgS2F0eiJdCgogICAgdmFyIG5vdEthdHpGaWx0ZXIgPSBmdW5jdGlvbihwZXJzb24pIHsKICAgICAgcmV0dXJuICFwZXJzb24uZ2V0KCduYW1lJykubWF0Y2goL0thdHokLyk7CiAgICB9OwogICAgcGVvcGxlLnNldCgnZmlsdGVyRnVuY3Rpb24nLCBub3RLYXR6RmlsdGVyKTsKICAgIHBlb3BsZS5tYXBCeSgnbmFtZScpOyAvLyBbIlRvbSBEYWxlIiwgIlRyZWsgR2xvd2Fja2kiXQogICAgYGBgCgogICAgQG1ldGhvZCBmaWx0ZXJGdW5jdGlvbgogICAgQHBhcmFtIHtEUy5Nb2RlbH0gcmVjb3JkCiAgICBAcmV0dXJuIHtCb29sZWFufSBgdHJ1ZWAgaWYgdGhlIHJlY29yZCBzaG91bGQgYmUgaW4gdGhlIGFycmF5CiAgKi8KICBmaWx0ZXJGdW5jdGlvbjogbnVsbCwKICBpc0xvYWRlZDogdHJ1ZSwKCiAgcmVwbGFjZTogZnVuY3Rpb24oKSB7CiAgICB2YXIgdHlwZSA9IGdldCh0aGlzLCAndHlwZScpLnRvU3RyaW5nKCk7CiAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSByZXN1bHQgb2YgYSBjbGllbnQtc2lkZSBmaWx0ZXIgKG9uICIgKyB0eXBlICsgIikgaXMgaW1tdXRhYmxlLiIpOwogIH0sCgogIC8qKgogICAgQG1ldGhvZCB1cGRhdGVGaWx0ZXIKICAgIEBwcml2YXRlCiAgKi8KICB1cGRhdGVGaWx0ZXI6IEVtYmVyLm9ic2VydmVyKGZ1bmN0aW9uKCkgewogICAgdmFyIG1hbmFnZXIgPSBnZXQodGhpcywgJ21hbmFnZXInKTsKICAgIG1hbmFnZXIudXBkYXRlRmlsdGVyKHRoaXMsIGdldCh0aGlzLCAndHlwZScpLCBnZXQodGhpcywgJ2ZpbHRlckZ1bmN0aW9uJykpOwogIH0sICdmaWx0ZXJGdW5jdGlvbicpCn0pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKICBAbW9kdWxlIGVtYmVyLWRhdGEKKi8KCnZhciBnZXQgPSBFbWJlci5nZXQsIHNldCA9IEVtYmVyLnNldDsKCi8qKgogIFJlcHJlc2VudHMgYW4gb3JkZXJlZCBsaXN0IG9mIHJlY29yZHMgd2hvc2Ugb3JkZXIgYW5kIG1lbWJlcnNoaXAgaXMKICBkZXRlcm1pbmVkIGJ5IHRoZSBhZGFwdGVyLiBGb3IgZXhhbXBsZSwgYSBxdWVyeSBzZW50IHRvIHRoZSBhZGFwdGVyCiAgbWF5IHRyaWdnZXIgYSBzZWFyY2ggb24gdGhlIHNlcnZlciwgd2hvc2UgcmVzdWx0cyB3b3VsZCBiZSBsb2FkZWQKICBpbnRvIGFuIGluc3RhbmNlIG9mIHRoZSBgQWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5YC4KCiAgQGNsYXNzIEFkYXB0ZXJQb3B1bGF0ZWRSZWNvcmRBcnJheQogIEBuYW1lc3BhY2UgRFMKICBAZXh0ZW5kcyBEUy5SZWNvcmRBcnJheQoqLwpEUy5BZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXkgPSBEUy5SZWNvcmRBcnJheS5leHRlbmQoewogIHF1ZXJ5OiBudWxsLAoKICByZXBsYWNlOiBmdW5jdGlvbigpIHsKICAgIHZhciB0eXBlID0gZ2V0KHRoaXMsICd0eXBlJykudG9TdHJpbmcoKTsKICAgIHRocm93IG5ldyBFcnJvcigiVGhlIHJlc3VsdCBvZiBhIHNlcnZlciBxdWVyeSAob24gIiArIHR5cGUgKyAiKSBpcyBpbW11dGFibGUuIik7CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIGxvYWQKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge0FycmF5fSBkYXRhCiAgKi8KICBsb2FkOiBmdW5jdGlvbihkYXRhKSB7CiAgICB2YXIgc3RvcmUgPSBnZXQodGhpcywgJ3N0b3JlJyksCiAgICAgICAgdHlwZSA9IGdldCh0aGlzLCAndHlwZScpLAogICAgICAgIHJlY29yZHMgPSBzdG9yZS5wdXNoTWFueSh0eXBlLCBkYXRhKSwKICAgICAgICBtZXRhID0gc3RvcmUubWV0YWRhdGFGb3IodHlwZSk7CgogICAgdGhpcy5zZXRQcm9wZXJ0aWVzKHsKICAgICAgY29udGVudDogRW1iZXIuQShyZWNvcmRzKSwKICAgICAgaXNMb2FkZWQ6IHRydWUsCiAgICAgIG1ldGE6IG1ldGEKICAgIH0pOwoKICAgIC8vIFRPRE86IGRvZXMgdHJpZ2dlcmluZyBkaWRMb2FkIGV2ZW50IHNob3VsZCBiZSB0aGUgbGFzdCBhY3Rpb24gb2YgdGhlIHJ1bkxvb3A/CiAgICBFbWJlci5ydW4ub25jZSh0aGlzLCAndHJpZ2dlcicsICdkaWRMb2FkJyk7CiAgfQp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCiAgQG1vZHVsZSBlbWJlci1kYXRhCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQ7CnZhciBtYXAgPSBFbWJlci5FbnVtZXJhYmxlVXRpbHMubWFwOwoKLyoqCiAgQSBgTWFueUFycmF5YCBpcyBhIGBSZWNvcmRBcnJheWAgdGhhdCByZXByZXNlbnRzIHRoZSBjb250ZW50cyBvZiBhIGhhcy1tYW55CiAgcmVsYXRpb25zaGlwLgoKICBUaGUgYE1hbnlBcnJheWAgaXMgaW5zdGFudGlhdGVkIGxhemlseSB0aGUgZmlyc3QgdGltZSB0aGUgcmVsYXRpb25zaGlwIGlzCiAgcmVxdWVzdGVkLgoKICAjIyMgSW52ZXJzZXMKCiAgT2Z0ZW4sIHRoZSByZWxhdGlvbnNoaXBzIGluIEVtYmVyIERhdGEgYXBwbGljYXRpb25zIHdpbGwgaGF2ZQogIGFuIGludmVyc2UuIEZvciBleGFtcGxlLCBpbWFnaW5lIHRoZSBmb2xsb3dpbmcgbW9kZWxzIGFyZQogIGRlZmluZWQ6CgogIGBgYGphdmFzY3JpcHQKICBBcHAuUG9zdCA9IERTLk1vZGVsLmV4dGVuZCh7CiAgICBjb21tZW50czogRFMuaGFzTWFueSgnY29tbWVudCcpCiAgfSk7CgogIEFwcC5Db21tZW50ID0gRFMuTW9kZWwuZXh0ZW5kKHsKICAgIHBvc3Q6IERTLmJlbG9uZ3NUbygncG9zdCcpCiAgfSk7CiAgYGBgCgogIElmIHlvdSBjcmVhdGVkIGEgbmV3IGluc3RhbmNlIG9mIGBBcHAuUG9zdGAgYW5kIGFkZGVkCiAgYSBgQXBwLkNvbW1lbnRgIHJlY29yZCB0byBpdHMgYGNvbW1lbnRzYCBoYXMtbWFueQogIHJlbGF0aW9uc2hpcCwgeW91IHdvdWxkIGV4cGVjdCB0aGUgY29tbWVudCdzIGBwb3N0YAogIHByb3BlcnR5IHRvIGJlIHNldCB0byB0aGUgcG9zdCB0aGF0IGNvbnRhaW5lZAogIHRoZSBoYXMtbWFueS4KCiAgV2UgY2FsbCB0aGUgcmVjb3JkIHRvIHdoaWNoIGEgcmVsYXRpb25zaGlwIGJlbG9uZ3MgdGhlCiAgcmVsYXRpb25zaGlwJ3MgX293bmVyXy4KCiAgQGNsYXNzIE1hbnlBcnJheQogIEBuYW1lc3BhY2UgRFMKICBAZXh0ZW5kcyBEUy5SZWNvcmRBcnJheQoqLwpEUy5NYW55QXJyYXkgPSBEUy5SZWNvcmRBcnJheS5leHRlbmQoewogIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMuX2NoYW5nZXNUb1N5bmMgPSBFbWJlci5PcmRlcmVkU2V0LmNyZWF0ZSgpOwogIH0sCgogIC8qKgogICAgVGhlIHByb3BlcnR5IG5hbWUgb2YgdGhlIHJlbGF0aW9uc2hpcAoKICAgIEBwcm9wZXJ0eSB7U3RyaW5nfSBuYW1lCiAgICBAcHJpdmF0ZQogICovCiAgbmFtZTogbnVsbCwKCiAgLyoqCiAgICBUaGUgcmVjb3JkIHRvIHdoaWNoIHRoaXMgcmVsYXRpb25zaGlwIGJlbG9uZ3MuCgogICAgQHByb3BlcnR5IHtEUy5Nb2RlbH0gb3duZXIKICAgIEBwcml2YXRlCiAgKi8KICBvd25lcjogbnVsbCwKCiAgLyoqCiAgICBgdHJ1ZWAgaWYgdGhlIHJlbGF0aW9uc2hpcCBpcyBwb2x5bW9ycGhpYywgYGZhbHNlYCBvdGhlcndpc2UuCgogICAgQHByb3BlcnR5IHtCb29sZWFufSBpc1BvbHltb3JwaGljCiAgICBAcHJpdmF0ZQogICovCiAgaXNQb2x5bW9ycGhpYzogZmFsc2UsCgogIC8vIExPQURJTkcgU1RBVEUKCiAgaXNMb2FkZWQ6IGZhbHNlLAoKICAvKioKICAgIFVzZWQgZm9yIGFzeW5jIGBoYXNNYW55YCBhcnJheXMKICAgIHRvIGtlZXAgdHJhY2sgb2Ygd2hlbiB0aGV5IHdpbGwgcmVzb2x2ZS4KCiAgICBAcHJvcGVydHkge0VtYmVyLlJTVlAuUHJvbWlzZX0gcHJvbWlzZQogICAgQHByaXZhdGUKICAqLwogIHByb21pc2U6IG51bGwsCgogIC8qKgogICAgQG1ldGhvZCBsb2FkaW5nUmVjb3Jkc0NvdW50CiAgICBAcGFyYW0ge051bWJlcn0gY291bnQKICAgIEBwcml2YXRlCiAgKi8KICBsb2FkaW5nUmVjb3Jkc0NvdW50OiBmdW5jdGlvbihjb3VudCkgewogICAgdGhpcy5sb2FkaW5nUmVjb3Jkc0NvdW50ID0gY291bnQ7CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIGxvYWRlZFJlY29yZAogICAgQHByaXZhdGUKICAqLwogIGxvYWRlZFJlY29yZDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLmxvYWRpbmdSZWNvcmRzQ291bnQtLTsKICAgIGlmICh0aGlzLmxvYWRpbmdSZWNvcmRzQ291bnQgPT09IDApIHsKICAgICAgc2V0KHRoaXMsICdpc0xvYWRlZCcsIHRydWUpOwogICAgICB0aGlzLnRyaWdnZXIoJ2RpZExvYWQnKTsKICAgIH0KICB9LAoKICAvKioKICAgIEBtZXRob2QgZmV0Y2gKICAgIEBwcml2YXRlCiAgKi8KICBmZXRjaDogZnVuY3Rpb24oKSB7CiAgICB2YXIgcmVjb3JkcyA9IGdldCh0aGlzLCAnY29udGVudCcpLAogICAgICAgIHN0b3JlID0gZ2V0KHRoaXMsICdzdG9yZScpLAogICAgICAgIG93bmVyID0gZ2V0KHRoaXMsICdvd25lcicpLAogICAgICAgIHJlc29sdmVyID0gRW1iZXIuUlNWUC5kZWZlcigiRFM6IE1hbnlBcnJheSNmZXRjaCAiICsgZ2V0KHRoaXMsICd0eXBlJykpOwoKICAgIHZhciB1bmxvYWRlZFJlY29yZHMgPSByZWNvcmRzLmZpbHRlclByb3BlcnR5KCdpc0VtcHR5JywgdHJ1ZSk7CiAgICBzdG9yZS5mZXRjaE1hbnkodW5sb2FkZWRSZWNvcmRzLCBvd25lciwgcmVzb2x2ZXIpOwogIH0sCgogIC8vIE92ZXJyaWRlcyBFbWJlci5BcnJheSdzIHJlcGxhY2UgbWV0aG9kIHRvIGltcGxlbWVudAogIHJlcGxhY2VDb250ZW50OiBmdW5jdGlvbihpbmRleCwgcmVtb3ZlZCwgYWRkZWQpIHsKICAgIC8vIE1hcCB0aGUgYXJyYXkgb2YgcmVjb3JkIG9iamVjdHMgaW50byBhbiBhcnJheSBvZiAgY2xpZW50IGlkcy4KICAgIGFkZGVkID0gbWFwKGFkZGVkLCBmdW5jdGlvbihyZWNvcmQpIHsKICAgICAgRW1iZXIuYXNzZXJ0KCJZb3UgY2Fubm90IGFkZCAnIiArIHJlY29yZC5jb25zdHJ1Y3Rvci50eXBlS2V5ICsgIicgcmVjb3JkcyB0byB0aGlzIHJlbGF0aW9uc2hpcCAob25seSAnIiArIHRoaXMudHlwZS50eXBlS2V5ICsgIicgYWxsb3dlZCkiLCAhdGhpcy50eXBlIHx8IHJlY29yZCBpbnN0YW5jZW9mIHRoaXMudHlwZSk7CiAgICAgIHJldHVybiByZWNvcmQ7CiAgICB9LCB0aGlzKTsKCiAgICB0aGlzLl9zdXBlcihpbmRleCwgcmVtb3ZlZCwgYWRkZWQpOwogIH0sCgogIGFycmFuZ2VkQ29udGVudERpZENoYW5nZTogZnVuY3Rpb24oKSB7CiAgICBFbWJlci5ydW4ub25jZSh0aGlzLCAnZmV0Y2gnKTsKICB9LAoKICBhcnJheUNvbnRlbnRXaWxsQ2hhbmdlOiBmdW5jdGlvbihpbmRleCwgcmVtb3ZlZCwgYWRkZWQpIHsKICAgIHZhciBvd25lciA9IGdldCh0aGlzLCAnb3duZXInKSwKICAgICAgICBuYW1lID0gZ2V0KHRoaXMsICduYW1lJyk7CgogICAgaWYgKCFvd25lci5fc3VzcGVuZGVkUmVsYXRpb25zaGlwcykgewogICAgICAvLyBUaGlzIGNvZGUgaXMgdGhlIGZpcnN0IGhhbGYgb2YgY29kZSB0aGF0IGNvbnRpbnVlcyBpbnNpZGUKICAgICAgLy8gb2YgYXJyYXlDb250ZW50RGlkQ2hhbmdlLiBJdCBnZXRzIG9yIGNyZWF0ZXMgYSBjaGFuZ2UgZnJvbQogICAgICAvLyB0aGUgY2hpbGQgb2JqZWN0LCBhZGRzIHRoZSBjdXJyZW50IG93bmVyIGFzIHRoZSBvbGQKICAgICAgLy8gcGFyZW50IGlmIHRoaXMgaXMgdGhlIGZpcnN0IHRpbWUgdGhlIG9iamVjdCB3YXMgcmVtb3ZlZAogICAgICAvLyBmcm9tIGEgTWFueUFycmF5LCBhbmQgc2V0cyBgbmV3UGFyZW50YCB0byBudWxsLgogICAgICAvLwogICAgICAvLyBMYXRlciwgaWYgdGhlIG9iamVjdCBpcyBhZGRlZCB0byBhbm90aGVyIE1hbnlBcnJheSwKICAgICAgLy8gdGhlIGBhcnJheUNvbnRlbnREaWRDaGFuZ2VgIHdpbGwgc2V0IGBuZXdQYXJlbnRgIG9uCiAgICAgIC8vIHRoZSBjaGFuZ2UuCiAgICAgIGZvciAodmFyIGk9aW5kZXg7IGk8aW5kZXgrcmVtb3ZlZDsgaSsrKSB7CiAgICAgICAgdmFyIHJlY29yZCA9IGdldCh0aGlzLCAnY29udGVudCcpLm9iamVjdEF0KGkpOwoKICAgICAgICB2YXIgY2hhbmdlID0gRFMuUmVsYXRpb25zaGlwQ2hhbmdlLmNyZWF0ZUNoYW5nZShvd25lciwgcmVjb3JkLCBnZXQodGhpcywgJ3N0b3JlJyksIHsKICAgICAgICAgIHBhcmVudFR5cGU6IG93bmVyLmNvbnN0cnVjdG9yLAogICAgICAgICAgY2hhbmdlVHlwZTogInJlbW92ZSIsCiAgICAgICAgICBraW5kOiAiaGFzTWFueSIsCiAgICAgICAgICBrZXk6IG5hbWUKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5fY2hhbmdlc1RvU3luYy5hZGQoY2hhbmdlKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0sCgogIGFycmF5Q29udGVudERpZENoYW5nZTogZnVuY3Rpb24oaW5kZXgsIHJlbW92ZWQsIGFkZGVkKSB7CiAgICB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgIHZhciBvd25lciA9IGdldCh0aGlzLCAnb3duZXInKSwKICAgICAgICBuYW1lID0gZ2V0KHRoaXMsICduYW1lJyksCiAgICAgICAgc3RvcmUgPSBnZXQodGhpcywgJ3N0b3JlJyk7CgogICAgaWYgKCFvd25lci5fc3VzcGVuZGVkUmVsYXRpb25zaGlwcykgewogICAgICAvLyBUaGlzIGNvZGUgaXMgdGhlIHNlY29uZCBoYWxmIG9mIGNvZGUgdGhhdCBzdGFydGVkIGluCiAgICAgIC8vIGBhcnJheUNvbnRlbnRXaWxsQ2hhbmdlYC4gSXQgZ2V0cyBvciBjcmVhdGVzIGEgY2hhbmdlCiAgICAgIC8vIGZyb20gdGhlIGNoaWxkIG9iamVjdCwgYW5kIGFkZHMgdGhlIGN1cnJlbnQgb3duZXIgYXMKICAgICAgLy8gdGhlIG5ldyBwYXJlbnQuCiAgICAgIGZvciAodmFyIGk9aW5kZXg7IGk8aW5kZXgrYWRkZWQ7IGkrKykgewogICAgICAgIHZhciByZWNvcmQgPSBnZXQodGhpcywgJ2NvbnRlbnQnKS5vYmplY3RBdChpKTsKCiAgICAgICAgdmFyIGNoYW5nZSA9IERTLlJlbGF0aW9uc2hpcENoYW5nZS5jcmVhdGVDaGFuZ2Uob3duZXIsIHJlY29yZCwgc3RvcmUsIHsKICAgICAgICAgIHBhcmVudFR5cGU6IG93bmVyLmNvbnN0cnVjdG9yLAogICAgICAgICAgY2hhbmdlVHlwZTogImFkZCIsCiAgICAgICAgICBraW5kOiJoYXNNYW55IiwKICAgICAgICAgIGtleTogbmFtZQogICAgICAgIH0pOwogICAgICAgIGNoYW5nZS5oYXNNYW55TmFtZSA9IG5hbWU7CgogICAgICAgIHRoaXMuX2NoYW5nZXNUb1N5bmMuYWRkKGNoYW5nZSk7CiAgICAgIH0KCiAgICAgIC8vIFdlIHdhaXQgdW50aWwgdGhlIGFycmF5IGhhcyBmaW5pc2hlZCBiZWluZwogICAgICAvLyBtdXRhdGVkIGJlZm9yZSBzeW5jaW5nIHRoZSBPbmVUb01hbnlDaGFuZ2VzIGNyZWF0ZWQKICAgICAgLy8gaW4gYXJyYXlDb250ZW50V2lsbENoYW5nZSwgc28gdGhhdCB0aGUgYXJyYXkKICAgICAgLy8gbWVtYmVyc2hpcCB0ZXN0IGluIHRoZSBzeW5jKCkgbG9naWMgb3BlcmF0ZXMKICAgICAgLy8gb24gdGhlIGZpbmFsIHJlc3VsdHMuCiAgICAgIHRoaXMuX2NoYW5nZXNUb1N5bmMuZm9yRWFjaChmdW5jdGlvbihjaGFuZ2UpIHsKICAgICAgICBjaGFuZ2Uuc3luYygpOwogICAgICB9KTsKCiAgICAgIHRoaXMuX2NoYW5nZXNUb1N5bmMuY2xlYXIoKTsKICAgIH0KICB9LAoKICAvKioKICAgIENyZWF0ZSBhIGNoaWxkIHJlY29yZCB3aXRoaW4gdGhlIG93bmVyCgogICAgQG1ldGhvZCBjcmVhdGVSZWNvcmQKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge09iamVjdH0gaGFzaAogICAgQHJldHVybiB7RFMuTW9kZWx9IHJlY29yZAogICovCiAgY3JlYXRlUmVjb3JkOiBmdW5jdGlvbihoYXNoKSB7CiAgICB2YXIgb3duZXIgPSBnZXQodGhpcywgJ293bmVyJyksCiAgICAgICAgc3RvcmUgPSBnZXQob3duZXIsICdzdG9yZScpLAogICAgICAgIHR5cGUgPSBnZXQodGhpcywgJ3R5cGUnKSwKICAgICAgICByZWNvcmQ7CgogICAgRW1iZXIuYXNzZXJ0KCJZb3UgY2Fubm90IGFkZCAnIiArIHR5cGUudHlwZUtleSArICInIHJlY29yZHMgdG8gdGhpcyBwb2x5bW9ycGhpYyByZWxhdGlvbnNoaXAuIiwgIWdldCh0aGlzLCAnaXNQb2x5bW9ycGhpYycpKTsKCiAgICByZWNvcmQgPSBzdG9yZS5jcmVhdGVSZWNvcmQuY2FsbChzdG9yZSwgdHlwZSwgaGFzaCk7CiAgICB0aGlzLnB1c2hPYmplY3QocmVjb3JkKTsKCiAgICByZXR1cm4gcmVjb3JkOwogIH0KCn0pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKICBAbW9kdWxlIGVtYmVyLWRhdGEKKi8KCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLypnbG9iYWxzIEVtYmVyKi8KLypqc2hpbnQgZXFudWxsOnRydWUqLwovKioKICBAbW9kdWxlIGVtYmVyLWRhdGEKKi8KCnZhciBnZXQgPSBFbWJlci5nZXQsIHNldCA9IEVtYmVyLnNldDsKdmFyIG9uY2UgPSBFbWJlci5ydW4ub25jZTsKdmFyIGlzTm9uZSA9IEVtYmVyLmlzTm9uZTsKdmFyIGZvckVhY2ggPSBFbWJlci5FbnVtZXJhYmxlVXRpbHMuZm9yRWFjaDsKdmFyIGluZGV4T2YgPSBFbWJlci5FbnVtZXJhYmxlVXRpbHMuaW5kZXhPZjsKdmFyIG1hcCA9IEVtYmVyLkVudW1lcmFibGVVdGlscy5tYXA7CnZhciByZXNvbHZlID0gRW1iZXIuUlNWUC5yZXNvbHZlOwp2YXIgY29weSA9IEVtYmVyLmNvcHk7CgovLyBJbXBsZW1lbnRvcnMgTm90ZToKLy8KLy8gICBUaGUgdmFyaWFibGVzIGluIHRoaXMgZmlsZSBhcmUgY29uc2lzdGVudGx5IG5hbWVkIGFjY29yZGluZyB0byB0aGUgZm9sbG93aW5nCi8vICAgc2NoZW1lOgovLwovLyAgICogK2lkKyBtZWFucyBhbiBpZGVudGlmaWVyIG1hbmFnZWQgYnkgYW4gZXh0ZXJuYWwgc291cmNlLCBwcm92aWRlZCBpbnNpZGUKLy8gICAgIHRoZSBkYXRhIHByb3ZpZGVkIGJ5IHRoYXQgc291cmNlLiBUaGVzZSBhcmUgYWx3YXlzIGNvZXJjZWQgdG8gYmUgc3RyaW5ncwovLyAgICAgYmVmb3JlIGJlaW5nIHVzZWQgaW50ZXJuYWxseS4KLy8gICAqICtjbGllbnRJZCsgbWVhbnMgYSB0cmFuc2llbnQgbnVtZXJpY2FsIGlkZW50aWZpZXIgZ2VuZXJhdGVkIGF0IHJ1bnRpbWUgYnkKLy8gICAgIHRoZSBkYXRhIHN0b3JlLiBJdCBpcyBpbXBvcnRhbnQgcHJpbWFyaWx5IGJlY2F1c2UgbmV3bHkgY3JlYXRlZCBvYmplY3RzIG1heQovLyAgICAgbm90IHlldCBoYXZlIGFuIGV4dGVybmFsbHkgZ2VuZXJhdGVkIGlkLgovLyAgICogK3JlZmVyZW5jZSsgbWVhbnMgYSByZWNvcmQgcmVmZXJlbmNlIG9iamVjdCwgd2hpY2ggaG9sZHMgbWV0YWRhdGEgYWJvdXQgYQovLyAgICAgcmVjb3JkLCBldmVuIGlmIGl0IGhhcyBub3QgeWV0IGJlZW4gZnVsbHkgbWF0ZXJpYWxpemVkLgovLyAgICogK3R5cGUrIG1lYW5zIGEgc3ViY2xhc3Mgb2YgRFMuTW9kZWwuCgovLyBVc2VkIGJ5IHRoZSBzdG9yZSB0byBub3JtYWxpemUgSURzIGVudGVyaW5nIHRoZSBzdG9yZS4gIERlc3BpdGUgdGhlIGZhY3QKLy8gdGhhdCBkZXZlbG9wZXJzIG1heSBwcm92aWRlIElEcyBhcyBudW1iZXJzIChlLmcuLCBgc3RvcmUuZmluZChQZXJzb24sIDEpYCksCi8vIGl0IGlzIGltcG9ydGFudCB0aGF0IGludGVybmFsbHkgd2UgdXNlIHN0cmluZ3MsIHNpbmNlIElEcyBtYXkgYmUgc2VyaWFsaXplZAovLyBhbmQgbG9zZSB0eXBlIGluZm9ybWF0aW9uLiAgRm9yIGV4YW1wbGUsIEVtYmVyJ3Mgcm91dGVyIG1heSBwdXQgYSByZWNvcmQncwovLyBJRCBpbnRvIHRoZSBVUkwsIGFuZCBpZiB3ZSBsYXRlciB0cnkgdG8gZGVzZXJpYWxpemUgdGhhdCBVUkwgYW5kIGZpbmQgdGhlCi8vIGNvcnJlc3BvbmRpbmcgcmVjb3JkLCB3ZSB3aWxsIG5vdCBrbm93IGlmIGl0IGlzIGEgc3RyaW5nIG9yIGEgbnVtYmVyLgp2YXIgY29lcmNlSWQgPSBmdW5jdGlvbihpZCkgewogIHJldHVybiBpZCA9PSBudWxsID8gbnVsbCA6IGlkKycnOwp9OwoKLyoqCiAgVGhlIHN0b3JlIGNvbnRhaW5zIGFsbCBvZiB0aGUgZGF0YSBmb3IgcmVjb3JkcyBsb2FkZWQgZnJvbSB0aGUgc2VydmVyLgogIEl0IGlzIGFsc28gcmVzcG9uc2libGUgZm9yIGNyZWF0aW5nIGluc3RhbmNlcyBvZiBgRFMuTW9kZWxgIHRoYXQgd3JhcAogIHRoZSBpbmRpdmlkdWFsIGRhdGEgZm9yIGEgcmVjb3JkLCBzbyB0aGF0IHRoZXkgY2FuIGJlIGJvdW5kIHRvIGluIHlvdXIKICBIYW5kbGViYXJzIHRlbXBsYXRlcy4KCiAgRGVmaW5lIHlvdXIgYXBwbGljYXRpb24ncyBzdG9yZSBsaWtlIHRoaXM6CgogIGBgYGphdmFzY3JpcHQKICBNeUFwcC5TdG9yZSA9IERTLlN0b3JlLmV4dGVuZCgpOwogIGBgYAoKICBNb3N0IEVtYmVyLmpzIGFwcGxpY2F0aW9ucyB3aWxsIG9ubHkgaGF2ZSBhIHNpbmdsZSBgRFMuU3RvcmVgIHRoYXQgaXMKICBhdXRvbWF0aWNhbGx5IGNyZWF0ZWQgYnkgdGhlaXIgYEVtYmVyLkFwcGxpY2F0aW9uYC4KCiAgWW91IGNhbiByZXRyaWV2ZSBtb2RlbHMgZnJvbSB0aGUgc3RvcmUgaW4gc2V2ZXJhbCB3YXlzLiBUbyByZXRyaWV2ZSBhIHJlY29yZAogIGZvciBhIHNwZWNpZmljIGlkLCB1c2UgYERTLlN0b3JlYCdzIGBmaW5kKClgIG1ldGhvZDoKCiAgYGBgamF2YXNjcmlwdAogIHZhciBwZXJzb24gPSBzdG9yZS5maW5kKCdwZXJzb24nLCAxMjMpOwogIGBgYAoKICBJZiB5b3VyIGFwcGxpY2F0aW9uIGhhcyBtdWx0aXBsZSBgRFMuU3RvcmVgIGluc3RhbmNlcyAoYW4gdW51c3VhbCBjYXNlKSwgeW91IGNhbgogIHNwZWNpZnkgd2hpY2ggc3RvcmUgc2hvdWxkIGJlIHVzZWQ6CgogIGBgYGphdmFzY3JpcHQKICB2YXIgcGVyc29uID0gc3RvcmUuZmluZChBcHAuUGVyc29uLCAxMjMpOwogIGBgYAoKICBCeSBkZWZhdWx0LCB0aGUgc3RvcmUgd2lsbCB0YWxrIHRvIHlvdXIgYmFja2VuZCB1c2luZyBhIHN0YW5kYXJkCiAgUkVTVCBtZWNoYW5pc20uIFlvdSBjYW4gY3VzdG9taXplIGhvdyB0aGUgc3RvcmUgdGFsa3MgdG8geW91cgogIGJhY2tlbmQgYnkgc3BlY2lmeWluZyBhIGN1c3RvbSBhZGFwdGVyOgoKICBgYGBqYXZhc2NyaXB0CiAgIE15QXBwLnN0b3JlID0gRFMuU3RvcmUuY3JlYXRlKHsKICAgICBhZGFwdGVyOiAnTXlBcHAuQ3VzdG9tQWRhcHRlcicKICAgfSk7CiAgIGBgYAoKICBZb3UgY2FuIGxlYXJuIG1vcmUgYWJvdXQgd3JpdGluZyBhIGN1c3RvbSBhZGFwdGVyIGJ5IHJlYWRpbmcgdGhlIGBEUy5BZGFwdGVyYAogIGRvY3VtZW50YXRpb24uCgogIEBjbGFzcyBTdG9yZQogIEBuYW1lc3BhY2UgRFMKICBAZXh0ZW5kcyBFbWJlci5PYmplY3QKKi8KRFMuU3RvcmUgPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKCiAgLyoqCiAgICBAbWV0aG9kIGluaXQKICAgIEBwcml2YXRlCiAgKi8KICBpbml0OiBmdW5jdGlvbigpIHsKICAgIC8vIGludGVybmFsIGJvb2trZWVwaW5nOyBub3Qgb2JzZXJ2YWJsZQogICAgdGhpcy50eXBlTWFwcyA9IHt9OwogICAgdGhpcy5yZWNvcmRBcnJheU1hbmFnZXIgPSBEUy5SZWNvcmRBcnJheU1hbmFnZXIuY3JlYXRlKHsKICAgICAgc3RvcmU6IHRoaXMKICAgIH0pOwogICAgdGhpcy5fcmVsYXRpb25zaGlwQ2hhbmdlcyA9IHt9OwogICAgdGhpcy5fcGVuZGluZ1NhdmUgPSBbXTsKICB9LAoKICAvKioKICAgIFRoZSBhZGFwdGVyIHRvIHVzZSB0byBjb21tdW5pY2F0ZSB0byBhIGJhY2tlbmQgc2VydmVyIG9yIG90aGVyIHBlcnNpc3RlbmNlIGxheWVyLgoKICAgIFRoaXMgY2FuIGJlIHNwZWNpZmllZCBhcyBhbiBpbnN0YW5jZSwgY2xhc3MsIG9yIHN0cmluZy4KCiAgICBJZiB5b3Ugd2FudCB0byBzcGVjaWZ5IGBBcHAuQ3VzdG9tQWRhcHRlcmAgYXMgYSBzdHJpbmcsIGRvOgoKICAgIGBgYGpzCiAgICBhZGFwdGVyOiAnY3VzdG9tJwogICAgYGBgCgogICAgQHByb3BlcnR5IGFkYXB0ZXIKICAgIEBkZWZhdWx0IERTLlJFU1RBZGFwdGVyCiAgICBAdHlwZSB7RFMuQWRhcHRlcnxTdHJpbmd9CiAgKi8KICBhZGFwdGVyOiAnX3Jlc3QnLAoKICAvKioKICAgIFJldHVybnMgYSBKU09OIHJlcHJlc2VudGF0aW9uIG9mIHRoZSByZWNvcmQgdXNpbmcgYSBjdXN0b20KICAgIHR5cGUtc3BlY2lmaWMgc2VyaWFsaXplciwgaWYgb25lIGV4aXN0cy4KCiAgICBUaGUgYXZhaWxhYmxlIG9wdGlvbnMgYXJlOgoKICAgICogYGluY2x1ZGVJZGA6IGB0cnVlYCBpZiB0aGUgcmVjb3JkJ3MgSUQgc2hvdWxkIGJlIGluY2x1ZGVkIGluCiAgICAgIHRoZSBKU09OIHJlcHJlc2VudGF0aW9uCgogICAgQG1ldGhvZCBzZXJpYWxpemUKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge0RTLk1vZGVsfSByZWNvcmQgdGhlIHJlY29yZCB0byBzZXJpYWxpemUKICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIGFuIG9wdGlvbnMgaGFzaAogICovCiAgc2VyaWFsaXplOiBmdW5jdGlvbihyZWNvcmQsIG9wdGlvbnMpIHsKICAgIHJldHVybiB0aGlzLnNlcmlhbGl6ZXJGb3IocmVjb3JkLmNvbnN0cnVjdG9yLnR5cGVLZXkpLnNlcmlhbGl6ZShyZWNvcmQsIG9wdGlvbnMpOwogIH0sCgogIC8qKgogICAgVGhpcyBwcm9wZXJ0eSByZXR1cm5zIHRoZSBhZGFwdGVyLCBhZnRlciByZXNvbHZpbmcgYSBwb3NzaWJsZQogICAgc3RyaW5nIGtleS4KCiAgICBJZiB0aGUgc3VwcGxpZWQgYGFkYXB0ZXJgIHdhcyBhIGNsYXNzLCBvciBhIFN0cmluZyBwcm9wZXJ0eQogICAgcGF0aCByZXNvbHZlZCB0byBhIGNsYXNzLCB0aGlzIHByb3BlcnR5IHdpbGwgaW5zdGFudGlhdGUgdGhlCiAgICBjbGFzcy4KCiAgICBUaGlzIHByb3BlcnR5IGlzIGNhY2hlYWJsZSwgc28gdGhlIHNhbWUgaW5zdGFuY2Ugb2YgYSBzcGVjaWZpZWQKICAgIGFkYXB0ZXIgY2xhc3Mgc2hvdWxkIGJlIHVzZWQgZm9yIHRoZSBsaWZldGltZSBvZiB0aGUgc3RvcmUuCgogICAgQHByb3BlcnR5IGRlZmF1bHRBZGFwdGVyCiAgICBAcHJpdmF0ZQogICAgQHJldHVybnMgRFMuQWRhcHRlcgogICovCiAgZGVmYXVsdEFkYXB0ZXI6IEVtYmVyLmNvbXB1dGVkKCdhZGFwdGVyJywgZnVuY3Rpb24oKSB7CiAgICB2YXIgYWRhcHRlciA9IGdldCh0aGlzLCAnYWRhcHRlcicpOwoKICAgIEVtYmVyLmFzc2VydCgnWW91IHRyaWVkIHRvIHNldCBgYWRhcHRlcmAgcHJvcGVydHkgdG8gYW4gaW5zdGFuY2Ugb2YgYERTLkFkYXB0ZXJgLCB3aGVyZSBpdCBzaG91bGQgYmUgYSBuYW1lIG9yIGEgZmFjdG9yeScsICEoYWRhcHRlciBpbnN0YW5jZW9mIERTLkFkYXB0ZXIpKTsKCiAgICBpZiAodHlwZW9mIGFkYXB0ZXIgPT09ICdzdHJpbmcnKSB7CiAgICAgIGFkYXB0ZXIgPSB0aGlzLmNvbnRhaW5lci5sb29rdXAoJ2FkYXB0ZXI6JyArIGFkYXB0ZXIpIHx8IHRoaXMuY29udGFpbmVyLmxvb2t1cCgnYWRhcHRlcjphcHBsaWNhdGlvbicpIHx8IHRoaXMuY29udGFpbmVyLmxvb2t1cCgnYWRhcHRlcjpfcmVzdCcpOwogICAgfQoKICAgIGlmIChEUy5BZGFwdGVyLmRldGVjdChhZGFwdGVyKSkgewogICAgICBhZGFwdGVyID0gYWRhcHRlci5jcmVhdGUoeyBjb250YWluZXI6IHRoaXMuY29udGFpbmVyIH0pOwogICAgfQoKICAgIHJldHVybiBhZGFwdGVyOwogIH0pLAoKICAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4KICAvLyAuIENSRUFURSBORVcgUkVDT1JEIC4KICAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4KCiAgLyoqCiAgICBDcmVhdGUgYSBuZXcgcmVjb3JkIGluIHRoZSBjdXJyZW50IHN0b3JlLiBUaGUgcHJvcGVydGllcyBwYXNzZWQKICAgIHRvIHRoaXMgbWV0aG9kIGFyZSBzZXQgb24gdGhlIG5ld2x5IGNyZWF0ZWQgcmVjb3JkLgoKICAgIFRvIGNyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBgQXBwLlBvc3RgOgoKICAgIGBgYGpzCiAgICBzdG9yZS5jcmVhdGVSZWNvcmQoJ3Bvc3QnLCB7CiAgICAgIHRpdGxlOiAiUmFpbHMgaXMgb21ha2FzZSIKICAgIH0pOwogICAgYGBgCgogICAgQG1ldGhvZCBjcmVhdGVSZWNvcmQKICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlCiAgICBAcGFyYW0ge09iamVjdH0gcHJvcGVydGllcyBhIGhhc2ggb2YgcHJvcGVydGllcyB0byBzZXQgb24gdGhlCiAgICAgIG5ld2x5IGNyZWF0ZWQgcmVjb3JkLgogICAgQHJldHVybnMge0RTLk1vZGVsfSByZWNvcmQKICAqLwogIGNyZWF0ZVJlY29yZDogZnVuY3Rpb24odHlwZSwgcHJvcGVydGllcykgewogICAgdHlwZSA9IHRoaXMubW9kZWxGb3IodHlwZSk7CgogICAgcHJvcGVydGllcyA9IGNvcHkocHJvcGVydGllcykgfHwge307CgogICAgLy8gSWYgdGhlIHBhc3NlZCBwcm9wZXJ0aWVzIGRvIG5vdCBpbmNsdWRlIGEgcHJpbWFyeSBrZXksCiAgICAvLyBnaXZlIHRoZSBhZGFwdGVyIGFuIG9wcG9ydHVuaXR5IHRvIGdlbmVyYXRlIG9uZS4gVHlwaWNhbGx5LAogICAgLy8gY2xpZW50LXNpZGUgSUQgZ2VuZXJhdG9ycyB3aWxsIHVzZSBzb21ldGhpbmcgbGlrZSB1dWlkLmpzCiAgICAvLyB0byBhdm9pZCBjb25mbGljdHMuCgogICAgaWYgKGlzTm9uZShwcm9wZXJ0aWVzLmlkKSkgewogICAgICBwcm9wZXJ0aWVzLmlkID0gdGhpcy5fZ2VuZXJhdGVJZCh0eXBlKTsKICAgIH0KCiAgICAvLyBDb2VyY2UgSUQgdG8gYSBzdHJpbmcKICAgIHByb3BlcnRpZXMuaWQgPSBjb2VyY2VJZChwcm9wZXJ0aWVzLmlkKTsKCiAgICB2YXIgcmVjb3JkID0gdGhpcy5idWlsZFJlY29yZCh0eXBlLCBwcm9wZXJ0aWVzLmlkKTsKCiAgICAvLyBNb3ZlIHRoZSByZWNvcmQgb3V0IG9mIGl0cyBpbml0aWFsIGBlbXB0eWAgc3RhdGUgaW50bwogICAgLy8gdGhlIGBsb2FkZWRgIHN0YXRlLgogICAgcmVjb3JkLmxvYWRlZERhdGEoKTsKCiAgICAvLyBTZXQgdGhlIHByb3BlcnRpZXMgc3BlY2lmaWVkIG9uIHRoZSByZWNvcmQuCiAgICByZWNvcmQuc2V0UHJvcGVydGllcyhwcm9wZXJ0aWVzKTsKCiAgICByZXR1cm4gcmVjb3JkOwogIH0sCgogIC8qKgogICAgSWYgcG9zc2libGUsIHRoaXMgbWV0aG9kIGFza3MgdGhlIGFkYXB0ZXIgdG8gZ2VuZXJhdGUgYW4gSUQgZm9yCiAgICBhIG5ld2x5IGNyZWF0ZWQgcmVjb3JkLgoKICAgIEBtZXRob2QgX2dlbmVyYXRlSWQKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1N0cmluZ30gdHlwZQogICAgQHJldHVybnMge1N0cmluZ30gaWYgdGhlIGFkYXB0ZXIgY2FuIGdlbmVyYXRlIG9uZSwgYW4gSUQKICAqLwogIF9nZW5lcmF0ZUlkOiBmdW5jdGlvbih0eXBlKSB7CiAgICB2YXIgYWRhcHRlciA9IHRoaXMuYWRhcHRlckZvcih0eXBlKTsKCiAgICBpZiAoYWRhcHRlciAmJiBhZGFwdGVyLmdlbmVyYXRlSWRGb3JSZWNvcmQpIHsKICAgICAgcmV0dXJuIGFkYXB0ZXIuZ2VuZXJhdGVJZEZvclJlY29yZCh0aGlzKTsKICAgIH0KCiAgICByZXR1cm4gbnVsbDsKICB9LAoKICAvLyAuLi4uLi4uLi4uLi4uLi4uLgogIC8vIC4gREVMRVRFIFJFQ09SRCAuCiAgLy8gLi4uLi4uLi4uLi4uLi4uLi4KCiAgLyoqCiAgICBGb3Igc3ltbWV0cnksIGEgcmVjb3JkIGNhbiBiZSBkZWxldGVkIHZpYSB0aGUgc3RvcmUuCgogICAgRXhhbXBsZQoKICAgIGBgYGphdmFzY3JpcHQKICAgIHZhciBwb3N0ID0gc3RvcmUuY3JlYXRlUmVjb3JkKCdwb3N0JywgewogICAgICB0aXRsZTogIlJhaWxzIGlzIG9tYWthc2UiCiAgICB9KTsKCiAgICBzdG9yZS5kZWxldGVkUmVjb3JkKHBvc3QpOwogICAgYGBgCgogICAgQG1ldGhvZCBkZWxldGVSZWNvcmQKICAgIEBwYXJhbSB7RFMuTW9kZWx9IHJlY29yZAogICovCiAgZGVsZXRlUmVjb3JkOiBmdW5jdGlvbihyZWNvcmQpIHsKICAgIHJlY29yZC5kZWxldGVSZWNvcmQoKTsKICB9LAoKICAvKioKICAgIEZvciBzeW1tZXRyeSwgYSByZWNvcmQgY2FuIGJlIHVubG9hZGVkIHZpYSB0aGUgc3RvcmUuIE9ubHkKICAgIG5vbi1kaXJ0eSByZWNvcmRzIGNhbiBiZSB1bmxvYWRlZC4KCiAgICBFeGFtcGxlCgogICAgYGBgamF2YXNjcmlwdAogICAgc3RvcmUuZmluZCgncG9zdCcsIDEpLnRoZW4oZnVuY3Rpb24ocG9zdCkgewogICAgICBzdG9yZS51bmxvYWRSZWNvcmQocG9zdCk7CiAgICB9KTsKICAgIGBgYAoKICAgIEBtZXRob2QgdW5sb2FkUmVjb3JkCiAgICBAcGFyYW0ge0RTLk1vZGVsfSByZWNvcmQKICAqLwogIHVubG9hZFJlY29yZDogZnVuY3Rpb24ocmVjb3JkKSB7CiAgICByZWNvcmQudW5sb2FkUmVjb3JkKCk7CiAgfSwKCiAgLy8gLi4uLi4uLi4uLi4uLi4uLgogIC8vIC4gRklORCBSRUNPUkRTIC4KICAvLyAuLi4uLi4uLi4uLi4uLi4uCgogIC8qKgogICAgVGhpcyBpcyB0aGUgbWFpbiBlbnRyeSBwb2ludCBpbnRvIGZpbmRpbmcgcmVjb3Jkcy4gVGhlIGZpcnN0IHBhcmFtZXRlciB0bwogICAgdGhpcyBtZXRob2QgaXMgdGhlIG1vZGVsJ3MgbmFtZSBhcyBhIHN0cmluZy4KCiAgICAtLS0KCiAgICBUbyBmaW5kIGEgcmVjb3JkIGJ5IElELCBwYXNzIHRoZSBgaWRgIGFzIHRoZSBzZWNvbmQgcGFyYW1ldGVyOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIHN0b3JlLmZpbmQoJ3BlcnNvbicsIDEpOwogICAgYGBgCgogICAgVGhlIGBmaW5kYCBtZXRob2Qgd2lsbCBhbHdheXMgcmV0dXJuIGEgKipwcm9taXNlKiogdGhhdCB3aWxsIGJlIHJlc29sdmVkCiAgICB3aXRoIHRoZSByZWNvcmQuIElmIHRoZSByZWNvcmQgd2FzIGFscmVhZHkgaW4gdGhlIHN0b3JlLCB0aGUgcHJvbWlzZSB3aWxsCiAgICBiZSByZXNvbHZlZCBpbW1lZGlhdGVseS4gT3RoZXJ3aXNlLCB0aGUgc3RvcmUgd2lsbCBhc2sgdGhlIGFkYXB0ZXIncyBgZmluZGAKICAgIG1ldGhvZCB0byBmaW5kIHRoZSBuZWNlc3NhcnkgZGF0YS4KCiAgICBUaGUgYGZpbmRgIG1ldGhvZCB3aWxsIGFsd2F5cyByZXNvbHZlIGl0cyBwcm9taXNlIHdpdGggdGhlIHNhbWUgb2JqZWN0IGZvcgogICAgYSBnaXZlbiB0eXBlIGFuZCBgaWRgLgoKICAgIC0tLQoKICAgIFRvIGZpbmQgYWxsIHJlY29yZHMgZm9yIGEgdHlwZSwgY2FsbCBgZmluZGAgd2l0aCBubyBhZGRpdGlvbmFsIHBhcmFtZXRlcnM6CgogICAgYGBgamF2YXNjcmlwdAogICAgc3RvcmUuZmluZCgncGVyc29uJyk7CiAgICBgYGAKCiAgICBUaGlzIHdpbGwgYXNrIHRoZSBhZGFwdGVyJ3MgYGZpbmRBbGxgIG1ldGhvZCB0byBmaW5kIHRoZSByZWNvcmRzIGZvciB0aGUKICAgIGdpdmVuIHR5cGUsIGFuZCByZXR1cm4gYSBwcm9taXNlIHRoYXQgd2lsbCBiZSByZXNvbHZlZCBvbmNlIHRoZSBzZXJ2ZXIKICAgIHJldHVybnMgdGhlIHZhbHVlcy4KCiAgICAtLS0KCiAgICBUbyBmaW5kIGEgcmVjb3JkIGJ5IGEgcXVlcnksIGNhbGwgYGZpbmRgIHdpdGggYSBoYXNoIGFzIHRoZSBzZWNvbmQKICAgIHBhcmFtZXRlcjoKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBzdG9yZS5maW5kKEFwcC5QZXJzb24sIHsgcGFnZTogMSB9KTsKICAgIGBgYAoKICAgIFRoaXMgd2lsbCBhc2sgdGhlIGFkYXB0ZXIncyBgZmluZFF1ZXJ5YCBtZXRob2QgdG8gZmluZCB0aGUgcmVjb3JkcyBmb3IKICAgIHRoZSBxdWVyeSwgYW5kIHJldHVybiBhIHByb21pc2UgdGhhdCB3aWxsIGJlIHJlc29sdmVkIG9uY2UgdGhlIHNlcnZlcgogICAgcmVzcG9uZHMuCgogICAgQG1ldGhvZCBmaW5kCiAgICBAcGFyYW0ge1N0cmluZyBvciBzdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHBhcmFtIHtPYmplY3R8U3RyaW5nfEludGVnZXJ8bnVsbH0gaWQKICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAqLwogIGZpbmQ6IGZ1bmN0aW9uKHR5cGUsIGlkKSB7CiAgICBpZiAoaWQgPT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm4gdGhpcy5maW5kQWxsKHR5cGUpOwogICAgfQoKICAgIC8vIFdlIGFyZSBwYXNzZWQgYSBxdWVyeSBpbnN0ZWFkIG9mIGFuIGlkLgogICAgaWYgKEVtYmVyLnR5cGVPZihpZCkgPT09ICdvYmplY3QnKSB7CiAgICAgIHJldHVybiB0aGlzLmZpbmRRdWVyeSh0eXBlLCBpZCk7CiAgICB9CgogICAgcmV0dXJuIHRoaXMuZmluZEJ5SWQodHlwZSwgY29lcmNlSWQoaWQpKTsKICB9LAoKICAvKioKICAgIFRoaXMgbWV0aG9kIHJldHVybnMgYSByZWNvcmQgZm9yIGEgZ2l2ZW4gdHlwZSBhbmQgaWQgY29tYmluYXRpb24uCgogICAgQG1ldGhvZCBmaW5kQnlJZAogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nIG9yIHN1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgICBAcGFyYW0ge1N0cmluZ3xJbnRlZ2VyfSBpZAogICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICovCiAgZmluZEJ5SWQ6IGZ1bmN0aW9uKHR5cGUsIGlkKSB7CiAgICB0eXBlID0gdGhpcy5tb2RlbEZvcih0eXBlKTsKCiAgICB2YXIgcmVjb3JkID0gdGhpcy5yZWNvcmRGb3JJZCh0eXBlLCBpZCk7CgogICAgdmFyIHByb21pc2UgPSB0aGlzLmZldGNoUmVjb3JkKHJlY29yZCkgfHwgcmVzb2x2ZShyZWNvcmQsICJEUzogU3RvcmUjZmluZEJ5SWQgIiArIHR5cGUgKyAiIHdpdGggaWQ6ICIgKyBpZCk7CiAgICByZXR1cm4gcHJvbWlzZU9iamVjdChwcm9taXNlKTsKICB9LAoKICAvKioKICAgIFRoaXMgbWV0aG9kIG1ha2VzIGEgc2VyaWVzIG9mIHJlcXVlc3RzIHRvIHRoZSBhZGFwdGVyJ3MgYGZpbmRgIG1ldGhvZAogICAgYW5kIHJldHVybnMgYSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgb25jZSB0aGV5IGFyZSBhbGwgbG9hZGVkLgoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIGZpbmRCeUlkcwogICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUKICAgIEBwYXJhbSB7QXJyYXl9IGlkcwogICAgQHJldHVybnMge1Byb21pc2V9IHByb21pc2UKICAqLwogIGZpbmRCeUlkczogZnVuY3Rpb24odHlwZSwgaWRzKSB7CiAgICB2YXIgc3RvcmUgPSB0aGlzOwogICAgdmFyIHByb21pc2VMYWJlbCA9ICJEUzogU3RvcmUjZmluZEJ5SWRzICIgKyB0eXBlOwogICAgcmV0dXJuIHByb21pc2VBcnJheShFbWJlci5SU1ZQLmFsbChtYXAoaWRzLCBmdW5jdGlvbihpZCkgewogICAgICByZXR1cm4gc3RvcmUuZmluZEJ5SWQodHlwZSwgaWQpOwogICAgfSkpLnRoZW4oRW1iZXIuQSwgbnVsbCwgIkRTOiBTdG9yZSNmaW5kQnlJZHMgb2YgIiArIHR5cGUgKyAiIGNvbXBsZXRlIikpOwogIH0sCgogIC8qKgogICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGJ5IGBmaW5kQnlJZGAgaWYgaXQgZGlzY292ZXJzIHRoYXQgYSBwYXJ0aWN1bGFyCiAgICB0eXBlL2lkIHBhaXIgaGFzbid0IGJlZW4gbG9hZGVkIHlldCB0byBraWNrIG9mZiBhIHJlcXVlc3QgdG8gdGhlCiAgICBhZGFwdGVyLgoKICAgIEBtZXRob2QgZmV0Y2hSZWNvcmQKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge0RTLk1vZGVsfSByZWNvcmQKICAgIEByZXR1cm5zIHtQcm9taXNlfSBwcm9taXNlCiAgKi8KICBmZXRjaFJlY29yZDogZnVuY3Rpb24ocmVjb3JkKSB7CiAgICBpZiAoaXNOb25lKHJlY29yZCkpIHsgcmV0dXJuIG51bGw7IH0KICAgIGlmIChyZWNvcmQuX2xvYWRpbmdQcm9taXNlKSB7IHJldHVybiByZWNvcmQuX2xvYWRpbmdQcm9taXNlOyB9CiAgICBpZiAoIWdldChyZWNvcmQsICdpc0VtcHR5JykpIHsgcmV0dXJuIG51bGw7IH0KCiAgICB2YXIgdHlwZSA9IHJlY29yZC5jb25zdHJ1Y3RvciwKICAgICAgICBpZCA9IGdldChyZWNvcmQsICdpZCcpOwoKICAgIHZhciBhZGFwdGVyID0gdGhpcy5hZGFwdGVyRm9yKHR5cGUpOwoKICAgIEVtYmVyLmFzc2VydCgiWW91IHRyaWVkIHRvIGZpbmQgYSByZWNvcmQgYnV0IHlvdSBoYXZlIG5vIGFkYXB0ZXIgKGZvciAiICsgdHlwZSArICIpIiwgYWRhcHRlcik7CiAgICBFbWJlci5hc3NlcnQoIllvdSB0cmllZCB0byBmaW5kIGEgcmVjb3JkIGJ1dCB5b3VyIGFkYXB0ZXIgKGZvciAiICsgdHlwZSArICIpIGRvZXMgbm90IGltcGxlbWVudCAnZmluZCciLCBhZGFwdGVyLmZpbmQpOwoKICAgIHZhciBwcm9taXNlID0gX2ZpbmQoYWRhcHRlciwgdGhpcywgdHlwZSwgaWQpOwogICAgcmVjb3JkLmxvYWRpbmdEYXRhKHByb21pc2UpOwogICAgcmV0dXJuIHByb21pc2U7CiAgfSwKCiAgLyoqCiAgICBHZXQgYSByZWNvcmQgYnkgYSBnaXZlbiB0eXBlIGFuZCBJRCB3aXRob3V0IHRyaWdnZXJpbmcgYSBmZXRjaC4KCiAgICBUaGlzIG1ldGhvZCB3aWxsIHN5bmNocm9ub3VzbHkgcmV0dXJuIHRoZSByZWNvcmQgaWYgaXQncyBhdmFpbGFibGUuCiAgICBPdGhlcndpc2UsIGl0IHdpbGwgcmV0dXJuIG51bGwuCgogICAgYGBganMKICAgIHZhciBwb3N0ID0gc3RvcmUuZ2V0QnlJZCgncG9zdCcsIDEpOwogICAgYGBgCgogICAgQG1ldGhvZCBnZXRCeUlkCiAgICBAcGFyYW0ge1N0cmluZyBvciBzdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHBhcmFtIHtTdHJpbmd8SW50ZWdlcn0gaWQKICAgIEBwYXJhbSB7RFMuTW9kZWx9IHJlY29yZAogICovCiAgZ2V0QnlJZDogZnVuY3Rpb24odHlwZSwgaWQpIHsKICAgIGlmICh0aGlzLmhhc1JlY29yZEZvcklkKHR5cGUsIGlkKSkgewogICAgICByZXR1cm4gdGhpcy5yZWNvcmRGb3JJZCh0eXBlLCBpZCk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9LAoKICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBieSB0aGUgcmVjb3JkJ3MgYHJlbG9hZGAgbWV0aG9kLgoKICAgIFRoaXMgbWV0aG9kIGNhbGxzIHRoZSBhZGFwdGVyJ3MgYGZpbmRgIG1ldGhvZCwgd2hpY2ggcmV0dXJucyBhIHByb21pc2UuIFdoZW4KICAgICoqdGhhdCoqIHByb21pc2UgcmVzb2x2ZXMsIGByZWxvYWRSZWNvcmRgIHdpbGwgcmVzb2x2ZSB0aGUgcHJvbWlzZSByZXR1cm5lZAogICAgYnkgdGhlIHJlY29yZCdzIGByZWxvYWRgLgoKICAgIEBtZXRob2QgcmVsb2FkUmVjb3JkCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtEUy5Nb2RlbH0gcmVjb3JkCiAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlCiAgKi8KICByZWxvYWRSZWNvcmQ6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgdmFyIHR5cGUgPSByZWNvcmQuY29uc3RydWN0b3IsCiAgICAgICAgYWRhcHRlciA9IHRoaXMuYWRhcHRlckZvcih0eXBlKSwKICAgICAgICBpZCA9IGdldChyZWNvcmQsICdpZCcpOwoKICAgIEVtYmVyLmFzc2VydCgiWW91IGNhbm5vdCByZWxvYWQgYSByZWNvcmQgd2l0aG91dCBhbiBJRCIsIGlkKTsKICAgIEVtYmVyLmFzc2VydCgiWW91IHRyaWVkIHRvIHJlbG9hZCBhIHJlY29yZCBidXQgeW91IGhhdmUgbm8gYWRhcHRlciAoZm9yICIgKyB0eXBlICsgIikiLCBhZGFwdGVyKTsKICAgIEVtYmVyLmFzc2VydCgiWW91IHRyaWVkIHRvIHJlbG9hZCBhIHJlY29yZCBidXQgeW91ciBhZGFwdGVyIGRvZXMgbm90IGltcGxlbWVudCBgZmluZGAiLCBhZGFwdGVyLmZpbmQpOwoKICAgIHJldHVybiBfZmluZChhZGFwdGVyLCB0aGlzLCB0eXBlLCBpZCk7CiAgfSwKCiAgLyoqCiAgICBUaGlzIG1ldGhvZCB0YWtlcyBhIGxpc3Qgb2YgcmVjb3JkcywgZ3JvdXBzIHRoZSByZWNvcmRzIGJ5IHR5cGUsCiAgICBjb252ZXJ0cyB0aGUgcmVjb3JkcyBpbnRvIElEcywgYW5kIHRoZW4gaW52b2tlcyB0aGUgYWRhcHRlcidzIGBmaW5kTWFueWAKICAgIG1ldGhvZC4KCiAgICBUaGUgcmVjb3JkcyBhcmUgZ3JvdXBlZCBieSB0eXBlIHRvIGludm9rZSBgZmluZE1hbnlgIG9uIGFkYXB0ZXJzCiAgICBmb3IgZWFjaCB1bmlxdWUgdHlwZSBpbiByZWNvcmRzLgoKICAgIEl0IGlzIHVzZWQgYm90aCBieSBhIGJyYW5kIG5ldyByZWxhdGlvbnNoaXAgKHZpYSB0aGUgYGZpbmRNYW55YAogICAgbWV0aG9kKSBvciB3aGVuIHRoZSBkYXRhIHVuZGVybHlpbmcgYW4gZXhpc3RpbmcgcmVsYXRpb25zaGlwCiAgICBjaGFuZ2VzLgoKICAgIEBtZXRob2QgZmV0Y2hNYW55CiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtBcnJheX0gcmVjb3JkcwogICAgQHBhcmFtIHtEUy5Nb2RlbH0gb3duZXIKICAgIEBwYXJhbSB7UmVzb2x2ZXJ9IHJlc29sdmVyCiAgKi8KICBmZXRjaE1hbnk6IGZ1bmN0aW9uKHJlY29yZHMsIG93bmVyLCByZXNvbHZlcikgewogICAgaWYgKCFyZWNvcmRzLmxlbmd0aCkgeyByZXR1cm47IH0KCiAgICAvLyBHcm91cCBCeSBUeXBlCiAgICB2YXIgcmVjb3Jkc0J5VHlwZU1hcCA9IEVtYmVyLk1hcFdpdGhEZWZhdWx0LmNyZWF0ZSh7CiAgICAgIGRlZmF1bHRWYWx1ZTogZnVuY3Rpb24oKSB7IHJldHVybiBFbWJlci5BKCk7IH0KICAgIH0pOwoKICAgIGZvckVhY2gocmVjb3JkcywgZnVuY3Rpb24ocmVjb3JkKSB7CiAgICAgIHJlY29yZHNCeVR5cGVNYXAuZ2V0KHJlY29yZC5jb25zdHJ1Y3RvcikucHVzaChyZWNvcmQpOwogICAgfSk7CgogICAgZm9yRWFjaChyZWNvcmRzQnlUeXBlTWFwLCBmdW5jdGlvbih0eXBlLCByZWNvcmRzKSB7CiAgICAgIHZhciBpZHMgPSByZWNvcmRzLm1hcFByb3BlcnR5KCdpZCcpLAogICAgICAgICAgYWRhcHRlciA9IHRoaXMuYWRhcHRlckZvcih0eXBlKTsKCiAgICAgIEVtYmVyLmFzc2VydCgiWW91IHRyaWVkIHRvIGxvYWQgbWFueSByZWNvcmRzIGJ1dCB5b3UgaGF2ZSBubyBhZGFwdGVyIChmb3IgIiArIHR5cGUgKyAiKSIsIGFkYXB0ZXIpOwogICAgICBFbWJlci5hc3NlcnQoIllvdSB0cmllZCB0byBsb2FkIG1hbnkgcmVjb3JkcyBidXQgeW91ciBhZGFwdGVyIGRvZXMgbm90IGltcGxlbWVudCBgZmluZE1hbnlgIiwgYWRhcHRlci5maW5kTWFueSk7CgogICAgICByZXNvbHZlci5yZXNvbHZlKF9maW5kTWFueShhZGFwdGVyLCB0aGlzLCB0eXBlLCBpZHMsIG93bmVyKSk7CiAgICB9LCB0aGlzKTsKICB9LAoKICAvKioKICAgIFJldHVybnMgdHJ1ZSBpZiBhIHJlY29yZCBmb3IgYSBnaXZlbiB0eXBlIGFuZCBJRCBpcyBhbHJlYWR5IGxvYWRlZC4KCiAgICBAbWV0aG9kIGhhc1JlY29yZEZvcklkCiAgICBAcGFyYW0ge1N0cmluZyBvciBzdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHBhcmFtIHtTdHJpbmd8SW50ZWdlcn0gaWQKICAgIEByZXR1cm5zIHtCb29sZWFufQogICovCiAgaGFzUmVjb3JkRm9ySWQ6IGZ1bmN0aW9uKHR5cGUsIGlkKSB7CiAgICBpZCA9IGNvZXJjZUlkKGlkKTsKICAgIHR5cGUgPSB0aGlzLm1vZGVsRm9yKHR5cGUpOwogICAgcmV0dXJuICEhdGhpcy50eXBlTWFwRm9yKHR5cGUpLmlkVG9SZWNvcmRbaWRdOwogIH0sCgogIC8qKgogICAgUmV0dXJucyBpZCByZWNvcmQgZm9yIGEgZ2l2ZW4gdHlwZSBhbmQgSUQuIElmIG9uZSBpc24ndCBhbHJlYWR5IGxvYWRlZCwKICAgIGl0IGJ1aWxkcyBhIG5ldyByZWNvcmQgYW5kIGxlYXZlcyBpdCBpbiB0aGUgYGVtcHR5YCBzdGF0ZS4KCiAgICBAbWV0aG9kIHJlY29yZEZvcklkCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtTdHJpbmcgb3Igc3ViY2xhc3Mgb2YgRFMuTW9kZWx9IHR5cGUKICAgIEBwYXJhbSB7U3RyaW5nfEludGVnZXJ9IGlkCiAgICBAcmV0dXJucyB7RFMuTW9kZWx9IHJlY29yZAogICovCiAgcmVjb3JkRm9ySWQ6IGZ1bmN0aW9uKHR5cGUsIGlkKSB7CiAgICB0eXBlID0gdGhpcy5tb2RlbEZvcih0eXBlKTsKCiAgICBpZCA9IGNvZXJjZUlkKGlkKTsKCiAgICB2YXIgcmVjb3JkID0gdGhpcy50eXBlTWFwRm9yKHR5cGUpLmlkVG9SZWNvcmRbaWRdOwoKICAgIGlmICghcmVjb3JkKSB7CiAgICAgIHJlY29yZCA9IHRoaXMuYnVpbGRSZWNvcmQodHlwZSwgaWQpOwogICAgfQoKICAgIHJldHVybiByZWNvcmQ7CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIGZpbmRNYW55CiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtEUy5Nb2RlbH0gb3duZXIKICAgIEBwYXJhbSB7QXJyYXl9IHJlY29yZHMKICAgIEBwYXJhbSB7U3RyaW5nIG9yIHN1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgICBAcGFyYW0ge1Jlc29sdmVyfSByZXNvbHZlcgogICAgQHJldHVybiB7RFMuTWFueUFycmF5fSByZWNvcmRzCiAgKi8KICBmaW5kTWFueTogZnVuY3Rpb24ob3duZXIsIHJlY29yZHMsIHR5cGUsIHJlc29sdmVyKSB7CiAgICB0eXBlID0gdGhpcy5tb2RlbEZvcih0eXBlKTsKCiAgICByZWNvcmRzID0gRW1iZXIuQShyZWNvcmRzKTsKCiAgICB2YXIgdW5sb2FkZWRSZWNvcmRzID0gcmVjb3Jkcy5maWx0ZXJQcm9wZXJ0eSgnaXNFbXB0eScsIHRydWUpLAogICAgICAgIG1hbnlBcnJheSA9IHRoaXMucmVjb3JkQXJyYXlNYW5hZ2VyLmNyZWF0ZU1hbnlBcnJheSh0eXBlLCByZWNvcmRzKTsKCiAgICBmb3JFYWNoKHVubG9hZGVkUmVjb3JkcywgZnVuY3Rpb24ocmVjb3JkKSB7CiAgICAgIHJlY29yZC5sb2FkaW5nRGF0YSgpOwogICAgfSk7CgogICAgbWFueUFycmF5LmxvYWRpbmdSZWNvcmRzQ291bnQgPSB1bmxvYWRlZFJlY29yZHMubGVuZ3RoOwoKICAgIGlmICh1bmxvYWRlZFJlY29yZHMubGVuZ3RoKSB7CiAgICAgIGZvckVhY2godW5sb2FkZWRSZWNvcmRzLCBmdW5jdGlvbihyZWNvcmQpIHsKICAgICAgICB0aGlzLnJlY29yZEFycmF5TWFuYWdlci5yZWdpc3RlcldhaXRpbmdSZWNvcmRBcnJheShyZWNvcmQsIG1hbnlBcnJheSk7CiAgICAgIH0sIHRoaXMpOwoKICAgICAgdGhpcy5mZXRjaE1hbnkodW5sb2FkZWRSZWNvcmRzLCBvd25lciwgcmVzb2x2ZXIpOwogICAgfSBlbHNlIHsKICAgICAgaWYgKHJlc29sdmVyKSB7IHJlc29sdmVyLnJlc29sdmUoKTsgfQogICAgICBtYW55QXJyYXkuc2V0KCdpc0xvYWRlZCcsIHRydWUpOwogICAgICBFbWJlci5ydW4ub25jZShtYW55QXJyYXksICd0cmlnZ2VyJywgJ2RpZExvYWQnKTsKICAgIH0KCiAgICByZXR1cm4gbWFueUFycmF5OwogIH0sCgogIC8qKgogICAgSWYgYSByZWxhdGlvbnNoaXAgd2FzIG9yaWdpbmFsbHkgcG9wdWxhdGVkIGJ5IHRoZSBhZGFwdGVyIGFzIGEgbGluawogICAgKGFzIG9wcG9zZWQgdG8gYSBsaXN0IG9mIElEcyksIHRoaXMgbWV0aG9kIGlzIGNhbGxlZCB3aGVuIHRoZQogICAgcmVsYXRpb25zaGlwIGlzIGZldGNoZWQuCgogICAgVGhlIGxpbmsgKHdoaWNoIGlzIHVzdWFsbHkgYSBVUkwpIGlzIHBhc3NlZCB0aHJvdWdoIHVuY2hhbmdlZCwgc28gdGhlCiAgICBhZGFwdGVyIGNhbiBtYWtlIHdoYXRldmVyIHJlcXVlc3QgaXQgd2FudHMuCgogICAgVGhlIHVzdWFsIHVzZS1jYXNlIGlzIGZvciB0aGUgc2VydmVyIHRvIHJlZ2lzdGVyIGEgVVJMIGFzIGEgbGluaywgYW5kCiAgICB0aGVuIHVzZSB0aGF0IFVSTCBpbiB0aGUgZnV0dXJlIHRvIG1ha2UgYSByZXF1ZXN0IGZvciB0aGUgcmVsYXRpb25zaGlwLgoKICAgIEBtZXRob2QgZmluZEhhc01hbnkKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge0RTLk1vZGVsfSBvd25lcgogICAgQHBhcmFtIHthbnl9IGxpbmsKICAgIEBwYXJhbSB7U3RyaW5nIG9yIHN1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgICBAcGFyYW0ge1Jlc29sdmVyfSByZXNvbHZlcgogICAgQHJldHVybiB7RFMuTWFueUFycmF5fQogICovCiAgZmluZEhhc01hbnk6IGZ1bmN0aW9uKG93bmVyLCBsaW5rLCByZWxhdGlvbnNoaXAsIHJlc29sdmVyKSB7CiAgICB2YXIgYWRhcHRlciA9IHRoaXMuYWRhcHRlckZvcihvd25lci5jb25zdHJ1Y3Rvcik7CgogICAgRW1iZXIuYXNzZXJ0KCJZb3UgdHJpZWQgdG8gbG9hZCBhIGhhc01hbnkgcmVsYXRpb25zaGlwIGJ1dCB5b3UgaGF2ZSBubyBhZGFwdGVyIChmb3IgIiArIG93bmVyLmNvbnN0cnVjdG9yICsgIikiLCBhZGFwdGVyKTsKICAgIEVtYmVyLmFzc2VydCgiWW91IHRyaWVkIHRvIGxvYWQgYSBoYXNNYW55IHJlbGF0aW9uc2hpcCBmcm9tIGEgc3BlY2lmaWVkIGBsaW5rYCBpbiB0aGUgb3JpZ2luYWwgcGF5bG9hZCBidXQgeW91ciBhZGFwdGVyIGRvZXMgbm90IGltcGxlbWVudCBgZmluZEhhc01hbnlgIiwgYWRhcHRlci5maW5kSGFzTWFueSk7CgogICAgdmFyIHJlY29yZHMgPSB0aGlzLnJlY29yZEFycmF5TWFuYWdlci5jcmVhdGVNYW55QXJyYXkocmVsYXRpb25zaGlwLnR5cGUsIEVtYmVyLkEoW10pKTsKICAgIHJlc29sdmVyLnJlc29sdmUoX2ZpbmRIYXNNYW55KGFkYXB0ZXIsIHRoaXMsIG93bmVyLCBsaW5rLCByZWxhdGlvbnNoaXApKTsKICAgIHJldHVybiByZWNvcmRzOwogIH0sCgogIC8qKgogICAgQG1ldGhvZCBmaW5kQmVsb25nc1RvCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtEUy5Nb2RlbH0gb3duZXIKICAgIEBwYXJhbSB7YW55fSBsaW5rCiAgICBAcGFyYW0ge1JlbGF0aW9uc2hpcH0gcmVsYXRpb25zaGlwCiAgICBAcGFyYW0ge1Jlc29sdmVyfSByZXNvbHZlcgogICovCiAgZmluZEJlbG9uZ3NUbzogZnVuY3Rpb24ob3duZXIsIGxpbmssIHJlbGF0aW9uc2hpcCwgcmVzb2x2ZXIpIHsKICAgIHZhciBhZGFwdGVyID0gdGhpcy5hZGFwdGVyRm9yKG93bmVyLmNvbnN0cnVjdG9yKTsKCiAgICBFbWJlci5hc3NlcnQoIllvdSB0cmllZCB0byBsb2FkIGEgYmVsb25nc1RvIHJlbGF0aW9uc2hpcCBidXQgeW91IGhhdmUgbm8gYWRhcHRlciAoZm9yICIgKyBvd25lci5jb25zdHJ1Y3RvciArICIpIiwgYWRhcHRlcik7CiAgICBFbWJlci5hc3NlcnQoIllvdSB0cmllZCB0byBsb2FkIGEgYmVsb25nc1RvIHJlbGF0aW9uc2hpcCBmcm9tIGEgc3BlY2lmaWVkIGBsaW5rYCBpbiB0aGUgb3JpZ2luYWwgcGF5bG9hZCBidXQgeW91ciBhZGFwdGVyIGRvZXMgbm90IGltcGxlbWVudCBgZmluZEJlbG9uZ3NUb2AiLCBhZGFwdGVyLmZpbmRCZWxvbmdzVG8pOwoKICAgIHJlc29sdmVyLnJlc29sdmUoX2ZpbmRCZWxvbmdzVG8oYWRhcHRlciwgdGhpcywgb3duZXIsIGxpbmssIHJlbGF0aW9uc2hpcCkpOwogIH0sCgogIC8qKgogICAgVGhpcyBtZXRob2QgZGVsZWdhdGVzIGEgcXVlcnkgdG8gdGhlIGFkYXB0ZXIuIFRoaXMgaXMgdGhlIG9uZSBwbGFjZSB3aGVyZQogICAgYWRhcHRlci1sZXZlbCBzZW1hbnRpY3MgYXJlIGV4cG9zZWQgdG8gdGhlIGFwcGxpY2F0aW9uLgoKICAgIEV4cG9zaW5nIHF1ZXJpZXMgdGhpcyB3YXkgc2VlbXMgcHJlZmVyYWJsZSB0byBjcmVhdGluZyBhbiBhYnN0cmFjdCBxdWVyeQogICAgbGFuZ3VhZ2UgZm9yIGFsbCBzZXJ2ZXItc2lkZSBxdWVyaWVzLCBhbmQgdGhlbiByZXF1aXJlIGFsbCBhZGFwdGVycyB0bwogICAgaW1wbGVtZW50IHRoZW0uCgogICAgVGhpcyBtZXRob2QgcmV0dXJucyBhIHByb21pc2UsIHdoaWNoIGlzIHJlc29sdmVkIHdpdGggYSBgUmVjb3JkQXJyYXlgCiAgICBvbmNlIHRoZSBzZXJ2ZXIgcmV0dXJucy4KCiAgICBAbWV0aG9kIGZpbmRRdWVyeQogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nIG9yIHN1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgICBAcGFyYW0ge2FueX0gcXVlcnkgYW4gb3BhcXVlIHF1ZXJ5IHRvIGJlIHVzZWQgYnkgdGhlIGFkYXB0ZXIKICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAqLwogIGZpbmRRdWVyeTogZnVuY3Rpb24odHlwZSwgcXVlcnkpIHsKICAgIHR5cGUgPSB0aGlzLm1vZGVsRm9yKHR5cGUpOwoKICAgIHZhciBhcnJheSA9IHRoaXMucmVjb3JkQXJyYXlNYW5hZ2VyCiAgICAgIC5jcmVhdGVBZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXkodHlwZSwgcXVlcnkpOwoKICAgIHZhciBhZGFwdGVyID0gdGhpcy5hZGFwdGVyRm9yKHR5cGUpLAogICAgICAgIHByb21pc2VMYWJlbCA9ICJEUzogU3RvcmUjZmluZFF1ZXJ5ICIgKyB0eXBlLAogICAgICAgIHJlc29sdmVyID0gRW1iZXIuUlNWUC5kZWZlcihwcm9taXNlTGFiZWwpOwoKICAgIEVtYmVyLmFzc2VydCgiWW91IHRyaWVkIHRvIGxvYWQgYSBxdWVyeSBidXQgeW91IGhhdmUgbm8gYWRhcHRlciAoZm9yICIgKyB0eXBlICsgIikiLCBhZGFwdGVyKTsKICAgIEVtYmVyLmFzc2VydCgiWW91IHRyaWVkIHRvIGxvYWQgYSBxdWVyeSBidXQgeW91ciBhZGFwdGVyIGRvZXMgbm90IGltcGxlbWVudCBgZmluZFF1ZXJ5YCIsIGFkYXB0ZXIuZmluZFF1ZXJ5KTsKCiAgICByZXNvbHZlci5yZXNvbHZlKF9maW5kUXVlcnkoYWRhcHRlciwgdGhpcywgdHlwZSwgcXVlcnksIGFycmF5KSk7CgogICAgcmV0dXJuIHByb21pc2VBcnJheShyZXNvbHZlci5wcm9taXNlKTsKICB9LAoKICAvKioKICAgIFRoaXMgbWV0aG9kIHJldHVybnMgYW4gYXJyYXkgb2YgYWxsIHJlY29yZHMgYWRhcHRlciBjYW4gZmluZC4KICAgIEl0IHRyaWdnZXJzIHRoZSBhZGFwdGVyJ3MgYGZpbmRBbGxgIG1ldGhvZCB0byBnaXZlIGl0IGFuIG9wcG9ydHVuaXR5IHRvIHBvcHVsYXRlCiAgICB0aGUgYXJyYXkgd2l0aCByZWNvcmRzIG9mIHRoYXQgdHlwZS4KCiAgICBAbWV0aG9kIGZpbmRBbGwKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1N0cmluZyBvciBzdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHJldHVybiB7RFMuQWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5fQogICovCiAgZmluZEFsbDogZnVuY3Rpb24odHlwZSkgewogICAgdHlwZSA9IHRoaXMubW9kZWxGb3IodHlwZSk7CgogICAgcmV0dXJuIHRoaXMuZmV0Y2hBbGwodHlwZSwgdGhpcy5hbGwodHlwZSkpOwogIH0sCgogIC8qKgogICAgQG1ldGhvZCBmZXRjaEFsbAogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7RFMuTW9kZWx9IHR5cGUKICAgIEBwYXJhbSB7RFMuUmVjb3JkQXJyYXl9IGFycmF5CiAgICBAcmV0dXJucyB7UHJvbWlzZX0gcHJvbWlzZQogICovCiAgZmV0Y2hBbGw6IGZ1bmN0aW9uKHR5cGUsIGFycmF5KSB7CiAgICB2YXIgYWRhcHRlciA9IHRoaXMuYWRhcHRlckZvcih0eXBlKSwKICAgICAgICBzaW5jZVRva2VuID0gdGhpcy50eXBlTWFwRm9yKHR5cGUpLm1ldGFkYXRhLnNpbmNlOwoKICAgIHNldChhcnJheSwgJ2lzVXBkYXRpbmcnLCB0cnVlKTsKCiAgICBFbWJlci5hc3NlcnQoIllvdSB0cmllZCB0byBsb2FkIGFsbCByZWNvcmRzIGJ1dCB5b3UgaGF2ZSBubyBhZGFwdGVyIChmb3IgIiArIHR5cGUgKyAiKSIsIGFkYXB0ZXIpOwogICAgRW1iZXIuYXNzZXJ0KCJZb3UgdHJpZWQgdG8gbG9hZCBhbGwgcmVjb3JkcyBidXQgeW91ciBhZGFwdGVyIGRvZXMgbm90IGltcGxlbWVudCBgZmluZEFsbGAiLCBhZGFwdGVyLmZpbmRBbGwpOwoKICAgIHJldHVybiBwcm9taXNlQXJyYXkoX2ZpbmRBbGwoYWRhcHRlciwgdGhpcywgdHlwZSwgc2luY2VUb2tlbikpOwogIH0sCgogIC8qKgogICAgQG1ldGhvZCBkaWRVcGRhdGVBbGwKICAgIEBwYXJhbSB7RFMuTW9kZWx9IHR5cGUKICAqLwogIGRpZFVwZGF0ZUFsbDogZnVuY3Rpb24odHlwZSkgewogICAgdmFyIGZpbmRBbGxDYWNoZSA9IHRoaXMudHlwZU1hcEZvcih0eXBlKS5maW5kQWxsQ2FjaGU7CiAgICBzZXQoZmluZEFsbENhY2hlLCAnaXNVcGRhdGluZycsIGZhbHNlKTsKICB9LAoKICAvKioKICAgIFRoaXMgbWV0aG9kIHJldHVybnMgYSBmaWx0ZXJlZCBhcnJheSB0aGF0IGNvbnRhaW5zIGFsbCBvZiB0aGUga25vd24gcmVjb3JkcwogICAgZm9yIGEgZ2l2ZW4gdHlwZS4KCiAgICBOb3RlIHRoYXQgYmVjYXVzZSBpdCdzIGp1c3QgYSBmaWx0ZXIsIGl0IHdpbGwgaGF2ZSBhbnkgbG9jYWxseQogICAgY3JlYXRlZCByZWNvcmRzIG9mIHRoZSB0eXBlLgoKICAgIEFsc28gbm90ZSB0aGF0IG11bHRpcGxlIGNhbGxzIHRvIGBhbGxgIGZvciBhIGdpdmVuIHR5cGUgd2lsbCBhbHdheXMKICAgIHJldHVybiB0aGUgc2FtZSBSZWNvcmRBcnJheS4KCiAgICBFeGFtcGxlCgogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIGxvY2FsX3Bvc3RzID0gc3RvcmUuYWxsKEFwcC5Qb3N0KTsKICAgIGBgYAoKICAgIEBtZXRob2QgYWxsCiAgICBAcGFyYW0ge1N0cmluZyBvciBzdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHJldHVybiB7RFMuUmVjb3JkQXJyYXl9CiAgKi8KICBhbGw6IGZ1bmN0aW9uKHR5cGUpIHsKICAgIHR5cGUgPSB0aGlzLm1vZGVsRm9yKHR5cGUpOwoKICAgIHZhciB0eXBlTWFwID0gdGhpcy50eXBlTWFwRm9yKHR5cGUpLAogICAgICAgIGZpbmRBbGxDYWNoZSA9IHR5cGVNYXAuZmluZEFsbENhY2hlOwoKICAgIGlmIChmaW5kQWxsQ2FjaGUpIHsgcmV0dXJuIGZpbmRBbGxDYWNoZTsgfQoKICAgIHZhciBhcnJheSA9IHRoaXMucmVjb3JkQXJyYXlNYW5hZ2VyLmNyZWF0ZVJlY29yZEFycmF5KHR5cGUpOwoKICAgIHR5cGVNYXAuZmluZEFsbENhY2hlID0gYXJyYXk7CiAgICByZXR1cm4gYXJyYXk7CiAgfSwKCgogIC8qKgogICAgVGhpcyBtZXRob2QgdW5sb2FkcyBhbGwgb2YgdGhlIGtub3duIHJlY29yZHMgZm9yIGEgZ2l2ZW4gdHlwZS4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICBzdG9yZS51bmxvYWRBbGwoQXBwLlBvc3QpOwogICAgYGBgCgogICAgQG1ldGhvZCB1bmxvYWRBbGwKICAgIEBwYXJhbSB7U3RyaW5nIG9yIHN1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgKi8KICB1bmxvYWRBbGw6IGZ1bmN0aW9uKHR5cGUpIHsKICAgIHR5cGUgPSB0aGlzLm1vZGVsRm9yKHR5cGUpOwoKICAgIHZhciB0eXBlTWFwID0gdGhpcy50eXBlTWFwRm9yKHR5cGUpLAogICAgICAgIHJlY29yZHMgPSB0eXBlTWFwLnJlY29yZHMsIHJlY29yZDsKCiAgICB3aGlsZShyZWNvcmQgPSByZWNvcmRzLnBvcCgpKSB7CiAgICAgIHJlY29yZC51bmxvYWRSZWNvcmQoKTsKICAgIH0KCiAgICB0eXBlTWFwLmZpbmRBbGxDYWNoZSA9IG51bGw7CiAgfSwKCiAgLyoqCiAgICBUYWtlcyBhIHR5cGUgYW5kIGZpbHRlciBmdW5jdGlvbiwgYW5kIHJldHVybnMgYSBsaXZlIFJlY29yZEFycmF5IHRoYXQKICAgIHJlbWFpbnMgdXAgdG8gZGF0ZSBhcyBuZXcgcmVjb3JkcyBhcmUgbG9hZGVkIGludG8gdGhlIHN0b3JlIG9yIGNyZWF0ZWQKICAgIGxvY2FsbHkuCgogICAgVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHRha2VzIGEgbWF0ZXJpYWxpemVkIHJlY29yZCwgYW5kIHJldHVybnMgdHJ1ZQogICAgaWYgdGhlIHJlY29yZCBzaG91bGQgYmUgaW5jbHVkZWQgaW4gdGhlIGZpbHRlciBhbmQgZmFsc2UgaWYgaXQgc2hvdWxkCiAgICBub3QuCgogICAgVGhlIGZpbHRlciBmdW5jdGlvbiBpcyBjYWxsZWQgb25jZSBvbiBhbGwgcmVjb3JkcyBmb3IgdGhlIHR5cGUgd2hlbgogICAgaXQgaXMgY3JlYXRlZCwgYW5kIHRoZW4gb25jZSBvbiBlYWNoIG5ld2x5IGxvYWRlZCBvciBjcmVhdGVkIHJlY29yZC4KCiAgICBJZiBhbnkgb2YgYSByZWNvcmQncyBwcm9wZXJ0aWVzIGNoYW5nZSwgb3IgaWYgaXQgY2hhbmdlcyBzdGF0ZSwgdGhlCiAgICBmaWx0ZXIgZnVuY3Rpb24gd2lsbCBiZSBpbnZva2VkIGFnYWluIHRvIGRldGVybWluZSB3aGV0aGVyIGl0IHNob3VsZAogICAgc3RpbGwgYmUgaW4gdGhlIGFycmF5LgoKICAgIE9wdGlvbmFsbHkgeW91IGNhbiBwYXNzIGEgcXVlcnkgd2hpY2ggd2lsbCBiZSB0cmlnZ2VyZWQgYXQgZmlyc3QuIFRoZQogICAgcmVzdWx0cyByZXR1cm5lZCBieSB0aGUgc2VydmVyIGNvdWxkIHRoZW4gYXBwZWFyIGluIHRoZSBmaWx0ZXIgaWYgdGhleQogICAgbWF0Y2ggdGhlIGZpbHRlciBmdW5jdGlvbi4KCiAgICBFeGFtcGxlCgogICAgYGBgamF2YXNjcmlwdAogICAgc3RvcmUuZmlsdGVyKEFwcC5Qb3N0LCB7dW5yZWFkOiB0cnVlfSwgZnVuY3Rpb24ocG9zdCkgewogICAgICByZXR1cm4gcG9zdC5nZXQoJ3VucmVhZCcpOwogICAgfSkudGhlbihmdW5jdGlvbih1bnJlYWRQb3N0cykgewogICAgICB1bnJlYWRQb3N0cy5nZXQoJ2xlbmd0aCcpOyAvLyA1CiAgICAgIHZhciB1bnJlYWRQb3N0ID0gdW5yZWFkUG9zdHMub2JqZWN0QXQoMCk7CiAgICAgIHVucmVhZFBvc3RzLnNldCgndW5yZWFkJywgZmFsc2UpOwogICAgICB1bnJlYWRQb3N0cy5nZXQoJ2xlbmd0aCcpOyAvLyA0CiAgICB9KTsKICAgIGBgYAoKICAgIEBtZXRob2QgZmlsdGVyCiAgICBAcGFyYW0ge1N0cmluZyBvciBzdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHBhcmFtIHtPYmplY3R9IHF1ZXJ5IG9wdGlvbmFsIHF1ZXJ5CiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBmaWx0ZXIKICAgIEByZXR1cm4ge0RTLlByb21pc2VBcnJheX0KICAqLwogIGZpbHRlcjogZnVuY3Rpb24odHlwZSwgcXVlcnksIGZpbHRlcikgewogICAgdmFyIHByb21pc2U7CgogICAgLy8gYWxsb3cgYW4gb3B0aW9uYWwgc2VydmVyIHF1ZXJ5CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMykgewogICAgICBwcm9taXNlID0gdGhpcy5maW5kUXVlcnkodHlwZSwgcXVlcnkpOwogICAgfSBlbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CiAgICAgIGZpbHRlciA9IHF1ZXJ5OwogICAgfQoKICAgIHR5cGUgPSB0aGlzLm1vZGVsRm9yKHR5cGUpOwoKICAgIHZhciBhcnJheSA9IHRoaXMucmVjb3JkQXJyYXlNYW5hZ2VyCiAgICAgIC5jcmVhdGVGaWx0ZXJlZFJlY29yZEFycmF5KHR5cGUsIGZpbHRlcik7CiAgICBwcm9taXNlID0gcHJvbWlzZSB8fCByZXNvbHZlKGFycmF5KTsKCiAgICByZXR1cm4gcHJvbWlzZUFycmF5KHByb21pc2UudGhlbihmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGFycmF5OwogICAgfSwgbnVsbCwgIkRTOiBTdG9yZSNmaWx0ZXIgb2YgIiArIHR5cGUpKTsKICB9LAoKICAvKioKICAgIFRoaXMgbWV0aG9kIHJldHVybnMgaWYgYSBjZXJ0YWluIHJlY29yZCBpcyBhbHJlYWR5IGxvYWRlZAogICAgaW4gdGhlIHN0b3JlLiBVc2UgdGhpcyBmdW5jdGlvbiB0byBrbm93IGJlZm9yZWhhbmQgaWYgYSBmaW5kKCkKICAgIHdpbGwgcmVzdWx0IGluIGEgcmVxdWVzdCBvciB0aGF0IGl0IHdpbGwgYmUgYSBjYWNoZSBoaXQuCgogICAgIEV4YW1wbGUKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBzdG9yZS5yZWNvcmRJc0xvYWRlZChBcHAuUG9zdCwgMSk7IC8vIGZhbHNlCiAgICBzdG9yZS5maW5kKEFwcC5Qb3N0LCAxKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICBzdG9yZS5yZWNvcmRJc0xvYWRlZChBcHAuUG9zdCwgMSk7IC8vIHRydWUKICAgIH0pOwogICAgYGBgCgogICAgQG1ldGhvZCByZWNvcmRJc0xvYWRlZAogICAgQHBhcmFtIHtTdHJpbmcgb3Igc3ViY2xhc3Mgb2YgRFMuTW9kZWx9IHR5cGUKICAgIEBwYXJhbSB7c3RyaW5nfSBpZAogICAgQHJldHVybiB7Ym9vbGVhbn0KICAqLwogIHJlY29yZElzTG9hZGVkOiBmdW5jdGlvbih0eXBlLCBpZCkgewogICAgaWYgKCF0aGlzLmhhc1JlY29yZEZvcklkKHR5cGUsIGlkKSkgeyByZXR1cm4gZmFsc2U7IH0KICAgIHJldHVybiAhZ2V0KHRoaXMucmVjb3JkRm9ySWQodHlwZSwgaWQpLCAnaXNFbXB0eScpOwogIH0sCgogIC8qKgogICAgVGhpcyBtZXRob2QgcmV0dXJucyB0aGUgbWV0YWRhdGEgZm9yIGEgc3BlY2lmaWMgdHlwZS4KCiAgICBAbWV0aG9kIG1ldGFkYXRhRm9yCiAgICBAcGFyYW0ge1N0cmluZyBvciBzdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHJldHVybiB7b2JqZWN0fQogICovCiAgbWV0YWRhdGFGb3I6IGZ1bmN0aW9uKHR5cGUpIHsKICAgIHR5cGUgPSB0aGlzLm1vZGVsRm9yKHR5cGUpOwogICAgcmV0dXJuIHRoaXMudHlwZU1hcEZvcih0eXBlKS5tZXRhZGF0YTsKICB9LAoKICAvLyAuLi4uLi4uLi4uLi4KICAvLyAuIFVQREFUSU5HIC4KICAvLyAuLi4uLi4uLi4uLi4KCiAgLyoqCiAgICBJZiB0aGUgYWRhcHRlciB1cGRhdGVzIGF0dHJpYnV0ZXMgb3IgYWNrbm93bGVkZ2VzIGNyZWF0aW9uCiAgICBvciBkZWxldGlvbiwgdGhlIHJlY29yZCB3aWxsIG5vdGlmeSB0aGUgc3RvcmUgdG8gdXBkYXRlIGl0cwogICAgbWVtYmVyc2hpcCBpbiBhbnkgZmlsdGVycy4KICAgIFRvIGF2b2lkIHRocmFzaGluZywgdGhpcyBtZXRob2QgaXMgaW52b2tlZCBvbmx5IG9uY2UgcGVyCgogICAgcnVuIGxvb3AgcGVyIHJlY29yZC4KCiAgICBAbWV0aG9kIGRhdGFXYXNVcGRhdGVkCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtDbGFzc30gdHlwZQogICAgQHBhcmFtIHtEUy5Nb2RlbH0gcmVjb3JkCiAgKi8KICBkYXRhV2FzVXBkYXRlZDogZnVuY3Rpb24odHlwZSwgcmVjb3JkKSB7CiAgICB0aGlzLnJlY29yZEFycmF5TWFuYWdlci5yZWNvcmREaWRDaGFuZ2UocmVjb3JkKTsKICB9LAoKICAvLyAuLi4uLi4uLi4uLi4uLgogIC8vIC4gUEVSU0lTVElORyAuCiAgLy8gLi4uLi4uLi4uLi4uLi4KCiAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgYnkgYHJlY29yZC5zYXZlYCwgYW5kIGdldHMgcGFzc2VkIGEKICAgIHJlc29sdmVyIGZvciB0aGUgcHJvbWlzZSB0aGF0IGByZWNvcmQuc2F2ZWAgcmV0dXJucy4KCiAgICBJdCBzY2hlZHVsZXMgc2F2aW5nIHRvIGhhcHBlbiBhdCB0aGUgZW5kIG9mIHRoZSBydW4gbG9vcC4KCiAgICBAbWV0aG9kIHNjaGVkdWxlU2F2ZQogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7RFMuTW9kZWx9IHJlY29yZAogICAgQHBhcmFtIHtSZXNvbHZlcn0gcmVzb2x2ZXIKICAqLwogIHNjaGVkdWxlU2F2ZTogZnVuY3Rpb24ocmVjb3JkLCByZXNvbHZlcikgewogICAgcmVjb3JkLmFkYXB0ZXJXaWxsQ29tbWl0KCk7CiAgICB0aGlzLl9wZW5kaW5nU2F2ZS5wdXNoKFtyZWNvcmQsIHJlc29sdmVyXSk7CiAgICBvbmNlKHRoaXMsICdmbHVzaFBlbmRpbmdTYXZlJyk7CiAgfSwKCiAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgYXQgdGhlIGVuZCBvZiB0aGUgcnVuIGxvb3AsIGFuZAogICAgZmx1c2hlcyBhbnkgcmVjb3JkcyBwYXNzZWQgaW50byBgc2NoZWR1bGVTYXZlYAoKICAgIEBtZXRob2QgZmx1c2hQZW5kaW5nU2F2ZQogICAgQHByaXZhdGUKICAqLwogIGZsdXNoUGVuZGluZ1NhdmU6IGZ1bmN0aW9uKCkgewogICAgdmFyIHBlbmRpbmcgPSB0aGlzLl9wZW5kaW5nU2F2ZS5zbGljZSgpOwogICAgdGhpcy5fcGVuZGluZ1NhdmUgPSBbXTsKCiAgICBmb3JFYWNoKHBlbmRpbmcsIGZ1bmN0aW9uKHR1cGxlKSB7CiAgICAgIHZhciByZWNvcmQgPSB0dXBsZVswXSwgcmVzb2x2ZXIgPSB0dXBsZVsxXSwKICAgICAgICAgIGFkYXB0ZXIgPSB0aGlzLmFkYXB0ZXJGb3IocmVjb3JkLmNvbnN0cnVjdG9yKSwKICAgICAgICAgIG9wZXJhdGlvbjsKCiAgICAgIGlmIChnZXQocmVjb3JkLCAnaXNOZXcnKSkgewogICAgICAgIG9wZXJhdGlvbiA9ICdjcmVhdGVSZWNvcmQnOwogICAgICB9IGVsc2UgaWYgKGdldChyZWNvcmQsICdpc0RlbGV0ZWQnKSkgewogICAgICAgIG9wZXJhdGlvbiA9ICdkZWxldGVSZWNvcmQnOwogICAgICB9IGVsc2UgewogICAgICAgIG9wZXJhdGlvbiA9ICd1cGRhdGVSZWNvcmQnOwogICAgICB9CgogICAgICByZXNvbHZlci5yZXNvbHZlKF9jb21taXQoYWRhcHRlciwgdGhpcywgb3BlcmF0aW9uLCByZWNvcmQpKTsKICAgIH0sIHRoaXMpOwogIH0sCgogIC8qKgogICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIG9uY2UgdGhlIHByb21pc2UgcmV0dXJuZWQgYnkgYW4KICAgIGFkYXB0ZXIncyBgY3JlYXRlUmVjb3JkYCwgYHVwZGF0ZVJlY29yZGAgb3IgYGRlbGV0ZVJlY29yZGAKICAgIGlzIHJlc29sdmVkLgoKICAgIElmIHRoZSBkYXRhIHByb3ZpZGVzIGEgc2VydmVyLWdlbmVyYXRlZCBJRCwgaXQgd2lsbAogICAgdXBkYXRlIHRoZSByZWNvcmQgYW5kIHRoZSBzdG9yZSdzIGluZGV4ZXMuCgogICAgQG1ldGhvZCBkaWRTYXZlUmVjb3JkCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtEUy5Nb2RlbH0gcmVjb3JkIHRoZSBpbi1mbGlnaHQgcmVjb3JkCiAgICBAcGFyYW0ge09iamVjdH0gZGF0YSBvcHRpb25hbCBkYXRhIChzZWUgYWJvdmUpCiAgKi8KICBkaWRTYXZlUmVjb3JkOiBmdW5jdGlvbihyZWNvcmQsIGRhdGEpIHsKICAgIGlmIChkYXRhKSB7CiAgICAgIC8vIG5vcm1hbGl6ZSByZWxhdGlvbnNoaXAgSURzIGludG8gcmVjb3JkcwogICAgICBkYXRhID0gbm9ybWFsaXplUmVsYXRpb25zaGlwcyh0aGlzLCByZWNvcmQuY29uc3RydWN0b3IsIGRhdGEsIHJlY29yZCk7CgogICAgICB0aGlzLnVwZGF0ZUlkKHJlY29yZCwgZGF0YSk7CiAgICB9CgogICAgcmVjb3JkLmFkYXB0ZXJEaWRDb21taXQoZGF0YSk7CiAgfSwKCiAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgb25jZSB0aGUgcHJvbWlzZSByZXR1cm5lZCBieSBhbgogICAgYWRhcHRlcidzIGBjcmVhdGVSZWNvcmRgLCBgdXBkYXRlUmVjb3JkYCBvciBgZGVsZXRlUmVjb3JkYAogICAgaXMgcmVqZWN0ZWQgd2l0aCBhIGBEUy5JbnZhbGlkRXJyb3JgLgoKICAgIEBtZXRob2QgcmVjb3JkV2FzSW52YWxpZAogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7RFMuTW9kZWx9IHJlY29yZAogICAgQHBhcmFtIHtPYmplY3R9IGVycm9ycwogICovCiAgcmVjb3JkV2FzSW52YWxpZDogZnVuY3Rpb24ocmVjb3JkLCBlcnJvcnMpIHsKICAgIHJlY29yZC5hZGFwdGVyRGlkSW52YWxpZGF0ZShlcnJvcnMpOwogIH0sCgogIC8qKgogICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIG9uY2UgdGhlIHByb21pc2UgcmV0dXJuZWQgYnkgYW4KICAgIGFkYXB0ZXIncyBgY3JlYXRlUmVjb3JkYCwgYHVwZGF0ZVJlY29yZGAgb3IgYGRlbGV0ZVJlY29yZGAKICAgIGlzIHJlamVjdGVkICh3aXRoIGFueXRoaW5nIG90aGVyIHRoYW4gYSBgRFMuSW52YWxpZEVycm9yYCkuCgogICAgQG1ldGhvZCByZWNvcmRXYXNFcnJvcgogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7RFMuTW9kZWx9IHJlY29yZAogICovCiAgcmVjb3JkV2FzRXJyb3I6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgcmVjb3JkLmFkYXB0ZXJEaWRFcnJvcigpOwogIH0sCgogIC8qKgogICAgV2hlbiBhbiBhZGFwdGVyJ3MgYGNyZWF0ZVJlY29yZGAsIGB1cGRhdGVSZWNvcmRgIG9yIGBkZWxldGVSZWNvcmRgCiAgICByZXNvbHZlcyB3aXRoIGRhdGEsIHRoaXMgbWV0aG9kIGV4dHJhY3RzIHRoZSBJRCBmcm9tIHRoZSBzdXBwbGllZAogICAgZGF0YS4KCiAgICBAbWV0aG9kIHVwZGF0ZUlkCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtEUy5Nb2RlbH0gcmVjb3JkCiAgICBAcGFyYW0ge09iamVjdH0gZGF0YQogICovCiAgdXBkYXRlSWQ6IGZ1bmN0aW9uKHJlY29yZCwgZGF0YSkgewogICAgdmFyIG9sZElkID0gZ2V0KHJlY29yZCwgJ2lkJyksCiAgICAgICAgaWQgPSBjb2VyY2VJZChkYXRhLmlkKTsKCiAgICBFbWJlci5hc3NlcnQoIkFuIGFkYXB0ZXIgY2Fubm90IGFzc2lnbiBhIG5ldyBpZCB0byBhIHJlY29yZCB0aGF0IGFscmVhZHkgaGFzIGFuIGlkLiAiICsgcmVjb3JkICsgIiBoYWQgaWQ6ICIgKyBvbGRJZCArICIgYW5kIHlvdSB0cmllZCB0byB1cGRhdGUgaXQgd2l0aCAiICsgaWQgKyAiLiBUaGlzIGxpa2VseSBoYXBwZW5lZCBiZWNhdXNlIHlvdXIgc2VydmVyIHJldHVybmVkIGRhdGEgaW4gcmVzcG9uc2UgdG8gYSBmaW5kIG9yIHVwZGF0ZSB0aGF0IGhhZCBhIGRpZmZlcmVudCBpZCB0aGFuIHRoZSBvbmUgeW91IHNlbnQuIiwgb2xkSWQgPT09IG51bGwgfHwgaWQgPT09IG9sZElkKTsKCiAgICB0aGlzLnR5cGVNYXBGb3IocmVjb3JkLmNvbnN0cnVjdG9yKS5pZFRvUmVjb3JkW2lkXSA9IHJlY29yZDsKCiAgICBzZXQocmVjb3JkLCAnaWQnLCBpZCk7CiAgfSwKCiAgLyoqCiAgICBSZXR1cm5zIGEgbWFwIG9mIElEcyB0byBjbGllbnQgSURzIGZvciBhIGdpdmVuIHR5cGUuCgogICAgQG1ldGhvZCB0eXBlTWFwRm9yCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHR5cGUKICAgIEByZXR1cm4ge09iamVjdH0gdHlwZU1hcAogICovCiAgdHlwZU1hcEZvcjogZnVuY3Rpb24odHlwZSkgewogICAgdmFyIHR5cGVNYXBzID0gZ2V0KHRoaXMsICd0eXBlTWFwcycpLAogICAgICAgIGd1aWQgPSBFbWJlci5ndWlkRm9yKHR5cGUpLAogICAgICAgIHR5cGVNYXA7CgogICAgdHlwZU1hcCA9IHR5cGVNYXBzW2d1aWRdOwoKICAgIGlmICh0eXBlTWFwKSB7IHJldHVybiB0eXBlTWFwOyB9CgogICAgdHlwZU1hcCA9IHsKICAgICAgaWRUb1JlY29yZDoge30sCiAgICAgIHJlY29yZHM6IFtdLAogICAgICBtZXRhZGF0YToge30KICAgIH07CgogICAgdHlwZU1hcHNbZ3VpZF0gPSB0eXBlTWFwOwoKICAgIHJldHVybiB0eXBlTWFwOwogIH0sCgogIC8vIC4uLi4uLi4uLi4uLi4uLi4KICAvLyAuIExPQURJTkcgREFUQSAuCiAgLy8gLi4uLi4uLi4uLi4uLi4uLgoKICAvKioKICAgIFRoaXMgaW50ZXJuYWwgbWV0aG9kIGlzIHVzZWQgYnkgYHB1c2hgLgoKICAgIEBtZXRob2QgX2xvYWQKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1N0cmluZyBvciBzdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHBhcmFtIHtPYmplY3R9IGRhdGEKICAgIEBwYXJhbSB7Qm9vbGVhbn0gcGFydGlhbCB0aGUgZGF0YSBzaG91bGQgYmUgbWVyZ2VkIGludG8KICAgICAgdGhlIGV4aXN0aW5nIGRhdGEsIG5vdCByZXBsYWNlIGl0LgogICovCiAgX2xvYWQ6IGZ1bmN0aW9uKHR5cGUsIGRhdGEsIHBhcnRpYWwpIHsKICAgIHZhciBpZCA9IGNvZXJjZUlkKGRhdGEuaWQpLAogICAgICAgIHJlY29yZCA9IHRoaXMucmVjb3JkRm9ySWQodHlwZSwgaWQpOwoKICAgIHJlY29yZC5zZXR1cERhdGEoZGF0YSwgcGFydGlhbCk7CiAgICB0aGlzLnJlY29yZEFycmF5TWFuYWdlci5yZWNvcmREaWRDaGFuZ2UocmVjb3JkKTsKCiAgICByZXR1cm4gcmVjb3JkOwogIH0sCgogIC8qKgogICAgUmV0dXJucyBhIG1vZGVsIGNsYXNzIGZvciBhIHBhcnRpY3VsYXIga2V5LiBVc2VkIGJ5CiAgICBtZXRob2RzIHRoYXQgdGFrZSBhIHR5cGUga2V5IChsaWtlIGBmaW5kYCwgYGNyZWF0ZVJlY29yZGAsCiAgICBldGMuKQoKICAgIEBtZXRob2QgbW9kZWxGb3IKICAgIEBwYXJhbSB7U3RyaW5nIG9yIHN1YmNsYXNzIG9mIERTLk1vZGVsfSBrZXkKICAgIEByZXR1cm5zIHtzdWJjbGFzcyBvZiBEUy5Nb2RlbH0KICAqLwogIG1vZGVsRm9yOiBmdW5jdGlvbihrZXkpIHsKICAgIHZhciBmYWN0b3J5OwoKCiAgICBpZiAodHlwZW9mIGtleSA9PT0gJ3N0cmluZycpIHsKICAgICAgdmFyIG5vcm1hbGl6ZWRLZXkgPSB0aGlzLmNvbnRhaW5lci5ub3JtYWxpemUoJ21vZGVsOicgKyBrZXkpOwoKICAgICAgZmFjdG9yeSA9IHRoaXMuY29udGFpbmVyLmxvb2t1cEZhY3Rvcnkobm9ybWFsaXplZEtleSk7CiAgICAgIGlmICghZmFjdG9yeSkgeyB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoIk5vIG1vZGVsIHdhcyBmb3VuZCBmb3IgJyIgKyBrZXkgKyAiJyIpOyB9CiAgICAgIGZhY3RvcnkudHlwZUtleSA9IG5vcm1hbGl6ZWRLZXkuc3BsaXQoJzonLCAyKVsxXTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIEEgZmFjdG9yeSBhbHJlYWR5IHN1cHBsaWVkLgogICAgICBmYWN0b3J5ID0ga2V5OwogICAgfQoKICAgIGZhY3Rvcnkuc3RvcmUgPSB0aGlzOwogICAgcmV0dXJuIGZhY3Rvcnk7CiAgfSwKCiAgLyoqCiAgICBQdXNoIHNvbWUgZGF0YSBmb3IgYSBnaXZlbiB0eXBlIGludG8gdGhlIHN0b3JlLgoKICAgIFRoaXMgbWV0aG9kIGV4cGVjdHMgbm9ybWFsaXplZCBkYXRhOgoKICAgICogVGhlIElEIGlzIGEga2V5IG5hbWVkIGBpZGAgKGFuIElEIGlzIG1hbmRhdG9yeSkKICAgICogVGhlIG5hbWVzIG9mIGF0dHJpYnV0ZXMgYXJlIHRoZSBvbmVzIHlvdSB1c2VkIGluCiAgICAgIHlvdXIgbW9kZWwncyBgRFMuYXR0cmBzLgogICAgKiBZb3VyIHJlbGF0aW9uc2hpcHMgbXVzdCBiZToKICAgICAgKiByZXByZXNlbnRlZCBhcyBJRHMgb3IgQXJyYXlzIG9mIElEcwogICAgICAqIHJlcHJlc2VudGVkIGFzIG1vZGVsIGluc3RhbmNlcwogICAgICAqIHJlcHJlc2VudGVkIGFzIFVSTHMsIHVuZGVyIHRoZSBgbGlua3NgIGtleQoKICAgIEZvciB0aGlzIG1vZGVsOgoKICAgIGBgYGpzCiAgICBBcHAuUGVyc29uID0gRFMuTW9kZWwuZXh0ZW5kKHsKICAgICAgZmlyc3ROYW1lOiBEUy5hdHRyKCksCiAgICAgIGxhc3ROYW1lOiBEUy5hdHRyKCksCgogICAgICBjaGlsZHJlbjogRFMuaGFzTWFueSgncGVyc29uJykKICAgIH0pOwogICAgYGBgCgogICAgVG8gcmVwcmVzZW50IHRoZSBjaGlsZHJlbiBhcyBJRHM6CgogICAgYGBganMKICAgIHsKICAgICAgaWQ6IDEsCiAgICAgIGZpcnN0TmFtZTogIlRvbSIsCiAgICAgIGxhc3ROYW1lOiAiRGFsZSIsCiAgICAgIGNoaWxkcmVuOiBbMSwgMiwgM10KICAgIH0KICAgIGBgYAoKICAgIFRvIHJlcHJlc2VudCB0aGUgY2hpbGRyZW4gcmVsYXRpb25zaGlwIGFzIGEgVVJMOgoKICAgIGBgYGpzCiAgICB7CiAgICAgIGlkOiAxLAogICAgICBmaXJzdE5hbWU6ICJUb20iLAogICAgICBsYXN0TmFtZTogIkRhbGUiLAogICAgICBsaW5rczogewogICAgICAgIGNoaWxkcmVuOiAiL3Blb3BsZS8xL2NoaWxkcmVuIgogICAgICB9CiAgICB9CiAgICBgYGAKCiAgICBJZiB5b3UncmUgc3RyZWFtaW5nIGRhdGEgb3IgaW1wbGVtZW50aW5nIGFuIGFkYXB0ZXIsCiAgICBtYWtlIHN1cmUgdGhhdCB5b3UgaGF2ZSBjb252ZXJ0ZWQgdGhlIGluY29taW5nIGRhdGEKICAgIGludG8gdGhpcyBmb3JtLgoKICAgIFRoaXMgbWV0aG9kIGNhbiBiZSB1c2VkIGJvdGggdG8gcHVzaCBpbiBicmFuZCBuZXcKICAgIHJlY29yZHMsIGFzIHdlbGwgYXMgdG8gdXBkYXRlIGV4aXN0aW5nIHJlY29yZHMuCgogICAgQG1ldGhvZCBwdXNoCiAgICBAcGFyYW0ge1N0cmluZyBvciBzdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHBhcmFtIHtPYmplY3R9IGRhdGEKICAgIEByZXR1cm5zIHtEUy5Nb2RlbH0gdGhlIHJlY29yZCB0aGF0IHdhcyBjcmVhdGVkIG9yCiAgICAgIHVwZGF0ZWQuCiAgKi8KICBwdXNoOiBmdW5jdGlvbih0eXBlLCBkYXRhLCBfcGFydGlhbCkgewogICAgLy8gX3BhcnRpYWwgaXMgYW4gaW50ZXJuYWwgcGFyYW0gdXNlZCBieSBgdXBkYXRlYC4KICAgIC8vIElmIHBhc3NlZCwgaXQgbWVhbnMgdGhhdCB0aGUgZGF0YSBzaG91bGQgYmUKICAgIC8vIG1lcmdlZCBpbnRvIHRoZSBleGlzdGluZyBkYXRhLCBub3QgcmVwbGFjZSBpdC4KCiAgICBFbWJlci5hc3NlcnQoIllvdSBtdXN0IGluY2x1ZGUgYW4gYGlkYCBpbiBhIGhhc2ggcGFzc2VkIHRvIGBwdXNoYCIsIGRhdGEuaWQgIT0gbnVsbCk7CgogICAgdHlwZSA9IHRoaXMubW9kZWxGb3IodHlwZSk7CgogICAgLy8gbm9ybWFsaXplIHJlbGF0aW9uc2hpcCBJRHMgaW50byByZWNvcmRzCiAgICBkYXRhID0gbm9ybWFsaXplUmVsYXRpb25zaGlwcyh0aGlzLCB0eXBlLCBkYXRhKTsKCiAgICB0aGlzLl9sb2FkKHR5cGUsIGRhdGEsIF9wYXJ0aWFsKTsKCiAgICByZXR1cm4gdGhpcy5yZWNvcmRGb3JJZCh0eXBlLCBkYXRhLmlkKTsKICB9LAoKICAvKioKICAgIFB1c2ggc29tZSByYXcgZGF0YSBpbnRvIHRoZSBzdG9yZS4KCiAgICBUaGUgZGF0YSB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgZGVzZXJpYWxpemVkIHVzaW5nIHRoZQogICAgc2VyaWFsaXplciBmb3IgdGhlIGB0eXBlYCBwYXJhbS4KCiAgICBUaGlzIG1ldGhvZCBjYW4gYmUgdXNlZCBib3RoIHRvIHB1c2ggaW4gYnJhbmQgbmV3CiAgICByZWNvcmRzLCBhcyB3ZWxsIGFzIHRvIHVwZGF0ZSBleGlzdGluZyByZWNvcmRzLgoKICAgIFlvdSBjYW4gcHVzaCBpbiBtb3JlIHRoYW4gb25lIHR5cGUgb2Ygb2JqZWN0IGF0IG9uY2UuCiAgICBBbGwgb2JqZWN0cyBzaG91bGQgYmUgaW4gdGhlIGZvcm1hdCBleHBlY3RlZCBieSB0aGUKICAgIHNlcmlhbGl6ZXIuCgogICAgYGBganMKICAgIEFwcC5BcHBsaWNhdGlvblNlcmlhbGl6ZXIgPSBEUy5BY3RpdmVNb2RlbFNlcmlhbGl6ZXI7CgogICAgdmFyIHB1c2hEYXRhID0gewogICAgICBwb3N0czogWwogICAgICAgIHtpZDogMSwgcG9zdF90aXRsZTogIkdyZWF0IHBvc3QiLCBjb21tZW50X2lkczogWzJdfQogICAgICBdLAogICAgICBjb21tZW50czogWwogICAgICAgIHtpZDogMiwgY29tbWVudF9ib2R5OiAiSW5zaWdodGZ1bCBjb21tZW50In0KICAgICAgXQogICAgfQoKICAgIHN0b3JlLnB1c2hQYXlsb2FkKCdwb3N0JywgcHVzaERhdGEpOwogICAgYGBgCgogICAgQG1ldGhvZCBwdXNoUGF5bG9hZAogICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUKICAgIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICBAcmV0dXJuIHtEUy5Nb2RlbH0gdGhlIHJlY29yZCB0aGF0IHdhcyBjcmVhdGVkIG9yIHVwZGF0ZWQuCiAgKi8KICBwdXNoUGF5bG9hZDogZnVuY3Rpb24gKHR5cGUsIHBheWxvYWQpIHsKICAgIHZhciBzZXJpYWxpemVyOwogICAgaWYgKCFwYXlsb2FkKSB7CiAgICAgIHBheWxvYWQgPSB0eXBlOwogICAgICBzZXJpYWxpemVyID0gZGVmYXVsdFNlcmlhbGl6ZXIodGhpcy5jb250YWluZXIpOwogICAgICBFbWJlci5hc3NlcnQoIllvdSBjYW5ub3QgdXNlIGBzdG9yZSNwdXNoUGF5bG9hZGAgd2l0aG91dCBhIHR5cGUgdW5sZXNzIHlvdXIgZGVmYXVsdCBzZXJpYWxpemVyIGRlZmluZXMgYHB1c2hQYXlsb2FkYCIsIHNlcmlhbGl6ZXIucHVzaFBheWxvYWQpOwogICAgfSBlbHNlIHsKICAgICAgc2VyaWFsaXplciA9IHRoaXMuc2VyaWFsaXplckZvcih0eXBlKTsKICAgIH0KICAgIHNlcmlhbGl6ZXIucHVzaFBheWxvYWQodGhpcywgcGF5bG9hZCk7CiAgfSwKCiAgdXBkYXRlOiBmdW5jdGlvbih0eXBlLCBkYXRhKSB7CiAgICBFbWJlci5hc3NlcnQoIllvdSBtdXN0IGluY2x1ZGUgYW4gYGlkYCBpbiBhIGhhc2ggcGFzc2VkIHRvIGB1cGRhdGVgIiwgZGF0YS5pZCAhPSBudWxsKTsKCiAgICByZXR1cm4gdGhpcy5wdXNoKHR5cGUsIGRhdGEsIHRydWUpOwogIH0sCgogIC8qKgogICAgSWYgeW91IGhhdmUgYW4gQXJyYXkgb2Ygbm9ybWFsaXplZCBkYXRhIHRvIHB1c2gsCiAgICB5b3UgY2FuIGNhbGwgYHB1c2hNYW55YCB3aXRoIHRoZSBBcnJheSwgYW5kIGl0IHdpbGwKICAgIGNhbGwgYHB1c2hgIHJlcGVhdGVkbHkgZm9yIHlvdS4KCiAgICBAbWV0aG9kIHB1c2hNYW55CiAgICBAcGFyYW0ge1N0cmluZyBvciBzdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHBhcmFtIHtBcnJheX0gZGF0YXMKICAgIEByZXR1cm4ge0FycmF5fQogICovCiAgcHVzaE1hbnk6IGZ1bmN0aW9uKHR5cGUsIGRhdGFzKSB7CiAgICByZXR1cm4gbWFwKGRhdGFzLCBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHJldHVybiB0aGlzLnB1c2godHlwZSwgZGF0YSk7CiAgICB9LCB0aGlzKTsKICB9LAoKICAvKioKICAgIElmIHlvdSBoYXZlIHNvbWUgbWV0YWRhdGEgdG8gc2V0IGZvciBhIHR5cGUKICAgIHlvdSBjYW4gY2FsbCBgbWV0YUZvclR5cGVgLgoKICAgIEBtZXRob2QgbWV0YUZvclR5cGUKICAgIEBwYXJhbSB7U3RyaW5nIG9yIHN1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgICBAcGFyYW0ge09iamVjdH0gbWV0YWRhdGEKICAqLwogIG1ldGFGb3JUeXBlOiBmdW5jdGlvbih0eXBlLCBtZXRhZGF0YSkgewogICAgdHlwZSA9IHRoaXMubW9kZWxGb3IodHlwZSk7CgogICAgRW1iZXIubWVyZ2UodGhpcy50eXBlTWFwRm9yKHR5cGUpLm1ldGFkYXRhLCBtZXRhZGF0YSk7CiAgfSwKCiAgLyoqCiAgICBCdWlsZCBhIGJyYW5kIG5ldyByZWNvcmQgZm9yIGEgZ2l2ZW4gdHlwZSwgSUQsIGFuZAogICAgaW5pdGlhbCBkYXRhLgoKICAgIEBtZXRob2QgYnVpbGRSZWNvcmQKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge3N1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgICBAcGFyYW0ge1N0cmluZ30gaWQKICAgIEBwYXJhbSB7T2JqZWN0fSBkYXRhCiAgICBAcmV0dXJucyB7RFMuTW9kZWx9IHJlY29yZAogICovCiAgYnVpbGRSZWNvcmQ6IGZ1bmN0aW9uKHR5cGUsIGlkLCBkYXRhKSB7CiAgICB2YXIgdHlwZU1hcCA9IHRoaXMudHlwZU1hcEZvcih0eXBlKSwKICAgICAgICBpZFRvUmVjb3JkID0gdHlwZU1hcC5pZFRvUmVjb3JkOwoKICAgIEVtYmVyLmFzc2VydCgnVGhlIGlkICcgKyBpZCArICcgaGFzIGFscmVhZHkgYmVlbiB1c2VkIHdpdGggYW5vdGhlciByZWNvcmQgb2YgdHlwZSAnICsgdHlwZS50b1N0cmluZygpICsgJy4nLCAhaWQgfHwgIWlkVG9SZWNvcmRbaWRdKTsKCiAgICAvLyBsb29rdXBGYWN0b3J5IHNob3VsZCByZWFsbHkgcmV0dXJuIGFuIG9iamVjdCB0aGF0IGNyZWF0ZXMKICAgIC8vIGluc3RhbmNlcyB3aXRoIHRoZSBpbmplY3Rpb25zIGFwcGxpZWQKICAgIHZhciByZWNvcmQgPSB0eXBlLl9jcmVhdGUoewogICAgICBpZDogaWQsCiAgICAgIHN0b3JlOiB0aGlzLAogICAgICBjb250YWluZXI6IHRoaXMuY29udGFpbmVyCiAgICB9KTsKCiAgICBpZiAoZGF0YSkgewogICAgICByZWNvcmQuc2V0dXBEYXRhKGRhdGEpOwogICAgfQoKICAgIC8vIGlmIHdlJ3JlIGNyZWF0aW5nIGFuIGl0ZW0sIHRoaXMgcHJvY2VzcyB3aWxsIGJlIGRvbmUKICAgIC8vIGxhdGVyLCBvbmNlIHRoZSBvYmplY3QgaGFzIGJlZW4gcGVyc2lzdGVkLgogICAgaWYgKGlkKSB7CiAgICAgIGlkVG9SZWNvcmRbaWRdID0gcmVjb3JkOwogICAgfQoKICAgIHR5cGVNYXAucmVjb3Jkcy5wdXNoKHJlY29yZCk7CgogICAgcmV0dXJuIHJlY29yZDsKICB9LAoKICAvLyAuLi4uLi4uLi4uLi4uLi4KICAvLyAuIERFU1RSVUNUSU9OIC4KICAvLyAuLi4uLi4uLi4uLi4uLi4KCiAgLyoqCiAgICBXaGVuIGEgcmVjb3JkIGlzIGRlc3Ryb3llZCwgdGhpcyB1bi1pbmRleGVzIGl0IGFuZAogICAgcmVtb3ZlcyBpdCBmcm9tIGFueSByZWNvcmQgYXJyYXlzIHNvIGl0IGNhbiBiZSBHQ2VkLgoKICAgIEBtZXRob2QgZGVtYXRlcmlhbGl6ZVJlY29yZAogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7RFMuTW9kZWx9IHJlY29yZAogICovCiAgZGVtYXRlcmlhbGl6ZVJlY29yZDogZnVuY3Rpb24ocmVjb3JkKSB7CiAgICB2YXIgdHlwZSA9IHJlY29yZC5jb25zdHJ1Y3RvciwKICAgICAgICB0eXBlTWFwID0gdGhpcy50eXBlTWFwRm9yKHR5cGUpLAogICAgICAgIGlkID0gZ2V0KHJlY29yZCwgJ2lkJyk7CgogICAgcmVjb3JkLnVwZGF0ZVJlY29yZEFycmF5cygpOwoKICAgIGlmIChpZCkgewogICAgICBkZWxldGUgdHlwZU1hcC5pZFRvUmVjb3JkW2lkXTsKICAgIH0KCiAgICB2YXIgbG9jID0gaW5kZXhPZih0eXBlTWFwLnJlY29yZHMsIHJlY29yZCk7CiAgICB0eXBlTWFwLnJlY29yZHMuc3BsaWNlKGxvYywgMSk7CiAgfSwKCiAgLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCiAgLy8gLiBSRUxBVElPTlNISVAgQ0hBTkdFUyAuCiAgLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCgogIGFkZFJlbGF0aW9uc2hpcENoYW5nZUZvcjogZnVuY3Rpb24oY2hpbGRSZWNvcmQsIGNoaWxkS2V5LCBwYXJlbnRSZWNvcmQsIHBhcmVudEtleSwgY2hhbmdlKSB7CiAgICB2YXIgY2xpZW50SWQgPSBjaGlsZFJlY29yZC5jbGllbnRJZCwKICAgICAgICBwYXJlbnRDbGllbnRJZCA9IHBhcmVudFJlY29yZCA/IHBhcmVudFJlY29yZCA6IHBhcmVudFJlY29yZDsKICAgIHZhciBrZXkgPSBjaGlsZEtleSArIHBhcmVudEtleTsKICAgIHZhciBjaGFuZ2VzID0gdGhpcy5fcmVsYXRpb25zaGlwQ2hhbmdlczsKICAgIGlmICghKGNsaWVudElkIGluIGNoYW5nZXMpKSB7CiAgICAgIGNoYW5nZXNbY2xpZW50SWRdID0ge307CiAgICB9CiAgICBpZiAoIShwYXJlbnRDbGllbnRJZCBpbiBjaGFuZ2VzW2NsaWVudElkXSkpIHsKICAgICAgY2hhbmdlc1tjbGllbnRJZF1bcGFyZW50Q2xpZW50SWRdID0ge307CiAgICB9CiAgICBpZiAoIShrZXkgaW4gY2hhbmdlc1tjbGllbnRJZF1bcGFyZW50Q2xpZW50SWRdKSkgewogICAgICBjaGFuZ2VzW2NsaWVudElkXVtwYXJlbnRDbGllbnRJZF1ba2V5XSA9IHt9OwogICAgfQogICAgY2hhbmdlc1tjbGllbnRJZF1bcGFyZW50Q2xpZW50SWRdW2tleV1bY2hhbmdlLmNoYW5nZVR5cGVdID0gY2hhbmdlOwogIH0sCgogIHJlbW92ZVJlbGF0aW9uc2hpcENoYW5nZUZvcjogZnVuY3Rpb24oY2xpZW50UmVjb3JkLCBjaGlsZEtleSwgcGFyZW50UmVjb3JkLCBwYXJlbnRLZXksIHR5cGUpIHsKICAgIHZhciBjbGllbnRJZCA9IGNsaWVudFJlY29yZC5jbGllbnRJZCwKICAgICAgICBwYXJlbnRDbGllbnRJZCA9IHBhcmVudFJlY29yZCA/IHBhcmVudFJlY29yZC5jbGllbnRJZCA6IHBhcmVudFJlY29yZDsKICAgIHZhciBjaGFuZ2VzID0gdGhpcy5fcmVsYXRpb25zaGlwQ2hhbmdlczsKICAgIHZhciBrZXkgPSBjaGlsZEtleSArIHBhcmVudEtleTsKICAgIGlmICghKGNsaWVudElkIGluIGNoYW5nZXMpIHx8ICEocGFyZW50Q2xpZW50SWQgaW4gY2hhbmdlc1tjbGllbnRJZF0pIHx8ICEoa2V5IGluIGNoYW5nZXNbY2xpZW50SWRdW3BhcmVudENsaWVudElkXSkpewogICAgICByZXR1cm47CiAgICB9CiAgICBkZWxldGUgY2hhbmdlc1tjbGllbnRJZF1bcGFyZW50Q2xpZW50SWRdW2tleV1bdHlwZV07CiAgfSwKCiAgcmVsYXRpb25zaGlwQ2hhbmdlUGFpcnNGb3I6IGZ1bmN0aW9uKHJlY29yZCl7CiAgICB2YXIgdG9SZXR1cm4gPSBbXTsKCiAgICBpZiggIXJlY29yZCApIHsgcmV0dXJuIHRvUmV0dXJuOyB9CgogICAgLy9UT0RPKElnb3IpIFdoYXQgYWJvdXQgdGhlIG90aGVyIHNpZGUKICAgIHZhciBjaGFuZ2VzT2JqZWN0ID0gdGhpcy5fcmVsYXRpb25zaGlwQ2hhbmdlc1tyZWNvcmQuY2xpZW50SWRdOwogICAgZm9yICh2YXIgb2JqS2V5IGluIGNoYW5nZXNPYmplY3QpewogICAgICBpZihjaGFuZ2VzT2JqZWN0Lmhhc093blByb3BlcnR5KG9iaktleSkpewogICAgICAgIGZvciAodmFyIGNoYW5nZUtleSBpbiBjaGFuZ2VzT2JqZWN0W29iaktleV0pewogICAgICAgICAgaWYoY2hhbmdlc09iamVjdFtvYmpLZXldLmhhc093blByb3BlcnR5KGNoYW5nZUtleSkpewogICAgICAgICAgICB0b1JldHVybi5wdXNoKGNoYW5nZXNPYmplY3Rbb2JqS2V5XVtjaGFuZ2VLZXldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0b1JldHVybjsKICB9LAoKICAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uCiAgLy8gLiBQRVItVFlQRSBBREFQVEVSUwogIC8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KCiAgLyoqCiAgICBSZXR1cm5zIHRoZSBhZGFwdGVyIGZvciBhIGdpdmVuIHR5cGUuCgogICAgQG1ldGhvZCBhZGFwdGVyRm9yCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtzdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHJldHVybnMgRFMuQWRhcHRlcgogICovCiAgYWRhcHRlckZvcjogZnVuY3Rpb24odHlwZSkgewogICAgdmFyIGNvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyLCBhZGFwdGVyOwoKICAgIGlmIChjb250YWluZXIpIHsKICAgICAgYWRhcHRlciA9IGNvbnRhaW5lci5sb29rdXAoJ2FkYXB0ZXI6JyArIHR5cGUudHlwZUtleSkgfHwgY29udGFpbmVyLmxvb2t1cCgnYWRhcHRlcjphcHBsaWNhdGlvbicpOwogICAgfQoKICAgIHJldHVybiBhZGFwdGVyIHx8IGdldCh0aGlzLCAnZGVmYXVsdEFkYXB0ZXInKTsKICB9LAoKICAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KICAvLyAuIFJFQ09SRCBDSEFOR0UgTk9USUZJQ0FUSU9OIC4KICAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KCiAgLyoqCiAgICBSZXR1cm5zIGFuIGluc3RhbmNlIG9mIHRoZSBzZXJpYWxpemVyIGZvciBhIGdpdmVuIHR5cGUuIEZvcgogICAgZXhhbXBsZSwgYHNlcmlhbGl6ZXJGb3IoJ3BlcnNvbicpYCB3aWxsIHJldHVybiBhbiBpbnN0YW5jZSBvZgogICAgYEFwcC5QZXJzb25TZXJpYWxpemVyYC4KCiAgICBJZiBubyBgQXBwLlBlcnNvblNlcmlhbGl6ZXJgIGlzIGZvdW5kLCB0aGlzIG1ldGhvZCB3aWxsIGxvb2sKICAgIGZvciBhbiBgQXBwLkFwcGxpY2F0aW9uU2VyaWFsaXplcmAgKHRoZSBkZWZhdWx0IHNlcmlhbGl6ZXIgZm9yCiAgICB5b3VyIGVudGlyZSBhcHBsaWNhdGlvbikuCgogICAgSWYgbm8gYEFwcC5BcHBsaWNhdGlvblNlcmlhbGl6ZXJgIGlzIGZvdW5kLCBpdCB3aWxsIGZhbGwgYmFjawogICAgdG8gYW4gaW5zdGFuY2Ugb2YgYERTLkpTT05TZXJpYWxpemVyYC4KCiAgICBAbWV0aG9kIHNlcmlhbGl6ZXJGb3IKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSB0aGUgcmVjb3JkIHRvIHNlcmlhbGl6ZQogICAgQHJldHVybiB7RFMuU2VyaWFsaXplcn0KICAqLwogIHNlcmlhbGl6ZXJGb3I6IGZ1bmN0aW9uKHR5cGUpIHsKICAgIHR5cGUgPSB0aGlzLm1vZGVsRm9yKHR5cGUpOwogICAgdmFyIGFkYXB0ZXIgPSB0aGlzLmFkYXB0ZXJGb3IodHlwZSk7CgogICAgcmV0dXJuIHNlcmlhbGl6ZXJGb3IodGhpcy5jb250YWluZXIsIHR5cGUudHlwZUtleSwgYWRhcHRlciAmJiBhZGFwdGVyLmRlZmF1bHRTZXJpYWxpemVyKTsKICB9Cn0pOwoKZnVuY3Rpb24gbm9ybWFsaXplUmVsYXRpb25zaGlwcyhzdG9yZSwgdHlwZSwgZGF0YSwgcmVjb3JkKSB7CiAgdHlwZS5lYWNoUmVsYXRpb25zaGlwKGZ1bmN0aW9uKGtleSwgcmVsYXRpb25zaGlwKSB7CiAgICAvLyBBIGxpbmsgKHVzdWFsbHkgYSBVUkwpIHdhcyBhbHJlYWR5IHByb3ZpZGVkIGluCiAgICAvLyBub3JtYWxpemVkIGZvcm0KICAgIGlmIChkYXRhLmxpbmtzICYmIGRhdGEubGlua3Nba2V5XSkgewogICAgICBpZiAocmVjb3JkICYmIHJlbGF0aW9uc2hpcC5vcHRpb25zLmFzeW5jKSB7IHJlY29yZC5fcmVsYXRpb25zaGlwc1trZXldID0gbnVsbDsgfQogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGtpbmQgPSByZWxhdGlvbnNoaXAua2luZCwKICAgICAgICB2YWx1ZSA9IGRhdGFba2V5XTsKCiAgICBpZiAodmFsdWUgPT0gbnVsbCkgeyByZXR1cm47IH0KCiAgICBpZiAoa2luZCA9PT0gJ2JlbG9uZ3NUbycpIHsKICAgICAgZGVzZXJpYWxpemVSZWNvcmRJZChzdG9yZSwgZGF0YSwga2V5LCByZWxhdGlvbnNoaXAsIHZhbHVlKTsKICAgIH0gZWxzZSBpZiAoa2luZCA9PT0gJ2hhc01hbnknKSB7CiAgICAgIGRlc2VyaWFsaXplUmVjb3JkSWRzKHN0b3JlLCBkYXRhLCBrZXksIHJlbGF0aW9uc2hpcCwgdmFsdWUpOwogICAgICBhZGRVbnNhdmVkUmVjb3JkcyhyZWNvcmQsIGtleSwgdmFsdWUpOwogICAgfQogIH0pOwoKICByZXR1cm4gZGF0YTsKfQoKZnVuY3Rpb24gZGVzZXJpYWxpemVSZWNvcmRJZChzdG9yZSwgZGF0YSwga2V5LCByZWxhdGlvbnNoaXAsIGlkKSB7CiAgaWYgKGlzTm9uZShpZCkgfHwgaWQgaW5zdGFuY2VvZiBEUy5Nb2RlbCkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIHR5cGU7CgogIGlmICh0eXBlb2YgaWQgPT09ICdudW1iZXInIHx8IHR5cGVvZiBpZCA9PT0gJ3N0cmluZycpIHsKICAgIHR5cGUgPSB0eXBlRm9yKHJlbGF0aW9uc2hpcCwga2V5LCBkYXRhKTsKICAgIGRhdGFba2V5XSA9IHN0b3JlLnJlY29yZEZvcklkKHR5cGUsIGlkKTsKICB9IGVsc2UgaWYgKHR5cGVvZiBpZCA9PT0gJ29iamVjdCcpIHsKICAgIC8vIHBvbHltb3JwaGljCiAgICBkYXRhW2tleV0gPSBzdG9yZS5yZWNvcmRGb3JJZChpZC50eXBlLCBpZC5pZCk7CiAgfQp9CgpmdW5jdGlvbiB0eXBlRm9yKHJlbGF0aW9uc2hpcCwga2V5LCBkYXRhKSB7CiAgaWYgKHJlbGF0aW9uc2hpcC5vcHRpb25zLnBvbHltb3JwaGljKSB7CiAgICByZXR1cm4gZGF0YVtrZXkgKyAiVHlwZSJdOwogIH0gZWxzZSB7CiAgICByZXR1cm4gcmVsYXRpb25zaGlwLnR5cGU7CiAgfQp9CgpmdW5jdGlvbiBkZXNlcmlhbGl6ZVJlY29yZElkcyhzdG9yZSwgZGF0YSwga2V5LCByZWxhdGlvbnNoaXAsIGlkcykgewogIGZvciAodmFyIGk9MCwgbD1pZHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgZGVzZXJpYWxpemVSZWNvcmRJZChzdG9yZSwgaWRzLCBpLCByZWxhdGlvbnNoaXAsIGlkc1tpXSk7CiAgfQp9CgovLyBJZiB0aGVyZSBhcmUgYW55IHVuc2F2ZWQgcmVjb3JkcyB0aGF0IGFyZSBpbiBhIGhhc01hbnkgdGhleSB3b24ndCBiZQovLyBpbiB0aGUgcGF5bG9hZCwgc28gYWRkIHRoZW0gYmFjayBpbiBtYW51YWxseS4KZnVuY3Rpb24gYWRkVW5zYXZlZFJlY29yZHMocmVjb3JkLCBrZXksIGRhdGEpIHsKICBpZihyZWNvcmQpIHsKICAgIGRhdGEucHVzaE9iamVjdHMocmVjb3JkLmdldChrZXkpLmZpbHRlckJ5KCdpc05ldycpKTsKICB9Cn0KCi8vIERlbGVnYXRpb24gdG8gdGhlIGFkYXB0ZXIgYW5kIHByb21pc2UgbWFuYWdlbWVudAovKioKICBBIGBQcm9taXNlQXJyYXlgIGlzIGFuIG9iamVjdCB0aGF0IGFjdHMgbGlrZSBib3RoIGFuIGBFbWJlci5BcnJheWAKICBhbmQgYSBwcm9taXNlLiBXaGVuIHRoZSBwcm9taXNlIGlzIHJlc29sdmVkIHRoZSB0aGUgcmVzdWx0aW5nIHZhbHVlCiAgd2lsbCBiZSBzZXQgdG8gdGhlIGBQcm9taXNlQXJyYXlgJ3MgYGNvbnRlbnRgIHByb3BlcnR5LiBUaGlzIG1ha2VzCiAgaXQgZWFzeSB0byBjcmVhdGUgZGF0YSBiaW5kaW5ncyB3aXRoIHRoZSBgUHJvbWlzZUFycmF5YCB0aGF0IHdpbGwgYmUKICB1cGRhdGVkIHdoZW4gdGhlIHByb21pc2UgcmVzb2x2ZXMuCgogIEZvciBtb3JlIGluZm9ybWF0aW9uIHNlZSB0aGUgW0VtYmVyLlByb21pc2VQcm94eU1peGluCiAgZG9jdW1lbnRhdGlvbl0oL2FwaS9jbGFzc2VzL0VtYmVyLlByb21pc2VQcm94eU1peGluLmh0bWwpLgoKICBFeGFtcGxlCgogIGBgYGphdmFzY3JpcHQKICB2YXIgcHJvbWlzZUFycmF5ID0gRFMuUHJvbWlzZUFycmF5LmNyZWF0ZSh7CiAgICBwcm9taXNlOiAkLmdldEpTT04oJy9zb21lL3JlbW90ZS9kYXRhLmpzb24nKQogIH0pOwoKICBwcm9taXNlQXJyYXkuZ2V0KCdsZW5ndGgnKTsgLy8gMAoKICBwcm9taXNlQXJyYXkudGhlbihmdW5jdGlvbigpIHsKICAgIHByb21pc2VBcnJheS5nZXQoJ2xlbmd0aCcpOyAvLyAxMDAKICB9KTsKICBgYGAKCiAgQGNsYXNzIFByb21pc2VBcnJheQogIEBuYW1lc3BhY2UgRFMKICBAZXh0ZW5kcyBFbWJlci5BcnJheVByb3h5CiAgQHVzZXMgRW1iZXIuUHJvbWlzZVByb3h5TWl4aW4KKi8KRFMuUHJvbWlzZUFycmF5ID0gRW1iZXIuQXJyYXlQcm94eS5leHRlbmQoRW1iZXIuUHJvbWlzZVByb3h5TWl4aW4pOwovKioKICBBIGBQcm9taXNlT2JqZWN0YCBpcyBhbiBvYmplY3QgdGhhdCBhY3RzIGxpa2UgYm90aCBhbiBgRW1iZXIuT2JqZWN0YAogIGFuZCBhIHByb21pc2UuIFdoZW4gdGhlIHByb21pc2UgaXMgcmVzb2x2ZWQgdGhlIHRoZSByZXN1bHRpbmcgdmFsdWUKICB3aWxsIGJlIHNldCB0byB0aGUgYFByb21pc2VPYmplY3RgJ3MgYGNvbnRlbnRgIHByb3BlcnR5LiBUaGlzIG1ha2VzCiAgaXQgZWFzeSB0byBjcmVhdGUgZGF0YSBiaW5kaW5ncyB3aXRoIHRoZSBgUHJvbWlzZU9iamVjdGAgdGhhdCB3aWxsCiAgYmUgdXBkYXRlZCB3aGVuIHRoZSBwcm9taXNlIHJlc29sdmVzLgoKICBGb3IgbW9yZSBpbmZvcm1hdGlvbiBzZWUgdGhlIFtFbWJlci5Qcm9taXNlUHJveHlNaXhpbgogIGRvY3VtZW50YXRpb25dKC9hcGkvY2xhc3Nlcy9FbWJlci5Qcm9taXNlUHJveHlNaXhpbi5odG1sKS4KCiAgRXhhbXBsZQoKICBgYGBqYXZhc2NyaXB0CiAgdmFyIHByb21pc2VPYmplY3QgPSBEUy5Qcm9taXNlT2JqZWN0LmNyZWF0ZSh7CiAgICBwcm9taXNlOiAkLmdldEpTT04oJy9zb21lL3JlbW90ZS9kYXRhLmpzb24nKQogIH0pOwoKICBwcm9taXNlT2JqZWN0LmdldCgnbmFtZScpOyAvLyBudWxsCgogIHByb21pc2VPYmplY3QudGhlbihmdW5jdGlvbigpIHsKICAgIHByb21pc2VPYmplY3QuZ2V0KCduYW1lJyk7IC8vICdUb21zdGVyJwogIH0pOwogIGBgYAoKICBAY2xhc3MgUHJvbWlzZU9iamVjdAogIEBuYW1lc3BhY2UgRFMKICBAZXh0ZW5kcyBFbWJlci5PYmplY3RQcm94eQogIEB1c2VzIEVtYmVyLlByb21pc2VQcm94eU1peGluCiovCkRTLlByb21pc2VPYmplY3QgPSBFbWJlci5PYmplY3RQcm94eS5leHRlbmQoRW1iZXIuUHJvbWlzZVByb3h5TWl4aW4pOwoKZnVuY3Rpb24gcHJvbWlzZU9iamVjdChwcm9taXNlKSB7CiAgcmV0dXJuIERTLlByb21pc2VPYmplY3QuY3JlYXRlKHsgcHJvbWlzZTogcHJvbWlzZSB9KTsKfQoKZnVuY3Rpb24gcHJvbWlzZUFycmF5KHByb21pc2UpIHsKICByZXR1cm4gRFMuUHJvbWlzZUFycmF5LmNyZWF0ZSh7IHByb21pc2U6IHByb21pc2UgfSk7Cn0KCmZ1bmN0aW9uIGlzVGhlbmFibGUob2JqZWN0KSB7CiAgcmV0dXJuIG9iamVjdCAmJiB0eXBlb2Ygb2JqZWN0LnRoZW4gPT09ICdmdW5jdGlvbic7Cn0KCmZ1bmN0aW9uIHNlcmlhbGl6ZXJGb3IoY29udGFpbmVyLCB0eXBlLCBkZWZhdWx0U2VyaWFsaXplcikgewogIHJldHVybiBjb250YWluZXIubG9va3VwKCdzZXJpYWxpemVyOicrdHlwZSkgfHwKICAgICAgICAgICAgICAgICBjb250YWluZXIubG9va3VwKCdzZXJpYWxpemVyOmFwcGxpY2F0aW9uJykgfHwKICAgICAgICAgICAgICAgICBjb250YWluZXIubG9va3VwKCdzZXJpYWxpemVyOicgKyBkZWZhdWx0U2VyaWFsaXplcikgfHwKICAgICAgICAgICAgICAgICBjb250YWluZXIubG9va3VwKCdzZXJpYWxpemVyOl9kZWZhdWx0Jyk7Cn0KCmZ1bmN0aW9uIGRlZmF1bHRTZXJpYWxpemVyKGNvbnRhaW5lcikgewogIHJldHVybiBjb250YWluZXIubG9va3VwKCdzZXJpYWxpemVyOmFwcGxpY2F0aW9uJykgfHwKICAgICAgICAgY29udGFpbmVyLmxvb2t1cCgnc2VyaWFsaXplcjpfZGVmYXVsdCcpOwp9CgpmdW5jdGlvbiBzZXJpYWxpemVyRm9yQWRhcHRlcihhZGFwdGVyLCB0eXBlKSB7CiAgdmFyIHNlcmlhbGl6ZXIgPSBhZGFwdGVyLnNlcmlhbGl6ZXIsCiAgICAgIGRlZmF1bHRTZXJpYWxpemVyID0gYWRhcHRlci5kZWZhdWx0U2VyaWFsaXplciwKICAgICAgY29udGFpbmVyID0gYWRhcHRlci5jb250YWluZXI7CgogIGlmIChjb250YWluZXIgJiYgc2VyaWFsaXplciA9PT0gdW5kZWZpbmVkKSB7CiAgICBzZXJpYWxpemVyID0gc2VyaWFsaXplckZvcihjb250YWluZXIsIHR5cGUudHlwZUtleSwgZGVmYXVsdFNlcmlhbGl6ZXIpOwogIH0KCiAgaWYgKHNlcmlhbGl6ZXIgPT09IG51bGwgfHwgc2VyaWFsaXplciA9PT0gdW5kZWZpbmVkKSB7CiAgICBzZXJpYWxpemVyID0gewogICAgICBleHRyYWN0OiBmdW5jdGlvbihzdG9yZSwgdHlwZSwgcGF5bG9hZCkgeyByZXR1cm4gcGF5bG9hZDsgfQogICAgfTsKICB9CgogIHJldHVybiBzZXJpYWxpemVyOwp9CgpmdW5jdGlvbiBfZmluZChhZGFwdGVyLCBzdG9yZSwgdHlwZSwgaWQpIHsKICB2YXIgcHJvbWlzZSA9IGFkYXB0ZXIuZmluZChzdG9yZSwgdHlwZSwgaWQpLAogICAgICBzZXJpYWxpemVyID0gc2VyaWFsaXplckZvckFkYXB0ZXIoYWRhcHRlciwgdHlwZSk7CgogIHJldHVybiByZXNvbHZlKHByb21pc2UsICJEUzogSGFuZGxlIEFkYXB0ZXIjZmluZCBvZiAiICsgdHlwZSArICIgd2l0aCBpZDogIiArIGlkKS50aGVuKGZ1bmN0aW9uKHBheWxvYWQpIHsKICAgIEVtYmVyLmFzc2VydCgiWW91IG1hZGUgYSByZXF1ZXN0IGZvciBhICIgKyB0eXBlLnR5cGVLZXkgKyAiIHdpdGggaWQgIiArIGlkICsgIiwgYnV0IHRoZSBhZGFwdGVyJ3MgcmVzcG9uc2UgZGlkIG5vdCBoYXZlIGFueSBkYXRhIiwgcGF5bG9hZCk7CiAgICBwYXlsb2FkID0gc2VyaWFsaXplci5leHRyYWN0KHN0b3JlLCB0eXBlLCBwYXlsb2FkLCBpZCwgJ2ZpbmQnKTsKCiAgICByZXR1cm4gc3RvcmUucHVzaCh0eXBlLCBwYXlsb2FkKTsKICB9LCBmdW5jdGlvbihlcnJvcikgewogICAgdmFyIHJlY29yZCA9IHN0b3JlLmdldEJ5SWQodHlwZSwgaWQpOwogICAgcmVjb3JkLm5vdEZvdW5kKCk7CiAgICB0aHJvdyBlcnJvcjsKICB9LCAiRFM6IEV4dHJhY3QgcGF5bG9hZCBvZiAnIiArIHR5cGUgKyAiJyIpOwp9CgpmdW5jdGlvbiBfZmluZE1hbnkoYWRhcHRlciwgc3RvcmUsIHR5cGUsIGlkcywgb3duZXIpIHsKICB2YXIgcHJvbWlzZSA9IGFkYXB0ZXIuZmluZE1hbnkoc3RvcmUsIHR5cGUsIGlkcywgb3duZXIpLAogICAgICBzZXJpYWxpemVyID0gc2VyaWFsaXplckZvckFkYXB0ZXIoYWRhcHRlciwgdHlwZSk7CgogIHJldHVybiByZXNvbHZlKHByb21pc2UsICJEUzogSGFuZGxlIEFkYXB0ZXIjZmluZE1hbnkgb2YgIiArIHR5cGUpLnRoZW4oZnVuY3Rpb24ocGF5bG9hZCkgewogICAgcGF5bG9hZCA9IHNlcmlhbGl6ZXIuZXh0cmFjdChzdG9yZSwgdHlwZSwgcGF5bG9hZCwgbnVsbCwgJ2ZpbmRNYW55Jyk7CgogICAgRW1iZXIuYXNzZXJ0KCJUaGUgcmVzcG9uc2UgZnJvbSBhIGZpbmRNYW55IG11c3QgYmUgYW4gQXJyYXksIG5vdCAiICsgRW1iZXIuaW5zcGVjdChwYXlsb2FkKSwgRW1iZXIudHlwZU9mKHBheWxvYWQpID09PSAnYXJyYXknKTsKCiAgICBzdG9yZS5wdXNoTWFueSh0eXBlLCBwYXlsb2FkKTsKICB9LCBudWxsLCAiRFM6IEV4dHJhY3QgcGF5bG9hZCBvZiAiICsgdHlwZSk7Cn0KCmZ1bmN0aW9uIF9maW5kSGFzTWFueShhZGFwdGVyLCBzdG9yZSwgcmVjb3JkLCBsaW5rLCByZWxhdGlvbnNoaXApIHsKICB2YXIgcHJvbWlzZSA9IGFkYXB0ZXIuZmluZEhhc01hbnkoc3RvcmUsIHJlY29yZCwgbGluaywgcmVsYXRpb25zaGlwKSwKICAgICAgc2VyaWFsaXplciA9IHNlcmlhbGl6ZXJGb3JBZGFwdGVyKGFkYXB0ZXIsIHJlbGF0aW9uc2hpcC50eXBlKTsKCiAgcmV0dXJuIHJlc29sdmUocHJvbWlzZSwgIkRTOiBIYW5kbGUgQWRhcHRlciNmaW5kSGFzTWFueSBvZiAiICsgcmVjb3JkICsgIiA6ICIgKyByZWxhdGlvbnNoaXAudHlwZSkudGhlbihmdW5jdGlvbihwYXlsb2FkKSB7CiAgICBwYXlsb2FkID0gc2VyaWFsaXplci5leHRyYWN0KHN0b3JlLCByZWxhdGlvbnNoaXAudHlwZSwgcGF5bG9hZCwgbnVsbCwgJ2ZpbmRIYXNNYW55Jyk7CgogICAgRW1iZXIuYXNzZXJ0KCJUaGUgcmVzcG9uc2UgZnJvbSBhIGZpbmRIYXNNYW55IG11c3QgYmUgYW4gQXJyYXksIG5vdCAiICsgRW1iZXIuaW5zcGVjdChwYXlsb2FkKSwgRW1iZXIudHlwZU9mKHBheWxvYWQpID09PSAnYXJyYXknKTsKCiAgICB2YXIgcmVjb3JkcyA9IHN0b3JlLnB1c2hNYW55KHJlbGF0aW9uc2hpcC50eXBlLCBwYXlsb2FkKTsKICAgIHJlY29yZC51cGRhdGVIYXNNYW55KHJlbGF0aW9uc2hpcC5rZXksIHJlY29yZHMpOwogIH0sIG51bGwsICJEUzogRXh0cmFjdCBwYXlsb2FkIG9mICIgKyByZWNvcmQgKyAiIDogaGFzTWFueSAiICsgcmVsYXRpb25zaGlwLnR5cGUpOwp9CgpmdW5jdGlvbiBfZmluZEJlbG9uZ3NUbyhhZGFwdGVyLCBzdG9yZSwgcmVjb3JkLCBsaW5rLCByZWxhdGlvbnNoaXApIHsKICB2YXIgcHJvbWlzZSA9IGFkYXB0ZXIuZmluZEJlbG9uZ3NUbyhzdG9yZSwgcmVjb3JkLCBsaW5rLCByZWxhdGlvbnNoaXApLAogICAgICBzZXJpYWxpemVyID0gc2VyaWFsaXplckZvckFkYXB0ZXIoYWRhcHRlciwgcmVsYXRpb25zaGlwLnR5cGUpOwoKICByZXR1cm4gcmVzb2x2ZShwcm9taXNlLCAiRFM6IEhhbmRsZSBBZGFwdGVyI2ZpbmRCZWxvbmdzVG8gb2YgIiArIHJlY29yZCArICIgOiAiICsgcmVsYXRpb25zaGlwLnR5cGUpLnRoZW4oZnVuY3Rpb24ocGF5bG9hZCkgewogICAgcGF5bG9hZCA9IHNlcmlhbGl6ZXIuZXh0cmFjdChzdG9yZSwgcmVsYXRpb25zaGlwLnR5cGUsIHBheWxvYWQsIG51bGwsICdmaW5kQmVsb25nc1RvJyk7CgogICAgdmFyIHJlY29yZCA9IHN0b3JlLnB1c2gocmVsYXRpb25zaGlwLnR5cGUsIHBheWxvYWQpOwogICAgcmVjb3JkLnVwZGF0ZUJlbG9uZ3NUbyhyZWxhdGlvbnNoaXAua2V5LCByZWNvcmQpOwogICAgcmV0dXJuIHJlY29yZDsKICB9LCBudWxsLCAiRFM6IEV4dHJhY3QgcGF5bG9hZCBvZiAiICsgcmVjb3JkICsgIiA6ICIgKyByZWxhdGlvbnNoaXAudHlwZSk7Cn0KCmZ1bmN0aW9uIF9maW5kQWxsKGFkYXB0ZXIsIHN0b3JlLCB0eXBlLCBzaW5jZVRva2VuKSB7CiAgdmFyIHByb21pc2UgPSBhZGFwdGVyLmZpbmRBbGwoc3RvcmUsIHR5cGUsIHNpbmNlVG9rZW4pLAogICAgICBzZXJpYWxpemVyID0gc2VyaWFsaXplckZvckFkYXB0ZXIoYWRhcHRlciwgdHlwZSk7CgogIHJldHVybiByZXNvbHZlKHByb21pc2UsICJEUzogSGFuZGxlIEFkYXB0ZXIjZmluZEFsbCBvZiAiICsgdHlwZSkudGhlbihmdW5jdGlvbihwYXlsb2FkKSB7CiAgICBwYXlsb2FkID0gc2VyaWFsaXplci5leHRyYWN0KHN0b3JlLCB0eXBlLCBwYXlsb2FkLCBudWxsLCAnZmluZEFsbCcpOwoKICAgIEVtYmVyLmFzc2VydCgiVGhlIHJlc3BvbnNlIGZyb20gYSBmaW5kQWxsIG11c3QgYmUgYW4gQXJyYXksIG5vdCAiICsgRW1iZXIuaW5zcGVjdChwYXlsb2FkKSwgRW1iZXIudHlwZU9mKHBheWxvYWQpID09PSAnYXJyYXknKTsKCiAgICBzdG9yZS5wdXNoTWFueSh0eXBlLCBwYXlsb2FkKTsKICAgIHN0b3JlLmRpZFVwZGF0ZUFsbCh0eXBlKTsKICAgIHJldHVybiBzdG9yZS5hbGwodHlwZSk7CiAgfSwgbnVsbCwgIkRTOiBFeHRyYWN0IHBheWxvYWQgb2YgZmluZEFsbCAiICsgdHlwZSk7Cn0KCmZ1bmN0aW9uIF9maW5kUXVlcnkoYWRhcHRlciwgc3RvcmUsIHR5cGUsIHF1ZXJ5LCByZWNvcmRBcnJheSkgewogIHZhciBwcm9taXNlID0gYWRhcHRlci5maW5kUXVlcnkoc3RvcmUsIHR5cGUsIHF1ZXJ5LCByZWNvcmRBcnJheSksCiAgICAgIHNlcmlhbGl6ZXIgPSBzZXJpYWxpemVyRm9yQWRhcHRlcihhZGFwdGVyLCB0eXBlKTsKCiAgcmV0dXJuIHJlc29sdmUocHJvbWlzZSwgIkRTOiBIYW5kbGUgQWRhcHRlciNmaW5kUXVlcnkgb2YgIiArIHR5cGUpLnRoZW4oZnVuY3Rpb24ocGF5bG9hZCkgewogICAgcGF5bG9hZCA9IHNlcmlhbGl6ZXIuZXh0cmFjdChzdG9yZSwgdHlwZSwgcGF5bG9hZCwgbnVsbCwgJ2ZpbmRRdWVyeScpOwoKICAgIEVtYmVyLmFzc2VydCgiVGhlIHJlc3BvbnNlIGZyb20gYSBmaW5kUXVlcnkgbXVzdCBiZSBhbiBBcnJheSwgbm90ICIgKyBFbWJlci5pbnNwZWN0KHBheWxvYWQpLCBFbWJlci50eXBlT2YocGF5bG9hZCkgPT09ICdhcnJheScpOwoKICAgIHJlY29yZEFycmF5LmxvYWQocGF5bG9hZCk7CiAgICByZXR1cm4gcmVjb3JkQXJyYXk7CiAgfSwgbnVsbCwgIkRTOiBFeHRyYWN0IHBheWxvYWQgb2YgZmluZFF1ZXJ5ICIgKyB0eXBlKTsKfQoKZnVuY3Rpb24gX2NvbW1pdChhZGFwdGVyLCBzdG9yZSwgb3BlcmF0aW9uLCByZWNvcmQpIHsKICB2YXIgdHlwZSA9IHJlY29yZC5jb25zdHJ1Y3RvciwKICAgICAgcHJvbWlzZSA9IGFkYXB0ZXJbb3BlcmF0aW9uXShzdG9yZSwgdHlwZSwgcmVjb3JkKSwKICAgICAgc2VyaWFsaXplciA9IHNlcmlhbGl6ZXJGb3JBZGFwdGVyKGFkYXB0ZXIsIHR5cGUpOwoKICBFbWJlci5hc3NlcnQoIllvdXIgYWRhcHRlcidzICciICsgb3BlcmF0aW9uICsgIicgbWV0aG9kIG11c3QgcmV0dXJuIGEgcHJvbWlzZSwgYnV0IGl0IHJldHVybmVkICIgKyBwcm9taXNlLCBpc1RoZW5hYmxlKHByb21pc2UpKTsKCiAgcmV0dXJuIHByb21pc2UudGhlbihmdW5jdGlvbihwYXlsb2FkKSB7CiAgICBpZiAocGF5bG9hZCkgeyBwYXlsb2FkID0gc2VyaWFsaXplci5leHRyYWN0KHN0b3JlLCB0eXBlLCBwYXlsb2FkLCBnZXQocmVjb3JkLCAnaWQnKSwgb3BlcmF0aW9uKTsgfQogICAgc3RvcmUuZGlkU2F2ZVJlY29yZChyZWNvcmQsIHBheWxvYWQpOwogICAgcmV0dXJuIHJlY29yZDsKICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICAgIGlmIChyZWFzb24gaW5zdGFuY2VvZiBEUy5JbnZhbGlkRXJyb3IpIHsKICAgICAgc3RvcmUucmVjb3JkV2FzSW52YWxpZChyZWNvcmQsIHJlYXNvbi5lcnJvcnMpOwogICAgfSBlbHNlIHsKICAgICAgc3RvcmUucmVjb3JkV2FzRXJyb3IocmVjb3JkLCByZWFzb24pOwogICAgfQoKICAgIHRocm93IHJlYXNvbjsKICB9LCAiRFM6IEV4dHJhY3QgYW5kIG5vdGlmeSBhYm91dCAiICsgb3BlcmF0aW9uICsgIiBjb21wbGV0aW9uIG9mICIgKyByZWNvcmQpOwp9Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgogIEBtb2R1bGUgZW1iZXItZGF0YQoqLwoKdmFyIGdldCA9IEVtYmVyLmdldCwgc2V0ID0gRW1iZXIuc2V0OwovKgogIFRoaXMgZmlsZSBlbmNhcHN1bGF0ZXMgdGhlIHZhcmlvdXMgc3RhdGVzIHRoYXQgYSByZWNvcmQgY2FuIHRyYW5zaXRpb24KICB0aHJvdWdoIGR1cmluZyBpdHMgbGlmZWN5Y2xlLgoqLwovKioKICAjIyMgU3RhdGUKCiAgRWFjaCByZWNvcmQgaGFzIGEgYGN1cnJlbnRTdGF0ZWAgcHJvcGVydHkgdGhhdCBleHBsaWNpdGx5IHRyYWNrcyB3aGF0CiAgc3RhdGUgYSByZWNvcmQgaXMgaW4gYXQgYW55IGdpdmVuIHRpbWUuIEZvciBpbnN0YW5jZSwgaWYgYSByZWNvcmQgaXMKICBuZXdseSBjcmVhdGVkIGFuZCBoYXMgbm90IHlldCBiZWVuIHNlbnQgdG8gdGhlIGFkYXB0ZXIgdG8gYmUgc2F2ZWQsCiAgaXQgd291bGQgYmUgaW4gdGhlIGByb290LmxvYWRlZC5jcmVhdGVkLnVuY29tbWl0dGVkYCBzdGF0ZS4gIElmIGEKICByZWNvcmQgaGFzIGhhZCBsb2NhbCBtb2RpZmljYXRpb25zIG1hZGUgdG8gaXQgdGhhdCBhcmUgaW4gdGhlCiAgcHJvY2VzcyBvZiBiZWluZyBzYXZlZCwgdGhlIHJlY29yZCB3b3VsZCBiZSBpbiB0aGUKICBgcm9vdC5sb2FkZWQudXBkYXRlZC5pbkZsaWdodGAgc3RhdGUuIChUaGVzZSBzdGF0ZSBwYXRocyB3aWxsIGJlCiAgZXhwbGFpbmVkIGluIG1vcmUgZGV0YWlsIGJlbG93LikKCiAgRXZlbnRzIGFyZSBzZW50IGJ5IHRoZSByZWNvcmQgb3IgaXRzIHN0b3JlIHRvIHRoZSByZWNvcmQncwogIGBjdXJyZW50U3RhdGVgIHByb3BlcnR5LiBIb3cgdGhlIHN0YXRlIHJlYWN0cyB0byB0aGVzZSBldmVudHMgaXMKICBkZXBlbmRlbnQgb24gd2hpY2ggc3RhdGUgaXQgaXMgaW4uIEluIHNvbWUgc3RhdGVzLCBjZXJ0YWluIGV2ZW50cwogIHdpbGwgYmUgaW52YWxpZCBhbmQgd2lsbCBjYXVzZSBhbiBleGNlcHRpb24gdG8gYmUgcmFpc2VkLgoKICBTdGF0ZXMgYXJlIGhpZXJhcmNoaWNhbCBhbmQgZXZlcnkgc3RhdGUgaXMgYSBzdWJzdGF0ZSBvZiB0aGUKICBgUm9vdFN0YXRlYC4gRm9yIGV4YW1wbGUsIGEgcmVjb3JkIGNhbiBiZSBpbiB0aGUKICBgcm9vdC5kZWxldGVkLnVuY29tbWl0dGVkYCBzdGF0ZSwgdGhlbiB0cmFuc2l0aW9uIGludG8gdGhlCiAgYHJvb3QuZGVsZXRlZC5pbkZsaWdodGAgc3RhdGUuIElmIGEgY2hpbGQgc3RhdGUgZG9lcyBub3QgaW1wbGVtZW50CiAgYW4gZXZlbnQgaGFuZGxlciwgdGhlIHN0YXRlIG1hbmFnZXIgd2lsbCBhdHRlbXB0IHRvIGludm9rZSB0aGUgZXZlbnQKICBvbiBhbGwgcGFyZW50IHN0YXRlcyB1bnRpbCB0aGUgcm9vdCBzdGF0ZSBpcyByZWFjaGVkLiBUaGUgc3RhdGUKICBoaWVyYXJjaHkgb2YgYSByZWNvcmQgaXMgZGVzY3JpYmVkIGluIHRlcm1zIG9mIGEgcGF0aCBzdHJpbmcuIFlvdQogIGNhbiBkZXRlcm1pbmUgYSByZWNvcmQncyBjdXJyZW50IHN0YXRlIGJ5IGdldHRpbmcgdGhlIHN0YXRlJ3MKICBgc3RhdGVOYW1lYCBwcm9wZXJ0eToKCiAgYGBgamF2YXNjcmlwdAogIHJlY29yZC5nZXQoJ2N1cnJlbnRTdGF0ZS5zdGF0ZU5hbWUnKTsKICAvLz0+ICJyb290LmNyZWF0ZWQudW5jb21taXR0ZWQiCiAgIGBgYAoKICBUaGUgaGllcmFyY2h5IG9mIHZhbGlkIHN0YXRlcyB0aGF0IHNoaXAgd2l0aCBlbWJlciBkYXRhIGxvb2tzIGxpa2UKICB0aGlzOgoKICBgYGB0ZXh0CiAgKiByb290CiAgICAqIGRlbGV0ZWQKICAgICAgKiBzYXZlZAogICAgICAqIHVuY29tbWl0dGVkCiAgICAgICogaW5GbGlnaHQKICAgICogZW1wdHkKICAgICogbG9hZGVkCiAgICAgICogY3JlYXRlZAogICAgICAgICogdW5jb21taXR0ZWQKICAgICAgICAqIGluRmxpZ2h0CiAgICAgICogc2F2ZWQKICAgICAgKiB1cGRhdGVkCiAgICAgICAgKiB1bmNvbW1pdHRlZAogICAgICAgICogaW5GbGlnaHQKICAgICogbG9hZGluZwogIGBgYAoKICBUaGUgYERTLk1vZGVsYCBzdGF0ZXMgYXJlIHRoZW1zZWx2ZXMgc3RhdGVsZXNzLiBXaGF0IHdlIG1lYW4gaXMKICB0aGF0LCB0aGUgaGllcmFyY2hpY2FsIHN0YXRlcyB0aGF0IGVhY2ggb2YgKnRob3NlKiBwb2ludHMgdG8gaXMgYQogIHNoYXJlZCBkYXRhIHN0cnVjdHVyZS4gRm9yIHBlcmZvcm1hbmNlIHJlYXNvbnMsIGluc3RlYWQgb2YgZWFjaAogIHJlY29yZCBnZXR0aW5nIGl0cyBvd24gY29weSBvZiB0aGUgaGllcmFyY2h5IG9mIHN0YXRlcywgZWFjaCByZWNvcmQKICBwb2ludHMgdG8gdGhpcyBnbG9iYWwsIGltbXV0YWJsZSBzaGFyZWQgaW5zdGFuY2UuIEhvdyBkb2VzIGEgc3RhdGUKICBrbm93IHdoaWNoIHJlY29yZCBpdCBzaG91bGQgYmUgYWN0aW5nIG9uPyBXZSBwYXNzIHRoZSByZWNvcmQKICBpbnN0YW5jZSBpbnRvIHRoZSBzdGF0ZSdzIGV2ZW50IGhhbmRsZXJzIGFzIHRoZSBmaXJzdCBhcmd1bWVudC4KCiAgVGhlIHJlY29yZCBwYXNzZWQgYXMgdGhlIGZpcnN0IHBhcmFtZXRlciBpcyB3aGVyZSB5b3Ugc2hvdWxkIHN0YXNoCiAgc3RhdGUgYWJvdXQgdGhlIHJlY29yZCBpZiBuZWVkZWQ7IHlvdSBzaG91bGQgbmV2ZXIgc3RvcmUgZGF0YSBvbiB0aGUgc3RhdGUKICBvYmplY3QgaXRzZWxmLgoKICAjIyMgRXZlbnRzIGFuZCBGbGFncwoKICBBIHN0YXRlIG1heSBpbXBsZW1lbnQgemVybyBvciBtb3JlIGV2ZW50cyBhbmQgZmxhZ3MuCgogICMjIyMgRXZlbnRzCgogIEV2ZW50cyBhcmUgbmFtZWQgZnVuY3Rpb25zIHRoYXQgYXJlIGludm9rZWQgd2hlbiBzZW50IHRvIGEgcmVjb3JkLiBUaGUKICByZWNvcmQgd2lsbCBmaXJzdCBsb29rIGZvciBhIG1ldGhvZCB3aXRoIHRoZSBnaXZlbiBuYW1lIG9uIHRoZQogIGN1cnJlbnQgc3RhdGUuIElmIG5vIG1ldGhvZCBpcyBmb3VuZCwgaXQgd2lsbCBzZWFyY2ggdGhlIGN1cnJlbnQKICBzdGF0ZSdzIHBhcmVudCwgYW5kIHRoZW4gaXRzIGdyYW5kcGFyZW50LCBhbmQgc28gb24gdW50aWwgcmVhY2hpbmcKICB0aGUgdG9wIG9mIHRoZSBoaWVyYXJjaHkuIElmIHRoZSByb290IGlzIHJlYWNoZWQgd2l0aG91dCBhbiBldmVudAogIGhhbmRsZXIgYmVpbmcgZm91bmQsIGFuIGV4Y2VwdGlvbiB3aWxsIGJlIHJhaXNlZC4gVGhpcyBjYW4gYmUgdmVyeQogIGhlbHBmdWwgd2hlbiBkZWJ1Z2dpbmcgbmV3IGZlYXR1cmVzLgoKICBIZXJlJ3MgYW4gZXhhbXBsZSBpbXBsZW1lbnRhdGlvbiBvZiBhIHN0YXRlIHdpdGggYSBgbXlFdmVudGAgZXZlbnQgaGFuZGxlcjoKCiAgYGBgamF2YXNjcmlwdAogIGFTdGF0ZTogRFMuU3RhdGUuY3JlYXRlKHsKICAgIG15RXZlbnQ6IGZ1bmN0aW9uKG1hbmFnZXIsIHBhcmFtKSB7CiAgICAgIGNvbnNvbGUubG9nKCJSZWNlaXZlZCBteUV2ZW50IHdpdGgiLCBwYXJhbSk7CiAgICB9CiAgfSkKICBgYGAKCiAgVG8gdHJpZ2dlciB0aGlzIGV2ZW50OgoKICBgYGBqYXZhc2NyaXB0CiAgcmVjb3JkLnNlbmQoJ215RXZlbnQnLCAnZm9vJyk7CiAgLy89PiAiUmVjZWl2ZWQgbXlFdmVudCB3aXRoIGZvbyIKICBgYGAKCiAgTm90ZSB0aGF0IGFuIG9wdGlvbmFsIHBhcmFtZXRlciBjYW4gYmUgc2VudCB0byBhIHJlY29yZCdzIGBzZW5kKClgIG1ldGhvZCwKICB3aGljaCB3aWxsIGJlIHBhc3NlZCBhcyB0aGUgc2Vjb25kIHBhcmFtZXRlciB0byB0aGUgZXZlbnQgaGFuZGxlci4KCiAgRXZlbnRzIHNob3VsZCB0cmFuc2l0aW9uIHRvIGEgZGlmZmVyZW50IHN0YXRlIGlmIGFwcHJvcHJpYXRlLiBUaGlzIGNhbiBiZQogIGRvbmUgYnkgY2FsbGluZyB0aGUgcmVjb3JkJ3MgYHRyYW5zaXRpb25UbygpYCBtZXRob2Qgd2l0aCBhIHBhdGggdG8gdGhlCiAgZGVzaXJlZCBzdGF0ZS4gVGhlIHN0YXRlIG1hbmFnZXIgd2lsbCBhdHRlbXB0IHRvIHJlc29sdmUgdGhlIHN0YXRlIHBhdGgKICByZWxhdGl2ZSB0byB0aGUgY3VycmVudCBzdGF0ZS4gSWYgbm8gc3RhdGUgaXMgZm91bmQgYXQgdGhhdCBwYXRoLCBpdCB3aWxsCiAgYXR0ZW1wdCB0byByZXNvbHZlIGl0IHJlbGF0aXZlIHRvIHRoZSBjdXJyZW50IHN0YXRlJ3MgcGFyZW50LCBhbmQgdGhlbiBpdHMKICBwYXJlbnQsIGFuZCBzbyBvbiB1bnRpbCB0aGUgcm9vdCBpcyByZWFjaGVkLiBGb3IgZXhhbXBsZSwgaW1hZ2luZSBhIGhpZXJhcmNoeQogIGxpa2UgdGhpczoKCiAgICAgICogY3JlYXRlZAogICAgICAgICogdW5jb21taXR0ZWQgPC0tIGN1cnJlbnRTdGF0ZQogICAgICAgICogaW5GbGlnaHQKICAgICAgKiB1cGRhdGVkCiAgICAgICAgKiBpbkZsaWdodAoKICBJZiB3ZSBhcmUgY3VycmVudGx5IGluIHRoZSBgdW5jb21taXR0ZWRgIHN0YXRlLCBjYWxsaW5nCiAgYHRyYW5zaXRpb25UbygnaW5GbGlnaHQnKWAgd291bGQgdHJhbnNpdGlvbiB0byB0aGUgYGNyZWF0ZWQuaW5GbGlnaHRgIHN0YXRlLAogIHdoaWxlIGNhbGxpbmcgYHRyYW5zaXRpb25UbygndXBkYXRlZC5pbkZsaWdodCcpYCB3b3VsZCB0cmFuc2l0aW9uIHRvCiAgdGhlIGB1cGRhdGVkLmluRmxpZ2h0YCBzdGF0ZS4KCiAgUmVtZW1iZXIgdGhhdCAqb25seSBldmVudHMqIHNob3VsZCBldmVyIGNhdXNlIGEgc3RhdGUgdHJhbnNpdGlvbi4gWW91IHNob3VsZAogIG5ldmVyIGNhbGwgYHRyYW5zaXRpb25UbygpYCBmcm9tIG91dHNpZGUgYSBzdGF0ZSdzIGV2ZW50IGhhbmRsZXIuIElmIHlvdSBhcmUKICB0ZW1wdGVkIHRvIGRvIHNvLCBjcmVhdGUgYSBuZXcgZXZlbnQgYW5kIHNlbmQgdGhhdCB0byB0aGUgc3RhdGUgbWFuYWdlci4KCiAgIyMjIyBGbGFncwoKICBGbGFncyBhcmUgQm9vbGVhbiB2YWx1ZXMgdGhhdCBjYW4gYmUgdXNlZCB0byBpbnRyb3NwZWN0IGEgcmVjb3JkJ3MgY3VycmVudAogIHN0YXRlIGluIGEgbW9yZSB1c2VyLWZyaWVuZGx5IHdheSB0aGFuIGV4YW1pbmluZyBpdHMgc3RhdGUgcGF0aC4gRm9yIGV4YW1wbGUsCiAgaW5zdGVhZCBvZiBkb2luZyB0aGlzOgoKICBgYGBqYXZhc2NyaXB0CiAgdmFyIHN0YXRlUGF0aCA9IHJlY29yZC5nZXQoJ3N0YXRlTWFuYWdlci5jdXJyZW50UGF0aCcpOwogIGlmIChzdGF0ZVBhdGggPT09ICdjcmVhdGVkLmluRmxpZ2h0JykgewogICAgZG9Tb21ldGhpbmcoKTsKICB9CiAgYGBgCgogIFlvdSBjYW4gc2F5OgoKICBgYGBqYXZhc2NyaXB0CiAgaWYgKHJlY29yZC5nZXQoJ2lzTmV3JykgJiYgcmVjb3JkLmdldCgnaXNTYXZpbmcnKSkgewogICAgZG9Tb21ldGhpbmcoKTsKICB9CiAgYGBgCgogIElmIHlvdXIgc3RhdGUgZG9lcyBub3Qgc2V0IGEgdmFsdWUgZm9yIGEgZ2l2ZW4gZmxhZywgdGhlIHZhbHVlIHdpbGwKICBiZSBpbmhlcml0ZWQgZnJvbSBpdHMgcGFyZW50IChvciB0aGUgZmlyc3QgcGxhY2UgaW4gdGhlIHN0YXRlIGhpZXJhcmNoeQogIHdoZXJlIGl0IGlzIGRlZmluZWQpLgoKICBUaGUgY3VycmVudCBzZXQgb2YgZmxhZ3MgYXJlIGRlZmluZWQgYmVsb3cuIElmIHlvdSB3YW50IHRvIGFkZCBhIG5ldyBmbGFnLAogIGluIGFkZGl0aW9uIHRvIHRoZSBhcmVhIGJlbG93LCB5b3Ugd2lsbCBhbHNvIG5lZWQgdG8gZGVjbGFyZSBpdCBpbiB0aGUKICBgRFMuTW9kZWxgIGNsYXNzLgoKCiAgICogW2lzRW1wdHldKERTLk1vZGVsLmh0bWwjcHJvcGVydHlfaXNFbXB0eSkKICAgKiBbaXNMb2FkaW5nXShEUy5Nb2RlbC5odG1sI3Byb3BlcnR5X2lzTG9hZGluZykKICAgKiBbaXNMb2FkZWRdKERTLk1vZGVsLmh0bWwjcHJvcGVydHlfaXNMb2FkZWQpCiAgICogW2lzRGlydHldKERTLk1vZGVsLmh0bWwjcHJvcGVydHlfaXNEaXJ0eSkKICAgKiBbaXNTYXZpbmddKERTLk1vZGVsLmh0bWwjcHJvcGVydHlfaXNTYXZpbmcpCiAgICogW2lzRGVsZXRlZF0oRFMuTW9kZWwuaHRtbCNwcm9wZXJ0eV9pc0RlbGV0ZWQpCiAgICogW2lzTmV3XShEUy5Nb2RlbC5odG1sI3Byb3BlcnR5X2lzTmV3KQogICAqIFtpc1ZhbGlkXShEUy5Nb2RlbC5odG1sI3Byb3BlcnR5X2lzVmFsaWQpCgogIEBuYW1lc3BhY2UgRFMKICBAY2xhc3MgUm9vdFN0YXRlCiovCgp2YXIgaGFzRGVmaW5lZFByb3BlcnRpZXMgPSBmdW5jdGlvbihvYmplY3QpIHsKICAvLyBJZ25vcmUgaW50ZXJuYWwgcHJvcGVydHkgZGVmaW5lZCBieSBzaW11bGF0ZWQgYEVtYmVyLmNyZWF0ZWAuCiAgdmFyIG5hbWVzID0gRW1iZXIua2V5cyhvYmplY3QpOwogIHZhciBpLCBsLCBuYW1lOwogIGZvciAoaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CiAgICBuYW1lID0gbmFtZXNbaV07CiAgICBpZiAob2JqZWN0Lmhhc093blByb3BlcnR5KG5hbWUpICYmIG9iamVjdFtuYW1lXSkgeyByZXR1cm4gdHJ1ZTsgfQogIH0KCiAgcmV0dXJuIGZhbHNlOwp9OwoKdmFyIGRpZFNldFByb3BlcnR5ID0gZnVuY3Rpb24ocmVjb3JkLCBjb250ZXh0KSB7CiAgaWYgKGNvbnRleHQudmFsdWUgPT09IGNvbnRleHQub3JpZ2luYWxWYWx1ZSkgewogICAgZGVsZXRlIHJlY29yZC5fYXR0cmlidXRlc1tjb250ZXh0Lm5hbWVdOwogICAgcmVjb3JkLnNlbmQoJ3Byb3BlcnR5V2FzUmVzZXQnLCBjb250ZXh0Lm5hbWUpOwogIH0gZWxzZSBpZiAoY29udGV4dC52YWx1ZSAhPT0gY29udGV4dC5vbGRWYWx1ZSkgewogICAgcmVjb3JkLnNlbmQoJ2JlY29tZURpcnR5Jyk7CiAgfQoKICByZWNvcmQudXBkYXRlUmVjb3JkQXJyYXlzTGF0ZXIoKTsKfTsKCi8vIEltcGxlbWVudGF0aW9uIG5vdGVzOgovLwovLyBFYWNoIHN0YXRlIGhhcyBhIGJvb2xlYW4gdmFsdWUgZm9yIGFsbCBvZiB0aGUgZm9sbG93aW5nIGZsYWdzOgovLwovLyAqIGlzTG9hZGVkOiBUaGUgcmVjb3JkIGhhcyBhIHBvcHVsYXRlZCBgZGF0YWAgcHJvcGVydHkuIFdoZW4gYQovLyAgIHJlY29yZCBpcyBsb2FkZWQgdmlhIGBzdG9yZS5maW5kYCwgYGlzTG9hZGVkYCBpcyBmYWxzZQovLyAgIHVudGlsIHRoZSBhZGFwdGVyIHNldHMgaXQuIFdoZW4gYSByZWNvcmQgaXMgY3JlYXRlZCBsb2NhbGx5LAovLyAgIGl0cyBgaXNMb2FkZWRgIHByb3BlcnR5IGlzIGFsd2F5cyB0cnVlLgovLyAqIGlzRGlydHk6IFRoZSByZWNvcmQgaGFzIGxvY2FsIGNoYW5nZXMgdGhhdCBoYXZlIG5vdCB5ZXQgYmVlbgovLyAgIHNhdmVkIGJ5IHRoZSBhZGFwdGVyLiBUaGlzIGluY2x1ZGVzIHJlY29yZHMgdGhhdCBoYXZlIGJlZW4KLy8gICBjcmVhdGVkIChidXQgbm90IHlldCBzYXZlZCkgb3IgZGVsZXRlZC4KLy8gKiBpc1NhdmluZzogVGhlIHJlY29yZCBoYXMgYmVlbiBjb21taXR0ZWQsIGJ1dAovLyAgIHRoZSBhZGFwdGVyIGhhcyBub3QgeWV0IGFja25vd2xlZGdlZCB0aGF0IHRoZSBjaGFuZ2VzIGhhdmUKLy8gICBiZWVuIHBlcnNpc3RlZCB0byB0aGUgYmFja2VuZC4KLy8gKiBpc0RlbGV0ZWQ6IFRoZSByZWNvcmQgd2FzIG1hcmtlZCBmb3IgZGVsZXRpb24uIFdoZW4gYGlzRGVsZXRlZGAKLy8gICBpcyB0cnVlIGFuZCBgaXNEaXJ0eWAgaXMgdHJ1ZSwgdGhlIHJlY29yZCBpcyBkZWxldGVkIGxvY2FsbHkKLy8gICBidXQgdGhlIGRlbGV0aW9uIHdhcyBub3QgeWV0IHBlcnNpc3RlZC4gV2hlbiBgaXNTYXZpbmdgIGlzCi8vICAgdHJ1ZSwgdGhlIGNoYW5nZSBpcyBpbi1mbGlnaHQuIFdoZW4gYm90aCBgaXNEaXJ0eWAgYW5kCi8vICAgYGlzU2F2aW5nYCBhcmUgZmFsc2UsIHRoZSBjaGFuZ2UgaGFzIHBlcnNpc3RlZC4KLy8gKiBpc0Vycm9yOiBUaGUgYWRhcHRlciByZXBvcnRlZCB0aGF0IGl0IHdhcyB1bmFibGUgdG8gc2F2ZQovLyAgIGxvY2FsIGNoYW5nZXMgdG8gdGhlIGJhY2tlbmQuIFRoaXMgbWF5IGFsc28gcmVzdWx0IGluIHRoZQovLyAgIHJlY29yZCBoYXZpbmcgaXRzIGBpc1ZhbGlkYCBwcm9wZXJ0eSBiZWNvbWUgZmFsc2UgaWYgdGhlCi8vICAgYWRhcHRlciByZXBvcnRlZCB0aGF0IHNlcnZlci1zaWRlIHZhbGlkYXRpb25zIGZhaWxlZC4KLy8gKiBpc05ldzogVGhlIHJlY29yZCB3YXMgY3JlYXRlZCBvbiB0aGUgY2xpZW50IGFuZCB0aGUgYWRhcHRlcgovLyAgIGRpZCBub3QgeWV0IHJlcG9ydCB0aGF0IGl0IHdhcyBzdWNjZXNzZnVsbHkgc2F2ZWQuCi8vICogaXNWYWxpZDogTm8gY2xpZW50LXNpZGUgdmFsaWRhdGlvbnMgaGF2ZSBmYWlsZWQgYW5kIHRoZQovLyAgIGFkYXB0ZXIgZGlkIG5vdCByZXBvcnQgYW55IHNlcnZlci1zaWRlIHZhbGlkYXRpb24gZmFpbHVyZXMuCgovLyBUaGUgZGlydHkgc3RhdGUgaXMgYSBhYnN0cmFjdCBzdGF0ZSB3aG9zZSBmdW5jdGlvbmFsaXR5IGlzCi8vIHNoYXJlZCBiZXR3ZWVuIHRoZSBgY3JlYXRlZGAgYW5kIGB1cGRhdGVkYCBzdGF0ZXMuCi8vCi8vIFRoZSBkZWxldGVkIHN0YXRlIHNoYXJlcyB0aGUgYGlzRGlydHlgIGZsYWcgd2l0aCB0aGUKLy8gc3ViY2xhc3NlcyBvZiBgRGlydHlTdGF0ZWAsIGJ1dCB3aXRoIGEgdmVyeSBkaWZmZXJlbnQKLy8gaW1wbGVtZW50YXRpb24uCi8vCi8vIERpcnR5IHN0YXRlcyBoYXZlIHRocmVlIGNoaWxkIHN0YXRlczoKLy8KLy8gYHVuY29tbWl0dGVkYDogdGhlIHN0b3JlIGhhcyBub3QgeWV0IGhhbmRlZCBvZmYgdGhlIHJlY29yZAovLyAgIHRvIGJlIHNhdmVkLgovLyBgaW5GbGlnaHRgOiB0aGUgc3RvcmUgaGFzIGhhbmRlZCBvZmYgdGhlIHJlY29yZCB0byBiZSBzYXZlZCwKLy8gICBidXQgdGhlIGFkYXB0ZXIgaGFzIG5vdCB5ZXQgYWNrbm93bGVkZ2VkIHN1Y2Nlc3MuCi8vIGBpbnZhbGlkYDogdGhlIHJlY29yZCBoYXMgaW52YWxpZCBpbmZvcm1hdGlvbiBhbmQgY2Fubm90IGJlCi8vICAgc2VuZCB0byB0aGUgYWRhcHRlciB5ZXQuCnZhciBEaXJ0eVN0YXRlID0gewogIGluaXRpYWxTdGF0ZTogJ3VuY29tbWl0dGVkJywKCiAgLy8gRkxBR1MKICBpc0RpcnR5OiB0cnVlLAoKICAvLyBTVUJTVEFURVMKCiAgLy8gV2hlbiBhIHJlY29yZCBmaXJzdCBiZWNvbWVzIGRpcnR5LCBpdCBpcyBgdW5jb21taXR0ZWRgLgogIC8vIFRoaXMgbWVhbnMgdGhhdCB0aGVyZSBhcmUgbG9jYWwgcGVuZGluZyBjaGFuZ2VzLCBidXQgdGhleQogIC8vIGhhdmUgbm90IHlldCBiZWd1biB0byBiZSBzYXZlZCwgYW5kIGFyZSBub3QgaW52YWxpZC4KICB1bmNvbW1pdHRlZDogewogICAgLy8gRVZFTlRTCiAgICBkaWRTZXRQcm9wZXJ0eTogZGlkU2V0UHJvcGVydHksCgogICAgcHJvcGVydHlXYXNSZXNldDogZnVuY3Rpb24ocmVjb3JkLCBuYW1lKSB7CiAgICAgIHZhciBzdGlsbERpcnR5ID0gZmFsc2U7CgogICAgICBmb3IgKHZhciBwcm9wIGluIHJlY29yZC5fYXR0cmlidXRlcykgewogICAgICAgIHN0aWxsRGlydHkgPSB0cnVlOwogICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICBpZiAoIXN0aWxsRGlydHkpIHsgcmVjb3JkLnNlbmQoJ3JvbGxlZEJhY2snKTsgfQogICAgfSwKCiAgICBwdXNoZWREYXRhOiBFbWJlci5LLAoKICAgIGJlY29tZURpcnR5OiBFbWJlci5LLAoKICAgIHdpbGxDb21taXQ6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgICByZWNvcmQudHJhbnNpdGlvblRvKCdpbkZsaWdodCcpOwogICAgfSwKCiAgICByZWxvYWRSZWNvcmQ6IGZ1bmN0aW9uKHJlY29yZCwgcmVzb2x2ZSkgewogICAgICByZXNvbHZlKGdldChyZWNvcmQsICdzdG9yZScpLnJlbG9hZFJlY29yZChyZWNvcmQpKTsKICAgIH0sCgogICAgcm9sbGVkQmFjazogZnVuY3Rpb24ocmVjb3JkKSB7CiAgICAgIHJlY29yZC50cmFuc2l0aW9uVG8oJ2xvYWRlZC5zYXZlZCcpOwogICAgfSwKCiAgICBiZWNhbWVJbnZhbGlkOiBmdW5jdGlvbihyZWNvcmQpIHsKICAgICAgcmVjb3JkLnRyYW5zaXRpb25UbygnaW52YWxpZCcpOwogICAgfSwKCiAgICByb2xsYmFjazogZnVuY3Rpb24ocmVjb3JkKSB7CiAgICAgIHJlY29yZC5yb2xsYmFjaygpOwogICAgfQogIH0sCgogIC8vIE9uY2UgYSByZWNvcmQgaGFzIGJlZW4gaGFuZGVkIG9mZiB0byB0aGUgYWRhcHRlciB0byBiZQogIC8vIHNhdmVkLCBpdCBpcyBpbiB0aGUgJ2luIGZsaWdodCcgc3RhdGUuIENoYW5nZXMgdG8gdGhlCiAgLy8gcmVjb3JkIGNhbm5vdCBiZSBtYWRlIGR1cmluZyB0aGlzIHdpbmRvdy4KICBpbkZsaWdodDogewogICAgLy8gRkxBR1MKICAgIGlzU2F2aW5nOiB0cnVlLAoKICAgIC8vIEVWRU5UUwogICAgZGlkU2V0UHJvcGVydHk6IGRpZFNldFByb3BlcnR5LAogICAgYmVjb21lRGlydHk6IEVtYmVyLkssCiAgICBwdXNoZWREYXRhOiBFbWJlci5LLAoKICAgIC8vIFRPRE86IE1vcmUgcm9idXN0IHNlbWFudGljcyBhcm91bmQgc2F2ZS13aGlsZS1pbi1mbGlnaHQKICAgIHdpbGxDb21taXQ6IEVtYmVyLkssCgogICAgZGlkQ29tbWl0OiBmdW5jdGlvbihyZWNvcmQpIHsKICAgICAgdmFyIGRpcnR5VHlwZSA9IGdldCh0aGlzLCAnZGlydHlUeXBlJyk7CgogICAgICByZWNvcmQudHJhbnNpdGlvblRvKCdzYXZlZCcpOwogICAgICByZWNvcmQuc2VuZCgnaW52b2tlTGlmZWN5Y2xlQ2FsbGJhY2tzJywgZGlydHlUeXBlKTsKICAgIH0sCgogICAgYmVjYW1lSW52YWxpZDogZnVuY3Rpb24ocmVjb3JkKSB7CiAgICAgIHJlY29yZC50cmFuc2l0aW9uVG8oJ2ludmFsaWQnKTsKICAgICAgcmVjb3JkLnNlbmQoJ2ludm9rZUxpZmVjeWNsZUNhbGxiYWNrcycpOwogICAgfSwKCiAgICBiZWNhbWVFcnJvcjogZnVuY3Rpb24ocmVjb3JkKSB7CiAgICAgIHJlY29yZC50cmFuc2l0aW9uVG8oJ3VuY29tbWl0dGVkJyk7CiAgICAgIHJlY29yZC50cmlnZ2VyTGF0ZXIoJ2JlY2FtZUVycm9yJywgcmVjb3JkKTsKICAgIH0KICB9LAoKICAvLyBBIHJlY29yZCBpcyBpbiB0aGUgYGludmFsaWRgIHN0YXRlIHdoZW4gaXRzIGNsaWVudC1zaWRlCiAgLy8gaW52YWxpZGF0aW9ucyBoYXZlIGZhaWxlZCwgb3IgaWYgdGhlIGFkYXB0ZXIgaGFzIGluZGljYXRlZAogIC8vIHRoZSB0aGUgcmVjb3JkIGZhaWxlZCBzZXJ2ZXItc2lkZSBpbnZhbGlkYXRpb25zLgogIGludmFsaWQ6IHsKICAgIC8vIEZMQUdTCiAgICBpc1ZhbGlkOiBmYWxzZSwKCiAgICAvLyBFVkVOVFMKICAgIGRlbGV0ZVJlY29yZDogZnVuY3Rpb24ocmVjb3JkKSB7CiAgICAgIHJlY29yZC50cmFuc2l0aW9uVG8oJ2RlbGV0ZWQudW5jb21taXR0ZWQnKTsKICAgICAgcmVjb3JkLmNsZWFyUmVsYXRpb25zaGlwcygpOwogICAgfSwKCiAgICBkaWRTZXRQcm9wZXJ0eTogZnVuY3Rpb24ocmVjb3JkLCBjb250ZXh0KSB7CiAgICAgIGdldChyZWNvcmQsICdlcnJvcnMnKS5yZW1vdmUoY29udGV4dC5uYW1lKTsKCiAgICAgIGRpZFNldFByb3BlcnR5KHJlY29yZCwgY29udGV4dCk7CiAgICB9LAoKICAgIGJlY29tZURpcnR5OiBFbWJlci5LLAoKICAgIHJvbGxlZEJhY2s6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgICBnZXQocmVjb3JkLCAnZXJyb3JzJykuY2xlYXIoKTsKICAgIH0sCgogICAgYmVjYW1lVmFsaWQ6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgICByZWNvcmQudHJhbnNpdGlvblRvKCd1bmNvbW1pdHRlZCcpOwogICAgfSwKCiAgICBpbnZva2VMaWZlY3ljbGVDYWxsYmFja3M6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgICByZWNvcmQudHJpZ2dlckxhdGVyKCdiZWNhbWVJbnZhbGlkJywgcmVjb3JkKTsKICAgIH0KICB9Cn07CgovLyBUaGUgY3JlYXRlZCBhbmQgdXBkYXRlZCBzdGF0ZXMgYXJlIGNyZWF0ZWQgb3V0c2lkZSB0aGUgc3RhdGUKLy8gY2hhcnQgc28gd2UgY2FuIHJlb3BlbiB0aGVpciBzdWJzdGF0ZXMgYW5kIGFkZCBtaXhpbnMgYXMKLy8gbmVjZXNzYXJ5LgoKZnVuY3Rpb24gZGVlcENsb25lKG9iamVjdCkgewogIHZhciBjbG9uZSA9IHt9LCB2YWx1ZTsKCiAgZm9yICh2YXIgcHJvcCBpbiBvYmplY3QpIHsKICAgIHZhbHVlID0gb2JqZWN0W3Byb3BdOwogICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcpIHsKICAgICAgY2xvbmVbcHJvcF0gPSBkZWVwQ2xvbmUodmFsdWUpOwogICAgfSBlbHNlIHsKICAgICAgY2xvbmVbcHJvcF0gPSB2YWx1ZTsKICAgIH0KICB9CgogIHJldHVybiBjbG9uZTsKfQoKZnVuY3Rpb24gbWl4aW4ob3JpZ2luYWwsIGhhc2gpIHsKICBmb3IgKHZhciBwcm9wIGluIGhhc2gpIHsKICAgIG9yaWdpbmFsW3Byb3BdID0gaGFzaFtwcm9wXTsKICB9CgogIHJldHVybiBvcmlnaW5hbDsKfQoKZnVuY3Rpb24gZGlydHlTdGF0ZShvcHRpb25zKSB7CiAgdmFyIG5ld1N0YXRlID0gZGVlcENsb25lKERpcnR5U3RhdGUpOwogIHJldHVybiBtaXhpbihuZXdTdGF0ZSwgb3B0aW9ucyk7Cn0KCnZhciBjcmVhdGVkU3RhdGUgPSBkaXJ0eVN0YXRlKHsKICBkaXJ0eVR5cGU6ICdjcmVhdGVkJywKCiAgLy8gRkxBR1MKICBpc05ldzogdHJ1ZQp9KTsKCmNyZWF0ZWRTdGF0ZS51bmNvbW1pdHRlZC5yb2xsZWRCYWNrID0gZnVuY3Rpb24ocmVjb3JkKSB7CiAgcmVjb3JkLnRyYW5zaXRpb25UbygnZGVsZXRlZC5zYXZlZCcpOwp9OwoKdmFyIHVwZGF0ZWRTdGF0ZSA9IGRpcnR5U3RhdGUoewogIGRpcnR5VHlwZTogJ3VwZGF0ZWQnCn0pOwoKY3JlYXRlZFN0YXRlLnVuY29tbWl0dGVkLmRlbGV0ZVJlY29yZCA9IGZ1bmN0aW9uKHJlY29yZCkgewogIHJlY29yZC5jbGVhclJlbGF0aW9uc2hpcHMoKTsKICByZWNvcmQudHJhbnNpdGlvblRvKCdkZWxldGVkLnNhdmVkJyk7Cn07CgpjcmVhdGVkU3RhdGUudW5jb21taXR0ZWQucm9sbGJhY2sgPSBmdW5jdGlvbihyZWNvcmQpIHsKICBEaXJ0eVN0YXRlLnVuY29tbWl0dGVkLnJvbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgcmVjb3JkLnRyYW5zaXRpb25UbygnZGVsZXRlZC5zYXZlZCcpOwp9OwoKdXBkYXRlZFN0YXRlLnVuY29tbWl0dGVkLmRlbGV0ZVJlY29yZCA9IGZ1bmN0aW9uKHJlY29yZCkgewogIHJlY29yZC50cmFuc2l0aW9uVG8oJ2RlbGV0ZWQudW5jb21taXR0ZWQnKTsKICByZWNvcmQuY2xlYXJSZWxhdGlvbnNoaXBzKCk7Cn07Cgp2YXIgUm9vdFN0YXRlID0gewogIC8vIEZMQUdTCiAgaXNFbXB0eTogZmFsc2UsCiAgaXNMb2FkaW5nOiBmYWxzZSwKICBpc0xvYWRlZDogZmFsc2UsCiAgaXNEaXJ0eTogZmFsc2UsCiAgaXNTYXZpbmc6IGZhbHNlLAogIGlzRGVsZXRlZDogZmFsc2UsCiAgaXNOZXc6IGZhbHNlLAogIGlzVmFsaWQ6IHRydWUsCgogIC8vIERFRkFVTFQgRVZFTlRTCgogIC8vIFRyeWluZyB0byByb2xsIGJhY2sgaWYgeW91J3JlIG5vdCBpbiB0aGUgZGlydHkgc3RhdGUKICAvLyBkb2Vzbid0IGNoYW5nZSB5b3VyIHN0YXRlLiBGb3IgZXhhbXBsZSwgaWYgeW91J3JlIGluIHRoZQogIC8vIGluLWZsaWdodCBzdGF0ZSwgcm9sbGluZyBiYWNrIHRoZSByZWNvcmQgZG9lc24ndCBtb3ZlCiAgLy8geW91IG91dCBvZiB0aGUgaW4tZmxpZ2h0IHN0YXRlLgogIHJvbGxlZEJhY2s6IEVtYmVyLkssCgogIHByb3BlcnR5V2FzUmVzZXQ6IEVtYmVyLkssCgogIC8vIFNVQlNUQVRFUwoKICAvLyBBIHJlY29yZCBiZWdpbnMgaXRzIGxpZmVjeWNsZSBpbiB0aGUgYGVtcHR5YCBzdGF0ZS4KICAvLyBJZiBpdHMgZGF0YSB3aWxsIGNvbWUgZnJvbSB0aGUgYWRhcHRlciwgaXQgd2lsbAogIC8vIHRyYW5zaXRpb24gaW50byB0aGUgYGxvYWRpbmdgIHN0YXRlLiBPdGhlcndpc2UsIGlmCiAgLy8gdGhlIHJlY29yZCBpcyBiZWluZyBjcmVhdGVkIG9uIHRoZSBjbGllbnQsIGl0IHdpbGwKICAvLyB0cmFuc2l0aW9uIGludG8gdGhlIGBjcmVhdGVkYCBzdGF0ZS4KICBlbXB0eTogewogICAgaXNFbXB0eTogdHJ1ZSwKCiAgICAvLyBFVkVOVFMKICAgIGxvYWRpbmdEYXRhOiBmdW5jdGlvbihyZWNvcmQsIHByb21pc2UpIHsKICAgICAgcmVjb3JkLl9sb2FkaW5nUHJvbWlzZSA9IHByb21pc2U7CiAgICAgIHJlY29yZC50cmFuc2l0aW9uVG8oJ2xvYWRpbmcnKTsKICAgIH0sCgogICAgbG9hZGVkRGF0YTogZnVuY3Rpb24ocmVjb3JkKSB7CiAgICAgIHJlY29yZC50cmFuc2l0aW9uVG8oJ2xvYWRlZC5jcmVhdGVkLnVuY29tbWl0dGVkJyk7CgogICAgICByZWNvcmQuc3VzcGVuZFJlbGF0aW9uc2hpcE9ic2VydmVycyhmdW5jdGlvbigpIHsKICAgICAgICByZWNvcmQubm90aWZ5UHJvcGVydHlDaGFuZ2UoJ2RhdGEnKTsKICAgICAgfSk7CiAgICB9LAoKICAgIHB1c2hlZERhdGE6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgICByZWNvcmQudHJhbnNpdGlvblRvKCdsb2FkZWQuc2F2ZWQnKTsKICAgICAgcmVjb3JkLnRyaWdnZXJMYXRlcignZGlkTG9hZCcpOwogICAgfQogIH0sCgogIC8vIEEgcmVjb3JkIGVudGVycyB0aGlzIHN0YXRlIHdoZW4gdGhlIHN0b3JlIGFza2VzCiAgLy8gdGhlIGFkYXB0ZXIgZm9yIGl0cyBkYXRhLiBJdCByZW1haW5zIGluIHRoaXMgc3RhdGUKICAvLyB1bnRpbCB0aGUgYWRhcHRlciBwcm92aWRlcyB0aGUgcmVxdWVzdGVkIGRhdGEuCiAgLy8KICAvLyBVc3VhbGx5LCB0aGlzIHByb2Nlc3MgaXMgYXN5bmNocm9ub3VzLCB1c2luZyBhbgogIC8vIFhIUiB0byByZXRyaWV2ZSB0aGUgZGF0YS4KICBsb2FkaW5nOiB7CiAgICAvLyBGTEFHUwogICAgaXNMb2FkaW5nOiB0cnVlLAoKICAgIGV4aXQ6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgICByZWNvcmQuX2xvYWRpbmdQcm9taXNlID0gbnVsbDsKICAgIH0sCgogICAgLy8gRVZFTlRTCiAgICBwdXNoZWREYXRhOiBmdW5jdGlvbihyZWNvcmQpIHsKICAgICAgcmVjb3JkLnRyYW5zaXRpb25UbygnbG9hZGVkLnNhdmVkJyk7CiAgICAgIHJlY29yZC50cmlnZ2VyTGF0ZXIoJ2RpZExvYWQnKTsKICAgICAgc2V0KHJlY29yZCwgJ2lzRXJyb3InLCBmYWxzZSk7CiAgICB9LAoKICAgIGJlY2FtZUVycm9yOiBmdW5jdGlvbihyZWNvcmQpIHsKICAgICAgcmVjb3JkLnRyaWdnZXJMYXRlcignYmVjYW1lRXJyb3InLCByZWNvcmQpOwogICAgfSwKCiAgICBub3RGb3VuZDogZnVuY3Rpb24ocmVjb3JkKSB7CiAgICAgIHJlY29yZC50cmFuc2l0aW9uVG8oJ2VtcHR5Jyk7CiAgICB9CiAgfSwKCiAgLy8gQSByZWNvcmQgZW50ZXJzIHRoaXMgc3RhdGUgd2hlbiBpdHMgZGF0YSBpcyBwb3B1bGF0ZWQuCiAgLy8gTW9zdCBvZiBhIHJlY29yZCdzIGxpZmVjeWNsZSBpcyBzcGVudCBpbnNpZGUgc3Vic3RhdGVzCiAgLy8gb2YgdGhlIGBsb2FkZWRgIHN0YXRlLgogIGxvYWRlZDogewogICAgaW5pdGlhbFN0YXRlOiAnc2F2ZWQnLAoKICAgIC8vIEZMQUdTCiAgICBpc0xvYWRlZDogdHJ1ZSwKCiAgICAvLyBTVUJTVEFURVMKCiAgICAvLyBJZiB0aGVyZSBhcmUgbm8gbG9jYWwgY2hhbmdlcyB0byBhIHJlY29yZCwgaXQgcmVtYWlucwogICAgLy8gaW4gdGhlIGBzYXZlZGAgc3RhdGUuCiAgICBzYXZlZDogewogICAgICBzZXR1cDogZnVuY3Rpb24ocmVjb3JkKSB7CiAgICAgICAgdmFyIGF0dHJzID0gcmVjb3JkLl9hdHRyaWJ1dGVzLAogICAgICAgICAgICBpc0RpcnR5ID0gZmFsc2U7CgogICAgICAgIGZvciAodmFyIHByb3AgaW4gYXR0cnMpIHsKICAgICAgICAgIGlmIChhdHRycy5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgewogICAgICAgICAgICBpc0RpcnR5ID0gdHJ1ZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNEaXJ0eSkgewogICAgICAgICAgcmVjb3JkLmFkYXB0ZXJEaWREaXJ0eSgpOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8vIEVWRU5UUwogICAgICBkaWRTZXRQcm9wZXJ0eTogZGlkU2V0UHJvcGVydHksCgogICAgICBwdXNoZWREYXRhOiBFbWJlci5LLAoKICAgICAgYmVjb21lRGlydHk6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgICAgIHJlY29yZC50cmFuc2l0aW9uVG8oJ3VwZGF0ZWQudW5jb21taXR0ZWQnKTsKICAgICAgfSwKCiAgICAgIHdpbGxDb21taXQ6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgICAgIHJlY29yZC50cmFuc2l0aW9uVG8oJ3VwZGF0ZWQuaW5GbGlnaHQnKTsKICAgICAgfSwKCiAgICAgIHJlbG9hZFJlY29yZDogZnVuY3Rpb24ocmVjb3JkLCByZXNvbHZlKSB7CiAgICAgICAgcmVzb2x2ZShnZXQocmVjb3JkLCAnc3RvcmUnKS5yZWxvYWRSZWNvcmQocmVjb3JkKSk7CiAgICAgIH0sCgogICAgICBkZWxldGVSZWNvcmQ6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgICAgIHJlY29yZC50cmFuc2l0aW9uVG8oJ2RlbGV0ZWQudW5jb21taXR0ZWQnKTsKICAgICAgICByZWNvcmQuY2xlYXJSZWxhdGlvbnNoaXBzKCk7CiAgICAgIH0sCgogICAgICB1bmxvYWRSZWNvcmQ6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgICAgIC8vIGNsZWFyIHJlbGF0aW9uc2hpcHMgYmVmb3JlIG1vdmluZyB0byBkZWxldGVkIHN0YXRlCiAgICAgICAgLy8gb3RoZXJ3aXNlIGl0IGZhaWxzCiAgICAgICAgcmVjb3JkLmNsZWFyUmVsYXRpb25zaGlwcygpOwogICAgICAgIHJlY29yZC50cmFuc2l0aW9uVG8oJ2RlbGV0ZWQuc2F2ZWQnKTsKICAgICAgfSwKCiAgICAgIGRpZENvbW1pdDogZnVuY3Rpb24ocmVjb3JkKSB7CiAgICAgICAgcmVjb3JkLnNlbmQoJ2ludm9rZUxpZmVjeWNsZUNhbGxiYWNrcycsIGdldChyZWNvcmQsICdsYXN0RGlydHlUeXBlJykpOwogICAgICB9LAoKICAgICAgLy8gbG9hZGVkLnNhdmVkLm5vdEZvdW5kIHdvdWxkIGJlIHRyaWdnZXJlZCBieSBhIGZhaWxlZAogICAgICAvLyBgcmVsb2FkKClgIG9uIGFuIHVuY2hhbmdlZCByZWNvcmQKICAgICAgbm90Rm91bmQ6IEVtYmVyLksKCiAgICB9LAoKICAgIC8vIEEgcmVjb3JkIGlzIGluIHRoaXMgc3RhdGUgYWZ0ZXIgaXQgaGFzIGJlZW4gbG9jYWxseQogICAgLy8gY3JlYXRlZCBidXQgYmVmb3JlIHRoZSBhZGFwdGVyIGhhcyBpbmRpY2F0ZWQgdGhhdAogICAgLy8gaXQgaGFzIGJlZW4gc2F2ZWQuCiAgICBjcmVhdGVkOiBjcmVhdGVkU3RhdGUsCgogICAgLy8gQSByZWNvcmQgaXMgaW4gdGhpcyBzdGF0ZSBpZiBpdCBoYXMgYWxyZWFkeSBiZWVuCiAgICAvLyBzYXZlZCB0byB0aGUgc2VydmVyLCBidXQgdGhlcmUgYXJlIG5ldyBsb2NhbCBjaGFuZ2VzCiAgICAvLyB0aGF0IGhhdmUgbm90IHlldCBiZWVuIHNhdmVkLgogICAgdXBkYXRlZDogdXBkYXRlZFN0YXRlCiAgfSwKCiAgLy8gQSByZWNvcmQgaXMgaW4gdGhpcyBzdGF0ZSBpZiBpdCB3YXMgZGVsZXRlZCBmcm9tIHRoZSBzdG9yZS4KICBkZWxldGVkOiB7CiAgICBpbml0aWFsU3RhdGU6ICd1bmNvbW1pdHRlZCcsCiAgICBkaXJ0eVR5cGU6ICdkZWxldGVkJywKCiAgICAvLyBGTEFHUwogICAgaXNEZWxldGVkOiB0cnVlLAogICAgaXNMb2FkZWQ6IHRydWUsCiAgICBpc0RpcnR5OiB0cnVlLAoKICAgIC8vIFRSQU5TSVRJT05TCiAgICBzZXR1cDogZnVuY3Rpb24ocmVjb3JkKSB7CiAgICAgIHJlY29yZC51cGRhdGVSZWNvcmRBcnJheXMoKTsKICAgIH0sCgogICAgLy8gU1VCU1RBVEVTCgogICAgLy8gV2hlbiBhIHJlY29yZCBpcyBkZWxldGVkLCBpdCBlbnRlcnMgdGhlIGBzdGFydGAKICAgIC8vIHN0YXRlLiBJdCB3aWxsIGV4aXQgdGhpcyBzdGF0ZSB3aGVuIHRoZSByZWNvcmQKICAgIC8vIHN0YXJ0cyB0byBjb21taXQuCiAgICB1bmNvbW1pdHRlZDogewoKICAgICAgLy8gRVZFTlRTCgogICAgICB3aWxsQ29tbWl0OiBmdW5jdGlvbihyZWNvcmQpIHsKICAgICAgICByZWNvcmQudHJhbnNpdGlvblRvKCdpbkZsaWdodCcpOwogICAgICB9LAoKICAgICAgcm9sbGJhY2s6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgICAgIHJlY29yZC5yb2xsYmFjaygpOwogICAgICB9LAoKICAgICAgYmVjb21lRGlydHk6IEVtYmVyLkssCiAgICAgIGRlbGV0ZVJlY29yZDogRW1iZXIuSywKCiAgICAgIHJvbGxlZEJhY2s6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgICAgIHJlY29yZC50cmFuc2l0aW9uVG8oJ2xvYWRlZC5zYXZlZCcpOwogICAgICB9CiAgICB9LAoKICAgIC8vIEFmdGVyIGEgcmVjb3JkIHN0YXJ0cyBjb21taXR0aW5nLCBidXQKICAgIC8vIGJlZm9yZSB0aGUgYWRhcHRlciBpbmRpY2F0ZXMgdGhhdCB0aGUgZGVsZXRpb24KICAgIC8vIGhhcyBzYXZlZCB0byB0aGUgc2VydmVyLCBhIHJlY29yZCBpcyBpbiB0aGUKICAgIC8vIGBpbkZsaWdodGAgc3Vic3RhdGUgb2YgYGRlbGV0ZWRgLgogICAgaW5GbGlnaHQ6IHsKICAgICAgLy8gRkxBR1MKICAgICAgaXNTYXZpbmc6IHRydWUsCgogICAgICAvLyBFVkVOVFMKCiAgICAgIC8vIFRPRE86IE1vcmUgcm9idXN0IHNlbWFudGljcyBhcm91bmQgc2F2ZS13aGlsZS1pbi1mbGlnaHQKICAgICAgd2lsbENvbW1pdDogRW1iZXIuSywKICAgICAgZGlkQ29tbWl0OiBmdW5jdGlvbihyZWNvcmQpIHsKICAgICAgICByZWNvcmQudHJhbnNpdGlvblRvKCdzYXZlZCcpOwoKICAgICAgICByZWNvcmQuc2VuZCgnaW52b2tlTGlmZWN5Y2xlQ2FsbGJhY2tzJyk7CiAgICAgIH0sCgogICAgICBiZWNhbWVFcnJvcjogZnVuY3Rpb24ocmVjb3JkKSB7CiAgICAgICAgcmVjb3JkLnRyYW5zaXRpb25UbygndW5jb21taXR0ZWQnKTsKICAgICAgICByZWNvcmQudHJpZ2dlckxhdGVyKCdiZWNhbWVFcnJvcicsIHJlY29yZCk7CiAgICAgIH0KICAgIH0sCgogICAgLy8gT25jZSB0aGUgYWRhcHRlciBpbmRpY2F0ZXMgdGhhdCB0aGUgZGVsZXRpb24gaGFzCiAgICAvLyBiZWVuIHNhdmVkLCB0aGUgcmVjb3JkIGVudGVycyB0aGUgYHNhdmVkYCBzdWJzdGF0ZQogICAgLy8gb2YgYGRlbGV0ZWRgLgogICAgc2F2ZWQ6IHsKICAgICAgLy8gRkxBR1MKICAgICAgaXNEaXJ0eTogZmFsc2UsCgogICAgICBzZXR1cDogZnVuY3Rpb24ocmVjb3JkKSB7CiAgICAgICAgdmFyIHN0b3JlID0gZ2V0KHJlY29yZCwgJ3N0b3JlJyk7CiAgICAgICAgc3RvcmUuZGVtYXRlcmlhbGl6ZVJlY29yZChyZWNvcmQpOwogICAgICB9LAoKICAgICAgaW52b2tlTGlmZWN5Y2xlQ2FsbGJhY2tzOiBmdW5jdGlvbihyZWNvcmQpIHsKICAgICAgICByZWNvcmQudHJpZ2dlckxhdGVyKCdkaWREZWxldGUnLCByZWNvcmQpOwogICAgICAgIHJlY29yZC50cmlnZ2VyTGF0ZXIoJ2RpZENvbW1pdCcsIHJlY29yZCk7CiAgICAgIH0KICAgIH0KICB9LAoKICBpbnZva2VMaWZlY3ljbGVDYWxsYmFja3M6IGZ1bmN0aW9uKHJlY29yZCwgZGlydHlUeXBlKSB7CiAgICBpZiAoZGlydHlUeXBlID09PSAnY3JlYXRlZCcpIHsKICAgICAgcmVjb3JkLnRyaWdnZXJMYXRlcignZGlkQ3JlYXRlJywgcmVjb3JkKTsKICAgIH0gZWxzZSB7CiAgICAgIHJlY29yZC50cmlnZ2VyTGF0ZXIoJ2RpZFVwZGF0ZScsIHJlY29yZCk7CiAgICB9CgogICAgcmVjb3JkLnRyaWdnZXJMYXRlcignZGlkQ29tbWl0JywgcmVjb3JkKTsKICB9Cn07CgpmdW5jdGlvbiB3aXJlU3RhdGUob2JqZWN0LCBwYXJlbnQsIG5hbWUpIHsKICAvKmpzaGludCBwcm90bzp0cnVlKi8KICAvLyBUT0RPOiBVc2UgT2JqZWN0LmNyZWF0ZSBhbmQgY29weSBpbnN0ZWFkCiAgb2JqZWN0ID0gbWl4aW4ocGFyZW50ID8gRW1iZXIuY3JlYXRlKHBhcmVudCkgOiB7fSwgb2JqZWN0KTsKICBvYmplY3QucGFyZW50U3RhdGUgPSBwYXJlbnQ7CiAgb2JqZWN0LnN0YXRlTmFtZSA9IG5hbWU7CgogIGZvciAodmFyIHByb3AgaW4gb2JqZWN0KSB7CiAgICBpZiAoIW9iamVjdC5oYXNPd25Qcm9wZXJ0eShwcm9wKSB8fCBwcm9wID09PSAncGFyZW50U3RhdGUnIHx8IHByb3AgPT09ICdzdGF0ZU5hbWUnKSB7IGNvbnRpbnVlOyB9CiAgICBpZiAodHlwZW9mIG9iamVjdFtwcm9wXSA9PT0gJ29iamVjdCcpIHsKICAgICAgb2JqZWN0W3Byb3BdID0gd2lyZVN0YXRlKG9iamVjdFtwcm9wXSwgb2JqZWN0LCBuYW1lICsgIi4iICsgcHJvcCk7CiAgICB9CiAgfQoKICByZXR1cm4gb2JqZWN0Owp9CgpSb290U3RhdGUgPSB3aXJlU3RhdGUoUm9vdFN0YXRlLCBudWxsLCAicm9vdCIpOwoKRFMuUm9vdFN0YXRlID0gUm9vdFN0YXRlOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBpc0VtcHR5ID0gRW1iZXIuaXNFbXB0eTsKCi8qKgpAbW9kdWxlIGVtYmVyLWRhdGEKKi8KCi8qKgogIEhvbGRzIHZhbGlkYXRpb24gZXJyb3JzIGZvciBhIGdpdmVuIHJlY29yZCBvcmdhbml6ZWQgYnkgYXR0cmlidXRlIG5hbWVzLgoKICBAY2xhc3MgRXJyb3JzCiAgQG5hbWVzcGFjZSBEUwogIEBleHRlbmRzIEVtYmVyLk9iamVjdAogIEB1c2VzIEVtYmVyLkVudW1lcmFibGUKICBAdXNlcyBFbWJlci5FdmVudGVkCiAqLwpEUy5FcnJvcnMgPSBFbWJlci5PYmplY3QuZXh0ZW5kKEVtYmVyLkVudW1lcmFibGUsIEVtYmVyLkV2ZW50ZWQsIHsKICAvKioKICAgIFJlZ2lzdGVyIHdpdGggdGFyZ2V0IGhhbmRsZXIKCiAgICBAbWV0aG9kIHJlZ2lzdGVySGFuZGxlcnMKICAgIEBwYXJhbSB7T2JqZWN0fSB0YXJnZXQKICAgIEBwYXJhbSB7RnVuY3Rpb259IGJlY2FtZUludmFsaWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IGJlY2FtZVZhbGlkCiAgKi8KICByZWdpc3RlckhhbmRsZXJzOiBmdW5jdGlvbih0YXJnZXQsIGJlY2FtZUludmFsaWQsIGJlY2FtZVZhbGlkKSB7CiAgICB0aGlzLm9uKCdiZWNhbWVJbnZhbGlkJywgdGFyZ2V0LCBiZWNhbWVJbnZhbGlkKTsKICAgIHRoaXMub24oJ2JlY2FtZVZhbGlkJywgdGFyZ2V0LCBiZWNhbWVWYWxpZCk7CiAgfSwKCiAgLyoqCiAgICBAcHJvcGVydHkgZXJyb3JzQnlBdHRyaWJ1dGVOYW1lCiAgICBAdHlwZSB7RW1iZXIuTWFwV2l0aERlZmF1bHR9CiAgICBAcHJpdmF0ZQogICovCiAgZXJyb3JzQnlBdHRyaWJ1dGVOYW1lOiBFbWJlci5yZWR1Y2VDb21wdXRlZCgiY29udGVudCIsIHsKICAgIGluaXRpYWxWYWx1ZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBFbWJlci5NYXBXaXRoRGVmYXVsdC5jcmVhdGUoewogICAgICAgIGRlZmF1bHRWYWx1ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gRW1iZXIuQSgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAoKICAgIGFkZGVkSXRlbTogZnVuY3Rpb24oZXJyb3JzLCBlcnJvcikgewogICAgICBlcnJvcnMuZ2V0KGVycm9yLmF0dHJpYnV0ZSkucHVzaE9iamVjdChlcnJvcik7CgogICAgICByZXR1cm4gZXJyb3JzOwogICAgfSwKCiAgICByZW1vdmVkSXRlbTogZnVuY3Rpb24oZXJyb3JzLCBlcnJvcikgewogICAgICBlcnJvcnMuZ2V0KGVycm9yLmF0dHJpYnV0ZSkucmVtb3ZlT2JqZWN0KGVycm9yKTsKCiAgICAgIHJldHVybiBlcnJvcnM7CiAgICB9CiAgfSksCgogIC8qKgogICAgUmV0dXJucyBlcnJvcnMgZm9yIGEgZ2l2ZW4gYXR0cmlidXRlCgogICAgQG1ldGhvZCBlcnJvcnNGb3IKICAgIEBwYXJhbSB7U3RyaW5nfSBhdHRyaWJ1dGUKICAgIEByZXR1cm5zIHtBcnJheX0KICAqLwogIGVycm9yc0ZvcjogZnVuY3Rpb24oYXR0cmlidXRlKSB7CiAgICByZXR1cm4gZ2V0KHRoaXMsICdlcnJvcnNCeUF0dHJpYnV0ZU5hbWUnKS5nZXQoYXR0cmlidXRlKTsKICB9LAoKICAvKioKICAqLwogIG1lc3NhZ2VzOiBFbWJlci5jb21wdXRlZC5tYXBCeSgnY29udGVudCcsICdtZXNzYWdlJyksCgogIC8qKgogICAgQHByb3BlcnR5IGNvbnRlbnQKICAgIEB0eXBlIHtBcnJheX0KICAgIEBwcml2YXRlCiAgKi8KICBjb250ZW50OiBFbWJlci5jb21wdXRlZChmdW5jdGlvbigpIHsKICAgIHJldHVybiBFbWJlci5BKCk7CiAgfSksCgogIC8qKgogICAgQG1ldGhvZCB1bmtub3duUHJvcGVydHkKICAgIEBwcml2YXRlCiAgKi8KICB1bmtub3duUHJvcGVydHk6IGZ1bmN0aW9uKGF0dHJpYnV0ZSkgewogICAgdmFyIGVycm9ycyA9IHRoaXMuZXJyb3JzRm9yKGF0dHJpYnV0ZSk7CiAgICBpZiAoaXNFbXB0eShlcnJvcnMpKSB7IHJldHVybiBudWxsOyB9CiAgICByZXR1cm4gZXJyb3JzOwogIH0sCgogIC8qKgogICAgQG1ldGhvZCBuZXh0T2JqZWN0CiAgICBAcHJpdmF0ZQogICovCiAgbmV4dE9iamVjdDogZnVuY3Rpb24oaW5kZXgsIHByZXZpb3VzT2JqZWN0LCBjb250ZXh0KSB7CiAgICByZXR1cm4gZ2V0KHRoaXMsICdjb250ZW50Jykub2JqZWN0QXQoaW5kZXgpOwogIH0sCgogIC8qKgogICAgVG90YWwgbnVtYmVyIG9mIGVycm9ycy4KCiAgICBAcHJvcGVydHkgbGVuZ3RoCiAgICBAdHlwZSB7TnVtYmVyfQogICAgQHJlYWRPbmx5CiAgKi8KICBsZW5ndGg6IEVtYmVyLmNvbXB1dGVkLm9uZVdheSgnY29udGVudC5sZW5ndGgnKS5yZWFkT25seSgpLAoKICAvKioKICAgIEBwcm9wZXJ0eSBpc0VtcHR5CiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgIEByZWFkT25seQogICovCiAgaXNFbXB0eTogRW1iZXIuY29tcHV0ZWQubm90KCdsZW5ndGgnKS5yZWFkT25seSgpLAoKICAvKioKICAgIEFkZHMgZXJyb3IgbWVzc2FnZXMgdG8gYSBnaXZlbiBhdHRyaWJ1dGUgYW5kIHNlbmRzCiAgICBgYmVjYW1lSW52YWxpZGAgZXZlbnQgdG8gdGhlIHJlY29yZC4KCiAgICBAbWV0aG9kIGFkZAogICAgQHBhcmFtIHtTdHJpbmd9IGF0dHJpYnV0ZQogICAgQHBhcmFtIHtBcnJheXxTdHJpbmd9IG1lc3NhZ2VzCiAgKi8KICBhZGQ6IGZ1bmN0aW9uKGF0dHJpYnV0ZSwgbWVzc2FnZXMpIHsKICAgIHZhciB3YXNFbXB0eSA9IGdldCh0aGlzLCAnaXNFbXB0eScpOwoKICAgIG1lc3NhZ2VzID0gdGhpcy5fZmluZE9yQ3JlYXRlTWVzc2FnZXMoYXR0cmlidXRlLCBtZXNzYWdlcyk7CiAgICBnZXQodGhpcywgJ2NvbnRlbnQnKS5hZGRPYmplY3RzKG1lc3NhZ2VzKTsKCiAgICB0aGlzLm5vdGlmeVByb3BlcnR5Q2hhbmdlKGF0dHJpYnV0ZSk7CiAgICB0aGlzLmVudW1lcmFibGVDb250ZW50RGlkQ2hhbmdlKCk7CgogICAgaWYgKHdhc0VtcHR5ICYmICFnZXQodGhpcywgJ2lzRW1wdHknKSkgewogICAgICB0aGlzLnRyaWdnZXIoJ2JlY2FtZUludmFsaWQnKTsKICAgIH0KICB9LAoKICAvKioKICAgIEBtZXRob2QgX2ZpbmRPckNyZWF0ZU1lc3NhZ2VzCiAgICBAcHJpdmF0ZQogICovCiAgX2ZpbmRPckNyZWF0ZU1lc3NhZ2VzOiBmdW5jdGlvbihhdHRyaWJ1dGUsIG1lc3NhZ2VzKSB7CiAgICB2YXIgZXJyb3JzID0gdGhpcy5lcnJvcnNGb3IoYXR0cmlidXRlKTsKCiAgICByZXR1cm4gRW1iZXIubWFrZUFycmF5KG1lc3NhZ2VzKS5tYXAoZnVuY3Rpb24obWVzc2FnZSkgewogICAgICByZXR1cm4gZXJyb3JzLmZpbmRCeSgnbWVzc2FnZScsIG1lc3NhZ2UpIHx8IHsKICAgICAgICBhdHRyaWJ1dGU6IGF0dHJpYnV0ZSwKICAgICAgICBtZXNzYWdlOiBtZXNzYWdlCiAgICAgIH07CiAgICB9KTsKICB9LAoKICAvKioKICAgIFJlbW92ZXMgYWxsIGVycm9yIG1lc3NhZ2VzIGZyb20gdGhlIGdpdmVuIGF0dHJpYnV0ZSBhbmQgc2VuZHMKICAgIGBiZWNhbWVWYWxpZGAgZXZlbnQgdG8gdGhlIHJlY29yZCBpZiB0aGVyZSBubyBtb3JlIGVycm9ycyBsZWZ0LgoKICAgIEBtZXRob2QgcmVtb3ZlCiAgICBAcGFyYW0ge1N0cmluZ30gYXR0cmlidXRlCiAgKi8KICByZW1vdmU6IGZ1bmN0aW9uKGF0dHJpYnV0ZSkgewogICAgaWYgKGdldCh0aGlzLCAnaXNFbXB0eScpKSB7IHJldHVybjsgfQoKICAgIHZhciBjb250ZW50ID0gZ2V0KHRoaXMsICdjb250ZW50JykucmVqZWN0QnkoJ2F0dHJpYnV0ZScsIGF0dHJpYnV0ZSk7CiAgICBnZXQodGhpcywgJ2NvbnRlbnQnKS5zZXRPYmplY3RzKGNvbnRlbnQpOwoKICAgIHRoaXMubm90aWZ5UHJvcGVydHlDaGFuZ2UoYXR0cmlidXRlKTsKICAgIHRoaXMuZW51bWVyYWJsZUNvbnRlbnREaWRDaGFuZ2UoKTsKCiAgICBpZiAoZ2V0KHRoaXMsICdpc0VtcHR5JykpIHsKICAgICAgdGhpcy50cmlnZ2VyKCdiZWNhbWVWYWxpZCcpOwogICAgfQogIH0sCgogIC8qKgogICAgUmVtb3ZlcyBhbGwgZXJyb3IgbWVzc2FnZXMgYW5kIHNlbmRzIGBiZWNhbWVWYWxpZGAgZXZlbnQKICAgIHRvIHRoZSByZWNvcmQuCgogICAgQG1ldGhvZCBjbGVhcgogICovCiAgY2xlYXI6IGZ1bmN0aW9uKCkgewogICAgaWYgKGdldCh0aGlzLCAnaXNFbXB0eScpKSB7IHJldHVybjsgfQoKICAgIGdldCh0aGlzLCAnY29udGVudCcpLmNsZWFyKCk7CiAgICB0aGlzLmVudW1lcmFibGVDb250ZW50RGlkQ2hhbmdlKCk7CgogICAgdGhpcy50cmlnZ2VyKCdiZWNhbWVWYWxpZCcpOwogIH0sCgogIC8qKgogICAgQ2hlY2tzIGlmIHRoZXJlIGlzIGVycm9yIG1lc3NhZ2VzIGZvciB0aGUgZ2l2ZW4gYXR0cmlidXRlLgoKICAgIEBtZXRob2QgaGFzCiAgICBAcGFyYW0ge1N0cmluZ30gYXR0cmlidXRlCiAgICBAcmV0dXJucyB7Qm9vbGVhbn0gdHJ1ZSBpZiB0aGVyZSBzb21lIGVycm9ycyBvbiBnaXZlbiBhdHRyaWJ1dGUKICAqLwogIGhhczogZnVuY3Rpb24oYXR0cmlidXRlKSB7CiAgICByZXR1cm4gIWlzRW1wdHkodGhpcy5lcnJvcnNGb3IoYXR0cmlidXRlKSk7CiAgfQp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCiAgQG1vZHVsZSBlbWJlci1kYXRhCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQsCiAgICBtZXJnZSA9IEVtYmVyLm1lcmdlLCBvbmNlID0gRW1iZXIucnVuLm9uY2U7Cgp2YXIgcmV0cmlldmVGcm9tQ3VycmVudFN0YXRlID0gRW1iZXIuY29tcHV0ZWQoJ2N1cnJlbnRTdGF0ZScsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICByZXR1cm4gZ2V0KGdldCh0aGlzLCAnY3VycmVudFN0YXRlJyksIGtleSk7Cn0pLnJlYWRPbmx5KCk7CgovKioKCiAgVGhlIG1vZGVsIGNsYXNzIHRoYXQgYWxsIEVtYmVyIERhdGEgcmVjb3JkcyBkZXNjZW5kIGZyb20uCgogIEBjbGFzcyBNb2RlbAogIEBuYW1lc3BhY2UgRFMKICBAZXh0ZW5kcyBFbWJlci5PYmplY3QKICBAdXNlcyBFbWJlci5FdmVudGVkCiovCkRTLk1vZGVsID0gRW1iZXIuT2JqZWN0LmV4dGVuZChFbWJlci5FdmVudGVkLCB7CiAgLyoqCiAgICBJZiB0aGlzIHByb3BlcnR5IGlzIGB0cnVlYCB0aGUgcmVjb3JkIGlzIGluIHRoZSBgZW1wdHlgCiAgICBzdGF0ZS4gRW1wdHkgaXMgdGhlIGZpcnN0IHN0YXRlIGFsbCByZWNvcmRzIGVudGVyIGFmdGVyIHRoZXkgaGF2ZQogICAgYmVlbiBjcmVhdGVkLiBNb3N0IHJlY29yZHMgY3JlYXRlZCBieSB0aGUgc3RvcmUgd2lsbCBxdWlja2x5CiAgICB0cmFuc2l0aW9uIHRvIHRoZSBgbG9hZGluZ2Agc3RhdGUgaWYgZGF0YSBuZWVkcyB0byBiZSBmZXRjaGVkIGZyb20KICAgIHRoZSBzZXJ2ZXIgb3IgdGhlIGBjcmVhdGVkYCBzdGF0ZSBpZiB0aGUgcmVjb3JkIGlzIGNyZWF0ZWQgb24gdGhlCiAgICBjbGllbnQuIEEgcmVjb3JkIGNhbiBhbHNvIGVudGVyIHRoZSBlbXB0eSBzdGF0ZSBpZiB0aGUgYWRhcHRlciBpcwogICAgdW5hYmxlIHRvIGxvY2F0ZSB0aGUgcmVjb3JkLgoKICAgIEBwcm9wZXJ0eSBpc0VtcHR5CiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgIEByZWFkT25seQogICovCiAgaXNFbXB0eTogcmV0cmlldmVGcm9tQ3VycmVudFN0YXRlLAogIC8qKgogICAgSWYgdGhpcyBwcm9wZXJ0eSBpcyBgdHJ1ZWAgdGhlIHJlY29yZCBpcyBpbiB0aGUgYGxvYWRpbmdgIHN0YXRlLiBBCiAgICByZWNvcmQgZW50ZXJzIHRoaXMgc3RhdGUgd2hlbiB0aGUgc3RvcmUgYXNrZXMgdGhlIGFkYXB0ZXIgZm9yIGl0cwogICAgZGF0YS4gSXQgcmVtYWlucyBpbiB0aGlzIHN0YXRlIHVudGlsIHRoZSBhZGFwdGVyIHByb3ZpZGVzIHRoZQogICAgcmVxdWVzdGVkIGRhdGEuCgogICAgQHByb3BlcnR5IGlzTG9hZGluZwogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAcmVhZE9ubHkKICAqLwogIGlzTG9hZGluZzogcmV0cmlldmVGcm9tQ3VycmVudFN0YXRlLAogIC8qKgogICAgSWYgdGhpcyBwcm9wZXJ0eSBpcyBgdHJ1ZWAgdGhlIHJlY29yZCBpcyBpbiB0aGUgYGxvYWRlZGAgc3RhdGUuIEEKICAgIHJlY29yZCBlbnRlcnMgdGhpcyBzdGF0ZSB3aGVuIGl0cyBkYXRhIGlzIHBvcHVsYXRlZC4gTW9zdCBvZiBhCiAgICByZWNvcmQncyBsaWZlY3ljbGUgaXMgc3BlbnQgaW5zaWRlIHN1YnN0YXRlcyBvZiB0aGUgYGxvYWRlZGAKICAgIHN0YXRlLgoKICAgIEV4YW1wbGUKCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgcmVjb3JkID0gc3RvcmUuY3JlYXRlUmVjb3JkKEFwcC5Nb2RlbCk7CiAgICByZWNvcmQuZ2V0KCdpc0xvYWRlZCcpOyAvLyB0cnVlCgogICAgc3RvcmUuZmluZCgnbW9kZWwnLCAxKS50aGVuKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIG1vZGVsLmdldCgnaXNMb2FkZWQnKTsgLy8gdHJ1ZQogICAgfSk7CiAgICBgYGAKCiAgICBAcHJvcGVydHkgaXNMb2FkZWQKICAgIEB0eXBlIHtCb29sZWFufQogICAgQHJlYWRPbmx5CiAgKi8KICBpc0xvYWRlZDogcmV0cmlldmVGcm9tQ3VycmVudFN0YXRlLAogIC8qKgogICAgSWYgdGhpcyBwcm9wZXJ0eSBpcyBgdHJ1ZWAgdGhlIHJlY29yZCBpcyBpbiB0aGUgYGRpcnR5YCBzdGF0ZS4gVGhlCiAgICByZWNvcmQgaGFzIGxvY2FsIGNoYW5nZXMgdGhhdCBoYXZlIG5vdCB5ZXQgYmVlbiBzYXZlZCBieSB0aGUKICAgIGFkYXB0ZXIuIFRoaXMgaW5jbHVkZXMgcmVjb3JkcyB0aGF0IGhhdmUgYmVlbiBjcmVhdGVkIChidXQgbm90IHlldAogICAgc2F2ZWQpIG9yIGRlbGV0ZWQuCgogICAgRXhhbXBsZQoKICAgIGBgYGphdmFzY3JpcHQKICAgIHZhciByZWNvcmQgPSBzdG9yZS5jcmVhdGVSZWNvcmQoQXBwLk1vZGVsKTsKICAgIHJlY29yZC5nZXQoJ2lzRGlydHknKTsgLy8gdHJ1ZQoKICAgIHN0b3JlLmZpbmQoJ21vZGVsJywgMSkudGhlbihmdW5jdGlvbihtb2RlbCkgewogICAgICBtb2RlbC5nZXQoJ2lzRGlydHknKTsgLy8gZmFsc2UKICAgICAgbW9kZWwuc2V0KCdmb28nLCAnc29tZSB2YWx1ZScpOwogICAgICBtb2RlbC5zZXQoJ2lzRGlydHknKTsgLy8gdHJ1ZQogICAgfSk7CiAgICBgYGAKCiAgICBAcHJvcGVydHkgaXNEaXJ0eQogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAcmVhZE9ubHkKICAqLwogIGlzRGlydHk6IHJldHJpZXZlRnJvbUN1cnJlbnRTdGF0ZSwKICAvKioKICAgIElmIHRoaXMgcHJvcGVydHkgaXMgYHRydWVgIHRoZSByZWNvcmQgaXMgaW4gdGhlIGBzYXZpbmdgIHN0YXRlLiBBCiAgICByZWNvcmQgZW50ZXJzIHRoZSBzYXZpbmcgc3RhdGUgd2hlbiBgc2F2ZWAgaXMgY2FsbGVkLCBidXQgdGhlCiAgICBhZGFwdGVyIGhhcyBub3QgeWV0IGFja25vd2xlZGdlZCB0aGF0IHRoZSBjaGFuZ2VzIGhhdmUgYmVlbgogICAgcGVyc2lzdGVkIHRvIHRoZSBiYWNrZW5kLgoKICAgIEV4YW1wbGUKCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgcmVjb3JkID0gc3RvcmUuY3JlYXRlUmVjb3JkKEFwcC5Nb2RlbCk7CiAgICByZWNvcmQuZ2V0KCdpc1NhdmluZycpOyAvLyBmYWxzZQogICAgdmFyIHByb21pc2UgPSByZWNvcmQuc2F2ZSgpOwogICAgcmVjb3JkLmdldCgnaXNTYXZpbmcnKTsgLy8gdHJ1ZQogICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKCkgewogICAgICByZWNvcmQuZ2V0KCdpc1NhdmluZycpOyAvLyBmYWxzZQogICAgfSk7CiAgICBgYGAKCiAgICBAcHJvcGVydHkgaXNTYXZpbmcKICAgIEB0eXBlIHtCb29sZWFufQogICAgQHJlYWRPbmx5CiAgKi8KICBpc1NhdmluZzogcmV0cmlldmVGcm9tQ3VycmVudFN0YXRlLAogIC8qKgogICAgSWYgdGhpcyBwcm9wZXJ0eSBpcyBgdHJ1ZWAgdGhlIHJlY29yZCBpcyBpbiB0aGUgYGRlbGV0ZWRgIHN0YXRlCiAgICBhbmQgaGFzIGJlZW4gbWFya2VkIGZvciBkZWxldGlvbi4gV2hlbiBgaXNEZWxldGVkYCBpcyB0cnVlIGFuZAogICAgYGlzRGlydHlgIGlzIHRydWUsIHRoZSByZWNvcmQgaXMgZGVsZXRlZCBsb2NhbGx5IGJ1dCB0aGUgZGVsZXRpb24KICAgIHdhcyBub3QgeWV0IHBlcnNpc3RlZC4gV2hlbiBgaXNTYXZpbmdgIGlzIHRydWUsIHRoZSBjaGFuZ2UgaXMKICAgIGluLWZsaWdodC4gV2hlbiBib3RoIGBpc0RpcnR5YCBhbmQgYGlzU2F2aW5nYCBhcmUgZmFsc2UsIHRoZQogICAgY2hhbmdlIGhhcyBwZXJzaXN0ZWQuCgogICAgRXhhbXBsZQoKICAgIGBgYGphdmFzY3JpcHQKICAgIHZhciByZWNvcmQgPSBzdG9yZS5jcmVhdGVSZWNvcmQoQXBwLk1vZGVsKTsKICAgIHJlY29yZC5nZXQoJ2lzRGVsZXRlZCcpOyAvLyBmYWxzZQogICAgcmVjb3JkLmRlbGV0ZVJlY29yZCgpOwogICAgcmVjb3JkLmdldCgnaXNEZWxldGVkJyk7IC8vIHRydWUKICAgIGBgYAoKICAgIEBwcm9wZXJ0eSBpc0RlbGV0ZWQKICAgIEB0eXBlIHtCb29sZWFufQogICAgQHJlYWRPbmx5CiAgKi8KICBpc0RlbGV0ZWQ6IHJldHJpZXZlRnJvbUN1cnJlbnRTdGF0ZSwKICAvKioKICAgIElmIHRoaXMgcHJvcGVydHkgaXMgYHRydWVgIHRoZSByZWNvcmQgaXMgaW4gdGhlIGBuZXdgIHN0YXRlLiBBCiAgICByZWNvcmQgd2lsbCBiZSBpbiB0aGUgYG5ld2Agc3RhdGUgd2hlbiBpdCBoYXMgYmVlbiBjcmVhdGVkIG9uIHRoZQogICAgY2xpZW50IGFuZCB0aGUgYWRhcHRlciBoYXMgbm90IHlldCByZXBvcnQgdGhhdCBpdCB3YXMgc3VjY2Vzc2Z1bGx5CiAgICBzYXZlZC4KCiAgICBFeGFtcGxlCgogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIHJlY29yZCA9IHN0b3JlLmNyZWF0ZVJlY29yZChBcHAuTW9kZWwpOwogICAgcmVjb3JkLmdldCgnaXNOZXcnKTsgLy8gdHJ1ZQoKICAgIHN0b3JlLmZpbmQoJ21vZGVsJywgMSkudGhlbihmdW5jdGlvbihtb2RlbCkgewogICAgICBtb2RlbC5nZXQoJ2lzTmV3Jyk7IC8vIGZhbHNlCiAgICB9KTsKICAgIGBgYAoKICAgIEBwcm9wZXJ0eSBpc05ldwogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAcmVhZE9ubHkKICAqLwogIGlzTmV3OiByZXRyaWV2ZUZyb21DdXJyZW50U3RhdGUsCiAgLyoqCiAgICBJZiB0aGlzIHByb3BlcnR5IGlzIGB0cnVlYCB0aGUgcmVjb3JkIGlzIGluIHRoZSBgdmFsaWRgIHN0YXRlLiBBCiAgICByZWNvcmQgd2lsbCBiZSBpbiB0aGUgYHZhbGlkYCBzdGF0ZSB3aGVuIG5vIGNsaWVudC1zaWRlCiAgICB2YWxpZGF0aW9ucyBoYXZlIGZhaWxlZCBhbmQgdGhlIGFkYXB0ZXIgZGlkIG5vdCByZXBvcnQgYW55CiAgICBzZXJ2ZXItc2lkZSB2YWxpZGF0aW9uIGZhaWx1cmVzLgoKICAgIEBwcm9wZXJ0eSBpc1ZhbGlkCiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgIEByZWFkT25seQogICovCiAgaXNWYWxpZDogcmV0cmlldmVGcm9tQ3VycmVudFN0YXRlLAogIC8qKgogICAgSWYgdGhlIHJlY29yZCBpcyBpbiB0aGUgZGlydHkgc3RhdGUgdGhpcyBwcm9wZXJ0eSB3aWxsIHJlcG9ydCB3aGF0CiAgICBraW5kIG9mIGNoYW5nZSBoYXMgY2F1c2VkIGl0IHRvIG1vdmUgaW50byB0aGUgZGlydHkKICAgIHN0YXRlLiBQb3NzaWJsZSB2YWx1ZXMgYXJlOgoKICAgIC0gYGNyZWF0ZWRgIFRoZSByZWNvcmQgaGFzIGJlZW4gY3JlYXRlZCBieSB0aGUgY2xpZW50IGFuZCBub3QgeWV0IHNhdmVkIHRvIHRoZSBhZGFwdGVyLgogICAgLSBgdXBkYXRlZGAgVGhlIHJlY29yZCBoYXMgYmVlbiB1cGRhdGVkIGJ5IHRoZSBjbGllbnQgYW5kIG5vdCB5ZXQgc2F2ZWQgdG8gdGhlIGFkYXB0ZXIuCiAgICAtIGBkZWxldGVkYCBUaGUgcmVjb3JkIGhhcyBiZWVuIGRlbGV0ZWQgYnkgdGhlIGNsaWVudCBhbmQgbm90IHlldCBzYXZlZCB0byB0aGUgYWRhcHRlci4KCiAgICBFeGFtcGxlCgogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIHJlY29yZCA9IHN0b3JlLmNyZWF0ZVJlY29yZChBcHAuTW9kZWwpOwogICAgcmVjb3JkLmdldCgnZGlydHlUeXBlJyk7IC8vICdjcmVhdGVkJwogICAgYGBgCgogICAgQHByb3BlcnR5IGRpcnR5VHlwZQogICAgQHR5cGUge1N0cmluZ30KICAgIEByZWFkT25seQogICovCiAgZGlydHlUeXBlOiByZXRyaWV2ZUZyb21DdXJyZW50U3RhdGUsCgogIC8qKgogICAgSWYgYHRydWVgIHRoZSBhZGFwdGVyIHJlcG9ydGVkIHRoYXQgaXQgd2FzIHVuYWJsZSB0byBzYXZlIGxvY2FsCiAgICBjaGFuZ2VzIHRvIHRoZSBiYWNrZW5kLiBUaGlzIG1heSBhbHNvIHJlc3VsdCBpbiB0aGUgcmVjb3JkIGhhdmluZwogICAgaXRzIGBpc1ZhbGlkYCBwcm9wZXJ0eSBiZWNvbWUgZmFsc2UgaWYgdGhlIGFkYXB0ZXIgcmVwb3J0ZWQgdGhhdAogICAgc2VydmVyLXNpZGUgdmFsaWRhdGlvbnMgZmFpbGVkLgoKICAgIEV4YW1wbGUKCiAgICBgYGBqYXZhc2NyaXB0CiAgICByZWNvcmQuZ2V0KCdpc0Vycm9yJyk7IC8vIGZhbHNlCiAgICByZWNvcmQuc2V0KCdmb28nLCAnaW52YWxpZCB2YWx1ZScpOwogICAgcmVjb3JkLnNhdmUoKS50aGVuKG51bGwsIGZ1bmN0aW9uKCkgewogICAgICByZWNvcmQuZ2V0KCdpc0Vycm9yJyk7IC8vIHRydWUKICAgIH0pOwogICAgYGBgCgogICAgQHByb3BlcnR5IGlzRXJyb3IKICAgIEB0eXBlIHtCb29sZWFufQogICAgQHJlYWRPbmx5CiAgKi8KICBpc0Vycm9yOiBmYWxzZSwKICAvKioKICAgIElmIGB0cnVlYCB0aGUgc3RvcmUgaXMgYXR0ZW1wdGluZyB0byByZWxvYWQgdGhlIHJlY29yZCBmb3JtIHRoZSBhZGFwdGVyLgoKICAgIEV4YW1wbGUKCiAgICBgYGBqYXZhc2NyaXB0CiAgICByZWNvcmQuZ2V0KCdpc1JlbG9hZGluZycpOyAvLyBmYWxzZQogICAgcmVjb3JkLnJlbG9hZCgpOwogICAgcmVjb3JkLmdldCgnaXNSZWxvYWRpbmcnKTsgLy8gdHJ1ZQogICAgYGBgCgogICAgQHByb3BlcnR5IGlzUmVsb2FkaW5nCiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgIEByZWFkT25seQogICovCiAgaXNSZWxvYWRpbmc6IGZhbHNlLAoKICAvKioKICAgIFRoZSBgY2xpZW50SWRgIHByb3BlcnR5IGlzIGEgdHJhbnNpZW50IG51bWVyaWNhbCBpZGVudGlmaWVyCiAgICBnZW5lcmF0ZWQgYXQgcnVudGltZSBieSB0aGUgZGF0YSBzdG9yZS4gSXQgaXMgaW1wb3J0YW50CiAgICBwcmltYXJpbHkgYmVjYXVzZSBuZXdseSBjcmVhdGVkIG9iamVjdHMgbWF5IG5vdCB5ZXQgaGF2ZSBhbgogICAgZXh0ZXJuYWxseSBnZW5lcmF0ZWQgaWQuCgogICAgQHByb3BlcnR5IGNsaWVudElkCiAgICBAcHJpdmF0ZQogICAgQHR5cGUge051bWJlcnxTdHJpbmd9CiAgKi8KICBjbGllbnRJZDogbnVsbCwKICAvKioKICAgIEFsbCBlbWJlciBtb2RlbHMgaGF2ZSBhbiBpZCBwcm9wZXJ0eS4gVGhpcyBpcyBhbiBpZGVudGlmaWVyCiAgICBtYW5hZ2VkIGJ5IGFuIGV4dGVybmFsIHNvdXJjZS4gVGhlc2UgYXJlIGFsd2F5cyBjb2VyY2VkIHRvIGJlCiAgICBzdHJpbmdzIGJlZm9yZSBiZWluZyB1c2VkIGludGVybmFsbHkuIE5vdGUgd2hlbiBkZWNsYXJpbmcgdGhlCiAgICBhdHRyaWJ1dGVzIGZvciBhIG1vZGVsIGl0IGlzIGFuIGVycm9yIHRvIGRlY2xhcmUgYW4gaWQKICAgIGF0dHJpYnV0ZS4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgcmVjb3JkID0gc3RvcmUuY3JlYXRlUmVjb3JkKEFwcC5Nb2RlbCk7CiAgICByZWNvcmQuZ2V0KCdpZCcpOyAvLyBudWxsCgogICAgc3RvcmUuZmluZCgnbW9kZWwnLCAxKS50aGVuKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIG1vZGVsLmdldCgnaWQnKTsgLy8gJzEnCiAgICB9KTsKICAgIGBgYAoKICAgIEBwcm9wZXJ0eSBpZAogICAgQHR5cGUge1N0cmluZ30KICAqLwogIGlkOiBudWxsLAogIHRyYW5zYWN0aW9uOiBudWxsLAogIC8qKgogICAgQHByb3BlcnR5IGN1cnJlbnRTdGF0ZQogICAgQHByaXZhdGUKICAgIEB0eXBlIHtPYmplY3R9CiAgKi8KICBjdXJyZW50U3RhdGU6IG51bGwsCiAgLyoqCiAgICBXaGVuIHRoZSByZWNvcmQgaXMgaW4gdGhlIGBpbnZhbGlkYCBzdGF0ZSB0aGlzIG9iamVjdCB3aWxsIGNvbnRhaW4KICAgIGFueSBlcnJvcnMgcmV0dXJuZWQgYnkgdGhlIGFkYXB0ZXIuIFdoZW4gcHJlc2VudCB0aGUgZXJyb3JzIGhhc2gKICAgIHR5cGljYWxseSBjb250YWlucyBrZXlzIGNvcmVzcG9uZGluZyB0byB0aGUgaW52YWxpZCBwcm9wZXJ0eSBuYW1lcwogICAgYW5kIHZhbHVlcyB3aGljaCBhcmUgYW4gYXJyYXkgb2YgZXJyb3IgbWVzc2FnZXMuCgogICAgYGBgamF2YXNjcmlwdAogICAgcmVjb3JkLmdldCgnZXJyb3JzLmxlbmd0aCcpOyAvLyAwCiAgICByZWNvcmQuc2V0KCdmb28nLCAnaW52YWxpZCB2YWx1ZScpOwogICAgcmVjb3JkLnNhdmUoKS50aGVuKG51bGwsIGZ1bmN0aW9uKCkgewogICAgICByZWNvcmQuZ2V0KCdlcnJvcnMnKS5nZXQoJ2ZvbycpOyAvLyBbJ2ZvbyBzaG91bGQgYmUgYSBudW1iZXIuJ10KICAgIH0pOwogICAgYGBgCgogICAgQHByb3BlcnR5IGVycm9ycwogICAgQHR5cGUge09iamVjdH0KICAqLwogIGVycm9yczogbnVsbCwKCiAgLyoqCiAgICBDcmVhdGUgYSBKU09OIHJlcHJlc2VudGF0aW9uIG9mIHRoZSByZWNvcmQsIHVzaW5nIHRoZSBzZXJpYWxpemF0aW9uCiAgICBzdHJhdGVneSBvZiB0aGUgc3RvcmUncyBhZGFwdGVyLgoKICAgYHNlcmlhbGl6ZWAgdGFrZXMgYW4gb3B0aW9uYWwgaGFzaCBhcyBhIHBhcmFtZXRlciwgY3VycmVudGx5CiAgICBzdXBwb3J0ZWQgb3B0aW9ucyBhcmU6CgogICAtIGBpbmNsdWRlSWRgOiBgdHJ1ZWAgaWYgdGhlIHJlY29yZCdzIElEIHNob3VsZCBiZSBpbmNsdWRlZCBpbiB0aGUKICAgICAgSlNPTiByZXByZXNlbnRhdGlvbi4KCiAgICBAbWV0aG9kIHNlcmlhbGl6ZQogICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgIEByZXR1cm5zIHtPYmplY3R9IGFuIG9iamVjdCB3aG9zZSB2YWx1ZXMgYXJlIHByaW1pdGl2ZSBKU09OIHZhbHVlcyBvbmx5CiAgKi8KICBzZXJpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHZhciBzdG9yZSA9IGdldCh0aGlzLCAnc3RvcmUnKTsKICAgIHJldHVybiBzdG9yZS5zZXJpYWxpemUodGhpcywgb3B0aW9ucyk7CiAgfSwKCiAgLyoqCiAgICBVc2UgW0RTLkpTT05TZXJpYWxpemVyXShEUy5KU09OU2VyaWFsaXplci5odG1sKSB0bwogICAgZ2V0IHRoZSBKU09OIHJlcHJlc2VudGF0aW9uIG9mIGEgcmVjb3JkLgoKICAgIGB0b0pTT05gIHRha2VzIGFuIG9wdGlvbmFsIGhhc2ggYXMgYSBwYXJhbWV0ZXIsIGN1cnJlbnRseQogICAgc3VwcG9ydGVkIG9wdGlvbnMgYXJlOgoKICAgIC0gYGluY2x1ZGVJZGA6IGB0cnVlYCBpZiB0aGUgcmVjb3JkJ3MgSUQgc2hvdWxkIGJlIGluY2x1ZGVkIGluIHRoZQogICAgICBKU09OIHJlcHJlc2VudGF0aW9uLgoKICAgIEBtZXRob2QgdG9KU09OCiAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAgQHJldHVybnMge09iamVjdH0gQSBKU09OIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBvYmplY3QuCiAgKi8KICB0b0pTT046IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIC8vIGNvbnRhaW5lciBpcyBmb3IgbGF6eSB0cmFuc2Zvcm0gbG9va3VwcwogICAgdmFyIHNlcmlhbGl6ZXIgPSBEUy5KU09OU2VyaWFsaXplci5jcmVhdGUoeyBjb250YWluZXI6IHRoaXMuY29udGFpbmVyIH0pOwogICAgcmV0dXJuIHNlcmlhbGl6ZXIuc2VyaWFsaXplKHRoaXMsIG9wdGlvbnMpOwogIH0sCgogIC8qKgogICAgRmlyZWQgd2hlbiB0aGUgcmVjb3JkIGlzIGxvYWRlZCBmcm9tIHRoZSBzZXJ2ZXIuCgogICAgQGV2ZW50IGRpZExvYWQKICAqLwogIGRpZExvYWQ6IEVtYmVyLkssCgogIC8qKgogICAgRmlyZWQgd2hlbiB0aGUgcmVjb3JkIGlzIHVwZGF0ZWQuCgogICAgQGV2ZW50IGRpZFVwZGF0ZQogICovCiAgZGlkVXBkYXRlOiBFbWJlci5LLAoKICAvKioKICAgIEZpcmVkIHdoZW4gdGhlIHJlY29yZCBpcyBjcmVhdGVkLgoKICAgIEBldmVudCBkaWRDcmVhdGUKICAqLwogIGRpZENyZWF0ZTogRW1iZXIuSywKCiAgLyoqCiAgICBGaXJlZCB3aGVuIHRoZSByZWNvcmQgaXMgZGVsZXRlZC4KCiAgICBAZXZlbnQgZGlkRGVsZXRlCiAgKi8KICBkaWREZWxldGU6IEVtYmVyLkssCgogIC8qKgogICAgRmlyZWQgd2hlbiB0aGUgcmVjb3JkIGJlY29tZXMgaW52YWxpZC4KCiAgICBAZXZlbnQgYmVjYW1lSW52YWxpZAogICovCiAgYmVjYW1lSW52YWxpZDogRW1iZXIuSywKCiAgLyoqCiAgICBGaXJlZCB3aGVuIHRoZSByZWNvcmQgZW50ZXJzIHRoZSBlcnJvciBzdGF0ZS4KCiAgICBAZXZlbnQgYmVjYW1lRXJyb3IKICAqLwogIGJlY2FtZUVycm9yOiBFbWJlci5LLAoKICAvKioKICAgIEBwcm9wZXJ0eSBkYXRhCiAgICBAcHJpdmF0ZQogICAgQHR5cGUge09iamVjdH0KICAqLwogIGRhdGE6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewogICAgdGhpcy5fZGF0YSA9IHRoaXMuX2RhdGEgfHwge307CiAgICByZXR1cm4gdGhpcy5fZGF0YTsKICB9KS5wcm9wZXJ0eSgpLAoKICBfZGF0YTogbnVsbCwKCiAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICBzZXQodGhpcywgJ2N1cnJlbnRTdGF0ZScsIERTLlJvb3RTdGF0ZS5lbXB0eSk7CiAgICB2YXIgZXJyb3JzID0gRFMuRXJyb3JzLmNyZWF0ZSgpOwogICAgZXJyb3JzLnJlZ2lzdGVySGFuZGxlcnModGhpcywgZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuc2VuZCgnYmVjYW1lSW52YWxpZCcpOwogICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuc2VuZCgnYmVjYW1lVmFsaWQnKTsKICAgIH0pOwogICAgc2V0KHRoaXMsICdlcnJvcnMnLCBlcnJvcnMpOwogICAgdGhpcy5fc3VwZXIoKTsKICAgIHRoaXMuX3NldHVwKCk7CiAgfSwKCiAgX3NldHVwOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2NoYW5nZXNUb1N5bmMgPSB7fTsKICAgIHRoaXMuX2RlZmVycmVkVHJpZ2dlcnMgPSBbXTsKICAgIHRoaXMuX2RhdGEgPSB7fTsKICAgIHRoaXMuX2F0dHJpYnV0ZXMgPSB7fTsKICAgIHRoaXMuX2luRmxpZ2h0QXR0cmlidXRlcyA9IHt9OwogICAgdGhpcy5fcmVsYXRpb25zaGlwcyA9IHt9OwogIH0sCgogIC8qKgogICAgQG1ldGhvZCBzZW5kCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUKICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0CiAgKi8KICBzZW5kOiBmdW5jdGlvbihuYW1lLCBjb250ZXh0KSB7CiAgICB2YXIgY3VycmVudFN0YXRlID0gZ2V0KHRoaXMsICdjdXJyZW50U3RhdGUnKTsKCiAgICBpZiAoIWN1cnJlbnRTdGF0ZVtuYW1lXSkgewogICAgICB0aGlzLl91bmhhbmRsZWRFdmVudChjdXJyZW50U3RhdGUsIG5hbWUsIGNvbnRleHQpOwogICAgfQoKICAgIHJldHVybiBjdXJyZW50U3RhdGVbbmFtZV0odGhpcywgY29udGV4dCk7CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIHRyYW5zaXRpb25UbwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lCiAgKi8KICB0cmFuc2l0aW9uVG86IGZ1bmN0aW9uKG5hbWUpIHsKICAgIC8vIFBPU1NJQkxFIFRPRE86IFJlbW92ZSB0aGlzIGNvZGUgYW5kIHJlcGxhY2Ugd2l0aAogICAgLy8gYWx3YXlzIGhhdmluZyBkaXJlY3QgcmVmZXJlbmNlcyB0byBzdGF0ZSBvYmplY3RzCgogICAgdmFyIHBpdm90TmFtZSA9IG5hbWUuc3BsaXQoIi4iLCAxKSwKICAgICAgICBjdXJyZW50U3RhdGUgPSBnZXQodGhpcywgJ2N1cnJlbnRTdGF0ZScpLAogICAgICAgIHN0YXRlID0gY3VycmVudFN0YXRlOwoKICAgIGRvIHsKICAgICAgaWYgKHN0YXRlLmV4aXQpIHsgc3RhdGUuZXhpdCh0aGlzKTsgfQogICAgICBzdGF0ZSA9IHN0YXRlLnBhcmVudFN0YXRlOwogICAgfSB3aGlsZSAoIXN0YXRlLmhhc093blByb3BlcnR5KHBpdm90TmFtZSkpOwoKICAgIHZhciBwYXRoID0gbmFtZS5zcGxpdCgiLiIpOwoKICAgIHZhciBzZXR1cHMgPSBbXSwgZW50ZXJzID0gW10sIGksIGw7CgogICAgZm9yIChpPTAsIGw9cGF0aC5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgIHN0YXRlID0gc3RhdGVbcGF0aFtpXV07CgogICAgICBpZiAoc3RhdGUuZW50ZXIpIHsgZW50ZXJzLnB1c2goc3RhdGUpOyB9CiAgICAgIGlmIChzdGF0ZS5zZXR1cCkgeyBzZXR1cHMucHVzaChzdGF0ZSk7IH0KICAgIH0KCiAgICBmb3IgKGk9MCwgbD1lbnRlcnMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICBlbnRlcnNbaV0uZW50ZXIodGhpcyk7CiAgICB9CgogICAgc2V0KHRoaXMsICdjdXJyZW50U3RhdGUnLCBzdGF0ZSk7CgogICAgZm9yIChpPTAsIGw9c2V0dXBzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgc2V0dXBzW2ldLnNldHVwKHRoaXMpOwogICAgfQoKICAgIHRoaXMudXBkYXRlUmVjb3JkQXJyYXlzTGF0ZXIoKTsKICB9LAoKICBfdW5oYW5kbGVkRXZlbnQ6IGZ1bmN0aW9uKHN0YXRlLCBuYW1lLCBjb250ZXh0KSB7CiAgICB2YXIgZXJyb3JNZXNzYWdlID0gIkF0dGVtcHRlZCB0byBoYW5kbGUgZXZlbnQgYCIgKyBuYW1lICsgImAgIjsKICAgIGVycm9yTWVzc2FnZSAgICArPSAib24gIiArIFN0cmluZyh0aGlzKSArICIgd2hpbGUgaW4gc3RhdGUgIjsKICAgIGVycm9yTWVzc2FnZSAgICArPSBzdGF0ZS5zdGF0ZU5hbWUgKyAiLiAiOwoKICAgIGlmIChjb250ZXh0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgZXJyb3JNZXNzYWdlICArPSAiQ2FsbGVkIHdpdGggIiArIEVtYmVyLmluc3BlY3QoY29udGV4dCkgKyAiLiI7CiAgICB9CgogICAgdGhyb3cgbmV3IEVtYmVyLkVycm9yKGVycm9yTWVzc2FnZSk7CiAgfSwKCiAgd2l0aFRyYW5zYWN0aW9uOiBmdW5jdGlvbihmbikgewogICAgdmFyIHRyYW5zYWN0aW9uID0gZ2V0KHRoaXMsICd0cmFuc2FjdGlvbicpOwogICAgaWYgKHRyYW5zYWN0aW9uKSB7IGZuKHRyYW5zYWN0aW9uKTsgfQogIH0sCgogIC8qKgogICAgQG1ldGhvZCBsb2FkaW5nRGF0YQogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7UHJvbWlzZX0gcHJvbWlzZQogICovCiAgbG9hZGluZ0RhdGE6IGZ1bmN0aW9uKHByb21pc2UpIHsKICAgIHRoaXMuc2VuZCgnbG9hZGluZ0RhdGEnLCBwcm9taXNlKTsKICB9LAoKICAvKioKICAgIEBtZXRob2QgbG9hZGVkRGF0YQogICAgQHByaXZhdGUKICAqLwogIGxvYWRlZERhdGE6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5zZW5kKCdsb2FkZWREYXRhJyk7CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIG5vdEZvdW5kCiAgICBAcHJpdmF0ZQogICovCiAgbm90Rm91bmQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5zZW5kKCdub3RGb3VuZCcpOwogIH0sCgogIC8qKgogICAgQG1ldGhvZCBwdXNoZWREYXRhCiAgICBAcHJpdmF0ZQogICovCiAgcHVzaGVkRGF0YTogZnVuY3Rpb24oKSB7CiAgICB0aGlzLnNlbmQoJ3B1c2hlZERhdGEnKTsKICB9LAoKICAvKioKICAgIE1hcmtzIHRoZSByZWNvcmQgYXMgZGVsZXRlZCBidXQgZG9lcyBub3Qgc2F2ZSBpdC4gWW91IG11c3QgY2FsbAogICAgYHNhdmVgIGFmdGVyd2FyZHMgaWYgeW91IHdhbnQgdG8gcGVyc2lzdCBpdC4gWW91IG1pZ2h0IHVzZSB0aGlzCiAgICBtZXRob2QgaWYgeW91IHdhbnQgdG8gYWxsb3cgdGhlIHVzZXIgdG8gc3RpbGwgYHJvbGxiYWNrKClgIGEKICAgIGRlbGV0ZSBhZnRlciBpdCB3YXMgbWFkZS4KCiAgICBFeGFtcGxlCgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLk1vZGVsRGVsZXRlUm91dGUgPSBFbWJlci5Sb3V0ZS5leHRlbmQoewogICAgICBhY3Rpb25zOiB7CiAgICAgICAgc29mdERlbGV0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLmdldCgnbW9kZWwnKS5kZWxldGVSZWNvcmQoKTsKICAgICAgICB9LAogICAgICAgIGNvbmZpcm06IGZ1bmN0aW9uKCkgewogICAgICAgICAgdGhpcy5nZXQoJ21vZGVsJykuc2F2ZSgpOwogICAgICAgIH0sCiAgICAgICAgdW5kbzogZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLmdldCgnbW9kZWwnKS5yb2xsYmFjaygpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBgYGAKCiAgICBAbWV0aG9kIGRlbGV0ZVJlY29yZAogICovCiAgZGVsZXRlUmVjb3JkOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuc2VuZCgnZGVsZXRlUmVjb3JkJyk7CiAgfSwKCiAgLyoqCiAgICBTYW1lIGFzIGBkZWxldGVSZWNvcmRgLCBidXQgc2F2ZXMgdGhlIHJlY29yZCBpbW1lZGlhdGVseS4KCiAgICBFeGFtcGxlCgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLk1vZGVsRGVsZXRlUm91dGUgPSBFbWJlci5Sb3V0ZS5leHRlbmQoewogICAgICBhY3Rpb25zOiB7CiAgICAgICAgZGVsZXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBjb250cm9sbGVyID0gdGhpcy5jb250cm9sbGVyOwogICAgICAgICAgdGhpcy5nZXQoJ21vZGVsJykuZGVzdHJveVJlY29yZCgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnRyb2xsZXIudHJhbnNpdGlvblRvUm91dGUoJ21vZGVsLmluZGV4Jyk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgQG1ldGhvZCBkZXN0cm95UmVjb3JkCiAgICBAcmV0dXJuIHtQcm9taXNlfSBhIHByb21pc2UgdGhhdCB3aWxsIGJlIHJlc29sdmVkIHdoZW4gdGhlIGFkYXB0ZXIgcmV0dXJucwogICAgc3VjY2Vzc2Z1bGx5IG9yIHJlamVjdGVkIGlmIHRoZSBhZGFwdGVyIHJldHVybnMgd2l0aCBhbiBlcnJvci4KICAqLwogIGRlc3Ryb3lSZWNvcmQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5kZWxldGVSZWNvcmQoKTsKICAgIHJldHVybiB0aGlzLnNhdmUoKTsKICB9LAoKICAvKioKICAgIEBtZXRob2QgdW5sb2FkUmVjb3JkCiAgICBAcHJpdmF0ZQogICovCiAgdW5sb2FkUmVjb3JkOiBmdW5jdGlvbigpIHsKICAgIEVtYmVyLmFzc2VydCgiWW91IGNhbiBvbmx5IHVubG9hZCBhIGxvYWRlZCwgbm9uLWRpcnR5IHJlY29yZC4iLCAhZ2V0KHRoaXMsICdpc0RpcnR5JykpOwoKICAgIHRoaXMuc2VuZCgndW5sb2FkUmVjb3JkJyk7CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIGNsZWFyUmVsYXRpb25zaGlwcwogICAgQHByaXZhdGUKICAqLwogIGNsZWFyUmVsYXRpb25zaGlwczogZnVuY3Rpb24oKSB7CiAgICB0aGlzLmVhY2hSZWxhdGlvbnNoaXAoZnVuY3Rpb24obmFtZSwgcmVsYXRpb25zaGlwKSB7CiAgICAgIGlmIChyZWxhdGlvbnNoaXAua2luZCA9PT0gJ2JlbG9uZ3NUbycpIHsKICAgICAgICBzZXQodGhpcywgbmFtZSwgbnVsbCk7CiAgICAgIH0gZWxzZSBpZiAocmVsYXRpb25zaGlwLmtpbmQgPT09ICdoYXNNYW55JykgewogICAgICAgIHZhciBoYXNNYW55ID0gdGhpcy5fcmVsYXRpb25zaGlwc1tyZWxhdGlvbnNoaXAubmFtZV07CiAgICAgICAgaWYgKGhhc01hbnkpIHsgaGFzTWFueS5jbGVhcigpOyB9CiAgICAgIH0KICAgIH0sIHRoaXMpOwogIH0sCgogIC8qKgogICAgQG1ldGhvZCB1cGRhdGVSZWNvcmRBcnJheXMKICAgIEBwcml2YXRlCiAgKi8KICB1cGRhdGVSZWNvcmRBcnJheXM6IGZ1bmN0aW9uKCkgewogICAgZ2V0KHRoaXMsICdzdG9yZScpLmRhdGFXYXNVcGRhdGVkKHRoaXMuY29uc3RydWN0b3IsIHRoaXMpOwogIH0sCgogIC8qKgogICAgUmV0dXJucyBhbiBvYmplY3QsIHdob3NlIGtleXMgYXJlIGNoYW5nZWQgcHJvcGVydGllcywgYW5kIHZhbHVlIGlzCiAgICBhbiBbb2xkUHJvcCwgbmV3UHJvcF0gYXJyYXkuCgogICAgRXhhbXBsZQoKICAgIGBgYGphdmFzY3JpcHQKICAgIEFwcC5NYXNjb3QgPSBEUy5Nb2RlbC5leHRlbmQoewogICAgICBuYW1lOiBhdHRyKCdzdHJpbmcnKQogICAgfSk7CgogICAgdmFyIHBlcnNvbiA9IHN0b3JlLmNyZWF0ZVJlY29yZCgncGVyc29uJyk7CiAgICBwZXJzb24uY2hhbmdlZEF0dHJpYnV0ZXMoKTsgLy8ge30KICAgIHBlcnNvbi5zZXQoJ25hbWUnLCAnVG9tc3RlcicpOwogICAgcGVyc29uLmNoYW5nZWRBdHRyaWJ1dGVzKCk7IC8vIHtuYW1lOiBbdW5kZWZpbmVkLCAnVG9tc3RlciddfQogICAgYGBgCgogICAgQG1ldGhvZCBjaGFuZ2VkQXR0cmlidXRlcwogICAgQHJldHVybiB7T2JqZWN0fSBhbiBvYmplY3QsIHdob3NlIGtleXMgYXJlIGNoYW5nZWQgcHJvcGVydGllcywKICAgICAgYW5kIHZhbHVlIGlzIGFuIFtvbGRQcm9wLCBuZXdQcm9wXSBhcnJheS4KICAqLwogIGNoYW5nZWRBdHRyaWJ1dGVzOiBmdW5jdGlvbigpIHsKICAgIHZhciBvbGREYXRhID0gZ2V0KHRoaXMsICdfZGF0YScpLAogICAgICAgIG5ld0RhdGEgPSBnZXQodGhpcywgJ19hdHRyaWJ1dGVzJyksCiAgICAgICAgZGlmZkRhdGEgPSB7fSwKICAgICAgICBwcm9wOwoKICAgIGZvciAocHJvcCBpbiBuZXdEYXRhKSB7CiAgICAgIGRpZmZEYXRhW3Byb3BdID0gW29sZERhdGFbcHJvcF0sIG5ld0RhdGFbcHJvcF1dOwogICAgfQoKICAgIHJldHVybiBkaWZmRGF0YTsKICB9LAoKICAvKioKICAgIEBtZXRob2QgYWRhcHRlcldpbGxDb21taXQKICAgIEBwcml2YXRlCiAgKi8KICBhZGFwdGVyV2lsbENvbW1pdDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLnNlbmQoJ3dpbGxDb21taXQnKTsKICB9LAoKICAvKioKICAgIElmIHRoZSBhZGFwdGVyIGRpZCBub3QgcmV0dXJuIGEgaGFzaCBpbiByZXNwb25zZSB0byBhIGNvbW1pdCwKICAgIG1lcmdlIHRoZSBjaGFuZ2VkIGF0dHJpYnV0ZXMgYW5kIHJlbGF0aW9uc2hpcHMgaW50byB0aGUgZXhpc3RpbmcKICAgIHNhdmVkIGRhdGEuCgogICAgQG1ldGhvZCBhZGFwdGVyRGlkQ29tbWl0CiAgKi8KICBhZGFwdGVyRGlkQ29tbWl0OiBmdW5jdGlvbihkYXRhKSB7CiAgICBzZXQodGhpcywgJ2lzRXJyb3InLCBmYWxzZSk7CgogICAgaWYgKGRhdGEpIHsKICAgICAgdGhpcy5fZGF0YSA9IGRhdGE7CiAgICB9IGVsc2UgewogICAgICBFbWJlci5taXhpbih0aGlzLl9kYXRhLCB0aGlzLl9pbkZsaWdodEF0dHJpYnV0ZXMpOwogICAgfQoKICAgIHRoaXMuX2luRmxpZ2h0QXR0cmlidXRlcyA9IHt9OwoKICAgIHRoaXMuc2VuZCgnZGlkQ29tbWl0Jyk7CiAgICB0aGlzLnVwZGF0ZVJlY29yZEFycmF5c0xhdGVyKCk7CgogICAgaWYgKCFkYXRhKSB7IHJldHVybjsgfQoKICAgIHRoaXMuc3VzcGVuZFJlbGF0aW9uc2hpcE9ic2VydmVycyhmdW5jdGlvbigpIHsKICAgICAgdGhpcy5ub3RpZnlQcm9wZXJ0eUNoYW5nZSgnZGF0YScpOwogICAgfSk7CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIGFkYXB0ZXJEaWREaXJ0eQogICAgQHByaXZhdGUKICAqLwogIGFkYXB0ZXJEaWREaXJ0eTogZnVuY3Rpb24oKSB7CiAgICB0aGlzLnNlbmQoJ2JlY29tZURpcnR5Jyk7CiAgICB0aGlzLnVwZGF0ZVJlY29yZEFycmF5c0xhdGVyKCk7CiAgfSwKCiAgZGF0YURpZENoYW5nZTogRW1iZXIub2JzZXJ2ZXIoZnVuY3Rpb24oKSB7CiAgICB0aGlzLnJlbG9hZEhhc01hbnlzKCk7CiAgfSwgJ2RhdGEnKSwKCiAgcmVsb2FkSGFzTWFueXM6IGZ1bmN0aW9uKCkgewogICAgdmFyIHJlbGF0aW9uc2hpcHMgPSBnZXQodGhpcy5jb25zdHJ1Y3RvciwgJ3JlbGF0aW9uc2hpcHNCeU5hbWUnKTsKICAgIHRoaXMudXBkYXRlUmVjb3JkQXJyYXlzTGF0ZXIoKTsKICAgIHJlbGF0aW9uc2hpcHMuZm9yRWFjaChmdW5jdGlvbihuYW1lLCByZWxhdGlvbnNoaXApIHsKICAgICAgaWYgKHRoaXMuX2RhdGEubGlua3MgJiYgdGhpcy5fZGF0YS5saW5rc1tuYW1lXSkgeyByZXR1cm47IH0KICAgICAgaWYgKHJlbGF0aW9uc2hpcC5raW5kID09PSAnaGFzTWFueScpIHsKICAgICAgICB0aGlzLmhhc01hbnlEaWRDaGFuZ2UocmVsYXRpb25zaGlwLmtleSk7CiAgICAgIH0KICAgIH0sIHRoaXMpOwogIH0sCgogIGhhc01hbnlEaWRDaGFuZ2U6IGZ1bmN0aW9uKGtleSkgewogICAgdmFyIGhhc01hbnkgPSB0aGlzLl9yZWxhdGlvbnNoaXBzW2tleV07CgogICAgaWYgKGhhc01hbnkpIHsKICAgICAgdmFyIHJlY29yZHMgPSB0aGlzLl9kYXRhW2tleV0gfHwgW107CgogICAgICBzZXQoaGFzTWFueSwgJ2NvbnRlbnQnLCBFbWJlci5BKHJlY29yZHMpKTsKICAgICAgc2V0KGhhc01hbnksICdpc0xvYWRlZCcsIHRydWUpOwogICAgICBoYXNNYW55LnRyaWdnZXIoJ2RpZExvYWQnKTsKICAgIH0KICB9LAoKICAvKioKICAgIEBtZXRob2QgdXBkYXRlUmVjb3JkQXJyYXlzTGF0ZXIKICAgIEBwcml2YXRlCiAgKi8KICB1cGRhdGVSZWNvcmRBcnJheXNMYXRlcjogZnVuY3Rpb24oKSB7CiAgICBFbWJlci5ydW4ub25jZSh0aGlzLCB0aGlzLnVwZGF0ZVJlY29yZEFycmF5cyk7CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIHNldHVwRGF0YQogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7T2JqZWN0fSBkYXRhCiAgICBAcGFyYW0ge0Jvb2xlYW59IHBhcnRpYWwgdGhlIGRhdGEgc2hvdWxkIGJlIG1lcmdlZCBpbnRvCiAgICAgIHRoZSBleGlzdGluZyBkYXRhLCBub3QgcmVwbGFjZSBpdC4KICAqLwogIHNldHVwRGF0YTogZnVuY3Rpb24oZGF0YSwgcGFydGlhbCkgewogICAgaWYgKHBhcnRpYWwpIHsKICAgICAgRW1iZXIubWVyZ2UodGhpcy5fZGF0YSwgZGF0YSk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLl9kYXRhID0gZGF0YTsKICAgIH0KCiAgICB2YXIgcmVsYXRpb25zaGlwcyA9IHRoaXMuX3JlbGF0aW9uc2hpcHM7CgogICAgdGhpcy5lYWNoUmVsYXRpb25zaGlwKGZ1bmN0aW9uKG5hbWUsIHJlbCkgewogICAgICBpZiAoZGF0YS5saW5rcyAmJiBkYXRhLmxpbmtzW25hbWVdKSB7IHJldHVybjsgfQogICAgICBpZiAocmVsLm9wdGlvbnMuYXN5bmMpIHsgcmVsYXRpb25zaGlwc1tuYW1lXSA9IG51bGw7IH0KICAgIH0pOwoKICAgIGlmIChkYXRhKSB7IHRoaXMucHVzaGVkRGF0YSgpOyB9CgogICAgdGhpcy5zdXNwZW5kUmVsYXRpb25zaGlwT2JzZXJ2ZXJzKGZ1bmN0aW9uKCkgewogICAgICB0aGlzLm5vdGlmeVByb3BlcnR5Q2hhbmdlKCdkYXRhJyk7CiAgICB9KTsKICB9LAoKICBtYXRlcmlhbGl6ZUlkOiBmdW5jdGlvbihpZCkgewogICAgc2V0KHRoaXMsICdpZCcsIGlkKTsKICB9LAoKICBtYXRlcmlhbGl6ZUF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGF0dHJpYnV0ZXMpIHsKICAgIEVtYmVyLmFzc2VydCgiTXVzdCBwYXNzIGEgaGFzaCBvZiBhdHRyaWJ1dGVzIHRvIG1hdGVyaWFsaXplQXR0cmlidXRlcyIsICEhYXR0cmlidXRlcyk7CiAgICBtZXJnZSh0aGlzLl9kYXRhLCBhdHRyaWJ1dGVzKTsKICB9LAoKICBtYXRlcmlhbGl6ZUF0dHJpYnV0ZTogZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgIHRoaXMuX2RhdGFbbmFtZV0gPSB2YWx1ZTsKICB9LAoKICAvKioKICAgIEBtZXRob2QgdXBkYXRlSGFzTWFueQogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lCiAgICBAcGFyYW0ge0FycmF5fSByZWNvcmRzCiAgKi8KICB1cGRhdGVIYXNNYW55OiBmdW5jdGlvbihuYW1lLCByZWNvcmRzKSB7CiAgICB0aGlzLl9kYXRhW25hbWVdID0gcmVjb3JkczsKICAgIHRoaXMuaGFzTWFueURpZENoYW5nZShuYW1lKTsKICB9LAoKICAvKioKICAgIEBtZXRob2QgdXBkYXRlQmVsb25nc1RvCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUKICAgIEBwYXJhbSB7RFMuTW9kZWx9IHJlY29yZAogICovCiAgdXBkYXRlQmVsb25nc1RvOiBmdW5jdGlvbihuYW1lLCByZWNvcmQpIHsKICAgIHRoaXMuX2RhdGFbbmFtZV0gPSByZWNvcmQ7CiAgfSwKCiAgLyoqCiAgICBJZiB0aGUgbW9kZWwgYGlzRGlydHlgIHRoaXMgZnVuY3Rpb24gd2lsbCB3aGljaCBkaXNjYXJkIGFueSB1bnNhdmVkCiAgICBjaGFuZ2VzCgogICAgRXhhbXBsZQoKICAgIGBgYGphdmFzY3JpcHQKICAgIHJlY29yZC5nZXQoJ25hbWUnKTsgLy8gJ1VudGl0bGVkIERvY3VtZW50JwogICAgcmVjb3JkLnNldCgnbmFtZScsICdEb2MgMScpOwogICAgcmVjb3JkLmdldCgnbmFtZScpOyAvLyAnRG9jIDEnCiAgICByZWNvcmQucm9sbGJhY2soKTsKICAgIHJlY29yZC5nZXQoJ25hbWUnKTsgLy8gJ1VudGl0bGVkIERvY3VtZW50JwogICAgYGBgCgogICAgQG1ldGhvZCByb2xsYmFjawogICovCiAgcm9sbGJhY2s6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fYXR0cmlidXRlcyA9IHt9OwoKICAgIGlmIChnZXQodGhpcywgJ2lzRXJyb3InKSkgewogICAgICB0aGlzLl9pbkZsaWdodEF0dHJpYnV0ZXMgPSB7fTsKICAgICAgc2V0KHRoaXMsICdpc0Vycm9yJywgZmFsc2UpOwogICAgfQoKICAgIGlmICghZ2V0KHRoaXMsICdpc1ZhbGlkJykpIHsKICAgICAgdGhpcy5faW5GbGlnaHRBdHRyaWJ1dGVzID0ge307CiAgICB9CgogICAgdGhpcy5zZW5kKCdyb2xsZWRCYWNrJyk7CgogICAgdGhpcy5zdXNwZW5kUmVsYXRpb25zaGlwT2JzZXJ2ZXJzKGZ1bmN0aW9uKCkgewogICAgICB0aGlzLm5vdGlmeVByb3BlcnR5Q2hhbmdlKCdkYXRhJyk7CiAgICB9KTsKICB9LAoKICB0b1N0cmluZ0V4dGVuc2lvbjogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gZ2V0KHRoaXMsICdpZCcpOwogIH0sCgogIC8qKgogICAgVGhlIGdvYWwgb2YgdGhpcyBtZXRob2QgaXMgdG8gdGVtcG9yYXJpbHkgZGlzYWJsZSBzcGVjaWZpYyBvYnNlcnZlcnMKICAgIHRoYXQgdGFrZSBhY3Rpb24gaW4gcmVzcG9uc2UgdG8gYXBwbGljYXRpb24gY2hhbmdlcy4KCiAgICBUaGlzIGFsbG93cyB0aGUgc3lzdGVtIHRvIG1ha2UgY2hhbmdlcyAoc3VjaCBhcyBtYXRlcmlhbGl6YXRpb24gYW5kCiAgICByb2xsYmFjaykgdGhhdCBzaG91bGQgbm90IHRyaWdnZXIgc2Vjb25kYXJ5IGJlaGF2aW9yIChzdWNoIGFzIHNldHRpbmcgYW4KICAgIGludmVyc2UgcmVsYXRpb25zaGlwIG9yIG1hcmtpbmcgcmVjb3JkcyBhcyBkaXJ0eSkuCgogICAgVGhlIHNwZWNpZmljIGltcGxlbWVudGF0aW9uIHdpbGwgbGlrZWx5IGNoYW5nZSBhcyBFbWJlciBwcm9wZXIgcHJvdmlkZXMKICAgIGJldHRlciBpbmZyYXN0cnVjdHVyZSBmb3Igc3VzcGVuZGluZyBncm91cHMgb2Ygb2JzZXJ2ZXJzLCBhbmQgaWYgQXJyYXkKICAgIG9ic2VydmF0aW9uIGJlY29tZXMgbW9yZSB1bmlmaWVkIHdpdGggcmVndWxhciBvYnNlcnZlcnMuCgogICAgQG1ldGhvZCBzdXNwZW5kUmVsYXRpb25zaGlwT2JzZXJ2ZXJzCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIGNhbGxiYWNrCiAgICBAcGFyYW0gYmluZGluZwogICovCiAgc3VzcGVuZFJlbGF0aW9uc2hpcE9ic2VydmVyczogZnVuY3Rpb24oY2FsbGJhY2ssIGJpbmRpbmcpIHsKICAgIHZhciBvYnNlcnZlcnMgPSBnZXQodGhpcy5jb25zdHJ1Y3RvciwgJ3JlbGF0aW9uc2hpcE5hbWVzJykuYmVsb25nc1RvOwogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHRyeSB7CiAgICAgIHRoaXMuX3N1c3BlbmRlZFJlbGF0aW9uc2hpcHMgPSB0cnVlOwogICAgICBFbWJlci5fc3VzcGVuZE9ic2VydmVycyhzZWxmLCBvYnNlcnZlcnMsIG51bGwsICdiZWxvbmdzVG9EaWRDaGFuZ2UnLCBmdW5jdGlvbigpIHsKICAgICAgICBFbWJlci5fc3VzcGVuZEJlZm9yZU9ic2VydmVycyhzZWxmLCBvYnNlcnZlcnMsIG51bGwsICdiZWxvbmdzVG9XaWxsQ2hhbmdlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBjYWxsYmFjay5jYWxsKGJpbmRpbmcgfHwgc2VsZik7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5fc3VzcGVuZGVkUmVsYXRpb25zaGlwcyA9IGZhbHNlOwogICAgfQogIH0sCgogIC8qKgogICAgU2F2ZSB0aGUgcmVjb3JkIGFuZCBwZXJzaXN0IGFueSBjaGFuZ2VzIHRvIHRoZSByZWNvcmQgdG8gYW4KICAgIGV4dGVuYWwgc291cmNlIHZpYSB0aGUgYWRhcHRlci4KCiAgICBFeGFtcGxlCgogICAgYGBgamF2YXNjcmlwdAogICAgcmVjb3JkLnNldCgnbmFtZScsICdUb21zdGVyJyk7CiAgICByZWNvcmQuc2F2ZSgpLnRoZW4oZnVuY3Rpb24oKXsKICAgICAgLy8gU3VjY2VzcyBjYWxsYmFjawogICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgIC8vIEVycm9yIGNhbGxiYWNrCiAgICB9KTsKICAgIGBgYAogICAgQG1ldGhvZCBzYXZlCiAgICBAcmV0dXJuIHtQcm9taXNlfSBhIHByb21pc2UgdGhhdCB3aWxsIGJlIHJlc29sdmVkIHdoZW4gdGhlIGFkYXB0ZXIgcmV0dXJucwogICAgc3VjY2Vzc2Z1bGx5IG9yIHJlamVjdGVkIGlmIHRoZSBhZGFwdGVyIHJldHVybnMgd2l0aCBhbiBlcnJvci4KICAqLwogIHNhdmU6IGZ1bmN0aW9uKCkgewogICAgdmFyIHByb21pc2VMYWJlbCA9ICJEUzogTW9kZWwjc2F2ZSAiICsgdGhpczsKICAgIHZhciByZXNvbHZlciA9IEVtYmVyLlJTVlAuZGVmZXIocHJvbWlzZUxhYmVsKTsKCiAgICB0aGlzLmdldCgnc3RvcmUnKS5zY2hlZHVsZVNhdmUodGhpcywgcmVzb2x2ZXIpOwogICAgdGhpcy5faW5GbGlnaHRBdHRyaWJ1dGVzID0gdGhpcy5fYXR0cmlidXRlczsKICAgIHRoaXMuX2F0dHJpYnV0ZXMgPSB7fTsKCiAgICByZXR1cm4gRFMuUHJvbWlzZU9iamVjdC5jcmVhdGUoeyBwcm9taXNlOiByZXNvbHZlci5wcm9taXNlIH0pOwogIH0sCgogIC8qKgogICAgUmVsb2FkIHRoZSByZWNvcmQgZnJvbSB0aGUgYWRhcHRlci4KCiAgICBUaGlzIHdpbGwgb25seSB3b3JrIGlmIHRoZSByZWNvcmQgaGFzIGFscmVhZHkgZmluaXNoZWQgbG9hZGluZwogICAgYW5kIGhhcyBub3QgeWV0IGJlZW4gbW9kaWZpZWQgKGBpc0xvYWRlZGAgYnV0IG5vdCBgaXNEaXJ0eWAsCiAgICBvciBgaXNTYXZpbmdgKS4KCiAgICBFeGFtcGxlCgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLk1vZGVsVmlld1JvdXRlID0gRW1iZXIuUm91dGUuZXh0ZW5kKHsKICAgICAgYWN0aW9uczogewogICAgICAgIHJlbG9hZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLmdldCgnbW9kZWwnKS5yZWxvYWQoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgQG1ldGhvZCByZWxvYWQKICAgIEByZXR1cm4ge1Byb21pc2V9IGEgcHJvbWlzZSB0aGF0IHdpbGwgYmUgcmVzb2x2ZWQgd2l0aCB0aGUgcmVjb3JkIHdoZW4gdGhlCiAgICBhZGFwdGVyIHJldHVybnMgc3VjY2Vzc2Z1bGx5IG9yIHJlamVjdGVkIGlmIHRoZSBhZGFwdGVyIHJldHVybnMKICAgIHdpdGggYW4gZXJyb3IuCiAgKi8KICByZWxvYWQ6IGZ1bmN0aW9uKCkgewogICAgc2V0KHRoaXMsICdpc1JlbG9hZGluZycsIHRydWUpOwoKICAgIHZhciAgcmVjb3JkID0gdGhpczsKCiAgICB2YXIgcHJvbWlzZUxhYmVsID0gIkRTOiBNb2RlbCNyZWxvYWQgb2YgIiArIHRoaXM7CiAgICB2YXIgcHJvbWlzZSA9IG5ldyBFbWJlci5SU1ZQLlByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSl7CiAgICAgICByZWNvcmQuc2VuZCgncmVsb2FkUmVjb3JkJywgcmVzb2x2ZSk7CiAgICB9LCBwcm9taXNlTGFiZWwpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgIHJlY29yZC5zZXQoJ2lzUmVsb2FkaW5nJywgZmFsc2UpOwogICAgICByZWNvcmQuc2V0KCdpc0Vycm9yJywgZmFsc2UpOwogICAgICByZXR1cm4gcmVjb3JkOwogICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgIHJlY29yZC5zZXQoJ2lzRXJyb3InLCB0cnVlKTsKICAgICAgdGhyb3cgcmVhc29uOwogICAgfSwgIkRTOiBNb2RlbCNyZWxvYWQgY29tcGxldGUsIHVwZGF0ZSBmbGFncyIpOwoKICAgIHJldHVybiBEUy5Qcm9taXNlT2JqZWN0LmNyZWF0ZSh7IHByb21pc2U6IHByb21pc2UgfSk7CiAgfSwKCiAgLy8gRk9SIFVTRSBEVVJJTkcgQ09NTUlUIFBST0NFU1MKCiAgYWRhcHRlckRpZFVwZGF0ZUF0dHJpYnV0ZTogZnVuY3Rpb24oYXR0cmlidXRlTmFtZSwgdmFsdWUpIHsKCiAgICAvLyBJZiBhIHZhbHVlIGlzIHBhc3NlZCBpbiwgdXBkYXRlIHRoZSBpbnRlcm5hbCBhdHRyaWJ1dGVzIGFuZCBjbGVhcgogICAgLy8gdGhlIGF0dHJpYnV0ZSBjYWNoZSBzbyBpdCBwaWNrcyB1cCB0aGUgbmV3IHZhbHVlLiBPdGhlcndpc2UsCiAgICAvLyBjb2xsYXBzZSB0aGUgY3VycmVudCB2YWx1ZSBpbnRvIHRoZSBpbnRlcm5hbCBhdHRyaWJ1dGVzIGJlY2F1c2UKICAgIC8vIHRoZSBhZGFwdGVyIGhhcyBhY2tub3dsZWRnZWQgaXQuCiAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICB0aGlzLl9kYXRhW2F0dHJpYnV0ZU5hbWVdID0gdmFsdWU7CiAgICAgIHRoaXMubm90aWZ5UHJvcGVydHlDaGFuZ2UoYXR0cmlidXRlTmFtZSk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLl9kYXRhW2F0dHJpYnV0ZU5hbWVdID0gdGhpcy5faW5GbGlnaHRBdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdOwogICAgfQoKICAgIHRoaXMudXBkYXRlUmVjb3JkQXJyYXlzTGF0ZXIoKTsKICB9LAoKICAvKioKICAgIEBtZXRob2QgYWRhcHRlckRpZEludmFsaWRhdGUKICAgIEBwcml2YXRlCiAgKi8KICBhZGFwdGVyRGlkSW52YWxpZGF0ZTogZnVuY3Rpb24oZXJyb3JzKSB7CiAgICB2YXIgcmVjb3JkRXJyb3JzID0gZ2V0KHRoaXMsICdlcnJvcnMnKTsKICAgIGZ1bmN0aW9uIGFkZEVycm9yKG5hbWUpIHsKICAgICAgaWYgKGVycm9yc1tuYW1lXSkgewogICAgICAgIHJlY29yZEVycm9ycy5hZGQobmFtZSwgZXJyb3JzW25hbWVdKTsKICAgICAgfQogICAgfQoKICAgIHRoaXMuZWFjaEF0dHJpYnV0ZShhZGRFcnJvcik7CiAgICB0aGlzLmVhY2hSZWxhdGlvbnNoaXAoYWRkRXJyb3IpOwogIH0sCgogIC8qKgogICAgQG1ldGhvZCBhZGFwdGVyRGlkRXJyb3IKICAgIEBwcml2YXRlCiAgKi8KICBhZGFwdGVyRGlkRXJyb3I6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5zZW5kKCdiZWNhbWVFcnJvcicpOwogICAgc2V0KHRoaXMsICdpc0Vycm9yJywgdHJ1ZSk7CiAgfSwKCiAgLyoqCiAgICBPdmVycmlkZSB0aGUgZGVmYXVsdCBldmVudCBmaXJpbmcgZnJvbSBFbWJlci5FdmVudGVkIHRvCiAgICBhbHNvIGNhbGwgbWV0aG9kcyB3aXRoIHRoZSBnaXZlbiBuYW1lLgoKICAgIEBtZXRob2QgdHJpZ2dlcgogICAgQHByaXZhdGUKICAgIEBwYXJhbSBuYW1lCiAgKi8KICB0cmlnZ2VyOiBmdW5jdGlvbihuYW1lKSB7CiAgICBFbWJlci50cnlJbnZva2UodGhpcywgbmFtZSwgW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfSwKCiAgdHJpZ2dlckxhdGVyOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2RlZmVycmVkVHJpZ2dlcnMucHVzaChhcmd1bWVudHMpOwogICAgb25jZSh0aGlzLCAnX3RyaWdnZXJEZWZlcnJlZFRyaWdnZXJzJyk7CiAgfSwKCiAgX3RyaWdnZXJEZWZlcnJlZFRyaWdnZXJzOiBmdW5jdGlvbigpIHsKICAgIGZvciAodmFyIGk9MCwgbD10aGlzLl9kZWZlcnJlZFRyaWdnZXJzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgdGhpcy50cmlnZ2VyLmFwcGx5KHRoaXMsIHRoaXMuX2RlZmVycmVkVHJpZ2dlcnNbaV0pOwogICAgfQoKICAgIHRoaXMuX2RlZmVycmVkVHJpZ2dlcnMgPSBbXTsKICB9Cn0pOwoKRFMuTW9kZWwucmVvcGVuQ2xhc3MoewoKICAvKioKICAgIEFsaWFzIERTLk1vZGVsJ3MgYGNyZWF0ZWAgbWV0aG9kIHRvIGBfY3JlYXRlYC4gVGhpcyBhbGxvd3MgdXMgdG8gY3JlYXRlIERTLk1vZGVsCiAgICBpbnN0YW5jZXMgZnJvbSB3aXRoaW4gdGhlIHN0b3JlLCBidXQgaWYgZW5kIHVzZXJzIGFjY2lkZW50YWxseSBjYWxsIGBjcmVhdGUoKWAKICAgIChpbnN0ZWFkIG9mIGBjcmVhdGVSZWNvcmQoKWApLCB3ZSBjYW4gcmFpc2UgYW4gZXJyb3IuCgogICAgQG1ldGhvZCBfY3JlYXRlCiAgICBAcHJpdmF0ZQogICAgQHN0YXRpYwogICovCiAgX2NyZWF0ZTogRFMuTW9kZWwuY3JlYXRlLAoKICAvKioKICAgIE92ZXJyaWRlIHRoZSBjbGFzcycgYGNyZWF0ZSgpYCBtZXRob2QgdG8gcmFpc2UgYW4gZXJyb3IuIFRoaXMKICAgIHByZXZlbnRzIGVuZCB1c2VycyBmcm9tIGluYWR2ZXJ0ZW50bHkgY2FsbGluZyBgY3JlYXRlKClgIGluc3RlYWQKICAgIG9mIGBjcmVhdGVSZWNvcmQoKWAuIFRoZSBzdG9yZSBpcyBzdGlsbCBhYmxlIHRvIGNyZWF0ZSBpbnN0YW5jZXMKICAgIGJ5IGNhbGxpbmcgdGhlIGBfY3JlYXRlKClgIG1ldGhvZC4gVG8gY3JlYXRlIGFuIGluc3RhbmNlIG9mIGEKICAgIGBEUy5Nb2RlbGAgdXNlIFtzdG9yZS5jcmVhdGVSZWNvcmRdKERTLlN0b3JlLmh0bWwjbWV0aG9kX2NyZWF0ZVJlY29yZCkuCgogICAgQG1ldGhvZCBjcmVhdGUKICAgIEBwcml2YXRlCiAgICBAc3RhdGljCiAgKi8KICBjcmVhdGU6IGZ1bmN0aW9uKCkgewogICAgdGhyb3cgbmV3IEVtYmVyLkVycm9yKCJZb3Ugc2hvdWxkIG5vdCBjYWxsIGBjcmVhdGVgIG9uIGEgbW9kZWwuIEluc3RlYWQsIGNhbGwgYHN0b3JlLmNyZWF0ZVJlY29yZGAgd2l0aCB0aGUgYXR0cmlidXRlcyB5b3Ugd291bGQgbGlrZSB0byBzZXQuIik7CiAgfQp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCiAgQG1vZHVsZSBlbWJlci1kYXRhCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0OwoKLyoqCiAgQGNsYXNzIE1vZGVsCiAgQG5hbWVzcGFjZSBEUwoqLwpEUy5Nb2RlbC5yZW9wZW5DbGFzcyh7CiAgLyoqCiAgICBBIG1hcCB3aG9zZSBrZXlzIGFyZSB0aGUgYXR0cmlidXRlcyBvZiB0aGUgbW9kZWwgKHByb3BlcnRpZXMKICAgIGRlc2NyaWJlZCBieSBEUy5hdHRyKSBhbmQgd2hvc2UgdmFsdWVzIGFyZSB0aGUgbWV0YSBvYmplY3QgZm9yIHRoZQogICAgcHJvcGVydHkuCgogICAgRXhhbXBsZQoKICAgIGBgYGphdmFzY3JpcHQKCiAgICBBcHAuUGVyc29uID0gRFMuTW9kZWwuZXh0ZW5kKHsKICAgICAgZmlyc3ROYW1lOiBhdHRyKCdzdHJpbmcnKSwKICAgICAgbGFzdE5hbWU6IGF0dHIoJ3N0cmluZycpLAogICAgICBiaXJ0aGRheTogYXR0cignZGF0ZScpCiAgICB9KTsKCiAgICB2YXIgYXR0cmlidXRlcyA9IEVtYmVyLmdldChBcHAuUGVyc29uLCAnYXR0cmlidXRlcycpCgogICAgYXR0cmlidXRlcy5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUsIG1ldGEpIHsKICAgICAgY29uc29sZS5sb2cobmFtZSwgbWV0YSk7CiAgICB9KTsKCiAgICAvLyBwcmludHM6CiAgICAvLyBmaXJzdE5hbWUge3R5cGU6ICJzdHJpbmciLCBpc0F0dHJpYnV0ZTogdHJ1ZSwgb3B0aW9uczogT2JqZWN0LCBwYXJlbnRUeXBlOiBmdW5jdGlvbiwgbmFtZTogImZpcnN0TmFtZSJ9CiAgICAvLyBsYXN0TmFtZSB7dHlwZTogInN0cmluZyIsIGlzQXR0cmlidXRlOiB0cnVlLCBvcHRpb25zOiBPYmplY3QsIHBhcmVudFR5cGU6IGZ1bmN0aW9uLCBuYW1lOiAibGFzdE5hbWUifQogICAgLy8gYmlydGhkYXkge3R5cGU6ICJkYXRlIiwgaXNBdHRyaWJ1dGU6IHRydWUsIG9wdGlvbnM6IE9iamVjdCwgcGFyZW50VHlwZTogZnVuY3Rpb24sIG5hbWU6ICJiaXJ0aGRheSJ9CiAgICBgYGAKCiAgICBAcHJvcGVydHkgYXR0cmlidXRlcwogICAgQHN0YXRpYwogICAgQHR5cGUge0VtYmVyLk1hcH0KICAgIEByZWFkT25seQogICovCiAgYXR0cmlidXRlczogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oKSB7CiAgICB2YXIgbWFwID0gRW1iZXIuTWFwLmNyZWF0ZSgpOwoKICAgIHRoaXMuZWFjaENvbXB1dGVkUHJvcGVydHkoZnVuY3Rpb24obmFtZSwgbWV0YSkgewogICAgICBpZiAobWV0YS5pc0F0dHJpYnV0ZSkgewogICAgICAgIEVtYmVyLmFzc2VydCgiWW91IG1heSBub3Qgc2V0IGBpZGAgYXMgYW4gYXR0cmlidXRlIG9uIHlvdXIgbW9kZWwuIFBsZWFzZSByZW1vdmUgYW55IGxpbmVzIHRoYXQgbG9vayBsaWtlOiBgaWQ6IERTLmF0dHIoJzx0eXBlPicpYCBmcm9tICIgKyB0aGlzLnRvU3RyaW5nKCksIG5hbWUgIT09ICdpZCcpOwoKICAgICAgICBtZXRhLm5hbWUgPSBuYW1lOwogICAgICAgIG1hcC5zZXQobmFtZSwgbWV0YSk7CiAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybiBtYXA7CiAgfSksCgogIC8qKgogICAgQSBtYXAgd2hvc2Uga2V5cyBhcmUgdGhlIGF0dHJpYnV0ZXMgb2YgdGhlIG1vZGVsIChwcm9wZXJ0aWVzCiAgICBkZXNjcmliZWQgYnkgRFMuYXR0cikgYW5kIHdob3NlIHZhbHVlcyBhcmUgdHlwZSBvZiB0cmFuc2Zvcm1hdGlvbgogICAgYXBwbGllZCB0byBlYWNoIGF0dHJpYnV0ZS4gVGhpcyBtYXAgZG9lcyBub3QgaW5jbHVkZSBhbnkKICAgIGF0dHJpYnV0ZXMgdGhhdCBkbyBub3QgaGF2ZSBhbiB0cmFuc2Zvcm1hdGlvbiB0eXBlLgoKICAgIEV4YW1wbGUKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuUGVyc29uID0gRFMuTW9kZWwuZXh0ZW5kKHsKICAgICAgZmlyc3ROYW1lOiBhdHRyKCksCiAgICAgIGxhc3ROYW1lOiBhdHRyKCdzdHJpbmcnKSwKICAgICAgYmlydGhkYXk6IGF0dHIoJ2RhdGUnKQogICAgfSk7CgogICAgdmFyIHRyYW5zZm9ybWVkQXR0cmlidXRlcyA9IEVtYmVyLmdldChBcHAuUGVyc29uLCAndHJhbnNmb3JtZWRBdHRyaWJ1dGVzJykKCiAgICB0cmFuc2Zvcm1lZEF0dHJpYnV0ZXMuZm9yRWFjaChmdW5jdGlvbihmaWVsZCwgdHlwZSkgewogICAgICBjb25zb2xlLmxvZyhmaWVsZCwgdHlwZSk7CiAgICB9KTsKCiAgICAvLyBwcmludHM6CiAgICAvLyBsYXN0TmFtZSBzdHJpbmcKICAgIC8vIGJpcnRoZGF5IGRhdGUKICAgIGBgYAoKICAgIEBwcm9wZXJ0eSB0cmFuc2Zvcm1lZEF0dHJpYnV0ZXMKICAgIEBzdGF0aWMKICAgIEB0eXBlIHtFbWJlci5NYXB9CiAgICBAcmVhZE9ubHkKICAqLwogIHRyYW5zZm9ybWVkQXR0cmlidXRlczogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oKSB7CiAgICB2YXIgbWFwID0gRW1iZXIuTWFwLmNyZWF0ZSgpOwoKICAgIHRoaXMuZWFjaEF0dHJpYnV0ZShmdW5jdGlvbihrZXksIG1ldGEpIHsKICAgICAgaWYgKG1ldGEudHlwZSkgewogICAgICAgIG1hcC5zZXQoa2V5LCBtZXRhLnR5cGUpOwogICAgICB9CiAgICB9KTsKCiAgICByZXR1cm4gbWFwOwogIH0pLAoKICAvKioKICAgIEl0ZXJhdGVzIHRocm91Z2ggdGhlIGF0dHJpYnV0ZXMgb2YgdGhlIG1vZGVsLCBjYWxsaW5nIHRoZSBwYXNzZWQgZnVuY3Rpb24gb24gZWFjaAogICAgYXR0cmlidXRlLgoKICAgIFRoZSBjYWxsYmFjayBtZXRob2QgeW91IHByb3ZpZGUgc2hvdWxkIGhhdmUgdGhlIGZvbGxvd2luZyBzaWduYXR1cmUgKGFsbAogICAgcGFyYW1ldGVycyBhcmUgb3B0aW9uYWwpOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIGZ1bmN0aW9uKG5hbWUsIG1ldGEpOwogICAgYGBgCgogICAgLSBgbmFtZWAgdGhlIG5hbWUgb2YgdGhlIGN1cnJlbnQgcHJvcGVydHkgaW4gdGhlIGl0ZXJhdGlvbgogICAgLSBgbWV0YWAgdGhlIG1ldGEgb2JqZWN0IGZvciB0aGUgYXR0cmlidXRlIHByb3BlcnR5IGluIHRoZSBpdGVyYXRpb24KCiAgICBOb3RlIHRoYXQgaW4gYWRkaXRpb24gdG8gYSBjYWxsYmFjaywgeW91IGNhbiBhbHNvIHBhc3MgYW4gb3B0aW9uYWwgdGFyZ2V0CiAgICBvYmplY3QgdGhhdCB3aWxsIGJlIHNldCBhcyBgdGhpc2Agb24gdGhlIGNvbnRleHQuCgogICAgRXhhbXBsZQoKICAgIGBgYGphdmFzY3JpcHQKICAgIEFwcC5QZXJzb24gPSBEUy5Nb2RlbC5leHRlbmQoewogICAgICBmaXJzdE5hbWU6IGF0dHIoJ3N0cmluZycpLAogICAgICBsYXN0TmFtZTogYXR0cignc3RyaW5nJyksCiAgICAgIGJpcnRoZGF5OiBhdHRyKCdkYXRlJykKICAgIH0pOwoKICAgIEFwcC5QZXJzb24uZWFjaEF0dHJpYnV0ZShmdW5jdGlvbihuYW1lLCBtZXRhKSB7CiAgICAgIGNvbnNvbGUubG9nKG5hbWUsIG1ldGEpOwogICAgfSk7CgogICAgLy8gcHJpbnRzOgogICAgLy8gZmlyc3ROYW1lIHt0eXBlOiAic3RyaW5nIiwgaXNBdHRyaWJ1dGU6IHRydWUsIG9wdGlvbnM6IE9iamVjdCwgcGFyZW50VHlwZTogZnVuY3Rpb24sIG5hbWU6ICJmaXJzdE5hbWUifQogICAgLy8gbGFzdE5hbWUge3R5cGU6ICJzdHJpbmciLCBpc0F0dHJpYnV0ZTogdHJ1ZSwgb3B0aW9uczogT2JqZWN0LCBwYXJlbnRUeXBlOiBmdW5jdGlvbiwgbmFtZTogImxhc3ROYW1lIn0KICAgIC8vIGJpcnRoZGF5IHt0eXBlOiAiZGF0ZSIsIGlzQXR0cmlidXRlOiB0cnVlLCBvcHRpb25zOiBPYmplY3QsIHBhcmVudFR5cGU6IGZ1bmN0aW9uLCBuYW1lOiAiYmlydGhkYXkifQogICBgYGAKCiAgICBAbWV0aG9kIGVhY2hBdHRyaWJ1dGUKICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayB0byBleGVjdXRlCiAgICBAcGFyYW0ge09iamVjdH0gW3RhcmdldF0gVGhlIHRhcmdldCBvYmplY3QgdG8gdXNlCiAgICBAc3RhdGljCiAgKi8KICBlYWNoQXR0cmlidXRlOiBmdW5jdGlvbihjYWxsYmFjaywgYmluZGluZykgewogICAgZ2V0KHRoaXMsICdhdHRyaWJ1dGVzJykuZm9yRWFjaChmdW5jdGlvbihuYW1lLCBtZXRhKSB7CiAgICAgIGNhbGxiYWNrLmNhbGwoYmluZGluZywgbmFtZSwgbWV0YSk7CiAgICB9LCBiaW5kaW5nKTsKICB9LAoKICAvKioKICAgIEl0ZXJhdGVzIHRocm91Z2ggdGhlIHRyYW5zZm9ybWVkQXR0cmlidXRlcyBvZiB0aGUgbW9kZWwsIGNhbGxpbmcKICAgIHRoZSBwYXNzZWQgZnVuY3Rpb24gb24gZWFjaCBhdHRyaWJ1dGUuIE5vdGUgdGhlIGNhbGxiYWNrIHdpbGwgbm90IGJlCiAgICBjYWxsZWQgZm9yIGFueSBhdHRyaWJ1dGVzIHRoYXQgZG8gbm90IGhhdmUgYW4gdHJhbnNmb3JtYXRpb24gdHlwZS4KCiAgICBUaGUgY2FsbGJhY2sgbWV0aG9kIHlvdSBwcm92aWRlIHNob3VsZCBoYXZlIHRoZSBmb2xsb3dpbmcgc2lnbmF0dXJlIChhbGwKICAgIHBhcmFtZXRlcnMgYXJlIG9wdGlvbmFsKToKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBmdW5jdGlvbihuYW1lLCB0eXBlKTsKICAgIGBgYAoKICAgIC0gYG5hbWVgIHRoZSBuYW1lIG9mIHRoZSBjdXJyZW50IHByb3BlcnR5IGluIHRoZSBpdGVyYXRpb24KICAgIC0gYHR5cGVgIGEgdHJpbmcgY29udHJpbmluZyB0aGUgbmFtZSBvZiB0aGUgdHlwZSBvZiB0cmFuc2Zvcm1lZAogICAgICBhcHBsaWVkIHRvIHRoZSBhdHRyaWJ1dGUKCiAgICBOb3RlIHRoYXQgaW4gYWRkaXRpb24gdG8gYSBjYWxsYmFjaywgeW91IGNhbiBhbHNvIHBhc3MgYW4gb3B0aW9uYWwgdGFyZ2V0CiAgICBvYmplY3QgdGhhdCB3aWxsIGJlIHNldCBhcyBgdGhpc2Agb24gdGhlIGNvbnRleHQuCgogICAgRXhhbXBsZQoKICAgIGBgYGphdmFzY3JpcHQKICAgIEFwcC5QZXJzb24gPSBEUy5Nb2RlbC5leHRlbmQoewogICAgICBmaXJzdE5hbWU6IGF0dHIoKSwKICAgICAgbGFzdE5hbWU6IGF0dHIoJ3N0cmluZycpLAogICAgICBiaXJ0aGRheTogYXR0cignZGF0ZScpCiAgICB9KTsKCiAgICBBcHAuUGVyc29uLmVhY2hUcmFuc2Zvcm1lZEF0dHJpYnV0ZShmdW5jdGlvbihuYW1lLCB0eXBlKSB7CiAgICAgIGNvbnNvbGUubG9nKG5hbWUsIHR5cGUpOwogICAgfSk7CgogICAgLy8gcHJpbnRzOgogICAgLy8gbGFzdE5hbWUgc3RyaW5nCiAgICAvLyBiaXJ0aGRheSBkYXRlCiAgIGBgYAoKICAgIEBtZXRob2QgZWFjaFRyYW5zZm9ybWVkQXR0cmlidXRlCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgdG8gZXhlY3V0ZQogICAgQHBhcmFtIHtPYmplY3R9IFt0YXJnZXRdIFRoZSB0YXJnZXQgb2JqZWN0IHRvIHVzZQogICAgQHN0YXRpYwogICovCiAgZWFjaFRyYW5zZm9ybWVkQXR0cmlidXRlOiBmdW5jdGlvbihjYWxsYmFjaywgYmluZGluZykgewogICAgZ2V0KHRoaXMsICd0cmFuc2Zvcm1lZEF0dHJpYnV0ZXMnKS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUsIHR5cGUpIHsKICAgICAgY2FsbGJhY2suY2FsbChiaW5kaW5nLCBuYW1lLCB0eXBlKTsKICAgIH0pOwogIH0KfSk7CgoKRFMuTW9kZWwucmVvcGVuKHsKICBlYWNoQXR0cmlidXRlOiBmdW5jdGlvbihjYWxsYmFjaywgYmluZGluZykgewogICAgdGhpcy5jb25zdHJ1Y3Rvci5lYWNoQXR0cmlidXRlKGNhbGxiYWNrLCBiaW5kaW5nKTsKICB9Cn0pOwoKZnVuY3Rpb24gZ2V0RGVmYXVsdFZhbHVlKHJlY29yZCwgb3B0aW9ucywga2V5KSB7CiAgaWYgKHR5cGVvZiBvcHRpb25zLmRlZmF1bHRWYWx1ZSA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIG9wdGlvbnMuZGVmYXVsdFZhbHVlKCk7CiAgfSBlbHNlIHsKICAgIHJldHVybiBvcHRpb25zLmRlZmF1bHRWYWx1ZTsKICB9Cn0KCmZ1bmN0aW9uIGhhc1ZhbHVlKHJlY29yZCwga2V5KSB7CiAgcmV0dXJuIHJlY29yZC5fYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShrZXkpIHx8CiAgICAgICAgIHJlY29yZC5faW5GbGlnaHRBdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KGtleSkgfHwKICAgICAgICAgcmVjb3JkLl9kYXRhLmhhc093blByb3BlcnR5KGtleSk7Cn0KCmZ1bmN0aW9uIGdldFZhbHVlKHJlY29yZCwga2V5KSB7CiAgaWYgKHJlY29yZC5fYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICByZXR1cm4gcmVjb3JkLl9hdHRyaWJ1dGVzW2tleV07CiAgfSBlbHNlIGlmIChyZWNvcmQuX2luRmxpZ2h0QXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICByZXR1cm4gcmVjb3JkLl9pbkZsaWdodEF0dHJpYnV0ZXNba2V5XTsKICB9IGVsc2UgewogICAgcmV0dXJuIHJlY29yZC5fZGF0YVtrZXldOwogIH0KfQoKLyoqCiAgYERTLmF0dHJgIGRlZmluZXMgYW4gYXR0cmlidXRlIG9uIGEgW0RTLk1vZGVsXShEUy5Nb2RlbC5odG1sKS4KICBCeSBkZWZhdWx0LCBhdHRyaWJ1dGVzIGFyZSBwYXNzZWQgdGhyb3VnaCBhcy1pcywgaG93ZXZlciB5b3UgY2FuIHNwZWNpZnkgYW4KICBvcHRpb25hbCB0eXBlIHRvIGhhdmUgdGhlIHZhbHVlIGF1dG9tYXRpY2FsbHkgdHJhbnNmb3JtZWQuCiAgRW1iZXIgRGF0YSBzaGlwcyB3aXRoIGZvdXIgYmFzaWMgdHJhbnNmb3JtIHR5cGVzOiBgc3RyaW5nYCwgYG51bWJlcmAsCiAgYGJvb2xlYW5gIGFuZCBgZGF0ZWAuIFlvdSBjYW4gZGVmaW5lIHlvdXIgb3duIHRyYW5zZm9ybXMgYnkgc3ViY2xhc3NpbmcKICBbRFMuVHJhbnNmb3JtXShEUy5UcmFuc2Zvcm0uaHRtbCkuCgogIGBEUy5hdHRyYCB0YWtlcyBhbiBvcHRpb25hbCBoYXNoIGFzIGEgc2Vjb25kIHBhcmFtZXRlciwgY3VycmVudGx5CiAgc3VwcG9ydGVkIG9wdGlvbnMgYXJlOgoKICAtIGBkZWZhdWx0VmFsdWVgOiBQYXNzIGEgc3RyaW5nIG9yIGEgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHRvIHNldCB0aGUgYXR0cmlidXRlCiAgICAgICAgICAgICAgICAgICAgdG8gYSBkZWZhdWx0IHZhbHVlIGlmIG5vbmUgaXMgc3VwcGxpZWQuCgogIEV4YW1wbGUKCiAgYGBgamF2YXNjcmlwdAogIHZhciBhdHRyID0gRFMuYXR0cjsKCiAgQXBwLlVzZXIgPSBEUy5Nb2RlbC5leHRlbmQoewogICAgdXNlcm5hbWU6IGF0dHIoJ3N0cmluZycpLAogICAgZW1haWw6IGF0dHIoJ3N0cmluZycpLAogICAgdmVyaWZpZWQ6IGF0dHIoJ2Jvb2xlYW4nLCB7ZGVmYXVsdFZhbHVlOiBmYWxzZX0pCiAgfSk7CiAgYGBgCgogIEBuYW1lc3BhY2UKICBAbWV0aG9kIGF0dHIKICBAZm9yIERTCiAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgdGhlIGF0dHJpYnV0ZSB0eXBlCiAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgYSBoYXNoIG9mIG9wdGlvbnMKICBAcmV0dXJuIHtBdHRyaWJ1dGV9CiovCgpEUy5hdHRyID0gZnVuY3Rpb24odHlwZSwgb3B0aW9ucykgewogIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICB2YXIgbWV0YSA9IHsKICAgIHR5cGU6IHR5cGUsCiAgICBpc0F0dHJpYnV0ZTogdHJ1ZSwKICAgIG9wdGlvbnM6IG9wdGlvbnMKICB9OwoKICByZXR1cm4gRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CiAgICAgIEVtYmVyLmFzc2VydCgiWW91IG1heSBub3Qgc2V0IGBpZGAgYXMgYW4gYXR0cmlidXRlIG9uIHlvdXIgbW9kZWwuIFBsZWFzZSByZW1vdmUgYW55IGxpbmVzIHRoYXQgbG9vayBsaWtlOiBgaWQ6IERTLmF0dHIoJzx0eXBlPicpYCBmcm9tICIgKyB0aGlzLmNvbnN0cnVjdG9yLnRvU3RyaW5nKCksIGtleSAhPT0gJ2lkJyk7CiAgICAgIHZhciBvbGRWYWx1ZSA9IHRoaXMuX2F0dHJpYnV0ZXNba2V5XSB8fCB0aGlzLl9pbkZsaWdodEF0dHJpYnV0ZXNba2V5XSB8fCB0aGlzLl9kYXRhW2tleV07CgogICAgICB0aGlzLnNlbmQoJ2RpZFNldFByb3BlcnR5JywgewogICAgICAgIG5hbWU6IGtleSwKICAgICAgICBvbGRWYWx1ZTogb2xkVmFsdWUsCiAgICAgICAgb3JpZ2luYWxWYWx1ZTogdGhpcy5fZGF0YVtrZXldLAogICAgICAgIHZhbHVlOiB2YWx1ZQogICAgICB9KTsKCiAgICAgIHRoaXMuX2F0dHJpYnV0ZXNba2V5XSA9IHZhbHVlOwogICAgICByZXR1cm4gdmFsdWU7CiAgICB9IGVsc2UgaWYgKGhhc1ZhbHVlKHRoaXMsIGtleSkpIHsKICAgICAgcmV0dXJuIGdldFZhbHVlKHRoaXMsIGtleSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZ2V0RGVmYXVsdFZhbHVlKHRoaXMsIG9wdGlvbnMsIGtleSk7CiAgICB9CgogIC8vIGBkYXRhYCBpcyBuZXZlciBzZXQgZGlyZWN0bHkuIEhvd2V2ZXIsIGl0IG1heSBiZQogIC8vIGludmFsaWRhdGVkIGZyb20gdGhlIHN0YXRlIG1hbmFnZXIncyBzZXREYXRhCiAgLy8gZXZlbnQuCiAgfSkucHJvcGVydHkoJ2RhdGEnKS5tZXRhKG1ldGEpOwp9OwoKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCiAgQG1vZHVsZSBlbWJlci1kYXRhCiovCgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgogIEBtb2R1bGUgZW1iZXItZGF0YQoqLwoKLyoqCiAgQW4gQXR0cmlidXRlQ2hhbmdlIG9iamVjdCBpcyBjcmVhdGVkIHdoZW5ldmVyIGEgcmVjb3JkJ3MKICBhdHRyaWJ1dGUgY2hhbmdlcyB2YWx1ZS4gSXQgaXMgdXNlZCB0byB0cmFjayBjaGFuZ2VzIHRvIGEKICByZWNvcmQgYmV0d2VlbiB0cmFuc2FjdGlvbiBjb21taXRzLgoKICBAY2xhc3MgQXR0cmlidXRlQ2hhbmdlCiAgQG5hbWVzcGFjZSBEUwogIEBwcml2YXRlCiAgQGNvbnN0cnVjdG9yCiovCnZhciBBdHRyaWJ1dGVDaGFuZ2UgPSBEUy5BdHRyaWJ1dGVDaGFuZ2UgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgdGhpcy5yZWNvcmQgPSBvcHRpb25zLnJlY29yZDsKICB0aGlzLnN0b3JlID0gb3B0aW9ucy5zdG9yZTsKICB0aGlzLm5hbWUgPSBvcHRpb25zLm5hbWU7CiAgdGhpcy52YWx1ZSA9IG9wdGlvbnMudmFsdWU7CiAgdGhpcy5vbGRWYWx1ZSA9IG9wdGlvbnMub2xkVmFsdWU7Cn07CgpBdHRyaWJ1dGVDaGFuZ2UuY3JlYXRlQ2hhbmdlID0gZnVuY3Rpb24ob3B0aW9ucykgewogIHJldHVybiBuZXcgQXR0cmlidXRlQ2hhbmdlKG9wdGlvbnMpOwp9OwoKQXR0cmlidXRlQ2hhbmdlLnByb3RvdHlwZSA9IHsKICBzeW5jOiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLnZhbHVlICE9PSB0aGlzLm9sZFZhbHVlKSB7CiAgICAgIHRoaXMucmVjb3JkLnNlbmQoJ2JlY29tZURpcnR5Jyk7CiAgICAgIHRoaXMucmVjb3JkLnVwZGF0ZVJlY29yZEFycmF5c0xhdGVyKCk7CiAgICB9CgogICAgLy8gVE9ETzogVXNlIHRoaXMgb2JqZWN0IGluIHRoZSBjb21taXQgcHJvY2VzcwogICAgdGhpcy5kZXN0cm95KCk7CiAgfSwKCiAgLyoqCiAgICBJZiB0aGUgQXR0cmlidXRlQ2hhbmdlIGlzIGRlc3Ryb3llZCAoZWl0aGVyIGJ5IGJlaW5nIHJvbGxlZCBiYWNrCiAgICBvciBiZWluZyBjb21taXR0ZWQpLCByZW1vdmUgaXQgZnJvbSB0aGUgbGlzdCBvZiBwZW5kaW5nIGNoYW5nZXMKICAgIG9uIHRoZSByZWNvcmQuCgogICAgQG1ldGhvZCBkZXN0cm95CiAgKi8KICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgIGRlbGV0ZSB0aGlzLnJlY29yZC5fY2hhbmdlc1RvU3luY1t0aGlzLm5hbWVdOwogIH0KfTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCiAgQG1vZHVsZSBlbWJlci1kYXRhCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQ7CnZhciBmb3JFYWNoID0gRW1iZXIuRW51bWVyYWJsZVV0aWxzLmZvckVhY2g7CgovKioKICBAY2xhc3MgUmVsYXRpb25zaGlwQ2hhbmdlCiAgQG5hbWVzcGFjZSBEUwogIEBwcml2YXRlCiAgQGNvbnN0cnV0b3IKKi8KRFMuUmVsYXRpb25zaGlwQ2hhbmdlID0gZnVuY3Rpb24ob3B0aW9ucykgewogIHRoaXMucGFyZW50UmVjb3JkID0gb3B0aW9ucy5wYXJlbnRSZWNvcmQ7CiAgdGhpcy5jaGlsZFJlY29yZCA9IG9wdGlvbnMuY2hpbGRSZWNvcmQ7CiAgdGhpcy5maXJzdFJlY29yZCA9IG9wdGlvbnMuZmlyc3RSZWNvcmQ7CiAgdGhpcy5maXJzdFJlY29yZEtpbmQgPSBvcHRpb25zLmZpcnN0UmVjb3JkS2luZDsKICB0aGlzLmZpcnN0UmVjb3JkTmFtZSA9IG9wdGlvbnMuZmlyc3RSZWNvcmROYW1lOwogIHRoaXMuc2Vjb25kUmVjb3JkID0gb3B0aW9ucy5zZWNvbmRSZWNvcmQ7CiAgdGhpcy5zZWNvbmRSZWNvcmRLaW5kID0gb3B0aW9ucy5zZWNvbmRSZWNvcmRLaW5kOwogIHRoaXMuc2Vjb25kUmVjb3JkTmFtZSA9IG9wdGlvbnMuc2Vjb25kUmVjb3JkTmFtZTsKICB0aGlzLmNoYW5nZVR5cGUgPSBvcHRpb25zLmNoYW5nZVR5cGU7CiAgdGhpcy5zdG9yZSA9IG9wdGlvbnMuc3RvcmU7CgogIHRoaXMuY29tbWl0dGVkID0ge307Cn07CgovKioKICBAY2xhc3MgUmVsYXRpb25zaGlwQ2hhbmdlQWRkCiAgQG5hbWVzcGFjZSBEUwogIEBwcml2YXRlCiAgQGNvbnN0cnV0b3IKKi8KRFMuUmVsYXRpb25zaGlwQ2hhbmdlQWRkID0gZnVuY3Rpb24ob3B0aW9ucyl7CiAgRFMuUmVsYXRpb25zaGlwQ2hhbmdlLmNhbGwodGhpcywgb3B0aW9ucyk7Cn07CgovKioKICBAY2xhc3MgUmVsYXRpb25zaGlwQ2hhbmdlUmVtb3ZlCiAgQG5hbWVzcGFjZSBEUwogIEBwcml2YXRlCiAgQGNvbnN0cnV0b3IKKi8KRFMuUmVsYXRpb25zaGlwQ2hhbmdlUmVtb3ZlID0gZnVuY3Rpb24ob3B0aW9ucyl7CiAgRFMuUmVsYXRpb25zaGlwQ2hhbmdlLmNhbGwodGhpcywgb3B0aW9ucyk7Cn07CgpEUy5SZWxhdGlvbnNoaXBDaGFuZ2UuY3JlYXRlID0gZnVuY3Rpb24ob3B0aW9ucykgewogIHJldHVybiBuZXcgRFMuUmVsYXRpb25zaGlwQ2hhbmdlKG9wdGlvbnMpOwp9OwoKRFMuUmVsYXRpb25zaGlwQ2hhbmdlQWRkLmNyZWF0ZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICByZXR1cm4gbmV3IERTLlJlbGF0aW9uc2hpcENoYW5nZUFkZChvcHRpb25zKTsKfTsKCkRTLlJlbGF0aW9uc2hpcENoYW5nZVJlbW92ZS5jcmVhdGUgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgcmV0dXJuIG5ldyBEUy5SZWxhdGlvbnNoaXBDaGFuZ2VSZW1vdmUob3B0aW9ucyk7Cn07CgpEUy5PbmVUb01hbnlDaGFuZ2UgPSB7fTsKRFMuT25lVG9Ob25lQ2hhbmdlID0ge307CkRTLk1hbnlUb05vbmVDaGFuZ2UgPSB7fTsKRFMuT25lVG9PbmVDaGFuZ2UgPSB7fTsKRFMuTWFueVRvTWFueUNoYW5nZSA9IHt9OwoKRFMuUmVsYXRpb25zaGlwQ2hhbmdlLl9jcmVhdGVDaGFuZ2UgPSBmdW5jdGlvbihvcHRpb25zKXsKICBpZihvcHRpb25zLmNoYW5nZVR5cGUgPT09ICJhZGQiKXsKICAgIHJldHVybiBEUy5SZWxhdGlvbnNoaXBDaGFuZ2VBZGQuY3JlYXRlKG9wdGlvbnMpOwogIH0KICBpZihvcHRpb25zLmNoYW5nZVR5cGUgPT09ICJyZW1vdmUiKXsKICAgIHJldHVybiBEUy5SZWxhdGlvbnNoaXBDaGFuZ2VSZW1vdmUuY3JlYXRlKG9wdGlvbnMpOwogIH0KfTsKCgpEUy5SZWxhdGlvbnNoaXBDaGFuZ2UuZGV0ZXJtaW5lUmVsYXRpb25zaGlwVHlwZSA9IGZ1bmN0aW9uKHJlY29yZFR5cGUsIGtub3duU2lkZSl7CiAgdmFyIGtub3duS2V5ID0ga25vd25TaWRlLmtleSwga2V5LCBvdGhlcktpbmQ7CiAgdmFyIGtub3duS2luZCA9IGtub3duU2lkZS5raW5kOwoKICB2YXIgaW52ZXJzZSA9IHJlY29yZFR5cGUuaW52ZXJzZUZvcihrbm93bktleSk7CgogIGlmIChpbnZlcnNlKXsKICAgIGtleSA9IGludmVyc2UubmFtZTsKICAgIG90aGVyS2luZCA9IGludmVyc2Uua2luZDsKICB9CgogIGlmICghaW52ZXJzZSl7CiAgICByZXR1cm4ga25vd25LaW5kID09PSAiYmVsb25nc1RvIiA/ICJvbmVUb05vbmUiIDogIm1hbnlUb05vbmUiOwogIH0KICBlbHNlewogICAgaWYob3RoZXJLaW5kID09PSAiYmVsb25nc1RvIil7CiAgICAgIHJldHVybiBrbm93bktpbmQgPT09ICJiZWxvbmdzVG8iID8gIm9uZVRvT25lIiA6ICJtYW55VG9PbmUiOwogICAgfQogICAgZWxzZXsKICAgICAgcmV0dXJuIGtub3duS2luZCA9PT0gImJlbG9uZ3NUbyIgPyAib25lVG9NYW55IiA6ICJtYW55VG9NYW55IjsKICAgIH0KICB9Cgp9OwoKRFMuUmVsYXRpb25zaGlwQ2hhbmdlLmNyZWF0ZUNoYW5nZSA9IGZ1bmN0aW9uKGZpcnN0UmVjb3JkLCBzZWNvbmRSZWNvcmQsIHN0b3JlLCBvcHRpb25zKXsKICAvLyBHZXQgdGhlIHR5cGUgb2YgdGhlIGNoaWxkIGJhc2VkIG9uIHRoZSBjaGlsZCdzIGNsaWVudCBJRAogIHZhciBmaXJzdFJlY29yZFR5cGUgPSBmaXJzdFJlY29yZC5jb25zdHJ1Y3RvciwgY2hhbmdlVHlwZTsKICBjaGFuZ2VUeXBlID0gRFMuUmVsYXRpb25zaGlwQ2hhbmdlLmRldGVybWluZVJlbGF0aW9uc2hpcFR5cGUoZmlyc3RSZWNvcmRUeXBlLCBvcHRpb25zKTsKICBpZiAoY2hhbmdlVHlwZSA9PT0gIm9uZVRvTWFueSIpewogICAgcmV0dXJuIERTLk9uZVRvTWFueUNoYW5nZS5jcmVhdGVDaGFuZ2UoZmlyc3RSZWNvcmQsIHNlY29uZFJlY29yZCwgc3RvcmUsIG9wdGlvbnMpOwogIH0KICBlbHNlIGlmIChjaGFuZ2VUeXBlID09PSAibWFueVRvT25lIil7CiAgICByZXR1cm4gRFMuT25lVG9NYW55Q2hhbmdlLmNyZWF0ZUNoYW5nZShzZWNvbmRSZWNvcmQsIGZpcnN0UmVjb3JkLCBzdG9yZSwgb3B0aW9ucyk7CiAgfQogIGVsc2UgaWYgKGNoYW5nZVR5cGUgPT09ICJvbmVUb05vbmUiKXsKICAgIHJldHVybiBEUy5PbmVUb05vbmVDaGFuZ2UuY3JlYXRlQ2hhbmdlKGZpcnN0UmVjb3JkLCBzZWNvbmRSZWNvcmQsIHN0b3JlLCBvcHRpb25zKTsKICB9CiAgZWxzZSBpZiAoY2hhbmdlVHlwZSA9PT0gIm1hbnlUb05vbmUiKXsKICAgIHJldHVybiBEUy5NYW55VG9Ob25lQ2hhbmdlLmNyZWF0ZUNoYW5nZShmaXJzdFJlY29yZCwgc2Vjb25kUmVjb3JkLCBzdG9yZSwgb3B0aW9ucyk7CiAgfQogIGVsc2UgaWYgKGNoYW5nZVR5cGUgPT09ICJvbmVUb09uZSIpewogICAgcmV0dXJuIERTLk9uZVRvT25lQ2hhbmdlLmNyZWF0ZUNoYW5nZShmaXJzdFJlY29yZCwgc2Vjb25kUmVjb3JkLCBzdG9yZSwgb3B0aW9ucyk7CiAgfQogIGVsc2UgaWYgKGNoYW5nZVR5cGUgPT09ICJtYW55VG9NYW55Iil7CiAgICByZXR1cm4gRFMuTWFueVRvTWFueUNoYW5nZS5jcmVhdGVDaGFuZ2UoZmlyc3RSZWNvcmQsIHNlY29uZFJlY29yZCwgc3RvcmUsIG9wdGlvbnMpOwogIH0KfTsKCkRTLk9uZVRvTm9uZUNoYW5nZS5jcmVhdGVDaGFuZ2UgPSBmdW5jdGlvbihjaGlsZFJlY29yZCwgcGFyZW50UmVjb3JkLCBzdG9yZSwgb3B0aW9ucykgewogIHZhciBrZXkgPSBvcHRpb25zLmtleTsKICB2YXIgY2hhbmdlID0gRFMuUmVsYXRpb25zaGlwQ2hhbmdlLl9jcmVhdGVDaGFuZ2UoewogICAgICBwYXJlbnRSZWNvcmQ6IHBhcmVudFJlY29yZCwKICAgICAgY2hpbGRSZWNvcmQ6IGNoaWxkUmVjb3JkLAogICAgICBmaXJzdFJlY29yZDogY2hpbGRSZWNvcmQsCiAgICAgIHN0b3JlOiBzdG9yZSwKICAgICAgY2hhbmdlVHlwZTogb3B0aW9ucy5jaGFuZ2VUeXBlLAogICAgICBmaXJzdFJlY29yZE5hbWU6IGtleSwKICAgICAgZmlyc3RSZWNvcmRLaW5kOiAiYmVsb25nc1RvIgogIH0pOwoKICBzdG9yZS5hZGRSZWxhdGlvbnNoaXBDaGFuZ2VGb3IoY2hpbGRSZWNvcmQsIGtleSwgcGFyZW50UmVjb3JkLCBudWxsLCBjaGFuZ2UpOwoKICByZXR1cm4gY2hhbmdlOwp9OwoKRFMuTWFueVRvTm9uZUNoYW5nZS5jcmVhdGVDaGFuZ2UgPSBmdW5jdGlvbihjaGlsZFJlY29yZCwgcGFyZW50UmVjb3JkLCBzdG9yZSwgb3B0aW9ucykgewogIHZhciBrZXkgPSBvcHRpb25zLmtleTsKICB2YXIgY2hhbmdlID0gRFMuUmVsYXRpb25zaGlwQ2hhbmdlLl9jcmVhdGVDaGFuZ2UoewogICAgICBwYXJlbnRSZWNvcmQ6IGNoaWxkUmVjb3JkLAogICAgICBjaGlsZFJlY29yZDogcGFyZW50UmVjb3JkLAogICAgICBzZWNvbmRSZWNvcmQ6IGNoaWxkUmVjb3JkLAogICAgICBzdG9yZTogc3RvcmUsCiAgICAgIGNoYW5nZVR5cGU6IG9wdGlvbnMuY2hhbmdlVHlwZSwKICAgICAgc2Vjb25kUmVjb3JkTmFtZTogb3B0aW9ucy5rZXksCiAgICAgIHNlY29uZFJlY29yZEtpbmQ6ICJoYXNNYW55IgogIH0pOwoKICBzdG9yZS5hZGRSZWxhdGlvbnNoaXBDaGFuZ2VGb3IoY2hpbGRSZWNvcmQsIGtleSwgcGFyZW50UmVjb3JkLCBudWxsLCBjaGFuZ2UpOwogIHJldHVybiBjaGFuZ2U7Cn07CgoKRFMuTWFueVRvTWFueUNoYW5nZS5jcmVhdGVDaGFuZ2UgPSBmdW5jdGlvbihjaGlsZFJlY29yZCwgcGFyZW50UmVjb3JkLCBzdG9yZSwgb3B0aW9ucykgewogIC8vIElmIHRoZSBuYW1lIG9mIHRoZSBiZWxvbmdzVG8gc2lkZSBvZiB0aGUgcmVsYXRpb25zaGlwIGlzIHNwZWNpZmllZCwKICAvLyB1c2UgdGhhdAogIC8vIElmIHRoZSB0eXBlIG9mIHRoZSBwYXJlbnQgaXMgc3BlY2lmaWVkLCBsb29rIGl0IHVwIG9uIHRoZSBjaGlsZCdzIHR5cGUKICAvLyBkZWZpbml0aW9uLgogIHZhciBrZXkgPSBvcHRpb25zLmtleTsKCiAgdmFyIGNoYW5nZSA9IERTLlJlbGF0aW9uc2hpcENoYW5nZS5fY3JlYXRlQ2hhbmdlKHsKICAgICAgcGFyZW50UmVjb3JkOiBwYXJlbnRSZWNvcmQsCiAgICAgIGNoaWxkUmVjb3JkOiBjaGlsZFJlY29yZCwKICAgICAgZmlyc3RSZWNvcmQ6IGNoaWxkUmVjb3JkLAogICAgICBzZWNvbmRSZWNvcmQ6IHBhcmVudFJlY29yZCwKICAgICAgZmlyc3RSZWNvcmRLaW5kOiAiaGFzTWFueSIsCiAgICAgIHNlY29uZFJlY29yZEtpbmQ6ICJoYXNNYW55IiwKICAgICAgc3RvcmU6IHN0b3JlLAogICAgICBjaGFuZ2VUeXBlOiBvcHRpb25zLmNoYW5nZVR5cGUsCiAgICAgIGZpcnN0UmVjb3JkTmFtZTogIGtleQogIH0pOwoKICBzdG9yZS5hZGRSZWxhdGlvbnNoaXBDaGFuZ2VGb3IoY2hpbGRSZWNvcmQsIGtleSwgcGFyZW50UmVjb3JkLCBudWxsLCBjaGFuZ2UpOwoKCiAgcmV0dXJuIGNoYW5nZTsKfTsKCkRTLk9uZVRvT25lQ2hhbmdlLmNyZWF0ZUNoYW5nZSA9IGZ1bmN0aW9uKGNoaWxkUmVjb3JkLCBwYXJlbnRSZWNvcmQsIHN0b3JlLCBvcHRpb25zKSB7CiAgdmFyIGtleTsKCiAgLy8gSWYgdGhlIG5hbWUgb2YgdGhlIGJlbG9uZ3NUbyBzaWRlIG9mIHRoZSByZWxhdGlvbnNoaXAgaXMgc3BlY2lmaWVkLAogIC8vIHVzZSB0aGF0CiAgLy8gSWYgdGhlIHR5cGUgb2YgdGhlIHBhcmVudCBpcyBzcGVjaWZpZWQsIGxvb2sgaXQgdXAgb24gdGhlIGNoaWxkJ3MgdHlwZQogIC8vIGRlZmluaXRpb24uCiAgaWYgKG9wdGlvbnMucGFyZW50VHlwZSkgewogICAga2V5ID0gb3B0aW9ucy5wYXJlbnRUeXBlLmludmVyc2VGb3Iob3B0aW9ucy5rZXkpLm5hbWU7CiAgfSBlbHNlIGlmIChvcHRpb25zLmtleSkgewogICAga2V5ID0gb3B0aW9ucy5rZXk7CiAgfSBlbHNlIHsKICAgIEVtYmVyLmFzc2VydCgiWW91IG11c3QgcGFzcyBlaXRoZXIgYSBwYXJlbnRUeXBlIG9yIGJlbG9uZ3NUb05hbWUgb3B0aW9uIHRvIE9uZVRvTWFueUNoYW5nZS5mb3JDaGlsZEFuZFBhcmVudCIsIGZhbHNlKTsKICB9CgogIHZhciBjaGFuZ2UgPSBEUy5SZWxhdGlvbnNoaXBDaGFuZ2UuX2NyZWF0ZUNoYW5nZSh7CiAgICAgIHBhcmVudFJlY29yZDogcGFyZW50UmVjb3JkLAogICAgICBjaGlsZFJlY29yZDogY2hpbGRSZWNvcmQsCiAgICAgIGZpcnN0UmVjb3JkOiBjaGlsZFJlY29yZCwKICAgICAgc2Vjb25kUmVjb3JkOiBwYXJlbnRSZWNvcmQsCiAgICAgIGZpcnN0UmVjb3JkS2luZDogImJlbG9uZ3NUbyIsCiAgICAgIHNlY29uZFJlY29yZEtpbmQ6ICJiZWxvbmdzVG8iLAogICAgICBzdG9yZTogc3RvcmUsCiAgICAgIGNoYW5nZVR5cGU6IG9wdGlvbnMuY2hhbmdlVHlwZSwKICAgICAgZmlyc3RSZWNvcmROYW1lOiAga2V5CiAgfSk7CgogIHN0b3JlLmFkZFJlbGF0aW9uc2hpcENoYW5nZUZvcihjaGlsZFJlY29yZCwga2V5LCBwYXJlbnRSZWNvcmQsIG51bGwsIGNoYW5nZSk7CgoKICByZXR1cm4gY2hhbmdlOwp9OwoKRFMuT25lVG9PbmVDaGFuZ2UubWFpbnRhaW5JbnZhcmlhbnQgPSBmdW5jdGlvbihvcHRpb25zLCBzdG9yZSwgY2hpbGRSZWNvcmQsIGtleSl7CiAgaWYgKG9wdGlvbnMuY2hhbmdlVHlwZSA9PT0gImFkZCIgJiYgc3RvcmUucmVjb3JkSXNNYXRlcmlhbGl6ZWQoY2hpbGRSZWNvcmQpKSB7CiAgICB2YXIgb2xkUGFyZW50ID0gZ2V0KGNoaWxkUmVjb3JkLCBrZXkpOwogICAgaWYgKG9sZFBhcmVudCl7CiAgICAgIHZhciBjb3JyZXNwb25kaW5nQ2hhbmdlID0gRFMuT25lVG9PbmVDaGFuZ2UuY3JlYXRlQ2hhbmdlKGNoaWxkUmVjb3JkLCBvbGRQYXJlbnQsIHN0b3JlLCB7CiAgICAgICAgICBwYXJlbnRUeXBlOiBvcHRpb25zLnBhcmVudFR5cGUsCiAgICAgICAgICBoYXNNYW55TmFtZTogb3B0aW9ucy5oYXNNYW55TmFtZSwKICAgICAgICAgIGNoYW5nZVR5cGU6ICJyZW1vdmUiLAogICAgICAgICAga2V5OiBvcHRpb25zLmtleQogICAgICAgIH0pOwogICAgICBzdG9yZS5hZGRSZWxhdGlvbnNoaXBDaGFuZ2VGb3IoY2hpbGRSZWNvcmQsIGtleSwgb3B0aW9ucy5wYXJlbnRSZWNvcmQgLCBudWxsLCBjb3JyZXNwb25kaW5nQ2hhbmdlKTsKICAgICBjb3JyZXNwb25kaW5nQ2hhbmdlLnN5bmMoKTsKICAgIH0KICB9Cn07CgpEUy5PbmVUb01hbnlDaGFuZ2UuY3JlYXRlQ2hhbmdlID0gZnVuY3Rpb24oY2hpbGRSZWNvcmQsIHBhcmVudFJlY29yZCwgc3RvcmUsIG9wdGlvbnMpIHsKICB2YXIga2V5OwoKICAvLyBJZiB0aGUgbmFtZSBvZiB0aGUgYmVsb25nc1RvIHNpZGUgb2YgdGhlIHJlbGF0aW9uc2hpcCBpcyBzcGVjaWZpZWQsCiAgLy8gdXNlIHRoYXQKICAvLyBJZiB0aGUgdHlwZSBvZiB0aGUgcGFyZW50IGlzIHNwZWNpZmllZCwgbG9vayBpdCB1cCBvbiB0aGUgY2hpbGQncyB0eXBlCiAgLy8gZGVmaW5pdGlvbi4KICBpZiAob3B0aW9ucy5wYXJlbnRUeXBlKSB7CiAgICBrZXkgPSBvcHRpb25zLnBhcmVudFR5cGUuaW52ZXJzZUZvcihvcHRpb25zLmtleSkubmFtZTsKICAgIERTLk9uZVRvTWFueUNoYW5nZS5tYWludGFpbkludmFyaWFudCggb3B0aW9ucywgc3RvcmUsIGNoaWxkUmVjb3JkLCBrZXkgKTsKICB9IGVsc2UgaWYgKG9wdGlvbnMua2V5KSB7CiAgICBrZXkgPSBvcHRpb25zLmtleTsKICB9IGVsc2UgewogICAgRW1iZXIuYXNzZXJ0KCJZb3UgbXVzdCBwYXNzIGVpdGhlciBhIHBhcmVudFR5cGUgb3IgYmVsb25nc1RvTmFtZSBvcHRpb24gdG8gT25lVG9NYW55Q2hhbmdlLmZvckNoaWxkQW5kUGFyZW50IiwgZmFsc2UpOwogIH0KCiAgdmFyIGNoYW5nZSA9IERTLlJlbGF0aW9uc2hpcENoYW5nZS5fY3JlYXRlQ2hhbmdlKHsKICAgICAgcGFyZW50UmVjb3JkOiBwYXJlbnRSZWNvcmQsCiAgICAgIGNoaWxkUmVjb3JkOiBjaGlsZFJlY29yZCwKICAgICAgZmlyc3RSZWNvcmQ6IGNoaWxkUmVjb3JkLAogICAgICBzZWNvbmRSZWNvcmQ6IHBhcmVudFJlY29yZCwKICAgICAgZmlyc3RSZWNvcmRLaW5kOiAiYmVsb25nc1RvIiwKICAgICAgc2Vjb25kUmVjb3JkS2luZDogImhhc01hbnkiLAogICAgICBzdG9yZTogc3RvcmUsCiAgICAgIGNoYW5nZVR5cGU6IG9wdGlvbnMuY2hhbmdlVHlwZSwKICAgICAgZmlyc3RSZWNvcmROYW1lOiAga2V5CiAgfSk7CgogIHN0b3JlLmFkZFJlbGF0aW9uc2hpcENoYW5nZUZvcihjaGlsZFJlY29yZCwga2V5LCBwYXJlbnRSZWNvcmQsIGNoYW5nZS5nZXRTZWNvbmRSZWNvcmROYW1lKCksIGNoYW5nZSk7CgoKICByZXR1cm4gY2hhbmdlOwp9OwoKCkRTLk9uZVRvTWFueUNoYW5nZS5tYWludGFpbkludmFyaWFudCA9IGZ1bmN0aW9uKG9wdGlvbnMsIHN0b3JlLCBjaGlsZFJlY29yZCwga2V5KXsKICBpZiAob3B0aW9ucy5jaGFuZ2VUeXBlID09PSAiYWRkIiAmJiBjaGlsZFJlY29yZCkgewogICAgdmFyIG9sZFBhcmVudCA9IGdldChjaGlsZFJlY29yZCwga2V5KTsKICAgIGlmIChvbGRQYXJlbnQpewogICAgICB2YXIgY29ycmVzcG9uZGluZ0NoYW5nZSA9IERTLk9uZVRvTWFueUNoYW5nZS5jcmVhdGVDaGFuZ2UoY2hpbGRSZWNvcmQsIG9sZFBhcmVudCwgc3RvcmUsIHsKICAgICAgICAgIHBhcmVudFR5cGU6IG9wdGlvbnMucGFyZW50VHlwZSwKICAgICAgICAgIGhhc01hbnlOYW1lOiBvcHRpb25zLmhhc01hbnlOYW1lLAogICAgICAgICAgY2hhbmdlVHlwZTogInJlbW92ZSIsCiAgICAgICAgICBrZXk6IG9wdGlvbnMua2V5CiAgICAgICAgfSk7CiAgICAgIHN0b3JlLmFkZFJlbGF0aW9uc2hpcENoYW5nZUZvcihjaGlsZFJlY29yZCwga2V5LCBvcHRpb25zLnBhcmVudFJlY29yZCwgY29ycmVzcG9uZGluZ0NoYW5nZS5nZXRTZWNvbmRSZWNvcmROYW1lKCksIGNvcnJlc3BvbmRpbmdDaGFuZ2UpOwogICAgICBjb3JyZXNwb25kaW5nQ2hhbmdlLnN5bmMoKTsKICAgIH0KICB9Cn07CgovKioKICBAY2xhc3MgUmVsYXRpb25zaGlwQ2hhbmdlCiAgQG5hbWVzcGFjZSBEUwoqLwpEUy5SZWxhdGlvbnNoaXBDaGFuZ2UucHJvdG90eXBlID0gewoKICBnZXRTZWNvbmRSZWNvcmROYW1lOiBmdW5jdGlvbigpIHsKICAgIHZhciBuYW1lID0gdGhpcy5zZWNvbmRSZWNvcmROYW1lLCBwYXJlbnQ7CgogICAgaWYgKCFuYW1lKSB7CiAgICAgIHBhcmVudCA9IHRoaXMuc2Vjb25kUmVjb3JkOwogICAgICBpZiAoIXBhcmVudCkgeyByZXR1cm47IH0KCiAgICAgIHZhciBjaGlsZFR5cGUgPSB0aGlzLmZpcnN0UmVjb3JkLmNvbnN0cnVjdG9yOwogICAgICB2YXIgaW52ZXJzZSA9IGNoaWxkVHlwZS5pbnZlcnNlRm9yKHRoaXMuZmlyc3RSZWNvcmROYW1lKTsKICAgICAgdGhpcy5zZWNvbmRSZWNvcmROYW1lID0gaW52ZXJzZS5uYW1lOwogICAgfQoKICAgIHJldHVybiB0aGlzLnNlY29uZFJlY29yZE5hbWU7CiAgfSwKCiAgLyoqCiAgICBHZXQgdGhlIG5hbWUgb2YgdGhlIHJlbGF0aW9uc2hpcCBvbiB0aGUgYmVsb25nc1RvIHNpZGUuCgogICAgQG1ldGhvZCBnZXRGaXJzdFJlY29yZE5hbWUKICAgIEByZXR1cm4ge1N0cmluZ30KICAqLwogIGdldEZpcnN0UmVjb3JkTmFtZTogZnVuY3Rpb24oKSB7CiAgICB2YXIgbmFtZSA9IHRoaXMuZmlyc3RSZWNvcmROYW1lOwogICAgcmV0dXJuIG5hbWU7CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIGRlc3Ryb3kKICAgIEBwcml2YXRlCiAgKi8KICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgIHZhciBjaGlsZFJlY29yZCA9IHRoaXMuY2hpbGRSZWNvcmQsCiAgICAgICAgYmVsb25nc1RvTmFtZSA9IHRoaXMuZ2V0Rmlyc3RSZWNvcmROYW1lKCksCiAgICAgICAgaGFzTWFueU5hbWUgPSB0aGlzLmdldFNlY29uZFJlY29yZE5hbWUoKSwKICAgICAgICBzdG9yZSA9IHRoaXMuc3RvcmU7CgogICAgc3RvcmUucmVtb3ZlUmVsYXRpb25zaGlwQ2hhbmdlRm9yKGNoaWxkUmVjb3JkLCBiZWxvbmdzVG9OYW1lLCB0aGlzLnBhcmVudFJlY29yZCwgaGFzTWFueU5hbWUsIHRoaXMuY2hhbmdlVHlwZSk7CiAgfSwKCiAgZ2V0U2Vjb25kUmVjb3JkOiBmdW5jdGlvbigpewogICAgcmV0dXJuIHRoaXMuc2Vjb25kUmVjb3JkOwogIH0sCgogIC8qKgogICAgQG1ldGhvZCBnZXRGaXJzdFJlY29yZAogICAgQHByaXZhdGUKICAqLwogIGdldEZpcnN0UmVjb3JkOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmZpcnN0UmVjb3JkOwogIH0sCgogIGNvYWxlc2NlOiBmdW5jdGlvbigpewogICAgdmFyIHJlbGF0aW9uc2hpcFBhaXJzID0gdGhpcy5zdG9yZS5yZWxhdGlvbnNoaXBDaGFuZ2VQYWlyc0Zvcih0aGlzLmZpcnN0UmVjb3JkKTsKICAgIGZvckVhY2gocmVsYXRpb25zaGlwUGFpcnMsIGZ1bmN0aW9uKHBhaXIpewogICAgICB2YXIgYWRkZWRDaGFuZ2UgPSBwYWlyWyJhZGQiXTsKICAgICAgdmFyIHJlbW92ZWRDaGFuZ2UgPSBwYWlyWyJyZW1vdmUiXTsKICAgICAgaWYoYWRkZWRDaGFuZ2UgJiYgcmVtb3ZlZENoYW5nZSkgewogICAgICAgIGFkZGVkQ2hhbmdlLmRlc3Ryb3koKTsKICAgICAgICByZW1vdmVkQ2hhbmdlLmRlc3Ryb3koKTsKICAgICAgfQogICAgfSk7CiAgfQp9OwoKRFMuUmVsYXRpb25zaGlwQ2hhbmdlQWRkLnByb3RvdHlwZSA9IEVtYmVyLmNyZWF0ZShEUy5SZWxhdGlvbnNoaXBDaGFuZ2UuY3JlYXRlKHt9KSk7CkRTLlJlbGF0aW9uc2hpcENoYW5nZVJlbW92ZS5wcm90b3R5cGUgPSBFbWJlci5jcmVhdGUoRFMuUmVsYXRpb25zaGlwQ2hhbmdlLmNyZWF0ZSh7fSkpOwoKLy8gdGhlIG9iamVjdCBpcyBhIHZhbHVlLCBhbmQgbm90IGEgcHJvbWlzZQpmdW5jdGlvbiBpc1ZhbHVlKG9iamVjdCkgewogIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09PSAnb2JqZWN0JyAmJiAoIW9iamVjdC50aGVuIHx8IHR5cGVvZiBvYmplY3QudGhlbiAhPT0gJ2Z1bmN0aW9uJyk7Cn0KCkRTLlJlbGF0aW9uc2hpcENoYW5nZUFkZC5wcm90b3R5cGUuY2hhbmdlVHlwZSA9ICJhZGQiOwpEUy5SZWxhdGlvbnNoaXBDaGFuZ2VBZGQucHJvdG90eXBlLnN5bmMgPSBmdW5jdGlvbigpIHsKICB2YXIgc2Vjb25kUmVjb3JkTmFtZSA9IHRoaXMuZ2V0U2Vjb25kUmVjb3JkTmFtZSgpLAogICAgICBmaXJzdFJlY29yZE5hbWUgPSB0aGlzLmdldEZpcnN0UmVjb3JkTmFtZSgpLAogICAgICBmaXJzdFJlY29yZCA9IHRoaXMuZ2V0Rmlyc3RSZWNvcmQoKSwKICAgICAgc2Vjb25kUmVjb3JkID0gdGhpcy5nZXRTZWNvbmRSZWNvcmQoKTsKCiAgLy9FbWJlci5hc3NlcnQoIllvdSBzcGVjaWZpZWQgYSBoYXNNYW55ICgiICsgaGFzTWFueU5hbWUgKyAiKSBvbiAiICsgKCFiZWxvbmdzVG9OYW1lICYmIChuZXdQYXJlbnQgfHwgb2xkUGFyZW50IHx8IHRoaXMubGFzdFBhcmVudCkuY29uc3RydWN0b3IpICsgIiBidXQgZGlkIG5vdCBzcGVjaWZ5IGFuIGludmVyc2UgYmVsb25nc1RvIG9uICIgKyBjaGlsZC5jb25zdHJ1Y3RvciwgYmVsb25nc1RvTmFtZSk7CiAgLy9FbWJlci5hc3NlcnQoIllvdSBzcGVjaWZpZWQgYSBiZWxvbmdzVG8gKCIgKyBiZWxvbmdzVG9OYW1lICsgIikgb24gIiArIGNoaWxkLmNvbnN0cnVjdG9yICsgIiBidXQgZGlkIG5vdCBzcGVjaWZ5IGFuIGludmVyc2UgaGFzTWFueSBvbiAiICsgKCFoYXNNYW55TmFtZSAmJiAobmV3UGFyZW50IHx8IG9sZFBhcmVudCB8fCB0aGlzLmxhc3RQYXJlbnRSZWNvcmQpLmNvbnN0cnVjdG9yKSwgaGFzTWFueU5hbWUpOwoKICBpZiAoc2Vjb25kUmVjb3JkIGluc3RhbmNlb2YgRFMuTW9kZWwgJiYgZmlyc3RSZWNvcmQgaW5zdGFuY2VvZiBEUy5Nb2RlbCkgewogICAgaWYodGhpcy5zZWNvbmRSZWNvcmRLaW5kID09PSAiYmVsb25nc1RvIil7CiAgICAgIHNlY29uZFJlY29yZC5zdXNwZW5kUmVsYXRpb25zaGlwT2JzZXJ2ZXJzKGZ1bmN0aW9uKCl7CiAgICAgICAgc2V0KHNlY29uZFJlY29yZCwgc2Vjb25kUmVjb3JkTmFtZSwgZmlyc3RSZWNvcmQpOwogICAgICB9KTsKCiAgICAgfQogICAgIGVsc2UgaWYodGhpcy5zZWNvbmRSZWNvcmRLaW5kID09PSAiaGFzTWFueSIpewogICAgICBzZWNvbmRSZWNvcmQuc3VzcGVuZFJlbGF0aW9uc2hpcE9ic2VydmVycyhmdW5jdGlvbigpewogICAgICAgIHZhciByZWxhdGlvbnNoaXAgPSBnZXQoc2Vjb25kUmVjb3JkLCBzZWNvbmRSZWNvcmROYW1lKTsKICAgICAgICBpZiAoaXNWYWx1ZShyZWxhdGlvbnNoaXApKSB7IHJlbGF0aW9uc2hpcC5hZGRPYmplY3QoZmlyc3RSZWNvcmQpOyB9CiAgICAgIH0pOwogICAgfQogIH0KCiAgaWYgKGZpcnN0UmVjb3JkIGluc3RhbmNlb2YgRFMuTW9kZWwgJiYgc2Vjb25kUmVjb3JkIGluc3RhbmNlb2YgRFMuTW9kZWwgJiYgZ2V0KGZpcnN0UmVjb3JkLCBmaXJzdFJlY29yZE5hbWUpICE9PSBzZWNvbmRSZWNvcmQpIHsKICAgIGlmKHRoaXMuZmlyc3RSZWNvcmRLaW5kID09PSAiYmVsb25nc1RvIil7CiAgICAgIGZpcnN0UmVjb3JkLnN1c3BlbmRSZWxhdGlvbnNoaXBPYnNlcnZlcnMoZnVuY3Rpb24oKXsKICAgICAgICBzZXQoZmlyc3RSZWNvcmQsIGZpcnN0UmVjb3JkTmFtZSwgc2Vjb25kUmVjb3JkKTsKICAgICAgfSk7CiAgICB9CiAgICBlbHNlIGlmKHRoaXMuZmlyc3RSZWNvcmRLaW5kID09PSAiaGFzTWFueSIpewogICAgICBmaXJzdFJlY29yZC5zdXNwZW5kUmVsYXRpb25zaGlwT2JzZXJ2ZXJzKGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIHJlbGF0aW9uc2hpcCA9IGdldChmaXJzdFJlY29yZCwgZmlyc3RSZWNvcmROYW1lKTsKICAgICAgICBpZiAoaXNWYWx1ZShyZWxhdGlvbnNoaXApKSB7IHJlbGF0aW9uc2hpcC5hZGRPYmplY3Qoc2Vjb25kUmVjb3JkKTsgfQogICAgICB9KTsKICAgIH0KICB9CgogIHRoaXMuY29hbGVzY2UoKTsKfTsKCkRTLlJlbGF0aW9uc2hpcENoYW5nZVJlbW92ZS5wcm90b3R5cGUuY2hhbmdlVHlwZSA9ICJyZW1vdmUiOwpEUy5SZWxhdGlvbnNoaXBDaGFuZ2VSZW1vdmUucHJvdG90eXBlLnN5bmMgPSBmdW5jdGlvbigpIHsKICB2YXIgc2Vjb25kUmVjb3JkTmFtZSA9IHRoaXMuZ2V0U2Vjb25kUmVjb3JkTmFtZSgpLAogICAgICBmaXJzdFJlY29yZE5hbWUgPSB0aGlzLmdldEZpcnN0UmVjb3JkTmFtZSgpLAogICAgICBmaXJzdFJlY29yZCA9IHRoaXMuZ2V0Rmlyc3RSZWNvcmQoKSwKICAgICAgc2Vjb25kUmVjb3JkID0gdGhpcy5nZXRTZWNvbmRSZWNvcmQoKTsKCiAgLy9FbWJlci5hc3NlcnQoIllvdSBzcGVjaWZpZWQgYSBoYXNNYW55ICgiICsgaGFzTWFueU5hbWUgKyAiKSBvbiAiICsgKCFiZWxvbmdzVG9OYW1lICYmIChuZXdQYXJlbnQgfHwgb2xkUGFyZW50IHx8IHRoaXMubGFzdFBhcmVudCkuY29uc3RydWN0b3IpICsgIiBidXQgZGlkIG5vdCBzcGVjaWZ5IGFuIGludmVyc2UgYmVsb25nc1RvIG9uICIgKyBjaGlsZC5jb25zdHJ1Y3RvciwgYmVsb25nc1RvTmFtZSk7CiAgLy9FbWJlci5hc3NlcnQoIllvdSBzcGVjaWZpZWQgYSBiZWxvbmdzVG8gKCIgKyBiZWxvbmdzVG9OYW1lICsgIikgb24gIiArIGNoaWxkLmNvbnN0cnVjdG9yICsgIiBidXQgZGlkIG5vdCBzcGVjaWZ5IGFuIGludmVyc2UgaGFzTWFueSBvbiAiICsgKCFoYXNNYW55TmFtZSAmJiAobmV3UGFyZW50IHx8IG9sZFBhcmVudCB8fCB0aGlzLmxhc3RQYXJlbnRSZWNvcmQpLmNvbnN0cnVjdG9yKSwgaGFzTWFueU5hbWUpOwoKICBpZiAoc2Vjb25kUmVjb3JkIGluc3RhbmNlb2YgRFMuTW9kZWwgJiYgZmlyc3RSZWNvcmQgaW5zdGFuY2VvZiBEUy5Nb2RlbCkgewogICAgaWYodGhpcy5zZWNvbmRSZWNvcmRLaW5kID09PSAiYmVsb25nc1RvIil7CiAgICAgIHNlY29uZFJlY29yZC5zdXNwZW5kUmVsYXRpb25zaGlwT2JzZXJ2ZXJzKGZ1bmN0aW9uKCl7CiAgICAgICAgc2V0KHNlY29uZFJlY29yZCwgc2Vjb25kUmVjb3JkTmFtZSwgbnVsbCk7CiAgICAgIH0pOwogICAgfQogICAgZWxzZSBpZih0aGlzLnNlY29uZFJlY29yZEtpbmQgPT09ICJoYXNNYW55Iil7CiAgICAgIHNlY29uZFJlY29yZC5zdXNwZW5kUmVsYXRpb25zaGlwT2JzZXJ2ZXJzKGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIHJlbGF0aW9uc2hpcCA9IGdldChzZWNvbmRSZWNvcmQsIHNlY29uZFJlY29yZE5hbWUpOwogICAgICAgIGlmIChpc1ZhbHVlKHJlbGF0aW9uc2hpcCkpIHsgcmVsYXRpb25zaGlwLnJlbW92ZU9iamVjdChmaXJzdFJlY29yZCk7IH0KICAgICAgfSk7CiAgICB9CiAgfQoKICBpZiAoZmlyc3RSZWNvcmQgaW5zdGFuY2VvZiBEUy5Nb2RlbCAmJiBnZXQoZmlyc3RSZWNvcmQsIGZpcnN0UmVjb3JkTmFtZSkpIHsKICAgIGlmKHRoaXMuZmlyc3RSZWNvcmRLaW5kID09PSAiYmVsb25nc1RvIil7CiAgICAgIGZpcnN0UmVjb3JkLnN1c3BlbmRSZWxhdGlvbnNoaXBPYnNlcnZlcnMoZnVuY3Rpb24oKXsKICAgICAgICBzZXQoZmlyc3RSZWNvcmQsIGZpcnN0UmVjb3JkTmFtZSwgbnVsbCk7CiAgICAgIH0pOwogICAgIH0KICAgICBlbHNlIGlmKHRoaXMuZmlyc3RSZWNvcmRLaW5kID09PSAiaGFzTWFueSIpewogICAgICAgZmlyc3RSZWNvcmQuc3VzcGVuZFJlbGF0aW9uc2hpcE9ic2VydmVycyhmdW5jdGlvbigpewogICAgICAgICB2YXIgcmVsYXRpb25zaGlwID0gZ2V0KGZpcnN0UmVjb3JkLCBmaXJzdFJlY29yZE5hbWUpOwogICAgICAgICBpZiAoaXNWYWx1ZShyZWxhdGlvbnNoaXApKSB7IHJlbGF0aW9uc2hpcC5yZW1vdmVPYmplY3Qoc2Vjb25kUmVjb3JkKTsgfQogICAgICB9KTsKICAgIH0KICB9CgogIHRoaXMuY29hbGVzY2UoKTsKfTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCiAgQG1vZHVsZSBlbWJlci1kYXRhCiovCgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7CnZhciBnZXQgPSBFbWJlci5nZXQsIHNldCA9IEVtYmVyLnNldCwKICAgIGlzTm9uZSA9IEVtYmVyLmlzTm9uZTsKCi8qKgogIEBtb2R1bGUgZW1iZXItZGF0YQoqLwoKZnVuY3Rpb24gYXN5bmNCZWxvbmdzVG8odHlwZSwgb3B0aW9ucywgbWV0YSkgewogIHJldHVybiBFbWJlci5jb21wdXRlZChmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICB2YXIgZGF0YSA9IGdldCh0aGlzLCAnZGF0YScpLAogICAgICAgIHN0b3JlID0gZ2V0KHRoaXMsICdzdG9yZScpLAogICAgICAgIHByb21pc2VMYWJlbCA9ICJEUzogQXN5bmMgYmVsb25nc1RvICIgKyB0aGlzICsgIiA6ICIgKyBrZXk7CgogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHsKICAgICAgRW1iZXIuYXNzZXJ0KCJZb3UgY2FuIG9ubHkgYWRkIGEgJyIgKyB0eXBlICsgIicgcmVjb3JkIHRvIHRoaXMgcmVsYXRpb25zaGlwIiwgIXZhbHVlIHx8IHZhbHVlIGluc3RhbmNlb2Ygc3RvcmUubW9kZWxGb3IodHlwZSkpOwogICAgICByZXR1cm4gdmFsdWUgPT09IHVuZGVmaW5lZCA/IG51bGwgOiBEUy5Qcm9taXNlT2JqZWN0LmNyZWF0ZSh7IHByb21pc2U6IEVtYmVyLlJTVlAucmVzb2x2ZSh2YWx1ZSwgcHJvbWlzZUxhYmVsKSB9KTsKICAgIH0KCiAgICB2YXIgbGluayA9IGRhdGEubGlua3MgJiYgZGF0YS5saW5rc1trZXldLAogICAgICAgIGJlbG9uZ3NUbyA9IGRhdGFba2V5XTsKCiAgICBpZighaXNOb25lKGJlbG9uZ3NUbykpIHsKICAgICAgdmFyIHByb21pc2UgPSBzdG9yZS5mZXRjaFJlY29yZChiZWxvbmdzVG8pIHx8IEVtYmVyLlJTVlAucmVzb2x2ZShiZWxvbmdzVG8sIHByb21pc2VMYWJlbCk7CiAgICAgIHJldHVybiBEUy5Qcm9taXNlT2JqZWN0LmNyZWF0ZSh7IHByb21pc2U6IHByb21pc2V9KTsKICAgIH0gZWxzZSBpZiAobGluaykgewogICAgICB2YXIgcmVzb2x2ZXIgPSBFbWJlci5SU1ZQLmRlZmVyKCJEUzogQXN5bmMgYmVsb25nc1RvIChsaW5rKSAiICsgdGhpcyArICIgOiAiICsga2V5KTsKICAgICAgc3RvcmUuZmluZEJlbG9uZ3NUbyh0aGlzLCBsaW5rLCBtZXRhLCByZXNvbHZlcik7CiAgICAgIHJldHVybiBEUy5Qcm9taXNlT2JqZWN0LmNyZWF0ZSh7IHByb21pc2U6IHJlc29sdmVyLnByb21pc2UgfSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9KS5wcm9wZXJ0eSgnZGF0YScpLm1ldGEobWV0YSk7Cn0KCi8qKgogIGBEUy5iZWxvbmdzVG9gIGlzIHVzZWQgdG8gZGVmaW5lIE9uZS1Uby1PbmUgYW5kIE9uZS1Uby1NYW55CiAgcmVsYXRpb25zaGlwcyBvbiBhIFtEUy5Nb2RlbF0oRFMuTW9kZWwuaHRtbCkuCgoKICBgRFMuYmVsb25nc1RvYCB0YWtlcyBhbiBvcHRpb25hbCBoYXNoIGFzIGEgc2Vjb25kIHBhcmFtZXRlciwgY3VycmVudGx5CiAgc3VwcG9ydGVkIG9wdGlvbnMgYXJlOgoKICAtIGBhc3luY2A6IEEgYm9vbGVhbiB2YWx1ZSB1c2VkIHRvIGV4cGxpY2l0bHkgZGVjbGFyZSB0aGlzIHRvIGJlIGFuIGFzeW5jIHJlbGF0aW9uc2hpcC4KICAtIGBpbnZlcnNlYDogQSBzdHJpbmcgdXNlZCB0byBpZGVudGlmeSB0aGUgaW52ZXJzZSBwcm9wZXJ0eSBvbiBhCiAgICByZWxhdGVkIG1vZGVsIGluIGEgT25lLVRvLU1hbnkgcmVsYXRpb25zaGlwLiBTZWUgW0V4cGxpY2l0IEludmVyc2VzXSgjdG9jX2V4cGxpY2l0LWludmVyc2VzKQoKICAjIyMjIE9uZS1Uby1PbmUKICBUbyBkZWNsYXJlIGEgb25lLXRvLW9uZSByZWxhdGlvbnNoaXAgYmV0d2VlbiB0d28gbW9kZWxzLCB1c2UKICBgRFMuYmVsb25nc1RvYDoKCiAgYGBgamF2YXNjcmlwdAogIEFwcC5Vc2VyID0gRFMuTW9kZWwuZXh0ZW5kKHsKICAgIHByb2ZpbGU6IERTLmJlbG9uZ3NUbygncHJvZmlsZScpCiAgfSk7CgogIEFwcC5Qcm9maWxlID0gRFMuTW9kZWwuZXh0ZW5kKHsKICAgIHVzZXI6IERTLmJlbG9uZ3NUbygndXNlcicpCiAgfSk7CiAgYGBgCgogICMjIyMgT25lLVRvLU1hbnkKICBUbyBkZWNsYXJlIGEgb25lLXRvLW1hbnkgcmVsYXRpb25zaGlwIGJldHdlZW4gdHdvIG1vZGVscywgdXNlCiAgYERTLmJlbG9uZ3NUb2AgaW4gY29tYmluYXRpb24gd2l0aCBgRFMuaGFzTWFueWAsIGxpa2UgdGhpczoKCiAgYGBgamF2YXNjcmlwdAogIEFwcC5Qb3N0ID0gRFMuTW9kZWwuZXh0ZW5kKHsKICAgIGNvbW1lbnRzOiBEUy5oYXNNYW55KCdjb21tZW50JykKICB9KTsKCiAgQXBwLkNvbW1lbnQgPSBEUy5Nb2RlbC5leHRlbmQoewogICAgcG9zdDogRFMuYmVsb25nc1RvKCdwb3N0JykKICB9KTsKICBgYGAKCiAgQG5hbWVzcGFjZQogIEBtZXRob2QgYmVsb25nc1RvCiAgQGZvciBEUwogIEBwYXJhbSB7U3RyaW5nIG9yIERTLk1vZGVsfSB0eXBlIHRoZSBtb2RlbCB0eXBlIG9mIHRoZSByZWxhdGlvbnNoaXAKICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBhIGhhc2ggb2Ygb3B0aW9ucwogIEByZXR1cm4ge0VtYmVyLmNvbXB1dGVkfSByZWxhdGlvbnNoaXAKKi8KRFMuYmVsb25nc1RvID0gZnVuY3Rpb24odHlwZSwgb3B0aW9ucykgewogIGlmICh0eXBlb2YgdHlwZSA9PT0gJ29iamVjdCcpIHsKICAgIG9wdGlvbnMgPSB0eXBlOwogICAgdHlwZSA9IHVuZGVmaW5lZDsKICB9IGVsc2UgewogICAgRW1iZXIuYXNzZXJ0KCJUaGUgZmlyc3QgYXJndW1lbnQgRFMuYmVsb25nc1RvIG11c3QgYmUgYSBtb2RlbCB0eXBlIG9yIHN0cmluZywgbGlrZSBEUy5iZWxvbmdzVG8oQXBwLlBlcnNvbikiLCAhIXR5cGUgJiYgKHR5cGVvZiB0eXBlID09PSAnc3RyaW5nJyB8fCBEUy5Nb2RlbC5kZXRlY3QodHlwZSkpKTsKICB9CgogIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICB2YXIgbWV0YSA9IHsgdHlwZTogdHlwZSwgaXNSZWxhdGlvbnNoaXA6IHRydWUsIG9wdGlvbnM6IG9wdGlvbnMsIGtpbmQ6ICdiZWxvbmdzVG8nIH07CgogIGlmIChvcHRpb25zLmFzeW5jKSB7CiAgICByZXR1cm4gYXN5bmNCZWxvbmdzVG8odHlwZSwgb3B0aW9ucywgbWV0YSk7CiAgfQoKICByZXR1cm4gRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgdmFyIGRhdGEgPSBnZXQodGhpcywgJ2RhdGEnKSwKICAgICAgICBzdG9yZSA9IGdldCh0aGlzLCAnc3RvcmUnKSwgYmVsb25nc1RvLCB0eXBlQ2xhc3M7CgogICAgaWYgKHR5cGVvZiB0eXBlID09PSAnc3RyaW5nJykgewogICAgICB0eXBlQ2xhc3MgPSBzdG9yZS5tb2RlbEZvcih0eXBlKTsKICAgIH0gZWxzZSB7CiAgICAgIHR5cGVDbGFzcyA9IHR5cGU7CiAgICB9CgogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHsKICAgICAgRW1iZXIuYXNzZXJ0KCJZb3UgY2FuIG9ubHkgYWRkIGEgJyIgKyB0eXBlICsgIicgcmVjb3JkIHRvIHRoaXMgcmVsYXRpb25zaGlwIiwgIXZhbHVlIHx8IHZhbHVlIGluc3RhbmNlb2YgdHlwZUNsYXNzKTsKICAgICAgcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPyBudWxsIDogdmFsdWU7CiAgICB9CgogICAgYmVsb25nc1RvID0gZGF0YVtrZXldOwoKICAgIGlmIChpc05vbmUoYmVsb25nc1RvKSkgeyByZXR1cm4gbnVsbDsgfQoKICAgIHN0b3JlLmZldGNoUmVjb3JkKGJlbG9uZ3NUbyk7CgogICAgcmV0dXJuIGJlbG9uZ3NUbzsKICB9KS5wcm9wZXJ0eSgnZGF0YScpLm1ldGEobWV0YSk7Cn07CgovKioKICBUaGVzZSBvYnNlcnZlcnMgb2JzZXJ2ZSBhbGwgYGJlbG9uZ3NUb2AgcmVsYXRpb25zaGlwcyBvbiB0aGUgcmVjb3JkLiBTZWUKICBgcmVsYXRpb25zaGlwcy9leHRgIHRvIHNlZSBob3cgdGhlc2Ugb2JzZXJ2ZXJzIGdldCB0aGVpciBkZXBlbmRlbmNpZXMuCgogIEBjbGFzcyBNb2RlbAogIEBuYW1lc3BhY2UgRFMKKi8KRFMuTW9kZWwucmVvcGVuKHsKCiAgLyoqCiAgICBAbWV0aG9kIGJlbG9uZ3NUb1dpbGxDaGFuZ2UKICAgIEBwcml2YXRlCiAgICBAc3RhdGljCiAgICBAcGFyYW0gcmVjb3JkCiAgICBAcGFyYW0ga2V5CiAgKi8KICBiZWxvbmdzVG9XaWxsQ2hhbmdlOiBFbWJlci5iZWZvcmVPYnNlcnZlcihmdW5jdGlvbihyZWNvcmQsIGtleSkgewogICAgaWYgKGdldChyZWNvcmQsICdpc0xvYWRlZCcpKSB7CiAgICAgIHZhciBvbGRQYXJlbnQgPSBnZXQocmVjb3JkLCBrZXkpOwoKICAgICAgaWYgKG9sZFBhcmVudCkgewogICAgICAgIHZhciBzdG9yZSA9IGdldChyZWNvcmQsICdzdG9yZScpLAogICAgICAgICAgICBjaGFuZ2UgPSBEUy5SZWxhdGlvbnNoaXBDaGFuZ2UuY3JlYXRlQ2hhbmdlKHJlY29yZCwgb2xkUGFyZW50LCBzdG9yZSwgeyBrZXk6IGtleSwga2luZDogImJlbG9uZ3NUbyIsIGNoYW5nZVR5cGU6ICJyZW1vdmUiIH0pOwoKICAgICAgICBjaGFuZ2Uuc3luYygpOwogICAgICAgIHRoaXMuX2NoYW5nZXNUb1N5bmNba2V5XSA9IGNoYW5nZTsKICAgICAgfQogICAgfQogIH0pLAoKICAvKioKICAgIEBtZXRob2QgYmVsb25nc1RvRGlkQ2hhbmdlCiAgICBAcHJpdmF0ZQogICAgQHN0YXRpYwogICAgQHBhcmFtIHJlY29yZAogICAgQHBhcmFtIGtleQogICovCiAgYmVsb25nc1RvRGlkQ2hhbmdlOiBFbWJlci5pbW1lZGlhdGVPYnNlcnZlcihmdW5jdGlvbihyZWNvcmQsIGtleSkgewogICAgaWYgKGdldChyZWNvcmQsICdpc0xvYWRlZCcpKSB7CiAgICAgIHZhciBuZXdQYXJlbnQgPSBnZXQocmVjb3JkLCBrZXkpOwoKICAgICAgaWYgKG5ld1BhcmVudCkgewogICAgICAgIHZhciBzdG9yZSA9IGdldChyZWNvcmQsICdzdG9yZScpLAogICAgICAgICAgICBjaGFuZ2UgPSBEUy5SZWxhdGlvbnNoaXBDaGFuZ2UuY3JlYXRlQ2hhbmdlKHJlY29yZCwgbmV3UGFyZW50LCBzdG9yZSwgeyBrZXk6IGtleSwga2luZDogImJlbG9uZ3NUbyIsIGNoYW5nZVR5cGU6ICJhZGQiIH0pOwoKICAgICAgICBjaGFuZ2Uuc3luYygpOwogICAgICB9CiAgICB9CgogICAgZGVsZXRlIHRoaXMuX2NoYW5nZXNUb1N5bmNba2V5XTsKICB9KQp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCiAgQG1vZHVsZSBlbWJlci1kYXRhCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQsIHNldFByb3BlcnRpZXMgPSBFbWJlci5zZXRQcm9wZXJ0aWVzOwoKZnVuY3Rpb24gYXN5bmNIYXNNYW55KHR5cGUsIG9wdGlvbnMsIG1ldGEpIHsKICByZXR1cm4gRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgdmFyIHJlbGF0aW9uc2hpcCA9IHRoaXMuX3JlbGF0aW9uc2hpcHNba2V5XSwKICAgICAgICBwcm9taXNlTGFiZWwgPSAiRFM6IEFzeW5jIGhhc01hbnkgIiArIHRoaXMgKyAiIDogIiArIGtleTsKCiAgICBpZiAoIXJlbGF0aW9uc2hpcCkgewogICAgICB2YXIgcmVzb2x2ZXIgPSBFbWJlci5SU1ZQLmRlZmVyKHByb21pc2VMYWJlbCk7CiAgICAgIHJlbGF0aW9uc2hpcCA9IGJ1aWxkUmVsYXRpb25zaGlwKHRoaXMsIGtleSwgb3B0aW9ucywgZnVuY3Rpb24oc3RvcmUsIGRhdGEpIHsKICAgICAgICB2YXIgbGluayA9IGRhdGEubGlua3MgJiYgZGF0YS5saW5rc1trZXldOwogICAgICAgIHZhciByZWw7CiAgICAgICAgaWYgKGxpbmspIHsKICAgICAgICAgIHJlbCA9IHN0b3JlLmZpbmRIYXNNYW55KHRoaXMsIGxpbmssIG1ldGEsIHJlc29sdmVyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVsID0gc3RvcmUuZmluZE1hbnkodGhpcywgZGF0YVtrZXldLCBtZXRhLnR5cGUsIHJlc29sdmVyKTsKICAgICAgICB9CiAgICAgICAgLy8gY2FjaGUgdGhlIHByb21pc2Ugc28gd2UgY2FuIHVzZSBpdAogICAgICAgIC8vIHdoZW4gd2UgY29tZSBiYWNrIGFuZCBkb24ndCBuZWVkIHRvIHJlYnVpbGQKICAgICAgICAvLyB0aGUgcmVsYXRpb25zaGlwLgogICAgICAgIHNldChyZWwsICdwcm9taXNlJywgcmVzb2x2ZXIucHJvbWlzZSk7CiAgICAgICAgcmV0dXJuIHJlbDsKICAgICAgfSk7CiAgICB9CgogICAgdmFyIHByb21pc2UgPSByZWxhdGlvbnNoaXAuZ2V0KCdwcm9taXNlJykudGhlbihmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHJlbGF0aW9uc2hpcDsKICAgIH0sIG51bGwsICJEUzogQXN5bmMgaGFzTWFueSByZWNvcmRzIHJlY2VpdmVkIik7CgogICAgcmV0dXJuIERTLlByb21pc2VBcnJheS5jcmVhdGUoeyBwcm9taXNlOiBwcm9taXNlIH0pOwogIH0pLnByb3BlcnR5KCdkYXRhJykubWV0YShtZXRhKTsKfQoKZnVuY3Rpb24gYnVpbGRSZWxhdGlvbnNoaXAocmVjb3JkLCBrZXksIG9wdGlvbnMsIGNhbGxiYWNrKSB7CiAgdmFyIHJlbHMgPSByZWNvcmQuX3JlbGF0aW9uc2hpcHM7CgogIGlmIChyZWxzW2tleV0pIHsgcmV0dXJuIHJlbHNba2V5XTsgfQoKICB2YXIgZGF0YSA9IGdldChyZWNvcmQsICdkYXRhJyksCiAgICAgIHN0b3JlID0gZ2V0KHJlY29yZCwgJ3N0b3JlJyk7CgogIHZhciByZWxhdGlvbnNoaXAgPSByZWxzW2tleV0gPSBjYWxsYmFjay5jYWxsKHJlY29yZCwgc3RvcmUsIGRhdGEpOwoKICByZXR1cm4gc2V0UHJvcGVydGllcyhyZWxhdGlvbnNoaXAsIHsKICAgIG93bmVyOiByZWNvcmQsIG5hbWU6IGtleSwgaXNQb2x5bW9ycGhpYzogb3B0aW9ucy5wb2x5bW9ycGhpYwogIH0pOwp9CgpmdW5jdGlvbiBoYXNSZWxhdGlvbnNoaXAodHlwZSwgb3B0aW9ucykgewogIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICB2YXIgbWV0YSA9IHsgdHlwZTogdHlwZSwgaXNSZWxhdGlvbnNoaXA6IHRydWUsIG9wdGlvbnM6IG9wdGlvbnMsIGtpbmQ6ICdoYXNNYW55JyB9OwoKICBpZiAob3B0aW9ucy5hc3luYykgewogICAgcmV0dXJuIGFzeW5jSGFzTWFueSh0eXBlLCBvcHRpb25zLCBtZXRhKTsKICB9CgogIHJldHVybiBFbWJlci5jb21wdXRlZChmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICByZXR1cm4gYnVpbGRSZWxhdGlvbnNoaXAodGhpcywga2V5LCBvcHRpb25zLCBmdW5jdGlvbihzdG9yZSwgZGF0YSkgewogICAgICB2YXIgcmVjb3JkcyA9IGRhdGFba2V5XTsKICAgICAgRW1iZXIuYXNzZXJ0KCJZb3UgbG9va2VkIHVwIHRoZSAnIiArIGtleSArICInIHJlbGF0aW9uc2hpcCBvbiAnIiArIHRoaXMgKyAiJyBidXQgc29tZSBvZiB0aGUgYXNzb2NpYXRlZCByZWNvcmRzIHdlcmUgbm90IGxvYWRlZC4gRWl0aGVyIG1ha2Ugc3VyZSB0aGV5IGFyZSBhbGwgbG9hZGVkIHRvZ2V0aGVyIHdpdGggdGhlIHBhcmVudCByZWNvcmQsIG9yIHNwZWNpZnkgdGhhdCB0aGUgcmVsYXRpb25zaGlwIGlzIGFzeW5jIChgRFMuaGFzTWFueSh7IGFzeW5jOiB0cnVlIH0pYCkiLCBFbWJlci5BKHJlY29yZHMpLmV2ZXJ5UHJvcGVydHkoJ2lzRW1wdHknLCBmYWxzZSkpOwogICAgICByZXR1cm4gc3RvcmUuZmluZE1hbnkodGhpcywgZGF0YVtrZXldLCBtZXRhLnR5cGUpOwogICAgfSk7CiAgfSkucHJvcGVydHkoJ2RhdGEnKS5tZXRhKG1ldGEpOwp9CgovKioKICBgRFMuaGFzTWFueWAgaXMgdXNlZCB0byBkZWZpbmUgT25lLVRvLU1hbnkgYW5kIE1hbnktVG8tTWFueQogIHJlbGF0aW9uc2hpcHMgb24gYSBbRFMuTW9kZWxdKERTLk1vZGVsLmh0bWwpLgoKICBgRFMuaGFzTWFueWAgdGFrZXMgYW4gb3B0aW9uYWwgaGFzaCBhcyBhIHNlY29uZCBwYXJhbWV0ZXIsIGN1cnJlbnRseQogIHN1cHBvcnRlZCBvcHRpb25zIGFyZToKCiAgLSBgYXN5bmNgOiBBIGJvb2xlYW4gdmFsdWUgdXNlZCB0byBleHBsaWNpdGx5IGRlY2xhcmUgdGhpcyB0byBiZSBhbiBhc3luYyByZWxhdGlvbnNoaXAuCiAgLSBgaW52ZXJzZWA6IEEgc3RyaW5nIHVzZWQgdG8gaWRlbnRpZnkgdGhlIGludmVyc2UgcHJvcGVydHkgb24gYSByZWxhdGVkIG1vZGVsLgoKICAjIyMjIE9uZS1Uby1NYW55CiAgVG8gZGVjbGFyZSBhIG9uZS10by1tYW55IHJlbGF0aW9uc2hpcCBiZXR3ZWVuIHR3byBtb2RlbHMsIHVzZQogIGBEUy5iZWxvbmdzVG9gIGluIGNvbWJpbmF0aW9uIHdpdGggYERTLmhhc01hbnlgLCBsaWtlIHRoaXM6CgogIGBgYGphdmFzY3JpcHQKICBBcHAuUG9zdCA9IERTLk1vZGVsLmV4dGVuZCh7CiAgICBjb21tZW50czogRFMuaGFzTWFueSgnY29tbWVudCcpCiAgfSk7CgogIEFwcC5Db21tZW50ID0gRFMuTW9kZWwuZXh0ZW5kKHsKICAgIHBvc3Q6IERTLmJlbG9uZ3NUbygncG9zdCcpCiAgfSk7CiAgYGBgCgogICMjIyMgTWFueS1Uby1NYW55CiAgVG8gZGVjbGFyZSBhIG1hbnktdG8tbWFueSByZWxhdGlvbnNoaXAgYmV0d2VlbiB0d28gbW9kZWxzLCB1c2UKICBgRFMuaGFzTWFueWA6CgogIGBgYGphdmFzY3JpcHQKICBBcHAuUG9zdCA9IERTLk1vZGVsLmV4dGVuZCh7CiAgICB0YWdzOiBEUy5oYXNNYW55KCd0YWcnKQogIH0pOwoKICBBcHAuVGFnID0gRFMuTW9kZWwuZXh0ZW5kKHsKICAgIHBvc3RzOiBEUy5oYXNNYW55KCdwb3N0JykKICB9KTsKICBgYGAKCiAgIyMjIyBFeHBsaWNpdCBJbnZlcnNlcwoKICBFbWJlciBEYXRhIHdpbGwgZG8gaXRzIGJlc3QgdG8gZGlzY292ZXIgd2hpY2ggcmVsYXRpb25zaGlwcyBtYXAgdG8KICBvbmUgYW5vdGhlci4gSW4gdGhlIG9uZS10by1tYW55IGNvZGUgYWJvdmUsIGZvciBleGFtcGxlLCBFbWJlciBEYXRhCiAgY2FuIGZpZ3VyZSBvdXQgdGhhdCBjaGFuZ2luZyB0aGUgYGNvbW1lbnRzYCByZWxhdGlvbnNoaXAgc2hvdWxkIHVwZGF0ZQogIHRoZSBgcG9zdGAgcmVsYXRpb25zaGlwIG9uIHRoZSBpbnZlcnNlIGJlY2F1c2UgcG9zdCBpcyB0aGUgb25seQogIHJlbGF0aW9uc2hpcCB0byB0aGF0IG1vZGVsLgoKICBIb3dldmVyLCBzb21ldGltZXMgeW91IG1heSBoYXZlIG11bHRpcGxlIGBiZWxvbmdzVG9gL2BoYXNNYW55c2AgZm9yIHRoZQogIHNhbWUgdHlwZS4gWW91IGNhbiBzcGVjaWZ5IHdoaWNoIHByb3BlcnR5IG9uIHRoZSByZWxhdGVkIG1vZGVsIGlzCiAgdGhlIGludmVyc2UgdXNpbmcgYERTLmhhc01hbnlgJ3MgYGludmVyc2VgIG9wdGlvbjoKCiAgYGBgamF2YXNjcmlwdAogIHZhciBiZWxvbmdzVG8gPSBEUy5iZWxvbmdzVG8sCiAgICAgIGhhc01hbnkgPSBEUy5oYXNNYW55OwoKICBBcHAuQ29tbWVudCA9IERTLk1vZGVsLmV4dGVuZCh7CiAgICBvbmVQb3N0OiBiZWxvbmdzVG8oJ3Bvc3QnKSwKICAgIHR3b1Bvc3Q6IGJlbG9uZ3NUbygncG9zdCcpLAogICAgcmVkUG9zdDogYmVsb25nc1RvKCdwb3N0JyksCiAgICBibHVlUG9zdDogYmVsb25nc1RvKCdwb3N0JykKICB9KTsKCiAgQXBwLlBvc3QgPSBEUy5Nb2RlbC5leHRlbmQoewogICAgY29tbWVudHM6IGhhc01hbnkoJ2NvbW1lbnQnLCB7CiAgICAgIGludmVyc2U6ICdyZWRQb3N0JwogICAgfSkKICB9KTsKICBgYGAKCiAgWW91IGNhbiBhbHNvIHNwZWNpZnkgYW4gaW52ZXJzZSBvbiBhIGBiZWxvbmdzVG9gLCB3aGljaCB3b3JrcyBob3cKICB5b3UnZCBleHBlY3QuCgogIEBuYW1lc3BhY2UKICBAbWV0aG9kIGhhc01hbnkKICBAZm9yIERTCiAgQHBhcmFtIHtTdHJpbmcgb3IgRFMuTW9kZWx9IHR5cGUgdGhlIG1vZGVsIHR5cGUgb2YgdGhlIHJlbGF0aW9uc2hpcAogIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIGEgaGFzaCBvZiBvcHRpb25zCiAgQHJldHVybiB7RW1iZXIuY29tcHV0ZWR9IHJlbGF0aW9uc2hpcAoqLwpEUy5oYXNNYW55ID0gZnVuY3Rpb24odHlwZSwgb3B0aW9ucykgewogIGlmICh0eXBlb2YgdHlwZSA9PT0gJ29iamVjdCcpIHsKICAgIG9wdGlvbnMgPSB0eXBlOwogICAgdHlwZSA9IHVuZGVmaW5lZDsKICB9CiAgcmV0dXJuIGhhc1JlbGF0aW9uc2hpcCh0eXBlLCBvcHRpb25zKTsKfTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKdmFyIGdldCA9IEVtYmVyLmdldCwgc2V0ID0gRW1iZXIuc2V0OwoKLyoqCiAgQG1vZHVsZSBlbWJlci1kYXRhCiovCgovKgogIFRoaXMgZmlsZSBkZWZpbmVzIHNldmVyYWwgZXh0ZW5zaW9ucyB0byB0aGUgYmFzZSBgRFMuTW9kZWxgIGNsYXNzIHRoYXQKICBhZGQgc3VwcG9ydCBmb3Igb25lLXRvLW1hbnkgcmVsYXRpb25zaGlwcy4KKi8KCi8qKgogIEBjbGFzcyBNb2RlbAogIEBuYW1lc3BhY2UgRFMKKi8KRFMuTW9kZWwucmVvcGVuKHsKCiAgLyoqCiAgICBUaGlzIEVtYmVyLmpzIGhvb2sgYWxsb3dzIGFuIG9iamVjdCB0byBiZSBub3RpZmllZCB3aGVuIGEgcHJvcGVydHkKICAgIGlzIGRlZmluZWQuCgogICAgSW4gdGhpcyBjYXNlLCB3ZSB1c2UgaXQgdG8gYmUgbm90aWZpZWQgd2hlbiBhbiBFbWJlciBEYXRhIHVzZXIgZGVmaW5lcyBhCiAgICBiZWxvbmdzLXRvIHJlbGF0aW9uc2hpcC4gSW4gdGhhdCBjYXNlLCB3ZSBuZWVkIHRvIHNldCB1cCBvYnNlcnZlcnMgZm9yCiAgICBlYWNoIG9uZSwgYWxsb3dpbmcgdXMgdG8gdHJhY2sgcmVsYXRpb25zaGlwIGNoYW5nZXMgYW5kIGF1dG9tYXRpY2FsbHkKICAgIHJlZmxlY3QgY2hhbmdlcyBpbiB0aGUgaW52ZXJzZSBoYXMtbWFueSBhcnJheS4KCiAgICBUaGlzIGhvb2sgcGFzc2VzIHRoZSBjbGFzcyBiZWluZyBzZXQgdXAsIGFzIHdlbGwgYXMgdGhlIGtleSBhbmQgdmFsdWUKICAgIGJlaW5nIGRlZmluZWQuIFNvLCBmb3IgZXhhbXBsZSwgd2hlbiB0aGUgdXNlciBkb2VzIHRoaXM6CgogICAgYGBgamF2YXNjcmlwdAogICAgRFMuTW9kZWwuZXh0ZW5kKHsKICAgICAgcGFyZW50OiBEUy5iZWxvbmdzVG8oJ3VzZXInKQogICAgfSk7CiAgICBgYGAKCiAgICBUaGlzIGhvb2sgd291bGQgYmUgY2FsbGVkIHdpdGggInBhcmVudCIgYXMgdGhlIGtleSBhbmQgdGhlIGNvbXB1dGVkCiAgICBwcm9wZXJ0eSByZXR1cm5lZCBieSBgRFMuYmVsb25nc1RvYCBhcyB0aGUgdmFsdWUuCgogICAgQG1ldGhvZCBkaWREZWZpbmVQcm9wZXJ0eQogICAgQHBhcmFtIHByb3RvCiAgICBAcGFyYW0ga2V5CiAgICBAcGFyYW0gdmFsdWUKICAqLwogIGRpZERlZmluZVByb3BlcnR5OiBmdW5jdGlvbihwcm90bywga2V5LCB2YWx1ZSkgewogICAgLy8gQ2hlY2sgaWYgdGhlIHZhbHVlIGJlaW5nIHNldCBpcyBhIGNvbXB1dGVkIHByb3BlcnR5LgogICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRW1iZXIuRGVzY3JpcHRvcikgewoKICAgICAgLy8gSWYgaXQgaXMsIGdldCB0aGUgbWV0YWRhdGEgZm9yIHRoZSByZWxhdGlvbnNoaXAuIFRoaXMgaXMKICAgICAgLy8gcG9wdWxhdGVkIGJ5IHRoZSBgRFMuYmVsb25nc1RvYCBoZWxwZXIgd2hlbiBpdCBpcyBjcmVhdGluZwogICAgICAvLyB0aGUgY29tcHV0ZWQgcHJvcGVydHkuCiAgICAgIHZhciBtZXRhID0gdmFsdWUubWV0YSgpOwoKICAgICAgaWYgKG1ldGEuaXNSZWxhdGlvbnNoaXAgJiYgbWV0YS5raW5kID09PSAnYmVsb25nc1RvJykgewogICAgICAgIEVtYmVyLmFkZE9ic2VydmVyKHByb3RvLCBrZXksIG51bGwsICdiZWxvbmdzVG9EaWRDaGFuZ2UnKTsKICAgICAgICBFbWJlci5hZGRCZWZvcmVPYnNlcnZlcihwcm90bywga2V5LCBudWxsLCAnYmVsb25nc1RvV2lsbENoYW5nZScpOwogICAgICB9CgogICAgICBtZXRhLnBhcmVudFR5cGUgPSBwcm90by5jb25zdHJ1Y3RvcjsKICAgIH0KICB9Cn0pOwoKLyoKICBUaGVzZSBEUy5Nb2RlbCBleHRlbnNpb25zIGFkZCBjbGFzcyBtZXRob2RzIHRoYXQgcHJvdmlkZSByZWxhdGlvbnNoaXAKICBpbnRyb3NwZWN0aW9uIGFiaWxpdGllcyBhYm91dCByZWxhdGlvbnNoaXBzLgoKICBBIG5vdGUgYWJvdXQgdGhlIGNvbXB1dGVkIHByb3BlcnRpZXMgY29udGFpbmVkIGhlcmU6CgogICoqVGhlc2UgcHJvcGVydGllcyBhcmUgZWZmZWN0aXZlbHkgc2VhbGVkIG9uY2UgY2FsbGVkIGZvciB0aGUgZmlyc3QgdGltZS4qKgogIFRvIGF2b2lkIHJlcGVhdGVkbHkgZG9pbmcgZXhwZW5zaXZlIGl0ZXJhdGlvbiBvdmVyIGEgbW9kZWwncyBmaWVsZHMsIHRoZXNlCiAgdmFsdWVzIGFyZSBjb21wdXRlZCBvbmNlIGFuZCB0aGVuIGNhY2hlZCBmb3IgdGhlIHJlbWFpbmRlciBvZiB0aGUgcnVudGltZSBvZgogIHlvdXIgYXBwbGljYXRpb24uCgogIElmIHlvdXIgYXBwbGljYXRpb24gbmVlZHMgdG8gbW9kaWZ5IGEgY2xhc3MgYWZ0ZXIgaXRzIGluaXRpYWwgZGVmaW5pdGlvbgogIChmb3IgZXhhbXBsZSwgdXNpbmcgYHJlb3BlbigpYCB0byBhZGQgYWRkaXRpb25hbCBhdHRyaWJ1dGVzKSwgbWFrZSBzdXJlIHlvdQogIGRvIGl0IGJlZm9yZSB1c2luZyB5b3VyIG1vZGVsIHdpdGggdGhlIHN0b3JlLCB3aGljaCB1c2VzIHRoZXNlIHByb3BlcnRpZXMKICBleHRlbnNpdmVseS4KKi8KCkRTLk1vZGVsLnJlb3BlbkNsYXNzKHsKICAvKioKICAgIEZvciBhIGdpdmVuIHJlbGF0aW9uc2hpcCBuYW1lLCByZXR1cm5zIHRoZSBtb2RlbCB0eXBlIG9mIHRoZSByZWxhdGlvbnNoaXAuCgogICAgRm9yIGV4YW1wbGUsIGlmIHlvdSBkZWZpbmUgYSBtb2RlbCBsaWtlIHRoaXM6CgogICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuUG9zdCA9IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgIGNvbW1lbnRzOiBEUy5oYXNNYW55KCdjb21tZW50JykKICAgIH0pOwogICBgYGAKCiAgICBDYWxsaW5nIGBBcHAuUG9zdC50eXBlRm9yUmVsYXRpb25zaGlwKCdjb21tZW50cycpYCB3aWxsIHJldHVybiBgQXBwLkNvbW1lbnRgLgoKICAgIEBtZXRob2QgdHlwZUZvclJlbGF0aW9uc2hpcAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgdGhlIG5hbWUgb2YgdGhlIHJlbGF0aW9uc2hpcAogICAgQHJldHVybiB7c3ViY2xhc3Mgb2YgRFMuTW9kZWx9IHRoZSB0eXBlIG9mIHRoZSByZWxhdGlvbnNoaXAsIG9yIHVuZGVmaW5lZAogICovCiAgdHlwZUZvclJlbGF0aW9uc2hpcDogZnVuY3Rpb24obmFtZSkgewogICAgdmFyIHJlbGF0aW9uc2hpcCA9IGdldCh0aGlzLCAncmVsYXRpb25zaGlwc0J5TmFtZScpLmdldChuYW1lKTsKICAgIHJldHVybiByZWxhdGlvbnNoaXAgJiYgcmVsYXRpb25zaGlwLnR5cGU7CiAgfSwKCiAgaW52ZXJzZUZvcjogZnVuY3Rpb24obmFtZSkgewogICAgdmFyIGludmVyc2VUeXBlID0gdGhpcy50eXBlRm9yUmVsYXRpb25zaGlwKG5hbWUpOwoKICAgIGlmICghaW52ZXJzZVR5cGUpIHsgcmV0dXJuIG51bGw7IH0KCiAgICB2YXIgb3B0aW9ucyA9IHRoaXMubWV0YUZvclByb3BlcnR5KG5hbWUpLm9wdGlvbnM7CgogICAgaWYgKG9wdGlvbnMuaW52ZXJzZSA9PT0gbnVsbCkgeyByZXR1cm4gbnVsbDsgfQogICAgCiAgICB2YXIgaW52ZXJzZU5hbWUsIGludmVyc2VLaW5kOwoKICAgIGlmIChvcHRpb25zLmludmVyc2UpIHsKICAgICAgaW52ZXJzZU5hbWUgPSBvcHRpb25zLmludmVyc2U7CiAgICAgIGludmVyc2VLaW5kID0gRW1iZXIuZ2V0KGludmVyc2VUeXBlLCAncmVsYXRpb25zaGlwc0J5TmFtZScpLmdldChpbnZlcnNlTmFtZSkua2luZDsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBwb3NzaWJsZVJlbGF0aW9uc2hpcHMgPSBmaW5kUG9zc2libGVJbnZlcnNlcyh0aGlzLCBpbnZlcnNlVHlwZSk7CgogICAgICBpZiAocG9zc2libGVSZWxhdGlvbnNoaXBzLmxlbmd0aCA9PT0gMCkgeyByZXR1cm4gbnVsbDsgfQoKICAgICAgRW1iZXIuYXNzZXJ0KCJZb3UgZGVmaW5lZCB0aGUgJyIgKyBuYW1lICsgIicgcmVsYXRpb25zaGlwIG9uICIgKyB0aGlzICsgIiwgYnV0IG11bHRpcGxlIHBvc3NpYmxlIGludmVyc2UgcmVsYXRpb25zaGlwcyBvZiB0eXBlICIgKyB0aGlzICsgIiB3ZXJlIGZvdW5kIG9uICIgKyBpbnZlcnNlVHlwZSArICIuIExvb2sgYXQgaHR0cDovL2VtYmVyanMuY29tL2d1aWRlcy9tb2RlbHMvZGVmaW5pbmctbW9kZWxzLyN0b2NfZXhwbGljaXQtaW52ZXJzZXMgZm9yIGhvdyB0byBleHBsaWNpdGx5IHNwZWNpZnkgaW52ZXJzZXMiLCBwb3NzaWJsZVJlbGF0aW9uc2hpcHMubGVuZ3RoID09PSAxKTsKCiAgICAgIGludmVyc2VOYW1lID0gcG9zc2libGVSZWxhdGlvbnNoaXBzWzBdLm5hbWU7CiAgICAgIGludmVyc2VLaW5kID0gcG9zc2libGVSZWxhdGlvbnNoaXBzWzBdLmtpbmQ7CiAgICB9CgogICAgZnVuY3Rpb24gZmluZFBvc3NpYmxlSW52ZXJzZXModHlwZSwgaW52ZXJzZVR5cGUsIHBvc3NpYmxlUmVsYXRpb25zaGlwcykgewogICAgICBwb3NzaWJsZVJlbGF0aW9uc2hpcHMgPSBwb3NzaWJsZVJlbGF0aW9uc2hpcHMgfHwgW107CgogICAgICB2YXIgcmVsYXRpb25zaGlwTWFwID0gZ2V0KGludmVyc2VUeXBlLCAncmVsYXRpb25zaGlwcycpOwogICAgICBpZiAoIXJlbGF0aW9uc2hpcE1hcCkgeyByZXR1cm47IH0KCiAgICAgIHZhciByZWxhdGlvbnNoaXBzID0gcmVsYXRpb25zaGlwTWFwLmdldCh0eXBlKTsKICAgICAgaWYgKHJlbGF0aW9uc2hpcHMpIHsKICAgICAgICBwb3NzaWJsZVJlbGF0aW9uc2hpcHMucHVzaC5hcHBseShwb3NzaWJsZVJlbGF0aW9uc2hpcHMsIHJlbGF0aW9uc2hpcE1hcC5nZXQodHlwZSkpOwogICAgICB9CgogICAgICBpZiAodHlwZS5zdXBlcmNsYXNzKSB7CiAgICAgICAgZmluZFBvc3NpYmxlSW52ZXJzZXModHlwZS5zdXBlcmNsYXNzLCBpbnZlcnNlVHlwZSwgcG9zc2libGVSZWxhdGlvbnNoaXBzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHBvc3NpYmxlUmVsYXRpb25zaGlwczsKICAgIH0KCiAgICByZXR1cm4gewogICAgICB0eXBlOiBpbnZlcnNlVHlwZSwKICAgICAgbmFtZTogaW52ZXJzZU5hbWUsCiAgICAgIGtpbmQ6IGludmVyc2VLaW5kCiAgICB9OwogIH0sCgogIC8qKgogICAgVGhlIG1vZGVsJ3MgcmVsYXRpb25zaGlwcyBhcyBhIG1hcCwga2V5ZWQgb24gdGhlIHR5cGUgb2YgdGhlCiAgICByZWxhdGlvbnNoaXAuIFRoZSB2YWx1ZSBvZiBlYWNoIGVudHJ5IGlzIGFuIGFycmF5IGNvbnRhaW5pbmcgYSBkZXNjcmlwdG9yCiAgICBmb3IgZWFjaCByZWxhdGlvbnNoaXAgd2l0aCB0aGF0IHR5cGUsIGRlc2NyaWJpbmcgdGhlIG5hbWUgb2YgdGhlIHJlbGF0aW9uc2hpcAogICAgYXMgd2VsbCBhcyB0aGUgdHlwZS4KCiAgICBGb3IgZXhhbXBsZSwgZ2l2ZW4gdGhlIGZvbGxvd2luZyBtb2RlbCBkZWZpbml0aW9uOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIEFwcC5CbG9nID0gRFMuTW9kZWwuZXh0ZW5kKHsKICAgICAgdXNlcnM6IERTLmhhc01hbnkoJ3VzZXInKSwKICAgICAgb3duZXI6IERTLmJlbG9uZ3NUbygndXNlcicpLAogICAgICBwb3N0czogRFMuaGFzTWFueSgncG9zdCcpCiAgICB9KTsKICAgIGBgYAoKICAgIFRoaXMgY29tcHV0ZWQgcHJvcGVydHkgd291bGQgcmV0dXJuIGEgbWFwIGRlc2NyaWJpbmcgdGhlc2UKICAgIHJlbGF0aW9uc2hpcHMsIGxpa2UgdGhpczoKCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgcmVsYXRpb25zaGlwcyA9IEVtYmVyLmdldChBcHAuQmxvZywgJ3JlbGF0aW9uc2hpcHMnKTsKICAgIHJlbGF0aW9uc2hpcHMuZ2V0KEFwcC5Vc2VyKTsKICAgIC8vPT4gWyB7IG5hbWU6ICd1c2VycycsIGtpbmQ6ICdoYXNNYW55JyB9LAogICAgLy8gICAgIHsgbmFtZTogJ293bmVyJywga2luZDogJ2JlbG9uZ3NUbycgfSBdCiAgICByZWxhdGlvbnNoaXBzLmdldChBcHAuUG9zdCk7CiAgICAvLz0+IFsgeyBuYW1lOiAncG9zdHMnLCBraW5kOiAnaGFzTWFueScgfSBdCiAgICBgYGAKCiAgICBAcHJvcGVydHkgcmVsYXRpb25zaGlwcwogICAgQHN0YXRpYwogICAgQHR5cGUgRW1iZXIuTWFwCiAgICBAcmVhZE9ubHkKICAqLwogIHJlbGF0aW9uc2hpcHM6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewogICAgdmFyIG1hcCA9IG5ldyBFbWJlci5NYXBXaXRoRGVmYXVsdCh7CiAgICAgIGRlZmF1bHRWYWx1ZTogZnVuY3Rpb24oKSB7IHJldHVybiBbXTsgfQogICAgfSk7CgogICAgLy8gTG9vcCB0aHJvdWdoIGVhY2ggY29tcHV0ZWQgcHJvcGVydHkgb24gdGhlIGNsYXNzCiAgICB0aGlzLmVhY2hDb21wdXRlZFByb3BlcnR5KGZ1bmN0aW9uKG5hbWUsIG1ldGEpIHsKCiAgICAgIC8vIElmIHRoZSBjb21wdXRlZCBwcm9wZXJ0eSBpcyBhIHJlbGF0aW9uc2hpcCwgYWRkCiAgICAgIC8vIGl0IHRvIHRoZSBtYXAuCiAgICAgIGlmIChtZXRhLmlzUmVsYXRpb25zaGlwKSB7CiAgICAgICAgaWYgKHR5cGVvZiBtZXRhLnR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBtZXRhLnR5cGUgPSB0aGlzLnN0b3JlLm1vZGVsRm9yKG1ldGEudHlwZSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgcmVsYXRpb25zaGlwc0ZvclR5cGUgPSBtYXAuZ2V0KG1ldGEudHlwZSk7CgogICAgICAgIHJlbGF0aW9uc2hpcHNGb3JUeXBlLnB1c2goeyBuYW1lOiBuYW1lLCBraW5kOiBtZXRhLmtpbmQgfSk7CiAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybiBtYXA7CiAgfSksCgogIC8qKgogICAgQSBoYXNoIGNvbnRhaW5pbmcgbGlzdHMgb2YgdGhlIG1vZGVsJ3MgcmVsYXRpb25zaGlwcywgZ3JvdXBlZAogICAgYnkgdGhlIHJlbGF0aW9uc2hpcCBraW5kLiBGb3IgZXhhbXBsZSwgZ2l2ZW4gYSBtb2RlbCB3aXRoIHRoaXMKICAgIGRlZmluaXRpb246CgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLkJsb2cgPSBEUy5Nb2RlbC5leHRlbmQoewogICAgICB1c2VyczogRFMuaGFzTWFueSgndXNlcicpLAogICAgICBvd25lcjogRFMuYmVsb25nc1RvKCd1c2VyJyksCgogICAgICBwb3N0czogRFMuaGFzTWFueSgncG9zdCcpCiAgICB9KTsKICAgIGBgYAoKICAgIFRoaXMgcHJvcGVydHkgd291bGQgY29udGFpbiB0aGUgZm9sbG93aW5nOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIHZhciByZWxhdGlvbnNoaXBOYW1lcyA9IEVtYmVyLmdldChBcHAuQmxvZywgJ3JlbGF0aW9uc2hpcE5hbWVzJyk7CiAgICByZWxhdGlvbnNoaXBOYW1lcy5oYXNNYW55OwogICAgLy89PiBbJ3VzZXJzJywgJ3Bvc3RzJ10KICAgIHJlbGF0aW9uc2hpcE5hbWVzLmJlbG9uZ3NUbzsKICAgIC8vPT4gWydvd25lciddCiAgICBgYGAKCiAgICBAcHJvcGVydHkgcmVsYXRpb25zaGlwTmFtZXMKICAgIEBzdGF0aWMKICAgIEB0eXBlIE9iamVjdAogICAgQHJlYWRPbmx5CiAgKi8KICByZWxhdGlvbnNoaXBOYW1lczogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oKSB7CiAgICB2YXIgbmFtZXMgPSB7IGhhc01hbnk6IFtdLCBiZWxvbmdzVG86IFtdIH07CgogICAgdGhpcy5lYWNoQ29tcHV0ZWRQcm9wZXJ0eShmdW5jdGlvbihuYW1lLCBtZXRhKSB7CiAgICAgIGlmIChtZXRhLmlzUmVsYXRpb25zaGlwKSB7CiAgICAgICAgbmFtZXNbbWV0YS5raW5kXS5wdXNoKG5hbWUpOwogICAgICB9CiAgICB9KTsKCiAgICByZXR1cm4gbmFtZXM7CiAgfSksCgogIC8qKgogICAgQW4gYXJyYXkgb2YgdHlwZXMgZGlyZWN0bHkgcmVsYXRlZCB0byBhIG1vZGVsLiBFYWNoIHR5cGUgd2lsbCBiZQogICAgaW5jbHVkZWQgb25jZSwgcmVnYXJkbGVzcyBvZiB0aGUgbnVtYmVyIG9mIHJlbGF0aW9uc2hpcHMgaXQgaGFzIHdpdGgKICAgIHRoZSBtb2RlbC4KCiAgICBGb3IgZXhhbXBsZSwgZ2l2ZW4gYSBtb2RlbCB3aXRoIHRoaXMgZGVmaW5pdGlvbjoKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuQmxvZyA9IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgIHVzZXJzOiBEUy5oYXNNYW55KCd1c2VyJyksCiAgICAgIG93bmVyOiBEUy5iZWxvbmdzVG8oJ3VzZXInKSwKCiAgICAgIHBvc3RzOiBEUy5oYXNNYW55KCdwb3N0JykKICAgIH0pOwogICAgYGBgCgogICAgVGhpcyBwcm9wZXJ0eSB3b3VsZCBjb250YWluIHRoZSBmb2xsb3dpbmc6CgogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIHJlbGF0ZWRUeXBlcyA9IEVtYmVyLmdldChBcHAuQmxvZywgJ3JlbGF0ZWRUeXBlcycpOwogICAgLy89PiBbIEFwcC5Vc2VyLCBBcHAuUG9zdCBdCiAgICBgYGAKCiAgICBAcHJvcGVydHkgcmVsYXRlZFR5cGVzCiAgICBAc3RhdGljCiAgICBAdHlwZSBFbWJlci5BcnJheQogICAgQHJlYWRPbmx5CiAgKi8KICByZWxhdGVkVHlwZXM6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewogICAgdmFyIHR5cGUsCiAgICAgICAgdHlwZXMgPSBFbWJlci5BKCk7CgogICAgLy8gTG9vcCB0aHJvdWdoIGVhY2ggY29tcHV0ZWQgcHJvcGVydHkgb24gdGhlIGNsYXNzLAogICAgLy8gYW5kIGNyZWF0ZSBhbiBhcnJheSBvZiB0aGUgdW5pcXVlIHR5cGVzIGludm9sdmVkCiAgICAvLyBpbiByZWxhdGlvbnNoaXBzCiAgICB0aGlzLmVhY2hDb21wdXRlZFByb3BlcnR5KGZ1bmN0aW9uKG5hbWUsIG1ldGEpIHsKICAgICAgaWYgKG1ldGEuaXNSZWxhdGlvbnNoaXApIHsKICAgICAgICB0eXBlID0gbWV0YS50eXBlOwoKICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICB0eXBlID0gZ2V0KHRoaXMsIHR5cGUsIGZhbHNlKSB8fCB0aGlzLnN0b3JlLm1vZGVsRm9yKHR5cGUpOwogICAgICAgIH0KCiAgICAgICAgRW1iZXIuYXNzZXJ0KCJZb3Ugc3BlY2lmaWVkIGEgaGFzTWFueSAoIiArIG1ldGEudHlwZSArICIpIG9uICIgKyBtZXRhLnBhcmVudFR5cGUgKyAiIGJ1dCAiICsgbWV0YS50eXBlICsgIiB3YXMgbm90IGZvdW5kLiIsICB0eXBlKTsKCiAgICAgICAgaWYgKCF0eXBlcy5jb250YWlucyh0eXBlKSkgewogICAgICAgICAgRW1iZXIuYXNzZXJ0KCJUcnlpbmcgdG8gc2lkZWxvYWQgIiArIG5hbWUgKyAiIG9uICIgKyB0aGlzLnRvU3RyaW5nKCkgKyAiIGJ1dCB0aGUgdHlwZSBkb2Vzbid0IGV4aXN0LiIsICEhdHlwZSk7CiAgICAgICAgICB0eXBlcy5wdXNoKHR5cGUpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CgogICAgcmV0dXJuIHR5cGVzOwogIH0pLAoKICAvKioKICAgIEEgbWFwIHdob3NlIGtleXMgYXJlIHRoZSByZWxhdGlvbnNoaXBzIG9mIGEgbW9kZWwgYW5kIHdob3NlIHZhbHVlcyBhcmUKICAgIHJlbGF0aW9uc2hpcCBkZXNjcmlwdG9ycy4KCiAgICBGb3IgZXhhbXBsZSwgZ2l2ZW4gYSBtb2RlbCB3aXRoIHRoaXMKICAgIGRlZmluaXRpb246CgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLkJsb2cgPSBEUy5Nb2RlbC5leHRlbmQoewogICAgICB1c2VyczogRFMuaGFzTWFueSgndXNlcicpLAogICAgICBvd25lcjogRFMuYmVsb25nc1RvKCd1c2VyJyksCgogICAgICBwb3N0czogRFMuaGFzTWFueSgncG9zdCcpCiAgICB9KTsKICAgIGBgYAoKICAgIFRoaXMgcHJvcGVydHkgd291bGQgY29udGFpbiB0aGUgZm9sbG93aW5nOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIHZhciByZWxhdGlvbnNoaXBzQnlOYW1lID0gRW1iZXIuZ2V0KEFwcC5CbG9nLCAncmVsYXRpb25zaGlwc0J5TmFtZScpOwogICAgcmVsYXRpb25zaGlwc0J5TmFtZS5nZXQoJ3VzZXJzJyk7CiAgICAvLz0+IHsga2V5OiAndXNlcnMnLCBraW5kOiAnaGFzTWFueScsIHR5cGU6IEFwcC5Vc2VyIH0KICAgIHJlbGF0aW9uc2hpcHNCeU5hbWUuZ2V0KCdvd25lcicpOwogICAgLy89PiB7IGtleTogJ293bmVyJywga2luZDogJ2JlbG9uZ3NUbycsIHR5cGU6IEFwcC5Vc2VyIH0KICAgIGBgYAoKICAgIEBwcm9wZXJ0eSByZWxhdGlvbnNoaXBzQnlOYW1lCiAgICBAc3RhdGljCiAgICBAdHlwZSBFbWJlci5NYXAKICAgIEByZWFkT25seQogICovCiAgcmVsYXRpb25zaGlwc0J5TmFtZTogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oKSB7CiAgICB2YXIgbWFwID0gRW1iZXIuTWFwLmNyZWF0ZSgpLCB0eXBlOwoKICAgIHRoaXMuZWFjaENvbXB1dGVkUHJvcGVydHkoZnVuY3Rpb24obmFtZSwgbWV0YSkgewogICAgICBpZiAobWV0YS5pc1JlbGF0aW9uc2hpcCkgewogICAgICAgIG1ldGEua2V5ID0gbmFtZTsKICAgICAgICB0eXBlID0gbWV0YS50eXBlOwoKICAgICAgICBpZiAoIXR5cGUgJiYgbWV0YS5raW5kID09PSAnaGFzTWFueScpIHsKICAgICAgICAgIHR5cGUgPSBFbWJlci5TdHJpbmcuc2luZ3VsYXJpemUobmFtZSk7CiAgICAgICAgfSBlbHNlIGlmICghdHlwZSkgewogICAgICAgICAgdHlwZSA9IG5hbWU7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBtZXRhLnR5cGUgPSB0aGlzLnN0b3JlLm1vZGVsRm9yKHR5cGUpOwogICAgICAgIH0KCiAgICAgICAgbWFwLnNldChuYW1lLCBtZXRhKTsKICAgICAgfQogICAgfSk7CgogICAgcmV0dXJuIG1hcDsKICB9KSwKCiAgLyoqCiAgICBBIG1hcCB3aG9zZSBrZXlzIGFyZSB0aGUgZmllbGRzIG9mIHRoZSBtb2RlbCBhbmQgd2hvc2UgdmFsdWVzIGFyZSBzdHJpbmdzCiAgICBkZXNjcmliaW5nIHRoZSBraW5kIG9mIHRoZSBmaWVsZC4gQSBtb2RlbCdzIGZpZWxkcyBhcmUgdGhlIHVuaW9uIG9mIGFsbCBvZiBpdHMKICAgIGF0dHJpYnV0ZXMgYW5kIHJlbGF0aW9uc2hpcHMuCgogICAgRm9yIGV4YW1wbGU6CgogICAgYGBgamF2YXNjcmlwdAoKICAgIEFwcC5CbG9nID0gRFMuTW9kZWwuZXh0ZW5kKHsKICAgICAgdXNlcnM6IERTLmhhc01hbnkoJ3VzZXInKSwKICAgICAgb3duZXI6IERTLmJlbG9uZ3NUbygndXNlcicpLAoKICAgICAgcG9zdHM6IERTLmhhc01hbnkoJ3Bvc3QnKSwKCiAgICAgIHRpdGxlOiBEUy5hdHRyKCdzdHJpbmcnKQogICAgfSk7CgogICAgdmFyIGZpZWxkcyA9IEVtYmVyLmdldChBcHAuQmxvZywgJ2ZpZWxkcycpOwogICAgZmllbGRzLmZvckVhY2goZnVuY3Rpb24oZmllbGQsIGtpbmQpIHsKICAgICAgY29uc29sZS5sb2coZmllbGQsIGtpbmQpOwogICAgfSk7CgogICAgLy8gcHJpbnRzOgogICAgLy8gdXNlcnMsIGhhc01hbnkKICAgIC8vIG93bmVyLCBiZWxvbmdzVG8KICAgIC8vIHBvc3RzLCBoYXNNYW55CiAgICAvLyB0aXRsZSwgYXR0cmlidXRlCiAgICBgYGAKCiAgICBAcHJvcGVydHkgZmllbGRzCiAgICBAc3RhdGljCiAgICBAdHlwZSBFbWJlci5NYXAKICAgIEByZWFkT25seQogICovCiAgZmllbGRzOiBFbWJlci5jb21wdXRlZChmdW5jdGlvbigpIHsKICAgIHZhciBtYXAgPSBFbWJlci5NYXAuY3JlYXRlKCk7CgogICAgdGhpcy5lYWNoQ29tcHV0ZWRQcm9wZXJ0eShmdW5jdGlvbihuYW1lLCBtZXRhKSB7CiAgICAgIGlmIChtZXRhLmlzUmVsYXRpb25zaGlwKSB7CiAgICAgICAgbWFwLnNldChuYW1lLCBtZXRhLmtpbmQpOwogICAgICB9IGVsc2UgaWYgKG1ldGEuaXNBdHRyaWJ1dGUpIHsKICAgICAgICBtYXAuc2V0KG5hbWUsICdhdHRyaWJ1dGUnKTsKICAgICAgfQogICAgfSk7CgogICAgcmV0dXJuIG1hcDsKICB9KSwKCiAgLyoqCiAgICBHaXZlbiBhIGNhbGxiYWNrLCBpdGVyYXRlcyBvdmVyIGVhY2ggb2YgdGhlIHJlbGF0aW9uc2hpcHMgaW4gdGhlIG1vZGVsLAogICAgaW52b2tpbmcgdGhlIGNhbGxiYWNrIHdpdGggdGhlIG5hbWUgb2YgZWFjaCByZWxhdGlvbnNoaXAgYW5kIGl0cyByZWxhdGlvbnNoaXAKICAgIGRlc2NyaXB0b3IuCgogICAgQG1ldGhvZCBlYWNoUmVsYXRpb25zaGlwCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayB0aGUgY2FsbGJhY2sgdG8gaW52b2tlCiAgICBAcGFyYW0ge2FueX0gYmluZGluZyB0aGUgdmFsdWUgdG8gd2hpY2ggdGhlIGNhbGxiYWNrJ3MgYHRoaXNgIHNob3VsZCBiZSBib3VuZAogICovCiAgZWFjaFJlbGF0aW9uc2hpcDogZnVuY3Rpb24oY2FsbGJhY2ssIGJpbmRpbmcpIHsKICAgIGdldCh0aGlzLCAncmVsYXRpb25zaGlwc0J5TmFtZScpLmZvckVhY2goZnVuY3Rpb24obmFtZSwgcmVsYXRpb25zaGlwKSB7CiAgICAgIGNhbGxiYWNrLmNhbGwoYmluZGluZywgbmFtZSwgcmVsYXRpb25zaGlwKTsKICAgIH0pOwogIH0sCgogIC8qKgogICAgR2l2ZW4gYSBjYWxsYmFjaywgaXRlcmF0ZXMgb3ZlciBlYWNoIG9mIHRoZSB0eXBlcyByZWxhdGVkIHRvIGEgbW9kZWwsCiAgICBpbnZva2luZyB0aGUgY2FsbGJhY2sgd2l0aCB0aGUgcmVsYXRlZCB0eXBlJ3MgY2xhc3MuIEVhY2ggdHlwZSB3aWxsIGJlCiAgICByZXR1cm5lZCBqdXN0IG9uY2UsIHJlZ2FyZGxlc3Mgb2YgaG93IG1hbnkgZGlmZmVyZW50IHJlbGF0aW9uc2hpcHMgaXQgaGFzCiAgICB3aXRoIGEgbW9kZWwuCgogICAgQG1ldGhvZCBlYWNoUmVsYXRlZFR5cGUKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIHRoZSBjYWxsYmFjayB0byBpbnZva2UKICAgIEBwYXJhbSB7YW55fSBiaW5kaW5nIHRoZSB2YWx1ZSB0byB3aGljaCB0aGUgY2FsbGJhY2sncyBgdGhpc2Agc2hvdWxkIGJlIGJvdW5kCiAgKi8KICBlYWNoUmVsYXRlZFR5cGU6IGZ1bmN0aW9uKGNhbGxiYWNrLCBiaW5kaW5nKSB7CiAgICBnZXQodGhpcywgJ3JlbGF0ZWRUeXBlcycpLmZvckVhY2goZnVuY3Rpb24odHlwZSkgewogICAgICBjYWxsYmFjay5jYWxsKGJpbmRpbmcsIHR5cGUpOwogICAgfSk7CiAgfQp9KTsKCkRTLk1vZGVsLnJlb3Blbih7CiAgLyoqCiAgICBHaXZlbiBhIGNhbGxiYWNrLCBpdGVyYXRlcyBvdmVyIGVhY2ggb2YgdGhlIHJlbGF0aW9uc2hpcHMgaW4gdGhlIG1vZGVsLAogICAgaW52b2tpbmcgdGhlIGNhbGxiYWNrIHdpdGggdGhlIG5hbWUgb2YgZWFjaCByZWxhdGlvbnNoaXAgYW5kIGl0cyByZWxhdGlvbnNoaXAKICAgIGRlc2NyaXB0b3IuCgogICAgQG1ldGhvZCBlYWNoUmVsYXRpb25zaGlwCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayB0aGUgY2FsbGJhY2sgdG8gaW52b2tlCiAgICBAcGFyYW0ge2FueX0gYmluZGluZyB0aGUgdmFsdWUgdG8gd2hpY2ggdGhlIGNhbGxiYWNrJ3MgYHRoaXNgIHNob3VsZCBiZSBib3VuZAogICovCiAgZWFjaFJlbGF0aW9uc2hpcDogZnVuY3Rpb24oY2FsbGJhY2ssIGJpbmRpbmcpIHsKICAgIHRoaXMuY29uc3RydWN0b3IuZWFjaFJlbGF0aW9uc2hpcChjYWxsYmFjaywgYmluZGluZyk7CiAgfQp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCiAgQG1vZHVsZSBlbWJlci1kYXRhCiovCgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgogIEBtb2R1bGUgZW1iZXItZGF0YQoqLwoKdmFyIGdldCA9IEVtYmVyLmdldCwgc2V0ID0gRW1iZXIuc2V0Owp2YXIgb25jZSA9IEVtYmVyLnJ1bi5vbmNlOwp2YXIgZm9yRWFjaCA9IEVtYmVyLkVudW1lcmFibGVVdGlscy5mb3JFYWNoOwoKLyoqCiAgQGNsYXNzIFJlY29yZEFycmF5TWFuYWdlcgogIEBuYW1lc3BhY2UgRFMKICBAcHJpdmF0ZQogIEBleHRlbmRzIEVtYmVyLk9iamVjdAoqLwpEUy5SZWNvcmRBcnJheU1hbmFnZXIgPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICBpbml0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuZmlsdGVyZWRSZWNvcmRBcnJheXMgPSBFbWJlci5NYXBXaXRoRGVmYXVsdC5jcmVhdGUoewogICAgICBkZWZhdWx0VmFsdWU6IGZ1bmN0aW9uKCkgeyByZXR1cm4gW107IH0KICAgIH0pOwoKICAgIHRoaXMuY2hhbmdlZFJlY29yZHMgPSBbXTsKICB9LAoKICByZWNvcmREaWRDaGFuZ2U6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgdGhpcy5jaGFuZ2VkUmVjb3Jkcy5wdXNoKHJlY29yZCk7CiAgICBvbmNlKHRoaXMsIHRoaXMudXBkYXRlUmVjb3JkQXJyYXlzKTsKICB9LAoKICByZWNvcmRBcnJheXNGb3JSZWNvcmQ6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgcmVjb3JkLl9yZWNvcmRBcnJheXMgPSByZWNvcmQuX3JlY29yZEFycmF5cyB8fCBFbWJlci5PcmRlcmVkU2V0LmNyZWF0ZSgpOwogICAgcmV0dXJuIHJlY29yZC5fcmVjb3JkQXJyYXlzOwogIH0sCgogIC8qKgogICAgVGhpcyBtZXRob2QgaXMgaW52b2tlZCB3aGVuZXZlciBkYXRhIGlzIGxvYWRlZCBpbnRvIHRoZSBzdG9yZSBieSB0aGUKICAgIGFkYXB0ZXIgb3IgdXBkYXRlZCBieSB0aGUgYWRhcHRlciwgb3Igd2hlbiBhIHJlY29yZCBoYXMgY2hhbmdlZC4KCiAgICBJdCB1cGRhdGVzIGFsbCByZWNvcmQgYXJyYXlzIHRoYXQgYSByZWNvcmQgYmVsb25ncyB0by4KCiAgICBUbyBhdm9pZCB0aHJhc2hpbmcsIGl0IG9ubHkgcnVucyBhdCBtb3N0IG9uY2UgcGVyIHJ1biBsb29wLgoKICAgIEBtZXRob2QgdXBkYXRlUmVjb3JkQXJyYXlzCiAgICBAcGFyYW0ge0NsYXNzfSB0eXBlCiAgICBAcGFyYW0ge051bWJlcnxTdHJpbmd9IGNsaWVudElkCiAgKi8KICB1cGRhdGVSZWNvcmRBcnJheXM6IGZ1bmN0aW9uKCkgewogICAgZm9yRWFjaCh0aGlzLmNoYW5nZWRSZWNvcmRzLCBmdW5jdGlvbihyZWNvcmQpIHsKICAgICAgaWYgKGdldChyZWNvcmQsICdpc0RlbGV0ZWQnKSkgewogICAgICAgIHRoaXMuX3JlY29yZFdhc0RlbGV0ZWQocmVjb3JkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9yZWNvcmRXYXNDaGFuZ2VkKHJlY29yZCk7CiAgICAgIH0KICAgIH0sIHRoaXMpOwoKICAgIHRoaXMuY2hhbmdlZFJlY29yZHMgPSBbXTsKICB9LAoKICBfcmVjb3JkV2FzRGVsZXRlZDogZnVuY3Rpb24gKHJlY29yZCkgewogICAgdmFyIHJlY29yZEFycmF5cyA9IHJlY29yZC5fcmVjb3JkQXJyYXlzOwoKICAgIGlmICghcmVjb3JkQXJyYXlzKSB7IHJldHVybjsgfQoKICAgIGZvckVhY2gocmVjb3JkQXJyYXlzLCBmdW5jdGlvbihhcnJheSkgewogICAgICBhcnJheS5yZW1vdmVSZWNvcmQocmVjb3JkKTsKICAgIH0pOwogIH0sCgogIF9yZWNvcmRXYXNDaGFuZ2VkOiBmdW5jdGlvbiAocmVjb3JkKSB7CiAgICB2YXIgdHlwZSA9IHJlY29yZC5jb25zdHJ1Y3RvciwKICAgICAgICByZWNvcmRBcnJheXMgPSB0aGlzLmZpbHRlcmVkUmVjb3JkQXJyYXlzLmdldCh0eXBlKSwKICAgICAgICBmaWx0ZXI7CgogICAgZm9yRWFjaChyZWNvcmRBcnJheXMsIGZ1bmN0aW9uKGFycmF5KSB7CiAgICAgIGZpbHRlciA9IGdldChhcnJheSwgJ2ZpbHRlckZ1bmN0aW9uJyk7CiAgICAgIHRoaXMudXBkYXRlUmVjb3JkQXJyYXkoYXJyYXksIGZpbHRlciwgdHlwZSwgcmVjb3JkKTsKICAgIH0sIHRoaXMpOwoKICAgIC8vIGxvb3AgdGhyb3VnaCBhbGwgbWFueUFycmF5cyBjb250YWluaW5nIGFuIHVubG9hZGVkIGNvcHkgb2YgdGhpcwogICAgLy8gY2xpZW50SWQgYW5kIG5vdGlmeSB0aGVtIHRoYXQgdGhlIHJlY29yZCB3YXMgbG9hZGVkLgogICAgdmFyIG1hbnlBcnJheXMgPSByZWNvcmQuX2xvYWRpbmdSZWNvcmRBcnJheXM7CgogICAgaWYgKG1hbnlBcnJheXMpIHsKICAgICAgZm9yICh2YXIgaT0wLCBsPW1hbnlBcnJheXMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIG1hbnlBcnJheXNbaV0ubG9hZGVkUmVjb3JkKCk7CiAgICAgIH0KCiAgICAgIHJlY29yZC5fbG9hZGluZ1JlY29yZEFycmF5cyA9IFtdOwogICAgfQogIH0sCgogIC8qKgogICAgVXBkYXRlIGFuIGluZGl2aWR1YWwgZmlsdGVyLgoKICAgIEBtZXRob2QgdXBkYXRlUmVjb3JkQXJyYXkKICAgIEBwYXJhbSB7RFMuRmlsdGVyZWRSZWNvcmRBcnJheX0gYXJyYXkKICAgIEBwYXJhbSB7RnVuY3Rpb259IGZpbHRlcgogICAgQHBhcmFtIHtDbGFzc30gdHlwZQogICAgQHBhcmFtIHtOdW1iZXJ8U3RyaW5nfSBjbGllbnRJZAogICovCiAgdXBkYXRlUmVjb3JkQXJyYXk6IGZ1bmN0aW9uKGFycmF5LCBmaWx0ZXIsIHR5cGUsIHJlY29yZCkgewogICAgdmFyIHNob3VsZEJlSW5BcnJheTsKCiAgICBpZiAoIWZpbHRlcikgewogICAgICBzaG91bGRCZUluQXJyYXkgPSB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgc2hvdWxkQmVJbkFycmF5ID0gZmlsdGVyKHJlY29yZCk7CiAgICB9CgogICAgdmFyIHJlY29yZEFycmF5cyA9IHRoaXMucmVjb3JkQXJyYXlzRm9yUmVjb3JkKHJlY29yZCk7CgogICAgaWYgKHNob3VsZEJlSW5BcnJheSkgewogICAgICByZWNvcmRBcnJheXMuYWRkKGFycmF5KTsKICAgICAgYXJyYXkuYWRkUmVjb3JkKHJlY29yZCk7CiAgICB9IGVsc2UgaWYgKCFzaG91bGRCZUluQXJyYXkpIHsKICAgICAgcmVjb3JkQXJyYXlzLnJlbW92ZShhcnJheSk7CiAgICAgIGFycmF5LnJlbW92ZVJlY29yZChyZWNvcmQpOwogICAgfQogIH0sCgogIC8qKgogICAgVGhpcyBtZXRob2QgaXMgaW52b2tlZCBpZiB0aGUgYGZpbHRlckZ1bmN0aW9uYCBwcm9wZXJ0eSBpcwogICAgY2hhbmdlZCBvbiBhIGBEUy5GaWx0ZXJlZFJlY29yZEFycmF5YC4KCiAgICBJdCBlc3NlbnRpYWxseSByZS1ydW5zIHRoZSBmaWx0ZXIgZnJvbSBzY3JhdGNoLiBUaGlzIHNhbWUKICAgIG1ldGhvZCBpcyBpbnZva2VkIHdoZW4gdGhlIGZpbHRlciBpcyBjcmVhdGVkIGluIHRoIGZpcnN0IHBsYWNlLgoKICAgIEBtZXRob2QgdXBkYXRlRmlsdGVyCiAgICBAcGFyYW0gYXJyYXkKICAgIEBwYXJhbSB0eXBlCiAgICBAcGFyYW0gZmlsdGVyCiAgKi8KICB1cGRhdGVGaWx0ZXI6IGZ1bmN0aW9uKGFycmF5LCB0eXBlLCBmaWx0ZXIpIHsKICAgIHZhciB0eXBlTWFwID0gdGhpcy5zdG9yZS50eXBlTWFwRm9yKHR5cGUpLAogICAgICAgIHJlY29yZHMgPSB0eXBlTWFwLnJlY29yZHMsIHJlY29yZDsKCiAgICBmb3IgKHZhciBpPTAsIGw9cmVjb3Jkcy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgIHJlY29yZCA9IHJlY29yZHNbaV07CgogICAgICBpZiAoIWdldChyZWNvcmQsICdpc0RlbGV0ZWQnKSAmJiAhZ2V0KHJlY29yZCwgJ2lzRW1wdHknKSkgewogICAgICAgIHRoaXMudXBkYXRlUmVjb3JkQXJyYXkoYXJyYXksIGZpbHRlciwgdHlwZSwgcmVjb3JkKTsKICAgICAgfQogICAgfQogIH0sCgogIC8qKgogICAgQ3JlYXRlIGEgYERTLk1hbnlBcnJheWAgZm9yIGEgdHlwZSBhbmQgbGlzdCBvZiByZWNvcmQgcmVmZXJlbmNlcywgYW5kIGluZGV4CiAgICB0aGUgYE1hbnlBcnJheWAgdW5kZXIgZWFjaCByZWZlcmVuY2UuIFRoaXMgYWxsb3dzIHVzIHRvIGVmZmljaWVudGx5IHJlbW92ZQogICAgcmVjb3JkcyBmcm9tIGBNYW55QXJyYXlgcyB3aGVuIHRoZXkgYXJlIGRlbGV0ZWQuCgogICAgQG1ldGhvZCBjcmVhdGVNYW55QXJyYXkKICAgIEBwYXJhbSB7Q2xhc3N9IHR5cGUKICAgIEBwYXJhbSB7QXJyYXl9IHJlZmVyZW5jZXMKICAgIEByZXR1cm4ge0RTLk1hbnlBcnJheX0KICAqLwogIGNyZWF0ZU1hbnlBcnJheTogZnVuY3Rpb24odHlwZSwgcmVjb3JkcykgewogICAgdmFyIG1hbnlBcnJheSA9IERTLk1hbnlBcnJheS5jcmVhdGUoewogICAgICB0eXBlOiB0eXBlLAogICAgICBjb250ZW50OiByZWNvcmRzLAogICAgICBzdG9yZTogdGhpcy5zdG9yZQogICAgfSk7CgogICAgZm9yRWFjaChyZWNvcmRzLCBmdW5jdGlvbihyZWNvcmQpIHsKICAgICAgdmFyIGFycmF5cyA9IHRoaXMucmVjb3JkQXJyYXlzRm9yUmVjb3JkKHJlY29yZCk7CiAgICAgIGFycmF5cy5hZGQobWFueUFycmF5KTsKICAgIH0sIHRoaXMpOwoKICAgIHJldHVybiBtYW55QXJyYXk7CiAgfSwKCiAgLyoqCiAgICBDcmVhdGUgYSBgRFMuUmVjb3JkQXJyYXlgIGZvciBhIHR5cGUgYW5kIHJlZ2lzdGVyIGl0IGZvciB1cGRhdGVzLgoKICAgIEBtZXRob2QgY3JlYXRlUmVjb3JkQXJyYXkKICAgIEBwYXJhbSB7Q2xhc3N9IHR5cGUKICAgIEByZXR1cm4ge0RTLlJlY29yZEFycmF5fQogICovCiAgY3JlYXRlUmVjb3JkQXJyYXk6IGZ1bmN0aW9uKHR5cGUpIHsKICAgIHZhciBhcnJheSA9IERTLlJlY29yZEFycmF5LmNyZWF0ZSh7CiAgICAgIHR5cGU6IHR5cGUsCiAgICAgIGNvbnRlbnQ6IEVtYmVyLkEoKSwKICAgICAgc3RvcmU6IHRoaXMuc3RvcmUsCiAgICAgIGlzTG9hZGVkOiB0cnVlCiAgICB9KTsKCiAgICB0aGlzLnJlZ2lzdGVyRmlsdGVyZWRSZWNvcmRBcnJheShhcnJheSwgdHlwZSk7CgogICAgcmV0dXJuIGFycmF5OwogIH0sCgogIC8qKgogICAgQ3JlYXRlIGEgYERTLkZpbHRlcmVkUmVjb3JkQXJyYXlgIGZvciBhIHR5cGUgYW5kIHJlZ2lzdGVyIGl0IGZvciB1cGRhdGVzLgoKICAgIEBtZXRob2QgY3JlYXRlRmlsdGVyZWRSZWNvcmRBcnJheQogICAgQHBhcmFtIHtDbGFzc30gdHlwZQogICAgQHBhcmFtIHtGdW5jdGlvbn0gZmlsdGVyCiAgICBAcmV0dXJuIHtEUy5GaWx0ZXJlZFJlY29yZEFycmF5fQogICovCiAgY3JlYXRlRmlsdGVyZWRSZWNvcmRBcnJheTogZnVuY3Rpb24odHlwZSwgZmlsdGVyKSB7CiAgICB2YXIgYXJyYXkgPSBEUy5GaWx0ZXJlZFJlY29yZEFycmF5LmNyZWF0ZSh7CiAgICAgIHR5cGU6IHR5cGUsCiAgICAgIGNvbnRlbnQ6IEVtYmVyLkEoKSwKICAgICAgc3RvcmU6IHRoaXMuc3RvcmUsCiAgICAgIG1hbmFnZXI6IHRoaXMsCiAgICAgIGZpbHRlckZ1bmN0aW9uOiBmaWx0ZXIKICAgIH0pOwoKICAgIHRoaXMucmVnaXN0ZXJGaWx0ZXJlZFJlY29yZEFycmF5KGFycmF5LCB0eXBlLCBmaWx0ZXIpOwoKICAgIHJldHVybiBhcnJheTsKICB9LAoKICAvKioKICAgIENyZWF0ZSBhIGBEUy5BZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXlgIGZvciBhIHR5cGUgd2l0aCBnaXZlbiBxdWVyeS4KCiAgICBAbWV0aG9kIGNyZWF0ZUFkYXB0ZXJQb3B1bGF0ZWRSZWNvcmRBcnJheQogICAgQHBhcmFtIHtDbGFzc30gdHlwZQogICAgQHBhcmFtIHtPYmplY3R9IHF1ZXJ5CiAgICBAcmV0dXJuIHtEUy5BZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXl9CiAgKi8KICBjcmVhdGVBZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXk6IGZ1bmN0aW9uKHR5cGUsIHF1ZXJ5KSB7CiAgICByZXR1cm4gRFMuQWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5LmNyZWF0ZSh7CiAgICAgIHR5cGU6IHR5cGUsCiAgICAgIHF1ZXJ5OiBxdWVyeSwKICAgICAgY29udGVudDogRW1iZXIuQSgpLAogICAgICBzdG9yZTogdGhpcy5zdG9yZQogICAgfSk7CiAgfSwKCiAgLyoqCiAgICBSZWdpc3RlciBhIFJlY29yZEFycmF5IGZvciBhIGdpdmVuIHR5cGUgdG8gYmUgYmFja2VkIGJ5CiAgICBhIGZpbHRlciBmdW5jdGlvbi4gVGhpcyB3aWxsIGNhdXNlIHRoZSBhcnJheSB0byB1cGRhdGUKICAgIGF1dG9tYXRpY2FsbHkgd2hlbiByZWNvcmRzIG9mIHRoYXQgdHlwZSBjaGFuZ2UgYXR0cmlidXRlCiAgICB2YWx1ZXMgb3Igc3RhdGVzLgoKICAgIEBtZXRob2QgcmVnaXN0ZXJGaWx0ZXJlZFJlY29yZEFycmF5CiAgICBAcGFyYW0ge0RTLlJlY29yZEFycmF5fSBhcnJheQogICAgQHBhcmFtIHtDbGFzc30gdHlwZQogICAgQHBhcmFtIHtGdW5jdGlvbn0gZmlsdGVyCiAgKi8KICByZWdpc3RlckZpbHRlcmVkUmVjb3JkQXJyYXk6IGZ1bmN0aW9uKGFycmF5LCB0eXBlLCBmaWx0ZXIpIHsKICAgIHZhciByZWNvcmRBcnJheXMgPSB0aGlzLmZpbHRlcmVkUmVjb3JkQXJyYXlzLmdldCh0eXBlKTsKICAgIHJlY29yZEFycmF5cy5wdXNoKGFycmF5KTsKCiAgICB0aGlzLnVwZGF0ZUZpbHRlcihhcnJheSwgdHlwZSwgZmlsdGVyKTsKICB9LAoKICAvLyBJbnRlcm5hbGx5LCB3ZSBtYWludGFpbiBhIG1hcCBvZiBhbGwgdW5sb2FkZWQgSURzIHJlcXVlc3RlZCBieQogIC8vIGEgTWFueUFycmF5LiBBcyB0aGUgYWRhcHRlciBsb2FkcyBkYXRhIGludG8gdGhlIHN0b3JlLCB0aGUKICAvLyBzdG9yZSBub3RpZmllcyBhbnkgaW50ZXJlc3RlZCBNYW55QXJyYXlzLiBXaGVuIHRoZSBNYW55QXJyYXkncwogIC8vIHRvdGFsIG51bWJlciBvZiBsb2FkaW5nIHJlY29yZHMgZHJvcHMgdG8gemVybywgaXQgYmVjb21lcwogIC8vIGBpc0xvYWRlZGAgYW5kIGZpcmVzIGEgYGRpZExvYWRgIGV2ZW50LgogIHJlZ2lzdGVyV2FpdGluZ1JlY29yZEFycmF5OiBmdW5jdGlvbihyZWNvcmQsIGFycmF5KSB7CiAgICB2YXIgbG9hZGluZ1JlY29yZEFycmF5cyA9IHJlY29yZC5fbG9hZGluZ1JlY29yZEFycmF5cyB8fCBbXTsKICAgIGxvYWRpbmdSZWNvcmRBcnJheXMucHVzaChhcnJheSk7CiAgICByZWNvcmQuX2xvYWRpbmdSZWNvcmRBcnJheXMgPSBsb2FkaW5nUmVjb3JkQXJyYXlzOwogIH0KfSk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgogIEBtb2R1bGUgZW1iZXItZGF0YQoqLwoKdmFyIGdldCA9IEVtYmVyLmdldCwgc2V0ID0gRW1iZXIuc2V0Owp2YXIgbWFwID0gRW1iZXIuQXJyYXlQb2x5ZmlsbHMubWFwOwoKdmFyIGVycm9yUHJvcHMgPSBbJ2Rlc2NyaXB0aW9uJywgJ2ZpbGVOYW1lJywgJ2xpbmVOdW1iZXInLCAnbWVzc2FnZScsICduYW1lJywgJ251bWJlcicsICdzdGFjayddOwoKLyoqCiAgQSBgRFMuSW52YWxpZEVycm9yYCBpcyB1c2VkIGJ5IGFuIGFkYXB0ZXIgdG8gc2lnbmFsIHRoZSBleHRlcm5hbCBBUEkKICB3YXMgdW5hYmxlIHRvIHByb2Nlc3MgYSByZXF1ZXN0IGJlY2F1c2UgdGhlIGNvbnRlbnQgd2FzIG5vdAogIHNlbWFudGljYWxseSBjb3JyZWN0IG9yIG1lYW5pbmdmdWwgcGVyIHRoZSBBUEkuIFVzdWFsbHkgdGhpcyBtZWFucyBhCiAgcmVjb3JkIGZhaWxlZCBzb21lIGZvcm0gb2Ygc2VydmVyIHNpZGUgdmFsaWRhdGlvbi4gV2hlbiBhIHByb21pc2UKICBmcm9tIGFuIGFkYXB0ZXIgaXMgcmVqZWN0ZWQgd2l0aCBhIGBEUy5JbnZhbGlkRXJyb3JgIHRoZSByZWNvcmQgd2lsbAogIHRyYW5zaXRpb24gdG8gdGhlIGBpbnZhbGlkYCBzdGF0ZSBhbmQgdGhlIGVycm9ycyB3aWxsIGJlIHNldCB0byB0aGUKICBgZXJyb3JzYCBwcm9wZXJ0eSBvbiB0aGUgcmVjb3JkLgoKICBFeGFtcGxlCgogIGBgYGphdmFzY3JpcHQKICBBcHAuQXBwbGljYXRpb25BZGFwdGVyID0gRFMuUkVTVEFkYXB0ZXIuZXh0ZW5kKHsKICAgIGFqYXhFcnJvcjogZnVuY3Rpb24oanFYSFIpIHsKICAgICAgdmFyIGVycm9yID0gdGhpcy5fc3VwZXIoanFYSFIpOwoKICAgICAgaWYgKGpxWEhSICYmIGpxWEhSLnN0YXR1cyA9PT0gNDIyKSB7CiAgICAgICAgdmFyIGpzb25FcnJvcnMgPSBFbWJlci4kLnBhcnNlSlNPTihqcVhIUi5yZXNwb25zZVRleHQpWyJlcnJvcnMiXTsKICAgICAgICByZXR1cm4gbmV3IERTLkludmFsaWRFcnJvcihqc29uRXJyb3JzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZXJyb3I7CiAgICAgIH0KICAgIH0KICB9KTsKICBgYGAKCiAgQGNsYXNzIEludmFsaWRFcnJvcgogIEBuYW1lc3BhY2UgRFMKKi8KRFMuSW52YWxpZEVycm9yID0gZnVuY3Rpb24oZXJyb3JzKSB7CiAgdmFyIHRtcCA9IEVycm9yLnByb3RvdHlwZS5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsICJUaGUgYmFja2VuZCByZWplY3RlZCB0aGUgY29tbWl0IGJlY2F1c2UgaXQgd2FzIGludmFsaWQ6ICIgKyBFbWJlci5pbnNwZWN0KGVycm9ycykpOwogIHRoaXMuZXJyb3JzID0gZXJyb3JzOwoKICBmb3IgKHZhciBpPTAsIGw9ZXJyb3JQcm9wcy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICB0aGlzW2Vycm9yUHJvcHNbaV1dID0gdG1wW2Vycm9yUHJvcHNbaV1dOwogIH0KfTsKRFMuSW52YWxpZEVycm9yLnByb3RvdHlwZSA9IEVtYmVyLmNyZWF0ZShFcnJvci5wcm90b3R5cGUpOwoKLyoqCiAgQW4gYWRhcHRlciBpcyBhbiBvYmplY3QgdGhhdCByZWNlaXZlcyByZXF1ZXN0cyBmcm9tIGEgc3RvcmUgYW5kCiAgdHJhbnNsYXRlcyB0aGVtIGludG8gdGhlIGFwcHJvcHJpYXRlIGFjdGlvbiB0byB0YWtlIGFnYWluc3QgeW91cgogIHBlcnNpc3RlbmNlIGxheWVyLiBUaGUgcGVyc2lzdGVuY2UgbGF5ZXIgaXMgdXN1YWxseSBhbiBIVFRQIEFQSSwgYnV0CiAgbWF5IGJlIGFueXRoaW5nLCBzdWNoIGFzIHRoZSBicm93c2VyJ3MgbG9jYWwgc3RvcmFnZS4gVHlwaWNhbGx5IHRoZQogIGFkYXB0ZXIgaXMgbm90IGludm9rZWQgZGlyZWN0bHkgaW5zdGVhZCBpdHMgZnVuY3Rpb25hbGl0eSBpcyBhY2Nlc3NlZAogIHRocm91Z2ggdGhlIGBzdG9yZWAuCgogICMjIyBDcmVhdGluZyBhbiBBZGFwdGVyCgogIEZpcnN0LCBjcmVhdGUgYSBuZXcgc3ViY2xhc3Mgb2YgYERTLkFkYXB0ZXJgOgoKICBgYGBqYXZhc2NyaXB0CiAgQXBwLk15QWRhcHRlciA9IERTLkFkYXB0ZXIuZXh0ZW5kKHsKICAgIC8vIC4uLnlvdXIgY29kZSBoZXJlCiAgfSk7CiAgYGBgCgogIFRvIHRlbGwgeW91ciBzdG9yZSB3aGljaCBhZGFwdGVyIHRvIHVzZSwgc2V0IGl0cyBgYWRhcHRlcmAgcHJvcGVydHk6CgogIGBgYGphdmFzY3JpcHQKICBBcHAuc3RvcmUgPSBEUy5TdG9yZS5jcmVhdGUoewogICAgYWRhcHRlcjogQXBwLk15QWRhcHRlci5jcmVhdGUoKQogIH0pOwogIGBgYAoKICBgRFMuQWRhcHRlcmAgaXMgYW4gYWJzdHJhY3QgYmFzZSBjbGFzcyB0aGF0IHlvdSBzaG91bGQgb3ZlcnJpZGUgaW4geW91cgogIGFwcGxpY2F0aW9uIHRvIGN1c3RvbWl6ZSBpdCBmb3IgeW91ciBiYWNrZW5kLiBUaGUgbWluaW11bSBzZXQgb2YgbWV0aG9kcwogIHRoYXQgeW91IHNob3VsZCBpbXBsZW1lbnQgaXM6CgogICAgKiBgZmluZCgpYAogICAgKiBgY3JlYXRlUmVjb3JkKClgCiAgICAqIGB1cGRhdGVSZWNvcmQoKWAKICAgICogYGRlbGV0ZVJlY29yZCgpYAogICAgKiBgZmluZEFsbCgpYAogICAgKiBgZmluZFF1ZXJ5KClgCgogIFRvIGltcHJvdmUgdGhlIG5ldHdvcmsgcGVyZm9ybWFuY2Ugb2YgeW91ciBhcHBsaWNhdGlvbiwgeW91IGNhbiBvcHRpbWl6ZQogIHlvdXIgYWRhcHRlciBieSBvdmVycmlkaW5nIHRoZXNlIGxvd2VyLWxldmVsIG1ldGhvZHM6CgogICAgKiBgZmluZE1hbnkoKWAKCgogIEZvciBhbiBleGFtcGxlIGltcGxlbWVudGF0aW9uLCBzZWUgYERTLlJFU1RBZGFwdGVyYCwgdGhlCiAgaW5jbHVkZWQgUkVTVCBhZGFwdGVyLgoKICBAY2xhc3MgQWRhcHRlcgogIEBuYW1lc3BhY2UgRFMKICBAZXh0ZW5kcyBFbWJlci5PYmplY3QKKi8KCkRTLkFkYXB0ZXIgPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKCiAgLyoqCiAgICBJZiB5b3Ugd291bGQgbGlrZSB5b3VyIGFkYXB0ZXIgdG8gdXNlIGEgY3VzdG9tIHNlcmlhbGl6ZXIgeW91IGNhbgogICAgc2V0IHRoZSBgZGVmYXVsdFNlcmlhbGl6ZXJgIHByb3BlcnR5IHRvIGJlIHRoZSBuYW1lIG9mIHRoZSBjdXN0b20KICAgIHNlcmlhbGl6ZXIuCgogICAgTm90ZSB0aGUgYGRlZmF1bHRTZXJpYWxpemVyYCBzZXJpYWxpemVyIGhhcyBhIGxvd2VyIHByaW9yaXR5IHRoZW4KICAgIGEgbW9kZWwgc3BlY2lmaWMgc2VyaWFsaXplciAoaS5lLiBgUG9zdFNlcmlhbGl6ZXJgKSBvciB0aGUKICAgIGBhcHBsaWNhdGlvbmAgc2VyaWFsaXplci4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgRGphbmdvQWRhcHRlciA9IERTLkFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgZGVmYXVsdFNlcmlhbGl6ZXI6ICdkamFuZ28nCiAgICB9KTsKICAgIGBgYAoKICAgIEBwcm9wZXJ0eSBkZWZhdWx0U2VyaWFsaXplcgogICAgQHR5cGUge1N0cmluZ30KICAqLwoKICAvKioKICAgIFRoZSBgZmluZCgpYCBtZXRob2QgaXMgaW52b2tlZCB3aGVuIHRoZSBzdG9yZSBpcyBhc2tlZCBmb3IgYSByZWNvcmQgdGhhdAogICAgaGFzIG5vdCBwcmV2aW91c2x5IGJlZW4gbG9hZGVkLiBJbiByZXNwb25zZSB0byBgZmluZCgpYCBiZWluZyBjYWxsZWQsIHlvdQogICAgc2hvdWxkIHF1ZXJ5IHlvdXIgcGVyc2lzdGVuY2UgbGF5ZXIgZm9yIGEgcmVjb3JkIHdpdGggdGhlIGdpdmVuIElELiBPbmNlCiAgICBmb3VuZCwgeW91IGNhbiBhc3luY2hyb25vdXNseSBjYWxsIHRoZSBzdG9yZSdzIGBwdXNoKClgIG1ldGhvZCB0byBwdXNoCiAgICB0aGUgcmVjb3JkIGludG8gdGhlIHN0b3JlLgoKICAgIEhlcmUgaXMgYW4gZXhhbXBsZSBgZmluZGAgaW1wbGVtZW50YXRpb246CgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLkFwcGxpY2F0aW9uQWRhcHRlciA9IERTLkFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgZmluZDogZnVuY3Rpb24oc3RvcmUsIHR5cGUsIGlkKSB7CiAgICAgICAgdmFyIHVybCA9IFt0eXBlLCBpZF0uam9pbignLycpOwoKICAgICAgICByZXR1cm4gbmV3IEVtYmVyLlJTVlAuUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIGpRdWVyeS5nZXRKU09OKHVybCkudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgIEVtYmVyLnJ1bihudWxsLCByZXNvbHZlLCBkYXRhKTsKICAgICAgICAgIH0sIGZ1bmN0aW9uKGpxWEhSKSB7CiAgICAgICAgICAgIGpxWEhSLnRoZW4gPSBudWxsOyAvLyB0YW1lIGpRdWVyeSdzIGlsbCBtYW5uZXJlZCBwcm9taXNlcwogICAgICAgICAgICBFbWJlci5ydW4obnVsbCwgcmVqZWN0LCBqcVhIUik7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgICBgYGAKCiAgICBAbWV0aG9kIGZpbmQKICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICBAcGFyYW0ge3N1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgICBAcGFyYW0ge1N0cmluZ30gaWQKICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAqLwogIGZpbmQ6IEVtYmVyLnJlcXVpcmVkKEZ1bmN0aW9uKSwKCiAgLyoqCiAgICBUaGUgYGZpbmRBbGwoKWAgbWV0aG9kIGlzIGNhbGxlZCB3aGVuIHlvdSBjYWxsIGBmaW5kYCBvbiB0aGUgc3RvcmUKICAgIHdpdGhvdXQgYW4gSUQgKGkuZS4gYHN0b3JlLmZpbmQoJ3Bvc3QnKWApLgoKICAgIEV4YW1wbGUKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuQXBwbGljYXRpb25BZGFwdGVyID0gRFMuQWRhcHRlci5leHRlbmQoewogICAgICBmaW5kQWxsOiBmdW5jdGlvbihzdG9yZSwgdHlwZSwgc2luY2VUb2tlbikgewogICAgICAgIHZhciB1cmwgPSB0eXBlOwogICAgICAgIHZhciBxdWVyeSA9IHsgc2luY2U6IHNpbmNlVG9rZW4gfTsKICAgICAgICByZXR1cm4gbmV3IEVtYmVyLlJTVlAuUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIGpRdWVyeS5nZXRKU09OKHVybCwgcXVlcnkpLnRoZW4oZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICBFbWJlci5ydW4obnVsbCwgcmVzb2x2ZSwgZGF0YSk7CiAgICAgICAgICB9LCBmdW5jdGlvbihqcVhIUikgewogICAgICAgICAgICBqcVhIUi50aGVuID0gbnVsbDsgLy8gdGFtZSBqUXVlcnkncyBpbGwgbWFubmVyZWQgcHJvbWlzZXMKICAgICAgICAgICAgRW1iZXIucnVuKG51bGwsIHJlamVjdCwganFYSFIpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgQHByaXZhdGUKICAgIEBtZXRob2QgZmluZEFsbAogICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgIEBwYXJhbSB7c3ViY2xhc3Mgb2YgRFMuTW9kZWx9IHR5cGUKICAgIEBwYXJhbSB7U3RyaW5nfSBzaW5jZVRva2VuCiAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlCiAgKi8KICBmaW5kQWxsOiBudWxsLAoKICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCB3aGVuIHlvdSBjYWxsIGBmaW5kYCBvbiB0aGUgc3RvcmUgd2l0aCBhCiAgICBxdWVyeSBvYmplY3QgYXMgdGhlIHNlY29uZCBwYXJhbWV0ZXIgKGkuZS4gYHN0b3JlLmZpbmQoJ3BlcnNvbicsIHsKICAgIHBhZ2U6IDEgfSlgKS4KCiAgICBFeGFtcGxlCgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLkFwcGxpY2F0aW9uQWRhcHRlciA9IERTLkFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgZmluZFF1ZXJ5OiBmdW5jdGlvbihzdG9yZSwgdHlwZSwgcXVlcnkpIHsKICAgICAgICB2YXIgdXJsID0gdHlwZTsKICAgICAgICByZXR1cm4gbmV3IEVtYmVyLlJTVlAuUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIGpRdWVyeS5nZXRKU09OKHVybCwgcXVlcnkpLnRoZW4oZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICBFbWJlci5ydW4obnVsbCwgcmVzb2x2ZSwgZGF0YSk7CiAgICAgICAgICB9LCBmdW5jdGlvbihqcVhIUikgewogICAgICAgICAgICBqcVhIUi50aGVuID0gbnVsbDsgLy8gdGFtZSBqUXVlcnkncyBpbGwgbWFubmVyZWQgcHJvbWlzZXMKICAgICAgICAgICAgRW1iZXIucnVuKG51bGwsIHJlamVjdCwganFYSFIpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgQHByaXZhdGUKICAgIEBtZXRob2QgZmluZFF1ZXJ5CiAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgQHBhcmFtIHtzdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHBhcmFtIHtPYmplY3R9IHF1ZXJ5CiAgICBAcGFyYW0ge0RTLkFkYXB0ZXJQb3B1bGF0ZWRSZWNvcmRBcnJheX0gcmVjb3JkQXJyYXkKICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAqLwogIGZpbmRRdWVyeTogbnVsbCwKCiAgLyoqCiAgICBJZiB0aGUgZ2xvYmFsbHkgdW5pcXVlIElEcyBmb3IgeW91ciByZWNvcmRzIHNob3VsZCBiZSBnZW5lcmF0ZWQgb24gdGhlIGNsaWVudCwKICAgIGltcGxlbWVudCB0aGUgYGdlbmVyYXRlSWRGb3JSZWNvcmQoKWAgbWV0aG9kLiBUaGlzIG1ldGhvZCB3aWxsIGJlIGludm9rZWQKICAgIGVhY2ggdGltZSB5b3UgY3JlYXRlIGEgbmV3IHJlY29yZCwgYW5kIHRoZSB2YWx1ZSByZXR1cm5lZCBmcm9tIGl0IHdpbGwgYmUKICAgIGFzc2lnbmVkIHRvIHRoZSByZWNvcmQncyBgcHJpbWFyeUtleWAuCgogICAgTW9zdCB0cmFkaXRpb25hbCBSRVNULWxpa2UgSFRUUCBBUElzIHdpbGwgbm90IHVzZSB0aGlzIG1ldGhvZC4gSW5zdGVhZCwgdGhlIElECiAgICBvZiB0aGUgcmVjb3JkIHdpbGwgYmUgc2V0IGJ5IHRoZSBzZXJ2ZXIsIGFuZCB5b3VyIGFkYXB0ZXIgd2lsbCB1cGRhdGUgdGhlIHN0b3JlCiAgICB3aXRoIHRoZSBuZXcgSUQgd2hlbiBpdCBjYWxscyBgZGlkQ3JlYXRlUmVjb3JkKClgLiBPbmx5IGltcGxlbWVudCB0aGlzIG1ldGhvZCBpZgogICAgeW91IGludGVuZCB0byBnZW5lcmF0ZSByZWNvcmQgSURzIG9uIHRoZSBjbGllbnQtc2lkZS4KCiAgICBUaGUgYGdlbmVyYXRlSWRGb3JSZWNvcmQoKWAgbWV0aG9kIHdpbGwgYmUgaW52b2tlZCB3aXRoIHRoZSByZXF1ZXN0aW5nIHN0b3JlIGFzCiAgICB0aGUgZmlyc3QgcGFyYW1ldGVyIGFuZCB0aGUgbmV3bHkgY3JlYXRlZCByZWNvcmQgYXMgdGhlIHNlY29uZCBwYXJhbWV0ZXI6CgogICAgYGBgamF2YXNjcmlwdAogICAgZ2VuZXJhdGVJZEZvclJlY29yZDogZnVuY3Rpb24oc3RvcmUsIHJlY29yZCkgewogICAgICB2YXIgdXVpZCA9IEFwcC5nZW5lcmF0ZVVVSURXaXRoU3RhdGlzdGljYWxseUxvd09kZHNPZkNvbGxpc2lvbigpOwogICAgICByZXR1cm4gdXVpZDsKICAgIH0KICAgIGBgYAoKICAgIEBtZXRob2QgZ2VuZXJhdGVJZEZvclJlY29yZAogICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgIEBwYXJhbSB7RFMuTW9kZWx9IHJlY29yZAogICAgQHJldHVybiB7U3RyaW5nfE51bWJlcn0gaWQKICAqLwogIGdlbmVyYXRlSWRGb3JSZWNvcmQ6IG51bGwsCgogIC8qKgogICAgUHJveGllcyB0byB0aGUgc2VyaWFsaXplcidzIGBzZXJpYWxpemVgIG1ldGhvZC4KCiAgICBFeGFtcGxlCgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLkFwcGxpY2F0aW9uQWRhcHRlciA9IERTLkFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgY3JlYXRlUmVjb3JkOiBmdW5jdGlvbihzdG9yZSwgdHlwZSwgcmVjb3JkKSB7CiAgICAgICAgdmFyIGRhdGEgPSB0aGlzLnNlcmlhbGl6ZShyZWNvcmQsIHsgaW5jbHVkZUlkOiB0cnVlIH0pOwogICAgICAgIHZhciB1cmwgPSB0eXBlOwoKICAgICAgICAvLyAuLi4KICAgICAgfQogICAgfSk7CiAgICBgYGAKCiAgICBAbWV0aG9kIHNlcmlhbGl6ZQogICAgQHBhcmFtIHtEUy5Nb2RlbH0gcmVjb3JkCiAgICBAcGFyYW0ge09iamVjdH0gICBvcHRpb25zCiAgICBAcmV0dXJuIHtPYmplY3R9IHNlcmlhbGl6ZWQgcmVjb3JkCiAgKi8KICBzZXJpYWxpemU6IGZ1bmN0aW9uKHJlY29yZCwgb3B0aW9ucykgewogICAgcmV0dXJuIGdldChyZWNvcmQsICdzdG9yZScpLnNlcmlhbGl6ZXJGb3IocmVjb3JkLmNvbnN0cnVjdG9yLnR5cGVLZXkpLnNlcmlhbGl6ZShyZWNvcmQsIG9wdGlvbnMpOwogIH0sCgogIC8qKgogICAgSW1wbGVtZW50IHRoaXMgbWV0aG9kIGluIGEgc3ViY2xhc3MgdG8gaGFuZGxlIHRoZSBjcmVhdGlvbiBvZgogICAgbmV3IHJlY29yZHMuCgogICAgU2VyaWFsaXplcyB0aGUgcmVjb3JkIGFuZCBzZW5kIGl0IHRvIHRoZSBzZXJ2ZXIuCgogICAgRXhhbXBsZQoKICAgIGBgYGphdmFzY3JpcHQKICAgIEFwcC5BcHBsaWNhdGlvbkFkYXB0ZXIgPSBEUy5BZGFwdGVyLmV4dGVuZCh7CiAgICAgIGNyZWF0ZVJlY29yZDogZnVuY3Rpb24oc3RvcmUsIHR5cGUsIHJlY29yZCkgewogICAgICAgIHZhciBkYXRhID0gdGhpcy5zZXJpYWxpemUocmVjb3JkLCB7IGluY2x1ZGVJZDogdHJ1ZSB9KTsKICAgICAgICB2YXIgdXJsID0gdHlwZTsKCiAgICAgICAgcmV0dXJuIG5ldyBFbWJlci5SU1ZQLlByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICBqUXVlcnkuYWpheCh7CiAgICAgICAgICAgIHR5cGU6ICdQT1NUJywKICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgIGRhdGFUeXBlOiAnanNvbicsCiAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICBFbWJlci5ydW4obnVsbCwgcmVzb2x2ZSwgZGF0YSk7CiAgICAgICAgICB9LCBmdW5jdGlvbihqcVhIUikgewogICAgICAgICAgICBqcVhIUi50aGVuID0gbnVsbDsgLy8gdGFtZSBqUXVlcnkncyBpbGwgbWFubmVyZWQgcHJvbWlzZXMKICAgICAgICAgICAgRW1iZXIucnVuKG51bGwsIHJlamVjdCwganFYSFIpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgQG1ldGhvZCBjcmVhdGVSZWNvcmQKICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICBAcGFyYW0ge3N1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlICAgdGhlIERTLk1vZGVsIGNsYXNzIG9mIHRoZSByZWNvcmQKICAgIEBwYXJhbSB7RFMuTW9kZWx9IHJlY29yZAogICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICovCiAgY3JlYXRlUmVjb3JkOiBFbWJlci5yZXF1aXJlZChGdW5jdGlvbiksCgogIC8qKgogICAgSW1wbGVtZW50IHRoaXMgbWV0aG9kIGluIGEgc3ViY2xhc3MgdG8gaGFuZGxlIHRoZSB1cGRhdGluZyBvZgogICAgYSByZWNvcmQuCgogICAgU2VyaWFsaXplcyB0aGUgcmVjb3JkIHVwZGF0ZSBhbmQgc2VuZCBpdCB0byB0aGUgc2VydmVyLgoKICAgIEV4YW1wbGUKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuQXBwbGljYXRpb25BZGFwdGVyID0gRFMuQWRhcHRlci5leHRlbmQoewogICAgICB1cGRhdGVSZWNvcmQ6IGZ1bmN0aW9uKHN0b3JlLCB0eXBlLCByZWNvcmQpIHsKICAgICAgICB2YXIgZGF0YSA9IHRoaXMuc2VyaWFsaXplKHJlY29yZCwgeyBpbmNsdWRlSWQ6IHRydWUgfSk7CiAgICAgICAgdmFyIGlkID0gcmVjb3JkLmdldCgnaWQnKTsKICAgICAgICB2YXIgdXJsID0gW3R5cGUsIGlkXS5qb2luKCcvJyk7CgogICAgICAgIHJldHVybiBuZXcgRW1iZXIuUlNWUC5Qcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgalF1ZXJ5LmFqYXgoewogICAgICAgICAgICB0eXBlOiAnUFVUJywKICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgIGRhdGFUeXBlOiAnanNvbicsCiAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICBFbWJlci5ydW4obnVsbCwgcmVzb2x2ZSwgZGF0YSk7CiAgICAgICAgICB9LCBmdW5jdGlvbihqcVhIUikgewogICAgICAgICAgICBqcVhIUi50aGVuID0gbnVsbDsgLy8gdGFtZSBqUXVlcnkncyBpbGwgbWFubmVyZWQgcHJvbWlzZXMKICAgICAgICAgICAgRW1iZXIucnVuKG51bGwsIHJlamVjdCwganFYSFIpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgQG1ldGhvZCB1cGRhdGVSZWNvcmQKICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICBAcGFyYW0ge3N1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlICAgdGhlIERTLk1vZGVsIGNsYXNzIG9mIHRoZSByZWNvcmQKICAgIEBwYXJhbSB7RFMuTW9kZWx9IHJlY29yZAogICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICovCiAgdXBkYXRlUmVjb3JkOiBFbWJlci5yZXF1aXJlZChGdW5jdGlvbiksCgogIC8qKgogICAgSW1wbGVtZW50IHRoaXMgbWV0aG9kIGluIGEgc3ViY2xhc3MgdG8gaGFuZGxlIHRoZSBkZWxldGlvbiBvZgogICAgYSByZWNvcmQuCgogICAgU2VuZHMgYSBkZWxldGUgcmVxdWVzdCBmb3IgdGhlIHJlY29yZCB0byB0aGUgc2VydmVyLgoKICAgIEV4YW1wbGUKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuQXBwbGljYXRpb25BZGFwdGVyID0gRFMuQWRhcHRlci5leHRlbmQoewogICAgICBkZWxldGVSZWNvcmQ6IGZ1bmN0aW9uKHN0b3JlLCB0eXBlLCByZWNvcmQpIHsKICAgICAgICB2YXIgZGF0YSA9IHRoaXMuc2VyaWFsaXplKHJlY29yZCwgeyBpbmNsdWRlSWQ6IHRydWUgfSk7CiAgICAgICAgdmFyIGlkID0gcmVjb3JkLmdldCgnaWQnKTsKICAgICAgICB2YXIgdXJsID0gW3R5cGUsIGlkXS5qb2luKCcvJyk7CgogICAgICAgIHJldHVybiBuZXcgRW1iZXIuUlNWUC5Qcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgalF1ZXJ5LmFqYXgoewogICAgICAgICAgICB0eXBlOiAnREVMRVRFJywKICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgIGRhdGFUeXBlOiAnanNvbicsCiAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICBFbWJlci5ydW4obnVsbCwgcmVzb2x2ZSwgZGF0YSk7CiAgICAgICAgICB9LCBmdW5jdGlvbihqcVhIUikgewogICAgICAgICAgICBqcVhIUi50aGVuID0gbnVsbDsgLy8gdGFtZSBqUXVlcnkncyBpbGwgbWFubmVyZWQgcHJvbWlzZXMKICAgICAgICAgICAgRW1iZXIucnVuKG51bGwsIHJlamVjdCwganFYSFIpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgQG1ldGhvZCBkZWxldGVSZWNvcmQKICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICBAcGFyYW0ge3N1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlICAgdGhlIERTLk1vZGVsIGNsYXNzIG9mIHRoZSByZWNvcmQKICAgIEBwYXJhbSB7RFMuTW9kZWx9IHJlY29yZAogICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICovCiAgZGVsZXRlUmVjb3JkOiBFbWJlci5yZXF1aXJlZChGdW5jdGlvbiksCgogIC8qKgogICAgRmluZCBtdWx0aXBsZSByZWNvcmRzIGF0IG9uY2UuCgogICAgQnkgZGVmYXVsdCwgaXQgbG9vcHMgb3ZlciB0aGUgcHJvdmlkZWQgaWRzIGFuZCBjYWxscyBgZmluZGAgb24gZWFjaC4KICAgIE1heSBiZSBvdmVyd3JpdHRlbiB0byBpbXByb3ZlIHBlcmZvcm1hbmNlIGFuZCByZWR1Y2UgdGhlIG51bWJlciBvZgogICAgc2VydmVyIHJlcXVlc3RzLgoKICAgIEV4YW1wbGUKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuQXBwbGljYXRpb25BZGFwdGVyID0gRFMuQWRhcHRlci5leHRlbmQoewogICAgICBmaW5kTWFueTogZnVuY3Rpb24oc3RvcmUsIHR5cGUsIGlkcykgewogICAgICAgIHZhciB1cmwgPSB0eXBlOwogICAgICAgIHJldHVybiBuZXcgRW1iZXIuUlNWUC5Qcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgalF1ZXJ5LmdldEpTT04odXJsLCB7aWRzOiBpZHN9KS50aGVuKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgRW1iZXIucnVuKG51bGwsIHJlc29sdmUsIGRhdGEpOwogICAgICAgICAgfSwgZnVuY3Rpb24oanFYSFIpIHsKICAgICAgICAgICAganFYSFIudGhlbiA9IG51bGw7IC8vIHRhbWUgalF1ZXJ5J3MgaWxsIG1hbm5lcmVkIHByb21pc2VzCiAgICAgICAgICAgIEVtYmVyLnJ1bihudWxsLCByZWplY3QsIGpxWEhSKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgIEBtZXRob2QgZmluZE1hbnkKICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICBAcGFyYW0ge3N1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlICAgdGhlIERTLk1vZGVsIGNsYXNzIG9mIHRoZSByZWNvcmRzCiAgICBAcGFyYW0ge0FycmF5fSAgICBpZHMKICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAqLwogIGZpbmRNYW55OiBmdW5jdGlvbihzdG9yZSwgdHlwZSwgaWRzKSB7CiAgICB2YXIgcHJvbWlzZXMgPSBtYXAuY2FsbChpZHMsIGZ1bmN0aW9uKGlkKSB7CiAgICAgIHJldHVybiB0aGlzLmZpbmQoc3RvcmUsIHR5cGUsIGlkKTsKICAgIH0sIHRoaXMpOwoKICAgIHJldHVybiBFbWJlci5SU1ZQLmFsbChwcm9taXNlcyk7CiAgfQp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCiAgQG1vZHVsZSBlbWJlci1kYXRhCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBmbXQgPSBFbWJlci5TdHJpbmcuZm10LAogICAgaW5kZXhPZiA9IEVtYmVyLkVudW1lcmFibGVVdGlscy5pbmRleE9mOwoKdmFyIGNvdW50ZXIgPSAwOwoKLyoqCiAgYERTLkZpeHR1cmVBZGFwdGVyYCBpcyBhbiBhZGFwdGVyIHRoYXQgbG9hZHMgcmVjb3JkcyBmcm9tIG1lbW9yeS4KICBJdHMgcHJpbWFyaWx5IHVzZWQgZm9yIGRldmVsb3BtZW50IGFuZCB0ZXN0aW5nLiBZb3UgY2FuIGFsc28gdXNlCiAgYERTLkZpeHR1cmVBZGFwdGVyYCB3aGlsZSB3b3JraW5nIG9uIHRoZSBBUEkgYnV0IGFyZSBub3QgcmVhZHkgdG8KICBpbnRlZ3JhdGUgeWV0LiBJdCBpcyBhIGZ1bGx5IGZ1bmN0aW9uaW5nIGFkYXB0ZXIuIEFsbCBDUlVEIG1ldGhvZHMKICBhcmUgaW1wbGVtZW50ZWQuIFlvdSBjYW4gYWxzbyBpbXBsZW1lbnQgcXVlcnkgbG9naWMgdGhhdCBhIHJlbW90ZQogIHN5c3RlbSB3b3VsZCBkby4gSXRzIHBvc3NpYmxlIHRvIGRvIGRldmVsb3AgeW91ciBlbnRpcmUgYXBwbGljYXRpb24KICB3aXRoIGBEUy5GaXh0dXJlQWRhcHRlcmAuCgogIEZvciBpbmZvcm1hdGlvbiBvbiBob3cgdG8gdXNlIHRoZSBgRml4dHVyZUFkYXB0ZXJgIGluIHlvdXIKICBhcHBsaWNhdGlvbiBwbGVhc2Ugc2VlIHRoZSBbRml4dHVyZUFkYXB0ZXIKICBndWlkZV0oL2d1aWRlcy9tb2RlbHMvdGhlLWZpeHR1cmUtYWRhcHRlci8pLgoKICBAY2xhc3MgRml4dHVyZUFkYXB0ZXIKICBAbmFtZXNwYWNlIERTCiAgQGV4dGVuZHMgRFMuQWRhcHRlcgoqLwpEUy5GaXh0dXJlQWRhcHRlciA9IERTLkFkYXB0ZXIuZXh0ZW5kKHsKICAvLyBieSBkZWZhdWx0LCBmaXh0dXJlcyBhcmUgYWxyZWFkeSBpbiBub3JtYWxpemVkIGZvcm0KICBzZXJpYWxpemVyOiBudWxsLAoKICAvKioKICAgIElmIGBzaW11bGF0ZVJlbW90ZVJlc3BvbnNlYCBpcyBgdHJ1ZWAgdGhlIGBGaXh0dXJlQWRhcHRlcmAgd2lsbAogICAgd2FpdCBhIG51bWJlciBvZiBtaWxsaXNlY29uZHMgYmVmb3JlIHJlc29sdmluZyBwcm9taXNlcyB3aXRoIHRoZQogICAgZml4dHVyZSB2YWx1ZXMuIFRoZSB3YWl0IHRpbWUgY2FuIGJlIGNvbmZpZ3VyZWQgdmlhIHRoZSBgbGF0ZW5jeWAKICAgIHByb3BlcnR5LgoKICAgIEBwcm9wZXJ0eSBzaW11bGF0ZVJlbW90ZVJlc3BvbnNlCiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgIEBkZWZhdWx0IHRydWUKICAqLwogIHNpbXVsYXRlUmVtb3RlUmVzcG9uc2U6IHRydWUsCgogIC8qKgogICAgQnkgZGVmYXVsdCB0aGUgYEZpeHR1cmVBZGFwdGVyYCB3aWxsIHNpbXVsYXRlIGEgd2FpdCBvZiB0aGUKICAgIGBsYXRlbmN5YCBtaWxsaXNlY29uZHMgYmVmb3JlIHJlc29sdmluZyBwcm9taXNlcyB3aXRoIHRoZSBmaXh0dXJlCiAgICB2YWx1ZXMuIFRoaXMgYmVoYXZpb3IgY2FuIGJlIHR1cm5lZCBvZmYgdmlhIHRoZQogICAgYHNpbXVsYXRlUmVtb3RlUmVzcG9uc2VgIHByb3BlcnR5LgoKICAgIEBwcm9wZXJ0eSBsYXRlbmN5CiAgICBAdHlwZSB7TnVtYmVyfQogICAgQGRlZmF1bHQgNTAKICAqLwogIGxhdGVuY3k6IDUwLAoKICAvKioKICAgIEltcGxlbWVudCB0aGlzIG1ldGhvZCBpbiBvcmRlciB0byBwcm92aWRlIGRhdGEgYXNzb2NpYXRlZCB3aXRoIGEgdHlwZQoKICAgIEBtZXRob2QgZml4dHVyZXNGb3JUeXBlCiAgICBAcGFyYW0ge1N1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgICBAcmV0dXJuIHtBcnJheX0KICAqLwogIGZpeHR1cmVzRm9yVHlwZTogZnVuY3Rpb24odHlwZSkgewogICAgaWYgKHR5cGUuRklYVFVSRVMpIHsKICAgICAgdmFyIGZpeHR1cmVzID0gRW1iZXIuQSh0eXBlLkZJWFRVUkVTKTsKICAgICAgcmV0dXJuIGZpeHR1cmVzLm1hcChmdW5jdGlvbihmaXh0dXJlKXsKICAgICAgICB2YXIgZml4dHVyZUlkVHlwZSA9IHR5cGVvZiBmaXh0dXJlLmlkOwogICAgICAgIGlmKGZpeHR1cmVJZFR5cGUgIT09ICJudW1iZXIiICYmIGZpeHR1cmVJZFR5cGUgIT09ICJzdHJpbmciKXsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmbXQoJ3RoZSBpZCBwcm9wZXJ0eSBtdXN0IGJlIGRlZmluZWQgYXMgYSBudW1iZXIgb3Igc3RyaW5nIGZvciBmaXh0dXJlICVAJywgW2ZpeHR1cmVdKSk7CiAgICAgICAgfQogICAgICAgIGZpeHR1cmUuaWQgPSBmaXh0dXJlLmlkICsgJyc7CiAgICAgICAgcmV0dXJuIGZpeHR1cmU7CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfSwKCiAgLyoqCiAgICBJbXBsZW1lbnQgdGhpcyBtZXRob2QgaW4gb3JkZXIgdG8gcXVlcnkgZml4dHVyZXMgZGF0YQoKICAgIEBtZXRob2QgcXVlcnlGaXh0dXJlcwogICAgQHBhcmFtIHtBcnJheX0gZml4dHVyZQogICAgQHBhcmFtIHtPYmplY3R9IHF1ZXJ5CiAgICBAcGFyYW0ge1N1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgICBAcmV0dXJuIHtQcm9taXNlfEFycmF5fQogICovCiAgcXVlcnlGaXh0dXJlczogZnVuY3Rpb24oZml4dHVyZXMsIHF1ZXJ5LCB0eXBlKSB7CiAgICBFbWJlci5hc3NlcnQoJ05vdCBpbXBsZW1lbnRlZDogWW91IG11c3Qgb3ZlcnJpZGUgdGhlIERTLkZpeHR1cmVBZGFwdGVyOjpxdWVyeUZpeHR1cmVzIG1ldGhvZCB0byBzdXBwb3J0IHF1ZXJ5aW5nIHRoZSBmaXh0dXJlIHN0b3JlLicpOwogIH0sCgogIC8qKgogICAgQG1ldGhvZCB1cGRhdGVGaXh0dXJlcwogICAgQHBhcmFtIHtTdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHBhcmFtIHtBcnJheX0gZml4dHVyZQogICovCiAgdXBkYXRlRml4dHVyZXM6IGZ1bmN0aW9uKHR5cGUsIGZpeHR1cmUpIHsKICAgIGlmKCF0eXBlLkZJWFRVUkVTKSB7CiAgICAgIHR5cGUuRklYVFVSRVMgPSBbXTsKICAgIH0KCiAgICB2YXIgZml4dHVyZXMgPSB0eXBlLkZJWFRVUkVTOwoKICAgIHRoaXMuZGVsZXRlTG9hZGVkRml4dHVyZSh0eXBlLCBmaXh0dXJlKTsKCiAgICBmaXh0dXJlcy5wdXNoKGZpeHR1cmUpOwogIH0sCgogIC8qKgogICAgSW1wbGVtZW50IHRoaXMgbWV0aG9kIGluIG9yZGVyIHRvIHByb3ZpZGUganNvbiBmb3IgQ1JVRCBtZXRob2RzCgogICAgQG1ldGhvZCBtb2NrSlNPTgogICAgQHBhcmFtIHtTdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHBhcmFtIHtEUy5Nb2RlbH0gcmVjb3JkCiAgKi8KICBtb2NrSlNPTjogZnVuY3Rpb24oc3RvcmUsIHR5cGUsIHJlY29yZCkgewogICAgcmV0dXJuIHN0b3JlLnNlcmlhbGl6ZXJGb3IodHlwZSkuc2VyaWFsaXplKHJlY29yZCwgeyBpbmNsdWRlSWQ6IHRydWUgfSk7CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIGdlbmVyYXRlSWRGb3JSZWNvcmQKICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICBAcGFyYW0ge0RTLk1vZGVsfSByZWNvcmQKICAgIEByZXR1cm4ge1N0cmluZ30gaWQKICAqLwogIGdlbmVyYXRlSWRGb3JSZWNvcmQ6IGZ1bmN0aW9uKHN0b3JlKSB7CiAgICByZXR1cm4gImZpeHR1cmUtIiArIGNvdW50ZXIrKzsKICB9LAoKICAvKioKICAgIEBtZXRob2QgZmluZAogICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgIEBwYXJhbSB7c3ViY2xhc3Mgb2YgRFMuTW9kZWx9IHR5cGUKICAgIEBwYXJhbSB7U3RyaW5nfSBpZAogICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICovCiAgZmluZDogZnVuY3Rpb24oc3RvcmUsIHR5cGUsIGlkKSB7CiAgICB2YXIgZml4dHVyZXMgPSB0aGlzLmZpeHR1cmVzRm9yVHlwZSh0eXBlKSwKICAgICAgICBmaXh0dXJlOwoKICAgIEVtYmVyLmFzc2VydCgiVW5hYmxlIHRvIGZpbmQgZml4dHVyZXMgZm9yIG1vZGVsIHR5cGUgIit0eXBlLnRvU3RyaW5nKCksIGZpeHR1cmVzKTsKCiAgICBpZiAoZml4dHVyZXMpIHsKICAgICAgZml4dHVyZSA9IEVtYmVyLkEoZml4dHVyZXMpLmZpbmRQcm9wZXJ0eSgnaWQnLCBpZCk7CiAgICB9CgogICAgaWYgKGZpeHR1cmUpIHsKICAgICAgcmV0dXJuIHRoaXMuc2ltdWxhdGVSZW1vdGVDYWxsKGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBmaXh0dXJlOwogICAgICB9LCB0aGlzKTsKICAgIH0KICB9LAoKICAvKioKICAgIEBtZXRob2QgZmluZE1hbnkKICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICBAcGFyYW0ge3N1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgICBAcGFyYW0ge0FycmF5fSBpZHMKICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAqLwogIGZpbmRNYW55OiBmdW5jdGlvbihzdG9yZSwgdHlwZSwgaWRzKSB7CiAgICB2YXIgZml4dHVyZXMgPSB0aGlzLmZpeHR1cmVzRm9yVHlwZSh0eXBlKTsKCiAgICBFbWJlci5hc3NlcnQoIlVuYWJsZSB0byBmaW5kIGZpeHR1cmVzIGZvciBtb2RlbCB0eXBlICIrdHlwZS50b1N0cmluZygpLCBmaXh0dXJlcyk7CgogICAgaWYgKGZpeHR1cmVzKSB7CiAgICAgIGZpeHR1cmVzID0gZml4dHVyZXMuZmlsdGVyKGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICByZXR1cm4gaW5kZXhPZihpZHMsIGl0ZW0uaWQpICE9PSAtMTsKICAgICAgfSk7CiAgICB9CgogICAgaWYgKGZpeHR1cmVzKSB7CiAgICAgIHJldHVybiB0aGlzLnNpbXVsYXRlUmVtb3RlQ2FsbChmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZml4dHVyZXM7CiAgICAgIH0sIHRoaXMpOwogICAgfQogIH0sCgogIC8qKgogICAgQHByaXZhdGUKICAgIEBtZXRob2QgZmluZEFsbAogICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgIEBwYXJhbSB7c3ViY2xhc3Mgb2YgRFMuTW9kZWx9IHR5cGUKICAgIEBwYXJhbSB7U3RyaW5nfSBzaW5jZVRva2VuCiAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlCiAgKi8KICBmaW5kQWxsOiBmdW5jdGlvbihzdG9yZSwgdHlwZSkgewogICAgdmFyIGZpeHR1cmVzID0gdGhpcy5maXh0dXJlc0ZvclR5cGUodHlwZSk7CgogICAgRW1iZXIuYXNzZXJ0KCJVbmFibGUgdG8gZmluZCBmaXh0dXJlcyBmb3IgbW9kZWwgdHlwZSAiK3R5cGUudG9TdHJpbmcoKSwgZml4dHVyZXMpOwoKICAgIHJldHVybiB0aGlzLnNpbXVsYXRlUmVtb3RlQ2FsbChmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGZpeHR1cmVzOwogICAgfSwgdGhpcyk7CiAgfSwKCiAgLyoqCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBmaW5kUXVlcnkKICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICBAcGFyYW0ge3N1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgICBAcGFyYW0ge09iamVjdH0gcXVlcnkKICAgIEBwYXJhbSB7RFMuQWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5fSByZWNvcmRBcnJheQogICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICovCiAgZmluZFF1ZXJ5OiBmdW5jdGlvbihzdG9yZSwgdHlwZSwgcXVlcnksIGFycmF5KSB7CiAgICB2YXIgZml4dHVyZXMgPSB0aGlzLmZpeHR1cmVzRm9yVHlwZSh0eXBlKTsKCiAgICBFbWJlci5hc3NlcnQoIlVuYWJsZSB0byBmaW5kIGZpeHR1cmVzIGZvciBtb2RlbCB0eXBlICIrdHlwZS50b1N0cmluZygpLCBmaXh0dXJlcyk7CgogICAgZml4dHVyZXMgPSB0aGlzLnF1ZXJ5Rml4dHVyZXMoZml4dHVyZXMsIHF1ZXJ5LCB0eXBlKTsKCiAgICBpZiAoZml4dHVyZXMpIHsKICAgICAgcmV0dXJuIHRoaXMuc2ltdWxhdGVSZW1vdGVDYWxsKGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBmaXh0dXJlczsKICAgICAgfSwgdGhpcyk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIGNyZWF0ZVJlY29yZAogICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgIEBwYXJhbSB7c3ViY2xhc3Mgb2YgRFMuTW9kZWx9IHR5cGUKICAgIEBwYXJhbSB7RFMuTW9kZWx9IHJlY29yZAogICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICovCiAgY3JlYXRlUmVjb3JkOiBmdW5jdGlvbihzdG9yZSwgdHlwZSwgcmVjb3JkKSB7CiAgICB2YXIgZml4dHVyZSA9IHRoaXMubW9ja0pTT04oc3RvcmUsIHR5cGUsIHJlY29yZCk7CgogICAgdGhpcy51cGRhdGVGaXh0dXJlcyh0eXBlLCBmaXh0dXJlKTsKCiAgICByZXR1cm4gdGhpcy5zaW11bGF0ZVJlbW90ZUNhbGwoZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBmaXh0dXJlOwogICAgfSwgdGhpcyk7CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIHVwZGF0ZVJlY29yZAogICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgIEBwYXJhbSB7c3ViY2xhc3Mgb2YgRFMuTW9kZWx9IHR5cGUKICAgIEBwYXJhbSB7RFMuTW9kZWx9IHJlY29yZAogICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICovCiAgdXBkYXRlUmVjb3JkOiBmdW5jdGlvbihzdG9yZSwgdHlwZSwgcmVjb3JkKSB7CiAgICB2YXIgZml4dHVyZSA9IHRoaXMubW9ja0pTT04oc3RvcmUsIHR5cGUsIHJlY29yZCk7CgogICAgdGhpcy51cGRhdGVGaXh0dXJlcyh0eXBlLCBmaXh0dXJlKTsKCiAgICByZXR1cm4gdGhpcy5zaW11bGF0ZVJlbW90ZUNhbGwoZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBmaXh0dXJlOwogICAgfSwgdGhpcyk7CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIGRlbGV0ZVJlY29yZAogICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgIEBwYXJhbSB7c3ViY2xhc3Mgb2YgRFMuTW9kZWx9IHR5cGUKICAgIEBwYXJhbSB7RFMuTW9kZWx9IHJlY29yZAogICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICovCiAgZGVsZXRlUmVjb3JkOiBmdW5jdGlvbihzdG9yZSwgdHlwZSwgcmVjb3JkKSB7CiAgICB2YXIgZml4dHVyZSA9IHRoaXMubW9ja0pTT04oc3RvcmUsIHR5cGUsIHJlY29yZCk7CgogICAgdGhpcy5kZWxldGVMb2FkZWRGaXh0dXJlKHR5cGUsIGZpeHR1cmUpOwoKICAgIHJldHVybiB0aGlzLnNpbXVsYXRlUmVtb3RlQ2FsbChmdW5jdGlvbigpIHsKICAgICAgLy8gbm8gcGF5bG9hZCBpbiBhIGRlbGV0aW9uCiAgICAgIHJldHVybiBudWxsOwogICAgfSk7CiAgfSwKCiAgLyoKICAgIEBtZXRob2QgZGVsZXRlTG9hZGVkRml4dHVyZQogICAgQHByaXZhdGUKICAgIEBwYXJhbSB0eXBlCiAgICBAcGFyYW0gcmVjb3JkCiAgKi8KICBkZWxldGVMb2FkZWRGaXh0dXJlOiBmdW5jdGlvbih0eXBlLCByZWNvcmQpIHsKICAgIHZhciBleGlzdGluZ0ZpeHR1cmUgPSB0aGlzLmZpbmRFeGlzdGluZ0ZpeHR1cmUodHlwZSwgcmVjb3JkKTsKCiAgICBpZihleGlzdGluZ0ZpeHR1cmUpIHsKICAgICAgdmFyIGluZGV4ID0gaW5kZXhPZih0eXBlLkZJWFRVUkVTLCBleGlzdGluZ0ZpeHR1cmUpOwogICAgICB0eXBlLkZJWFRVUkVTLnNwbGljZShpbmRleCwgMSk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0sCgogIC8qCiAgICBAbWV0aG9kIGZpbmRFeGlzdGluZ0ZpeHR1cmUKICAgIEBwcml2YXRlCiAgICBAcGFyYW0gdHlwZQogICAgQHBhcmFtIHJlY29yZAogICovCiAgZmluZEV4aXN0aW5nRml4dHVyZTogZnVuY3Rpb24odHlwZSwgcmVjb3JkKSB7CiAgICB2YXIgZml4dHVyZXMgPSB0aGlzLmZpeHR1cmVzRm9yVHlwZSh0eXBlKTsKICAgIHZhciBpZCA9IGdldChyZWNvcmQsICdpZCcpOwoKICAgIHJldHVybiB0aGlzLmZpbmRGaXh0dXJlQnlJZChmaXh0dXJlcywgaWQpOwogIH0sCgogIC8qCiAgICBAbWV0aG9kIGZpbmRGaXh0dXJlQnlJZAogICAgQHByaXZhdGUKICAgIEBwYXJhbSBmaXh0dXJlcwogICAgQHBhcmFtIGlkCiAgKi8KICBmaW5kRml4dHVyZUJ5SWQ6IGZ1bmN0aW9uKGZpeHR1cmVzLCBpZCkgewogICAgcmV0dXJuIEVtYmVyLkEoZml4dHVyZXMpLmZpbmQoZnVuY3Rpb24ocikgewogICAgICBpZignJytnZXQociwgJ2lkJykgPT09ICcnK2lkKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9KTsKICB9LAoKICAvKgogICAgQG1ldGhvZCBzaW11bGF0ZVJlbW90ZUNhbGwKICAgIEBwcml2YXRlCiAgICBAcGFyYW0gY2FsbGJhY2sKICAgIEBwYXJhbSBjb250ZXh0CiAgKi8KICBzaW11bGF0ZVJlbW90ZUNhbGw6IGZ1bmN0aW9uKGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICB2YXIgYWRhcHRlciA9IHRoaXM7CgogICAgcmV0dXJuIG5ldyBFbWJlci5SU1ZQLlByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSkgewogICAgICBpZiAoZ2V0KGFkYXB0ZXIsICdzaW11bGF0ZVJlbW90ZVJlc3BvbnNlJykpIHsKICAgICAgICAvLyBTY2hlZHVsZSB3aXRoIHNldFRpbWVvdXQKICAgICAgICBFbWJlci5ydW4ubGF0ZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXNvbHZlKGNhbGxiYWNrLmNhbGwoY29udGV4dCkpOwogICAgICAgIH0sIGdldChhZGFwdGVyLCAnbGF0ZW5jeScpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBBc3luY2hyb25vdXMsIGJ1dCBhdCB0aGUgb2YgdGhlIHJ1bmxvb3Agd2l0aCB6ZXJvIGxhdGVuY3kKICAgICAgICBFbWJlci5ydW4uc2NoZWR1bGUoJ2FjdGlvbnMnLCBudWxsLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHJlc29sdmUoY2FsbGJhY2suY2FsbChjb250ZXh0KSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sICJEUzogRml4dHVyZUFkYXB0ZXIjc2ltdWxhdGVSZW1vdGVDYWxsIik7CiAgfQp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCiAgQG1vZHVsZSBlbWJlci1kYXRhCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQ7CnZhciBmb3JFYWNoID0gRW1iZXIuQXJyYXlQb2x5ZmlsbHMuZm9yRWFjaDsKdmFyIG1hcCA9IEVtYmVyLkFycmF5UG9seWZpbGxzLm1hcDsKCmZ1bmN0aW9uIGNvZXJjZUlkKGlkKSB7CiAgcmV0dXJuIGlkID09IG51bGwgPyBudWxsIDogaWQrJyc7Cn0KCi8qKgogIE5vcm1hbGx5LCBhcHBsaWNhdGlvbnMgd2lsbCB1c2UgdGhlIGBSRVNUU2VyaWFsaXplcmAgYnkgaW1wbGVtZW50aW5nCiAgdGhlIGBub3JtYWxpemVgIG1ldGhvZCBhbmQgaW5kaXZpZHVhbCBub3JtYWxpemF0aW9ucyB1bmRlcgogIGBub3JtYWxpemVIYXNoYC4KCiAgVGhpcyBhbGxvd3MgeW91IHRvIGRvIHdoYXRldmVyIGtpbmQgb2YgbXVuZ2luZyB5b3UgbmVlZCwgYW5kIGlzCiAgZXNwZWNpYWxseSB1c2VmdWwgaWYgeW91ciBzZXJ2ZXIgaXMgaW5jb25zaXN0ZW50IGFuZCB5b3UgbmVlZCB0bwogIGRvIG11bmdpbmcgZGlmZmVyZW50bHkgZm9yIG1hbnkgZGlmZmVyZW50IGtpbmRzIG9mIHJlc3BvbnNlcy4KCiAgU2VlIHRoZSBgbm9ybWFsaXplYCBkb2N1bWVudGF0aW9uIGZvciBtb3JlIGluZm9ybWF0aW9uLgoKICAjIyBBY3Jvc3MgdGhlIEJvYXJkIE5vcm1hbGl6YXRpb24KCiAgVGhlcmUgYXJlIGFsc28gYSBudW1iZXIgb2YgaG9va3MgdGhhdCB5b3UgbWlnaHQgZmluZCB1c2VmdWwgdG8gZGVmaW5lZAogIGFjcm9zcy10aGUtYm9hcmQgcnVsZXMgZm9yIHlvdXIgcGF5bG9hZC4gVGhlc2UgcnVsZXMgd2lsbCBiZSB1c2VmdWwKICBpZiB5b3VyIHNlcnZlciBpcyBjb25zaXN0ZW50LCBvciBpZiB5b3UncmUgYnVpbGRpbmcgYW4gYWRhcHRlciBmb3IKICBhbiBpbmZyYXN0cnVjdHVyZSBzZXJ2aWNlLCBsaWtlIFBhcnNlLCBhbmQgd2FudCB0byBlbmNvZGUgc2VydmljZQogIGNvbnZlbnRpb25zLgoKICBGb3IgZXhhbXBsZSwgaWYgYWxsIG9mIHlvdXIga2V5cyBhcmUgdW5kZXJzY29yZWQgYW5kIGFsbC1jYXBzLCBidXQKICBvdGhlcndpc2UgY29uc2lzdGVudCB3aXRoIHRoZSBuYW1lcyB5b3UgdXNlIGluIHlvdXIgbW9kZWxzLCB5b3UKICBjYW4gaW1wbGVtZW50IGFjcm9zcy10aGUtYm9hcmQgcnVsZXMgZm9yIGhvdyB0byBjb252ZXJ0IGFuIGF0dHJpYnV0ZQogIG5hbWUgaW4geW91ciBtb2RlbCB0byBhIGtleSBpbiB5b3VyIEpTT04uCgogIGBgYGpzCiAgQXBwLkFwcGxpY2F0aW9uU2VyaWFsaXplciA9IERTLlJFU1RTZXJpYWxpemVyLmV4dGVuZCh7CiAgICBrZXlGb3JBdHRyaWJ1dGU6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgcmV0dXJuIEVtYmVyLlN0cmluZy51bmRlcnNjb3JlKGF0dHIpLnRvVXBwZXJDYXNlKCk7CiAgICB9CiAgfSk7CiAgYGBgCgogIFlvdSBjYW4gYWxzbyBpbXBsZW1lbnQgYGtleUZvclJlbGF0aW9uc2hpcGAsIHdoaWNoIHRha2VzIHRoZSBuYW1lCiAgb2YgdGhlIHJlbGF0aW9uc2hpcCBhcyB0aGUgZmlyc3QgcGFyYW1ldGVyLCBhbmQgdGhlIGtpbmQgb2YKICByZWxhdGlvbnNoaXAgKGBoYXNNYW55YCBvciBgYmVsb25nc1RvYCkgYXMgdGhlIHNlY29uZCBwYXJhbWV0ZXIuCgogIEBjbGFzcyBSRVNUU2VyaWFsaXplcgogIEBuYW1lc3BhY2UgRFMKICBAZXh0ZW5kcyBEUy5KU09OU2VyaWFsaXplcgoqLwpEUy5SRVNUU2VyaWFsaXplciA9IERTLkpTT05TZXJpYWxpemVyLmV4dGVuZCh7CiAgLyoqCiAgICBJZiB5b3Ugd2FudCB0byBkbyBub3JtYWxpemF0aW9ucyBzcGVjaWZpYyB0byBzb21lIHBhcnQgb2YgdGhlIHBheWxvYWQsIHlvdQogICAgY2FuIHNwZWNpZnkgdGhvc2UgdW5kZXIgYG5vcm1hbGl6ZUhhc2hgLgoKICAgIEZvciBleGFtcGxlLCBnaXZlbiB0aGUgZm9sbG93aW5nIGpzb24gd2hlcmUgdGhlIHRoZSBgSURzYCB1bmRlcgogICAgYCJjb21tZW50cyJgIGFyZSBwcm92aWRlZCBhcyBgX2lkYCBpbnN0ZWFkIG9mIGBpZGAuCgogICAgYGBgamF2YXNjcmlwdAogICAgewogICAgICAicG9zdCI6IHsKICAgICAgICAiaWQiOiAxLAogICAgICAgICJ0aXRsZSI6ICJSYWlscyBpcyBvbWFrYXNlIiwKICAgICAgICAiY29tbWVudHMiOiBbIDEsIDIgXQogICAgICB9LAogICAgICAiY29tbWVudHMiOiBbewogICAgICAgICJfaWQiOiAxLAogICAgICAgICJib2R5IjogIkZJUlNUIgogICAgICB9LCB7CiAgICAgICAgIl9pZCI6IDIsCiAgICAgICAgImJvZHkiOiAiUmFpbHMgaXMgdW5hZ2kiCiAgICAgIH1dCiAgICB9CiAgICBgYGAKCiAgICBZb3UgdXNlIGBub3JtYWxpemVIYXNoYCB0byBub3JtYWxpemUganVzdCB0aGUgY29tbWVudHM6CgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLlBvc3RTZXJpYWxpemVyID0gRFMuUkVTVFNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgbm9ybWFsaXplSGFzaDogewogICAgICAgIGNvbW1lbnRzOiBmdW5jdGlvbihoYXNoKSB7CiAgICAgICAgICBoYXNoLmlkID0gaGFzaC5faWQ7CiAgICAgICAgICBkZWxldGUgaGFzaC5faWQ7CiAgICAgICAgICByZXR1cm4gaGFzaDsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgVGhlIGtleSB1bmRlciBgbm9ybWFsaXplSGFzaGAgaXMgdXN1YWxseSBqdXN0IHRoZSBvcmlnaW5hbCBrZXkKICAgIHRoYXQgd2FzIGluIHRoZSBvcmlnaW5hbCBwYXlsb2FkLiBIb3dldmVyLCBrZXkgbmFtZXMgd2lsbCBiZQogICAgaW1wYWN0ZWQgYnkgYW55IG1vZGlmaWNhdGlvbnMgZG9uZSBpbiB0aGUgYG5vcm1hbGl6ZVBheWxvYWRgCiAgICBtZXRob2QuIFRoZSBgRFMuUkVTVFNlcmlhbGl6ZXJgJ3MgZGVmYXVsdCBpbXBsZW1lbnRpb24gbWFrZXMgbm8KICAgIGNoYW5nZXMgdG8gdGhlIHBheWxvYWQga2V5cy4KCiAgICBAcHJvcGVydHkgbm9ybWFsaXplSGFzaAogICAgQHR5cGUge09iamVjdH0KICAgIEBkZWZhdWx0IHVuZGVmaW5lZAogICovCgogIC8qKgogICAgTm9ybWFsaXplcyBhIHBhcnQgb2YgdGhlIEpTT04gcGF5bG9hZCByZXR1cm5lZCBieQogICAgdGhlIHNlcnZlci4gWW91IHNob3VsZCBvdmVycmlkZSB0aGlzIG1ldGhvZCwgbXVuZ2UgdGhlIGhhc2gKICAgIGFuZCBjYWxsIHN1cGVyIGlmIHlvdSBoYXZlIGdlbmVyaWMgbm9ybWFsaXphdGlvbiB0byBkby4KCiAgICBJdCB0YWtlcyB0aGUgdHlwZSBvZiB0aGUgcmVjb3JkIHRoYXQgaXMgYmVpbmcgbm9ybWFsaXplZAogICAgKGFzIGEgRFMuTW9kZWwgY2xhc3MpLCB0aGUgcHJvcGVydHkgd2hlcmUgdGhlIGhhc2ggd2FzCiAgICBvcmlnaW5hbGx5IGZvdW5kLCBhbmQgdGhlIGhhc2ggdG8gbm9ybWFsaXplLgoKICAgIEZvciBleGFtcGxlLCBpZiB5b3UgaGF2ZSBhIHBheWxvYWQgdGhhdCBsb29rcyBsaWtlIHRoaXM6CgogICAgYGBganMKICAgIHsKICAgICAgInBvc3QiOiB7CiAgICAgICAgImlkIjogMSwKICAgICAgICAidGl0bGUiOiAiUmFpbHMgaXMgb21ha2FzZSIsCiAgICAgICAgImNvbW1lbnRzIjogWyAxLCAyIF0KICAgICAgfSwKICAgICAgImNvbW1lbnRzIjogW3sKICAgICAgICAiaWQiOiAxLAogICAgICAgICJib2R5IjogIkZJUlNUIgogICAgICB9LCB7CiAgICAgICAgImlkIjogMiwKICAgICAgICAiYm9keSI6ICJSYWlscyBpcyB1bmFnaSIKICAgICAgfV0KICAgIH0KICAgIGBgYAoKICAgIFRoZSBgbm9ybWFsaXplYCBtZXRob2Qgd2lsbCBiZSBjYWxsZWQgdGhyZWUgdGltZXM6CgogICAgKiBXaXRoIGBBcHAuUG9zdGAsIGAicG9zdHMiYCBhbmQgYHsgaWQ6IDEsIHRpdGxlOiAiUmFpbHMgaXMgb21ha2FzZSIsIC4uLiB9YAogICAgKiBXaXRoIGBBcHAuQ29tbWVudGAsIGAiY29tbWVudHMiYCBhbmQgYHsgaWQ6IDEsIGJvZHk6ICJGSVJTVCIgfWAKICAgICogV2l0aCBgQXBwLkNvbW1lbnRgLCBgImNvbW1lbnRzImAgYW5kIGB7IGlkOiAyLCBib2R5OiAiUmFpbHMgaXMgdW5hZ2kiIH1gCgogICAgWW91IGNhbiB1c2UgdGhpcyBtZXRob2QsIGZvciBleGFtcGxlLCB0byBub3JtYWxpemUgdW5kZXJzY29yZWQga2V5cyB0byBjYW1lbGl6ZWQKICAgIG9yIG90aGVyIGdlbmVyYWwtcHVycG9zZSBub3JtYWxpemF0aW9ucy4KCiAgICBJZiB5b3Ugd2FudCB0byBkbyBub3JtYWxpemF0aW9ucyBzcGVjaWZpYyB0byBzb21lIHBhcnQgb2YgdGhlIHBheWxvYWQsIHlvdQogICAgY2FuIHNwZWNpZnkgdGhvc2UgdW5kZXIgYG5vcm1hbGl6ZUhhc2hgLgoKICAgIEZvciBleGFtcGxlLCBpZiB0aGUgYElEc2AgdW5kZXIgYCJjb21tZW50cyJgIGFyZSBwcm92aWRlZCBhcyBgX2lkYCBpbnN0ZWFkIG9mCiAgICBgaWRgLCB5b3UgY2FuIHNwZWNpZnkgaG93IHRvIG5vcm1hbGl6ZSBqdXN0IHRoZSBjb21tZW50czoKCiAgICBgYGBqcwogICAgQXBwLlBvc3RTZXJpYWxpemVyID0gRFMuUkVTVFNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgbm9ybWFsaXplSGFzaDogewogICAgICAgIGNvbW1lbnRzOiBmdW5jdGlvbihoYXNoKSB7CiAgICAgICAgICBoYXNoLmlkID0gaGFzaC5faWQ7CiAgICAgICAgICBkZWxldGUgaGFzaC5faWQ7CiAgICAgICAgICByZXR1cm4gaGFzaDsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgVGhlIGtleSB1bmRlciBgbm9ybWFsaXplSGFzaGAgaXMganVzdCB0aGUgb3JpZ2luYWwga2V5IHRoYXQgd2FzIGluIHRoZSBvcmlnaW5hbAogICAgcGF5bG9hZC4KCiAgICBAbWV0aG9kIG5vcm1hbGl6ZQogICAgQHBhcmFtIHtzdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHBhcmFtIHtPYmplY3R9IGhhc2gKICAgIEBwYXJhbSB7U3RyaW5nfSBwcm9wCiAgICBAcmV0dXJucyB7T2JqZWN0fQogICovCiAgbm9ybWFsaXplOiBmdW5jdGlvbih0eXBlLCBoYXNoLCBwcm9wKSB7CiAgICB0aGlzLm5vcm1hbGl6ZUlkKGhhc2gpOwogICAgdGhpcy5ub3JtYWxpemVBdHRyaWJ1dGVzKHR5cGUsIGhhc2gpOwogICAgdGhpcy5ub3JtYWxpemVSZWxhdGlvbnNoaXBzKHR5cGUsIGhhc2gpOwoKICAgIHRoaXMubm9ybWFsaXplVXNpbmdEZWNsYXJlZE1hcHBpbmcodHlwZSwgaGFzaCk7CgogICAgaWYgKHRoaXMubm9ybWFsaXplSGFzaCAmJiB0aGlzLm5vcm1hbGl6ZUhhc2hbcHJvcF0pIHsKICAgICAgdGhpcy5ub3JtYWxpemVIYXNoW3Byb3BdKGhhc2gpOwogICAgfQoKICAgIHJldHVybiB0aGlzLl9zdXBlcih0eXBlLCBoYXNoLCBwcm9wKTsKICB9LAoKICAvKioKICAgIFlvdSBjYW4gdXNlIHRoaXMgbWV0aG9kIHRvIG5vcm1hbGl6ZSBhbGwgcGF5bG9hZHMsIHJlZ2FyZGxlc3Mgb2Ygd2hldGhlciB0aGV5CiAgICByZXByZXNlbnQgc2luZ2xlIHJlY29yZHMgb3IgYW4gYXJyYXkuCgogICAgRm9yIGV4YW1wbGUsIHlvdSBtaWdodCB3YW50IHRvIHJlbW92ZSBzb21lIGV4dHJhbmVvdXMgZGF0YSBmcm9tIHRoZSBwYXlsb2FkOgoKICAgIGBgYGpzCiAgICBBcHAuQXBwbGljYXRpb25TZXJpYWxpemVyID0gRFMuUkVTVFNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgbm9ybWFsaXplUGF5bG9hZDogZnVuY3Rpb24odHlwZSwgcGF5bG9hZCkgewogICAgICAgIGRlbGV0ZSBwYXlsb2FkLnZlcnNpb247CiAgICAgICAgZGVsZXRlIHBheWxvYWQuc3RhdHVzOwogICAgICAgIHJldHVybiBwYXlsb2FkOwogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgIEBtZXRob2Qgbm9ybWFsaXplUGF5bG9hZAogICAgQHBhcmFtIHtzdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHBhcmFtIHtPYmplY3R9IGhhc2gKICAgIEByZXR1cm5zIHtPYmplY3R9IHRoZSBub3JtYWxpemVkIHBheWxvYWQKICAqLwogIG5vcm1hbGl6ZVBheWxvYWQ6IGZ1bmN0aW9uKHR5cGUsIHBheWxvYWQpIHsKICAgIHJldHVybiBwYXlsb2FkOwogIH0sCgogIC8qKgogICAgQG1ldGhvZCBub3JtYWxpemVJZAogICAgQHByaXZhdGUKICAqLwogIG5vcm1hbGl6ZUlkOiBmdW5jdGlvbihoYXNoKSB7CiAgICB2YXIgcHJpbWFyeUtleSA9IGdldCh0aGlzLCAncHJpbWFyeUtleScpOwoKICAgIGlmIChwcmltYXJ5S2V5ID09PSAnaWQnKSB7IHJldHVybjsgfQoKICAgIGhhc2guaWQgPSBoYXNoW3ByaW1hcnlLZXldOwogICAgZGVsZXRlIGhhc2hbcHJpbWFyeUtleV07CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIG5vcm1hbGl6ZVVzaW5nRGVjbGFyZWRNYXBwaW5nCiAgICBAcHJpdmF0ZQogICovCiAgbm9ybWFsaXplVXNpbmdEZWNsYXJlZE1hcHBpbmc6IGZ1bmN0aW9uKHR5cGUsIGhhc2gpIHsKICAgIHZhciBhdHRycyA9IGdldCh0aGlzLCAnYXR0cnMnKSwgcGF5bG9hZEtleSwga2V5OwoKICAgIGlmIChhdHRycykgewogICAgICBmb3IgKGtleSBpbiBhdHRycykgewogICAgICAgIHBheWxvYWRLZXkgPSBhdHRyc1trZXldOwogICAgICAgIGlmIChwYXlsb2FkS2V5ICYmIHBheWxvYWRLZXkua2V5KSB7CiAgICAgICAgICBwYXlsb2FkS2V5ID0gcGF5bG9hZEtleS5rZXk7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgcGF5bG9hZEtleSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGhhc2hba2V5XSA9IGhhc2hbcGF5bG9hZEtleV07CiAgICAgICAgICBkZWxldGUgaGFzaFtwYXlsb2FkS2V5XTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LAoKICAvKioKICAgIEBtZXRob2Qgbm9ybWFsaXplQXR0cmlidXRlcwogICAgQHByaXZhdGUKICAqLwogIG5vcm1hbGl6ZUF0dHJpYnV0ZXM6IGZ1bmN0aW9uKHR5cGUsIGhhc2gpIHsKICAgIHZhciBwYXlsb2FkS2V5LCBrZXk7CgogICAgaWYgKHRoaXMua2V5Rm9yQXR0cmlidXRlKSB7CiAgICAgIHR5cGUuZWFjaEF0dHJpYnV0ZShmdW5jdGlvbihrZXkpIHsKICAgICAgICBwYXlsb2FkS2V5ID0gdGhpcy5rZXlGb3JBdHRyaWJ1dGUoa2V5KTsKICAgICAgICBpZiAoa2V5ID09PSBwYXlsb2FkS2V5KSB7IHJldHVybjsgfQoKICAgICAgICBoYXNoW2tleV0gPSBoYXNoW3BheWxvYWRLZXldOwogICAgICAgIGRlbGV0ZSBoYXNoW3BheWxvYWRLZXldOwogICAgICB9LCB0aGlzKTsKICAgIH0KICB9LAoKICAvKioKICAgIEBtZXRob2Qgbm9ybWFsaXplUmVsYXRpb25zaGlwcwogICAgQHByaXZhdGUKICAqLwogIG5vcm1hbGl6ZVJlbGF0aW9uc2hpcHM6IGZ1bmN0aW9uKHR5cGUsIGhhc2gpIHsKICAgIHZhciBwYXlsb2FkS2V5LCBrZXk7CgogICAgaWYgKHRoaXMua2V5Rm9yUmVsYXRpb25zaGlwKSB7CiAgICAgIHR5cGUuZWFjaFJlbGF0aW9uc2hpcChmdW5jdGlvbihrZXksIHJlbGF0aW9uc2hpcCkgewogICAgICAgIHBheWxvYWRLZXkgPSB0aGlzLmtleUZvclJlbGF0aW9uc2hpcChrZXksIHJlbGF0aW9uc2hpcC5raW5kKTsKICAgICAgICBpZiAoa2V5ID09PSBwYXlsb2FkS2V5KSB7IHJldHVybjsgfQoKICAgICAgICBoYXNoW2tleV0gPSBoYXNoW3BheWxvYWRLZXldOwogICAgICAgIGRlbGV0ZSBoYXNoW3BheWxvYWRLZXldOwogICAgICB9LCB0aGlzKTsKICAgIH0KICB9LAoKICAvKioKICAgIENhbGxlZCB3aGVuIHRoZSBzZXJ2ZXIgaGFzIHJldHVybmVkIGEgcGF5bG9hZCByZXByZXNlbnRpbmcKICAgIGEgc2luZ2xlIHJlY29yZCwgc3VjaCBhcyBpbiByZXNwb25zZSB0byBhIGBmaW5kYCBvciBgc2F2ZWAuCgogICAgSXQgaXMgeW91ciBvcHBvcnR1bml0eSB0byBjbGVhbiB1cCB0aGUgc2VydmVyJ3MgcmVzcG9uc2UgaW50byB0aGUgbm9ybWFsaXplZAogICAgZm9ybSBleHBlY3RlZCBieSBFbWJlciBEYXRhLgoKICAgIElmIHlvdSB3YW50LCB5b3UgY2FuIGp1c3QgcmVzdHJ1Y3R1cmUgdGhlIHRvcC1sZXZlbCBvZiB5b3VyIHBheWxvYWQsIGFuZAogICAgZG8gbW9yZSBmaW5lLWdyYWluZWQgbm9ybWFsaXphdGlvbiBpbiB0aGUgYG5vcm1hbGl6ZWAgbWV0aG9kLgoKICAgIEZvciBleGFtcGxlLCBpZiB5b3UgaGF2ZSBhIHBheWxvYWQgbGlrZSB0aGlzIGluIHJlc3BvbnNlIHRvIGEgcmVxdWVzdCBmb3IKICAgIHBvc3QgMToKCiAgICBgYGBqcwogICAgewogICAgICAiaWQiOiAxLAogICAgICAidGl0bGUiOiAiUmFpbHMgaXMgb21ha2FzZSIsCgogICAgICAiX2VtYmVkZGVkIjogewogICAgICAgICJjb21tZW50IjogW3sKICAgICAgICAgICJfaWQiOiAxLAogICAgICAgICAgImNvbW1lbnRfdGl0bGUiOiAiRklSU1QiCiAgICAgICAgfSwgewogICAgICAgICAgIl9pZCI6IDIsCiAgICAgICAgICAiY29tbWVudF90aXRsZSI6ICJSYWlscyBpcyB1bmFnaSIKICAgICAgICB9XQogICAgICB9CiAgICB9CiAgICBgYGAKCiAgICBZb3UgY291bGQgaW1wbGVtZW50IGEgc2VyaWFsaXplciB0aGF0IGxvb2tzIGxpa2UgdGhpcyB0byBnZXQgeW91ciBwYXlsb2FkCiAgICBpbnRvIHNoYXBlOgoKICAgIGBgYGpzCiAgICBBcHAuUG9zdFNlcmlhbGl6ZXIgPSBEUy5SRVNUU2VyaWFsaXplci5leHRlbmQoewogICAgICAvLyBGaXJzdCwgcmVzdHJ1Y3R1cmUgdGhlIHRvcC1sZXZlbCBzbyBpdCdzIG9yZ2FuaXplZCBieSB0eXBlCiAgICAgIGV4dHJhY3RTaW5nbGU6IGZ1bmN0aW9uKHN0b3JlLCB0eXBlLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUpIHsKICAgICAgICB2YXIgY29tbWVudHMgPSBwYXlsb2FkLl9lbWJlZGRlZC5jb21tZW50OwogICAgICAgIGRlbGV0ZSBwYXlsb2FkLl9lbWJlZGRlZDsKCiAgICAgICAgcGF5bG9hZCA9IHsgY29tbWVudHM6IGNvbW1lbnRzLCBwb3N0OiBwYXlsb2FkIH07CiAgICAgICAgcmV0dXJuIHRoaXMuX3N1cGVyKHN0b3JlLCB0eXBlLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUpOwogICAgICB9LAoKICAgICAgbm9ybWFsaXplSGFzaDogewogICAgICAgIC8vIE5leHQsIG5vcm1hbGl6ZSBpbmRpdmlkdWFsIGNvbW1lbnRzLCB3aGljaCAoYWZ0ZXIgYGV4dHJhY3RgKQogICAgICAgIC8vIGFyZSBub3cgbG9jYXRlZCB1bmRlciBgY29tbWVudHNgCiAgICAgICAgY29tbWVudHM6IGZ1bmN0aW9uKGhhc2gpIHsKICAgICAgICAgIGhhc2guaWQgPSBoYXNoLl9pZDsKICAgICAgICAgIGhhc2gudGl0bGUgPSBoYXNoLmNvbW1lbnRfdGl0bGU7CiAgICAgICAgICBkZWxldGUgaGFzaC5faWQ7CiAgICAgICAgICBkZWxldGUgaGFzaC5jb21tZW50X3RpdGxlOwogICAgICAgICAgcmV0dXJuIGhhc2g7CiAgICAgICAgfQogICAgICB9CiAgICB9KQogICAgYGBgCgogICAgV2hlbiB5b3UgY2FsbCBzdXBlciBmcm9tIHlvdXIgb3duIGltcGxlbWVudGF0aW9uIG9mIGBleHRyYWN0U2luZ2xlYCwgdGhlCiAgICBidWlsdC1pbiBpbXBsZW1lbnRhdGlvbiB3aWxsIGZpbmQgdGhlIHByaW1hcnkgcmVjb3JkIGluIHlvdXIgbm9ybWFsaXplZAogICAgcGF5bG9hZCBhbmQgcHVzaCB0aGUgcmVtYWluaW5nIHJlY29yZHMgaW50byB0aGUgc3RvcmUuCgogICAgVGhlIHByaW1hcnkgcmVjb3JkIGlzIHRoZSBzaW5nbGUgaGFzaCBmb3VuZCB1bmRlciBgcG9zdGAgb3IgdGhlIGZpcnN0CiAgICBlbGVtZW50IG9mIHRoZSBgcG9zdHNgIGFycmF5LgoKICAgIFRoZSBwcmltYXJ5IHJlY29yZCBoYXMgc3BlY2lhbCBtZWFuaW5nIHdoZW4gdGhlIHJlY29yZCBpcyBiZWluZyBjcmVhdGVkCiAgICBmb3IgdGhlIGZpcnN0IHRpbWUgb3IgdXBkYXRlZCAoYGNyZWF0ZVJlY29yZGAgb3IgYHVwZGF0ZVJlY29yZGApLiBJbgogICAgcGFydGljdWxhciwgaXQgd2lsbCB1cGRhdGUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIHJlY29yZCB0aGF0IHdhcyBzYXZlZC4KCiAgICBAbWV0aG9kIGV4dHJhY3RTaW5nbGUKICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICBAcGFyYW0ge3N1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgQHBhcmFtIHtTdHJpbmd9IGlkCiAgICBAcGFyYW0geydmaW5kJ3wnY3JlYXRlUmVjb3JkJ3wndXBkYXRlUmVjb3JkJ3wnZGVsZXRlUmVjb3JkJ30gcmVxdWVzdFR5cGUKICAgIEByZXR1cm5zIHtPYmplY3R9IHRoZSBwcmltYXJ5IHJlc3BvbnNlIHRvIHRoZSBvcmlnaW5hbCByZXF1ZXN0CiAgKi8KICBleHRyYWN0U2luZ2xlOiBmdW5jdGlvbihzdG9yZSwgcHJpbWFyeVR5cGUsIHBheWxvYWQsIHJlY29yZElkLCByZXF1ZXN0VHlwZSkgewogICAgcGF5bG9hZCA9IHRoaXMubm9ybWFsaXplUGF5bG9hZChwcmltYXJ5VHlwZSwgcGF5bG9hZCk7CgogICAgdmFyIHByaW1hcnlUeXBlTmFtZSA9IHByaW1hcnlUeXBlLnR5cGVLZXksCiAgICAgICAgcHJpbWFyeVJlY29yZDsKCiAgICBmb3IgKHZhciBwcm9wIGluIHBheWxvYWQpIHsKICAgICAgdmFyIHR5cGVOYW1lICA9IHRoaXMudHlwZUZvclJvb3QocHJvcCksCiAgICAgICAgICBpc1ByaW1hcnkgPSB0eXBlTmFtZSA9PT0gcHJpbWFyeVR5cGVOYW1lOwoKICAgICAgLy8gbGVnYWN5IHN1cHBvcnQgZm9yIHNpbmd1bGFyIHJlc291cmNlcwogICAgICBpZiAoaXNQcmltYXJ5ICYmIEVtYmVyLnR5cGVPZihwYXlsb2FkW3Byb3BdKSAhPT0gImFycmF5IiApIHsKICAgICAgICBwcmltYXJ5UmVjb3JkID0gdGhpcy5ub3JtYWxpemUocHJpbWFyeVR5cGUsIHBheWxvYWRbcHJvcF0sIHByb3ApOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CgogICAgICB2YXIgdHlwZSA9IHN0b3JlLm1vZGVsRm9yKHR5cGVOYW1lKTsKCiAgICAgIC8qanNoaW50IGxvb3BmdW5jOnRydWUqLwogICAgICBmb3JFYWNoLmNhbGwocGF5bG9hZFtwcm9wXSwgZnVuY3Rpb24oaGFzaCkgewogICAgICAgIHZhciB0eXBlTmFtZSA9IHRoaXMudHlwZUZvclJvb3QocHJvcCksCiAgICAgICAgICAgIHR5cGUgPSBzdG9yZS5tb2RlbEZvcih0eXBlTmFtZSksCiAgICAgICAgICAgIHR5cGVTZXJpYWxpemVyID0gc3RvcmUuc2VyaWFsaXplckZvcih0eXBlKTsKCiAgICAgICAgaGFzaCA9IHR5cGVTZXJpYWxpemVyLm5vcm1hbGl6ZSh0eXBlLCBoYXNoLCBwcm9wKTsKCiAgICAgICAgdmFyIGlzRmlyc3RDcmVhdGVkUmVjb3JkID0gaXNQcmltYXJ5ICYmICFyZWNvcmRJZCAmJiAhcHJpbWFyeVJlY29yZCwKICAgICAgICAgICAgaXNVcGRhdGVkUmVjb3JkID0gaXNQcmltYXJ5ICYmIGNvZXJjZUlkKGhhc2guaWQpID09PSByZWNvcmRJZDsKCiAgICAgICAgLy8gZmluZCB0aGUgcHJpbWFyeSByZWNvcmQuCiAgICAgICAgLy8KICAgICAgICAvLyBJdCdzIGVpdGhlcjoKICAgICAgICAvLyAqIHRoZSByZWNvcmQgd2l0aCB0aGUgc2FtZSBJRCBhcyB0aGUgb3JpZ2luYWwgcmVxdWVzdAogICAgICAgIC8vICogaW4gdGhlIGNhc2Ugb2YgYSBuZXdseSBjcmVhdGVkIHJlY29yZCB0aGF0IGRpZG4ndCBoYXZlIGFuIElELCB0aGUgZmlyc3QKICAgICAgICAvLyAgIHJlY29yZCBpbiB0aGUgQXJyYXkKICAgICAgICBpZiAoaXNGaXJzdENyZWF0ZWRSZWNvcmQgfHwgaXNVcGRhdGVkUmVjb3JkKSB7CiAgICAgICAgICBwcmltYXJ5UmVjb3JkID0gaGFzaDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RvcmUucHVzaCh0eXBlTmFtZSwgaGFzaCk7CiAgICAgICAgfQogICAgICB9LCB0aGlzKTsKICAgIH0KCiAgICByZXR1cm4gcHJpbWFyeVJlY29yZDsKICB9LAoKICAvKioKICAgIENhbGxlZCB3aGVuIHRoZSBzZXJ2ZXIgaGFzIHJldHVybmVkIGEgcGF5bG9hZCByZXByZXNlbnRpbmcKICAgIG11bHRpcGxlIHJlY29yZHMsIHN1Y2ggYXMgaW4gcmVzcG9uc2UgdG8gYSBgZmluZEFsbGAgb3IgYGZpbmRRdWVyeWAuCgogICAgSXQgaXMgeW91ciBvcHBvcnR1bml0eSB0byBjbGVhbiB1cCB0aGUgc2VydmVyJ3MgcmVzcG9uc2UgaW50byB0aGUgbm9ybWFsaXplZAogICAgZm9ybSBleHBlY3RlZCBieSBFbWJlciBEYXRhLgoKICAgIElmIHlvdSB3YW50LCB5b3UgY2FuIGp1c3QgcmVzdHJ1Y3R1cmUgdGhlIHRvcC1sZXZlbCBvZiB5b3VyIHBheWxvYWQsIGFuZAogICAgZG8gbW9yZSBmaW5lLWdyYWluZWQgbm9ybWFsaXphdGlvbiBpbiB0aGUgYG5vcm1hbGl6ZWAgbWV0aG9kLgoKICAgIEZvciBleGFtcGxlLCBpZiB5b3UgaGF2ZSBhIHBheWxvYWQgbGlrZSB0aGlzIGluIHJlc3BvbnNlIHRvIGEgcmVxdWVzdCBmb3IKICAgIGFsbCBwb3N0czoKCiAgICBgYGBqcwogICAgewogICAgICAiX2VtYmVkZGVkIjogewogICAgICAgICJwb3N0IjogW3sKICAgICAgICAgICJpZCI6IDEsCiAgICAgICAgICAidGl0bGUiOiAiUmFpbHMgaXMgb21ha2FzZSIKICAgICAgICB9LCB7CiAgICAgICAgICAiaWQiOiAyLAogICAgICAgICAgInRpdGxlIjogIlRoZSBQYXJsZXkgTGV0dGVyIgogICAgICAgIH1dLAogICAgICAgICJjb21tZW50IjogW3sKICAgICAgICAgICJfaWQiOiAxLAogICAgICAgICAgImNvbW1lbnRfdGl0bGUiOiAiUmFpbHMgaXMgdW5hZ2kiCiAgICAgICAgICAicG9zdF9pZCI6IDEKICAgICAgICB9LCB7CiAgICAgICAgICAiX2lkIjogMiwKICAgICAgICAgICJjb21tZW50X3RpdGxlIjogIkRvbid0IHRyZWFkIG9uIG1lIiwKICAgICAgICAgICJwb3N0X2lkIjogMgogICAgICAgIH1dCiAgICAgIH0KICAgIH0KICAgIGBgYAoKICAgIFlvdSBjb3VsZCBpbXBsZW1lbnQgYSBzZXJpYWxpemVyIHRoYXQgbG9va3MgbGlrZSB0aGlzIHRvIGdldCB5b3VyIHBheWxvYWQKICAgIGludG8gc2hhcGU6CgogICAgYGBganMKICAgIEFwcC5Qb3N0U2VyaWFsaXplciA9IERTLlJFU1RTZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgIC8vIEZpcnN0LCByZXN0cnVjdHVyZSB0aGUgdG9wLWxldmVsIHNvIGl0J3Mgb3JnYW5pemVkIGJ5IHR5cGUKICAgICAgLy8gYW5kIHRoZSBjb21tZW50cyBhcmUgbGlzdGVkIHVuZGVyIGEgcG9zdCdzIGBjb21tZW50c2Aga2V5LgogICAgICBleHRyYWN0QXJyYXk6IGZ1bmN0aW9uKHN0b3JlLCB0eXBlLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUpIHsKICAgICAgICB2YXIgcG9zdHMgPSBwYXlsb2FkLl9lbWJlZGRlZC5wb3N0OwogICAgICAgIHZhciBjb21tZW50cyA9IFtdOwogICAgICAgIHZhciBwb3N0Q2FjaGUgPSB7fTsKCiAgICAgICAgcG9zdHMuZm9yRWFjaChmdW5jdGlvbihwb3N0KSB7CiAgICAgICAgICBwb3N0LmNvbW1lbnRzID0gW107CiAgICAgICAgICBwb3N0Q2FjaGVbcG9zdC5pZF0gPSBwb3N0OwogICAgICAgIH0pOwoKICAgICAgICBwYXlsb2FkLl9lbWJlZGRlZC5jb21tZW50LmZvckVhY2goZnVuY3Rpb24oY29tbWVudCkgewogICAgICAgICAgY29tbWVudHMucHVzaChjb21tZW50KTsKICAgICAgICAgIHBvc3RDYWNoZVtjb21tZW50LnBvc3RfaWRdLmNvbW1lbnRzLnB1c2goY29tbWVudCk7CiAgICAgICAgICBkZWxldGUgY29tbWVudC5wb3N0X2lkOwogICAgICAgIH0KCiAgICAgICAgcGF5bG9hZCA9IHsgY29tbWVudHM6IGNvbW1lbnRzLCBwb3N0czogcGF5bG9hZCB9OwoKICAgICAgICByZXR1cm4gdGhpcy5fc3VwZXIoc3RvcmUsIHR5cGUsIHBheWxvYWQsIGlkLCByZXF1ZXN0VHlwZSk7CiAgICAgIH0sCgogICAgICBub3JtYWxpemVIYXNoOiB7CiAgICAgICAgLy8gTmV4dCwgbm9ybWFsaXplIGluZGl2aWR1YWwgY29tbWVudHMsIHdoaWNoIChhZnRlciBgZXh0cmFjdGApCiAgICAgICAgLy8gYXJlIG5vdyBsb2NhdGVkIHVuZGVyIGBjb21tZW50c2AKICAgICAgICBjb21tZW50czogZnVuY3Rpb24oaGFzaCkgewogICAgICAgICAgaGFzaC5pZCA9IGhhc2guX2lkOwogICAgICAgICAgaGFzaC50aXRsZSA9IGhhc2guY29tbWVudF90aXRsZTsKICAgICAgICAgIGRlbGV0ZSBoYXNoLl9pZDsKICAgICAgICAgIGRlbGV0ZSBoYXNoLmNvbW1lbnRfdGl0bGU7CiAgICAgICAgICByZXR1cm4gaGFzaDsKICAgICAgICB9CiAgICAgIH0KICAgIH0pCiAgICBgYGAKCiAgICBXaGVuIHlvdSBjYWxsIHN1cGVyIGZyb20geW91ciBvd24gaW1wbGVtZW50YXRpb24gb2YgYGV4dHJhY3RBcnJheWAsIHRoZQogICAgYnVpbHQtaW4gaW1wbGVtZW50YXRpb24gd2lsbCBmaW5kIHRoZSBwcmltYXJ5IGFycmF5IGluIHlvdXIgbm9ybWFsaXplZAogICAgcGF5bG9hZCBhbmQgcHVzaCB0aGUgcmVtYWluaW5nIHJlY29yZHMgaW50byB0aGUgc3RvcmUuCgogICAgVGhlIHByaW1hcnkgYXJyYXkgaXMgdGhlIGFycmF5IGZvdW5kIHVuZGVyIGBwb3N0c2AuCgogICAgVGhlIHByaW1hcnkgcmVjb3JkIGhhcyBzcGVjaWFsIG1lYW5pbmcgd2hlbiByZXNwb25kaW5nIHRvIGBmaW5kUXVlcnlgCiAgICBvciBgZmluZEhhc01hbnlgLiBJbiBwYXJ0aWN1bGFyLCB0aGUgcHJpbWFyeSBhcnJheSB3aWxsIGJlY29tZSB0aGUKICAgIGxpc3Qgb2YgcmVjb3JkcyBpbiB0aGUgcmVjb3JkIGFycmF5IHRoYXQga2lja2VkIG9mZiB0aGUgcmVxdWVzdC4KCiAgICBJZiB5b3VyIHByaW1hcnkgYXJyYXkgY29udGFpbnMgc2Vjb25kYXJ5IChlbWJlZGRlZCkgcmVjb3JkcyBvZiB0aGUgc2FtZSB0eXBlLAogICAgeW91IGNhbm5vdCBwbGFjZSB0aGVzZSBpbnRvIHRoZSBwcmltYXJ5IGFycmF5IGBwb3N0c2AuIEluc3RlYWQsIHBsYWNlIHRoZQogICAgc2Vjb25kYXJ5IGl0ZW1zIGludG8gYW4gdW5kZXJzY29yZSBwcmVmaXhlZCBwcm9wZXJ0eSBgX3Bvc3RzYCwgd2hpY2ggd2lsbAogICAgcHVzaCB0aGVzZSBpdGVtcyBpbnRvIHRoZSBzdG9yZSBhbmQgd2lsbCBub3QgYWZmZWN0IHRoZSByZXN1bHRpbmcgcXVlcnkuCgogICAgQG1ldGhvZCBleHRyYWN0QXJyYXkKICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICBAcGFyYW0ge3N1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgQHBhcmFtIHsnZmluZEFsbCd8J2ZpbmRNYW55J3wnZmluZEhhc01hbnknfCdmaW5kUXVlcnknfSByZXF1ZXN0VHlwZQogICAgQHJldHVybnMge0FycmF5fSBUaGUgcHJpbWFyeSBhcnJheSB0aGF0IHdhcyByZXR1cm5lZCBpbiByZXNwb25zZQogICAgICB0byB0aGUgb3JpZ2luYWwgcXVlcnkuCiAgKi8KICBleHRyYWN0QXJyYXk6IGZ1bmN0aW9uKHN0b3JlLCBwcmltYXJ5VHlwZSwgcGF5bG9hZCkgewogICAgcGF5bG9hZCA9IHRoaXMubm9ybWFsaXplUGF5bG9hZChwcmltYXJ5VHlwZSwgcGF5bG9hZCk7CgogICAgdmFyIHByaW1hcnlUeXBlTmFtZSA9IHByaW1hcnlUeXBlLnR5cGVLZXksCiAgICAgICAgcHJpbWFyeUFycmF5OwoKICAgIGZvciAodmFyIHByb3AgaW4gcGF5bG9hZCkgewogICAgICB2YXIgdHlwZUtleSA9IHByb3AsCiAgICAgICAgICBmb3JjZWRTZWNvbmRhcnkgPSBmYWxzZTsKCiAgICAgIGlmIChwcm9wLmNoYXJBdCgwKSA9PT0gJ18nKSB7CiAgICAgICAgZm9yY2VkU2Vjb25kYXJ5ID0gdHJ1ZTsKICAgICAgICB0eXBlS2V5ID0gcHJvcC5zdWJzdHIoMSk7CiAgICAgIH0KCiAgICAgIHZhciB0eXBlTmFtZSA9IHRoaXMudHlwZUZvclJvb3QodHlwZUtleSksCiAgICAgICAgICB0eXBlID0gc3RvcmUubW9kZWxGb3IodHlwZU5hbWUpLAogICAgICAgICAgdHlwZVNlcmlhbGl6ZXIgPSBzdG9yZS5zZXJpYWxpemVyRm9yKHR5cGUpLAogICAgICAgICAgaXNQcmltYXJ5ID0gKCFmb3JjZWRTZWNvbmRhcnkgJiYgKHR5cGVOYW1lID09PSBwcmltYXJ5VHlwZU5hbWUpKTsKCiAgICAgIC8qanNoaW50IGxvb3BmdW5jOnRydWUqLwogICAgICB2YXIgbm9ybWFsaXplZEFycmF5ID0gbWFwLmNhbGwocGF5bG9hZFtwcm9wXSwgZnVuY3Rpb24oaGFzaCkgewogICAgICAgIHJldHVybiB0eXBlU2VyaWFsaXplci5ub3JtYWxpemUodHlwZSwgaGFzaCwgcHJvcCk7CiAgICAgIH0sIHRoaXMpOwoKICAgICAgaWYgKGlzUHJpbWFyeSkgewogICAgICAgIHByaW1hcnlBcnJheSA9IG5vcm1hbGl6ZWRBcnJheTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdG9yZS5wdXNoTWFueSh0eXBlTmFtZSwgbm9ybWFsaXplZEFycmF5KTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBwcmltYXJ5QXJyYXk7CiAgfSwKCiAgLyoqCiAgICBUaGlzIG1ldGhvZCBhbGxvd3MgeW91IHRvIHB1c2ggYSBwYXlsb2FkIGNvbnRhaW5pbmcgdG9wLWxldmVsCiAgICBjb2xsZWN0aW9ucyBvZiByZWNvcmRzIG9yZ2FuaXplZCBwZXIgdHlwZS4KCiAgICBgYGBqcwogICAgewogICAgICAicG9zdHMiOiBbewogICAgICAgICJpZCI6ICIxIiwKICAgICAgICAidGl0bGUiOiAiUmFpbHMgaXMgb21ha2FzZSIsCiAgICAgICAgImF1dGhvciIsICIxIiwKICAgICAgICAiY29tbWVudHMiOiBbICIxIiBdCiAgICAgIH1dLAogICAgICAiY29tbWVudHMiOiBbewogICAgICAgICJpZCI6ICIxIiwKICAgICAgICAiYm9keSI6ICJGSVJTVCIKICAgICAgfV0sCiAgICAgICJ1c2VycyI6IFt7CiAgICAgICAgImlkIjogIjEiLAogICAgICAgICJuYW1lIjogIkBkMmgiCiAgICAgIH1dCiAgICB9CiAgICBgYGAKCiAgICBJdCB3aWxsIGZpcnN0IG5vcm1hbGl6ZSB0aGUgcGF5bG9hZCwgc28geW91IGNhbiB1c2UgdGhpcyB0byBwdXNoCiAgICBpbiBkYXRhIHN0cmVhbWluZyBpbiBmcm9tIHlvdXIgc2VydmVyIHN0cnVjdHVyZWQgdGhlIHNhbWUgd2F5CiAgICB0aGF0IGZldGNoZXMgYW5kIHNhdmVzIGFyZSBzdHJ1Y3R1cmVkLgoKICAgIEBtZXRob2QgcHVzaFBheWxvYWQKICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICovCiAgcHVzaFBheWxvYWQ6IGZ1bmN0aW9uKHN0b3JlLCBwYXlsb2FkKSB7CiAgICBwYXlsb2FkID0gdGhpcy5ub3JtYWxpemVQYXlsb2FkKG51bGwsIHBheWxvYWQpOwoKICAgIGZvciAodmFyIHByb3AgaW4gcGF5bG9hZCkgewogICAgICB2YXIgdHlwZU5hbWUgPSB0aGlzLnR5cGVGb3JSb290KHByb3ApLAogICAgICAgICAgdHlwZSA9IHN0b3JlLm1vZGVsRm9yKHR5cGVOYW1lKTsKCiAgICAgIC8qanNoaW50IGxvb3BmdW5jOnRydWUqLwogICAgICB2YXIgbm9ybWFsaXplZEFycmF5ID0gbWFwLmNhbGwoRW1iZXIubWFrZUFycmF5KHBheWxvYWRbcHJvcF0pLCBmdW5jdGlvbihoYXNoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplKHR5cGUsIGhhc2gsIHByb3ApOwogICAgICB9LCB0aGlzKTsKCiAgICAgIHN0b3JlLnB1c2hNYW55KHR5cGVOYW1lLCBub3JtYWxpemVkQXJyYXkpOwogICAgfQogIH0sCgogIC8qKgogICAgWW91IGNhbiB1c2UgdGhpcyBtZXRob2QgdG8gbm9ybWFsaXplIHRoZSBKU09OIHJvb3Qga2V5cyByZXR1cm5lZAogICAgaW50byB0aGUgbW9kZWwgdHlwZSBleHBlY3RlZCBieSB5b3VyIHN0b3JlLgoKICAgIEZvciBleGFtcGxlLCB5b3VyIHNlcnZlciBtYXkgcmV0dXJuIHVuZGVyc2NvcmVkIHJvb3Qga2V5cyByYXRoZXIgdGhhbgogICAgdGhlIGV4cGVjdGVkIGNhbWVsY2FzZWQgdmVyc2lvbnMuCgogICAgYGBganMKICAgIEFwcC5BcHBsaWNhdGlvblNlcmlhbGl6ZXIgPSBEUy5SRVNUU2VyaWFsaXplci5leHRlbmQoewogICAgICB0eXBlRm9yUm9vdDogZnVuY3Rpb24ocm9vdCkgewogICAgICAgIHZhciBjYW1lbGl6ZWQgPSBFbWJlci5TdHJpbmcuY2FtZWxpemUocm9vdCk7CiAgICAgICAgcmV0dXJuIEVtYmVyLlN0cmluZy5zaW5ndWxhcml6ZShjYW1lbGl6ZWQpOwogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgIEBtZXRob2QgdHlwZUZvclJvb3QKICAgIEBwYXJhbSB7U3RyaW5nfSByb290CiAgICBAcmV0dXJucyB7U3RyaW5nfSB0aGUgbW9kZWwncyB0eXBlS2V5CiAgKi8KICB0eXBlRm9yUm9vdDogZnVuY3Rpb24ocm9vdCkgewogICAgcmV0dXJuIEVtYmVyLlN0cmluZy5zaW5ndWxhcml6ZShyb290KTsKICB9LAoKICAvLyBTRVJJQUxJWkUKCiAgLyoqCiAgICBDYWxsZWQgd2hlbiBhIHJlY29yZCBpcyBzYXZlZCBpbiBvcmRlciB0byBjb252ZXJ0IHRoZQogICAgcmVjb3JkIGludG8gSlNPTi4KCiAgICBCeSBkZWZhdWx0LCBpdCBjcmVhdGVzIGEgSlNPTiBvYmplY3Qgd2l0aCBhIGtleSBmb3IKICAgIGVhY2ggYXR0cmlidXRlIGFuZCBiZWxvbmdzVG8gcmVsYXRpb25zaGlwLgoKICAgIEZvciBleGFtcGxlLCBjb25zaWRlciB0aGlzIG1vZGVsOgoKICAgIGBgYGpzCiAgICBBcHAuQ29tbWVudCA9IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgIHRpdGxlOiBEUy5hdHRyKCksCiAgICAgIGJvZHk6IERTLmF0dHIoKSwKCiAgICAgIGF1dGhvcjogRFMuYmVsb25nc1RvKCd1c2VyJykKICAgIH0pOwogICAgYGBgCgogICAgVGhlIGRlZmF1bHQgc2VyaWFsaXphdGlvbiB3b3VsZCBjcmVhdGUgYSBKU09OIG9iamVjdCBsaWtlOgoKICAgIGBgYGpzCiAgICB7CiAgICAgICJ0aXRsZSI6ICJSYWlscyBpcyB1bmFnaSIsCiAgICAgICJib2R5IjogIlJhaWxzPyBPbWFrYXNlPyBPX08iLAogICAgICAiYXV0aG9yIjogMTIKICAgIH0KICAgIGBgYAoKICAgIEJ5IGRlZmF1bHQsIGF0dHJpYnV0ZXMgYXJlIHBhc3NlZCB0aHJvdWdoIGFzLWlzLCB1bmxlc3MKICAgIHlvdSBzcGVjaWZpZWQgYW4gYXR0cmlidXRlIHR5cGUgKGBEUy5hdHRyKCdkYXRlJylgKS4gSWYKICAgIHlvdSBzcGVjaWZ5IGEgdHJhbnNmb3JtLCB0aGUgSmF2YVNjcmlwdCB2YWx1ZSB3aWxsIGJlCiAgICBzZXJpYWxpemVkIHdoZW4gaW5zZXJ0ZWQgaW50byB0aGUgSlNPTiBoYXNoLgoKICAgIEJ5IGRlZmF1bHQsIGJlbG9uZ3MtdG8gcmVsYXRpb25zaGlwcyBhcmUgY29udmVydGVkIGludG8KICAgIElEcyB3aGVuIGluc2VydGVkIGludG8gdGhlIEpTT04gaGFzaC4KCiAgICAjIyBJRHMKCiAgICBgc2VyaWFsaXplYCB0YWtlcyBhbiBvcHRpb25zIGhhc2ggd2l0aCBhIHNpbmdsZSBvcHRpb246CiAgICBgaW5jbHVkZUlkYC4gSWYgdGhpcyBvcHRpb24gaXMgYHRydWVgLCBgc2VyaWFsaXplYCB3aWxsLAogICAgYnkgZGVmYXVsdCBpbmNsdWRlIHRoZSBJRCBpbiB0aGUgSlNPTiBvYmplY3QgaXQgYnVpbGRzLgoKICAgIFRoZSBhZGFwdGVyIHBhc3NlcyBpbiBgaW5jbHVkZUlkOiB0cnVlYCB3aGVuIHNlcmlhbGl6aW5nCiAgICBhIHJlY29yZCBmb3IgYGNyZWF0ZVJlY29yZGAsIGJ1dCBub3QgZm9yIGB1cGRhdGVSZWNvcmRgLgoKICAgICMjIEN1c3RvbWl6YXRpb24KCiAgICBZb3VyIHNlcnZlciBtYXkgZXhwZWN0IGEgZGlmZmVyZW50IEpTT04gZm9ybWF0IHRoYW4gdGhlCiAgICBidWlsdC1pbiBzZXJpYWxpemF0aW9uIGZvcm1hdC4KCiAgICBJbiB0aGF0IGNhc2UsIHlvdSBjYW4gaW1wbGVtZW50IGBzZXJpYWxpemVgIHlvdXJzZWxmIGFuZAogICAgcmV0dXJuIGEgSlNPTiBoYXNoIG9mIHlvdXIgY2hvb3NpbmcuCgogICAgYGBganMKICAgIEFwcC5Qb3N0U2VyaWFsaXplciA9IERTLlJFU1RTZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgIHNlcmlhbGl6ZTogZnVuY3Rpb24ocG9zdCwgb3B0aW9ucykgewogICAgICAgIHZhciBqc29uID0gewogICAgICAgICAgUE9TVF9UVEw6IHBvc3QuZ2V0KCd0aXRsZScpLAogICAgICAgICAgUE9TVF9CRFk6IHBvc3QuZ2V0KCdib2R5JyksCiAgICAgICAgICBQT1NUX0NNUzogcG9zdC5nZXQoJ2NvbW1lbnRzJykubWFwUHJvcGVydHkoJ2lkJykKICAgICAgICB9CgogICAgICAgIGlmIChvcHRpb25zLmluY2x1ZGVJZCkgewogICAgICAgICAganNvbi5QT1NUX0lEXyA9IHBvc3QuZ2V0KCdpZCcpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGpzb247CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgIyMgQ3VzdG9taXppbmcgYW4gQXBwLVdpZGUgU2VyaWFsaXplcgoKICAgIElmIHlvdSB3YW50IHRvIGRlZmluZSBhIHNlcmlhbGl6ZXIgZm9yIHlvdXIgZW50aXJlCiAgICBhcHBsaWNhdGlvbiwgeW91J2xsIHByb2JhYmx5IHdhbnQgdG8gdXNlIGBlYWNoQXR0cmlidXRlYAogICAgYW5kIGBlYWNoUmVsYXRpb25zaGlwYCBvbiB0aGUgcmVjb3JkLgoKICAgIGBgYGpzCiAgICBBcHAuQXBwbGljYXRpb25TZXJpYWxpemVyID0gRFMuUkVTVFNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgc2VyaWFsaXplOiBmdW5jdGlvbihyZWNvcmQsIG9wdGlvbnMpIHsKICAgICAgICB2YXIganNvbiA9IHt9OwoKICAgICAgICByZWNvcmQuZWFjaEF0dHJpYnV0ZShmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBqc29uW3NlcnZlckF0dHJpYnV0ZU5hbWUobmFtZSldID0gcmVjb3JkLmdldChuYW1lKTsKICAgICAgICB9KQoKICAgICAgICByZWNvcmQuZWFjaFJlbGF0aW9uc2hpcChmdW5jdGlvbihuYW1lLCByZWxhdGlvbnNoaXApIHsKICAgICAgICAgIGlmIChyZWxhdGlvbnNoaXAua2luZCA9PT0gJ2hhc01hbnknKSB7CiAgICAgICAgICAgIGpzb25bc2VydmVySGFzTWFueU5hbWUobmFtZSldID0gcmVjb3JkLmdldChuYW1lKS5tYXBCeSgnaWQnKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgaWYgKG9wdGlvbnMuaW5jbHVkZUlkKSB7CiAgICAgICAgICBqc29uLklEXyA9IHJlY29yZC5nZXQoJ2lkJyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4ganNvbjsKICAgICAgfQogICAgfSk7CgogICAgZnVuY3Rpb24gc2VydmVyQXR0cmlidXRlTmFtZShhdHRyaWJ1dGUpIHsKICAgICAgcmV0dXJuIGF0dHJpYnV0ZS51bmRlcnNjb3JlKCkudG9VcHBlckNhc2UoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXJ2ZXJIYXNNYW55TmFtZShuYW1lKSB7CiAgICAgIHJldHVybiBzZXJ2ZXJBdHRyaWJ1dGVOYW1lKG5hbWUuc2luZ3VsYXJpemUoKSkgKyAiX0lEUyI7CiAgICB9CiAgICBgYGAKCiAgICBUaGlzIHNlcmlhbGl6ZXIgd2lsbCBnZW5lcmF0ZSBKU09OIHRoYXQgbG9va3MgbGlrZSB0aGlzOgoKICAgIGBgYGpzCiAgICB7CiAgICAgICJUSVRMRSI6ICJSYWlscyBpcyBvbWFrYXNlIiwKICAgICAgIkJPRFkiOiAiWWVwLiBPbWFrYXNlLiIsCiAgICAgICJDT01NRU5UX0lEUyI6IFsgMSwgMiwgMyBdCiAgICB9CiAgICBgYGAKCiAgICAjIyBUd2Vha2luZyB0aGUgRGVmYXVsdCBKU09OCgogICAgSWYgeW91IGp1c3Qgd2FudCB0byBkbyBzb21lIHNtYWxsIHR3ZWFrcyBvbiB0aGUgZGVmYXVsdCBKU09OLAogICAgeW91IGNhbiBjYWxsIHN1cGVyIGZpcnN0IGFuZCBtYWtlIHRoZSB0d2Vha3Mgb24gdGhlIHJldHVybmVkCiAgICBKU09OLgoKICAgIGBgYGpzCiAgICBBcHAuUG9zdFNlcmlhbGl6ZXIgPSBEUy5SRVNUU2VyaWFsaXplci5leHRlbmQoewogICAgICBzZXJpYWxpemU6IGZ1bmN0aW9uKHJlY29yZCwgb3B0aW9ucykgewogICAgICAgIHZhciBqc29uID0gdGhpcy5fc3VwZXIocmVjb3JkLCBvcHRpb25zKTsKCiAgICAgICAganNvbi5zdWJqZWN0ID0ganNvbi50aXRsZTsKICAgICAgICBkZWxldGUganNvbi50aXRsZTsKCiAgICAgICAgcmV0dXJuIGpzb247CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgQG1ldGhvZCBzZXJpYWxpemUKICAgIEBwYXJhbSByZWNvcmQKICAgIEBwYXJhbSBvcHRpb25zCiAgKi8KICBzZXJpYWxpemU6IGZ1bmN0aW9uKHJlY29yZCwgb3B0aW9ucykgewogICAgcmV0dXJuIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfSwKCiAgLyoqCiAgICBZb3UgY2FuIHVzZSB0aGlzIG1ldGhvZCB0byBjdXN0b21pemUgdGhlIHJvb3Qga2V5cyBzZXJpYWxpemVkIGludG8gdGhlIEpTT04uCiAgICBCeSBkZWZhdWx0IHRoZSBSRVNUIFNlcmlhbGl6ZXIgc2VuZHMgY2FtZWxpemVkIHJvb3Qga2V5cy4KICAgIEZvciBleGFtcGxlLCB5b3VyIHNlcnZlciBtYXkgZXhwZWN0IHVuZGVyc2NvcmVkIHJvb3Qgb2JqZWN0cy4KCiAgICBgYGBqcwogICAgQXBwLkFwcGxpY2F0aW9uU2VyaWFsaXplciA9IERTLlJFU1RTZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgIHNlcmlhbGl6ZUludG9IYXNoOiBmdW5jdGlvbihkYXRhLCB0eXBlLCByZWNvcmQsIG9wdGlvbnMpIHsKICAgICAgICB2YXIgcm9vdCA9IEVtYmVyLlN0cmluZy5kZWNhbWVsaXplKHR5cGUudHlwZUtleSk7CiAgICAgICAgZGF0YVtyb290XSA9IHRoaXMuc2VyaWFsaXplKHJlY29yZCwgb3B0aW9ucyk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgQG1ldGhvZCBzZXJpYWxpemVJbnRvSGFzaAogICAgQHBhcmFtIHtPYmplY3R9IGhhc2gKICAgIEBwYXJhbSB7c3ViY2xhc3Mgb2YgRFMuTW9kZWx9IHR5cGUKICAgIEBwYXJhbSB7RFMuTW9kZWx9IHJlY29yZAogICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAqLwogIHNlcmlhbGl6ZUludG9IYXNoOiBmdW5jdGlvbihoYXNoLCB0eXBlLCByZWNvcmQsIG9wdGlvbnMpIHsKICAgIGhhc2hbdHlwZS50eXBlS2V5XSA9IHRoaXMuc2VyaWFsaXplKHJlY29yZCwgb3B0aW9ucyk7CiAgfSwKCiAgLyoqCiAgICBZb3UgY2FuIHVzZSB0aGlzIG1ldGhvZCB0byBjdXN0b21pemUgaG93IHBvbHltb3JwaGljIG9iamVjdHMgYXJlIHNlcmlhbGl6ZWQuCiAgICBCeSBkZWZhdWx0IHRoZSBKU09OIFNlcmlhbGl6ZXIgY3JlYXRlcyB0aGUga2V5IGJ5IGFwcGVuZGluZyBgVHlwZWAgdG8KICAgIHRoZSBhdHRyaWJ1dGUgYW5kIHZhbHVlIGZyb20gdGhlIG1vZGVsJ3MgY2FtZWxjYXNlZCBtb2RlbCBuYW1lLgoKICAgIEBtZXRob2Qgc2VyaWFsaXplUG9seW1vcnBoaWNUeXBlCiAgICBAcGFyYW0ge0RTLk1vZGVsfSByZWNvcmQKICAgIEBwYXJhbSB7T2JqZWN0fSBqc29uCiAgICBAcGFyYW0ge09iamVjdH0gcmVsYXRpb25zaGlwCiAgKi8KICBzZXJpYWxpemVQb2x5bW9ycGhpY1R5cGU6IGZ1bmN0aW9uKHJlY29yZCwganNvbiwgcmVsYXRpb25zaGlwKSB7CiAgICB2YXIga2V5ID0gcmVsYXRpb25zaGlwLmtleSwKICAgICAgICBiZWxvbmdzVG8gPSBnZXQocmVjb3JkLCBrZXkpOwogICAga2V5ID0gdGhpcy5rZXlGb3JBdHRyaWJ1dGUgPyB0aGlzLmtleUZvckF0dHJpYnV0ZShrZXkpIDoga2V5OwogICAganNvbltrZXkgKyAiVHlwZSJdID0gYmVsb25nc1RvLmNvbnN0cnVjdG9yLnR5cGVLZXk7CiAgfQp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCiAgQG1vZHVsZSBlbWJlci1kYXRhCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQ7CnZhciBmb3JFYWNoID0gRW1iZXIuQXJyYXlQb2x5ZmlsbHMuZm9yRWFjaDsKCi8qKgogIFRoZSBSRVNUIGFkYXB0ZXIgYWxsb3dzIHlvdXIgc3RvcmUgdG8gY29tbXVuaWNhdGUgd2l0aCBhbiBIVFRQIHNlcnZlciBieQogIHRyYW5zbWl0dGluZyBKU09OIHZpYSBYSFIuIE1vc3QgRW1iZXIuanMgYXBwcyB0aGF0IGNvbnN1bWUgYSBKU09OIEFQSQogIHNob3VsZCB1c2UgdGhlIFJFU1QgYWRhcHRlci4KCiAgVGhpcyBhZGFwdGVyIGlzIGRlc2lnbmVkIGFyb3VuZCB0aGUgaWRlYSB0aGF0IHRoZSBKU09OIGV4Y2hhbmdlZCB3aXRoCiAgdGhlIHNlcnZlciBzaG91bGQgYmUgY29udmVudGlvbmFsLgoKICAjIyBKU09OIFN0cnVjdHVyZQoKICBUaGUgUkVTVCBhZGFwdGVyIGV4cGVjdHMgdGhlIEpTT04gcmV0dXJuZWQgZnJvbSB5b3VyIHNlcnZlciB0byBmb2xsb3cKICB0aGVzZSBjb252ZW50aW9ucy4KCiAgIyMjIE9iamVjdCBSb290CgogIFRoZSBKU09OIHBheWxvYWQgc2hvdWxkIGJlIGFuIG9iamVjdCB0aGF0IGNvbnRhaW5zIHRoZSByZWNvcmQgaW5zaWRlIGEKICByb290IHByb3BlcnR5LiBGb3IgZXhhbXBsZSwgaW4gcmVzcG9uc2UgdG8gYSBgR0VUYCByZXF1ZXN0IGZvcgogIGAvcG9zdHMvMWAsIHRoZSBKU09OIHNob3VsZCBsb29rIGxpa2UgdGhpczoKCiAgYGBganMKICB7CiAgICAicG9zdCI6IHsKICAgICAgInRpdGxlIjogIkknbSBSdW5uaW5nIHRvIFJlZm9ybSB0aGUgVzNDJ3MgVGFnIiwKICAgICAgImF1dGhvciI6ICJZZWh1ZGEgS2F0eiIKICAgIH0KICB9CiAgYGBgCgogICMjIyBDb252ZW50aW9uYWwgTmFtZXMKCiAgQXR0cmlidXRlIG5hbWVzIGluIHlvdXIgSlNPTiBwYXlsb2FkIHNob3VsZCBiZSB0aGUgY2FtZWxDYXNlZCB2ZXJzaW9ucyBvZgogIHRoZSBhdHRyaWJ1dGVzIGluIHlvdXIgRW1iZXIuanMgbW9kZWxzLgoKICBGb3IgZXhhbXBsZSwgaWYgeW91IGhhdmUgYSBgUGVyc29uYCBtb2RlbDoKCiAgYGBganMKICBBcHAuUGVyc29uID0gRFMuTW9kZWwuZXh0ZW5kKHsKICAgIGZpcnN0TmFtZTogRFMuYXR0cignc3RyaW5nJyksCiAgICBsYXN0TmFtZTogRFMuYXR0cignc3RyaW5nJyksCiAgICBvY2N1cGF0aW9uOiBEUy5hdHRyKCdzdHJpbmcnKQogIH0pOwogIGBgYAoKICBUaGUgSlNPTiByZXR1cm5lZCBzaG91bGQgbG9vayBsaWtlIHRoaXM6CgogIGBgYGpzCiAgewogICAgInBlcnNvbiI6IHsKICAgICAgImZpcnN0TmFtZSI6ICJCYXJhY2siLAogICAgICAibGFzdE5hbWUiOiAiT2JhbWEiLAogICAgICAib2NjdXBhdGlvbiI6ICJQcmVzaWRlbnQiCiAgICB9CiAgfQogIGBgYAoKICAjIyBDdXN0b21pemF0aW9uCgogICMjIyBFbmRwb2ludCBwYXRoIGN1c3RvbWl6YXRpb24KCiAgRW5kcG9pbnQgcGF0aHMgY2FuIGJlIHByZWZpeGVkIHdpdGggYSBgbmFtZXNwYWNlYCBieSBzZXR0aW5nIHRoZSBuYW1lc3BhY2UKICBwcm9wZXJ0eSBvbiB0aGUgYWRhcHRlcjoKCiAgYGBganMKICBEUy5SRVNUQWRhcHRlci5yZW9wZW4oewogICAgbmFtZXNwYWNlOiAnYXBpLzEnCiAgfSk7CiAgYGBgCiAgUmVxdWVzdHMgZm9yIGBBcHAuUGVyc29uYCB3b3VsZCBub3cgdGFyZ2V0IGAvYXBpLzEvcGVvcGxlLzFgLgoKICAjIyMgSG9zdCBjdXN0b21pemF0aW9uCgogIEFuIGFkYXB0ZXIgY2FuIHRhcmdldCBvdGhlciBob3N0cyBieSBzZXR0aW5nIHRoZSBgaG9zdGAgcHJvcGVydHkuCgogIGBgYGpzCiAgRFMuUkVTVEFkYXB0ZXIucmVvcGVuKHsKICAgIGhvc3Q6ICdodHRwczovL2FwaS5leGFtcGxlLmNvbScKICB9KTsKICBgYGAKCiAgIyMjIEhlYWRlcnMgY3VzdG9taXphdGlvbgoKICBTb21lIEFQSXMgcmVxdWlyZSBIVFRQIGhlYWRlcnMsIGUuZy4gdG8gcHJvdmlkZSBhbiBBUEkga2V5LiBBbiBhcnJheSBvZgogIGhlYWRlcnMgY2FuIGJlIGFkZGVkIHRvIHRoZSBhZGFwdGVyIHdoaWNoIGFyZSBwYXNzZWQgd2l0aCBldmVyeSByZXF1ZXN0OgoKICBgYGBqcwogIERTLlJFU1RBZGFwdGVyLnJlb3Blbih7CiAgICBoZWFkZXJzOiB7CiAgICAgICJBUElfS0VZIjogInNlY3JldCBrZXkiLAogICAgICAiQU5PVEhFUl9IRUFERVIiOiAiU29tZSBoZWFkZXIgdmFsdWUiCiAgICB9CiAgfSk7CiAgYGBgCgogIEBjbGFzcyBSRVNUQWRhcHRlcgogIEBjb25zdHJ1Y3RvcgogIEBuYW1lc3BhY2UgRFMKICBAZXh0ZW5kcyBEUy5BZGFwdGVyCiovCkRTLlJFU1RBZGFwdGVyID0gRFMuQWRhcHRlci5leHRlbmQoewogIGRlZmF1bHRTZXJpYWxpemVyOiAnX3Jlc3QnLAoKCiAgLyoqCiAgICBFbmRwb2ludCBwYXRocyBjYW4gYmUgcHJlZml4ZWQgd2l0aCBhIGBuYW1lc3BhY2VgIGJ5IHNldHRpbmcgdGhlIG5hbWVzcGFjZQogICAgcHJvcGVydHkgb24gdGhlIGFkYXB0ZXI6CgogICAgYGBgamF2YXNjcmlwdAogICAgRFMuUkVTVEFkYXB0ZXIucmVvcGVuKHsKICAgICAgbmFtZXNwYWNlOiAnYXBpLzEnCiAgICB9KTsKICAgIGBgYAoKICAgIFJlcXVlc3RzIGZvciBgQXBwLlBvc3RgIHdvdWxkIG5vdyB0YXJnZXQgYC9hcGkvMS9wb3N0L2AuCgogICAgQHByb3BlcnR5IG5hbWVzcGFjZQogICAgQHR5cGUge1N0cmluZ30KICAqLwoKICAvKioKICAgIEFuIGFkYXB0ZXIgY2FuIHRhcmdldCBvdGhlciBob3N0cyBieSBzZXR0aW5nIHRoZSBgaG9zdGAgcHJvcGVydHkuCgogICAgYGBgamF2YXNjcmlwdAogICAgRFMuUkVTVEFkYXB0ZXIucmVvcGVuKHsKICAgICAgaG9zdDogJ2h0dHBzOi8vYXBpLmV4YW1wbGUuY29tJwogICAgfSk7CiAgICBgYGAKCiAgICBSZXF1ZXN0cyBmb3IgYEFwcC5Qb3N0YCB3b3VsZCBub3cgdGFyZ2V0IGBodHRwczovL2FwaS5leGFtcGxlLmNvbS9wb3N0L2AuCgogICAgQHByb3BlcnR5IGhvc3QKICAgIEB0eXBlIHtTdHJpbmd9CiAgKi8KCiAgLyoqCiAgICBTb21lIEFQSXMgcmVxdWlyZSBIVFRQIGhlYWRlcnMsIGUuZy4gdG8gcHJvdmlkZSBhbiBBUEkga2V5LiBBbiBhcnJheSBvZgogICAgaGVhZGVycyBjYW4gYmUgYWRkZWQgdG8gdGhlIGFkYXB0ZXIgd2hpY2ggYXJlIHBhc3NlZCB3aXRoIGV2ZXJ5IHJlcXVlc3Q6CgogICAgYGBgamF2YXNjcmlwdAogICAgRFMuUkVTVEFkYXB0ZXIucmVvcGVuKHsKICAgICAgaGVhZGVyczogewogICAgICAgICJBUElfS0VZIjogInNlY3JldCBrZXkiLAogICAgICAgICJBTk9USEVSX0hFQURFUiI6ICJTb21lIGhlYWRlciB2YWx1ZSIKICAgICAgfQogICAgfSk7CiAgICBgYGAKCiAgICBAcHJvcGVydHkgaGVhZGVycwogICAgQHR5cGUge09iamVjdH0KICAqLwoKICAvKioKICAgIENhbGxlZCBieSB0aGUgc3RvcmUgaW4gb3JkZXIgdG8gZmV0Y2ggdGhlIEpTT04gZm9yIGEgZ2l2ZW4KICAgIHR5cGUgYW5kIElELgoKICAgIFRoZSBgZmluZGAgbWV0aG9kIG1ha2VzIGFuIEFqYXggcmVxdWVzdCB0byBhIFVSTCBjb21wdXRlZCBieSBgYnVpbGRVUkxgLCBhbmQgcmV0dXJucyBhCiAgICBwcm9taXNlIGZvciB0aGUgcmVzdWx0aW5nIHBheWxvYWQuCgogICAgVGhpcyBtZXRob2QgcGVyZm9ybXMgYW4gSFRUUCBgR0VUYCByZXF1ZXN0IHdpdGggdGhlIGlkIHByb3ZpZGVkIGFzIHBhcnQgb2YgdGhlIHF1ZXJ5c3RyaW5nLgoKICAgIEBtZXRob2QgZmluZAogICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgIEBwYXJhbSB7c3ViY2xhc3Mgb2YgRFMuTW9kZWx9IHR5cGUKICAgIEBwYXJhbSB7U3RyaW5nfSBpZAogICAgQHJldHVybnMge1Byb21pc2V9IHByb21pc2UKICAqLwogIGZpbmQ6IGZ1bmN0aW9uKHN0b3JlLCB0eXBlLCBpZCkgewogICAgcmV0dXJuIHRoaXMuYWpheCh0aGlzLmJ1aWxkVVJMKHR5cGUudHlwZUtleSwgaWQpLCAnR0VUJyk7CiAgfSwKCiAgLyoqCiAgICBDYWxsZWQgYnkgdGhlIHN0b3JlIGluIG9yZGVyIHRvIGZldGNoIGEgSlNPTiBhcnJheSBmb3IgYWxsCiAgICBvZiB0aGUgcmVjb3JkcyBmb3IgYSBnaXZlbiB0eXBlLgoKICAgIFRoZSBgZmluZEFsbGAgbWV0aG9kIG1ha2VzIGFuIEFqYXggKEhUVFAgR0VUKSByZXF1ZXN0IHRvIGEgVVJMIGNvbXB1dGVkIGJ5IGBidWlsZFVSTGAsIGFuZCByZXR1cm5zIGEKICAgIHByb21pc2UgZm9yIHRoZSByZXN1bHRpbmcgcGF5bG9hZC4KCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBmaW5kQWxsCiAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgQHBhcmFtIHtzdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHBhcmFtIHtTdHJpbmd9IHNpbmNlVG9rZW4KICAgIEByZXR1cm5zIHtQcm9taXNlfSBwcm9taXNlCiAgKi8KICBmaW5kQWxsOiBmdW5jdGlvbihzdG9yZSwgdHlwZSwgc2luY2VUb2tlbikgewogICAgdmFyIHF1ZXJ5OwoKICAgIGlmIChzaW5jZVRva2VuKSB7CiAgICAgIHF1ZXJ5ID0geyBzaW5jZTogc2luY2VUb2tlbiB9OwogICAgfQoKICAgIHJldHVybiB0aGlzLmFqYXgodGhpcy5idWlsZFVSTCh0eXBlLnR5cGVLZXkpLCAnR0VUJywgeyBkYXRhOiBxdWVyeSB9KTsKICB9LAoKICAvKioKICAgIENhbGxlZCBieSB0aGUgc3RvcmUgaW4gb3JkZXIgdG8gZmV0Y2ggYSBKU09OIGFycmF5IGZvcgogICAgdGhlIHJlY29yZHMgdGhhdCBtYXRjaCBhIHBhcnRpY3VsYXIgcXVlcnkuCgogICAgVGhlIGBmaW5kUXVlcnlgIG1ldGhvZCBtYWtlcyBhbiBBamF4IChIVFRQIEdFVCkgcmVxdWVzdCB0byBhIFVSTCBjb21wdXRlZCBieSBgYnVpbGRVUkxgLCBhbmQgcmV0dXJucyBhCiAgICBwcm9taXNlIGZvciB0aGUgcmVzdWx0aW5nIHBheWxvYWQuCgogICAgVGhlIGBxdWVyeWAgYXJndW1lbnQgaXMgYSBzaW1wbGUgSmF2YVNjcmlwdCBvYmplY3QgdGhhdCB3aWxsIGJlIHBhc3NlZCBkaXJlY3RseQogICAgdG8gdGhlIHNlcnZlciBhcyBwYXJhbWV0ZXJzLgoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIGZpbmRRdWVyeQogICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgIEBwYXJhbSB7c3ViY2xhc3Mgb2YgRFMuTW9kZWx9IHR5cGUKICAgIEBwYXJhbSB7T2JqZWN0fSBxdWVyeQogICAgQHJldHVybnMge1Byb21pc2V9IHByb21pc2UKICAqLwogIGZpbmRRdWVyeTogZnVuY3Rpb24oc3RvcmUsIHR5cGUsIHF1ZXJ5KSB7CiAgICByZXR1cm4gdGhpcy5hamF4KHRoaXMuYnVpbGRVUkwodHlwZS50eXBlS2V5KSwgJ0dFVCcsIHsgZGF0YTogcXVlcnkgfSk7CiAgfSwKCiAgLyoqCiAgICBDYWxsZWQgYnkgdGhlIHN0b3JlIGluIG9yZGVyIHRvIGZldGNoIGEgSlNPTiBhcnJheSBmb3IKICAgIHRoZSB1bmxvYWRlZCByZWNvcmRzIGluIGEgaGFzLW1hbnkgcmVsYXRpb25zaGlwIHRoYXQgd2VyZSBvcmlnaW5hbGx5CiAgICBzcGVjaWZpZWQgYXMgSURzLgoKICAgIEZvciBleGFtcGxlLCBpZiB0aGUgb3JpZ2luYWwgcGF5bG9hZCBsb29rcyBsaWtlOgoKICAgIGBgYGpzCiAgICB7CiAgICAgICJpZCI6IDEsCiAgICAgICJ0aXRsZSI6ICJSYWlscyBpcyBvbWFrYXNlIiwKICAgICAgImNvbW1lbnRzIjogWyAxLCAyLCAzIF0KICAgIH0KICAgIGBgYAoKICAgIFRoZSBJRHMgd2lsbCBiZSBwYXNzZWQgYXMgYSBVUkwtZW5jb2RlZCBBcnJheSBvZiBJRHMsIGluIHRoaXMgZm9ybToKCiAgICBgYGAKICAgIGlkc1tdPTEmaWRzW109MiZpZHNbXT0zCiAgICBgYGAKCiAgICBNYW55IHNlcnZlcnMsIHN1Y2ggYXMgUmFpbHMgYW5kIFBIUCwgd2lsbCBhdXRvbWF0aWNhbGx5IGNvbnZlcnQgdGhpcyBVUkwtZW5jb2RlZCBhcnJheQogICAgaW50byBhbiBBcnJheSBmb3IgeW91IG9uIHRoZSBzZXJ2ZXItc2lkZS4gSWYgeW91IHdhbnQgdG8gZW5jb2RlIHRoZQogICAgSURzLCBkaWZmZXJlbnRseSwganVzdCBvdmVycmlkZSB0aGlzIChvbmUtbGluZSkgbWV0aG9kLgoKICAgIFRoZSBgZmluZE1hbnlgIG1ldGhvZCBtYWtlcyBhbiBBamF4IChIVFRQIEdFVCkgcmVxdWVzdCB0byBhIFVSTCBjb21wdXRlZCBieSBgYnVpbGRVUkxgLCBhbmQgcmV0dXJucyBhCiAgICBwcm9taXNlIGZvciB0aGUgcmVzdWx0aW5nIHBheWxvYWQuCgogICAgQG1ldGhvZCBmaW5kTWFueQogICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgIEBwYXJhbSB7c3ViY2xhc3Mgb2YgRFMuTW9kZWx9IHR5cGUKICAgIEBwYXJhbSB7QXJyYXl9IGlkcwogICAgQHJldHVybnMge1Byb21pc2V9IHByb21pc2UKICAqLwogIGZpbmRNYW55OiBmdW5jdGlvbihzdG9yZSwgdHlwZSwgaWRzKSB7CiAgICByZXR1cm4gdGhpcy5hamF4KHRoaXMuYnVpbGRVUkwodHlwZS50eXBlS2V5KSwgJ0dFVCcsIHsgZGF0YTogeyBpZHM6IGlkcyB9IH0pOwogIH0sCgogIC8qKgogICAgQ2FsbGVkIGJ5IHRoZSBzdG9yZSBpbiBvcmRlciB0byBmZXRjaCBhIEpTT04gYXJyYXkgZm9yCiAgICB0aGUgdW5sb2FkZWQgcmVjb3JkcyBpbiBhIGhhcy1tYW55IHJlbGF0aW9uc2hpcCB0aGF0IHdlcmUgb3JpZ2luYWxseQogICAgc3BlY2lmaWVkIGFzIGEgVVJMIChpbnNpZGUgb2YgYGxpbmtzYCkuCgogICAgRm9yIGV4YW1wbGUsIGlmIHlvdXIgb3JpZ2luYWwgcGF5bG9hZCBsb29rcyBsaWtlIHRoaXM6CgogICAgYGBganMKICAgIHsKICAgICAgInBvc3QiOiB7CiAgICAgICAgImlkIjogMSwKICAgICAgICAidGl0bGUiOiAiUmFpbHMgaXMgb21ha2FzZSIsCiAgICAgICAgImxpbmtzIjogeyAiY29tbWVudHMiOiAiL3Bvc3RzLzEvY29tbWVudHMiIH0KICAgICAgfQogICAgfQogICAgYGBgCgogICAgVGhpcyBtZXRob2Qgd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGUgcGFyZW50IHJlY29yZCBhbmQgYC9wb3N0cy8xL2NvbW1lbnRzYC4KCiAgICBUaGUgYGZpbmRIYXNNYW55YCBtZXRob2Qgd2lsbCBtYWtlIGFuIEFqYXggKEhUVFAgR0VUKSByZXF1ZXN0IHRvIHRoZSBvcmlnaW5hbGx5IHNwZWNpZmllZCBVUkwuCiAgICBJZiB0aGUgVVJMIGlzIGhvc3QtcmVsYXRpdmUgKHN0YXJ0aW5nIHdpdGggYSBzaW5nbGUgc2xhc2gpLCB0aGUKICAgIHJlcXVlc3Qgd2lsbCB1c2UgdGhlIGhvc3Qgc3BlY2lmaWVkIG9uIHRoZSBhZGFwdGVyIChpZiBhbnkpLgoKICAgIEBtZXRob2QgZmluZEhhc01hbnkKICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICBAcGFyYW0ge0RTLk1vZGVsfSByZWNvcmQKICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwKICAgIEByZXR1cm5zIHtQcm9taXNlfSBwcm9taXNlCiAgKi8KICBmaW5kSGFzTWFueTogZnVuY3Rpb24oc3RvcmUsIHJlY29yZCwgdXJsKSB7CiAgICB2YXIgaG9zdCA9IGdldCh0aGlzLCAnaG9zdCcpLAogICAgICAgIGlkICAgPSBnZXQocmVjb3JkLCAnaWQnKSwKICAgICAgICB0eXBlID0gcmVjb3JkLmNvbnN0cnVjdG9yLnR5cGVLZXk7CgogICAgaWYgKGhvc3QgJiYgdXJsLmNoYXJBdCgwKSA9PT0gJy8nICYmIHVybC5jaGFyQXQoMSkgIT09ICcvJykgewogICAgICB1cmwgPSBob3N0ICsgdXJsOwogICAgfQoKICAgIHJldHVybiB0aGlzLmFqYXgodGhpcy51cmxQcmVmaXgodXJsLCB0aGlzLmJ1aWxkVVJMKHR5cGUsIGlkKSksICdHRVQnKTsKICB9LAoKICAvKioKICAgIENhbGxlZCBieSB0aGUgc3RvcmUgaW4gb3JkZXIgdG8gZmV0Y2ggYSBKU09OIGFycmF5IGZvcgogICAgdGhlIHVubG9hZGVkIHJlY29yZHMgaW4gYSBiZWxvbmdzLXRvIHJlbGF0aW9uc2hpcCB0aGF0IHdlcmUgb3JpZ2luYWxseQogICAgc3BlY2lmaWVkIGFzIGEgVVJMIChpbnNpZGUgb2YgYGxpbmtzYCkuCgogICAgRm9yIGV4YW1wbGUsIGlmIHlvdXIgb3JpZ2luYWwgcGF5bG9hZCBsb29rcyBsaWtlIHRoaXM6CgogICAgYGBganMKICAgIHsKICAgICAgInBlcnNvbiI6IHsKICAgICAgICAiaWQiOiAxLAogICAgICAgICJuYW1lIjogIlRvbSBEYWxlIiwKICAgICAgICAibGlua3MiOiB7ICJncm91cCI6ICIvcGVvcGxlLzEvZ3JvdXAiIH0KICAgICAgfQogICAgfQogICAgYGBgCgogICAgVGhpcyBtZXRob2Qgd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGUgcGFyZW50IHJlY29yZCBhbmQgYC9wZW9wbGUvMS9ncm91cGAuCgogICAgVGhlIGBmaW5kQmVsb25nc1RvYCBtZXRob2Qgd2lsbCBtYWtlIGFuIEFqYXggKEhUVFAgR0VUKSByZXF1ZXN0IHRvIHRoZSBvcmlnaW5hbGx5IHNwZWNpZmllZCBVUkwuCgogICAgQG1ldGhvZCBmaW5kQmVsb25nc1RvCiAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgQHBhcmFtIHtEUy5Nb2RlbH0gcmVjb3JkCiAgICBAcGFyYW0ge1N0cmluZ30gdXJsCiAgICBAcmV0dXJucyB7UHJvbWlzZX0gcHJvbWlzZQogICovCiAgZmluZEJlbG9uZ3NUbzogZnVuY3Rpb24oc3RvcmUsIHJlY29yZCwgdXJsKSB7CiAgICB2YXIgaWQgICA9IGdldChyZWNvcmQsICdpZCcpLAogICAgICAgIHR5cGUgPSByZWNvcmQuY29uc3RydWN0b3IudHlwZUtleTsKCiAgICByZXR1cm4gdGhpcy5hamF4KHRoaXMudXJsUHJlZml4KHVybCwgdGhpcy5idWlsZFVSTCh0eXBlLCBpZCkpLCAnR0VUJyk7CiAgfSwKCiAgLyoqCiAgICBDYWxsZWQgYnkgdGhlIHN0b3JlIHdoZW4gYSBuZXdseSBjcmVhdGVkIHJlY29yZCBpcwogICAgc2F2ZWQgdmlhIHRoZSBgc2F2ZWAgbWV0aG9kIG9uIGEgbW9kZWwgcmVjb3JkIGluc3RhbmNlLgoKICAgIFRoZSBgY3JlYXRlUmVjb3JkYCBtZXRob2Qgc2VyaWFsaXplcyB0aGUgcmVjb3JkIGFuZCBtYWtlcyBhbiBBamF4IChIVFRQIFBPU1QpIHJlcXVlc3QKICAgIHRvIGEgVVJMIGNvbXB1dGVkIGJ5IGBidWlsZFVSTGAuCgogICAgU2VlIGBzZXJpYWxpemVgIGZvciBpbmZvcm1hdGlvbiBvbiBob3cgdG8gY3VzdG9taXplIHRoZSBzZXJpYWxpemVkIGZvcm0KICAgIG9mIGEgcmVjb3JkLgoKICAgIEBtZXRob2QgY3JlYXRlUmVjb3JkCiAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgQHBhcmFtIHtzdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHBhcmFtIHtEUy5Nb2RlbH0gcmVjb3JkCiAgICBAcmV0dXJucyB7UHJvbWlzZX0gcHJvbWlzZQogICovCiAgY3JlYXRlUmVjb3JkOiBmdW5jdGlvbihzdG9yZSwgdHlwZSwgcmVjb3JkKSB7CiAgICB2YXIgZGF0YSA9IHt9OwogICAgdmFyIHNlcmlhbGl6ZXIgPSBzdG9yZS5zZXJpYWxpemVyRm9yKHR5cGUudHlwZUtleSk7CgogICAgc2VyaWFsaXplci5zZXJpYWxpemVJbnRvSGFzaChkYXRhLCB0eXBlLCByZWNvcmQsIHsgaW5jbHVkZUlkOiB0cnVlIH0pOwoKICAgIHJldHVybiB0aGlzLmFqYXgodGhpcy5idWlsZFVSTCh0eXBlLnR5cGVLZXkpLCAiUE9TVCIsIHsgZGF0YTogZGF0YSB9KTsKICB9LAoKICAvKioKICAgIENhbGxlZCBieSB0aGUgc3RvcmUgd2hlbiBhbiBleGlzdGluZyByZWNvcmQgaXMgc2F2ZWQKICAgIHZpYSB0aGUgYHNhdmVgIG1ldGhvZCBvbiBhIG1vZGVsIHJlY29yZCBpbnN0YW5jZS4KCiAgICBUaGUgYHVwZGF0ZVJlY29yZGAgbWV0aG9kIHNlcmlhbGl6ZXMgdGhlIHJlY29yZCBhbmQgbWFrZXMgYW4gQWpheCAoSFRUUCBQVVQpIHJlcXVlc3QKICAgIHRvIGEgVVJMIGNvbXB1dGVkIGJ5IGBidWlsZFVSTGAuCgogICAgU2VlIGBzZXJpYWxpemVgIGZvciBpbmZvcm1hdGlvbiBvbiBob3cgdG8gY3VzdG9taXplIHRoZSBzZXJpYWxpemVkIGZvcm0KICAgIG9mIGEgcmVjb3JkLgoKICAgIEBtZXRob2QgdXBkYXRlUmVjb3JkCiAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgQHBhcmFtIHtzdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHBhcmFtIHtEUy5Nb2RlbH0gcmVjb3JkCiAgICBAcmV0dXJucyB7UHJvbWlzZX0gcHJvbWlzZQogICovCiAgdXBkYXRlUmVjb3JkOiBmdW5jdGlvbihzdG9yZSwgdHlwZSwgcmVjb3JkKSB7CiAgICB2YXIgZGF0YSA9IHt9OwogICAgdmFyIHNlcmlhbGl6ZXIgPSBzdG9yZS5zZXJpYWxpemVyRm9yKHR5cGUudHlwZUtleSk7CgogICAgc2VyaWFsaXplci5zZXJpYWxpemVJbnRvSGFzaChkYXRhLCB0eXBlLCByZWNvcmQpOwoKICAgIHZhciBpZCA9IGdldChyZWNvcmQsICdpZCcpOwoKICAgIHJldHVybiB0aGlzLmFqYXgodGhpcy5idWlsZFVSTCh0eXBlLnR5cGVLZXksIGlkKSwgIlBVVCIsIHsgZGF0YTogZGF0YSB9KTsKICB9LAoKICAvKioKICAgIENhbGxlZCBieSB0aGUgc3RvcmUgd2hlbiBhIHJlY29yZCBpcyBkZWxldGVkLgoKICAgIFRoZSBgZGVsZXRlUmVjb3JkYCBtZXRob2QgIG1ha2VzIGFuIEFqYXggKEhUVFAgREVMRVRFKSByZXF1ZXN0IHRvIGEgVVJMIGNvbXB1dGVkIGJ5IGBidWlsZFVSTGAuCgogICAgQG1ldGhvZCBkZWxldGVSZWNvcmQKICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICBAcGFyYW0ge3N1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgICBAcGFyYW0ge0RTLk1vZGVsfSByZWNvcmQKICAgIEByZXR1cm5zIHtQcm9taXNlfSBwcm9taXNlCiAgKi8KICBkZWxldGVSZWNvcmQ6IGZ1bmN0aW9uKHN0b3JlLCB0eXBlLCByZWNvcmQpIHsKICAgIHZhciBpZCA9IGdldChyZWNvcmQsICdpZCcpOwoKICAgIHJldHVybiB0aGlzLmFqYXgodGhpcy5idWlsZFVSTCh0eXBlLnR5cGVLZXksIGlkKSwgIkRFTEVURSIpOwogIH0sCgogIC8qKgogICAgQnVpbGRzIGEgVVJMIGZvciBhIGdpdmVuIHR5cGUgYW5kIG9wdGlvbmFsIElELgoKICAgIEJ5IGRlZmF1bHQsIGl0IHBsdXJhbGl6ZXMgdGhlIHR5cGUncyBuYW1lIChmb3IgZXhhbXBsZSwgJ3Bvc3QnCiAgICBiZWNvbWVzICdwb3N0cycgYW5kICdwZXJzb24nIGJlY29tZXMgJ3Blb3BsZScpLiBUbyBvdmVycmlkZSB0aGUKICAgIHBsdXJhbGl6YXRpb24gc2VlIFtwYXRoRm9yVHlwZV0oI21ldGhvZF9wYXRoRm9yVHlwZSkuCgogICAgSWYgYW4gSUQgaXMgc3BlY2lmaWVkLCBpdCBhZGRzIHRoZSBJRCB0byB0aGUgcGF0aCBnZW5lcmF0ZWQKICAgIGZvciB0aGUgdHlwZSwgc2VwYXJhdGVkIGJ5IGEgYC9gLgoKICAgIEBtZXRob2QgYnVpbGRVUkwKICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlCiAgICBAcGFyYW0ge1N0cmluZ30gaWQKICAgIEByZXR1cm5zIHtTdHJpbmd9IHVybAogICovCiAgYnVpbGRVUkw6IGZ1bmN0aW9uKHR5cGUsIGlkKSB7CiAgICB2YXIgdXJsID0gW10sCiAgICAgICAgaG9zdCA9IGdldCh0aGlzLCAnaG9zdCcpLAogICAgICAgIHByZWZpeCA9IHRoaXMudXJsUHJlZml4KCk7CgogICAgaWYgKHR5cGUpIHsgdXJsLnB1c2godGhpcy5wYXRoRm9yVHlwZSh0eXBlKSk7IH0KICAgIGlmIChpZCkgeyB1cmwucHVzaChpZCk7IH0KCiAgICBpZiAocHJlZml4KSB7IHVybC51bnNoaWZ0KHByZWZpeCk7IH0KCiAgICB1cmwgPSB1cmwuam9pbignLycpOwogICAgaWYgKCFob3N0ICYmIHVybCkgeyB1cmwgPSAnLycgKyB1cmw7IH0KCiAgICByZXR1cm4gdXJsOwogIH0sCgogIC8qKgogICAgQG1ldGhvZCB1cmxQcmVmaXgKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1N0cmluZ30gcGF0aAogICAgQHBhcmFtIHtTdHJpbmd9IHBhcmVudFVybAogICAgQHJldHVybiB7U3RyaW5nfSB1cmxQcmVmaXgKICAqLwogIHVybFByZWZpeDogZnVuY3Rpb24ocGF0aCwgcGFyZW50VVJMKSB7CiAgICB2YXIgaG9zdCA9IGdldCh0aGlzLCAnaG9zdCcpLAogICAgICAgIG5hbWVzcGFjZSA9IGdldCh0aGlzLCAnbmFtZXNwYWNlJyksCiAgICAgICAgdXJsID0gW107CgogICAgaWYgKHBhdGgpIHsKICAgICAgLy8gQWJzb2x1dGUgcGF0aAogICAgICBpZiAocGF0aC5jaGFyQXQoMCkgPT09ICcvJykgewogICAgICAgIGlmIChob3N0KSB7CiAgICAgICAgICBwYXRoID0gcGF0aC5zbGljZSgxKTsKICAgICAgICAgIHVybC5wdXNoKGhvc3QpOwogICAgICAgIH0KICAgICAgLy8gUmVsYXRpdmUgcGF0aAogICAgICB9IGVsc2UgaWYgKCEvXmh0dHAocyk/OlwvXC8vLnRlc3QocGF0aCkpIHsKICAgICAgICB1cmwucHVzaChwYXJlbnRVUkwpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoaG9zdCkgeyB1cmwucHVzaChob3N0KTsgfQogICAgICBpZiAobmFtZXNwYWNlKSB7IHVybC5wdXNoKG5hbWVzcGFjZSk7IH0KICAgIH0KCiAgICBpZiAocGF0aCkgewogICAgICB1cmwucHVzaChwYXRoKTsKICAgIH0KCiAgICByZXR1cm4gdXJsLmpvaW4oJy8nKTsKICB9LAoKICAvKioKICAgIERldGVybWluZXMgdGhlIHBhdGhuYW1lIGZvciBhIGdpdmVuIHR5cGUuCgogICAgQnkgZGVmYXVsdCwgaXQgcGx1cmFsaXplcyB0aGUgdHlwZSdzIG5hbWUgKGZvciBleGFtcGxlLAogICAgJ3Bvc3QnIGJlY29tZXMgJ3Bvc3RzJyBhbmQgJ3BlcnNvbicgYmVjb21lcyAncGVvcGxlJykuCgogICAgIyMjIFBhdGhuYW1lIGN1c3RvbWl6YXRpb24KCiAgICBGb3IgZXhhbXBsZSBpZiB5b3UgaGF2ZSBhbiBvYmplY3QgTGluZUl0ZW0gd2l0aCBhbgogICAgZW5kcG9pbnQgb2YgIi9saW5lX2l0ZW1zLyIuCgogICAgYGBganMKICAgIERTLlJFU1RBZGFwdGVyLnJlb3Blbih7CiAgICAgIHBhdGhGb3JUeXBlOiBmdW5jdGlvbih0eXBlKSB7CiAgICAgICAgdmFyIGRlY2FtZWxpemVkID0gRW1iZXIuU3RyaW5nLmRlY2FtZWxpemUodHlwZSk7CiAgICAgICAgcmV0dXJuIEVtYmVyLlN0cmluZy5wbHVyYWxpemUoZGVjYW1lbGl6ZWQpOwogICAgICB9OwogICAgfSk7CiAgICBgYGAKCiAgICBAbWV0aG9kIHBhdGhGb3JUeXBlCiAgICBAcGFyYW0ge1N0cmluZ30gdHlwZQogICAgQHJldHVybnMge1N0cmluZ30gcGF0aAogICoqLwogIHBhdGhGb3JUeXBlOiBmdW5jdGlvbih0eXBlKSB7CiAgICByZXR1cm4gRW1iZXIuU3RyaW5nLnBsdXJhbGl6ZSh0eXBlKTsKICB9LAoKICAvKioKICAgIFRha2VzIGFuIGFqYXggcmVzcG9uc2UsIGFuZCByZXR1cm5zIGEgcmVsYXZhbnQgZXJyb3IuCgogICAgUmV0dXJuaW5nIGEgYERTLkludmFsaWRFcnJvcmAgZnJvbSB0aGlzIG1ldGhvZCB3aWxsIGNhdXNlIHRoZQogICAgcmVjb3JkIHRvIHRyYW5zaXRpb24gaW50byB0aGUgYGludmFsaWRgIHN0YXRlIGFuZCBtYWtlIHRoZQogICAgYGVycm9yc2Agb2JqZWN0IGF2YWlsYWJsZSBvbiB0aGUgcmVjb3JkLgoKICAgIGBgYGphdmFzY3JpcHQKICAgIEFwcC5BcHBsaWNhdGlvbkFkYXB0ZXIgPSBEUy5SRVNUQWRhcHRlci5leHRlbmQoewogICAgICBhamF4RXJyb3I6IGZ1bmN0aW9uKGpxWEhSKSB7CiAgICAgICAgdmFyIGVycm9yID0gdGhpcy5fc3VwZXIoanFYSFIpOwoKICAgICAgICBpZiAoanFYSFIgJiYganFYSFIuc3RhdHVzID09PSA0MjIpIHsKICAgICAgICAgIHZhciBqc29uRXJyb3JzID0gRW1iZXIuJC5wYXJzZUpTT04oanFYSFIucmVzcG9uc2VUZXh0KVsiZXJyb3JzIl07CgogICAgICAgICAgcmV0dXJuIG5ldyBEUy5JbnZhbGlkRXJyb3IoanNvbkVycm9ycyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBlcnJvcjsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgTm90ZTogQXMgYSBjb3JyZWN0bmVzcyBvcHRpbWl6YXRpb24sIHRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIG9mCiAgICB0aGUgYGFqYXhFcnJvcmAgbWV0aG9kIHN0cmlwcyBvdXQgdGhlIGB0aGVuYCBtZXRob2QgZnJvbSBqcXVlcnkncwogICAgYWpheCByZXNwb25zZSAoanFYSFIpLiBUaGlzIGlzIGltcG9ydGFudCBiZWNhdXNlIHRoZSBqcVhIUidzCiAgICBgdGhlbmAgbWV0aG9kIGZ1bGZpbGxzIHRoZSBwcm9taXNlIHdpdGggaXRzZWxmIHJlc3VsdGluZyBpbiBhCiAgICBjaXJjdWxhciAidGhlbmFibGUiIGNoYWluIHdoaWNoIG1heSBjYXVzZSBwcm9ibGVtcyBmb3Igc29tZQogICAgcHJvbWlzZSBsaWJyYXJpZXMuCgogICAgQG1ldGhvZCBhamF4RXJyb3IKICAgIEBwYXJhbSAge09iamVjdH0ganFYSFIKICAgIEByZXR1cm4ge09iamVjdH0ganFYSFIKICAqLwogIGFqYXhFcnJvcjogZnVuY3Rpb24oanFYSFIpIHsKICAgIGlmIChqcVhIUikgewogICAgICBqcVhIUi50aGVuID0gbnVsbDsKICAgIH0KCiAgICByZXR1cm4ganFYSFI7CiAgfSwKCiAgLyoqCiAgICBUYWtlcyBhIFVSTCwgYW4gSFRUUCBtZXRob2QgYW5kIGEgaGFzaCBvZiBkYXRhLCBhbmQgbWFrZXMgYW4KICAgIEhUVFAgcmVxdWVzdC4KCiAgICBXaGVuIHRoZSBzZXJ2ZXIgcmVzcG9uZHMgd2l0aCBhIHBheWxvYWQsIEVtYmVyIERhdGEgd2lsbCBjYWxsIGludG8gYGV4dHJhY3RTaW5nbGVgCiAgICBvciBgZXh0cmFjdEFycmF5YCAoZGVwZW5kaW5nIG9uIHdoZXRoZXIgdGhlIG9yaWdpbmFsIHF1ZXJ5IHdhcyBmb3Igb25lIHJlY29yZCBvcgogICAgbWFueSByZWNvcmRzKS4KCiAgICBCeSBkZWZhdWx0LCBgYWpheGAgbWV0aG9kIGhhcyB0aGUgZm9sbG93aW5nIGJlaGF2aW9yOgoKICAgICogSXQgc2V0cyB0aGUgcmVzcG9uc2UgYGRhdGFUeXBlYCB0byBgImpzb24iYAogICAgKiBJZiB0aGUgSFRUUCBtZXRob2QgaXMgbm90IGAiR0VUImAsIGl0IHNldHMgdGhlIGBDb250ZW50LVR5cGVgIHRvIGJlCiAgICAgIGBhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PXV0Zi04YAogICAgKiBJZiB0aGUgSFRUUCBtZXRob2QgaXMgbm90IGAiR0VUImAsIGl0IHN0cmluZ2lmaWVzIHRoZSBkYXRhIHBhc3NlZCBpbi4gVGhlCiAgICAgIGRhdGEgaXMgdGhlIHNlcmlhbGl6ZWQgcmVjb3JkIGluIHRoZSBjYXNlIG9mIGEgc2F2ZS4KICAgICogUmVnaXN0ZXJzIHN1Y2Nlc3MgYW5kIGZhaWx1cmUgaGFuZGxlcnMuCgogICAgQG1ldGhvZCBhamF4CiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtTdHJpbmd9IHVybAogICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHJlcXVlc3QgdHlwZSBHRVQsIFBPU1QsIFBVVCwgREVMRVRFIGVjdC4KICAgIEBwYXJhbSB7T2JqZWN0fSBoYXNoCiAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlCiAgKi8KICBhamF4OiBmdW5jdGlvbih1cmwsIHR5cGUsIGhhc2gpIHsKICAgIHZhciBhZGFwdGVyID0gdGhpczsKCiAgICByZXR1cm4gbmV3IEVtYmVyLlJTVlAuUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgaGFzaCA9IGFkYXB0ZXIuYWpheE9wdGlvbnModXJsLCB0eXBlLCBoYXNoKTsKCiAgICAgIGhhc2guc3VjY2VzcyA9IGZ1bmN0aW9uKGpzb24pIHsKICAgICAgICBFbWJlci5ydW4obnVsbCwgcmVzb2x2ZSwganNvbik7CiAgICAgIH07CgogICAgICBoYXNoLmVycm9yID0gZnVuY3Rpb24oanFYSFIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSB7CiAgICAgICAgRW1iZXIucnVuKG51bGwsIHJlamVjdCwgYWRhcHRlci5hamF4RXJyb3IoanFYSFIpKTsKICAgICAgfTsKCiAgICAgIEVtYmVyLiQuYWpheChoYXNoKTsKICAgIH0sICJEUzogUmVzdEFkYXB0ZXIjYWpheCAiICsgdHlwZSArICIgdG8gIiArIHVybCk7CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIGFqYXhPcHRpb25zCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtTdHJpbmd9IHVybAogICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHJlcXVlc3QgdHlwZSBHRVQsIFBPU1QsIFBVVCwgREVMRVRFIGVjdC4KICAgIEBwYXJhbSB7T2JqZWN0fSBoYXNoCiAgICBAcmV0dXJuIHtPYmplY3R9IGhhc2gKICAqLwogIGFqYXhPcHRpb25zOiBmdW5jdGlvbih1cmwsIHR5cGUsIGhhc2gpIHsKICAgIGhhc2ggPSBoYXNoIHx8IHt9OwogICAgaGFzaC51cmwgPSB1cmw7CiAgICBoYXNoLnR5cGUgPSB0eXBlOwogICAgaGFzaC5kYXRhVHlwZSA9ICdqc29uJzsKICAgIGhhc2guY29udGV4dCA9IHRoaXM7CgogICAgaWYgKGhhc2guZGF0YSAmJiB0eXBlICE9PSAnR0VUJykgewogICAgICBoYXNoLmNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9dXRmLTgnOwogICAgICBoYXNoLmRhdGEgPSBKU09OLnN0cmluZ2lmeShoYXNoLmRhdGEpOwogICAgfQoKICAgIGlmICh0aGlzLmhlYWRlcnMgIT09IHVuZGVmaW5lZCkgewogICAgICB2YXIgaGVhZGVycyA9IHRoaXMuaGVhZGVyczsKICAgICAgaGFzaC5iZWZvcmVTZW5kID0gZnVuY3Rpb24gKHhocikgewogICAgICAgIGZvckVhY2guY2FsbChFbWJlci5rZXlzKGhlYWRlcnMpLCBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGtleSwgaGVhZGVyc1trZXldKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgIH0KCgogICAgcmV0dXJuIGhhc2g7CiAgfQoKfSk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgogIEBtb2R1bGUgZW1iZXItZGF0YQoqLwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewpEUy5Nb2RlbC5yZW9wZW4oewoKICAvKioKICAgIFByb3ZpZGVzIGluZm8gYWJvdXQgdGhlIG1vZGVsIGZvciBkZWJ1Z2dpbmcgcHVycG9zZXMKICAgIGJ5IGdyb3VwaW5nIHRoZSBwcm9wZXJ0aWVzIGludG8gbW9yZSBzZW1hbnRpYyBncm91cHMuCgogICAgTWVhbnQgdG8gYmUgdXNlZCBieSBkZWJ1Z2dpbmcgdG9vbHMgc3VjaCBhcyB0aGUgQ2hyb21lIEVtYmVyIEV4dGVuc2lvbi4KCiAgICAtIEdyb3VwcyBhbGwgYXR0cmlidXRlcyBpbiAiQXR0cmlidXRlcyIgZ3JvdXAuCiAgICAtIEdyb3VwcyBhbGwgYmVsb25nc1RvIHJlbGF0aW9uc2hpcHMgaW4gIkJlbG9uZ3MgVG8iIGdyb3VwLgogICAgLSBHcm91cHMgYWxsIGhhc01hbnkgcmVsYXRpb25zaGlwcyBpbiAiSGFzIE1hbnkiIGdyb3VwLgogICAgLSBHcm91cHMgYWxsIGZsYWdzIGluICJGbGFncyIgZ3JvdXAuCiAgICAtIEZsYWdzIHJlbGF0aW9uc2hpcCBDUHMgYXMgZXhwZW5zaXZlIHByb3BlcnRpZXMuCgogICAgQG1ldGhvZCBfZGVidWdJbmZvCiAgICBAZm9yIERTLk1vZGVsCiAgICBAcHJpdmF0ZQogICovCiAgX2RlYnVnSW5mbzogZnVuY3Rpb24oKSB7CiAgICB2YXIgYXR0cmlidXRlcyA9IFsnaWQnXSwKICAgICAgICByZWxhdGlvbnNoaXBzID0geyBiZWxvbmdzVG86IFtdLCBoYXNNYW55OiBbXSB9LAogICAgICAgIGV4cGVuc2l2ZVByb3BlcnRpZXMgPSBbXTsKCiAgICB0aGlzLmVhY2hBdHRyaWJ1dGUoZnVuY3Rpb24obmFtZSwgbWV0YSkgewogICAgICBhdHRyaWJ1dGVzLnB1c2gobmFtZSk7CiAgICB9LCB0aGlzKTsKCiAgICB0aGlzLmVhY2hSZWxhdGlvbnNoaXAoZnVuY3Rpb24obmFtZSwgcmVsYXRpb25zaGlwKSB7CiAgICAgIHJlbGF0aW9uc2hpcHNbcmVsYXRpb25zaGlwLmtpbmRdLnB1c2gobmFtZSk7CiAgICAgIGV4cGVuc2l2ZVByb3BlcnRpZXMucHVzaChuYW1lKTsKICAgIH0pOwoKICAgIHZhciBncm91cHMgPSBbCiAgICAgIHsKICAgICAgICBuYW1lOiAnQXR0cmlidXRlcycsCiAgICAgICAgcHJvcGVydGllczogYXR0cmlidXRlcywKICAgICAgICBleHBhbmQ6IHRydWUKICAgICAgfSwKICAgICAgewogICAgICAgIG5hbWU6ICdCZWxvbmdzIFRvJywKICAgICAgICBwcm9wZXJ0aWVzOiByZWxhdGlvbnNoaXBzLmJlbG9uZ3NUbywKICAgICAgICBleHBhbmQ6IHRydWUKICAgICAgfSwKICAgICAgewogICAgICAgIG5hbWU6ICdIYXMgTWFueScsCiAgICAgICAgcHJvcGVydGllczogcmVsYXRpb25zaGlwcy5oYXNNYW55LAogICAgICAgIGV4cGFuZDogdHJ1ZQogICAgICB9LAogICAgICB7CiAgICAgICAgbmFtZTogJ0ZsYWdzJywKICAgICAgICBwcm9wZXJ0aWVzOiBbJ2lzTG9hZGVkJywgJ2lzRGlydHknLCAnaXNTYXZpbmcnLCAnaXNEZWxldGVkJywgJ2lzRXJyb3InLCAnaXNOZXcnLCAnaXNWYWxpZCddCiAgICAgIH0KICAgIF07CgogICAgcmV0dXJuIHsKICAgICAgcHJvcGVydHlJbmZvOiB7CiAgICAgICAgLy8gaW5jbHVkZSBhbGwgb3RoZXIgbWl4aW5zIC8gcHJvcGVydGllcyAobm90IGp1c3QgdGhlIGdyb3VwZWQgb25lcykKICAgICAgICBpbmNsdWRlT3RoZXJQcm9wZXJ0aWVzOiB0cnVlLAogICAgICAgIGdyb3VwczogZ3JvdXBzLAogICAgICAgIC8vIGRvbid0IHByZS1jYWxjdWxhdGUgdW5sZXNzIGNhY2hlZAogICAgICAgIGV4cGVuc2l2ZVByb3BlcnRpZXM6IGV4cGVuc2l2ZVByb3BlcnRpZXMKICAgICAgfQogICAgfTsKICB9Cgp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCiAgQG1vZHVsZSBlbWJlci1kYXRhCiovCgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgogIEVtYmVyIERhdGEKCiAgQG1vZHVsZSBlbWJlci1kYXRhCiAgQG1haW4gZW1iZXItZGF0YQoqLwoKfSkoKTsKCihmdW5jdGlvbigpIHsKRW1iZXIuU3RyaW5nLnBsdXJhbGl6ZSA9IGZ1bmN0aW9uKHdvcmQpIHsKICByZXR1cm4gRW1iZXIuSW5mbGVjdG9yLmluZmxlY3Rvci5wbHVyYWxpemUod29yZCk7Cn07CgpFbWJlci5TdHJpbmcuc2luZ3VsYXJpemUgPSBmdW5jdGlvbih3b3JkKSB7CiAgcmV0dXJuIEVtYmVyLkluZmxlY3Rvci5pbmZsZWN0b3Iuc2luZ3VsYXJpemUod29yZCk7Cn07Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7CnZhciBCTEFOS19SRUdFWCA9IC9eXHMqJC87CgpmdW5jdGlvbiBsb2FkVW5jb3VudGFibGUocnVsZXMsIHVuY291bnRhYmxlKSB7CiAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IHVuY291bnRhYmxlLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICBydWxlcy51bmNvdW50YWJsZVt1bmNvdW50YWJsZVtpXS50b0xvd2VyQ2FzZSgpXSA9IHRydWU7CiAgfQp9CgpmdW5jdGlvbiBsb2FkSXJyZWd1bGFyKHJ1bGVzLCBpcnJlZ3VsYXJQYWlycykgewogIHZhciBwYWlyOwoKICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gaXJyZWd1bGFyUGFpcnMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgIHBhaXIgPSBpcnJlZ3VsYXJQYWlyc1tpXTsKCiAgICBydWxlcy5pcnJlZ3VsYXJbcGFpclswXS50b0xvd2VyQ2FzZSgpXSA9IHBhaXJbMV07CiAgICBydWxlcy5pcnJlZ3VsYXJJbnZlcnNlW3BhaXJbMV0udG9Mb3dlckNhc2UoKV0gPSBwYWlyWzBdOwogIH0KfQoKLyoqCiAgSW5mbGVjdG9yLkVtYmVyIHByb3ZpZGVzIGEgbWVjaGFuaXNtIGZvciBzdXBwbHlpbmcgaW5mbGVjdGlvbiBydWxlcyBmb3IgeW91cgogIGFwcGxpY2F0aW9uLiBFbWJlciBpbmNsdWRlcyBhIGRlZmF1bHQgc2V0IG9mIGluZmxlY3Rpb24gcnVsZXMsIGFuZCBwcm92aWRlcyBhbgogIEFQSSBmb3IgcHJvdmlkaW5nIGFkZGl0aW9uYWwgcnVsZXMuCgogIEV4YW1wbGVzOgoKICBDcmVhdGluZyBhbiBpbmZsZWN0b3Igd2l0aCBubyBydWxlcy4KCiAgYGBganMKICB2YXIgaW5mbGVjdG9yID0gbmV3IEVtYmVyLkluZmxlY3RvcigpOwogIGBgYAoKICBDcmVhdGluZyBhbiBpbmZsZWN0b3Igd2l0aCB0aGUgZGVmYXVsdCBlbWJlciBydWxlc2V0LgoKICBgYGBqcwogIHZhciBpbmZsZWN0b3IgPSBuZXcgRW1iZXIuSW5mbGVjdG9yKEVtYmVyLkluZmxlY3Rvci5kZWZhdWx0UnVsZXMpOwoKICBpbmZsZWN0b3IucGx1cmFsaXplKCdjb3cnKSAvLz0+ICdraW5lJwogIGluZmxlY3Rvci5zaW5ndWxhcml6ZSgna2luZScpIC8vPT4gJ2NvdycKICBgYGAKCiAgQ3JlYXRpbmcgYW4gaW5mbGVjdG9yIGFuZCBhZGRpbmcgcnVsZXMgbGF0ZXIuCgogIGBgYGphdmFzY3JpcHQKICB2YXIgaW5mbGVjdG9yID0gRW1iZXIuSW5mbGVjdG9yLmluZmxlY3RvcjsKCiAgaW5mbGVjdG9yLnBsdXJhbGl6ZSgnYWR2aWNlJykgLy8gPT4gJ2FkdmljZXMnCiAgaW5mbGVjdG9yLnVuY291bnRhYmxlKCdhZHZpY2UnKTsKICBpbmZsZWN0b3IucGx1cmFsaXplKCdhZHZpY2UnKSAvLyA9PiAnYWR2aWNlJwoKICBpbmZsZWN0b3IucGx1cmFsaXplKCdmb3JtdWxhJykgLy8gPT4gJ2Zvcm11bGFzJwogIGluZmxlY3Rvci5pcnJlZ3VsYXIoJ2Zvcm11bGEnLCAnZm9ybXVsYWUnKTsKICBpbmZsZWN0b3IucGx1cmFsaXplKCdmb3JtdWxhJykgLy8gPT4gJ2Zvcm11bGFlJwoKICAvLyB5b3Ugd291bGQgbm90IG5lZWQgdG8gYWRkIHRoZXNlIGFzIHRoZXkgYXJlIHRoZSBkZWZhdWx0IHJ1bGVzCiAgaW5mbGVjdG9yLnBsdXJhbCgvJC8sICdzJyk7CiAgaW5mbGVjdG9yLnNpbmd1bGFyKC9zJC9pLCAnJyk7CiAgYGBgCgogIENyZWF0aW5nIGFuIGluZmxlY3RvciB3aXRoIGEgbm9uZGVmYXVsdCBydWxlc2V0LgoKICBgYGBqYXZhc2NyaXB0CiAgdmFyIHJ1bGVzID0gewogICAgcGx1cmFsczogIFsgLyQvLCAncycgXSwKICAgIHNpbmd1bGFyOiBbIC9ccyQvLCAnJyBdLAogICAgaXJyZWd1bGFyUGFpcnM6IFsKICAgICAgWyAnY293JywgJ2tpbmUnIF0KICAgIF0sCiAgICB1bmNvdW50YWJsZTogWyAnZmlzaCcgXQogIH07CgogIHZhciBpbmZsZWN0b3IgPSBuZXcgRW1iZXIuSW5mbGVjdG9yKHJ1bGVzKTsKICBgYGAKCiAgQGNsYXNzIEluZmxlY3RvcgogIEBuYW1lc3BhY2UgRW1iZXIKKi8KZnVuY3Rpb24gSW5mbGVjdG9yKHJ1bGVTZXQpIHsKICBydWxlU2V0ID0gcnVsZVNldCB8fCB7fTsKICBydWxlU2V0LnVuY291bnRhYmxlID0gcnVsZVNldC51bmNvdW50YWJsZSB8fCB7fTsKICBydWxlU2V0LmlycmVndWxhclBhaXJzID0gcnVsZVNldC5pcnJlZ3VsYXJQYWlycyB8fCB7fTsKCiAgdmFyIHJ1bGVzID0gdGhpcy5ydWxlcyA9IHsKICAgIHBsdXJhbHM6ICBydWxlU2V0LnBsdXJhbHMgfHwgW10sCiAgICBzaW5ndWxhcjogcnVsZVNldC5zaW5ndWxhciB8fCBbXSwKICAgIGlycmVndWxhcjoge30sCiAgICBpcnJlZ3VsYXJJbnZlcnNlOiB7fSwKICAgIHVuY291bnRhYmxlOiB7fQogIH07CgogIGxvYWRVbmNvdW50YWJsZShydWxlcywgcnVsZVNldC51bmNvdW50YWJsZSk7CiAgbG9hZElycmVndWxhcihydWxlcywgcnVsZVNldC5pcnJlZ3VsYXJQYWlycyk7Cn0KCkluZmxlY3Rvci5wcm90b3R5cGUgPSB7CiAgLyoqCiAgICBAbWV0aG9kIHBsdXJhbAogICAgQHBhcmFtIHtSZWdFeHB9IHJlZ2V4CiAgICBAcGFyYW0ge1N0cmluZ30gc3RyaW5nCiAgKi8KICBwbHVyYWw6IGZ1bmN0aW9uKHJlZ2V4LCBzdHJpbmcpIHsKICAgIHRoaXMucnVsZXMucGx1cmFscy5wdXNoKFtyZWdleCwgc3RyaW5nLnRvTG93ZXJDYXNlKCldKTsKICB9LAoKICAvKioKICAgIEBtZXRob2Qgc2luZ3VsYXIKICAgIEBwYXJhbSB7UmVnRXhwfSByZWdleAogICAgQHBhcmFtIHtTdHJpbmd9IHN0cmluZwogICovCiAgc2luZ3VsYXI6IGZ1bmN0aW9uKHJlZ2V4LCBzdHJpbmcpIHsKICAgIHRoaXMucnVsZXMuc2luZ3VsYXIucHVzaChbcmVnZXgsIHN0cmluZy50b0xvd2VyQ2FzZSgpXSk7CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIHVuY291bnRhYmxlCiAgICBAcGFyYW0ge1N0cmluZ30gcmVnZXgKICAqLwogIHVuY291bnRhYmxlOiBmdW5jdGlvbihzdHJpbmcpIHsKICAgIGxvYWRVbmNvdW50YWJsZSh0aGlzLnJ1bGVzLCBbc3RyaW5nLnRvTG93ZXJDYXNlKCldKTsKICB9LAoKICAvKioKICAgIEBtZXRob2QgaXJyZWd1bGFyCiAgICBAcGFyYW0ge1N0cmluZ30gc2luZ3VsYXIKICAgIEBwYXJhbSB7U3RyaW5nfSBwbHVyYWwKICAqLwogIGlycmVndWxhcjogZnVuY3Rpb24gKHNpbmd1bGFyLCBwbHVyYWwpIHsKICAgIGxvYWRJcnJlZ3VsYXIodGhpcy5ydWxlcywgW1tzaW5ndWxhciwgcGx1cmFsXV0pOwogIH0sCgogIC8qKgogICAgQG1ldGhvZCBwbHVyYWxpemUKICAgIEBwYXJhbSB7U3RyaW5nfSB3b3JkCiAgKi8KICBwbHVyYWxpemU6IGZ1bmN0aW9uKHdvcmQpIHsKICAgIHJldHVybiB0aGlzLmluZmxlY3Qod29yZCwgdGhpcy5ydWxlcy5wbHVyYWxzLCB0aGlzLnJ1bGVzLmlycmVndWxhcik7CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIHNpbmd1bGFyaXplCiAgICBAcGFyYW0ge1N0cmluZ30gd29yZAogICovCiAgc2luZ3VsYXJpemU6IGZ1bmN0aW9uKHdvcmQpIHsKICAgIHJldHVybiB0aGlzLmluZmxlY3Qod29yZCwgdGhpcy5ydWxlcy5zaW5ndWxhciwgIHRoaXMucnVsZXMuaXJyZWd1bGFySW52ZXJzZSk7CiAgfSwKCiAgLyoqCiAgICBAcHJvdGVjdGVkCgogICAgQG1ldGhvZCBpbmZsZWN0CiAgICBAcGFyYW0ge1N0cmluZ30gd29yZAogICAgQHBhcmFtIHtPYmplY3R9IHR5cGVSdWxlcwogICAgQHBhcmFtIHtPYmplY3R9IGlycmVndWxhcgogICovCiAgaW5mbGVjdDogZnVuY3Rpb24od29yZCwgdHlwZVJ1bGVzLCBpcnJlZ3VsYXIpIHsKICAgIHZhciBpbmZsZWN0aW9uLCBzdWJzdGl0dXRpb24sIHJlc3VsdCwgbG93ZXJjYXNlLCBpc0JsYW5rLAogICAgaXNVbmNvdW50YWJsZSwgaXNJcnJlZ3VsYXIsIGlzSXJyZWd1bGFySW52ZXJzZSwgcnVsZTsKCiAgICBpc0JsYW5rID0gQkxBTktfUkVHRVgudGVzdCh3b3JkKTsKCiAgICBpZiAoaXNCbGFuaykgewogICAgICByZXR1cm4gd29yZDsKICAgIH0KCiAgICBsb3dlcmNhc2UgPSB3b3JkLnRvTG93ZXJDYXNlKCk7CgogICAgaXNVbmNvdW50YWJsZSA9IHRoaXMucnVsZXMudW5jb3VudGFibGVbbG93ZXJjYXNlXTsKCiAgICBpZiAoaXNVbmNvdW50YWJsZSkgewogICAgICByZXR1cm4gd29yZDsKICAgIH0KCiAgICBpc0lycmVndWxhciA9IGlycmVndWxhciAmJiBpcnJlZ3VsYXJbbG93ZXJjYXNlXTsKCiAgICBpZiAoaXNJcnJlZ3VsYXIpIHsKICAgICAgcmV0dXJuIGlzSXJyZWd1bGFyOwogICAgfQoKICAgIGZvciAodmFyIGkgPSB0eXBlUnVsZXMubGVuZ3RoLCBtaW4gPSAwOyBpID4gbWluOyBpLS0pIHsKICAgICAgIGluZmxlY3Rpb24gPSB0eXBlUnVsZXNbaS0xXTsKICAgICAgIHJ1bGUgPSBpbmZsZWN0aW9uWzBdOwoKICAgICAgaWYgKHJ1bGUudGVzdCh3b3JkKSkgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgaW5mbGVjdGlvbiA9IGluZmxlY3Rpb24gfHwgW107CgogICAgcnVsZSA9IGluZmxlY3Rpb25bMF07CiAgICBzdWJzdGl0dXRpb24gPSBpbmZsZWN0aW9uWzFdOwoKICAgIHJlc3VsdCA9IHdvcmQucmVwbGFjZShydWxlLCBzdWJzdGl0dXRpb24pOwoKICAgIHJldHVybiByZXN1bHQ7CiAgfQp9OwoKRW1iZXIuSW5mbGVjdG9yID0gSW5mbGVjdG9yOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewpFbWJlci5JbmZsZWN0b3IuZGVmYXVsdFJ1bGVzID0gewogIHBsdXJhbHM6IFsKICAgIFsvJC8sICdzJ10sCiAgICBbL3MkL2ksICdzJ10sCiAgICBbL14oYXh8dGVzdClpcyQvaSwgJyQxZXMnXSwKICAgIFsvKG9jdG9wfHZpcil1cyQvaSwgJyQxaSddLAogICAgWy8ob2N0b3B8dmlyKWkkL2ksICckMWknXSwKICAgIFsvKGFsaWFzfHN0YXR1cykkL2ksICckMWVzJ10sCiAgICBbLyhidSlzJC9pLCAnJDFzZXMnXSwKICAgIFsvKGJ1ZmZhbHx0b21hdClvJC9pLCAnJDFvZXMnXSwKICAgIFsvKFt0aV0pdW0kL2ksICckMWEnXSwKICAgIFsvKFt0aV0pYSQvaSwgJyQxYSddLAogICAgWy9zaXMkL2ksICdzZXMnXSwKICAgIFsvKD86KFteZl0pZmV8KFtscl0pZikkL2ksICckMSQydmVzJ10sCiAgICBbLyhoaXZlKSQvaSwgJyQxcyddLAogICAgWy8oW15hZWlvdXldfHF1KXkkL2ksICckMWllcyddLAogICAgWy8oeHxjaHxzc3xzaCkkL2ksICckMWVzJ10sCiAgICBbLyhtYXRyfHZlcnR8aW5kKSg/Oml4fGV4KSQvaSwgJyQxaWNlcyddLAogICAgWy9eKG18bClvdXNlJC9pLCAnJDFpY2UnXSwKICAgIFsvXihtfGwpaWNlJC9pLCAnJDFpY2UnXSwKICAgIFsvXihveCkkL2ksICckMWVuJ10sCiAgICBbL14ob3hlbikkL2ksICckMSddLAogICAgWy8ocXVpeikkL2ksICckMXplcyddCiAgXSwKCiAgc2luZ3VsYXI6IFsKICAgIFsvcyQvaSwgJyddLAogICAgWy8oc3MpJC9pLCAnJDEnXSwKICAgIFsvKG4pZXdzJC9pLCAnJDFld3MnXSwKICAgIFsvKFt0aV0pYSQvaSwgJyQxdW0nXSwKICAgIFsvKChhKW5hbHl8KGIpYXwoZClpYWdub3wocClhcmVudGhlfChwKXJvZ25vfChzKXlub3B8KHQpaGUpKHNpc3xzZXMpJC9pLCAnJDFzaXMnXSwKICAgIFsvKF5hbmFseSkoc2lzfHNlcykkL2ksICckMXNpcyddLAogICAgWy8oW15mXSl2ZXMkL2ksICckMWZlJ10sCiAgICBbLyhoaXZlKXMkL2ksICckMSddLAogICAgWy8odGl2ZSlzJC9pLCAnJDEnXSwKICAgIFsvKFtscl0pdmVzJC9pLCAnJDFmJ10sCiAgICBbLyhbXmFlaW91eV18cXUpaWVzJC9pLCAnJDF5J10sCiAgICBbLyhzKWVyaWVzJC9pLCAnJDFlcmllcyddLAogICAgWy8obSlvdmllcyQvaSwgJyQxb3ZpZSddLAogICAgWy8oeHxjaHxzc3xzaCllcyQvaSwgJyQxJ10sCiAgICBbL14obXxsKWljZSQvaSwgJyQxb3VzZSddLAogICAgWy8oYnVzKShlcyk/JC9pLCAnJDEnXSwKICAgIFsvKG8pZXMkL2ksICckMSddLAogICAgWy8oc2hvZSlzJC9pLCAnJDEnXSwKICAgIFsvKGNyaXN8dGVzdCkoaXN8ZXMpJC9pLCAnJDFpcyddLAogICAgWy9eKGEpeFtpZV1zJC9pLCAnJDF4aXMnXSwKICAgIFsvKG9jdG9wfHZpcikodXN8aSkkL2ksICckMXVzJ10sCiAgICBbLyhhbGlhc3xzdGF0dXMpKGVzKT8kL2ksICckMSddLAogICAgWy9eKG94KWVuL2ksICckMSddLAogICAgWy8odmVydHxpbmQpaWNlcyQvaSwgJyQxZXgnXSwKICAgIFsvKG1hdHIpaWNlcyQvaSwgJyQxaXgnXSwKICAgIFsvKHF1aXopemVzJC9pLCAnJDEnXSwKICAgIFsvKGRhdGFiYXNlKXMkL2ksICckMSddCiAgXSwKCiAgaXJyZWd1bGFyUGFpcnM6IFsKICAgIFsncGVyc29uJywgJ3Blb3BsZSddLAogICAgWydtYW4nLCAnbWVuJ10sCiAgICBbJ2NoaWxkJywgJ2NoaWxkcmVuJ10sCiAgICBbJ3NleCcsICdzZXhlcyddLAogICAgWydtb3ZlJywgJ21vdmVzJ10sCiAgICBbJ2NvdycsICdraW5lJ10sCiAgICBbJ3pvbWJpZScsICd6b21iaWVzJ10KICBdLAoKICB1bmNvdW50YWJsZTogWwogICAgJ2VxdWlwbWVudCcsCiAgICAnaW5mb3JtYXRpb24nLAogICAgJ3JpY2UnLAogICAgJ21vbmV5JywKICAgICdzcGVjaWVzJywKICAgICdzZXJpZXMnLAogICAgJ2Zpc2gnLAogICAgJ3NoZWVwJywKICAgICdqZWFucycsCiAgICAncG9saWNlJwogIF0KfTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKaWYgKEVtYmVyLkVYVEVORF9QUk9UT1RZUEVTID09PSB0cnVlIHx8IEVtYmVyLkVYVEVORF9QUk9UT1RZUEVTLlN0cmluZykgewogIC8qKgogICAgU2VlIHt7I2Nyb3NzTGluayAiRW1iZXIuU3RyaW5nL3BsdXJhbGl6ZSJ9fXt7L2Nyb3NzTGlua319CgogICAgQG1ldGhvZCBwbHVyYWxpemUKICAgIEBmb3IgU3RyaW5nCiAgKi8KICBTdHJpbmcucHJvdG90eXBlLnBsdXJhbGl6ZSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIEVtYmVyLlN0cmluZy5wbHVyYWxpemUodGhpcyk7CiAgfTsKCiAgLyoqCiAgICBTZWUge3sjY3Jvc3NMaW5rICJFbWJlci5TdHJpbmcvc2luZ3VsYXJpemUifX17ey9jcm9zc0xpbmt9fQoKICAgIEBtZXRob2Qgc2luZ3VsYXJpemUKICAgIEBmb3IgU3RyaW5nCiAgKi8KICBTdHJpbmcucHJvdG90eXBlLnNpbmd1bGFyaXplID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gRW1iZXIuU3RyaW5nLnNpbmd1bGFyaXplKHRoaXMpOwogIH07Cn0KCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKRW1iZXIuSW5mbGVjdG9yLmluZmxlY3RvciA9IG5ldyBFbWJlci5JbmZsZWN0b3IoRW1iZXIuSW5mbGVjdG9yLmRlZmF1bHRSdWxlcyk7DQoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewoKfSkoKTsKCihmdW5jdGlvbigpIHsKLyoqCiAgQG1vZHVsZSBlbWJlci1kYXRhCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0Owp2YXIgZm9yRWFjaCA9IEVtYmVyLkVudW1lcmFibGVVdGlscy5mb3JFYWNoOwoKRFMuQWN0aXZlTW9kZWxTZXJpYWxpemVyID0gRFMuUkVTVFNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAvLyBTRVJJQUxJWkUKCiAgLyoqCiAgICBDb252ZXJ0cyBjYW1lbGNhc2VkIGF0dHJpYnV0ZXMgdG8gdW5kZXJzY29yZWQgd2hlbiBzZXJpYWxpemluZy4KCiAgICBAbWV0aG9kIGtleUZvckF0dHJpYnV0ZQogICAgQHBhcmFtIHtTdHJpbmd9IGF0dHJpYnV0ZQogICAgQHJldHVybnMgU3RyaW5nCiAgKi8KICBrZXlGb3JBdHRyaWJ1dGU6IGZ1bmN0aW9uKGF0dHIpIHsKICAgIHJldHVybiBFbWJlci5TdHJpbmcuZGVjYW1lbGl6ZShhdHRyKTsKICB9LAoKICAvKioKICAgIFVuZGVyc2NvcmVzIHJlbGF0aW9uc2hpcCBuYW1lcyBhbmQgYXBwZW5kcyAiX2lkIiBvciAiX2lkcyIgd2hlbiBzZXJpYWxpemluZwogICAgcmVsYXRpb25zaGlwIGtleXMuCgogICAgQG1ldGhvZCBrZXlGb3JSZWxhdGlvbnNoaXAKICAgIEBwYXJhbSB7U3RyaW5nfSBrZXkKICAgIEBwYXJhbSB7U3RyaW5nfSBraW5kCiAgICBAcmV0dXJucyBTdHJpbmcKICAqLwogIGtleUZvclJlbGF0aW9uc2hpcDogZnVuY3Rpb24oa2V5LCBraW5kKSB7CiAgICBrZXkgPSBFbWJlci5TdHJpbmcuZGVjYW1lbGl6ZShrZXkpOwogICAgaWYgKGtpbmQgPT09ICJiZWxvbmdzVG8iKSB7CiAgICAgIHJldHVybiBrZXkgKyAiX2lkIjsKICAgIH0gZWxzZSBpZiAoa2luZCA9PT0gImhhc01hbnkiKSB7CiAgICAgIHJldHVybiBFbWJlci5TdHJpbmcuc2luZ3VsYXJpemUoa2V5KSArICJfaWRzIjsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBrZXk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICBEb2VzIG5vdCBzZXJpYWxpemUgaGFzTWFueSByZWxhdGlvbnNoaXBzIGJ5IGRlZmF1bHQuCiAgKi8KICBzZXJpYWxpemVIYXNNYW55OiBFbWJlci5LLAoKICAvKioKICAgIFVuZGVyc2NvcmVzIHRoZSBKU09OIHJvb3Qga2V5cyB3aGVuIHNlcmlhbGl6aW5nLgoKICAgIEBtZXRob2Qgc2VyaWFsaXplSW50b0hhc2gKICAgIEBwYXJhbSB7T2JqZWN0fSBoYXNoCiAgICBAcGFyYW0ge3N1YmNsYXNzIG9mIERTLk1vZGVsfSB0eXBlCiAgICBAcGFyYW0ge0RTLk1vZGVsfSByZWNvcmQKICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgKi8KICBzZXJpYWxpemVJbnRvSGFzaDogZnVuY3Rpb24oZGF0YSwgdHlwZSwgcmVjb3JkLCBvcHRpb25zKSB7CiAgICB2YXIgcm9vdCA9IEVtYmVyLlN0cmluZy5kZWNhbWVsaXplKHR5cGUudHlwZUtleSk7CiAgICBkYXRhW3Jvb3RdID0gdGhpcy5zZXJpYWxpemUocmVjb3JkLCBvcHRpb25zKTsKICB9LAoKICAvKioKICAgIFNlcmlhbGl6ZXMgYSBwb2x5bW9ycGhpYyB0eXBlIGFzIGEgZnVsbHkgY2FwaXRhbGl6ZWQgbW9kZWwgbmFtZS4KCiAgICBAbWV0aG9kIHNlcmlhbGl6ZVBvbHltb3JwaGljVHlwZQogICAgQHBhcmFtIHtEUy5Nb2RlbH0gcmVjb3JkCiAgICBAcGFyYW0ge09iamVjdH0ganNvbgogICAgQHBhcmFtIHJlbGF0aW9uc2hpcAogICovCiAgc2VyaWFsaXplUG9seW1vcnBoaWNUeXBlOiBmdW5jdGlvbihyZWNvcmQsIGpzb24sIHJlbGF0aW9uc2hpcCkgewogICAgdmFyIGtleSA9IHJlbGF0aW9uc2hpcC5rZXksCiAgICAgICAgYmVsb25nc1RvID0gZ2V0KHJlY29yZCwga2V5KTsKICAgIGtleSA9IHRoaXMua2V5Rm9yQXR0cmlidXRlKGtleSk7CiAgICBqc29uW2tleSArICJfdHlwZSJdID0gRW1iZXIuU3RyaW5nLmNhcGl0YWxpemUoYmVsb25nc1RvLmNvbnN0cnVjdG9yLnR5cGVLZXkpOwogIH0sCgogIC8vIEVYVFJBQ1QKCiAgLyoqCiAgICBFeHRyYWN0cyB0aGUgbW9kZWwgdHlwZUtleSBmcm9tIHVuZGVyc2NvcmVkIHJvb3Qgb2JqZWN0cy4KCiAgICBAbWV0aG9kIHR5cGVGb3JSb290CiAgICBAcGFyYW0ge1N0cmluZ30gcm9vdAogICAgQHJldHVybnMgU3RyaW5nIHRoZSBtb2RlbCdzIHR5cGVLZXkKICAqLwogIHR5cGVGb3JSb290OiBmdW5jdGlvbihyb290KSB7CiAgICB2YXIgY2FtZWxpemVkID0gRW1iZXIuU3RyaW5nLmNhbWVsaXplKHJvb3QpOwogICAgcmV0dXJuIEVtYmVyLlN0cmluZy5zaW5ndWxhcml6ZShjYW1lbGl6ZWQpOwogIH0sCgogIC8qKgogICAgQWRkIGV4dHJhIHN0ZXAgdG8gYERTLlJFU1RTZXJpYWxpemVyLm5vcm1hbGl6ZWAgc28gbGlua3MgYXJlCiAgICBub3JtYWxpemVkLgoKICAgIElmIHlvdXIgcGF5bG9hZCBsb29rcyBsaWtlIHRoaXMKCiAgICBgYGBqcwogICAgewogICAgICAicG9zdCI6IHsKICAgICAgICAiaWQiOiAxLAogICAgICAgICJ0aXRsZSI6ICJSYWlscyBpcyBvbWFrYXNlIiwKICAgICAgICAibGlua3MiOiB7ICJmbGFnZ2VkX2NvbW1lbnRzIjogImFwaS9jb21tZW50cy9mbGFnZ2VkIiB9CiAgICAgIH0KICAgIH0KICAgIGBgYAogICAgVGhlIG5vcm1hbGl6ZWQgdmVyc2lvbiB3b3VsZCBsb29rIGxpa2UgdGhpcwoKICAgIGBgYGpzCiAgICB7CiAgICAgICJwb3N0IjogewogICAgICAgICJpZCI6IDEsCiAgICAgICAgInRpdGxlIjogIlJhaWxzIGlzIG9tYWthc2UiLAogICAgICAgICJsaW5rcyI6IHsgImZsYWdnZWRDb21tZW50cyI6ICJhcGkvY29tbWVudHMvZmxhZ2dlZCIgfQogICAgICB9CiAgICB9CiAgICBgYGAKCiAgICBAbWV0aG9kIG5vcm1hbGl6ZQogICAgQHBhcmFtIHtzdWJjbGFzcyBvZiBEUy5Nb2RlbH0gdHlwZQogICAgQHBhcmFtIHtPYmplY3R9IGhhc2gKICAgIEBwYXJhbSB7U3RyaW5nfSBwcm9wCiAgICBAcmV0dXJucyBPYmplY3QKICAqLwoKICBub3JtYWxpemU6IGZ1bmN0aW9uKHR5cGUsIGhhc2gsIHByb3ApIHsKICAgIHRoaXMubm9ybWFsaXplTGlua3MoaGFzaCk7CgogICAgcmV0dXJuIHRoaXMuX3N1cGVyKHR5cGUsIGhhc2gsIHByb3ApOwogIH0sCgogIC8qKgogICAgQ29udmVydCBgc25ha2VfY2FzZWRgIGxpbmtzICB0byBgY2FtZWxDYXNlYAoKICAgIEBtZXRob2Qgbm9ybWFsaXplTGlua3MKICAgIEBwYXJhbSB7T2JqZWN0fSBoYXNoCiAgKi8KCiAgbm9ybWFsaXplTGlua3M6IGZ1bmN0aW9uKGRhdGEpewogICAgaWYgKGRhdGEubGlua3MpIHsKICAgICAgdmFyIGxpbmtzID0gZGF0YS5saW5rczsKCiAgICAgIGZvciAodmFyIGxpbmsgaW4gbGlua3MpIHsKICAgICAgICB2YXIgY2FtZWxpemVkTGluayA9IEVtYmVyLlN0cmluZy5jYW1lbGl6ZShsaW5rKTsKCiAgICAgICAgaWYgKGNhbWVsaXplZExpbmsgIT09IGxpbmspIHsKICAgICAgICAgIGxpbmtzW2NhbWVsaXplZExpbmtdID0gbGlua3NbbGlua107CiAgICAgICAgICBkZWxldGUgbGlua3NbbGlua107CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSwKCiAgLyoqCiAgICBOb3JtYWxpemUgdGhlIHBvbHltb3JwaGljIHR5cGUgZnJvbSB0aGUgSlNPTi4KCiAgICBOb3JtYWxpemU6CiAgICBgYGBqcwogICAgICB7CiAgICAgICAgaWQ6ICIxIgogICAgICAgIG1pbmlvbjogeyB0eXBlOiAiZXZpbF9taW5pb24iLCBpZDogIjEyIn0KICAgICAgfQogICAgYGBgCgogICAgVG86CiAgICBgYGBqcwogICAgICB7CiAgICAgICAgaWQ6ICIxIgogICAgICAgIG1pbmlvbjogeyB0eXBlOiAiZXZpbE1pbmlvbiIsIGlkOiAiMTIifQogICAgICB9CiAgICBgYGAKCiAgICBAbWV0aG9kIG5vcm1hbGl6ZVJlbGF0aW9uc2hpcHMKICAgIEBwcml2YXRlCiAgKi8KICBub3JtYWxpemVSZWxhdGlvbnNoaXBzOiBmdW5jdGlvbih0eXBlLCBoYXNoKSB7CiAgICB2YXIgcGF5bG9hZEtleSwgcGF5bG9hZDsKCiAgICBpZiAodGhpcy5rZXlGb3JSZWxhdGlvbnNoaXApIHsKICAgICAgdHlwZS5lYWNoUmVsYXRpb25zaGlwKGZ1bmN0aW9uKGtleSwgcmVsYXRpb25zaGlwKSB7CiAgICAgICAgaWYgKHJlbGF0aW9uc2hpcC5vcHRpb25zLnBvbHltb3JwaGljKSB7CiAgICAgICAgICBwYXlsb2FkS2V5ID0gdGhpcy5rZXlGb3JBdHRyaWJ1dGUoa2V5KTsKICAgICAgICAgIHBheWxvYWQgPSBoYXNoW3BheWxvYWRLZXldOwogICAgICAgICAgaWYgKHBheWxvYWQgJiYgcGF5bG9hZC50eXBlKSB7CiAgICAgICAgICAgIHBheWxvYWQudHlwZSA9IHRoaXMudHlwZUZvclJvb3QocGF5bG9hZC50eXBlKTsKICAgICAgICAgIH0gZWxzZSBpZiAocGF5bG9hZCAmJiByZWxhdGlvbnNoaXAua2luZCA9PT0gImhhc01hbnkiKSB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgICAgZm9yRWFjaChwYXlsb2FkLCBmdW5jdGlvbihzaW5nbGUpIHsKICAgICAgICAgICAgICBzaW5nbGUudHlwZSA9IHNlbGYudHlwZUZvclJvb3Qoc2luZ2xlLnR5cGUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgcGF5bG9hZEtleSA9IHRoaXMua2V5Rm9yUmVsYXRpb25zaGlwKGtleSwgcmVsYXRpb25zaGlwLmtpbmQpOwogICAgICAgICAgcGF5bG9hZCA9IGhhc2hbcGF5bG9hZEtleV07CiAgICAgICAgfQoKICAgICAgICBoYXNoW2tleV0gPSBwYXlsb2FkOwoKICAgICAgICBpZiAoa2V5ICE9PSBwYXlsb2FkS2V5KSB7CiAgICAgICAgICBkZWxldGUgaGFzaFtwYXlsb2FkS2V5XTsKICAgICAgICB9CiAgICAgIH0sIHRoaXMpOwogICAgfQogIH0KfSk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7CnZhciBnZXQgPSBFbWJlci5nZXQ7CnZhciBmb3JFYWNoID0gRW1iZXIuRW51bWVyYWJsZVV0aWxzLmZvckVhY2g7CgovKioKICBUaGUgRW1iZWRkZWRSZWNvcmRzTWl4aW4gYWxsb3dzIHlvdSB0byBhZGQgZW1iZWRkZWQgcmVjb3JkIHN1cHBvcnQgdG8geW91cgogIHNlcmlhbGl6ZXJzLgogIFRvIHNldCB1cCBlbWJlZGRlZCByZWNvcmRzLCB5b3UgaW5jbHVkZSB0aGUgbWl4aW4gaW50byB0aGUgc2VyaWFsaXplciBhbmQgdGhlbgogIGRlZmluZSB5b3VyIGVtYmVkZGVkIHJlbGF0aW9ucy4KCiAgYGBganMKICBBcHAuUG9zdFNlcmlhbGl6ZXIgPSBEUy5BY3RpdmVNb2RlbFNlcmlhbGl6ZXIuZXh0ZW5kKERTLkVtYmVkZGVkUmVjb3Jkc01peGluLCB7CiAgICBhdHRyczogewogICAgICBjb21tZW50czoge2VtYmVkZGVkOiAnYWx3YXlzJ30KICAgIH0KICB9KQogIGBgYAoKICBDdXJyZW50bHkgb25seSBge2VtYmVkZGVkOiAnYWx3YXlzJ31gIHJlY29yZHMgYXJlIHN1cHBvcnRlZC4KCiAgQGNsYXNzIEVtYmVkZGVkUmVjb3Jkc01peGluCiAgQG5hbWVzcGFjZSBEUwoqLwpEUy5FbWJlZGRlZFJlY29yZHNNaXhpbiA9IEVtYmVyLk1peGluLmNyZWF0ZSh7CgogIC8qKgogICAgU2VyaWFsaXplIGhhcy1tYXkgcmVsYXRpb25zaGlwIHdoZW4gaXQgaXMgY29uZmlndXJlZCBhcyBlbWJlZGRlZCBvYmplY3RzLgoKICAgIEBtZXRob2Qgc2VyaWFsaXplSGFzTWFueQogICovCiAgc2VyaWFsaXplSGFzTWFueTogZnVuY3Rpb24ocmVjb3JkLCBqc29uLCByZWxhdGlvbnNoaXApIHsKICAgIHZhciBrZXkgICA9IHJlbGF0aW9uc2hpcC5rZXksCiAgICAgICAgYXR0cnMgPSBnZXQodGhpcywgJ2F0dHJzJyksCiAgICAgICAgZW1iZWQgPSBhdHRycyAmJiBhdHRyc1trZXldICYmIGF0dHJzW2tleV0uZW1iZWRkZWQgPT09ICdhbHdheXMnOwoKICAgIGlmIChlbWJlZCkgewogICAgICBqc29uW3RoaXMua2V5Rm9yQXR0cmlidXRlKGtleSldID0gZ2V0KHJlY29yZCwga2V5KS5tYXAoZnVuY3Rpb24ocmVsYXRpb24pIHsKICAgICAgICB2YXIgZGF0YSA9IHJlbGF0aW9uLnNlcmlhbGl6ZSgpLAogICAgICAgICAgICBwcmltYXJ5S2V5ID0gZ2V0KHRoaXMsICdwcmltYXJ5S2V5Jyk7CgogICAgICAgIGRhdGFbcHJpbWFyeUtleV0gPSBnZXQocmVsYXRpb24sIHByaW1hcnlLZXkpOwoKICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgfSwgdGhpcyk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICBFeHRyYWN0IGVtYmVkZGVkIG9iamVjdHMgb3V0IG9mIHRoZSBwYXlsb2FkIGZvciBhIHNpbmdsZSBvYmplY3QKICAgIGFuZCBhZGQgdGhlbSBhcyBzaWRlbG9hZGVkIG9iamVjdHMgaW5zdGVhZC4KCiAgICBAbWV0aG9kIGV4dHJhY3RTaW5nbGUKICAqLwogIGV4dHJhY3RTaW5nbGU6IGZ1bmN0aW9uKHN0b3JlLCBwcmltYXJ5VHlwZSwgcGF5bG9hZCwgcmVjb3JkSWQsIHJlcXVlc3RUeXBlKSB7CiAgICB2YXIgcm9vdCA9IHRoaXMua2V5Rm9yQXR0cmlidXRlKHByaW1hcnlUeXBlLnR5cGVLZXkpLAogICAgICAgIHBhcnRpYWwgPSBwYXlsb2FkW3Jvb3RdOwoKICAgIHVwZGF0ZVBheWxvYWRXaXRoRW1iZWRkZWQoc3RvcmUsIHRoaXMsIHByaW1hcnlUeXBlLCBwYXJ0aWFsLCBwYXlsb2FkKTsKCiAgICByZXR1cm4gdGhpcy5fc3VwZXIoc3RvcmUsIHByaW1hcnlUeXBlLCBwYXlsb2FkLCByZWNvcmRJZCwgcmVxdWVzdFR5cGUpOwogIH0sCgogIC8qKgogICAgRXh0cmFjdCBlbWJlZGRlZCBvYmplY3RzIG91dCBvZiBhIHN0YW5kYXJkIHBheWxvYWQKICAgIGFuZCBhZGQgdGhlbSBhcyBzaWRlbG9hZGVkIG9iamVjdHMgaW5zdGVhZC4KCiAgICBAbWV0aG9kIGV4dHJhY3RBcnJheQogICovCiAgZXh0cmFjdEFycmF5OiBmdW5jdGlvbihzdG9yZSwgdHlwZSwgcGF5bG9hZCkgewogICAgdmFyIHJvb3QgPSB0aGlzLmtleUZvckF0dHJpYnV0ZSh0eXBlLnR5cGVLZXkpLAogICAgICAgIHBhcnRpYWxzID0gcGF5bG9hZFtFbWJlci5TdHJpbmcucGx1cmFsaXplKHJvb3QpXTsKCiAgICBmb3JFYWNoKHBhcnRpYWxzLCBmdW5jdGlvbihwYXJ0aWFsKSB7CiAgICAgIHVwZGF0ZVBheWxvYWRXaXRoRW1iZWRkZWQoc3RvcmUsIHRoaXMsIHR5cGUsIHBhcnRpYWwsIHBheWxvYWQpOwogICAgfSwgdGhpcyk7CgogICAgcmV0dXJuIHRoaXMuX3N1cGVyKHN0b3JlLCB0eXBlLCBwYXlsb2FkKTsKICB9Cn0pOwoKZnVuY3Rpb24gdXBkYXRlUGF5bG9hZFdpdGhFbWJlZGRlZChzdG9yZSwgc2VyaWFsaXplciwgdHlwZSwgcGFydGlhbCwgcGF5bG9hZCkgewogIHZhciBhdHRycyA9IGdldChzZXJpYWxpemVyLCAnYXR0cnMnKTsKCiAgaWYgKCFhdHRycykgewogICAgcmV0dXJuOwogIH0KCiAgdHlwZS5lYWNoUmVsYXRpb25zaGlwKGZ1bmN0aW9uKGtleSwgcmVsYXRpb25zaGlwKSB7CiAgICB2YXIgZXhwYW5kZWRLZXksIGVtYmVkZGVkVHlwZUtleSwgYXR0cmlidXRlLCBpZHMsCiAgICAgICAgY29uZmlnID0gYXR0cnNba2V5XSwKICAgICAgICBzZXJpYWxpemVyID0gc3RvcmUuc2VyaWFsaXplckZvcihyZWxhdGlvbnNoaXAudHlwZS50eXBlS2V5KSwKICAgICAgICBwcmltYXJ5S2V5ID0gZ2V0KHNlcmlhbGl6ZXIsICJwcmltYXJ5S2V5Iik7CgogICAgaWYgKHJlbGF0aW9uc2hpcC5raW5kICE9PSAiaGFzTWFueSIpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChjb25maWcgJiYgKGNvbmZpZy5lbWJlZGRlZCA9PT0gJ2Fsd2F5cycgfHwgY29uZmlnLmVtYmVkZGVkID09PSAnbG9hZCcpKSB7CiAgICAgIC8vIHVuZGVyc2NvcmUgZm9yY2VzIHRoZSBlbWJlZGRlZCByZWNvcmRzIHRvIGJlIHNpZGUgbG9hZGVkLgogICAgICAvLyBpdCBpcyBuZWVkZWQgd2hlbiBtYWluIHR5cGUgPT09IHJlbGF0aW9uc2hpcC50eXBlCiAgICAgIGVtYmVkZGVkVHlwZUtleSA9ICdfJyArIEVtYmVyLlN0cmluZy5wbHVyYWxpemUocmVsYXRpb25zaGlwLnR5cGUudHlwZUtleSk7CiAgICAgIGV4cGFuZGVkS2V5ID0gdGhpcy5rZXlGb3JSZWxhdGlvbnNoaXAoa2V5LCByZWxhdGlvbnNoaXAua2luZCk7CiAgICAgIGF0dHJpYnV0ZSAgPSB0aGlzLmtleUZvckF0dHJpYnV0ZShrZXkpOwogICAgICBpZHMgPSBbXTsKCiAgICAgIGlmICghcGFydGlhbFthdHRyaWJ1dGVdKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBwYXlsb2FkW2VtYmVkZGVkVHlwZUtleV0gPSBwYXlsb2FkW2VtYmVkZGVkVHlwZUtleV0gfHwgW107CgogICAgICBmb3JFYWNoKHBhcnRpYWxbYXR0cmlidXRlXSwgZnVuY3Rpb24oZGF0YSkgewogICAgICAgIHZhciBlbWJlZGRlZFR5cGUgPSBzdG9yZS5tb2RlbEZvcihyZWxhdGlvbnNoaXAudHlwZS50eXBlS2V5KTsKICAgICAgICB1cGRhdGVQYXlsb2FkV2l0aEVtYmVkZGVkKHN0b3JlLCBzZXJpYWxpemVyLCBlbWJlZGRlZFR5cGUsIGRhdGEsIHBheWxvYWQpOwogICAgICAgIGlkcy5wdXNoKGRhdGFbcHJpbWFyeUtleV0pOwogICAgICAgIHBheWxvYWRbZW1iZWRkZWRUeXBlS2V5XS5wdXNoKGRhdGEpOwogICAgICB9KTsKCiAgICAgIHBhcnRpYWxbZXhwYW5kZWRLZXldID0gaWRzOwogICAgICBkZWxldGUgcGFydGlhbFthdHRyaWJ1dGVdOwogICAgfQogIH0sIHNlcmlhbGl6ZXIpOwp9Cn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCiAgQG1vZHVsZSBlbWJlci1kYXRhCiovCgp2YXIgZm9yRWFjaCA9IEVtYmVyLkVudW1lcmFibGVVdGlscy5mb3JFYWNoOwoKLyoqCiAgVGhlIEFjdGl2ZU1vZGVsQWRhcHRlciBpcyBhIHN1YmNsYXNzIG9mIHRoZSBSRVNUQWRhcHRlciBkZXNpZ25lZCB0byBpbnRlZ3JhdGUKICB3aXRoIGEgSlNPTiBBUEkgdGhhdCB1c2VzIGFuIHVuZGVyc2NvcmVkIG5hbWluZyBjb252ZW50aW9uIGluc3RlYWQgb2YgY2FtZWxjYXNpbmcuCiAgSXQgaGFzIGJlZW4gZGVzaWduZWQgdG8gd29yayBvdXQgb2YgdGhlIGJveCB3aXRoIHRoZQogIFthY3RpdmVfbW9kZWxfc2VyaWFsaXplcnNdKGh0dHA6Ly9naXRodWIuY29tL3JhaWxzLWFwaS9hY3RpdmVfbW9kZWxfc2VyaWFsaXplcnMpCiAgUnVieSBnZW0uCgogIFRoaXMgYWRhcHRlciBleHRlbmRzIHRoZSBEUy5SRVNUQWRhcHRlciBieSBtYWtpbmcgY29uc2lzdGVudCB1c2Ugb2YgdGhlIGNhbWVsaXphdGlvbiwKICBkZWNhbWVsaXphdGlvbiBhbmQgcGx1cmFsaXphdGlvbiBtZXRob2RzIHRvIG5vcm1hbGl6ZSB0aGUgc2VyaWFsaXplZCBKU09OIGludG8gYQogIGZvcm1hdCB0aGF0IGlzIGNvbXBhdGlibGUgd2l0aCBhIGNvbnZlbnRpb25hbCBSYWlscyBiYWNrZW5kIGFuZCBFbWJlciBEYXRhLgoKICAjIyBKU09OIFN0cnVjdHVyZQoKICBUaGUgQWN0aXZlTW9kZWxBZGFwdGVyIGV4cGVjdHMgdGhlIEpTT04gcmV0dXJuZWQgZnJvbSB5b3VyIHNlcnZlciB0byBmb2xsb3cKICB0aGUgUkVTVCBhZGFwdGVyIGNvbnZlbnRpb25zIHN1YnN0aXR1dGluZyB1bmRlcnNjb3JlZCBrZXlzIGZvciBjYW1lbGNhc2VkIG9uZXMuCgogICMjIyBDb252ZW50aW9uYWwgTmFtZXMKCiAgQXR0cmlidXRlIG5hbWVzIGluIHlvdXIgSlNPTiBwYXlsb2FkIHNob3VsZCBiZSB0aGUgdW5kZXJzY29yZWQgdmVyc2lvbnMgb2YKICB0aGUgYXR0cmlidXRlcyBpbiB5b3VyIEVtYmVyLmpzIG1vZGVscy4KCiAgRm9yIGV4YW1wbGUsIGlmIHlvdSBoYXZlIGEgYFBlcnNvbmAgbW9kZWw6CgogIGBgYGpzCiAgQXBwLkZhbW91c1BlcnNvbiA9IERTLk1vZGVsLmV4dGVuZCh7CiAgICBmaXJzdE5hbWU6IERTLmF0dHIoJ3N0cmluZycpLAogICAgbGFzdE5hbWU6IERTLmF0dHIoJ3N0cmluZycpLAogICAgb2NjdXBhdGlvbjogRFMuYXR0cignc3RyaW5nJykKICB9KTsKICBgYGAKCiAgVGhlIEpTT04gcmV0dXJuZWQgc2hvdWxkIGxvb2sgbGlrZSB0aGlzOgoKICBgYGBqcwogIHsKICAgICJmYW1vdXNfcGVyc29uIjogewogICAgICAiZmlyc3RfbmFtZSI6ICJCYXJhY2siLAogICAgICAibGFzdF9uYW1lIjogIk9iYW1hIiwKICAgICAgIm9jY3VwYXRpb24iOiAiUHJlc2lkZW50IgogICAgfQogIH0KICBgYGAKCiAgQGNsYXNzIEFjdGl2ZU1vZGVsQWRhcHRlcgogIEBjb25zdHJ1Y3RvcgogIEBuYW1lc3BhY2UgRFMKICBAZXh0ZW5kcyBEUy5BZGFwdGVyCioqLwoKRFMuQWN0aXZlTW9kZWxBZGFwdGVyID0gRFMuUkVTVEFkYXB0ZXIuZXh0ZW5kKHsKICBkZWZhdWx0U2VyaWFsaXplcjogJ19hbXMnLAogIC8qKgogICAgVGhlIEFjdGl2ZU1vZGVsQWRhcHRlciBvdmVycmlkZXMgdGhlIGBwYXRoRm9yVHlwZWAgbWV0aG9kIHRvIGJ1aWxkCiAgICB1bmRlcnNjb3JlZCBVUkxzIGJ5IGRlY2FtZWxpemluZyBhbmQgcGx1cmFsaXppbmcgdGhlIG9iamVjdCB0eXBlIG5hbWUuCgogICAgYGBganMKICAgICAgdGhpcy5wYXRoRm9yVHlwZSgiZmFtb3VzUGVyc29uIik7CiAgICAgIC8vPT4gImZhbW91c19wZW9wbGUiCiAgICBgYGAKCiAgICBAbWV0aG9kIHBhdGhGb3JUeXBlCiAgICBAcGFyYW0ge1N0cmluZ30gdHlwZQogICAgQHJldHVybnMgU3RyaW5nCiAgKi8KICBwYXRoRm9yVHlwZTogZnVuY3Rpb24odHlwZSkgewogICAgdmFyIGRlY2FtZWxpemVkID0gRW1iZXIuU3RyaW5nLmRlY2FtZWxpemUodHlwZSk7CiAgICByZXR1cm4gRW1iZXIuU3RyaW5nLnBsdXJhbGl6ZShkZWNhbWVsaXplZCk7CiAgfSwKCiAgLyoqCiAgICBUaGUgQWN0aXZlTW9kZWxBZGFwdGVyIG92ZXJyaWRlcyB0aGUgYGFqYXhFcnJvcmAgbWV0aG9kCiAgICB0byByZXR1cm4gYSBEUy5JbnZhbGlkRXJyb3IgZm9yIGFsbCA0MjIgVW5wcm9jZXNzYWJsZSBFbnRpdHkKICAgIHJlc3BvbnNlcy4KCiAgICBBIDQyMiBIVFRQIHJlc3BvbnNlIGZyb20gdGhlIHNlcnZlciBnZW5lcmFsbHkgaW1wbGllcyB0aGF0IHRoZSByZXF1ZXN0CiAgICB3YXMgd2VsbCBmb3JtZWQgYnV0IHRoZSBBUEkgd2FzIHVuYWJsZSB0byBwcm9jZXNzIGl0IGJlY2F1c2UgdGhlCiAgICBjb250ZW50IHdhcyBub3Qgc2VtYW50aWNhbGx5IGNvcnJlY3Qgb3IgbWVhbmluZ2Z1bCBwZXIgdGhlIEFQSS4KCiAgICBGb3IgbW9yZSBpbmZvcm1hdGlvbiBvbiA0MjIgSFRUUCBFcnJvciBjb2RlIHNlZSAxMS4yIFdlYkRBViBSRkMgNDkxOAogICAgaHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzQ5MTgjc2VjdGlvbi0xMS4yCgogICAgQG1ldGhvZCBhamF4RXJyb3IKICAgIEBwYXJhbSBqcVhIUgogICAgQHJldHVybnMgZXJyb3IKICAqLwogIGFqYXhFcnJvcjogZnVuY3Rpb24oanFYSFIpIHsKICAgIHZhciBlcnJvciA9IHRoaXMuX3N1cGVyKGpxWEhSKTsKCiAgICBpZiAoanFYSFIgJiYganFYSFIuc3RhdHVzID09PSA0MjIpIHsKICAgICAgdmFyIGpzb25FcnJvcnMgPSBFbWJlci4kLnBhcnNlSlNPTihqcVhIUi5yZXNwb25zZVRleHQpWyJlcnJvcnMiXSwKICAgICAgICAgIGVycm9ycyA9IHt9OwoKICAgICAgZm9yRWFjaChFbWJlci5rZXlzKGpzb25FcnJvcnMpLCBmdW5jdGlvbihrZXkpIHsKICAgICAgICBlcnJvcnNbRW1iZXIuU3RyaW5nLmNhbWVsaXplKGtleSldID0ganNvbkVycm9yc1trZXldOwogICAgICB9KTsKCiAgICAgIHJldHVybiBuZXcgRFMuSW52YWxpZEVycm9yKGVycm9ycyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZXJyb3I7CiAgICB9CiAgfQp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKRW1iZXIub25Mb2FkKCdFbWJlci5BcHBsaWNhdGlvbicsIGZ1bmN0aW9uKEFwcGxpY2F0aW9uKSB7CiAgQXBwbGljYXRpb24uaW5pdGlhbGl6ZXIoewogICAgbmFtZTogImFjdGl2ZU1vZGVsQWRhcHRlciIsCgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oY29udGFpbmVyLCBhcHBsaWNhdGlvbikgewogICAgICBhcHBsaWNhdGlvbi5yZWdpc3Rlcignc2VyaWFsaXplcjpfYW1zJywgRFMuQWN0aXZlTW9kZWxTZXJpYWxpemVyKTsKICAgICAgYXBwbGljYXRpb24ucmVnaXN0ZXIoJ2FkYXB0ZXI6X2FtcycsIERTLkFjdGl2ZU1vZGVsQWRhcHRlcik7CiAgICB9CiAgfSk7Cn0pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewoKfSkoKTsKCgp9KSgpOwo=</content>
    <filesize>278834</filesize>
  </attachment>
  <attachment>
    <filename>ember.js</filename>
    <author>XWiki.Admin</author>
    <date>1498975668000</date>
    <version>1.1</version>
    <comment/>
    <content>LyohCiAqIEBvdmVydmlldyAgRW1iZXIgLSBKYXZhU2NyaXB0IEFwcGxpY2F0aW9uIEZyYW1ld29yawogKiBAY29weXJpZ2h0IENvcHlyaWdodCAyMDExLTIwMTQgVGlsZGUgSW5jLiBhbmQgY29udHJpYnV0b3JzCiAqICAgICAgICAgICAgUG9ydGlvbnMgQ29weXJpZ2h0IDIwMDYtMjAxMSBTdHJvYmUgSW5jLgogKiAgICAgICAgICAgIFBvcnRpb25zIENvcHlyaWdodCAyMDA4LTIwMTEgQXBwbGUgSW5jLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBAbGljZW5zZSAgIExpY2Vuc2VkIHVuZGVyIE1JVCBsaWNlbnNlCiAqICAgICAgICAgICAgU2VlIGh0dHBzOi8vcmF3LmdpdGh1Yi5jb20vZW1iZXJqcy9lbWJlci5qcy9tYXN0ZXIvTElDRU5TRQogKiBAdmVyc2lvbiAgIDEuMy4xCiAqLwoKCihmdW5jdGlvbigpIHsKLypnbG9iYWwgX19mYWlsX18qLwoKLyoqCkVtYmVyIERlYnVnCgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItZGVidWcKKi8KCi8qKgpAY2xhc3MgRW1iZXIKKi8KCmlmICgndW5kZWZpbmVkJyA9PT0gdHlwZW9mIEVtYmVyKSB7CiAgRW1iZXIgPSB7fTsKCiAgaWYgKCd1bmRlZmluZWQnICE9PSB0eXBlb2Ygd2luZG93KSB7CiAgICB3aW5kb3cuRW0gPSB3aW5kb3cuRW1iZXIgPSBFbSA9IEVtYmVyOwogIH0KfQoKLy8gVGhpcyBuZWVkcyB0byBiZSBrZXB0IGluIHN5bmMgd2l0aCB0aGUgbG9naWMgaW4KLy8gYHBhY2thZ2VzL2VtYmVyLW1ldGFsL2xpYi9jb3JlLmpzYC4KLy8KLy8gVGhpcyBpcyBkdXBsaWNhdGVkIGhlcmUgdG8gZW5zdXJlIHRoYXQgYEVtYmVyLkVOVmAKLy8gaXMgc2V0dXAgZXZlbiBpZiBgRW1iZXJgIGlzIG5vdCBsb2FkZWQgeWV0LgppZiAoRW1iZXIuRU5WKSB7CiAgLy8gZG8gbm90aGluZyBpZiBFbWJlci5FTlYgaXMgYWxyZWFkeSBzZXR1cAp9IGVsc2UgaWYgKCd1bmRlZmluZWQnICE9PSB0eXBlb2YgRW1iZXJFTlYpIHsKICBFbWJlci5FTlYgPSBFbWJlckVOVjsKfSBlbHNlIGlmKCd1bmRlZmluZWQnICE9PSB0eXBlb2YgRU5WKSB7CiAgRW1iZXIuRU5WID0gRU5WOwp9IGVsc2UgewogIEVtYmVyLkVOViA9IHt9Owp9CgppZiAoISgnTUFOREFUT1JZX1NFVFRFUicgaW4gRW1iZXIuRU5WKSkgewogIEVtYmVyLkVOVi5NQU5EQVRPUllfU0VUVEVSID0gdHJ1ZTsgLy8gZGVmYXVsdCB0byB0cnVlIGZvciBkZWJ1ZyBkaXN0Cn0KCi8qKgogIERlZmluZSBhbiBhc3NlcnRpb24gdGhhdCB3aWxsIHRocm93IGFuIGV4Y2VwdGlvbiBpZiB0aGUgY29uZGl0aW9uIGlzIG5vdAogIG1ldC4gRW1iZXIgYnVpbGQgdG9vbHMgd2lsbCByZW1vdmUgYW55IGNhbGxzIHRvIGBFbWJlci5hc3NlcnQoKWAgd2hlbgogIGRvaW5nIGEgcHJvZHVjdGlvbiBidWlsZC4gRXhhbXBsZToKCiAgYGBgamF2YXNjcmlwdAogIC8vIFRlc3QgZm9yIHRydXRoaW5lc3MKICBFbWJlci5hc3NlcnQoJ011c3QgcGFzcyBhIHZhbGlkIG9iamVjdCcsIG9iaik7CiAgLy8gRmFpbCB1bmNvbmRpdGlvbmFsbHkKICBFbWJlci5hc3NlcnQoJ1RoaXMgY29kZSBwYXRoIHNob3VsZCBuZXZlciBiZSBydW4nKQogIGBgYAoKICBAbWV0aG9kIGFzc2VydAogIEBwYXJhbSB7U3RyaW5nfSBkZXNjIEEgZGVzY3JpcHRpb24gb2YgdGhlIGFzc2VydGlvbi4gVGhpcyB3aWxsIGJlY29tZQogICAgdGhlIHRleHQgb2YgdGhlIEVycm9yIHRocm93biBpZiB0aGUgYXNzZXJ0aW9uIGZhaWxzLgogIEBwYXJhbSB7Qm9vbGVhbn0gdGVzdCBNdXN0IGJlIHRydXRoeSBmb3IgdGhlIGFzc2VydGlvbiB0byBwYXNzLiBJZgogICAgZmFsc3ksIGFuIGV4Y2VwdGlvbiB3aWxsIGJlIHRocm93bi4KKi8KRW1iZXIuYXNzZXJ0ID0gZnVuY3Rpb24oZGVzYywgdGVzdCkgewogIGlmICghdGVzdCkgewogICAgRW1iZXIuTG9nZ2VyLmFzc2VydCh0ZXN0LCBkZXNjKTsKICB9CgogIGlmIChFbWJlci50ZXN0aW5nICYmICF0ZXN0KSB7CiAgICAvLyB3aGVuIHRlc3RpbmcsIGVuc3VyZSB0ZXN0IGZhaWx1cmVzIHdoZW4gYXNzZXJ0aW9ucyBmYWlsCiAgICB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoIkFzc2VydGlvbiBGYWlsZWQ6ICIgKyBkZXNjKTsKICB9Cn07CgoKLyoqCiAgRGlzcGxheSBhIHdhcm5pbmcgd2l0aCB0aGUgcHJvdmlkZWQgbWVzc2FnZS4gRW1iZXIgYnVpbGQgdG9vbHMgd2lsbAogIHJlbW92ZSBhbnkgY2FsbHMgdG8gYEVtYmVyLndhcm4oKWAgd2hlbiBkb2luZyBhIHByb2R1Y3Rpb24gYnVpbGQuCgogIEBtZXRob2Qgd2FybgogIEBwYXJhbSB7U3RyaW5nfSBtZXNzYWdlIEEgd2FybmluZyB0byBkaXNwbGF5LgogIEBwYXJhbSB7Qm9vbGVhbn0gdGVzdCBBbiBvcHRpb25hbCBib29sZWFuLiBJZiBmYWxzeSwgdGhlIHdhcm5pbmcKICAgIHdpbGwgYmUgZGlzcGxheWVkLgoqLwpFbWJlci53YXJuID0gZnVuY3Rpb24obWVzc2FnZSwgdGVzdCkgewogIGlmICghdGVzdCkgewogICAgRW1iZXIuTG9nZ2VyLndhcm4oIldBUk5JTkc6ICIrbWVzc2FnZSk7CiAgICBpZiAoJ3RyYWNlJyBpbiBFbWJlci5Mb2dnZXIpIEVtYmVyLkxvZ2dlci50cmFjZSgpOwogIH0KfTsKCi8qKgogIERpc3BsYXkgYSBkZWJ1ZyBub3RpY2UuIEVtYmVyIGJ1aWxkIHRvb2xzIHdpbGwgcmVtb3ZlIGFueSBjYWxscyB0bwogIGBFbWJlci5kZWJ1ZygpYCB3aGVuIGRvaW5nIGEgcHJvZHVjdGlvbiBidWlsZC4KCiAgYGBgamF2YXNjcmlwdAogIEVtYmVyLmRlYnVnKCJJJ20gYSBkZWJ1ZyBub3RpY2UhIik7CiAgYGBgCgogIEBtZXRob2QgZGVidWcKICBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZSBBIGRlYnVnIG1lc3NhZ2UgdG8gZGlzcGxheS4KKi8KRW1iZXIuZGVidWcgPSBmdW5jdGlvbihtZXNzYWdlKSB7CiAgRW1iZXIuTG9nZ2VyLmRlYnVnKCJERUJVRzogIittZXNzYWdlKTsKfTsKCi8qKgogIERpc3BsYXkgYSBkZXByZWNhdGlvbiB3YXJuaW5nIHdpdGggdGhlIHByb3ZpZGVkIG1lc3NhZ2UgYW5kIGEgc3RhY2sgdHJhY2UKICAoQ2hyb21lIGFuZCBGaXJlZm94IG9ubHkpLiBFbWJlciBidWlsZCB0b29scyB3aWxsIHJlbW92ZSBhbnkgY2FsbHMgdG8KICBgRW1iZXIuZGVwcmVjYXRlKClgIHdoZW4gZG9pbmcgYSBwcm9kdWN0aW9uIGJ1aWxkLgoKICBAbWV0aG9kIGRlcHJlY2F0ZQogIEBwYXJhbSB7U3RyaW5nfSBtZXNzYWdlIEEgZGVzY3JpcHRpb24gb2YgdGhlIGRlcHJlY2F0aW9uLgogIEBwYXJhbSB7Qm9vbGVhbn0gdGVzdCBBbiBvcHRpb25hbCBib29sZWFuLiBJZiBmYWxzeSwgdGhlIGRlcHJlY2F0aW9uCiAgICB3aWxsIGJlIGRpc3BsYXllZC4KKi8KRW1iZXIuZGVwcmVjYXRlID0gZnVuY3Rpb24obWVzc2FnZSwgdGVzdCkgewogIGlmIChFbWJlci5URVNUSU5HX0RFUFJFQ0FUSU9OKSB7IHJldHVybjsgfQoKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgeyB0ZXN0ID0gZmFsc2U7IH0KICBpZiAodGVzdCkgeyByZXR1cm47IH0KCiAgaWYgKEVtYmVyLkVOVi5SQUlTRV9PTl9ERVBSRUNBVElPTikgeyB0aHJvdyBuZXcgRW1iZXIuRXJyb3IobWVzc2FnZSk7IH0KCiAgdmFyIGVycm9yOwoKICAvLyBXaGVuIHVzaW5nIG5ldyBFcnJvciwgd2UgY2FuJ3QgZG8gdGhlIGFyZ3VtZW50cyBjaGVjayBmb3IgQ2hyb21lLiBBbHRlcm5hdGl2ZXMgYXJlIHdlbGNvbWUKICB0cnkgeyBfX2ZhaWxfXy5mYWlsKCk7IH0gY2F0Y2ggKGUpIHsgZXJyb3IgPSBlOyB9CgogIGlmIChFbWJlci5MT0dfU1RBQ0tUUkFDRV9PTl9ERVBSRUNBVElPTiAmJiBlcnJvci5zdGFjaykgewogICAgdmFyIHN0YWNrLCBzdGFja1N0ciA9ICcnOwogICAgaWYgKGVycm9yWydhcmd1bWVudHMnXSkgewogICAgICAvLyBDaHJvbWUKICAgICAgc3RhY2sgPSBlcnJvci5zdGFjay5yZXBsYWNlKC9eXHMrYXRccysvZ20sICcnKS4KICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlKC9eKFteXChdKz8pKFtcbiRdKS9nbSwgJ3thbm9ueW1vdXN9KCQxKSQyJykuCiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZSgvXk9iamVjdC48YW5vbnltb3VzPlxzKlwoKFteXCldKylcKS9nbSwgJ3thbm9ueW1vdXN9KCQxKScpLnNwbGl0KCdcbicpOwogICAgICBzdGFjay5zaGlmdCgpOwogICAgfSBlbHNlIHsKICAgICAgLy8gRmlyZWZveAogICAgICBzdGFjayA9IGVycm9yLnN0YWNrLnJlcGxhY2UoLyg/OlxuQDowKT9ccyskL20sICcnKS4KICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlKC9eXCgvZ20sICd7YW5vbnltb3VzfSgnKS5zcGxpdCgnXG4nKTsKICAgIH0KCiAgICBzdGFja1N0ciA9ICJcbiAgICAiICsgc3RhY2suc2xpY2UoMikuam9pbigiXG4gICAgIik7CiAgICBtZXNzYWdlID0gbWVzc2FnZSArIHN0YWNrU3RyOwogIH0KCiAgRW1iZXIuTG9nZ2VyLndhcm4oIkRFUFJFQ0FUSU9OOiAiK21lc3NhZ2UpOwp9OwoKCgovKioKICBBbGlhcyBhbiBvbGQsIGRlcHJlY2F0ZWQgbWV0aG9kIHdpdGggaXRzIG5ldyBjb3VudGVycGFydC4KCiAgRGlzcGxheSBhIGRlcHJlY2F0aW9uIHdhcm5pbmcgd2l0aCB0aGUgcHJvdmlkZWQgbWVzc2FnZSBhbmQgYSBzdGFjayB0cmFjZQogIChDaHJvbWUgYW5kIEZpcmVmb3ggb25seSkgd2hlbiB0aGUgYXNzaWduZWQgbWV0aG9kIGlzIGNhbGxlZC4KCiAgRW1iZXIgYnVpbGQgdG9vbHMgd2lsbCBub3QgcmVtb3ZlIGNhbGxzIHRvIGBFbWJlci5kZXByZWNhdGVGdW5jKClgLCB0aG91Z2gKICBubyB3YXJuaW5ncyB3aWxsIGJlIHNob3duIGluIHByb2R1Y3Rpb24uCgogIGBgYGphdmFzY3JpcHQKICBFbWJlci5vbGRNZXRob2QgPSBFbWJlci5kZXByZWNhdGVGdW5jKCJQbGVhc2UgdXNlIHRoZSBuZXcsIHVwZGF0ZWQgbWV0aG9kIiwgRW1iZXIubmV3TWV0aG9kKTsKICBgYGAKCiAgQG1ldGhvZCBkZXByZWNhdGVGdW5jCiAgQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2UgQSBkZXNjcmlwdGlvbiBvZiB0aGUgZGVwcmVjYXRpb24uCiAgQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgbmV3IGZ1bmN0aW9uIGNhbGxlZCB0byByZXBsYWNlIGl0cyBkZXByZWNhdGVkIGNvdW50ZXJwYXJ0LgogIEByZXR1cm4ge0Z1bmN0aW9ufSBhIG5ldyBmdW5jdGlvbiB0aGF0IHdyYXBwZWQgdGhlIG9yaWdpbmFsIGZ1bmN0aW9uIHdpdGggYSBkZXByZWNhdGlvbiB3YXJuaW5nCiovCkVtYmVyLmRlcHJlY2F0ZUZ1bmMgPSBmdW5jdGlvbihtZXNzYWdlLCBmdW5jKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgRW1iZXIuZGVwcmVjYXRlKG1lc3NhZ2UpOwogICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9Owp9OwoKCi8vIEluZm9ybSB0aGUgZGV2ZWxvcGVyIGFib3V0IHRoZSBFbWJlciBJbnNwZWN0b3IgaWYgbm90IGluc3RhbGxlZC4KaWYgKCFFbWJlci50ZXN0aW5nKSB7CiAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5jaHJvbWUgJiYgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJsb2FkIiwgZnVuY3Rpb24oKSB7CiAgICAgIGlmIChkb2N1bWVudC5ib2R5ICYmIGRvY3VtZW50LmJvZHkuZGF0YXNldCAmJiAhZG9jdW1lbnQuYm9keS5kYXRhc2V0LmVtYmVyRXh0ZW5zaW9uKSB7CiAgICAgICAgRW1iZXIuZGVidWcoJ0ZvciBtb3JlIGFkdmFuY2VkIGRlYnVnZ2luZywgaW5zdGFsbCB0aGUgRW1iZXIgSW5zcGVjdG9yIGZyb20gaHR0cHM6Ly9jaHJvbWUuZ29vZ2xlLmNvbS93ZWJzdG9yZS9kZXRhaWwvZW1iZXItaW5zcGVjdG9yL2JtZGJsbmNlZ2tlbmthY2llaWhmaHBqZnBwb2NvbmhpJyk7CiAgICAgIH0KICAgIH0sIGZhbHNlKTsKICB9Cn0KCn0pKCk7CgovKiEKICogQG92ZXJ2aWV3ICBFbWJlciAtIEphdmFTY3JpcHQgQXBwbGljYXRpb24gRnJhbWV3b3JrCiAqIEBjb3B5cmlnaHQgQ29weXJpZ2h0IDIwMTEtMjAxNCBUaWxkZSBJbmMuIGFuZCBjb250cmlidXRvcnMKICogICAgICAgICAgICBQb3J0aW9ucyBDb3B5cmlnaHQgMjAwNi0yMDExIFN0cm9iZSBJbmMuCiAqICAgICAgICAgICAgUG9ydGlvbnMgQ29weXJpZ2h0IDIwMDgtMjAxMSBBcHBsZSBJbmMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIEBsaWNlbnNlICAgTGljZW5zZWQgdW5kZXIgTUlUIGxpY2Vuc2UKICogICAgICAgICAgICBTZWUgaHR0cHM6Ly9yYXcuZ2l0aHViLmNvbS9lbWJlcmpzL2VtYmVyLmpzL21hc3Rlci9MSUNFTlNFCiAqIEB2ZXJzaW9uICAgMS4zLjEKICovCgoKKGZ1bmN0aW9uKCkgewp2YXIgZGVmaW5lLCByZXF1aXJlTW9kdWxlLCByZXF1aXJlLCByZXF1aXJlanM7CgooZnVuY3Rpb24oKSB7CiAgdmFyIHJlZ2lzdHJ5ID0ge30sIHNlZW4gPSB7fTsKCiAgZGVmaW5lID0gZnVuY3Rpb24obmFtZSwgZGVwcywgY2FsbGJhY2spIHsKICAgIHJlZ2lzdHJ5W25hbWVdID0geyBkZXBzOiBkZXBzLCBjYWxsYmFjazogY2FsbGJhY2sgfTsKICB9OwoKICByZXF1aXJlanMgPSByZXF1aXJlID0gcmVxdWlyZU1vZHVsZSA9IGZ1bmN0aW9uKG5hbWUpIHsKICByZXF1aXJlanMuX2Vha19zZWVuID0gcmVnaXN0cnk7CgogICAgaWYgKHNlZW5bbmFtZV0pIHsgcmV0dXJuIHNlZW5bbmFtZV07IH0KICAgIHNlZW5bbmFtZV0gPSB7fTsKCiAgICBpZiAoIXJlZ2lzdHJ5W25hbWVdKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiQ291bGQgbm90IGZpbmQgbW9kdWxlICIgKyBuYW1lKTsKICAgIH0KCiAgICB2YXIgbW9kID0gcmVnaXN0cnlbbmFtZV0sCiAgICAgICAgZGVwcyA9IG1vZC5kZXBzLAogICAgICAgIGNhbGxiYWNrID0gbW9kLmNhbGxiYWNrLAogICAgICAgIHJlaWZpZWQgPSBbXSwKICAgICAgICBleHBvcnRzOwoKICAgIGZvciAodmFyIGk9MCwgbD1kZXBzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgaWYgKGRlcHNbaV0gPT09ICdleHBvcnRzJykgewogICAgICAgIHJlaWZpZWQucHVzaChleHBvcnRzID0ge30pOwogICAgICB9IGVsc2UgewogICAgICAgIHJlaWZpZWQucHVzaChyZXF1aXJlTW9kdWxlKHJlc29sdmUoZGVwc1tpXSkpKTsKICAgICAgfQogICAgfQoKICAgIHZhciB2YWx1ZSA9IGNhbGxiYWNrLmFwcGx5KHRoaXMsIHJlaWZpZWQpOwogICAgcmV0dXJuIHNlZW5bbmFtZV0gPSBleHBvcnRzIHx8IHZhbHVlOwoKICAgIGZ1bmN0aW9uIHJlc29sdmUoY2hpbGQpIHsKICAgICAgaWYgKGNoaWxkLmNoYXJBdCgwKSAhPT0gJy4nKSB7IHJldHVybiBjaGlsZDsgfQogICAgICB2YXIgcGFydHMgPSBjaGlsZC5zcGxpdCgiLyIpOwogICAgICB2YXIgcGFyZW50QmFzZSA9IG5hbWUuc3BsaXQoIi8iKS5zbGljZSgwLCAtMSk7CgogICAgICBmb3IgKHZhciBpPTAsIGw9cGFydHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIHZhciBwYXJ0ID0gcGFydHNbaV07CgogICAgICAgIGlmIChwYXJ0ID09PSAnLi4nKSB7IHBhcmVudEJhc2UucG9wKCk7IH0KICAgICAgICBlbHNlIGlmIChwYXJ0ID09PSAnLicpIHsgY29udGludWU7IH0KICAgICAgICBlbHNlIHsgcGFyZW50QmFzZS5wdXNoKHBhcnQpOyB9CiAgICAgIH0KCiAgICAgIHJldHVybiBwYXJlbnRCYXNlLmpvaW4oIi8iKTsKICAgIH0KICB9Owp9KSgpOwooZnVuY3Rpb24oKSB7Ci8qZ2xvYmFscyBFbTp0cnVlIEVOViBFbWJlckVOViBNZXRhbW9ycGhFTlY6dHJ1ZSAqLwoKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1tZXRhbAoqLwoKLyoqCiAgQWxsIEVtYmVyIG1ldGhvZHMgYW5kIGZ1bmN0aW9ucyBhcmUgZGVmaW5lZCBpbnNpZGUgb2YgdGhpcyBuYW1lc3BhY2UuIFlvdQogIGdlbmVyYWxseSBzaG91bGQgbm90IGFkZCBuZXcgcHJvcGVydGllcyB0byB0aGlzIG5hbWVzcGFjZSBhcyBpdCBtYXkgYmUKICBvdmVyd3JpdHRlbiBieSBmdXR1cmUgdmVyc2lvbnMgb2YgRW1iZXIuCgogIFlvdSBjYW4gYWxzbyB1c2UgdGhlIHNob3J0aGFuZCBgRW1gIGluc3RlYWQgb2YgYEVtYmVyYC4KCiAgRW1iZXItUnVudGltZSBpcyBhIGZyYW1ld29yayB0aGF0IHByb3ZpZGVzIGNvcmUgZnVuY3Rpb25zIGZvciBFbWJlciBpbmNsdWRpbmcKICBjcm9zcy1wbGF0Zm9ybSBmdW5jdGlvbnMsIHN1cHBvcnQgZm9yIHByb3BlcnR5IG9ic2VydmluZyBhbmQgb2JqZWN0cy4gSXRzCiAgZm9jdXMgaXMgb24gc21hbGwgc2l6ZSBhbmQgcGVyZm9ybWFuY2UuIFlvdSBjYW4gdXNlIHRoaXMgaW4gcGxhY2Ugb2Ygb3IKICBhbG9uZy1zaWRlIG90aGVyIGNyb3NzLXBsYXRmb3JtIGxpYnJhcmllcyBzdWNoIGFzIGpRdWVyeS4KCiAgVGhlIGNvcmUgUnVudGltZSBmcmFtZXdvcmsgaXMgYmFzZWQgb24gdGhlIGpRdWVyeSBBUEkgd2l0aCBhIG51bWJlciBvZgogIHBlcmZvcm1hbmNlIG9wdGltaXphdGlvbnMuCgogIEBjbGFzcyBFbWJlcgogIEBzdGF0aWMKICBAdmVyc2lvbiAxLjMuMQoqLwoKaWYgKCd1bmRlZmluZWQnID09PSB0eXBlb2YgRW1iZXIpIHsKICAvLyBDcmVhdGUgY29yZSBvYmplY3QuIE1ha2UgaXQgYWN0IGxpa2UgYW4gaW5zdGFuY2Ugb2YgRW1iZXIuTmFtZXNwYWNlIHNvIHRoYXQKICAvLyBvYmplY3RzIGFzc2lnbmVkIHRvIGl0IGFyZSBnaXZlbiBhIHNhbmUgc3RyaW5nIHJlcHJlc2VudGF0aW9uLgogIEVtYmVyID0ge307Cn0KCi8vIERlZmF1bHQgaW1wb3J0cywgZXhwb3J0cyBhbmQgbG9va3VwIHRvIHRoZSBnbG9iYWwgb2JqZWN0Owp2YXIgaW1wb3J0cyA9IEVtYmVyLmltcG9ydHMgPSBFbWJlci5pbXBvcnRzIHx8IHRoaXM7CnZhciBleHBvcnRzID0gRW1iZXIuZXhwb3J0cyA9IEVtYmVyLmV4cG9ydHMgfHwgdGhpczsKdmFyIGxvb2t1cCAgPSBFbWJlci5sb29rdXAgID0gRW1iZXIubG9va3VwICB8fCB0aGlzOwoKLy8gYWxpYXNlcyBuZWVkZWQgdG8ga2VlcCBtaW5pZmllcnMgZnJvbSByZW1vdmluZyB0aGUgZ2xvYmFsIGNvbnRleHQKZXhwb3J0cy5FbSA9IGV4cG9ydHMuRW1iZXIgPSBFbSA9IEVtYmVyOwoKLy8gTWFrZSBzdXJlIHRoZXNlIGFyZSBzZXQgd2hldGhlciBFbWJlciB3YXMgYWxyZWFkeSBkZWZpbmVkIG9yIG5vdAoKRW1iZXIuaXNOYW1lc3BhY2UgPSB0cnVlOwoKRW1iZXIudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsgcmV0dXJuICJFbWJlciI7IH07CgoKLyoqCiAgQHByb3BlcnR5IFZFUlNJT04KICBAdHlwZSBTdHJpbmcKICBAZGVmYXVsdCAnMS4zLjEnCiAgQHN0YXRpYwoqLwpFbWJlci5WRVJTSU9OID0gJzEuMy4xJzsKCi8qKgogIFN0YW5kYXJkIGVudmlyb25tZW50YWwgdmFyaWFibGVzLiBZb3UgY2FuIGRlZmluZSB0aGVzZSBpbiBhIGdsb2JhbCBgRW1iZXJFTlZgCiAgdmFyaWFibGUgYmVmb3JlIGxvYWRpbmcgRW1iZXIgdG8gY29udHJvbCB2YXJpb3VzIGNvbmZpZ3VyYXRpb24gc2V0dGluZ3MuCgogIEZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSB3aXRoIGVhcmxpZXIgdmVyc2lvbnMgb2YgRW1iZXIgdGhlIGdsb2JhbCBgRU5WYAogIHZhcmlhYmxlIHdpbGwgYmUgdXNlZCBpZiBgRW1iZXJFTlZgIGlzIG5vdCBkZWZpbmVkLgoKICBAcHJvcGVydHkgRU5WCiAgQHR5cGUgSGFzaAoqLwoKLy8gVGhpcyBuZWVkcyB0byBiZSBrZXB0IGluIHN5bmMgd2l0aCB0aGUgbG9naWMgaW4KLy8gYHBhY2thZ2VzL2VtYmVyLWRlYnVnL2xpYi9tYWluLmpzYC4KaWYgKEVtYmVyLkVOVikgewogIC8vIGRvIG5vdGhpbmcgaWYgRW1iZXIuRU5WIGlzIGFscmVhZHkgc2V0dXAKfSBlbHNlIGlmICgndW5kZWZpbmVkJyAhPT0gdHlwZW9mIEVtYmVyRU5WKSB7CiAgRW1iZXIuRU5WID0gRW1iZXJFTlY7Cn0gZWxzZSBpZigndW5kZWZpbmVkJyAhPT0gdHlwZW9mIEVOVikgewogIEVtYmVyLkVOViA9IEVOVjsKfSBlbHNlIHsKICBFbWJlci5FTlYgPSB7fTsKfQoKRW1iZXIuY29uZmlnID0gRW1iZXIuY29uZmlnIHx8IHt9OwoKLy8gV2UgZGlzYWJsZSB0aGUgUkFOR0UgQVBJIGJ5IGRlZmF1bHQgZm9yIHBlcmZvcm1hbmNlIHJlYXNvbnMKaWYgKCd1bmRlZmluZWQnID09PSB0eXBlb2YgRW1iZXIuRU5WLkRJU0FCTEVfUkFOR0VfQVBJKSB7CiAgRW1iZXIuRU5WLkRJU0FCTEVfUkFOR0VfQVBJID0gdHJ1ZTsKfQoKaWYgKCJ1bmRlZmluZWQiID09PSB0eXBlb2YgTWV0YW1vcnBoRU5WKSB7CiAgZXhwb3J0cy5NZXRhbW9ycGhFTlYgPSB7fTsKfQoKTWV0YW1vcnBoRU5WLkRJU0FCTEVfUkFOR0VfQVBJID0gRW1iZXIuRU5WLkRJU0FCTEVfUkFOR0VfQVBJOwoKLyoqCiAgSGFzaCBvZiBlbmFibGVkIENhbmFyeSBmZWF0dXJlcy4gQWRkIHRvIGJlZm9yZSBjcmVhdGluZyB5b3VyIGFwcGxpY2F0aW9uLgoKICBZb3UgY2FuIGFsc28gZGVmaW5lIGBFTlYuRkVBVFVSRVNgIGlmIHlvdSBuZWVkIHRvIGVuYWJsZSBmZWF0dXJlcyBmbGFnZ2VkIGF0IHJ1bnRpbWUuCgogIEBwcm9wZXJ0eSBGRUFUVVJFUwogIEB0eXBlIEhhc2gKKi8KCkVtYmVyLkZFQVRVUkVTID0gRW1iZXIuRU5WLkZFQVRVUkVTIHx8IHt9OwoKLyoqCiAgVGVzdCB0aGF0IGEgZmVhdHVyZSBpcyBlbmFibGVkLiBQYXJzZWQgYnkgRW1iZXIncyBidWlsZCB0b29scyB0byBsZWF2ZQogIGV4cGVyaW1lbnRhbCBmZWF0dXJlcyBvdXQgb2YgYmV0YS9zdGFibGUgYnVpbGRzLgoKICBZb3UgY2FuIGRlZmluZSB0aGUgZm9sbG93aW5nIGNvbmZpZ3VyYXRpb24gb3B0aW9uczoKCiAgKiBgRU5WLkVOQUJMRV9BTExfRkVBVFVSRVNgIC0gZm9yY2UgYWxsIGZlYXR1cmVzIHRvIGJlIGVuYWJsZWQuCiAgKiBgRU5WLkVOQUJMRV9PUFRJT05BTF9GRUFUVVJFU2AgLSBlbmFibGUgYW55IGZlYXR1cmVzIHRoYXQgaGF2ZSBub3QgYmVlbiBleHBsaWNpdGx5CiAgICBlbmFibGVkL2Rpc2FibGVkLgoKICBAbWV0aG9kIGlzRW5hYmxlZAogIEBwYXJhbSB7c3RyaW5nfSBmZWF0dXJlCiovCgpFbWJlci5GRUFUVVJFUy5pc0VuYWJsZWQgPSBmdW5jdGlvbihmZWF0dXJlKSB7CiAgdmFyIGZlYXR1cmVWYWx1ZSA9IEVtYmVyLkZFQVRVUkVTW2ZlYXR1cmVdOwoKICBpZiAoRW1iZXIuRU5WLkVOQUJMRV9BTExfRkVBVFVSRVMpIHsKICAgIHJldHVybiB0cnVlOwogIH0gZWxzZSBpZiAoZmVhdHVyZVZhbHVlID09PSB0cnVlIHx8IGZlYXR1cmVWYWx1ZSA9PT0gZmFsc2UgfHwgZmVhdHVyZVZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgIHJldHVybiBmZWF0dXJlVmFsdWU7CiAgfSBlbHNlIGlmIChFbWJlci5FTlYuRU5BQkxFX09QVElPTkFMX0ZFQVRVUkVTKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9IGVsc2UgewogICAgcmV0dXJuIGZhbHNlOwogIH0KfTsKCi8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KLy8gQk9PVFNUUkFQCi8vCgovKioKICBEZXRlcm1pbmVzIHdoZXRoZXIgRW1iZXIgc2hvdWxkIGVuaGFuY2VzIHNvbWUgYnVpbHQtaW4gb2JqZWN0IHByb3RvdHlwZXMgdG8KICBwcm92aWRlIGEgbW9yZSBmcmllbmRseSBBUEkuIElmIGVuYWJsZWQsIGEgZmV3IG1ldGhvZHMgd2lsbCBiZSBhZGRlZCB0bwogIGBGdW5jdGlvbmAsIGBTdHJpbmdgLCBhbmQgYEFycmF5YC4gYE9iamVjdC5wcm90b3R5cGVgIHdpbGwgbm90IGJlIGVuaGFuY2VkLAogIHdoaWNoIGlzIHRoZSBvbmUgdGhhdCBjYXVzZXMgbW9zdCB0cm91YmxlIGZvciBwZW9wbGUuCgogIEluIGdlbmVyYWwgd2UgcmVjb21tZW5kIGxlYXZpbmcgdGhpcyBvcHRpb24gc2V0IHRvIHRydWUgc2luY2UgaXQgcmFyZWx5CiAgY29uZmxpY3RzIHdpdGggb3RoZXIgY29kZS4gSWYgeW91IG5lZWQgdG8gdHVybiBpdCBvZmYgaG93ZXZlciwgeW91IGNhbgogIGRlZmluZSBhbiBgRU5WLkVYVEVORF9QUk9UT1RZUEVTYCBjb25maWcgdG8gZGlzYWJsZSBpdC4KCiAgQHByb3BlcnR5IEVYVEVORF9QUk9UT1RZUEVTCiAgQHR5cGUgQm9vbGVhbgogIEBkZWZhdWx0IHRydWUKKi8KRW1iZXIuRVhURU5EX1BST1RPVFlQRVMgPSBFbWJlci5FTlYuRVhURU5EX1BST1RPVFlQRVM7CgppZiAodHlwZW9mIEVtYmVyLkVYVEVORF9QUk9UT1RZUEVTID09PSAndW5kZWZpbmVkJykgewogIEVtYmVyLkVYVEVORF9QUk9UT1RZUEVTID0gdHJ1ZTsKfQoKLyoqCiAgRGV0ZXJtaW5lcyB3aGV0aGVyIEVtYmVyIGxvZ3MgYSBmdWxsIHN0YWNrIHRyYWNlIGR1cmluZyBkZXByZWNhdGlvbiB3YXJuaW5ncwoKICBAcHJvcGVydHkgTE9HX1NUQUNLVFJBQ0VfT05fREVQUkVDQVRJT04KICBAdHlwZSBCb29sZWFuCiAgQGRlZmF1bHQgdHJ1ZQoqLwpFbWJlci5MT0dfU1RBQ0tUUkFDRV9PTl9ERVBSRUNBVElPTiA9IChFbWJlci5FTlYuTE9HX1NUQUNLVFJBQ0VfT05fREVQUkVDQVRJT04gIT09IGZhbHNlKTsKCi8qKgogIERldGVybWluZXMgd2hldGhlciBFbWJlciBzaG91bGQgYWRkIEVDTUFTY3JpcHQgNSBzaGltcyB0byBvbGRlciBicm93c2Vycy4KCiAgQHByb3BlcnR5IFNISU1fRVM1CiAgQHR5cGUgQm9vbGVhbgogIEBkZWZhdWx0IEVtYmVyLkVYVEVORF9QUk9UT1RZUEVTCiovCkVtYmVyLlNISU1fRVM1ID0gKEVtYmVyLkVOVi5TSElNX0VTNSA9PT0gZmFsc2UpID8gZmFsc2UgOiBFbWJlci5FWFRFTkRfUFJPVE9UWVBFUzsKCi8qKgogIERldGVybWluZXMgd2hldGhlciBFbWJlciBsb2dzIGluZm8gYWJvdXQgdmVyc2lvbiBvZiB1c2VkIGxpYnJhcmllcwoKICBAcHJvcGVydHkgTE9HX1ZFUlNJT04KICBAdHlwZSBCb29sZWFuCiAgQGRlZmF1bHQgdHJ1ZQoqLwpFbWJlci5MT0dfVkVSU0lPTiA9IChFbWJlci5FTlYuTE9HX1ZFUlNJT04gPT09IGZhbHNlKSA/IGZhbHNlIDogdHJ1ZTsKCi8qKgogIEVtcHR5IGZ1bmN0aW9uLiBVc2VmdWwgZm9yIHNvbWUgb3BlcmF0aW9ucy4gQWx3YXlzIHJldHVybnMgYHRoaXNgLgoKICBAbWV0aG9kIEsKICBAcHJpdmF0ZQogIEByZXR1cm4ge09iamVjdH0KKi8KRW1iZXIuSyA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpczsgfTsKCgovLyBTdHViIG91dCB0aGUgbWV0aG9kcyBkZWZpbmVkIGJ5IHRoZSBlbWJlci1kZWJ1ZyBwYWNrYWdlIGluIGNhc2UgaXQncyBub3QgbG9hZGVkCgppZiAoJ3VuZGVmaW5lZCcgPT09IHR5cGVvZiBFbWJlci5hc3NlcnQpIHsgRW1iZXIuYXNzZXJ0ID0gRW1iZXIuSzsgfQppZiAoJ3VuZGVmaW5lZCcgPT09IHR5cGVvZiBFbWJlci53YXJuKSB7IEVtYmVyLndhcm4gPSBFbWJlci5LOyB9CmlmICgndW5kZWZpbmVkJyA9PT0gdHlwZW9mIEVtYmVyLmRlYnVnKSB7IEVtYmVyLmRlYnVnID0gRW1iZXIuSzsgfQppZiAoJ3VuZGVmaW5lZCcgPT09IHR5cGVvZiBFbWJlci5kZXByZWNhdGUpIHsgRW1iZXIuZGVwcmVjYXRlID0gRW1iZXIuSzsgfQppZiAoJ3VuZGVmaW5lZCcgPT09IHR5cGVvZiBFbWJlci5kZXByZWNhdGVGdW5jKSB7CiAgRW1iZXIuZGVwcmVjYXRlRnVuYyA9IGZ1bmN0aW9uKF8sIGZ1bmMpIHsgcmV0dXJuIGZ1bmM7IH07Cn0KCi8qKgogIFByZXZpb3VzbHkgd2UgdXNlZCBgRW1iZXIuJC51dWlkYCwgaG93ZXZlciBgJC51dWlkYCBoYXMgYmVlbiByZW1vdmVkIGZyb20KICBqUXVlcnkgbWFzdGVyLiBXZSdsbCBqdXN0IGJvb3RzdHJhcCBvdXIgb3duIHV1aWQgbm93LgoKICBAcHJvcGVydHkgdXVpZAogIEB0eXBlIE51bWJlcgogIEBwcml2YXRlCiovCkVtYmVyLnV1aWQgPSAwOwoKLyoqCiAgTWVyZ2UgdGhlIGNvbnRlbnRzIG9mIHR3byBvYmplY3RzIHRvZ2V0aGVyIGludG8gdGhlIGZpcnN0IG9iamVjdC4KCiAgYGBgamF2YXNjcmlwdAogIEVtYmVyLm1lcmdlKHtmaXJzdDogJ1RvbSd9LCB7bGFzdDogJ0RhbGUnfSk7IC8vIHtmaXJzdDogJ1RvbScsIGxhc3Q6ICdEYWxlJ30KICB2YXIgYSA9IHtmaXJzdDogJ1llaHVkYSd9LCBiID0ge2xhc3Q6ICdLYXR6J307CiAgRW1iZXIubWVyZ2UoYSwgYik7IC8vIGEgPT0ge2ZpcnN0OiAnWWVodWRhJywgbGFzdDogJ0thdHonfSwgYiA9PSB7bGFzdDogJ0thdHonfQogIGBgYAoKICBAbWV0aG9kIG1lcmdlCiAgQGZvciBFbWJlcgogIEBwYXJhbSB7T2JqZWN0fSBvcmlnaW5hbCBUaGUgb2JqZWN0IHRvIG1lcmdlIGludG8KICBAcGFyYW0ge09iamVjdH0gdXBkYXRlcyBUaGUgb2JqZWN0IHRvIGNvcHkgcHJvcGVydGllcyBmcm9tCiAgQHJldHVybiB7T2JqZWN0fQoqLwpFbWJlci5tZXJnZSA9IGZ1bmN0aW9uKG9yaWdpbmFsLCB1cGRhdGVzKSB7CiAgZm9yICh2YXIgcHJvcCBpbiB1cGRhdGVzKSB7CiAgICBpZiAoIXVwZGF0ZXMuaGFzT3duUHJvcGVydHkocHJvcCkpIHsgY29udGludWU7IH0KICAgIG9yaWdpbmFsW3Byb3BdID0gdXBkYXRlc1twcm9wXTsKICB9CiAgcmV0dXJuIG9yaWdpbmFsOwp9OwoKLyoqCiAgUmV0dXJucyB0cnVlIGlmIHRoZSBwYXNzZWQgdmFsdWUgaXMgbnVsbCBvciB1bmRlZmluZWQuIFRoaXMgYXZvaWRzIGVycm9ycwogIGZyb20gSlNMaW50IGNvbXBsYWluaW5nIGFib3V0IHVzZSBvZiA9PSwgd2hpY2ggY2FuIGJlIHRlY2huaWNhbGx5CiAgY29uZnVzaW5nLgoKICBgYGBqYXZhc2NyaXB0CiAgRW1iZXIuaXNOb25lKCk7ICAgICAgICAgICAgICAvLyB0cnVlCiAgRW1iZXIuaXNOb25lKG51bGwpOyAgICAgICAgICAvLyB0cnVlCiAgRW1iZXIuaXNOb25lKHVuZGVmaW5lZCk7ICAgICAvLyB0cnVlCiAgRW1iZXIuaXNOb25lKCcnKTsgICAgICAgICAgICAvLyBmYWxzZQogIEVtYmVyLmlzTm9uZShbXSk7ICAgICAgICAgICAgLy8gZmFsc2UKICBFbWJlci5pc05vbmUoZnVuY3Rpb24oKSB7fSk7ICAvLyBmYWxzZQogIGBgYAoKICBAbWV0aG9kIGlzTm9uZQogIEBmb3IgRW1iZXIKICBAcGFyYW0ge09iamVjdH0gb2JqIFZhbHVlIHRvIHRlc3QKICBAcmV0dXJuIHtCb29sZWFufQoqLwpFbWJlci5pc05vbmUgPSBmdW5jdGlvbihvYmopIHsKICByZXR1cm4gb2JqID09PSBudWxsIHx8IG9iaiA9PT0gdW5kZWZpbmVkOwp9OwpFbWJlci5ub25lID0gRW1iZXIuZGVwcmVjYXRlRnVuYygiRW1iZXIubm9uZSBpcyBkZXByZWNhdGVkLiBQbGVhc2UgdXNlIEVtYmVyLmlzTm9uZSBpbnN0ZWFkLiIsIEVtYmVyLmlzTm9uZSk7CgovKioKICBWZXJpZmllcyB0aGF0IGEgdmFsdWUgaXMgYG51bGxgIG9yIGFuIGVtcHR5IHN0cmluZywgZW1wdHkgYXJyYXksCiAgb3IgZW1wdHkgZnVuY3Rpb24uCgogIENvbnN0cmFpbnMgdGhlIHJ1bGVzIG9uIGBFbWJlci5pc05vbmVgIGJ5IHJldHVybmluZyBmYWxzZSBmb3IgZW1wdHkKICBzdHJpbmcgYW5kIGVtcHR5IGFycmF5cy4KCiAgYGBgamF2YXNjcmlwdAogIEVtYmVyLmlzRW1wdHkoKTsgICAgICAgICAgICAgICAgLy8gdHJ1ZQogIEVtYmVyLmlzRW1wdHkobnVsbCk7ICAgICAgICAgICAgLy8gdHJ1ZQogIEVtYmVyLmlzRW1wdHkodW5kZWZpbmVkKTsgICAgICAgLy8gdHJ1ZQogIEVtYmVyLmlzRW1wdHkoJycpOyAgICAgICAgICAgICAgLy8gdHJ1ZQogIEVtYmVyLmlzRW1wdHkoW10pOyAgICAgICAgICAgICAgLy8gdHJ1ZQogIEVtYmVyLmlzRW1wdHkoJ0FkYW0gSGF3a2lucycpOyAgLy8gZmFsc2UKICBFbWJlci5pc0VtcHR5KFswLDEsMl0pOyAgICAgICAgIC8vIGZhbHNlCiAgYGBgCgogIEBtZXRob2QgaXNFbXB0eQogIEBmb3IgRW1iZXIKICBAcGFyYW0ge09iamVjdH0gb2JqIFZhbHVlIHRvIHRlc3QKICBAcmV0dXJuIHtCb29sZWFufQoqLwpFbWJlci5pc0VtcHR5ID0gZnVuY3Rpb24ob2JqKSB7CiAgcmV0dXJuIEVtYmVyLmlzTm9uZShvYmopIHx8IChvYmoubGVuZ3RoID09PSAwICYmIHR5cGVvZiBvYmogIT09ICdmdW5jdGlvbicpIHx8ICh0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyAmJiBFbWJlci5nZXQob2JqLCAnbGVuZ3RoJykgPT09IDApOwp9OwpFbWJlci5lbXB0eSA9IEVtYmVyLmRlcHJlY2F0ZUZ1bmMoIkVtYmVyLmVtcHR5IGlzIGRlcHJlY2F0ZWQuIFBsZWFzZSB1c2UgRW1iZXIuaXNFbXB0eSBpbnN0ZWFkLiIsIEVtYmVyLmlzRW1wdHkpIDsKCgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qZ2xvYmFscyBOb2RlICovCi8qKgpAbW9kdWxlIGVtYmVyLW1ldGFsCiovCgovKioKICBQbGF0Zm9ybSBzcGVjaWZpYyBtZXRob2RzIGFuZCBmZWF0dXJlIGRldGVjdG9ycyBuZWVkZWQgYnkgdGhlIGZyYW1ld29yay4KCiAgQGNsYXNzIHBsYXRmb3JtCiAgQG5hbWVzcGFjZSBFbWJlcgogIEBzdGF0aWMKKi8KdmFyIHBsYXRmb3JtID0gRW1iZXIucGxhdGZvcm0gPSB7fTsKCgovKioKICBJZGVudGljYWwgdG8gYE9iamVjdC5jcmVhdGUoKWAuIEltcGxlbWVudHMgaWYgbm90IGF2YWlsYWJsZSBuYXRpdmVseS4KCiAgQG1ldGhvZCBjcmVhdGUKICBAZm9yIEVtYmVyCiovCkVtYmVyLmNyZWF0ZSA9IE9iamVjdC5jcmVhdGU7CgovLyBJRTggaGFzIE9iamVjdC5jcmVhdGUgYnV0IGl0IGNvdWxkbid0IHRyZWF0IHByb3BlcnR5IGRlc2NyaXB0b3JzLgppZiAoRW1iZXIuY3JlYXRlKSB7CiAgaWYgKEVtYmVyLmNyZWF0ZSh7YTogMX0sIHthOiB7dmFsdWU6IDJ9fSkuYSAhPT0gMikgewogICAgRW1iZXIuY3JlYXRlID0gbnVsbDsKICB9Cn0KCi8vIFNUVUJfT0JKRUNUX0NSRUFURSBhbGxvd3MgdXMgdG8gb3ZlcnJpZGUgb3RoZXIgbGlicmFyaWVzIHRoYXQgc3R1YgovLyBPYmplY3QuY3JlYXRlIGRpZmZlcmVudCB0aGFuIHdlIHdvdWxkIHByZWZlcgppZiAoIUVtYmVyLmNyZWF0ZSB8fCBFbWJlci5FTlYuU1RVQl9PQkpFQ1RfQ1JFQVRFKSB7CiAgdmFyIEsgPSBmdW5jdGlvbigpIHt9OwoKICBFbWJlci5jcmVhdGUgPSBmdW5jdGlvbihvYmosIHByb3BzKSB7CiAgICBLLnByb3RvdHlwZSA9IG9iajsKICAgIG9iaiA9IG5ldyBLKCk7CiAgICBpZiAocHJvcHMpIHsKICAgICAgSy5wcm90b3R5cGUgPSBvYmo7CiAgICAgIGZvciAodmFyIHByb3AgaW4gcHJvcHMpIHsKICAgICAgICBLLnByb3RvdHlwZVtwcm9wXSA9IHByb3BzW3Byb3BdLnZhbHVlOwogICAgICB9CiAgICAgIG9iaiA9IG5ldyBLKCk7CiAgICB9CiAgICBLLnByb3RvdHlwZSA9IG51bGw7CgogICAgcmV0dXJuIG9iajsKICB9OwoKICBFbWJlci5jcmVhdGUuaXNTaW11bGF0ZWQgPSB0cnVlOwp9Cgp2YXIgZGVmaW5lUHJvcGVydHkgPSBPYmplY3QuZGVmaW5lUHJvcGVydHk7CnZhciBjYW5SZWRlZmluZVByb3BlcnRpZXMsIGNhbkRlZmluZVByb3BlcnR5T25ET007CgovLyBDYXRjaCBJRTggd2hlcmUgT2JqZWN0LmRlZmluZVByb3BlcnR5IGV4aXN0cyBidXQgb25seSB3b3JrcyBvbiBET00gZWxlbWVudHMKaWYgKGRlZmluZVByb3BlcnR5KSB7CiAgdHJ5IHsKICAgIGRlZmluZVByb3BlcnR5KHt9LCAnYScse2dldDpmdW5jdGlvbigpIHt9fSk7CiAgfSBjYXRjaCAoZSkgewogICAgZGVmaW5lUHJvcGVydHkgPSBudWxsOwogIH0KfQoKaWYgKGRlZmluZVByb3BlcnR5KSB7CiAgLy8gRGV0ZWN0cyBhIGJ1ZyBpbiBBbmRyb2lkIDwzLjIgd2hlcmUgeW91IGNhbm5vdCByZWRlZmluZSBhIHByb3BlcnR5IHVzaW5nCiAgLy8gT2JqZWN0LmRlZmluZVByb3BlcnR5IG9uY2UgYWNjZXNzb3JzIGhhdmUgYWxyZWFkeSBiZWVuIHNldC4KICBjYW5SZWRlZmluZVByb3BlcnRpZXMgPSAoZnVuY3Rpb24oKSB7CiAgICB2YXIgb2JqID0ge307CgogICAgZGVmaW5lUHJvcGVydHkob2JqLCAnYScsIHsKICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyB9LAogICAgICBzZXQ6IGZ1bmN0aW9uKCkgeyB9CiAgICB9KTsKCiAgICBkZWZpbmVQcm9wZXJ0eShvYmosICdhJywgewogICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICB2YWx1ZTogdHJ1ZQogICAgfSk7CgogICAgcmV0dXJuIG9iai5hID09PSB0cnVlOwogIH0pKCk7CgogIC8vIFRoaXMgaXMgZm9yIFNhZmFyaSA1LjAsIHdoaWNoIHN1cHBvcnRzIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSwgYnV0IG5vdAogIC8vIG9uIERPTSBub2Rlcy4KICBjYW5EZWZpbmVQcm9wZXJ0eU9uRE9NID0gKGZ1bmN0aW9uKCkgewogICAgdHJ5IHsKICAgICAgZGVmaW5lUHJvcGVydHkoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksICdkZWZpbmVQcm9wZXJ0eU9uRE9NJywge30pOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gY2F0Y2goZSkgeyB9CgogICAgcmV0dXJuIGZhbHNlOwogIH0pKCk7CgogIGlmICghY2FuUmVkZWZpbmVQcm9wZXJ0aWVzKSB7CiAgICBkZWZpbmVQcm9wZXJ0eSA9IG51bGw7CiAgfSBlbHNlIGlmICghY2FuRGVmaW5lUHJvcGVydHlPbkRPTSkgewogICAgZGVmaW5lUHJvcGVydHkgPSBmdW5jdGlvbihvYmosIGtleU5hbWUsIGRlc2MpIHsKICAgICAgdmFyIGlzTm9kZTsKCiAgICAgIGlmICh0eXBlb2YgTm9kZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICBpc05vZGUgPSBvYmogaW5zdGFuY2VvZiBOb2RlOwogICAgICB9IGVsc2UgewogICAgICAgIGlzTm9kZSA9IHR5cGVvZiBvYmogPT09ICJvYmplY3QiICYmIHR5cGVvZiBvYmoubm9kZVR5cGUgPT09ICJudW1iZXIiICYmIHR5cGVvZiBvYmoubm9kZU5hbWUgPT09ICJzdHJpbmciOwogICAgICB9CgogICAgICBpZiAoaXNOb2RlKSB7CiAgICAgICAgLy8gVE9ETzogU2hvdWxkIHdlIGhhdmUgYSB3YXJuaW5nIGhlcmU/CiAgICAgICAgcmV0dXJuIChvYmpba2V5TmFtZV0gPSBkZXNjLnZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5TmFtZSwgZGVzYyk7CiAgICAgIH0KICAgIH07CiAgfQp9CgovKioKQGNsYXNzIHBsYXRmb3JtCkBuYW1lc3BhY2UgRW1iZXIKKi8KCi8qKgogIElkZW50aWNhbCB0byBgT2JqZWN0LmRlZmluZVByb3BlcnR5KClgLiBJbXBsZW1lbnRzIGFzIG11Y2ggZnVuY3Rpb25hbGl0eQogIGFzIHBvc3NpYmxlIGlmIG5vdCBhdmFpbGFibGUgbmF0aXZlbHkuCgogIEBtZXRob2QgZGVmaW5lUHJvcGVydHkKICBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgdG8gbW9kaWZ5CiAgQHBhcmFtIHtTdHJpbmd9IGtleU5hbWUgcHJvcGVydHkgbmFtZSB0byBtb2RpZnkKICBAcGFyYW0ge09iamVjdH0gZGVzYyBkZXNjcmlwdG9yIGhhc2gKICBAcmV0dXJuIHt2b2lkfQoqLwpwbGF0Zm9ybS5kZWZpbmVQcm9wZXJ0eSA9IGRlZmluZVByb3BlcnR5OwoKLyoqCiAgU2V0IHRvIHRydWUgaWYgdGhlIHBsYXRmb3JtIHN1cHBvcnRzIG5hdGl2ZSBnZXR0ZXJzIGFuZCBzZXR0ZXJzLgoKICBAcHJvcGVydHkgaGFzUHJvcGVydHlBY2Nlc3NvcnMKICBAZmluYWwKKi8KcGxhdGZvcm0uaGFzUHJvcGVydHlBY2Nlc3NvcnMgPSB0cnVlOwoKaWYgKCFwbGF0Zm9ybS5kZWZpbmVQcm9wZXJ0eSkgewogIHBsYXRmb3JtLmhhc1Byb3BlcnR5QWNjZXNzb3JzID0gZmFsc2U7CgogIHBsYXRmb3JtLmRlZmluZVByb3BlcnR5ID0gZnVuY3Rpb24ob2JqLCBrZXlOYW1lLCBkZXNjKSB7CiAgICBpZiAoIWRlc2MuZ2V0KSB7IG9ialtrZXlOYW1lXSA9IGRlc2MudmFsdWU7IH0KICB9OwoKICBwbGF0Zm9ybS5kZWZpbmVQcm9wZXJ0eS5pc1NpbXVsYXRlZCA9IHRydWU7Cn0KCmlmIChFbWJlci5FTlYuTUFOREFUT1JZX1NFVFRFUiAmJiAhcGxhdGZvcm0uaGFzUHJvcGVydHlBY2Nlc3NvcnMpIHsKICBFbWJlci5FTlYuTUFOREFUT1JZX1NFVFRFUiA9IGZhbHNlOwp9Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qanNoaW50IG5ld2NhcDpmYWxzZSovCi8qKgpAbW9kdWxlIGVtYmVyLW1ldGFsCiovCgovLyBOT1RFOiBUaGVyZSBpcyBhIGJ1ZyBpbiBqc2hpbnQgdGhhdCBkb2Vzbid0IHJlY29nbml6ZSBgT2JqZWN0KClgIHdpdGhvdXQgYG5ld2AKLy8gYXMgYmVpbmcgb2sgdW5sZXNzIGJvdGggYG5ld2NhcDpmYWxzZWAgYW5kIG5vdCBgdXNlIHN0cmljdGAuCi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qc2hpbnQvanNoaW50L2lzc3Vlcy8zOTIKCi8vIFRlc3RpbmcgdGhpcyBpcyBub3QgaWRlYWwsIGJ1dCB3ZSB3YW50IHRvIHVzZSBuYXRpdmUgZnVuY3Rpb25zCi8vIGlmIGF2YWlsYWJsZSwgYnV0IG5vdCB0byB1c2UgdmVyc2lvbnMgY3JlYXRlZCBieSBsaWJyYXJpZXMgbGlrZSBQcm90b3R5cGUKdmFyIGlzTmF0aXZlRnVuYyA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAvLyBUaGlzIHNob3VsZCBwcm9iYWJseSB3b3JrIGluIGFsbCBicm93c2VycyBsaWtlbHkgdG8gaGF2ZSBFUzUgYXJyYXkgbWV0aG9kcwogIHJldHVybiBmdW5jICYmIEZ1bmN0aW9uLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGZ1bmMpLmluZGV4T2YoJ1tuYXRpdmUgY29kZV0nKSA+IC0xOwp9OwoKLy8gRnJvbTogaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvYXJyYXkvbWFwCnZhciBhcnJheU1hcCA9IGlzTmF0aXZlRnVuYyhBcnJheS5wcm90b3R5cGUubWFwKSA/IEFycmF5LnByb3RvdHlwZS5tYXAgOiBmdW5jdGlvbihmdW4gLyosIHRoaXNwICovKSB7CiAgLy8idXNlIHN0cmljdCI7CgogIGlmICh0aGlzID09PSB2b2lkIDAgfHwgdGhpcyA9PT0gbnVsbCkgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigpOwogIH0KCiAgdmFyIHQgPSBPYmplY3QodGhpcyk7CiAgdmFyIGxlbiA9IHQubGVuZ3RoID4+PiAwOwogIGlmICh0eXBlb2YgZnVuICE9PSAiZnVuY3Rpb24iKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCk7CiAgfQoKICB2YXIgcmVzID0gbmV3IEFycmF5KGxlbik7CiAgdmFyIHRoaXNwID0gYXJndW1lbnRzWzFdOwogIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgIGlmIChpIGluIHQpIHsKICAgICAgcmVzW2ldID0gZnVuLmNhbGwodGhpc3AsIHRbaV0sIGksIHQpOwogICAgfQogIH0KCiAgcmV0dXJuIHJlczsKfTsKCi8vIEZyb206IGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL2FycmF5L2ZvcmVhY2gKdmFyIGFycmF5Rm9yRWFjaCA9IGlzTmF0aXZlRnVuYyhBcnJheS5wcm90b3R5cGUuZm9yRWFjaCkgPyBBcnJheS5wcm90b3R5cGUuZm9yRWFjaCA6IGZ1bmN0aW9uKGZ1biAvKiwgdGhpc3AgKi8pIHsKICAvLyJ1c2Ugc3RyaWN0IjsKCiAgaWYgKHRoaXMgPT09IHZvaWQgMCB8fCB0aGlzID09PSBudWxsKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCk7CiAgfQoKICB2YXIgdCA9IE9iamVjdCh0aGlzKTsKICB2YXIgbGVuID0gdC5sZW5ndGggPj4+IDA7CiAgaWYgKHR5cGVvZiBmdW4gIT09ICJmdW5jdGlvbiIpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoKTsKICB9CgogIHZhciB0aGlzcCA9IGFyZ3VtZW50c1sxXTsKICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICBpZiAoaSBpbiB0KSB7CiAgICAgIGZ1bi5jYWxsKHRoaXNwLCB0W2ldLCBpLCB0KTsKICAgIH0KICB9Cn07Cgp2YXIgYXJyYXlJbmRleE9mID0gaXNOYXRpdmVGdW5jKEFycmF5LnByb3RvdHlwZS5pbmRleE9mKSA/IEFycmF5LnByb3RvdHlwZS5pbmRleE9mIDogZnVuY3Rpb24gKG9iaiwgZnJvbUluZGV4KSB7CiAgaWYgKGZyb21JbmRleCA9PT0gbnVsbCB8fCBmcm9tSW5kZXggPT09IHVuZGVmaW5lZCkgeyBmcm9tSW5kZXggPSAwOyB9CiAgZWxzZSBpZiAoZnJvbUluZGV4IDwgMCkgeyBmcm9tSW5kZXggPSBNYXRoLm1heCgwLCB0aGlzLmxlbmd0aCArIGZyb21JbmRleCk7IH0KICBmb3IgKHZhciBpID0gZnJvbUluZGV4LCBqID0gdGhpcy5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgIGlmICh0aGlzW2ldID09PSBvYmopIHsgcmV0dXJuIGk7IH0KICB9CiAgcmV0dXJuIC0xOwp9OwoKLyoqCiAgQXJyYXkgcG9seWZpbGxzIHRvIHN1cHBvcnQgRVM1IGZlYXR1cmVzIGluIG9sZGVyIGJyb3dzZXJzLgoKICBAbmFtZXNwYWNlIEVtYmVyCiAgQHByb3BlcnR5IEFycmF5UG9seWZpbGxzCiovCkVtYmVyLkFycmF5UG9seWZpbGxzID0gewogIG1hcDogYXJyYXlNYXAsCiAgZm9yRWFjaDogYXJyYXlGb3JFYWNoLAogIGluZGV4T2Y6IGFycmF5SW5kZXhPZgp9OwoKaWYgKEVtYmVyLlNISU1fRVM1KSB7CiAgaWYgKCFBcnJheS5wcm90b3R5cGUubWFwKSB7CiAgICBBcnJheS5wcm90b3R5cGUubWFwID0gYXJyYXlNYXA7CiAgfQoKICBpZiAoIUFycmF5LnByb3RvdHlwZS5mb3JFYWNoKSB7CiAgICBBcnJheS5wcm90b3R5cGUuZm9yRWFjaCA9IGFycmF5Rm9yRWFjaDsKICB9CgogIGlmICghQXJyYXkucHJvdG90eXBlLmluZGV4T2YpIHsKICAgIEFycmF5LnByb3RvdHlwZS5pbmRleE9mID0gYXJyYXlJbmRleE9mOwogIH0KfQoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewp2YXIgZXJyb3JQcm9wcyA9IFsnZGVzY3JpcHRpb24nLCAnZmlsZU5hbWUnLCAnbGluZU51bWJlcicsICdtZXNzYWdlJywgJ25hbWUnLCAnbnVtYmVyJywgJ3N0YWNrJ107CgovKioKICBBIHN1YmNsYXNzIG9mIHRoZSBKYXZhU2NyaXB0IEVycm9yIG9iamVjdCBmb3IgdXNlIGluIEVtYmVyLgoKICBAY2xhc3MgRXJyb3IKICBAbmFtZXNwYWNlIEVtYmVyCiAgQGV4dGVuZHMgRXJyb3IKICBAY29uc3RydWN0b3IKKi8KRW1iZXIuRXJyb3IgPSBmdW5jdGlvbigpIHsKICB2YXIgdG1wID0gRXJyb3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgLy8gQWRkcyBhIGBzdGFja2AgcHJvcGVydHkgdG8gdGhlIGdpdmVuIGVycm9yIG9iamVjdCB0aGF0IHdpbGwgeWllbGQgdGhlCiAgLy8gc3RhY2sgdHJhY2UgYXQgdGhlIHRpbWUgY2FwdHVyZVN0YWNrVHJhY2Ugd2FzIGNhbGxlZC4KICAvLyBXaGVuIGNvbGxlY3RpbmcgdGhlIHN0YWNrIHRyYWNlIGFsbCBmcmFtZXMgYWJvdmUgdGhlIHRvcG1vc3QgY2FsbAogIC8vIHRvIHRoaXMgZnVuY3Rpb24sIGluY2x1ZGluZyB0aGF0IGNhbGwsIHdpbGwgYmUgbGVmdCBvdXQgb2YgdGhlCiAgLy8gc3RhY2sgdHJhY2UuCiAgLy8gVGhpcyBpcyB1c2VmdWwgYmVjYXVzZSB3ZSBjYW4gaGlkZSBFbWJlciBpbXBsZW1lbnRhdGlvbiBkZXRhaWxzCiAgLy8gdGhhdCBhcmUgbm90IHZlcnkgaGVscGZ1bCBmb3IgdGhlIHVzZXIuCiAgaWYgKEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKSB7CiAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCBFbWJlci5FcnJvcik7CiAgfQogIC8vIFVuZm9ydHVuYXRlbHkgZXJyb3JzIGFyZSBub3QgZW51bWVyYWJsZSBpbiBDaHJvbWUgKGF0IGxlYXN0KSwgc28gYGZvciBwcm9wIGluIHRtcGAgZG9lc24ndCB3b3JrLgogIGZvciAodmFyIGlkeCA9IDA7IGlkeCA8IGVycm9yUHJvcHMubGVuZ3RoOyBpZHgrKykgewogICAgdGhpc1tlcnJvclByb3BzW2lkeF1dID0gdG1wW2Vycm9yUHJvcHNbaWR4XV07CiAgfQp9OwoKRW1iZXIuRXJyb3IucHJvdG90eXBlID0gRW1iZXIuY3JlYXRlKEVycm9yLnByb3RvdHlwZSk7CgovLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCi8vIEVSUk9SIEhBTkRMSU5HCi8vCgovKioKICBBIGZ1bmN0aW9uIG1heSBiZSBhc3NpZ25lZCB0byBgRW1iZXIub25lcnJvcmAgdG8gYmUgY2FsbGVkIHdoZW4gRW1iZXIKICBpbnRlcm5hbHMgZW5jb3VudGVyIGFuIGVycm9yLiBUaGlzIGlzIHVzZWZ1bCBmb3Igc3BlY2lhbGl6ZWQgZXJyb3IgaGFuZGxpbmcKICBhbmQgcmVwb3J0aW5nIGNvZGUuCgogIGBgYGphdmFzY3JpcHQKICBFbWJlci5vbmVycm9yID0gZnVuY3Rpb24oZXJyb3IpIHsKICAgIEVtLiQuYWpheCgnL3JlcG9ydC1lcnJvcicsICdQT1NUJywgewogICAgICBzdGFjazogZXJyb3Iuc3RhY2ssCiAgICAgIG90aGVySW5mb3JtYXRpb246ICd3aGF0ZXZlciBhcHAgc3RhdGUgeW91IHdhbnQgdG8gcHJvdmlkZScKICAgIH0pOwogIH07CiAgYGBgCgogIEBldmVudCBvbmVycm9yCiAgQGZvciBFbWJlcgogIEBwYXJhbSB7RXhjZXB0aW9ufSBlcnJvciB0aGUgZXJyb3Igb2JqZWN0CiovCkVtYmVyLm9uZXJyb3IgPSBudWxsOwoKLyoqCiAgV3JhcCBjb2RlIGJsb2NrIGluIGEgdHJ5L2NhdGNoIGlmIGBFbWJlci5vbmVycm9yYCBpcyBzZXQuCgogIEBwcml2YXRlCiAgQG1ldGhvZCBoYW5kbGVFcnJvcnMKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtGdW5jdGlvbn0gZnVuYwogIEBwYXJhbSBbY29udGV4dF0KKi8KRW1iZXIuaGFuZGxlRXJyb3JzID0gZnVuY3Rpb24oZnVuYywgY29udGV4dCkgewogIC8vIFVuZm9ydHVuYXRlbHkgaW4gc29tZSBicm93c2VycyB3ZSBsb3NlIHRoZSBiYWNrdHJhY2UgaWYgd2UgcmV0aHJvdyB0aGUgZXhpc3RpbmcgZXJyb3IsCiAgLy8gc28gaW4gdGhlIGV2ZW50IHRoYXQgd2UgZG9uJ3QgaGF2ZSBhbiBgb25lcnJvcmAgaGFuZGxlciB3ZSBkb24ndCB3cmFwIGluIGEgdHJ5L2NhdGNoCiAgaWYgKCdmdW5jdGlvbicgPT09IHR5cGVvZiBFbWJlci5vbmVycm9yKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gZnVuYy5jYWxsKGNvbnRleHQgfHwgdGhpcyk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBFbWJlci5vbmVycm9yKGVycm9yKTsKICAgIH0KICB9IGVsc2UgewogICAgcmV0dXJuIGZ1bmMuY2FsbChjb250ZXh0IHx8IHRoaXMpOwogIH0KfTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXItbWV0YWwKKi8KCi8qKgogIFByZWZpeCB1c2VkIGZvciBndWlkcyB0aHJvdWdoIG91dCBFbWJlci4KICBAcHJpdmF0ZQoqLwpFbWJlci5HVUlEX1BSRUZJWCA9ICdlbWJlcic7CgoKdmFyIG9fZGVmaW5lUHJvcGVydHkgPSBFbWJlci5wbGF0Zm9ybS5kZWZpbmVQcm9wZXJ0eSwKICAgIG9fY3JlYXRlID0gRW1iZXIuY3JlYXRlLAogICAgLy8gVXNlZCBmb3IgZ3VpZCBnZW5lcmF0aW9uLi4uCiAgICBHVUlEX0tFWSA9ICdfX2VtYmVyJysgKCsgbmV3IERhdGUoKSksCiAgICB1dWlkICAgICAgICAgPSAwLAogICAgbnVtYmVyQ2FjaGUgID0gW10sCiAgICBzdHJpbmdDYWNoZSAgPSB7fTsKCnZhciBNQU5EQVRPUllfU0VUVEVSID0gRW1iZXIuRU5WLk1BTkRBVE9SWV9TRVRURVI7CgovKioKICBBIHVuaXF1ZSBrZXkgdXNlZCB0byBhc3NpZ24gZ3VpZHMgYW5kIG90aGVyIHByaXZhdGUgbWV0YWRhdGEgdG8gb2JqZWN0cy4KICBJZiB5b3UgaW5zcGVjdCBhbiBvYmplY3QgaW4geW91ciBicm93c2VyIGRlYnVnZ2VyIHlvdSB3aWxsIG9mdGVuIHNlZSB0aGVzZS4KICBUaGV5IGNhbiBiZSBzYWZlbHkgaWdub3JlZC4KCiAgT24gYnJvd3NlcnMgdGhhdCBzdXBwb3J0IGl0LCB0aGVzZSBwcm9wZXJ0aWVzIGFyZSBhZGRlZCB3aXRoIGVudW1lcmF0aW9uCiAgZGlzYWJsZWQgc28gdGhleSB3b24ndCBzaG93IHVwIHdoZW4geW91IGl0ZXJhdGUgb3ZlciB5b3VyIHByb3BlcnRpZXMuCgogIEBwcml2YXRlCiAgQHByb3BlcnR5IEdVSURfS0VZCiAgQGZvciBFbWJlcgogIEB0eXBlIFN0cmluZwogIEBmaW5hbAoqLwpFbWJlci5HVUlEX0tFWSA9IEdVSURfS0VZOwoKdmFyIEdVSURfREVTQyA9IHsKICB3cml0YWJsZTogICAgZmFsc2UsCiAgY29uZmlndXJhYmxlOiBmYWxzZSwKICBlbnVtZXJhYmxlOiAgZmFsc2UsCiAgdmFsdWU6IG51bGwKfTsKCi8qKgogIEdlbmVyYXRlcyBhIG5ldyBndWlkLCBvcHRpb25hbGx5IHNhdmluZyB0aGUgZ3VpZCB0byB0aGUgb2JqZWN0IHRoYXQgeW91CiAgcGFzcyBpbi4gWW91IHdpbGwgcmFyZWx5IG5lZWQgdG8gdXNlIHRoaXMgbWV0aG9kLiBJbnN0ZWFkIHlvdSBzaG91bGQKICBjYWxsIGBFbWJlci5ndWlkRm9yKG9iailgLCB3aGljaCByZXR1cm4gYW4gZXhpc3RpbmcgZ3VpZCBpZiBhdmFpbGFibGUuCgogIEBwcml2YXRlCiAgQG1ldGhvZCBnZW5lcmF0ZUd1aWQKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtPYmplY3R9IFtvYmpdIE9iamVjdCB0aGUgZ3VpZCB3aWxsIGJlIHVzZWQgZm9yLiBJZiBwYXNzZWQgaW4sIHRoZSBndWlkIHdpbGwKICAgIGJlIHNhdmVkIG9uIHRoZSBvYmplY3QgYW5kIHJldXNlZCB3aGVuZXZlciB5b3UgcGFzcyB0aGUgc2FtZSBvYmplY3QKICAgIGFnYWluLgoKICAgIElmIG5vIG9iamVjdCBpcyBwYXNzZWQsIGp1c3QgZ2VuZXJhdGUgYSBuZXcgZ3VpZC4KICBAcGFyYW0ge1N0cmluZ30gW3ByZWZpeF0gUHJlZml4IHRvIHBsYWNlIGluIGZyb250IG9mIHRoZSBndWlkLiBVc2VmdWwgd2hlbiB5b3Ugd2FudCB0bwogICAgc2VwYXJhdGUgdGhlIGd1aWQgaW50byBzZXBhcmF0ZSBuYW1lc3BhY2VzLgogIEByZXR1cm4ge1N0cmluZ30gdGhlIGd1aWQKKi8KRW1iZXIuZ2VuZXJhdGVHdWlkID0gZnVuY3Rpb24gZ2VuZXJhdGVHdWlkKG9iaiwgcHJlZml4KSB7CiAgaWYgKCFwcmVmaXgpIHByZWZpeCA9IEVtYmVyLkdVSURfUFJFRklYOwogIHZhciByZXQgPSAocHJlZml4ICsgKHV1aWQrKykpOwogIGlmIChvYmopIHsKICAgIEdVSURfREVTQy52YWx1ZSA9IHJldDsKICAgIG9fZGVmaW5lUHJvcGVydHkob2JqLCBHVUlEX0tFWSwgR1VJRF9ERVNDKTsKICB9CiAgcmV0dXJuIHJldDsKfTsKCi8qKgogIFJldHVybnMgYSB1bmlxdWUgaWQgZm9yIHRoZSBvYmplY3QuIElmIHRoZSBvYmplY3QgZG9lcyBub3QgeWV0IGhhdmUgYSBndWlkLAogIG9uZSB3aWxsIGJlIGFzc2lnbmVkIHRvIGl0LiBZb3UgY2FuIGNhbGwgdGhpcyBvbiBhbnkgb2JqZWN0LAogIGBFbWJlci5PYmplY3RgLWJhc2VkIG9yIG5vdCwgYnV0IGJlIGF3YXJlIHRoYXQgaXQgd2lsbCBhZGQgYSBgX2d1aWRgCiAgcHJvcGVydHkuCgogIFlvdSBjYW4gYWxzbyB1c2UgdGhpcyBtZXRob2Qgb24gRE9NIEVsZW1lbnQgb2JqZWN0cy4KCiAgQHByaXZhdGUKICBAbWV0aG9kIGd1aWRGb3IKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtPYmplY3R9IG9iaiBhbnkgb2JqZWN0LCBzdHJpbmcsIG51bWJlciwgRWxlbWVudCwgb3IgcHJpbWl0aXZlCiAgQHJldHVybiB7U3RyaW5nfSB0aGUgdW5pcXVlIGd1aWQgZm9yIHRoaXMgaW5zdGFuY2UuCiovCkVtYmVyLmd1aWRGb3IgPSBmdW5jdGlvbiBndWlkRm9yKG9iaikgewoKICAvLyBzcGVjaWFsIGNhc2VzIHdoZXJlIHdlIGRvbid0IHdhbnQgdG8gYWRkIGEga2V5IHRvIG9iamVjdAogIGlmIChvYmogPT09IHVuZGVmaW5lZCkgcmV0dXJuICIodW5kZWZpbmVkKSI7CiAgaWYgKG9iaiA9PT0gbnVsbCkgcmV0dXJuICIobnVsbCkiOwoKICB2YXIgcmV0OwogIHZhciB0eXBlID0gdHlwZW9mIG9iajsKCiAgLy8gRG9uJ3QgYWxsb3cgcHJvdG90eXBlIGNoYW5nZXMgdG8gU3RyaW5nIGV0Yy4gdG8gY2hhbmdlIHRoZSBndWlkRm9yCiAgc3dpdGNoKHR5cGUpIHsKICAgIGNhc2UgJ251bWJlcic6CiAgICAgIHJldCA9IG51bWJlckNhY2hlW29ial07CiAgICAgIGlmICghcmV0KSByZXQgPSBudW1iZXJDYWNoZVtvYmpdID0gJ251JytvYmo7CiAgICAgIHJldHVybiByZXQ7CgogICAgY2FzZSAnc3RyaW5nJzoKICAgICAgcmV0ID0gc3RyaW5nQ2FjaGVbb2JqXTsKICAgICAgaWYgKCFyZXQpIHJldCA9IHN0cmluZ0NhY2hlW29ial0gPSAnc3QnKyh1dWlkKyspOwogICAgICByZXR1cm4gcmV0OwoKICAgIGNhc2UgJ2Jvb2xlYW4nOgogICAgICByZXR1cm4gb2JqID8gJyh0cnVlKScgOiAnKGZhbHNlKSc7CgogICAgZGVmYXVsdDoKICAgICAgaWYgKG9ialtHVUlEX0tFWV0pIHJldHVybiBvYmpbR1VJRF9LRVldOwogICAgICBpZiAob2JqID09PSBPYmplY3QpIHJldHVybiAnKE9iamVjdCknOwogICAgICBpZiAob2JqID09PSBBcnJheSkgIHJldHVybiAnKEFycmF5KSc7CiAgICAgIHJldCA9ICdlbWJlcicrKHV1aWQrKyk7CiAgICAgIEdVSURfREVTQy52YWx1ZSA9IHJldDsKICAgICAgb19kZWZpbmVQcm9wZXJ0eShvYmosIEdVSURfS0VZLCBHVUlEX0RFU0MpOwogICAgICByZXR1cm4gcmV0OwogIH0KfTsKCi8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KLy8gTUVUQQovLwoKdmFyIE1FVEFfREVTQyA9IHsKICB3cml0YWJsZTogICAgdHJ1ZSwKICBjb25maWd1cmFibGU6IGZhbHNlLAogIGVudW1lcmFibGU6ICBmYWxzZSwKICB2YWx1ZTogbnVsbAp9OwoKdmFyIE1FVEFfS0VZID0gRW1iZXIuR1VJRF9LRVkrJ19tZXRhJzsKCi8qKgogIFRoZSBrZXkgdXNlZCB0byBzdG9yZSBtZXRhIGluZm9ybWF0aW9uIG9uIG9iamVjdCBmb3IgcHJvcGVydHkgb2JzZXJ2aW5nLgoKICBAcHJvcGVydHkgTUVUQV9LRVkKICBAZm9yIEVtYmVyCiAgQHByaXZhdGUKICBAZmluYWwKICBAdHlwZSBTdHJpbmcKKi8KRW1iZXIuTUVUQV9LRVkgPSBNRVRBX0tFWTsKCnZhciBpc0RlZmluZVByb3BlcnR5U2ltdWxhdGVkID0gRW1iZXIucGxhdGZvcm0uZGVmaW5lUHJvcGVydHkuaXNTaW11bGF0ZWQ7CgpmdW5jdGlvbiBNZXRhKG9iaikgewogIHRoaXMuZGVzY3MgPSB7fTsKICB0aGlzLndhdGNoaW5nID0ge307CiAgdGhpcy5jYWNoZSA9IHt9OwogIHRoaXMuc291cmNlID0gb2JqOwp9CgpNZXRhLnByb3RvdHlwZSA9IHsKICBkZXNjczogbnVsbCwKICBkZXBzOiBudWxsLAogIHdhdGNoaW5nOiBudWxsLAogIGxpc3RlbmVyczogbnVsbCwKICBjYWNoZTogbnVsbCwKICBzb3VyY2U6IG51bGwsCiAgbWl4aW5zOiBudWxsLAogIGJpbmRpbmdzOiBudWxsLAogIGNoYWluczogbnVsbCwKICBjaGFpbldhdGNoZXJzOiBudWxsLAogIHZhbHVlczogbnVsbAp9OwoKaWYgKGlzRGVmaW5lUHJvcGVydHlTaW11bGF0ZWQpIHsKICAvLyBvbiBwbGF0Zm9ybXMgdGhhdCBkb24ndCBzdXBwb3J0IGVudW1lcmFibGUgZmFsc2UKICAvLyBtYWtlIG1ldGEgZmFpbCBqUXVlcnkuaXNQbGFpbk9iamVjdCgpIHRvIGhpZGUgZnJvbQogIC8vIGpRdWVyeS5leHRlbmQoKSBieSBoYXZpbmcgYSBwcm9wZXJ0eSB0aGF0IGZhaWxzCiAgLy8gaGFzT3duUHJvcGVydHkgY2hlY2suCiAgTWV0YS5wcm90b3R5cGUuX19wcmV2ZW50UGxhaW5PYmplY3RfXyA9IHRydWU7CgogIC8vIFdpdGhvdXQgbm9uLWVudW1lcmFibGUgcHJvcGVydGllcywgbWV0YSBvYmplY3RzIHdpbGwgYmUgb3V0cHV0IGluIEpTT04KICAvLyB1bmxlc3MgZXhwbGljaXRseSBzdXBwcmVzc2VkCiAgTWV0YS5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24gKCkgeyB9Owp9CgovLyBQbGFjZWhvbGRlciBmb3Igbm9uLXdyaXRhYmxlIG1ldGFzLgp2YXIgRU1QVFlfTUVUQSA9IG5ldyBNZXRhKG51bGwpOwoKaWYgKE1BTkRBVE9SWV9TRVRURVIpIHsgRU1QVFlfTUVUQS52YWx1ZXMgPSB7fTsgfQoKRW1iZXIuRU1QVFlfTUVUQSA9IEVNUFRZX01FVEE7CgovKioKICBSZXRyaWV2ZXMgdGhlIG1ldGEgaGFzaCBmb3IgYW4gb2JqZWN0LiBJZiBgd3JpdGFibGVgIGlzIHRydWUgZW5zdXJlcyB0aGUKICBoYXNoIGlzIHdyaXRhYmxlIGZvciB0aGlzIG9iamVjdCBhcyB3ZWxsLgoKICBUaGUgbWV0YSBvYmplY3QgY29udGFpbnMgaW5mb3JtYXRpb24gYWJvdXQgY29tcHV0ZWQgcHJvcGVydHkgZGVzY3JpcHRvcnMgYXMKICB3ZWxsIGFzIGFueSB3YXRjaGVkIHByb3BlcnRpZXMgYW5kIG90aGVyIGluZm9ybWF0aW9uLiBZb3UgZ2VuZXJhbGx5IHdpbGwKICBub3QgYWNjZXNzIHRoaXMgaW5mb3JtYXRpb24gZGlyZWN0bHkgYnV0IGluc3RlYWQgd29yayB3aXRoIGhpZ2hlciBsZXZlbAogIG1ldGhvZHMgdGhhdCBtYW5pcHVsYXRlIHRoaXMgaGFzaCBpbmRpcmVjdGx5LgoKICBAbWV0aG9kIG1ldGEKICBAZm9yIEVtYmVyCiAgQHByaXZhdGUKCiAgQHBhcmFtIHtPYmplY3R9IG9iaiBUaGUgb2JqZWN0IHRvIHJldHJpZXZlIG1ldGEgZm9yCiAgQHBhcmFtIHtCb29sZWFufSBbd3JpdGFibGU9dHJ1ZV0gUGFzcyBgZmFsc2VgIGlmIHlvdSBkbyBub3QgaW50ZW5kIHRvIG1vZGlmeQogICAgdGhlIG1ldGEgaGFzaCwgYWxsb3dpbmcgdGhlIG1ldGhvZCB0byBhdm9pZCBtYWtpbmcgYW4gdW5uZWNlc3NhcnkgY29weS4KICBAcmV0dXJuIHtPYmplY3R9IHRoZSBtZXRhIGhhc2ggZm9yIGFuIG9iamVjdAoqLwpFbWJlci5tZXRhID0gZnVuY3Rpb24gbWV0YShvYmosIHdyaXRhYmxlKSB7CgogIHZhciByZXQgPSBvYmpbTUVUQV9LRVldOwogIGlmICh3cml0YWJsZT09PWZhbHNlKSByZXR1cm4gcmV0IHx8IEVNUFRZX01FVEE7CgogIGlmICghcmV0KSB7CiAgICBpZiAoIWlzRGVmaW5lUHJvcGVydHlTaW11bGF0ZWQpIG9fZGVmaW5lUHJvcGVydHkob2JqLCBNRVRBX0tFWSwgTUVUQV9ERVNDKTsKCiAgICByZXQgPSBuZXcgTWV0YShvYmopOwoKICAgIGlmIChNQU5EQVRPUllfU0VUVEVSKSB7IHJldC52YWx1ZXMgPSB7fTsgfQoKICAgIG9ialtNRVRBX0tFWV0gPSByZXQ7CgogICAgLy8gbWFrZSBzdXJlIHdlIGRvbid0IGFjY2lkZW50YWxseSB0cnkgdG8gY3JlYXRlIGNvbnN0cnVjdG9yIGxpa2UgZGVzYwogICAgcmV0LmRlc2NzLmNvbnN0cnVjdG9yID0gbnVsbDsKCiAgfSBlbHNlIGlmIChyZXQuc291cmNlICE9PSBvYmopIHsKICAgIGlmICghaXNEZWZpbmVQcm9wZXJ0eVNpbXVsYXRlZCkgb19kZWZpbmVQcm9wZXJ0eShvYmosIE1FVEFfS0VZLCBNRVRBX0RFU0MpOwoKICAgIHJldCA9IG9fY3JlYXRlKHJldCk7CiAgICByZXQuZGVzY3MgICAgPSBvX2NyZWF0ZShyZXQuZGVzY3MpOwogICAgcmV0LndhdGNoaW5nID0gb19jcmVhdGUocmV0LndhdGNoaW5nKTsKICAgIHJldC5jYWNoZSAgICA9IHt9OwogICAgcmV0LnNvdXJjZSAgID0gb2JqOwoKICAgIGlmIChNQU5EQVRPUllfU0VUVEVSKSB7IHJldC52YWx1ZXMgPSBvX2NyZWF0ZShyZXQudmFsdWVzKTsgfQoKICAgIG9ialtNRVRBX0tFWV0gPSByZXQ7CiAgfQogIHJldHVybiByZXQ7Cn07CgpFbWJlci5nZXRNZXRhID0gZnVuY3Rpb24gZ2V0TWV0YShvYmosIHByb3BlcnR5KSB7CiAgdmFyIG1ldGEgPSBFbWJlci5tZXRhKG9iaiwgZmFsc2UpOwogIHJldHVybiBtZXRhW3Byb3BlcnR5XTsKfTsKCkVtYmVyLnNldE1ldGEgPSBmdW5jdGlvbiBzZXRNZXRhKG9iaiwgcHJvcGVydHksIHZhbHVlKSB7CiAgdmFyIG1ldGEgPSBFbWJlci5tZXRhKG9iaiwgdHJ1ZSk7CiAgbWV0YVtwcm9wZXJ0eV0gPSB2YWx1ZTsKICByZXR1cm4gdmFsdWU7Cn07CgovKioKICBAZGVwcmVjYXRlZAogIEBwcml2YXRlCgogIEluIG9yZGVyIHRvIHN0b3JlIGRlZmF1bHRzIGZvciBhIGNsYXNzLCBhIHByb3RvdHlwZSBtYXkgbmVlZCB0byBjcmVhdGUKICBhIGRlZmF1bHQgbWV0YSBvYmplY3QsIHdoaWNoIHdpbGwgYmUgaW5oZXJpdGVkIGJ5IGFueSBvYmplY3RzIGluc3RhbnRpYXRlZAogIGZyb20gdGhlIGNsYXNzJ3MgY29uc3RydWN0b3IuCgogIEhvd2V2ZXIsIHRoZSBwcm9wZXJ0aWVzIG9mIHRoYXQgbWV0YSBvYmplY3QgYXJlIG9ubHkgc2hhbGxvdy1jbG9uZWQsCiAgc28gaWYgYSBwcm9wZXJ0eSBpcyBhIGhhc2ggKGxpa2UgdGhlIGV2ZW50IHN5c3RlbSdzIGBsaXN0ZW5lcnNgIGhhc2gpLAogIGl0IHdpbGwgYnkgZGVmYXVsdCBiZSBzaGFyZWQgYWNyb3NzIGFsbCBpbnN0YW5jZXMgb2YgdGhhdCBjbGFzcy4KCiAgVGhpcyBtZXRob2QgYWxsb3dzIGV4dGVuc2lvbnMgdG8gZGVlcGx5IGNsb25lIGEgc2VyaWVzIG9mIG5lc3RlZCBoYXNoZXMgb3IKICBvdGhlciBjb21wbGV4IG9iamVjdHMuIEZvciBpbnN0YW5jZSwgdGhlIGV2ZW50IHN5c3RlbSBtaWdodCBwYXNzCiAgYFsnbGlzdGVuZXJzJywgJ2ZvbzpjaGFuZ2UnLCAnZW1iZXIxNTcnXWAgdG8gYHByZXBhcmVNZXRhUGF0aGAsIHdoaWNoIHdpbGwKICB3YWxrIGRvd24gdGhlIGtleXMgcHJvdmlkZWQuCgogIEZvciBlYWNoIGtleSwgaWYgdGhlIGtleSBkb2VzIG5vdCBleGlzdCwgaXQgaXMgY3JlYXRlZC4gSWYgaXQgYWxyZWFkeQogIGV4aXN0cyBhbmQgaXQgd2FzIGluaGVyaXRlZCBmcm9tIGl0cyBjb25zdHJ1Y3RvciwgdGhlIGNvbnN0cnVjdG9yJ3MKICBrZXkgaXMgY2xvbmVkLgoKICBZb3UgY2FuIGFsc28gcGFzcyBmYWxzZSBmb3IgYHdyaXRhYmxlYCwgd2hpY2ggd2lsbCBzaW1wbHkgcmV0dXJuCiAgdW5kZWZpbmVkIGlmIGBwcmVwYXJlTWV0YVBhdGhgIGRpc2NvdmVycyBhbnkgcGFydCBvZiB0aGUgcGF0aCB0aGF0CiAgc2hhcmVkIG9yIHVuZGVmaW5lZC4KCiAgQG1ldGhvZCBtZXRhUGF0aAogIEBmb3IgRW1iZXIKICBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3Qgd2hvc2UgbWV0YSB3ZSBhcmUgZXhhbWluaW5nCiAgQHBhcmFtIHtBcnJheX0gcGF0aCBBbiBhcnJheSBvZiBrZXlzIHRvIHdhbGsgZG93bgogIEBwYXJhbSB7Qm9vbGVhbn0gd3JpdGFibGUgd2hldGhlciBvciBub3QgdG8gY3JlYXRlIGEgbmV3IG1ldGEKICAgIChvciBtZXRhIHByb3BlcnR5KSBpZiBvbmUgZG9lcyBub3QgYWxyZWFkeSBleGlzdCBvciBpZiBpdCdzCiAgICBzaGFyZWQgd2l0aCBpdHMgY29uc3RydWN0b3IKKi8KRW1iZXIubWV0YVBhdGggPSBmdW5jdGlvbiBtZXRhUGF0aChvYmosIHBhdGgsIHdyaXRhYmxlKSB7CiAgRW1iZXIuZGVwcmVjYXRlKCJFbWJlci5tZXRhUGF0aCBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgZnJvbSBmdXR1cmUgcmVsZWFzZXMuIik7CiAgdmFyIG1ldGEgPSBFbWJlci5tZXRhKG9iaiwgd3JpdGFibGUpLCBrZXlOYW1lLCB2YWx1ZTsKCiAgZm9yICh2YXIgaT0wLCBsPXBhdGgubGVuZ3RoOyBpPGw7IGkrKykgewogICAga2V5TmFtZSA9IHBhdGhbaV07CiAgICB2YWx1ZSA9IG1ldGFba2V5TmFtZV07CgogICAgaWYgKCF2YWx1ZSkgewogICAgICBpZiAoIXdyaXRhYmxlKSB7IHJldHVybiB1bmRlZmluZWQ7IH0KICAgICAgdmFsdWUgPSBtZXRhW2tleU5hbWVdID0geyBfX2VtYmVyX3NvdXJjZV9fOiBvYmogfTsKICAgIH0gZWxzZSBpZiAodmFsdWUuX19lbWJlcl9zb3VyY2VfXyAhPT0gb2JqKSB7CiAgICAgIGlmICghd3JpdGFibGUpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfQogICAgICB2YWx1ZSA9IG1ldGFba2V5TmFtZV0gPSBvX2NyZWF0ZSh2YWx1ZSk7CiAgICAgIHZhbHVlLl9fZW1iZXJfc291cmNlX18gPSBvYmo7CiAgICB9CgogICAgbWV0YSA9IHZhbHVlOwogIH0KCiAgcmV0dXJuIHZhbHVlOwp9OwoKLyoqCiAgV3JhcHMgdGhlIHBhc3NlZCBmdW5jdGlvbiBzbyB0aGF0IGB0aGlzLl9zdXBlcmAgd2lsbCBwb2ludCB0byB0aGUgc3VwZXJGdW5jCiAgd2hlbiB0aGUgZnVuY3Rpb24gaXMgaW52b2tlZC4gVGhpcyBpcyB0aGUgcHJpbWl0aXZlIHdlIHVzZSB0byBpbXBsZW1lbnQKICBjYWxscyB0byBzdXBlci4KCiAgQHByaXZhdGUKICBAbWV0aG9kIHdyYXAKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gY2FsbAogIEBwYXJhbSB7RnVuY3Rpb259IHN1cGVyRnVuYyBUaGUgc3VwZXIgZnVuY3Rpb24uCiAgQHJldHVybiB7RnVuY3Rpb259IHdyYXBwZWQgZnVuY3Rpb24uCiovCkVtYmVyLndyYXAgPSBmdW5jdGlvbihmdW5jLCBzdXBlckZ1bmMpIHsKICBmdW5jdGlvbiBLKCkge30KCiAgZnVuY3Rpb24gc3VwZXJXcmFwcGVyKCkgewogICAgdmFyIHJldCwgc3VwID0gdGhpcy5fc3VwZXI7CiAgICB0aGlzLl9zdXBlciA9IHN1cGVyRnVuYyB8fCBLOwogICAgcmV0ID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhpcy5fc3VwZXIgPSBzdXA7CiAgICByZXR1cm4gcmV0OwogIH0KCiAgc3VwZXJXcmFwcGVyLndyYXBwZWRGdW5jdGlvbiA9IGZ1bmM7CiAgc3VwZXJXcmFwcGVyLl9fZW1iZXJfb2JzZXJ2ZXNfXyA9IGZ1bmMuX19lbWJlcl9vYnNlcnZlc19fOwogIHN1cGVyV3JhcHBlci5fX2VtYmVyX29ic2VydmVzQmVmb3JlX18gPSBmdW5jLl9fZW1iZXJfb2JzZXJ2ZXNCZWZvcmVfXzsKICBzdXBlcldyYXBwZXIuX19lbWJlcl9saXN0ZW5zX18gPSBmdW5jLl9fZW1iZXJfbGlzdGVuc19fOwoKICByZXR1cm4gc3VwZXJXcmFwcGVyOwp9OwoKLyoqCiAgUmV0dXJucyB0cnVlIGlmIHRoZSBwYXNzZWQgb2JqZWN0IGlzIGFuIGFycmF5IG9yIEFycmF5LWxpa2UuCgogIEVtYmVyIEFycmF5IFByb3RvY29sOgoKICAgIC0gdGhlIG9iamVjdCBoYXMgYW4gb2JqZWN0QXQgcHJvcGVydHkKICAgIC0gdGhlIG9iamVjdCBpcyBhIG5hdGl2ZSBBcnJheQogICAgLSB0aGUgb2JqZWN0IGlzIGFuIE9iamVjdCwgYW5kIGhhcyBhIGxlbmd0aCBwcm9wZXJ0eQoKICBVbmxpa2UgYEVtYmVyLnR5cGVPZmAgdGhpcyBtZXRob2QgcmV0dXJucyB0cnVlIGV2ZW4gaWYgdGhlIHBhc3NlZCBvYmplY3QgaXMKICBub3QgZm9ybWFsbHkgYXJyYXkgYnV0IGFwcGVhcnMgdG8gYmUgYXJyYXktbGlrZSAoaS5lLiBpbXBsZW1lbnRzIGBFbWJlci5BcnJheWApCgogIGBgYGphdmFzY3JpcHQKICBFbWJlci5pc0FycmF5KCk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBmYWxzZQogIEVtYmVyLmlzQXJyYXkoW10pOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRydWUKICBFbWJlci5pc0FycmF5KCBFbWJlci5BcnJheVByb3h5LmNyZWF0ZSh7IGNvbnRlbnQ6IFtdIH0pICk7ICAvLyB0cnVlCiAgYGBgCgogIEBtZXRob2QgaXNBcnJheQogIEBmb3IgRW1iZXIKICBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgdG8gdGVzdAogIEByZXR1cm4ge0Jvb2xlYW59IHRydWUgaWYgdGhlIHBhc3NlZCBvYmplY3QgaXMgYW4gYXJyYXkgb3IgQXJyYXktbGlrZQoqLwpFbWJlci5pc0FycmF5ID0gZnVuY3Rpb24ob2JqKSB7CiAgaWYgKCFvYmogfHwgb2JqLnNldEludGVydmFsKSB7IHJldHVybiBmYWxzZTsgfQogIGlmIChBcnJheS5pc0FycmF5ICYmIEFycmF5LmlzQXJyYXkob2JqKSkgeyByZXR1cm4gdHJ1ZTsgfQogIGlmIChFbWJlci5BcnJheSAmJiBFbWJlci5BcnJheS5kZXRlY3Qob2JqKSkgeyByZXR1cm4gdHJ1ZTsgfQogIGlmICgob2JqLmxlbmd0aCAhPT0gdW5kZWZpbmVkKSAmJiAnb2JqZWN0Jz09PXR5cGVvZiBvYmopIHsgcmV0dXJuIHRydWU7IH0KICByZXR1cm4gZmFsc2U7Cn07CgovKioKICBGb3JjZXMgdGhlIHBhc3NlZCBvYmplY3QgdG8gYmUgcGFydCBvZiBhbiBhcnJheS4gSWYgdGhlIG9iamVjdCBpcyBhbHJlYWR5CiAgYW4gYXJyYXkgb3IgYXJyYXktbGlrZSwgcmV0dXJucyB0aGUgb2JqZWN0LiBPdGhlcndpc2UgYWRkcyB0aGUgb2JqZWN0IHRvCiAgYW4gYXJyYXkuIElmIG9iaiBpcyBgbnVsbGAgb3IgYHVuZGVmaW5lZGAsIHJldHVybnMgYW4gZW1wdHkgYXJyYXkuCgogIGBgYGphdmFzY3JpcHQKICBFbWJlci5tYWtlQXJyYXkoKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBbXQogIEVtYmVyLm1ha2VBcnJheShudWxsKTsgICAgICAgICAgICAgICAgICAgICAgIC8vIFtdCiAgRW1iZXIubWFrZUFycmF5KHVuZGVmaW5lZCk7ICAgICAgICAgICAgICAgICAgLy8gW10KICBFbWJlci5tYWtlQXJyYXkoJ2xpbmRzYXknKTsgICAgICAgICAgICAgICAgICAvLyBbJ2xpbmRzYXknXQogIEVtYmVyLm1ha2VBcnJheShbMSwyLDQyXSk7ICAgICAgICAgICAgICAgICAgIC8vIFsxLDIsNDJdCgogIHZhciBjb250cm9sbGVyID0gRW1iZXIuQXJyYXlQcm94eS5jcmVhdGUoeyBjb250ZW50OiBbXSB9KTsKICBFbWJlci5tYWtlQXJyYXkoY29udHJvbGxlcikgPT09IGNvbnRyb2xsZXI7ICAvLyB0cnVlCiAgYGBgCgogIEBtZXRob2QgbWFrZUFycmF5CiAgQGZvciBFbWJlcgogIEBwYXJhbSB7T2JqZWN0fSBvYmogdGhlIG9iamVjdAogIEByZXR1cm4ge0FycmF5fQoqLwpFbWJlci5tYWtlQXJyYXkgPSBmdW5jdGlvbihvYmopIHsKICBpZiAob2JqID09PSBudWxsIHx8IG9iaiA9PT0gdW5kZWZpbmVkKSB7IHJldHVybiBbXTsgfQogIHJldHVybiBFbWJlci5pc0FycmF5KG9iaikgPyBvYmogOiBbb2JqXTsKfTsKCmZ1bmN0aW9uIGNhbkludm9rZShvYmosIG1ldGhvZE5hbWUpIHsKICByZXR1cm4gISEob2JqICYmIHR5cGVvZiBvYmpbbWV0aG9kTmFtZV0gPT09ICdmdW5jdGlvbicpOwp9CgovKioKICBDaGVja3MgdG8gc2VlIGlmIHRoZSBgbWV0aG9kTmFtZWAgZXhpc3RzIG9uIHRoZSBgb2JqYC4KCiAgYGBgamF2YXNjcmlwdAogIHZhciBmb28gPSB7YmFyOiBFbWJlci5LLCBiYXo6IG51bGx9OwogIEVtYmVyLmNhbkludm9rZShmb28sICdiYXInKTsgLy8gdHJ1ZQogIEVtYmVyLmNhbkludm9rZShmb28sICdiYXonKTsgLy8gZmFsc2UKICBFbWJlci5jYW5JbnZva2UoZm9vLCAnYmF0Jyk7IC8vIGZhbHNlCiAgYGBgCgogIEBtZXRob2QgY2FuSW52b2tlCiAgQGZvciBFbWJlcgogIEBwYXJhbSB7T2JqZWN0fSBvYmogVGhlIG9iamVjdCB0byBjaGVjayBmb3IgdGhlIG1ldGhvZAogIEBwYXJhbSB7U3RyaW5nfSBtZXRob2ROYW1lIFRoZSBtZXRob2QgbmFtZSB0byBjaGVjayBmb3IKICBAcmV0dXJuIHtCb29sZWFufQoqLwpFbWJlci5jYW5JbnZva2UgPSBjYW5JbnZva2U7CgovKioKICBDaGVja3MgdG8gc2VlIGlmIHRoZSBgbWV0aG9kTmFtZWAgZXhpc3RzIG9uIHRoZSBgb2JqYCwKICBhbmQgaWYgaXQgZG9lcywgaW52b2tlcyBpdCB3aXRoIHRoZSBhcmd1bWVudHMgcGFzc2VkLgoKICBgYGBqYXZhc2NyaXB0CiAgdmFyIGQgPSBuZXcgRGF0ZSgnMDMvMTUvMjAxMycpOwogIEVtYmVyLnRyeUludm9rZShkLCAnZ2V0VGltZScpOyAvLyAxMzYzMzIwMDAwMDAwCiAgRW1iZXIudHJ5SW52b2tlKGQsICdzZXRGdWxsWWVhcicsIFsyMDE0XSk7IC8vIDEzOTQ4NTYwMDAwMDAKICBFbWJlci50cnlJbnZva2UoZCwgJ25vU3VjaE1ldGhvZCcsIFsyMDE0XSk7IC8vIHVuZGVmaW5lZAogIGBgYAoKICBAbWV0aG9kIHRyeUludm9rZQogIEBmb3IgRW1iZXIKICBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgdG8gY2hlY2sgZm9yIHRoZSBtZXRob2QKICBAcGFyYW0ge1N0cmluZ30gbWV0aG9kTmFtZSBUaGUgbWV0aG9kIG5hbWUgdG8gY2hlY2sgZm9yCiAgQHBhcmFtIHtBcnJheX0gW2FyZ3NdIFRoZSBhcmd1bWVudHMgdG8gcGFzcyB0byB0aGUgbWV0aG9kCiAgQHJldHVybiB7Kn0gdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgaW52b2tlZCBtZXRob2Qgb3IgdW5kZWZpbmVkIGlmIGl0IGNhbm5vdCBiZSBpbnZva2VkCiovCkVtYmVyLnRyeUludm9rZSA9IGZ1bmN0aW9uKG9iaiwgbWV0aG9kTmFtZSwgYXJncykgewogIGlmIChjYW5JbnZva2Uob2JqLCBtZXRob2ROYW1lKSkgewogICAgcmV0dXJuIG9ialttZXRob2ROYW1lXS5hcHBseShvYmosIGFyZ3MgfHwgW10pOwogIH0KfTsKCi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9lbWJlcmpzL2VtYmVyLmpzL3B1bGwvMTYxNwp2YXIgbmVlZHNGaW5hbGx5Rml4ID0gKGZ1bmN0aW9uKCkgewogIHZhciBjb3VudCA9IDA7CiAgdHJ5ewogICAgdHJ5IHsgfQogICAgZmluYWxseSB7CiAgICAgIGNvdW50Kys7CiAgICAgIHRocm93IG5ldyBFcnJvcignbmVlZHNGaW5hbGx5Rml4VGVzdCcpOwogICAgfQogIH0gY2F0Y2ggKGUpIHt9CgogIHJldHVybiBjb3VudCAhPT0gMTsKfSkoKTsKCi8qKgogIFByb3ZpZGVzIHRyeSB7IH0gZmluYWxseSB7IH0gZnVuY3Rpb25hbGl0eSwgd2hpbGUgd29ya2luZwogIGFyb3VuZCBTYWZhcmkncyBkb3VibGUgZmluYWxseSBidWcuCgogIGBgYGphdmFzY3JpcHQKICB2YXIgdHJ5YWJsZSA9IGZ1bmN0aW9uKCkgewogICAgc29tZVJlc291cmNlLmxvY2soKTsKICAgIHJ1bkNhbGxiYWNrKCk7IC8vIE1heSB0aHJvdyBlcnJvci4KICB9OwogIHZhciBmaW5hbGl6ZXIgPSBmdW5jdGlvbigpIHsKICAgIHNvbWVSZXNvdXJjZS51bmxvY2soKTsKICB9OwogIEVtYmVyLnRyeUZpbmFsbHkodHJ5YWJsZSwgZmluYWxpemVyKTsKICBgYGAKCiAgQG1ldGhvZCB0cnlGaW5hbGx5CiAgQGZvciBFbWJlcgogIEBwYXJhbSB7RnVuY3Rpb259IHRyeWFibGUgVGhlIGZ1bmN0aW9uIHRvIHJ1biB0aGUgdHJ5IGNhbGxiYWNrCiAgQHBhcmFtIHtGdW5jdGlvbn0gZmluYWxpemVyIFRoZSBmdW5jdGlvbiB0byBydW4gdGhlIGZpbmFsbHkgY2FsbGJhY2sKICBAcGFyYW0ge09iamVjdH0gW2JpbmRpbmddIFRoZSBvcHRpb25hbCBjYWxsaW5nIG9iamVjdC4gRGVmYXVsdHMgdG8gJ3RoaXMnCiAgQHJldHVybiB7Kn0gVGhlIHJldHVybiB2YWx1ZSBpcyB0aGUgdGhhdCBvZiB0aGUgZmluYWxpemVyLAogIHVubGVzcyB0aGF0IHZhbHVlIGlzIHVuZGVmaW5lZCwgaW4gd2hpY2ggY2FzZSBpdCBpcyB0aGUgcmV0dXJuIHZhbHVlCiAgb2YgdGhlIHRyeWFibGUKKi8KCmlmIChuZWVkc0ZpbmFsbHlGaXgpIHsKICBFbWJlci50cnlGaW5hbGx5ID0gZnVuY3Rpb24odHJ5YWJsZSwgZmluYWxpemVyLCBiaW5kaW5nKSB7CiAgICB2YXIgcmVzdWx0LCBmaW5hbFJlc3VsdCwgZmluYWxFcnJvcjsKCiAgICBiaW5kaW5nID0gYmluZGluZyB8fCB0aGlzOwoKICAgIHRyeSB7CiAgICAgIHJlc3VsdCA9IHRyeWFibGUuY2FsbChiaW5kaW5nKTsKICAgIH0gZmluYWxseSB7CiAgICAgIHRyeSB7CiAgICAgICAgZmluYWxSZXN1bHQgPSBmaW5hbGl6ZXIuY2FsbChiaW5kaW5nKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGZpbmFsRXJyb3IgPSBlOwogICAgICB9CiAgICB9CgogICAgaWYgKGZpbmFsRXJyb3IpIHsgdGhyb3cgZmluYWxFcnJvcjsgfQoKICAgIHJldHVybiAoZmluYWxSZXN1bHQgPT09IHVuZGVmaW5lZCkgPyByZXN1bHQgOiBmaW5hbFJlc3VsdDsKICB9Owp9IGVsc2UgewogIEVtYmVyLnRyeUZpbmFsbHkgPSBmdW5jdGlvbih0cnlhYmxlLCBmaW5hbGl6ZXIsIGJpbmRpbmcpIHsKICAgIHZhciByZXN1bHQsIGZpbmFsUmVzdWx0OwoKICAgIGJpbmRpbmcgPSBiaW5kaW5nIHx8IHRoaXM7CgogICAgdHJ5IHsKICAgICAgcmVzdWx0ID0gdHJ5YWJsZS5jYWxsKGJpbmRpbmcpOwogICAgfSBmaW5hbGx5IHsKICAgICAgZmluYWxSZXN1bHQgPSBmaW5hbGl6ZXIuY2FsbChiaW5kaW5nKTsKICAgIH0KCiAgICByZXR1cm4gKGZpbmFsUmVzdWx0ID09PSB1bmRlZmluZWQpID8gcmVzdWx0IDogZmluYWxSZXN1bHQ7CiAgfTsKfQoKLyoqCiAgUHJvdmlkZXMgdHJ5IHsgfSBjYXRjaCBmaW5hbGx5IHsgfSBmdW5jdGlvbmFsaXR5LCB3aGlsZSB3b3JraW5nCiAgYXJvdW5kIFNhZmFyaSdzIGRvdWJsZSBmaW5hbGx5IGJ1Zy4KCiAgYGBgamF2YXNjcmlwdAogIHZhciB0cnlhYmxlID0gZnVuY3Rpb24oKSB7CiAgICBmb3IgKGk9MCwgbD1saXN0ZW5lcnMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICBsaXN0ZW5lciA9IGxpc3RlbmVyc1tpXTsKICAgICAgYmVmb3JlVmFsdWVzW2ldID0gbGlzdGVuZXIuYmVmb3JlKG5hbWUsIHRpbWUoKSwgcGF5bG9hZCk7CiAgICB9CgogICAgcmV0dXJuIGNhbGxiYWNrLmNhbGwoYmluZGluZyk7CiAgfTsKCiAgdmFyIGNhdGNoYWJsZSA9IGZ1bmN0aW9uKGUpIHsKICAgIHBheWxvYWQgPSBwYXlsb2FkIHx8IHt9OwogICAgcGF5bG9hZC5leGNlcHRpb24gPSBlOwogIH07CgogIHZhciBmaW5hbGl6ZXIgPSBmdW5jdGlvbigpIHsKICAgIGZvciAoaT0wLCBsPWxpc3RlbmVycy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgIGxpc3RlbmVyID0gbGlzdGVuZXJzW2ldOwogICAgICBsaXN0ZW5lci5hZnRlcihuYW1lLCB0aW1lKCksIHBheWxvYWQsIGJlZm9yZVZhbHVlc1tpXSk7CiAgICB9CiAgfTsKICBFbWJlci50cnlDYXRjaEZpbmFsbHkodHJ5YWJsZSwgY2F0Y2hhYmxlLCBmaW5hbGl6ZXIpOwogIGBgYAoKICBAbWV0aG9kIHRyeUNhdGNoRmluYWxseQogIEBmb3IgRW1iZXIKICBAcGFyYW0ge0Z1bmN0aW9ufSB0cnlhYmxlIFRoZSBmdW5jdGlvbiB0byBydW4gdGhlIHRyeSBjYWxsYmFjawogIEBwYXJhbSB7RnVuY3Rpb259IGNhdGNoYWJsZSBUaGUgZnVuY3Rpb24gdG8gcnVuIHRoZSBjYXRjaGFibGUgY2FsbGJhY2sKICBAcGFyYW0ge0Z1bmN0aW9ufSBmaW5hbGl6ZXIgVGhlIGZ1bmN0aW9uIHRvIHJ1biB0aGUgZmluYWxseSBjYWxsYmFjawogIEBwYXJhbSB7T2JqZWN0fSBbYmluZGluZ10gVGhlIG9wdGlvbmFsIGNhbGxpbmcgb2JqZWN0LiBEZWZhdWx0cyB0byAndGhpcycKICBAcmV0dXJuIHsqfSBUaGUgcmV0dXJuIHZhbHVlIGlzIHRoZSB0aGF0IG9mIHRoZSBmaW5hbGl6ZXIsCiAgdW5sZXNzIHRoYXQgdmFsdWUgaXMgdW5kZWZpbmVkLCBpbiB3aGljaCBjYXNlIGl0IGlzIHRoZSByZXR1cm4gdmFsdWUKICBvZiB0aGUgdHJ5YWJsZS4KKi8KaWYgKG5lZWRzRmluYWxseUZpeCkgewogIEVtYmVyLnRyeUNhdGNoRmluYWxseSA9IGZ1bmN0aW9uKHRyeWFibGUsIGNhdGNoYWJsZSwgZmluYWxpemVyLCBiaW5kaW5nKSB7CiAgICB2YXIgcmVzdWx0LCBmaW5hbFJlc3VsdCwgZmluYWxFcnJvcjsKCiAgICBiaW5kaW5nID0gYmluZGluZyB8fCB0aGlzOwoKICAgIHRyeSB7CiAgICAgIHJlc3VsdCA9IHRyeWFibGUuY2FsbChiaW5kaW5nKTsKICAgIH0gY2F0Y2goZXJyb3IpIHsKICAgICAgcmVzdWx0ID0gY2F0Y2hhYmxlLmNhbGwoYmluZGluZywgZXJyb3IpOwogICAgfSBmaW5hbGx5IHsKICAgICAgdHJ5IHsKICAgICAgICBmaW5hbFJlc3VsdCA9IGZpbmFsaXplci5jYWxsKGJpbmRpbmcpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgZmluYWxFcnJvciA9IGU7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoZmluYWxFcnJvcikgeyB0aHJvdyBmaW5hbEVycm9yOyB9CgogICAgcmV0dXJuIChmaW5hbFJlc3VsdCA9PT0gdW5kZWZpbmVkKSA/IHJlc3VsdCA6IGZpbmFsUmVzdWx0OwogIH07Cn0gZWxzZSB7CiAgRW1iZXIudHJ5Q2F0Y2hGaW5hbGx5ID0gZnVuY3Rpb24odHJ5YWJsZSwgY2F0Y2hhYmxlLCBmaW5hbGl6ZXIsIGJpbmRpbmcpIHsKICAgIHZhciByZXN1bHQsIGZpbmFsUmVzdWx0OwoKICAgIGJpbmRpbmcgPSBiaW5kaW5nIHx8IHRoaXM7CgogICAgdHJ5IHsKICAgICAgcmVzdWx0ID0gdHJ5YWJsZS5jYWxsKGJpbmRpbmcpOwogICAgfSBjYXRjaChlcnJvcikgewogICAgICByZXN1bHQgPSBjYXRjaGFibGUuY2FsbChiaW5kaW5nLCBlcnJvcik7CiAgICB9IGZpbmFsbHkgewogICAgICBmaW5hbFJlc3VsdCA9IGZpbmFsaXplci5jYWxsKGJpbmRpbmcpOwogICAgfQoKICAgIHJldHVybiAoZmluYWxSZXN1bHQgPT09IHVuZGVmaW5lZCkgPyByZXN1bHQgOiBmaW5hbFJlc3VsdDsKICB9Owp9CgovLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCi8vIFRZUElORyAmIEFSUkFZIE1FU1NBR0lORwovLwoKdmFyIFRZUEVfTUFQID0ge307CnZhciB0ID0gIkJvb2xlYW4gTnVtYmVyIFN0cmluZyBGdW5jdGlvbiBBcnJheSBEYXRlIFJlZ0V4cCBPYmplY3QiLnNwbGl0KCIgIik7CkVtYmVyLkFycmF5UG9seWZpbGxzLmZvckVhY2guY2FsbCh0LCBmdW5jdGlvbihuYW1lKSB7CiAgVFlQRV9NQVBbICJbb2JqZWN0ICIgKyBuYW1lICsgIl0iIF0gPSBuYW1lLnRvTG93ZXJDYXNlKCk7Cn0pOwoKdmFyIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKCi8qKgogIFJldHVybnMgYSBjb25zaXN0ZW50IHR5cGUgZm9yIHRoZSBwYXNzZWQgaXRlbS4KCiAgVXNlIHRoaXMgaW5zdGVhZCBvZiB0aGUgYnVpbHQtaW4gYHR5cGVvZmAgdG8gZ2V0IHRoZSB0eXBlIG9mIGFuIGl0ZW0uCiAgSXQgd2lsbCByZXR1cm4gdGhlIHNhbWUgcmVzdWx0IGFjcm9zcyBhbGwgYnJvd3NlcnMgYW5kIGluY2x1ZGVzIGEgYml0CiAgbW9yZSBkZXRhaWwuIEhlcmUgaXMgd2hhdCB3aWxsIGJlIHJldHVybmVkOgoKICAgICAgfCBSZXR1cm4gVmFsdWUgIHwgTWVhbmluZyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgIHwtLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfAogICAgICB8ICdzdHJpbmcnICAgICAgfCBTdHJpbmcgcHJpbWl0aXZlIG9yIFN0cmluZyBvYmplY3QuICAgICAgICAgICAgICAgICAgIHwKICAgICAgfCAnbnVtYmVyJyAgICAgIHwgTnVtYmVyIHByaW1pdGl2ZSBvciBOdW1iZXIgb2JqZWN0LiAgICAgICAgICAgICAgICAgICB8CiAgICAgIHwgJ2Jvb2xlYW4nICAgICB8IEJvb2xlYW4gcHJpbWl0aXZlIG9yIEJvb2xlYW4gb2JqZWN0LiAgICAgICAgICAgICAgICAgfAogICAgICB8ICdudWxsJyAgICAgICAgfCBOdWxsIHZhbHVlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgfCAndW5kZWZpbmVkJyAgIHwgVW5kZWZpbmVkIHZhbHVlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgIHwgJ2Z1bmN0aW9uJyAgICB8IEEgZnVuY3Rpb24gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICB8ICdhcnJheScgICAgICAgfCBBbiBpbnN0YW5jZSBvZiBBcnJheSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgfCAncmVnZXhwJyAgICAgIHwgQW4gaW5zdGFuY2Ugb2YgUmVnRXhwICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgIHwgJ2RhdGUnICAgICAgICB8IEFuIGluc3RhbmNlIG9mIERhdGUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICB8ICdjbGFzcycgICAgICAgfCBBbiBFbWJlciBjbGFzcyAoY3JlYXRlZCB1c2luZyBFbWJlci5PYmplY3QuZXh0ZW5kKCkpIHwKICAgICAgfCAnaW5zdGFuY2UnICAgIHwgQW4gRW1iZXIgb2JqZWN0IGluc3RhbmNlICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgIHwgJ2Vycm9yJyAgICAgICB8IEFuIGluc3RhbmNlIG9mIHRoZSBFcnJvciBvYmplY3QgICAgICAgICAgICAgICAgICAgICAgfAogICAgICB8ICdvYmplY3QnICAgICAgfCBBIEphdmFTY3JpcHQgb2JqZWN0IG5vdCBpbmhlcml0aW5nIGZyb20gRW1iZXIuT2JqZWN0IHwKCiAgRXhhbXBsZXM6CgogIGBgYGphdmFzY3JpcHQKICBFbWJlci50eXBlT2YoKTsgICAgICAgICAgICAgICAgICAgICAgIC8vICd1bmRlZmluZWQnCiAgRW1iZXIudHlwZU9mKG51bGwpOyAgICAgICAgICAgICAgICAgICAvLyAnbnVsbCcKICBFbWJlci50eXBlT2YodW5kZWZpbmVkKTsgICAgICAgICAgICAgIC8vICd1bmRlZmluZWQnCiAgRW1iZXIudHlwZU9mKCdtaWNoYWVsJyk7ICAgICAgICAgICAgICAvLyAnc3RyaW5nJwogIEVtYmVyLnR5cGVPZihuZXcgU3RyaW5nKCdtaWNoYWVsJykpOyAgLy8gJ3N0cmluZycKICBFbWJlci50eXBlT2YoMTAxKTsgICAgICAgICAgICAgICAgICAgIC8vICdudW1iZXInCiAgRW1iZXIudHlwZU9mKG5ldyBOdW1iZXIoMTAxKSk7ICAgICAgICAvLyAnbnVtYmVyJwogIEVtYmVyLnR5cGVPZih0cnVlKTsgICAgICAgICAgICAgICAgICAgLy8gJ2Jvb2xlYW4nCiAgRW1iZXIudHlwZU9mKG5ldyBCb29sZWFuKHRydWUpKTsgICAgICAvLyAnYm9vbGVhbicKICBFbWJlci50eXBlT2YoRW1iZXIubWFrZUFycmF5KTsgICAgICAgIC8vICdmdW5jdGlvbicKICBFbWJlci50eXBlT2YoWzEsMiw5MF0pOyAgICAgICAgICAgICAgIC8vICdhcnJheScKICBFbWJlci50eXBlT2YoL2FiYy8pOyAgICAgICAgICAgICAgICAgIC8vICdyZWdleHAnCiAgRW1iZXIudHlwZU9mKG5ldyBEYXRlKCkpOyAgICAgICAgICAgICAvLyAnZGF0ZScKICBFbWJlci50eXBlT2YoRW1iZXIuT2JqZWN0LmV4dGVuZCgpKTsgIC8vICdjbGFzcycKICBFbWJlci50eXBlT2YoRW1iZXIuT2JqZWN0LmNyZWF0ZSgpKTsgIC8vICdpbnN0YW5jZScKICBFbWJlci50eXBlT2YobmV3IEVycm9yKCd0ZWFtb2NpbCcpKTsgIC8vICdlcnJvcicKCiAgLy8gIm5vcm1hbCIgSmF2YVNjcmlwdCBvYmplY3QKICBFbWJlci50eXBlT2Yoe2E6ICdiJ30pOyAgICAgICAgICAgICAgLy8gJ29iamVjdCcKICBgYGAKCiAgQG1ldGhvZCB0eXBlT2YKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtPYmplY3R9IGl0ZW0gdGhlIGl0ZW0gdG8gY2hlY2sKICBAcmV0dXJuIHtTdHJpbmd9IHRoZSB0eXBlCiovCkVtYmVyLnR5cGVPZiA9IGZ1bmN0aW9uKGl0ZW0pIHsKICB2YXIgcmV0OwoKICByZXQgPSAoaXRlbSA9PT0gbnVsbCB8fCBpdGVtID09PSB1bmRlZmluZWQpID8gU3RyaW5nKGl0ZW0pIDogVFlQRV9NQVBbdG9TdHJpbmcuY2FsbChpdGVtKV0gfHwgJ29iamVjdCc7CgogIGlmIChyZXQgPT09ICdmdW5jdGlvbicpIHsKICAgIGlmIChFbWJlci5PYmplY3QgJiYgRW1iZXIuT2JqZWN0LmRldGVjdChpdGVtKSkgcmV0ID0gJ2NsYXNzJzsKICB9IGVsc2UgaWYgKHJldCA9PT0gJ29iamVjdCcpIHsKICAgIGlmIChpdGVtIGluc3RhbmNlb2YgRXJyb3IpIHJldCA9ICdlcnJvcic7CiAgICBlbHNlIGlmIChFbWJlci5PYmplY3QgJiYgaXRlbSBpbnN0YW5jZW9mIEVtYmVyLk9iamVjdCkgcmV0ID0gJ2luc3RhbmNlJzsKICAgIGVsc2UgaWYgKGl0ZW0gaW5zdGFuY2VvZiBEYXRlKSByZXQgPSAnZGF0ZSc7CiAgfQoKICByZXR1cm4gcmV0Owp9OwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovLyBFbWJlci50cnlDYXRjaEZpbmFsbHkKCi8qKgogIFRoZSBwdXJwb3NlIG9mIHRoZSBFbWJlciBJbnN0cnVtZW50YXRpb24gbW9kdWxlIGlzCiAgdG8gcHJvdmlkZSBlZmZpY2llbnQsIGdlbmVyYWwtcHVycG9zZSBpbnN0cnVtZW50YXRpb24KICBmb3IgRW1iZXIuCgogIFN1YnNjcmliZSB0byBhIGxpc3RlbmVyIGJ5IHVzaW5nIGBFbWJlci5zdWJzY3JpYmVgOgoKICBgYGBqYXZhc2NyaXB0CiAgRW1iZXIuc3Vic2NyaWJlKCJyZW5kZXIiLCB7CiAgICBiZWZvcmU6IGZ1bmN0aW9uKG5hbWUsIHRpbWVzdGFtcCwgcGF5bG9hZCkgewoKICAgIH0sCgogICAgYWZ0ZXI6IGZ1bmN0aW9uKG5hbWUsIHRpbWVzdGFtcCwgcGF5bG9hZCkgewoKICAgIH0KICB9KTsKICBgYGAKCiAgSWYgeW91IHJldHVybiBhIHZhbHVlIGZyb20gdGhlIGBiZWZvcmVgIGNhbGxiYWNrLCB0aGF0IHNhbWUKICB2YWx1ZSB3aWxsIGJlIHBhc3NlZCBhcyBhIGZvdXJ0aCBwYXJhbWV0ZXIgdG8gdGhlIGBhZnRlcmAKICBjYWxsYmFjay4KCiAgSW5zdHJ1bWVudCBhIGJsb2NrIG9mIGNvZGUgYnkgdXNpbmcgYEVtYmVyLmluc3RydW1lbnRgOgoKICBgYGBqYXZhc2NyaXB0CiAgRW1iZXIuaW5zdHJ1bWVudCgicmVuZGVyLmhhbmRsZWJhcnMiLCBwYXlsb2FkLCBmdW5jdGlvbigpIHsKICAgIC8vIHJlbmRlcmluZyBsb2dpYwogIH0sIGJpbmRpbmcpOwogIGBgYAoKICBFdmVudCBuYW1lcyBwYXNzZWQgdG8gYEVtYmVyLmluc3RydW1lbnRgIGFyZSBuYW1lc3BhY2VkCiAgYnkgcGVyaW9kcywgZnJvbSBtb3JlIGdlbmVyYWwgdG8gbW9yZSBzcGVjaWZpYy4gU3Vic2NyaWJlcnMKICBjYW4gbGlzdGVuIGZvciBldmVudHMgYnkgd2hhdGV2ZXIgbGV2ZWwgb2YgZ3JhbnVsYXJpdHkgdGhleQogIGFyZSBpbnRlcmVzdGVkIGluLgoKICBJbiB0aGUgYWJvdmUgZXhhbXBsZSwgdGhlIGV2ZW50IGlzIGByZW5kZXIuaGFuZGxlYmFyc2AsCiAgYW5kIHRoZSBzdWJzY3JpYmVyIGxpc3RlbmVkIGZvciBhbGwgZXZlbnRzIGJlZ2lubmluZyB3aXRoCiAgYHJlbmRlcmAuIEl0IHdvdWxkIHJlY2VpdmUgY2FsbGJhY2tzIGZvciBldmVudHMgbmFtZWQKICBgcmVuZGVyYCwgYHJlbmRlci5oYW5kbGViYXJzYCwgYHJlbmRlci5jb250YWluZXJgLCBvcgogIGV2ZW4gYHJlbmRlci5oYW5kbGViYXJzLmxheW91dGAuCgogIEBjbGFzcyBJbnN0cnVtZW50YXRpb24KICBAbmFtZXNwYWNlIEVtYmVyCiAgQHN0YXRpYwoqLwpFbWJlci5JbnN0cnVtZW50YXRpb24gPSB7fTsKCnZhciBzdWJzY3JpYmVycyA9IFtdLCBjYWNoZSA9IHt9OwoKdmFyIHBvcHVsYXRlTGlzdGVuZXJzID0gZnVuY3Rpb24obmFtZSkgewogIHZhciBsaXN0ZW5lcnMgPSBbXSwgc3Vic2NyaWJlcjsKCiAgZm9yICh2YXIgaT0wLCBsPXN1YnNjcmliZXJzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgIHN1YnNjcmliZXIgPSBzdWJzY3JpYmVyc1tpXTsKICAgIGlmIChzdWJzY3JpYmVyLnJlZ2V4LnRlc3QobmFtZSkpIHsKICAgICAgbGlzdGVuZXJzLnB1c2goc3Vic2NyaWJlci5vYmplY3QpOwogICAgfQogIH0KCiAgY2FjaGVbbmFtZV0gPSBsaXN0ZW5lcnM7CiAgcmV0dXJuIGxpc3RlbmVyczsKfTsKCnZhciB0aW1lID0gKGZ1bmN0aW9uKCkgewogIHZhciBwZXJmID0gJ3VuZGVmaW5lZCcgIT09IHR5cGVvZiB3aW5kb3cgPyB3aW5kb3cucGVyZm9ybWFuY2UgfHwge30gOiB7fTsKICB2YXIgZm4gPSBwZXJmLm5vdyB8fCBwZXJmLm1vek5vdyB8fCBwZXJmLndlYmtpdE5vdyB8fCBwZXJmLm1zTm93IHx8IHBlcmYub05vdzsKICAvLyBmbi5iaW5kIHdpbGwgYmUgYXZhaWxhYmxlIGluIGFsbCB0aGUgYnJvd3NlcnMgdGhhdCBzdXBwb3J0IHRoZSBhZHZhbmNlZCB3aW5kb3cucGVyZm9ybWFuY2UuLi4gOy0pCiAgcmV0dXJuIGZuID8gZm4uYmluZChwZXJmKSA6IGZ1bmN0aW9uKCkgeyByZXR1cm4gK25ldyBEYXRlKCk7IH07Cn0pKCk7CgovKioKICBOb3RpZmllcyBldmVudCdzIHN1YnNjcmliZXJzLCBjYWxscyBgYmVmb3JlYCBhbmQgYGFmdGVyYCBob29rcy4KCiAgQG1ldGhvZCBpbnN0cnVtZW50CiAgQG5hbWVzcGFjZSBFbWJlci5JbnN0cnVtZW50YXRpb24KCiAgQHBhcmFtIHtTdHJpbmd9IFtuYW1lXSBOYW1lc3BhY2VkIGV2ZW50IG5hbWUuCiAgQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBGdW5jdGlvbiB0aGF0IHlvdSdyZSBpbnN0cnVtZW50aW5nLgogIEBwYXJhbSB7T2JqZWN0fSBiaW5kaW5nIENvbnRleHQgdGhhdCBpbnN0cnVtZW50IGZ1bmN0aW9uIGlzIGNhbGxlZCB3aXRoLgoqLwpFbWJlci5JbnN0cnVtZW50YXRpb24uaW5zdHJ1bWVudCA9IGZ1bmN0aW9uKG5hbWUsIHBheWxvYWQsIGNhbGxiYWNrLCBiaW5kaW5nKSB7CiAgdmFyIGxpc3RlbmVycyA9IGNhY2hlW25hbWVdLCB0aW1lTmFtZSwgcmV0OwoKICBpZiAoRW1iZXIuU1RSVUNUVVJFRF9QUk9GSUxFKSB7CiAgICB0aW1lTmFtZSA9IG5hbWUgKyAiOiAiICsgcGF5bG9hZC5vYmplY3Q7CiAgICBjb25zb2xlLnRpbWUodGltZU5hbWUpOwogIH0KCiAgaWYgKCFsaXN0ZW5lcnMpIHsKICAgIGxpc3RlbmVycyA9IHBvcHVsYXRlTGlzdGVuZXJzKG5hbWUpOwogIH0KCiAgaWYgKGxpc3RlbmVycy5sZW5ndGggPT09IDApIHsKICAgIHJldCA9IGNhbGxiYWNrLmNhbGwoYmluZGluZyk7CiAgICBpZiAoRW1iZXIuU1RSVUNUVVJFRF9QUk9GSUxFKSB7IGNvbnNvbGUudGltZUVuZCh0aW1lTmFtZSk7IH0KICAgIHJldHVybiByZXQ7CiAgfQoKICB2YXIgYmVmb3JlVmFsdWVzID0gW10sIGxpc3RlbmVyLCBpLCBsOwoKICBmdW5jdGlvbiB0cnlhYmxlKCkgewogICAgZm9yIChpPTAsIGw9bGlzdGVuZXJzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgbGlzdGVuZXIgPSBsaXN0ZW5lcnNbaV07CiAgICAgIGJlZm9yZVZhbHVlc1tpXSA9IGxpc3RlbmVyLmJlZm9yZShuYW1lLCB0aW1lKCksIHBheWxvYWQpOwogICAgfQoKICAgIHJldHVybiBjYWxsYmFjay5jYWxsKGJpbmRpbmcpOwogIH0KCiAgZnVuY3Rpb24gY2F0Y2hhYmxlKGUpIHsKICAgIHBheWxvYWQgPSBwYXlsb2FkIHx8IHt9OwogICAgcGF5bG9hZC5leGNlcHRpb24gPSBlOwogIH0KCiAgZnVuY3Rpb24gZmluYWxpemVyKCkgewogICAgZm9yIChpPTAsIGw9bGlzdGVuZXJzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgbGlzdGVuZXIgPSBsaXN0ZW5lcnNbaV07CiAgICAgIGxpc3RlbmVyLmFmdGVyKG5hbWUsIHRpbWUoKSwgcGF5bG9hZCwgYmVmb3JlVmFsdWVzW2ldKTsKICAgIH0KCiAgICBpZiAoRW1iZXIuU1RSVUNUVVJFRF9QUk9GSUxFKSB7CiAgICAgIGNvbnNvbGUudGltZUVuZCh0aW1lTmFtZSk7CiAgICB9CiAgfQoKICByZXR1cm4gRW1iZXIudHJ5Q2F0Y2hGaW5hbGx5KHRyeWFibGUsIGNhdGNoYWJsZSwgZmluYWxpemVyKTsKfTsKCi8qKgogIFN1YnNjcmliZXMgdG8gYSBwYXJ0aWN1bGFyIGV2ZW50IG9yIGluc3RydW1lbnRlZCBibG9jayBvZiBjb2RlLgoKICBAbWV0aG9kIHN1YnNjcmliZQogIEBuYW1lc3BhY2UgRW1iZXIuSW5zdHJ1bWVudGF0aW9uCgogIEBwYXJhbSB7U3RyaW5nfSBbcGF0dGVybl0gTmFtZXNwYWNlZCBldmVudCBuYW1lLgogIEBwYXJhbSB7T2JqZWN0fSBbb2JqZWN0XSBCZWZvcmUgYW5kIEFmdGVyIGhvb2tzLgoKICBAcmV0dXJuIHtTdWJzY3JpYmVyfQoqLwpFbWJlci5JbnN0cnVtZW50YXRpb24uc3Vic2NyaWJlID0gZnVuY3Rpb24ocGF0dGVybiwgb2JqZWN0KSB7CiAgdmFyIHBhdGhzID0gcGF0dGVybi5zcGxpdCgiLiIpLCBwYXRoLCByZWdleCA9IFtdOwoKICBmb3IgKHZhciBpPTAsIGw9cGF0aHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgcGF0aCA9IHBhdGhzW2ldOwogICAgaWYgKHBhdGggPT09ICIqIikgewogICAgICByZWdleC5wdXNoKCJbXlxcLl0qIik7CiAgICB9IGVsc2UgewogICAgICByZWdleC5wdXNoKHBhdGgpOwogICAgfQogIH0KCiAgcmVnZXggPSByZWdleC5qb2luKCJcXC4iKTsKICByZWdleCA9IHJlZ2V4ICsgIihcXC4uKik/IjsKCiAgdmFyIHN1YnNjcmliZXIgPSB7CiAgICBwYXR0ZXJuOiBwYXR0ZXJuLAogICAgcmVnZXg6IG5ldyBSZWdFeHAoIl4iICsgcmVnZXggKyAiJCIpLAogICAgb2JqZWN0OiBvYmplY3QKICB9OwoKICBzdWJzY3JpYmVycy5wdXNoKHN1YnNjcmliZXIpOwogIGNhY2hlID0ge307CgogIHJldHVybiBzdWJzY3JpYmVyOwp9OwoKLyoqCiAgVW5zdWJzY3JpYmVzIGZyb20gYSBwYXJ0aWN1bGFyIGV2ZW50IG9yIGluc3RydW1lbnRlZCBibG9jayBvZiBjb2RlLgoKICBAbWV0aG9kIHVuc3Vic2NyaWJlCiAgQG5hbWVzcGFjZSBFbWJlci5JbnN0cnVtZW50YXRpb24KCiAgQHBhcmFtIHtPYmplY3R9IFtzdWJzY3JpYmVyXQoqLwpFbWJlci5JbnN0cnVtZW50YXRpb24udW5zdWJzY3JpYmUgPSBmdW5jdGlvbihzdWJzY3JpYmVyKSB7CiAgdmFyIGluZGV4OwoKICBmb3IgKHZhciBpPTAsIGw9c3Vic2NyaWJlcnMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgaWYgKHN1YnNjcmliZXJzW2ldID09PSBzdWJzY3JpYmVyKSB7CiAgICAgIGluZGV4ID0gaTsKICAgIH0KICB9CgogIHN1YnNjcmliZXJzLnNwbGljZShpbmRleCwgMSk7CiAgY2FjaGUgPSB7fTsKfTsKCi8qKgogIFJlc2V0cyBgRW1iZXIuSW5zdHJ1bWVudGF0aW9uYCBieSBmbHVzaGluZyBsaXN0IG9mIHN1YnNjcmliZXJzLgoKICBAbWV0aG9kIHJlc2V0CiAgQG5hbWVzcGFjZSBFbWJlci5JbnN0cnVtZW50YXRpb24KKi8KRW1iZXIuSW5zdHJ1bWVudGF0aW9uLnJlc2V0ID0gZnVuY3Rpb24oKSB7CiAgc3Vic2NyaWJlcnMgPSBbXTsKICBjYWNoZSA9IHt9Owp9OwoKRW1iZXIuaW5zdHJ1bWVudCA9IEVtYmVyLkluc3RydW1lbnRhdGlvbi5pbnN0cnVtZW50OwpFbWJlci5zdWJzY3JpYmUgPSBFbWJlci5JbnN0cnVtZW50YXRpb24uc3Vic2NyaWJlOwp9KSgpOwoKCgooZnVuY3Rpb24oKSB7CnZhciBtYXAsIGZvckVhY2gsIGluZGV4T2YsIHNwbGljZTsKbWFwICAgICA9IEFycmF5LnByb3RvdHlwZS5tYXAgICAgIHx8IEVtYmVyLkFycmF5UG9seWZpbGxzLm1hcDsKZm9yRWFjaCA9IEFycmF5LnByb3RvdHlwZS5mb3JFYWNoIHx8IEVtYmVyLkFycmF5UG9seWZpbGxzLmZvckVhY2g7CmluZGV4T2YgPSBBcnJheS5wcm90b3R5cGUuaW5kZXhPZiB8fCBFbWJlci5BcnJheVBvbHlmaWxscy5pbmRleE9mOwpzcGxpY2UgPSBBcnJheS5wcm90b3R5cGUuc3BsaWNlOwoKdmFyIHV0aWxzID0gRW1iZXIuRW51bWVyYWJsZVV0aWxzID0gewogIG1hcDogZnVuY3Rpb24ob2JqLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgcmV0dXJuIG9iai5tYXAgPyBvYmoubWFwLmNhbGwob2JqLCBjYWxsYmFjaywgdGhpc0FyZykgOiBtYXAuY2FsbChvYmosIGNhbGxiYWNrLCB0aGlzQXJnKTsKICB9LAoKICBmb3JFYWNoOiBmdW5jdGlvbihvYmosIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICByZXR1cm4gb2JqLmZvckVhY2ggPyBvYmouZm9yRWFjaC5jYWxsKG9iaiwgY2FsbGJhY2ssIHRoaXNBcmcpIDogZm9yRWFjaC5jYWxsKG9iaiwgY2FsbGJhY2ssIHRoaXNBcmcpOwogIH0sCgogIGluZGV4T2Y6IGZ1bmN0aW9uKG9iaiwgZWxlbWVudCwgaW5kZXgpIHsKICAgIHJldHVybiBvYmouaW5kZXhPZiA/IG9iai5pbmRleE9mLmNhbGwob2JqLCBlbGVtZW50LCBpbmRleCkgOiBpbmRleE9mLmNhbGwob2JqLCBlbGVtZW50LCBpbmRleCk7CiAgfSwKCiAgaW5kZXhlc09mOiBmdW5jdGlvbihvYmosIGVsZW1lbnRzKSB7CiAgICByZXR1cm4gZWxlbWVudHMgPT09IHVuZGVmaW5lZCA/IFtdIDogdXRpbHMubWFwKGVsZW1lbnRzLCBmdW5jdGlvbihpdGVtKSB7CiAgICAgIHJldHVybiB1dGlscy5pbmRleE9mKG9iaiwgaXRlbSk7CiAgICB9KTsKICB9LAoKICBhZGRPYmplY3Q6IGZ1bmN0aW9uKGFycmF5LCBpdGVtKSB7CiAgICB2YXIgaW5kZXggPSB1dGlscy5pbmRleE9mKGFycmF5LCBpdGVtKTsKICAgIGlmIChpbmRleCA9PT0gLTEpIHsgYXJyYXkucHVzaChpdGVtKTsgfQogIH0sCgogIHJlbW92ZU9iamVjdDogZnVuY3Rpb24oYXJyYXksIGl0ZW0pIHsKICAgIHZhciBpbmRleCA9IHV0aWxzLmluZGV4T2YoYXJyYXksIGl0ZW0pOwogICAgaWYgKGluZGV4ICE9PSAtMSkgeyBhcnJheS5zcGxpY2UoaW5kZXgsIDEpOyB9CiAgfSwKCiAgX3JlcGxhY2U6IGZ1bmN0aW9uKGFycmF5LCBpZHgsIGFtdCwgb2JqZWN0cykgewogICAgdmFyIGFyZ3MgPSBbXS5jb25jYXQob2JqZWN0cyksIGNodW5rLCByZXQgPSBbXSwKICAgICAgICAvLyBodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9NTY1ODgKICAgICAgICBzaXplID0gNjAwMDAsIHN0YXJ0ID0gaWR4LCBlbmRzID0gYW10LCBjb3VudDsKCiAgICB3aGlsZSAoYXJncy5sZW5ndGgpIHsKICAgICAgY291bnQgPSBlbmRzID4gc2l6ZSA/IHNpemUgOiBlbmRzOwogICAgICBpZiAoY291bnQgPD0gMCkgeyBjb3VudCA9IDA7IH0KCiAgICAgIGNodW5rID0gYXJncy5zcGxpY2UoMCwgc2l6ZSk7CiAgICAgIGNodW5rID0gW3N0YXJ0LCBjb3VudF0uY29uY2F0KGNodW5rKTsKCiAgICAgIHN0YXJ0ICs9IHNpemU7CiAgICAgIGVuZHMgLT0gY291bnQ7CgogICAgICByZXQgPSByZXQuY29uY2F0KHNwbGljZS5hcHBseShhcnJheSwgY2h1bmspKTsKICAgIH0KICAgIHJldHVybiByZXQ7CiAgfSwKCiAgcmVwbGFjZTogZnVuY3Rpb24oYXJyYXksIGlkeCwgYW10LCBvYmplY3RzKSB7CiAgICBpZiAoYXJyYXkucmVwbGFjZSkgewogICAgICByZXR1cm4gYXJyYXkucmVwbGFjZShpZHgsIGFtdCwgb2JqZWN0cyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdXRpbHMuX3JlcGxhY2UoYXJyYXksIGlkeCwgYW10LCBvYmplY3RzKTsKICAgIH0KICB9LAoKICBpbnRlcnNlY3Rpb246IGZ1bmN0aW9uKGFycmF5MSwgYXJyYXkyKSB7CiAgICB2YXIgaW50ZXJzZWN0aW9uID0gW107CgogICAgdXRpbHMuZm9yRWFjaChhcnJheTEsIGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgaWYgKHV0aWxzLmluZGV4T2YoYXJyYXkyLCBlbGVtZW50KSA+PSAwKSB7CiAgICAgICAgaW50ZXJzZWN0aW9uLnB1c2goZWxlbWVudCk7CiAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybiBpbnRlcnNlY3Rpb247CiAgfQp9OwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlci1tZXRhbAoqLwoKdmFyIE1FVEFfS0VZID0gRW1iZXIuTUVUQV9LRVksIGdldDsKCnZhciBNQU5EQVRPUllfU0VUVEVSID0gRW1iZXIuRU5WLk1BTkRBVE9SWV9TRVRURVI7Cgp2YXIgSVNfR0xPQkFMX1BBVEggPSAvXihbQS1aJF18KFswLTldW0EtWiRdKSkuKltcLlwqXS87CnZhciBIQVNfVEhJUyAgPSAvXnRoaXNbXC5cKl0vOwp2YXIgRklSU1RfS0VZID0gL14oW15cLlwqXSspLzsKCi8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KLy8gR0VUIEFORCBTRVQKLy8KLy8gSWYgd2UgYXJlIG9uIGEgcGxhdGZvcm0gdGhhdCBzdXBwb3J0cyBhY2Nlc3NvcnMgd2UgY2FuIHVzZSB0aG9zZS4KLy8gT3RoZXJ3aXNlIHNpbXVsYXRlIGFjY2Vzc29ycyBieSBsb29raW5nIHVwIHRoZSBwcm9wZXJ0eSBkaXJlY3RseSBvbiB0aGUKLy8gb2JqZWN0LgoKLyoqCiAgR2V0cyB0aGUgdmFsdWUgb2YgYSBwcm9wZXJ0eSBvbiBhbiBvYmplY3QuIElmIHRoZSBwcm9wZXJ0eSBpcyBjb21wdXRlZCwKICB0aGUgZnVuY3Rpb24gd2lsbCBiZSBpbnZva2VkLiBJZiB0aGUgcHJvcGVydHkgaXMgbm90IGRlZmluZWQgYnV0IHRoZQogIG9iamVjdCBpbXBsZW1lbnRzIHRoZSBgdW5rbm93blByb3BlcnR5YCBtZXRob2QgdGhlbiB0aGF0IHdpbGwgYmUgaW52b2tlZC4KCiAgSWYgeW91IHBsYW4gdG8gcnVuIG9uIElFOCBhbmQgb2xkZXIgYnJvd3NlcnMgdGhlbiB5b3Ugc2hvdWxkIHVzZSB0aGlzCiAgbWV0aG9kIGFueXRpbWUgeW91IHdhbnQgdG8gcmV0cmlldmUgYSBwcm9wZXJ0eSBvbiBhbiBvYmplY3QgdGhhdCB5b3UgZG9uJ3QKICBrbm93IGZvciBzdXJlIGlzIHByaXZhdGUuIChQcm9wZXJ0aWVzIGJlZ2lubmluZyB3aXRoIGFuIHVuZGVyc2NvcmUgJ18nCiAgYXJlIGNvbnNpZGVyZWQgcHJpdmF0ZS4pCgogIE9uIGFsbCBuZXdlciBicm93c2VycywgeW91IG9ubHkgbmVlZCB0byB1c2UgdGhpcyBtZXRob2QgdG8gcmV0cmlldmUKICBwcm9wZXJ0aWVzIGlmIHRoZSBwcm9wZXJ0eSBtaWdodCBub3QgYmUgZGVmaW5lZCBvbiB0aGUgb2JqZWN0IGFuZCB5b3Ugd2FudAogIHRvIHJlc3BlY3QgdGhlIGB1bmtub3duUHJvcGVydHlgIGhhbmRsZXIuIE90aGVyd2lzZSB5b3UgY2FuIGlnbm9yZSB0aGlzCiAgbWV0aG9kLgoKICBOb3RlIHRoYXQgaWYgdGhlIG9iamVjdCBpdHNlbGYgaXMgYHVuZGVmaW5lZGAsIHRoaXMgbWV0aG9kIHdpbGwgdGhyb3cKICBhbiBlcnJvci4KCiAgQG1ldGhvZCBnZXQKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtPYmplY3R9IG9iaiBUaGUgb2JqZWN0IHRvIHJldHJpZXZlIGZyb20uCiAgQHBhcmFtIHtTdHJpbmd9IGtleU5hbWUgVGhlIHByb3BlcnR5IGtleSB0byByZXRyaWV2ZQogIEByZXR1cm4ge09iamVjdH0gdGhlIHByb3BlcnR5IHZhbHVlIG9yIGBudWxsYC4KKi8KZ2V0ID0gZnVuY3Rpb24gZ2V0KG9iaiwga2V5TmFtZSkgewogIC8vIEhlbHBlcnMgdGhhdCBvcGVyYXRlIHdpdGggJ3RoaXMnIHdpdGhpbiBhbiAjZWFjaAogIGlmIChrZXlOYW1lID09PSAnJykgewogICAgcmV0dXJuIG9iajsKICB9CgogIGlmICgha2V5TmFtZSAmJiAnc3RyaW5nJz09PXR5cGVvZiBvYmopIHsKICAgIGtleU5hbWUgPSBvYmo7CiAgICBvYmogPSBudWxsOwogIH0KCiAgRW1iZXIuYXNzZXJ0KCJDYW5ub3QgY2FsbCBnZXQgd2l0aCAiKyBrZXlOYW1lICsiIGtleS4iLCAhIWtleU5hbWUpOwogIEVtYmVyLmFzc2VydCgiQ2Fubm90IGNhbGwgZ2V0IHdpdGggJyIrIGtleU5hbWUgKyInIG9uIGFuIHVuZGVmaW5lZCBvYmplY3QuIiwgb2JqICE9PSB1bmRlZmluZWQpOwoKICBpZiAob2JqID09PSBudWxsIHx8IGtleU5hbWUuaW5kZXhPZignLicpICE9PSAtMSkgewogICAgcmV0dXJuIGdldFBhdGgob2JqLCBrZXlOYW1lKTsKICB9CgogIHZhciBtZXRhID0gb2JqW01FVEFfS0VZXSwgZGVzYyA9IG1ldGEgJiYgbWV0YS5kZXNjc1trZXlOYW1lXSwgcmV0OwogIGlmIChkZXNjKSB7CiAgICByZXR1cm4gZGVzYy5nZXQob2JqLCBrZXlOYW1lKTsKICB9IGVsc2UgewogICAgaWYgKE1BTkRBVE9SWV9TRVRURVIgJiYgbWV0YSAmJiBtZXRhLndhdGNoaW5nW2tleU5hbWVdID4gMCkgewogICAgICByZXQgPSBtZXRhLnZhbHVlc1trZXlOYW1lXTsKICAgIH0gZWxzZSB7CiAgICAgIHJldCA9IG9ialtrZXlOYW1lXTsKICAgIH0KCiAgICBpZiAocmV0ID09PSB1bmRlZmluZWQgJiYKICAgICAgICAnb2JqZWN0JyA9PT0gdHlwZW9mIG9iaiAmJiAhKGtleU5hbWUgaW4gb2JqKSAmJiAnZnVuY3Rpb24nID09PSB0eXBlb2Ygb2JqLnVua25vd25Qcm9wZXJ0eSkgewogICAgICByZXR1cm4gb2JqLnVua25vd25Qcm9wZXJ0eShrZXlOYW1lKTsKICAgIH0KCiAgICByZXR1cm4gcmV0OwogIH0KfTsKCi8vIEN1cnJlbnRseSB1c2VkIG9ubHkgYnkgRW1iZXIgRGF0YSB0ZXN0cwppZiAoRW1iZXIuY29uZmlnLm92ZXJyaWRlQWNjZXNzb3JzKSB7CiAgRW1iZXIuZ2V0ID0gZ2V0OwogIEVtYmVyLmNvbmZpZy5vdmVycmlkZUFjY2Vzc29ycygpOwogIGdldCA9IEVtYmVyLmdldDsKfQoKLyoqCiAgTm9ybWFsaXplcyBhIHRhcmdldC9wYXRoIHBhaXIgdG8gcmVmbGVjdCB0aGF0IGFjdHVhbCB0YXJnZXQvcGF0aCB0aGF0IHNob3VsZAogIGJlIG9ic2VydmVkLCBldGMuIFRoaXMgdGFrZXMgaW50byBhY2NvdW50IHBhc3NpbmcgaW4gZ2xvYmFsIHByb3BlcnR5CiAgcGF0aHMgKGkuZS4gYSBwYXRoIGJlZ2lubmluZyB3aXRoIGEgY2FwdGlhbCBsZXR0ZXIgbm90IGRlZmluZWQgb24gdGhlCiAgdGFyZ2V0KSBhbmQgKiBzZXBhcmF0b3JzLgoKICBAcHJpdmF0ZQogIEBtZXRob2Qgbm9ybWFsaXplVHVwbGUKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtPYmplY3R9IHRhcmdldCBUaGUgY3VycmVudCB0YXJnZXQuIE1heSBiZSBgbnVsbGAuCiAgQHBhcmFtIHtTdHJpbmd9IHBhdGggQSBwYXRoIG9uIHRoZSB0YXJnZXQgb3IgYSBnbG9iYWwgcHJvcGVydHkgcGF0aC4KICBAcmV0dXJuIHtBcnJheX0gYSB0ZW1wb3JhcnkgYXJyYXkgd2l0aCB0aGUgbm9ybWFsaXplZCB0YXJnZXQvcGF0aCBwYWlyLgoqLwp2YXIgbm9ybWFsaXplVHVwbGUgPSBFbWJlci5ub3JtYWxpemVUdXBsZSA9IGZ1bmN0aW9uKHRhcmdldCwgcGF0aCkgewogIHZhciBoYXNUaGlzICA9IEhBU19USElTLnRlc3QocGF0aCksCiAgICAgIGlzR2xvYmFsID0gIWhhc1RoaXMgJiYgSVNfR0xPQkFMX1BBVEgudGVzdChwYXRoKSwKICAgICAga2V5OwoKICBpZiAoIXRhcmdldCB8fCBpc0dsb2JhbCkgdGFyZ2V0ID0gRW1iZXIubG9va3VwOwogIGlmIChoYXNUaGlzKSBwYXRoID0gcGF0aC5zbGljZSg1KTsKCiAgaWYgKHRhcmdldCA9PT0gRW1iZXIubG9va3VwKSB7CiAgICBrZXkgPSBwYXRoLm1hdGNoKEZJUlNUX0tFWSlbMF07CiAgICB0YXJnZXQgPSBnZXQodGFyZ2V0LCBrZXkpOwogICAgcGF0aCAgID0gcGF0aC5zbGljZShrZXkubGVuZ3RoKzEpOwogIH0KCiAgLy8gbXVzdCByZXR1cm4gc29tZSBraW5kIG9mIHBhdGggdG8gYmUgdmFsaWQgZWxzZSBvdGhlciB0aGluZ3Mgd2lsbCBicmVhay4KICBpZiAoIXBhdGggfHwgcGF0aC5sZW5ndGg9PT0wKSB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoJ0ludmFsaWQgUGF0aCcpOwoKICByZXR1cm4gWyB0YXJnZXQsIHBhdGggXTsKfTsKCnZhciBnZXRQYXRoID0gRW1iZXIuX2dldFBhdGggPSBmdW5jdGlvbihyb290LCBwYXRoKSB7CiAgdmFyIGhhc1RoaXMsIHBhcnRzLCB0dXBsZSwgaWR4LCBsZW47CgogIC8vIElmIHRoZXJlIGlzIG5vIHJvb3QgYW5kIHBhdGggaXMgYSBrZXkgbmFtZSwgcmV0dXJuIHRoYXQKICAvLyBwcm9wZXJ0eSBmcm9tIHRoZSBnbG9iYWwgb2JqZWN0LgogIC8vIEUuZy4gZ2V0KCdFbWJlcicpIC0+IEVtYmVyCiAgaWYgKHJvb3QgPT09IG51bGwgJiYgcGF0aC5pbmRleE9mKCcuJykgPT09IC0xKSB7IHJldHVybiBnZXQoRW1iZXIubG9va3VwLCBwYXRoKTsgfQoKICAvLyBkZXRlY3QgY29tcGxpY2F0ZWQgcGF0aHMgYW5kIG5vcm1hbGl6ZSB0aGVtCiAgaGFzVGhpcyAgPSBIQVNfVEhJUy50ZXN0KHBhdGgpOwoKICBpZiAoIXJvb3QgfHwgaGFzVGhpcykgewogICAgdHVwbGUgPSBub3JtYWxpemVUdXBsZShyb290LCBwYXRoKTsKICAgIHJvb3QgPSB0dXBsZVswXTsKICAgIHBhdGggPSB0dXBsZVsxXTsKICAgIHR1cGxlLmxlbmd0aCA9IDA7CiAgfQoKICBwYXJ0cyA9IHBhdGguc3BsaXQoIi4iKTsKICBsZW4gPSBwYXJ0cy5sZW5ndGg7CiAgZm9yIChpZHggPSAwOyByb290ICE9IG51bGwgJiYgaWR4IDwgbGVuOyBpZHgrKykgewogICAgcm9vdCA9IGdldChyb290LCBwYXJ0c1tpZHhdLCB0cnVlKTsKICAgIGlmIChyb290ICYmIHJvb3QuaXNEZXN0cm95ZWQpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfQogIH0KICByZXR1cm4gcm9vdDsKfTsKCkVtYmVyLmdldFdpdGhEZWZhdWx0ID0gZnVuY3Rpb24ocm9vdCwga2V5LCBkZWZhdWx0VmFsdWUpIHsKICB2YXIgdmFsdWUgPSBnZXQocm9vdCwga2V5KTsKCiAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsgcmV0dXJuIGRlZmF1bHRWYWx1ZTsgfQogIHJldHVybiB2YWx1ZTsKfTsKCgpFbWJlci5nZXQgPSBnZXQ7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyLW1ldGFsCiovCgp2YXIgb19jcmVhdGUgPSBFbWJlci5jcmVhdGUsCiAgICBtZXRhRm9yID0gRW1iZXIubWV0YSwKICAgIE1FVEFfS0VZID0gRW1iZXIuTUVUQV9LRVksCiAgICBhX3NsaWNlID0gW10uc2xpY2UsCiAgICAvKiBsaXN0ZW5lciBmbGFncyAqLwogICAgT05DRSA9IDEsIFNVU1BFTkRFRCA9IDI7CgovKgogIFRoZSBldmVudCBzeXN0ZW0gdXNlcyBhIHNlcmllcyBvZiBuZXN0ZWQgaGFzaGVzIHRvIHN0b3JlIGxpc3RlbmVycyBvbiBhbgogIG9iamVjdC4gV2hlbiBhIGxpc3RlbmVyIGlzIHJlZ2lzdGVyZWQsIG9yIHdoZW4gYW4gZXZlbnQgYXJyaXZlcywgdGhlc2UKICBoYXNoZXMgYXJlIGNvbnN1bHRlZCB0byBkZXRlcm1pbmUgd2hpY2ggdGFyZ2V0IGFuZCBhY3Rpb24gcGFpciB0byBpbnZva2UuCgogIFRoZSBoYXNoZXMgYXJlIHN0b3JlZCBpbiB0aGUgb2JqZWN0J3MgbWV0YSBoYXNoLCBhbmQgbG9vayBsaWtlIHRoaXM6CgogICAgICAvLyBPYmplY3QncyBtZXRhIGhhc2gKICAgICAgewogICAgICAgIGxpc3RlbmVyczogeyAgICAgICAvLyB2YXJpYWJsZSBuYW1lOiBgbGlzdGVuZXJTZXRgCiAgICAgICAgICAiZm9vOmNoYW5nZWQiOiBbIC8vIHZhcmlhYmxlIG5hbWU6IGBhY3Rpb25zYAogICAgICAgICAgICB0YXJnZXQsIG1ldGhvZCwgZmxhZ3MKICAgICAgICAgIF0KICAgICAgICB9CiAgICAgIH0KCiovCgpmdW5jdGlvbiBpbmRleE9mKGFycmF5LCB0YXJnZXQsIG1ldGhvZCkgewogIHZhciBpbmRleCA9IC0xOwogIGZvciAodmFyIGkgPSAwLCBsID0gYXJyYXkubGVuZ3RoOyBpIDwgbDsgaSArPSAzKSB7CiAgICBpZiAodGFyZ2V0ID09PSBhcnJheVtpXSAmJiBtZXRob2QgPT09IGFycmF5W2krMV0pIHsgaW5kZXggPSBpOyBicmVhazsgfQogIH0KICByZXR1cm4gaW5kZXg7Cn0KCmZ1bmN0aW9uIGFjdGlvbnNGb3Iob2JqLCBldmVudE5hbWUpIHsKICB2YXIgbWV0YSA9IG1ldGFGb3Iob2JqLCB0cnVlKSwKICAgICAgYWN0aW9uczsKCiAgaWYgKCFtZXRhLmxpc3RlbmVycykgeyBtZXRhLmxpc3RlbmVycyA9IHt9OyB9CgogIGlmICghbWV0YS5oYXNPd25Qcm9wZXJ0eSgnbGlzdGVuZXJzJykpIHsKICAgIC8vIHNldHVwIGluaGVyaXRlZCBjb3B5IG9mIHRoZSBsaXN0ZW5lcnMgb2JqZWN0CiAgICBtZXRhLmxpc3RlbmVycyA9IG9fY3JlYXRlKG1ldGEubGlzdGVuZXJzKTsKICB9CgogIGFjdGlvbnMgPSBtZXRhLmxpc3RlbmVyc1tldmVudE5hbWVdOwoKICAvLyBpZiB0aGVyZSBhcmUgYWN0aW9ucywgYnV0IHRoZSBldmVudE5hbWUgZG9lc24ndCBleGlzdCBpbiBvdXIgbGlzdGVuZXJzLCB0aGVuIGNvcHkgdGhlbSBmcm9tIHRoZSBwcm90b3R5cGUKICBpZiAoYWN0aW9ucyAmJiAhbWV0YS5saXN0ZW5lcnMuaGFzT3duUHJvcGVydHkoZXZlbnROYW1lKSkgewogICAgYWN0aW9ucyA9IG1ldGEubGlzdGVuZXJzW2V2ZW50TmFtZV0gPSBtZXRhLmxpc3RlbmVyc1tldmVudE5hbWVdLnNsaWNlKCk7CiAgfSBlbHNlIGlmICghYWN0aW9ucykgewogICAgYWN0aW9ucyA9IG1ldGEubGlzdGVuZXJzW2V2ZW50TmFtZV0gPSBbXTsKICB9CgogIHJldHVybiBhY3Rpb25zOwp9CgpmdW5jdGlvbiBhY3Rpb25zVW5pb24ob2JqLCBldmVudE5hbWUsIG90aGVyQWN0aW9ucykgewogIHZhciBtZXRhID0gb2JqW01FVEFfS0VZXSwKICAgICAgYWN0aW9ucyA9IG1ldGEgJiYgbWV0YS5saXN0ZW5lcnMgJiYgbWV0YS5saXN0ZW5lcnNbZXZlbnROYW1lXTsKCiAgaWYgKCFhY3Rpb25zKSB7IHJldHVybjsgfQogIGZvciAodmFyIGkgPSBhY3Rpb25zLmxlbmd0aCAtIDM7IGkgPj0gMDsgaSAtPSAzKSB7CiAgICB2YXIgdGFyZ2V0ID0gYWN0aW9uc1tpXSwKICAgICAgICBtZXRob2QgPSBhY3Rpb25zW2krMV0sCiAgICAgICAgZmxhZ3MgPSBhY3Rpb25zW2krMl0sCiAgICAgICAgYWN0aW9uSW5kZXggPSBpbmRleE9mKG90aGVyQWN0aW9ucywgdGFyZ2V0LCBtZXRob2QpOwoKICAgIGlmIChhY3Rpb25JbmRleCA9PT0gLTEpIHsKICAgICAgb3RoZXJBY3Rpb25zLnB1c2godGFyZ2V0LCBtZXRob2QsIGZsYWdzKTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGFjdGlvbnNEaWZmKG9iaiwgZXZlbnROYW1lLCBvdGhlckFjdGlvbnMpIHsKICB2YXIgbWV0YSA9IG9ialtNRVRBX0tFWV0sCiAgICAgIGFjdGlvbnMgPSBtZXRhICYmIG1ldGEubGlzdGVuZXJzICYmIG1ldGEubGlzdGVuZXJzW2V2ZW50TmFtZV0sCiAgICAgIGRpZmZBY3Rpb25zID0gW107CgogIGlmICghYWN0aW9ucykgeyByZXR1cm47IH0KICBmb3IgKHZhciBpID0gYWN0aW9ucy5sZW5ndGggLSAzOyBpID49IDA7IGkgLT0gMykgewogICAgdmFyIHRhcmdldCA9IGFjdGlvbnNbaV0sCiAgICAgICAgbWV0aG9kID0gYWN0aW9uc1tpKzFdLAogICAgICAgIGZsYWdzID0gYWN0aW9uc1tpKzJdLAogICAgICAgIGFjdGlvbkluZGV4ID0gaW5kZXhPZihvdGhlckFjdGlvbnMsIHRhcmdldCwgbWV0aG9kKTsKCiAgICBpZiAoYWN0aW9uSW5kZXggIT09IC0xKSB7IGNvbnRpbnVlOyB9CgogICAgb3RoZXJBY3Rpb25zLnB1c2godGFyZ2V0LCBtZXRob2QsIGZsYWdzKTsKICAgIGRpZmZBY3Rpb25zLnB1c2godGFyZ2V0LCBtZXRob2QsIGZsYWdzKTsKICB9CgogIHJldHVybiBkaWZmQWN0aW9uczsKfQoKLyoqCiAgQWRkIGFuIGV2ZW50IGxpc3RlbmVyCgogIEBtZXRob2QgYWRkTGlzdGVuZXIKICBAZm9yIEVtYmVyCiAgQHBhcmFtIG9iagogIEBwYXJhbSB7U3RyaW5nfSBldmVudE5hbWUKICBAcGFyYW0ge09iamVjdHxGdW5jdGlvbn0gdGFyZ2V0T3JNZXRob2QgQSB0YXJnZXQgb2JqZWN0IG9yIGEgZnVuY3Rpb24KICBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gbWV0aG9kIEEgZnVuY3Rpb24gb3IgdGhlIG5hbWUgb2YgYSBmdW5jdGlvbiB0byBiZSBjYWxsZWQgb24gYHRhcmdldGAKICBAcGFyYW0ge0Jvb2xlYW59IG9uY2UgQSBmbGFnIHdoZXRoZXIgYSBmdW5jdGlvbiBzaG91bGQgb25seSBiZSBjYWxsZWQgb25jZQoqLwpmdW5jdGlvbiBhZGRMaXN0ZW5lcihvYmosIGV2ZW50TmFtZSwgdGFyZ2V0LCBtZXRob2QsIG9uY2UpIHsKICBFbWJlci5hc3NlcnQoIllvdSBtdXN0IHBhc3MgYXQgbGVhc3QgYW4gb2JqZWN0IGFuZCBldmVudCBuYW1lIHRvIEVtYmVyLmFkZExpc3RlbmVyIiwgISFvYmogJiYgISFldmVudE5hbWUpOwoKICBpZiAoIW1ldGhvZCAmJiAnZnVuY3Rpb24nID09PSB0eXBlb2YgdGFyZ2V0KSB7CiAgICBtZXRob2QgPSB0YXJnZXQ7CiAgICB0YXJnZXQgPSBudWxsOwogIH0KCiAgdmFyIGFjdGlvbnMgPSBhY3Rpb25zRm9yKG9iaiwgZXZlbnROYW1lKSwKICAgICAgYWN0aW9uSW5kZXggPSBpbmRleE9mKGFjdGlvbnMsIHRhcmdldCwgbWV0aG9kKSwKICAgICAgZmxhZ3MgPSAwOwoKICBpZiAob25jZSkgZmxhZ3MgfD0gT05DRTsKCiAgaWYgKGFjdGlvbkluZGV4ICE9PSAtMSkgeyByZXR1cm47IH0KCiAgYWN0aW9ucy5wdXNoKHRhcmdldCwgbWV0aG9kLCBmbGFncyk7CgogIGlmICgnZnVuY3Rpb24nID09PSB0eXBlb2Ygb2JqLmRpZEFkZExpc3RlbmVyKSB7CiAgICBvYmouZGlkQWRkTGlzdGVuZXIoZXZlbnROYW1lLCB0YXJnZXQsIG1ldGhvZCk7CiAgfQp9CgovKioKICBSZW1vdmUgYW4gZXZlbnQgbGlzdGVuZXIKCiAgQXJndW1lbnRzIHNob3VsZCBtYXRjaCB0aG9zZSBwYXNzZWQgdG8gYEVtYmVyLmFkZExpc3RlbmVyYC4KCiAgQG1ldGhvZCByZW1vdmVMaXN0ZW5lcgogIEBmb3IgRW1iZXIKICBAcGFyYW0gb2JqCiAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50TmFtZQogIEBwYXJhbSB7T2JqZWN0fEZ1bmN0aW9ufSB0YXJnZXRPck1ldGhvZCBBIHRhcmdldCBvYmplY3Qgb3IgYSBmdW5jdGlvbgogIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBtZXRob2QgQSBmdW5jdGlvbiBvciB0aGUgbmFtZSBvZiBhIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBvbiBgdGFyZ2V0YAoqLwpmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcihvYmosIGV2ZW50TmFtZSwgdGFyZ2V0LCBtZXRob2QpIHsKICBFbWJlci5hc3NlcnQoIllvdSBtdXN0IHBhc3MgYXQgbGVhc3QgYW4gb2JqZWN0IGFuZCBldmVudCBuYW1lIHRvIEVtYmVyLnJlbW92ZUxpc3RlbmVyIiwgISFvYmogJiYgISFldmVudE5hbWUpOwoKICBpZiAoIW1ldGhvZCAmJiAnZnVuY3Rpb24nID09PSB0eXBlb2YgdGFyZ2V0KSB7CiAgICBtZXRob2QgPSB0YXJnZXQ7CiAgICB0YXJnZXQgPSBudWxsOwogIH0KCiAgZnVuY3Rpb24gX3JlbW92ZUxpc3RlbmVyKHRhcmdldCwgbWV0aG9kKSB7CiAgICB2YXIgYWN0aW9ucyA9IGFjdGlvbnNGb3Iob2JqLCBldmVudE5hbWUpLAogICAgICAgIGFjdGlvbkluZGV4ID0gaW5kZXhPZihhY3Rpb25zLCB0YXJnZXQsIG1ldGhvZCk7CgogICAgLy8gYWN0aW9uIGRvZXNuJ3QgZXhpc3QsIGdpdmUgdXAgc2lsZW50bHkKICAgIGlmIChhY3Rpb25JbmRleCA9PT0gLTEpIHsgcmV0dXJuOyB9CgogICAgYWN0aW9ucy5zcGxpY2UoYWN0aW9uSW5kZXgsIDMpOwoKICAgIGlmICgnZnVuY3Rpb24nID09PSB0eXBlb2Ygb2JqLmRpZFJlbW92ZUxpc3RlbmVyKSB7CiAgICAgIG9iai5kaWRSZW1vdmVMaXN0ZW5lcihldmVudE5hbWUsIHRhcmdldCwgbWV0aG9kKTsKICAgIH0KICB9CgogIGlmIChtZXRob2QpIHsKICAgIF9yZW1vdmVMaXN0ZW5lcih0YXJnZXQsIG1ldGhvZCk7CiAgfSBlbHNlIHsKICAgIHZhciBtZXRhID0gb2JqW01FVEFfS0VZXSwKICAgICAgICBhY3Rpb25zID0gbWV0YSAmJiBtZXRhLmxpc3RlbmVycyAmJiBtZXRhLmxpc3RlbmVyc1tldmVudE5hbWVdOwoKICAgIGlmICghYWN0aW9ucykgeyByZXR1cm47IH0KICAgIGZvciAodmFyIGkgPSBhY3Rpb25zLmxlbmd0aCAtIDM7IGkgPj0gMDsgaSAtPSAzKSB7CiAgICAgIF9yZW1vdmVMaXN0ZW5lcihhY3Rpb25zW2ldLCBhY3Rpb25zW2krMV0pOwogICAgfQogIH0KfQoKLyoqCiAgU3VzcGVuZCBsaXN0ZW5lciBkdXJpbmcgY2FsbGJhY2suCgogIFRoaXMgc2hvdWxkIG9ubHkgYmUgdXNlZCBieSB0aGUgdGFyZ2V0IG9mIHRoZSBldmVudCBsaXN0ZW5lcgogIHdoZW4gaXQgaXMgdGFraW5nIGFuIGFjdGlvbiB0aGF0IHdvdWxkIGNhdXNlIHRoZSBldmVudCwgZS5nLgogIGFuIG9iamVjdCBtaWdodCBzdXNwZW5kIGl0cyBwcm9wZXJ0eSBjaGFuZ2UgbGlzdGVuZXIgd2hpbGUgaXQgaXMKICBzZXR0aW5nIHRoYXQgcHJvcGVydHkuCgogIEBwcml2YXRlCiAgQG1ldGhvZCBzdXNwZW5kTGlzdGVuZXIKICBAZm9yIEVtYmVyCiAgQHBhcmFtIG9iagogIEBwYXJhbSB7U3RyaW5nfSBldmVudE5hbWUKICBAcGFyYW0ge09iamVjdHxGdW5jdGlvbn0gdGFyZ2V0T3JNZXRob2QgQSB0YXJnZXQgb2JqZWN0IG9yIGEgZnVuY3Rpb24KICBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gbWV0aG9kIEEgZnVuY3Rpb24gb3IgdGhlIG5hbWUgb2YgYSBmdW5jdGlvbiB0byBiZSBjYWxsZWQgb24gYHRhcmdldGAKICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjawoqLwpmdW5jdGlvbiBzdXNwZW5kTGlzdGVuZXIob2JqLCBldmVudE5hbWUsIHRhcmdldCwgbWV0aG9kLCBjYWxsYmFjaykgewogIGlmICghbWV0aG9kICYmICdmdW5jdGlvbicgPT09IHR5cGVvZiB0YXJnZXQpIHsKICAgIG1ldGhvZCA9IHRhcmdldDsKICAgIHRhcmdldCA9IG51bGw7CiAgfQoKICB2YXIgYWN0aW9ucyA9IGFjdGlvbnNGb3Iob2JqLCBldmVudE5hbWUpLAogICAgICBhY3Rpb25JbmRleCA9IGluZGV4T2YoYWN0aW9ucywgdGFyZ2V0LCBtZXRob2QpOwoKICBpZiAoYWN0aW9uSW5kZXggIT09IC0xKSB7CiAgICBhY3Rpb25zW2FjdGlvbkluZGV4KzJdIHw9IFNVU1BFTkRFRDsgLy8gbWFyayB0aGUgYWN0aW9uIGFzIHN1c3BlbmRlZAogIH0KCiAgZnVuY3Rpb24gdHJ5YWJsZSgpICAgeyByZXR1cm4gY2FsbGJhY2suY2FsbCh0YXJnZXQpOyB9CiAgZnVuY3Rpb24gZmluYWxpemVyKCkgeyBpZiAoYWN0aW9uSW5kZXggIT09IC0xKSB7IGFjdGlvbnNbYWN0aW9uSW5kZXgrMl0gJj0gflNVU1BFTkRFRDsgfSB9CgogIHJldHVybiBFbWJlci50cnlGaW5hbGx5KHRyeWFibGUsIGZpbmFsaXplcik7Cn0KCi8qKgogIFN1c3BlbmRzIG11bHRpcGxlIGxpc3RlbmVycyBkdXJpbmcgYSBjYWxsYmFjay4KCiAgQHByaXZhdGUKICBAbWV0aG9kIHN1c3BlbmRMaXN0ZW5lcnMKICBAZm9yIEVtYmVyCiAgQHBhcmFtIG9iagogIEBwYXJhbSB7QXJyYXl9IGV2ZW50TmFtZSBBcnJheSBvZiBldmVudCBuYW1lcwogIEBwYXJhbSB7T2JqZWN0fEZ1bmN0aW9ufSB0YXJnZXRPck1ldGhvZCBBIHRhcmdldCBvYmplY3Qgb3IgYSBmdW5jdGlvbgogIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBtZXRob2QgQSBmdW5jdGlvbiBvciB0aGUgbmFtZSBvZiBhIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBvbiBgdGFyZ2V0YAogIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrCiovCmZ1bmN0aW9uIHN1c3BlbmRMaXN0ZW5lcnMob2JqLCBldmVudE5hbWVzLCB0YXJnZXQsIG1ldGhvZCwgY2FsbGJhY2spIHsKICBpZiAoIW1ldGhvZCAmJiAnZnVuY3Rpb24nID09PSB0eXBlb2YgdGFyZ2V0KSB7CiAgICBtZXRob2QgPSB0YXJnZXQ7CiAgICB0YXJnZXQgPSBudWxsOwogIH0KCiAgdmFyIHN1c3BlbmRlZEFjdGlvbnMgPSBbXSwKICAgICAgYWN0aW9uc0xpc3QgPSBbXSwKICAgICAgZXZlbnROYW1lLCBhY3Rpb25zLCBpLCBsOwoKICBmb3IgKGk9MCwgbD1ldmVudE5hbWVzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgIGV2ZW50TmFtZSA9IGV2ZW50TmFtZXNbaV07CiAgICBhY3Rpb25zID0gYWN0aW9uc0ZvcihvYmosIGV2ZW50TmFtZSk7CiAgICB2YXIgYWN0aW9uSW5kZXggPSBpbmRleE9mKGFjdGlvbnMsIHRhcmdldCwgbWV0aG9kKTsKCiAgICBpZiAoYWN0aW9uSW5kZXggIT09IC0xKSB7CiAgICAgIGFjdGlvbnNbYWN0aW9uSW5kZXgrMl0gfD0gU1VTUEVOREVEOwogICAgICBzdXNwZW5kZWRBY3Rpb25zLnB1c2goYWN0aW9uSW5kZXgpOwogICAgICBhY3Rpb25zTGlzdC5wdXNoKGFjdGlvbnMpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gdHJ5YWJsZSgpIHsgcmV0dXJuIGNhbGxiYWNrLmNhbGwodGFyZ2V0KTsgfQoKICBmdW5jdGlvbiBmaW5hbGl6ZXIoKSB7CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IHN1c3BlbmRlZEFjdGlvbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIHZhciBhY3Rpb25JbmRleCA9IHN1c3BlbmRlZEFjdGlvbnNbaV07CiAgICAgIGFjdGlvbnNMaXN0W2ldW2FjdGlvbkluZGV4KzJdICY9IH5TVVNQRU5ERUQ7CiAgICB9CiAgfQoKICByZXR1cm4gRW1iZXIudHJ5RmluYWxseSh0cnlhYmxlLCBmaW5hbGl6ZXIpOwp9CgovKioKICBSZXR1cm4gYSBsaXN0IG9mIGN1cnJlbnRseSB3YXRjaGVkIGV2ZW50cwoKICBAcHJpdmF0ZQogIEBtZXRob2Qgd2F0Y2hlZEV2ZW50cwogIEBmb3IgRW1iZXIKICBAcGFyYW0gb2JqCiovCmZ1bmN0aW9uIHdhdGNoZWRFdmVudHMob2JqKSB7CiAgdmFyIGxpc3RlbmVycyA9IG9ialtNRVRBX0tFWV0ubGlzdGVuZXJzLCByZXQgPSBbXTsKCiAgaWYgKGxpc3RlbmVycykgewogICAgZm9yKHZhciBldmVudE5hbWUgaW4gbGlzdGVuZXJzKSB7CiAgICAgIGlmIChsaXN0ZW5lcnNbZXZlbnROYW1lXSkgeyByZXQucHVzaChldmVudE5hbWUpOyB9CiAgICB9CiAgfQogIHJldHVybiByZXQ7Cn0KCi8qKgogIFNlbmQgYW4gZXZlbnQuIFRoZSBleGVjdXRpb24gb2Ygc3VzcGVuZGVkIGxpc3RlbmVycwogIGlzIHNraXBwZWQsIGFuZCBvbmNlIGxpc3RlbmVycyBhcmUgcmVtb3ZlZC4gQSBsaXN0ZW5lciB3aXRob3V0CiAgYSB0YXJnZXQgaXMgZXhlY3V0ZWQgb24gdGhlIHBhc3NlZCBvYmplY3QuIElmIGFuIGFycmF5IG9mIGFjdGlvbnMKICBpcyBub3QgcGFzc2VkLCB0aGUgYWN0aW9ucyBzdG9yZWQgb24gdGhlIHBhc3NlZCBvYmplY3QgYXJlIGludm9rZWQuCgogIEBtZXRob2Qgc2VuZEV2ZW50CiAgQGZvciBFbWJlcgogIEBwYXJhbSBvYmoKICBAcGFyYW0ge1N0cmluZ30gZXZlbnROYW1lCiAgQHBhcmFtIHtBcnJheX0gcGFyYW1zIE9wdGlvbmFsIHBhcmFtZXRlcnMgZm9yIGVhY2ggbGlzdGVuZXIuCiAgQHBhcmFtIHtBcnJheX0gYWN0aW9ucyBPcHRpb25hbCBhcnJheSBvZiBhY3Rpb25zIChsaXN0ZW5lcnMpLgogIEByZXR1cm4gdHJ1ZQoqLwpmdW5jdGlvbiBzZW5kRXZlbnQob2JqLCBldmVudE5hbWUsIHBhcmFtcywgYWN0aW9ucykgewogIC8vIGZpcnN0IGdpdmUgb2JqZWN0IGEgY2hhbmNlIHRvIGhhbmRsZSBpdAogIGlmIChvYmogIT09IEVtYmVyICYmICdmdW5jdGlvbicgPT09IHR5cGVvZiBvYmouc2VuZEV2ZW50KSB7CiAgICBvYmouc2VuZEV2ZW50KGV2ZW50TmFtZSwgcGFyYW1zKTsKICB9CgogIGlmICghYWN0aW9ucykgewogICAgdmFyIG1ldGEgPSBvYmpbTUVUQV9LRVldOwogICAgYWN0aW9ucyA9IG1ldGEgJiYgbWV0YS5saXN0ZW5lcnMgJiYgbWV0YS5saXN0ZW5lcnNbZXZlbnROYW1lXTsKICB9CgogIGlmICghYWN0aW9ucykgeyByZXR1cm47IH0KCiAgZm9yICh2YXIgaSA9IGFjdGlvbnMubGVuZ3RoIC0gMzsgaSA+PSAwOyBpIC09IDMpIHsgLy8gbG9vcGluZyBpbiByZXZlcnNlIGZvciBvbmNlIGxpc3RlbmVycwogICAgdmFyIHRhcmdldCA9IGFjdGlvbnNbaV0sIG1ldGhvZCA9IGFjdGlvbnNbaSsxXSwgZmxhZ3MgPSBhY3Rpb25zW2krMl07CiAgICBpZiAoIW1ldGhvZCkgeyBjb250aW51ZTsgfQogICAgaWYgKGZsYWdzICYgU1VTUEVOREVEKSB7IGNvbnRpbnVlOyB9CiAgICBpZiAoZmxhZ3MgJiBPTkNFKSB7IHJlbW92ZUxpc3RlbmVyKG9iaiwgZXZlbnROYW1lLCB0YXJnZXQsIG1ldGhvZCk7IH0KICAgIGlmICghdGFyZ2V0KSB7IHRhcmdldCA9IG9iajsgfQogICAgaWYgKCdzdHJpbmcnID09PSB0eXBlb2YgbWV0aG9kKSB7IG1ldGhvZCA9IHRhcmdldFttZXRob2RdOyB9CiAgICBpZiAocGFyYW1zKSB7CiAgICAgIG1ldGhvZC5hcHBseSh0YXJnZXQsIHBhcmFtcyk7CiAgICB9IGVsc2UgewogICAgICBtZXRob2QuY2FsbCh0YXJnZXQpOwogICAgfQogIH0KICByZXR1cm4gdHJ1ZTsKfQoKLyoqCiAgQHByaXZhdGUKICBAbWV0aG9kIGhhc0xpc3RlbmVycwogIEBmb3IgRW1iZXIKICBAcGFyYW0gb2JqCiAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50TmFtZQoqLwpmdW5jdGlvbiBoYXNMaXN0ZW5lcnMob2JqLCBldmVudE5hbWUpIHsKICB2YXIgbWV0YSA9IG9ialtNRVRBX0tFWV0sCiAgICAgIGFjdGlvbnMgPSBtZXRhICYmIG1ldGEubGlzdGVuZXJzICYmIG1ldGEubGlzdGVuZXJzW2V2ZW50TmFtZV07CgogIHJldHVybiAhIShhY3Rpb25zICYmIGFjdGlvbnMubGVuZ3RoKTsKfQoKLyoqCiAgQHByaXZhdGUKICBAbWV0aG9kIGxpc3RlbmVyc0ZvcgogIEBmb3IgRW1iZXIKICBAcGFyYW0gb2JqCiAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50TmFtZQoqLwpmdW5jdGlvbiBsaXN0ZW5lcnNGb3Iob2JqLCBldmVudE5hbWUpIHsKICB2YXIgcmV0ID0gW107CiAgdmFyIG1ldGEgPSBvYmpbTUVUQV9LRVldLAogICAgICBhY3Rpb25zID0gbWV0YSAmJiBtZXRhLmxpc3RlbmVycyAmJiBtZXRhLmxpc3RlbmVyc1tldmVudE5hbWVdOwoKICBpZiAoIWFjdGlvbnMpIHsgcmV0dXJuIHJldDsgfQoKICBmb3IgKHZhciBpID0gMCwgbCA9IGFjdGlvbnMubGVuZ3RoOyBpIDwgbDsgaSArPSAzKSB7CiAgICB2YXIgdGFyZ2V0ID0gYWN0aW9uc1tpXSwKICAgICAgICBtZXRob2QgPSBhY3Rpb25zW2krMV07CiAgICByZXQucHVzaChbdGFyZ2V0LCBtZXRob2RdKTsKICB9CgogIHJldHVybiByZXQ7Cn0KCi8qKgogIERlZmluZSBhIHByb3BlcnR5IGFzIGEgZnVuY3Rpb24gdGhhdCBzaG91bGQgYmUgZXhlY3V0ZWQgd2hlbgogIGEgc3BlY2lmaWVkIGV2ZW50IG9yIGV2ZW50cyBhcmUgdHJpZ2dlcmVkLgoKCiAgYGBgIGphdmFzY3JpcHQKICB2YXIgSm9iID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CiAgICBsb2dDb21wbGV0ZWQ6IEVtYmVyLm9uKCdjb21wbGV0ZWQnLCBmdW5jdGlvbigpewogICAgICBjb25zb2xlLmxvZygnSm9iIGNvbXBsZXRlZCEnKTsKICAgIH0pCiAgfSk7CiAgdmFyIGpvYiA9IEpvYi5jcmVhdGUoKTsKICBFbWJlci5zZW5kRXZlbnQoam9iLCAnY29tcGxldGVkJyk7IC8vIExvZ3MgIkpvYiBjb21wbGV0ZWQhIgogYGBgCgogIEBtZXRob2Qgb24KICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50TmFtZXMqCiAgQHBhcmFtIHtGdW5jdGlvbn0gZnVuYwogIEByZXR1cm4gZnVuYwoqLwpFbWJlci5vbiA9IGZ1bmN0aW9uKCl7CiAgdmFyIGZ1bmMgPSBhX3NsaWNlLmNhbGwoYXJndW1lbnRzLCAtMSlbMF0sCiAgICAgIGV2ZW50cyA9IGFfc2xpY2UuY2FsbChhcmd1bWVudHMsIDAsIC0xKTsKICBmdW5jLl9fZW1iZXJfbGlzdGVuc19fID0gZXZlbnRzOwogIHJldHVybiBmdW5jOwp9OwoKRW1iZXIuYWRkTGlzdGVuZXIgPSBhZGRMaXN0ZW5lcjsKRW1iZXIucmVtb3ZlTGlzdGVuZXIgPSByZW1vdmVMaXN0ZW5lcjsKRW1iZXIuX3N1c3BlbmRMaXN0ZW5lciA9IHN1c3BlbmRMaXN0ZW5lcjsKRW1iZXIuX3N1c3BlbmRMaXN0ZW5lcnMgPSBzdXNwZW5kTGlzdGVuZXJzOwpFbWJlci5zZW5kRXZlbnQgPSBzZW5kRXZlbnQ7CkVtYmVyLmhhc0xpc3RlbmVycyA9IGhhc0xpc3RlbmVyczsKRW1iZXIud2F0Y2hlZEV2ZW50cyA9IHdhdGNoZWRFdmVudHM7CkVtYmVyLmxpc3RlbmVyc0ZvciA9IGxpc3RlbmVyc0ZvcjsKRW1iZXIubGlzdGVuZXJzRGlmZiA9IGFjdGlvbnNEaWZmOwpFbWJlci5saXN0ZW5lcnNVbmlvbiA9IGFjdGlvbnNVbmlvbjsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKdmFyIGd1aWRGb3IgPSBFbWJlci5ndWlkRm9yLAogICAgc2VuZEV2ZW50ID0gRW1iZXIuc2VuZEV2ZW50OwoKLyoKICB0aGlzLm9ic2VydmVyU2V0ID0gewogICAgW3NlbmRlckd1aWRdOiB7IC8vIHZhcmlhYmxlIG5hbWU6IGBrZXlTZXRgCiAgICAgIFtrZXlOYW1lXTogbGlzdEluZGV4CiAgICB9CiAgfSwKICB0aGlzLm9ic2VydmVycyA9IFsKICAgIHsKICAgICAgc2VuZGVyOiBvYmosCiAgICAgIGtleU5hbWU6IGtleU5hbWUsCiAgICAgIGV2ZW50TmFtZTogZXZlbnROYW1lLAogICAgICBsaXN0ZW5lcnM6IFsKICAgICAgICBbdGFyZ2V0LCBtZXRob2QsIGZsYWdzXQogICAgICBdCiAgICB9LAogICAgLi4uCiAgXQoqLwp2YXIgT2JzZXJ2ZXJTZXQgPSBFbWJlci5fT2JzZXJ2ZXJTZXQgPSBmdW5jdGlvbigpIHsKICB0aGlzLmNsZWFyKCk7Cn07CgpPYnNlcnZlclNldC5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24oc2VuZGVyLCBrZXlOYW1lLCBldmVudE5hbWUpIHsKICB2YXIgb2JzZXJ2ZXJTZXQgPSB0aGlzLm9ic2VydmVyU2V0LAogICAgICBvYnNlcnZlcnMgPSB0aGlzLm9ic2VydmVycywKICAgICAgc2VuZGVyR3VpZCA9IGd1aWRGb3Ioc2VuZGVyKSwKICAgICAga2V5U2V0ID0gb2JzZXJ2ZXJTZXRbc2VuZGVyR3VpZF0sCiAgICAgIGluZGV4OwoKICBpZiAoIWtleVNldCkgewogICAgb2JzZXJ2ZXJTZXRbc2VuZGVyR3VpZF0gPSBrZXlTZXQgPSB7fTsKICB9CiAgaW5kZXggPSBrZXlTZXRba2V5TmFtZV07CiAgaWYgKGluZGV4ID09PSB1bmRlZmluZWQpIHsKICAgIGluZGV4ID0gb2JzZXJ2ZXJzLnB1c2goewogICAgICBzZW5kZXI6IHNlbmRlciwKICAgICAga2V5TmFtZToga2V5TmFtZSwKICAgICAgZXZlbnROYW1lOiBldmVudE5hbWUsCiAgICAgIGxpc3RlbmVyczogW10KICAgIH0pIC0gMTsKICAgIGtleVNldFtrZXlOYW1lXSA9IGluZGV4OwogIH0KICByZXR1cm4gb2JzZXJ2ZXJzW2luZGV4XS5saXN0ZW5lcnM7Cn07CgpPYnNlcnZlclNldC5wcm90b3R5cGUuZmx1c2ggPSBmdW5jdGlvbigpIHsKICB2YXIgb2JzZXJ2ZXJzID0gdGhpcy5vYnNlcnZlcnMsIGksIGxlbiwgb2JzZXJ2ZXIsIHNlbmRlcjsKICB0aGlzLmNsZWFyKCk7CiAgZm9yIChpPTAsIGxlbj1vYnNlcnZlcnMubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgIG9ic2VydmVyID0gb2JzZXJ2ZXJzW2ldOwogICAgc2VuZGVyID0gb2JzZXJ2ZXIuc2VuZGVyOwogICAgaWYgKHNlbmRlci5pc0Rlc3Ryb3lpbmcgfHwgc2VuZGVyLmlzRGVzdHJveWVkKSB7IGNvbnRpbnVlOyB9CiAgICBzZW5kRXZlbnQoc2VuZGVyLCBvYnNlcnZlci5ldmVudE5hbWUsIFtzZW5kZXIsIG9ic2VydmVyLmtleU5hbWVdLCBvYnNlcnZlci5saXN0ZW5lcnMpOwogIH0KfTsKCk9ic2VydmVyU2V0LnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uKCkgewogIHRoaXMub2JzZXJ2ZXJTZXQgPSB7fTsKICB0aGlzLm9ic2VydmVycyA9IFtdOwp9Owp9KSgpOwoKCgooZnVuY3Rpb24oKSB7CnZhciBtZXRhRm9yID0gRW1iZXIubWV0YSwKICAgIGd1aWRGb3IgPSBFbWJlci5ndWlkRm9yLAogICAgdHJ5RmluYWxseSA9IEVtYmVyLnRyeUZpbmFsbHksCiAgICBzZW5kRXZlbnQgPSBFbWJlci5zZW5kRXZlbnQsCiAgICBsaXN0ZW5lcnNVbmlvbiA9IEVtYmVyLmxpc3RlbmVyc1VuaW9uLAogICAgbGlzdGVuZXJzRGlmZiA9IEVtYmVyLmxpc3RlbmVyc0RpZmYsCiAgICBPYnNlcnZlclNldCA9IEVtYmVyLl9PYnNlcnZlclNldCwKICAgIGJlZm9yZU9ic2VydmVyU2V0ID0gbmV3IE9ic2VydmVyU2V0KCksCiAgICBvYnNlcnZlclNldCA9IG5ldyBPYnNlcnZlclNldCgpLAogICAgZGVmZXJyZWQgPSAwOwoKLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgovLyBQUk9QRVJUWSBDSEFOR0VTCi8vCgovKioKICBUaGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCBqdXN0IGJlZm9yZSBhbiBvYmplY3QgcHJvcGVydHkgaXMgYWJvdXQgdG8gY2hhbmdlLgogIEl0IHdpbGwgbm90aWZ5IGFueSBiZWZvcmUgb2JzZXJ2ZXJzIGFuZCBwcmVwYXJlIGNhY2hlcyBhbW9uZyBvdGhlciB0aGluZ3MuCgogIE5vcm1hbGx5IHlvdSB3aWxsIG5vdCBuZWVkIHRvIGNhbGwgdGhpcyBtZXRob2QgZGlyZWN0bHkgYnV0IGlmIGZvciBzb21lCiAgcmVhc29uIHlvdSBjYW4ndCBkaXJlY3RseSB3YXRjaCBhIHByb3BlcnR5IHlvdSBjYW4gaW52b2tlIHRoaXMgbWV0aG9kCiAgbWFudWFsbHkgYWxvbmcgd2l0aCBgRW1iZXIucHJvcGVydHlEaWRDaGFuZ2UoKWAgd2hpY2ggeW91IHNob3VsZCBjYWxsIGp1c3QKICBhZnRlciB0aGUgcHJvcGVydHkgdmFsdWUgY2hhbmdlcy4KCiAgQG1ldGhvZCBwcm9wZXJ0eVdpbGxDaGFuZ2UKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtPYmplY3R9IG9iaiBUaGUgb2JqZWN0IHdpdGggdGhlIHByb3BlcnR5IHRoYXQgd2lsbCBjaGFuZ2UKICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZSBUaGUgcHJvcGVydHkga2V5IChvciBwYXRoKSB0aGF0IHdpbGwgY2hhbmdlLgogIEByZXR1cm4ge3ZvaWR9CiovCmZ1bmN0aW9uIHByb3BlcnR5V2lsbENoYW5nZShvYmosIGtleU5hbWUpIHsKICB2YXIgbSA9IG1ldGFGb3Iob2JqLCBmYWxzZSksCiAgICAgIHdhdGNoaW5nID0gbS53YXRjaGluZ1trZXlOYW1lXSA+IDAgfHwga2V5TmFtZSA9PT0gJ2xlbmd0aCcsCiAgICAgIHByb3RvID0gbS5wcm90bywKICAgICAgZGVzYyA9IG0uZGVzY3Nba2V5TmFtZV07CgogIGlmICghd2F0Y2hpbmcpIHsgcmV0dXJuOyB9CiAgaWYgKHByb3RvID09PSBvYmopIHsgcmV0dXJuOyB9CiAgaWYgKGRlc2MgJiYgZGVzYy53aWxsQ2hhbmdlKSB7IGRlc2Mud2lsbENoYW5nZShvYmosIGtleU5hbWUpOyB9CiAgZGVwZW5kZW50S2V5c1dpbGxDaGFuZ2Uob2JqLCBrZXlOYW1lLCBtKTsKICBjaGFpbnNXaWxsQ2hhbmdlKG9iaiwga2V5TmFtZSwgbSk7CiAgbm90aWZ5QmVmb3JlT2JzZXJ2ZXJzKG9iaiwga2V5TmFtZSk7Cn0KRW1iZXIucHJvcGVydHlXaWxsQ2hhbmdlID0gcHJvcGVydHlXaWxsQ2hhbmdlOwoKLyoqCiAgVGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQganVzdCBhZnRlciBhbiBvYmplY3QgcHJvcGVydHkgaGFzIGNoYW5nZWQuCiAgSXQgd2lsbCBub3RpZnkgYW55IG9ic2VydmVycyBhbmQgY2xlYXIgY2FjaGVzIGFtb25nIG90aGVyIHRoaW5ncy4KCiAgTm9ybWFsbHkgeW91IHdpbGwgbm90IG5lZWQgdG8gY2FsbCB0aGlzIG1ldGhvZCBkaXJlY3RseSBidXQgaWYgZm9yIHNvbWUKICByZWFzb24geW91IGNhbid0IGRpcmVjdGx5IHdhdGNoIGEgcHJvcGVydHkgeW91IGNhbiBpbnZva2UgdGhpcyBtZXRob2QKICBtYW51YWxseSBhbG9uZyB3aXRoIGBFbWJlci5wcm9wZXJ0eVdpbGxDaGFuZ2UoKWAgd2hpY2ggeW91IHNob3VsZCBjYWxsIGp1c3QKICBiZWZvcmUgdGhlIHByb3BlcnR5IHZhbHVlIGNoYW5nZXMuCgogIEBtZXRob2QgcHJvcGVydHlEaWRDaGFuZ2UKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtPYmplY3R9IG9iaiBUaGUgb2JqZWN0IHdpdGggdGhlIHByb3BlcnR5IHRoYXQgd2lsbCBjaGFuZ2UKICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZSBUaGUgcHJvcGVydHkga2V5IChvciBwYXRoKSB0aGF0IHdpbGwgY2hhbmdlLgogIEByZXR1cm4ge3ZvaWR9CiovCmZ1bmN0aW9uIHByb3BlcnR5RGlkQ2hhbmdlKG9iaiwga2V5TmFtZSkgewogIHZhciBtID0gbWV0YUZvcihvYmosIGZhbHNlKSwKICAgICAgd2F0Y2hpbmcgPSBtLndhdGNoaW5nW2tleU5hbWVdID4gMCB8fCBrZXlOYW1lID09PSAnbGVuZ3RoJywKICAgICAgcHJvdG8gPSBtLnByb3RvLAogICAgICBkZXNjID0gbS5kZXNjc1trZXlOYW1lXTsKCiAgaWYgKHByb3RvID09PSBvYmopIHsgcmV0dXJuOyB9CgogIC8vIHNob3VsZG4ndCB0aGlzIG1lYW4gdGhhdCB3ZSdyZSB3YXRjaGluZyB0aGlzIGtleT8KICBpZiAoZGVzYyAmJiBkZXNjLmRpZENoYW5nZSkgeyBkZXNjLmRpZENoYW5nZShvYmosIGtleU5hbWUpOyB9CiAgaWYgKCF3YXRjaGluZyAmJiBrZXlOYW1lICE9PSAnbGVuZ3RoJykgeyByZXR1cm47IH0KCiAgZGVwZW5kZW50S2V5c0RpZENoYW5nZShvYmosIGtleU5hbWUsIG0pOwogIGNoYWluc0RpZENoYW5nZShvYmosIGtleU5hbWUsIG0sIGZhbHNlKTsKICBub3RpZnlPYnNlcnZlcnMob2JqLCBrZXlOYW1lKTsKfQpFbWJlci5wcm9wZXJ0eURpZENoYW5nZSA9IHByb3BlcnR5RGlkQ2hhbmdlOwoKdmFyIFdJTExfU0VFTiwgRElEX1NFRU47CgovLyBjYWxsZWQgd2hlbmV2ZXIgYSBwcm9wZXJ0eSBpcyBhYm91dCB0byBjaGFuZ2UgdG8gY2xlYXIgdGhlIGNhY2hlIG9mIGFueSBkZXBlbmRlbnQga2V5cyAoYW5kIG5vdGlmeSB0aG9zZSBwcm9wZXJ0aWVzIG9mIGNoYW5nZXMsIGV0Yy4uLikKZnVuY3Rpb24gZGVwZW5kZW50S2V5c1dpbGxDaGFuZ2Uob2JqLCBkZXBLZXksIG1ldGEpIHsKICBpZiAob2JqLmlzRGVzdHJveWluZykgeyByZXR1cm47IH0KCiAgdmFyIHNlZW4gPSBXSUxMX1NFRU4sIHRvcCA9ICFzZWVuOwogIGlmICh0b3ApIHsgc2VlbiA9IFdJTExfU0VFTiA9IHt9OyB9CiAgaXRlckRlcHMocHJvcGVydHlXaWxsQ2hhbmdlLCBvYmosIGRlcEtleSwgc2VlbiwgbWV0YSk7CiAgaWYgKHRvcCkgeyBXSUxMX1NFRU4gPSBudWxsOyB9Cn0KCi8vIGNhbGxlZCB3aGVuZXZlciBhIHByb3BlcnR5IGhhcyBqdXN0IGNoYW5nZWQgdG8gdXBkYXRlIGRlcGVuZGVudCBrZXlzCmZ1bmN0aW9uIGRlcGVuZGVudEtleXNEaWRDaGFuZ2Uob2JqLCBkZXBLZXksIG1ldGEpIHsKICBpZiAob2JqLmlzRGVzdHJveWluZykgeyByZXR1cm47IH0KCiAgdmFyIHNlZW4gPSBESURfU0VFTiwgdG9wID0gIXNlZW47CiAgaWYgKHRvcCkgeyBzZWVuID0gRElEX1NFRU4gPSB7fTsgfQogIGl0ZXJEZXBzKHByb3BlcnR5RGlkQ2hhbmdlLCBvYmosIGRlcEtleSwgc2VlbiwgbWV0YSk7CiAgaWYgKHRvcCkgeyBESURfU0VFTiA9IG51bGw7IH0KfQoKZnVuY3Rpb24gaXRlckRlcHMobWV0aG9kLCBvYmosIGRlcEtleSwgc2VlbiwgbWV0YSkgewogIHZhciBndWlkID0gZ3VpZEZvcihvYmopOwogIGlmICghc2VlbltndWlkXSkgc2VlbltndWlkXSA9IHt9OwogIGlmIChzZWVuW2d1aWRdW2RlcEtleV0pIHJldHVybjsKICBzZWVuW2d1aWRdW2RlcEtleV0gPSB0cnVlOwoKICB2YXIgZGVwcyA9IG1ldGEuZGVwczsKICBkZXBzID0gZGVwcyAmJiBkZXBzW2RlcEtleV07CiAgaWYgKGRlcHMpIHsKICAgIGZvcih2YXIga2V5IGluIGRlcHMpIHsKICAgICAgdmFyIGRlc2MgPSBtZXRhLmRlc2NzW2tleV07CiAgICAgIGlmIChkZXNjICYmIGRlc2MuX3N1c3BlbmRlZCA9PT0gb2JqKSBjb250aW51ZTsKICAgICAgbWV0aG9kKG9iaiwga2V5KTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGNoYWluc1dpbGxDaGFuZ2Uob2JqLCBrZXlOYW1lLCBtKSB7CiAgaWYgKCEobS5oYXNPd25Qcm9wZXJ0eSgnY2hhaW5XYXRjaGVycycpICYmCiAgICAgICAgbS5jaGFpbldhdGNoZXJzW2tleU5hbWVdKSkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIG5vZGVzID0gbS5jaGFpbldhdGNoZXJzW2tleU5hbWVdLAogICAgICBldmVudHMgPSBbXSwKICAgICAgaSwgbDsKCiAgZm9yKGkgPSAwLCBsID0gbm9kZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICBub2Rlc1tpXS53aWxsQ2hhbmdlKGV2ZW50cyk7CiAgfQoKICBmb3IgKGkgPSAwLCBsID0gZXZlbnRzLmxlbmd0aDsgaSA8IGw7IGkgKz0gMikgewogICAgcHJvcGVydHlXaWxsQ2hhbmdlKGV2ZW50c1tpXSwgZXZlbnRzW2krMV0pOwogIH0KfQoKZnVuY3Rpb24gY2hhaW5zRGlkQ2hhbmdlKG9iaiwga2V5TmFtZSwgbSwgc3VwcHJlc3NFdmVudHMpIHsKICBpZiAoIShtLmhhc093blByb3BlcnR5KCdjaGFpbldhdGNoZXJzJykgJiYKICAgICAgICBtLmNoYWluV2F0Y2hlcnNba2V5TmFtZV0pKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgbm9kZXMgPSBtLmNoYWluV2F0Y2hlcnNba2V5TmFtZV0sCiAgICAgIGV2ZW50cyA9IHN1cHByZXNzRXZlbnRzID8gbnVsbCA6IFtdLAogICAgICBpLCBsOwoKICBmb3IoaSA9IDAsIGwgPSBub2Rlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIG5vZGVzW2ldLmRpZENoYW5nZShldmVudHMpOwogIH0KCiAgaWYgKHN1cHByZXNzRXZlbnRzKSB7CiAgICByZXR1cm47CiAgfQoKICBmb3IgKGkgPSAwLCBsID0gZXZlbnRzLmxlbmd0aDsgaSA8IGw7IGkgKz0gMikgewogICAgcHJvcGVydHlEaWRDaGFuZ2UoZXZlbnRzW2ldLCBldmVudHNbaSsxXSk7CiAgfQp9CgpFbWJlci5vdmVycmlkZUNoYWlucyA9IGZ1bmN0aW9uKG9iaiwga2V5TmFtZSwgbSkgewogIGNoYWluc0RpZENoYW5nZShvYmosIGtleU5hbWUsIG0sIHRydWUpOwp9OwoKLyoqCiAgQG1ldGhvZCBiZWdpblByb3BlcnR5Q2hhbmdlcwogIEBjaGFpbmFibGUKICBAcHJpdmF0ZQoqLwpmdW5jdGlvbiBiZWdpblByb3BlcnR5Q2hhbmdlcygpIHsKICBkZWZlcnJlZCsrOwp9CgpFbWJlci5iZWdpblByb3BlcnR5Q2hhbmdlcyA9IGJlZ2luUHJvcGVydHlDaGFuZ2VzOwoKLyoqCiAgQG1ldGhvZCBlbmRQcm9wZXJ0eUNoYW5nZXMKICBAcHJpdmF0ZQoqLwpmdW5jdGlvbiBlbmRQcm9wZXJ0eUNoYW5nZXMoKSB7CiAgZGVmZXJyZWQtLTsKICBpZiAoZGVmZXJyZWQ8PTApIHsKICAgIGJlZm9yZU9ic2VydmVyU2V0LmNsZWFyKCk7CiAgICBvYnNlcnZlclNldC5mbHVzaCgpOwogIH0KfQoKRW1iZXIuZW5kUHJvcGVydHlDaGFuZ2VzID0gZW5kUHJvcGVydHlDaGFuZ2VzOwoKLyoqCiAgTWFrZSBhIHNlcmllcyBvZiBwcm9wZXJ0eSBjaGFuZ2VzIHRvZ2V0aGVyIGluIGFuCiAgZXhjZXB0aW9uLXNhZmUgd2F5LgoKICBgYGBqYXZhc2NyaXB0CiAgRW1iZXIuY2hhbmdlUHJvcGVydGllcyhmdW5jdGlvbigpIHsKICAgIG9iajEuc2V0KCdmb28nLCBtYXlCbG93VXBXaGVuU2V0KTsKICAgIG9iajIuc2V0KCdiYXInLCBiYXopOwogIH0pOwogIGBgYAoKICBAbWV0aG9kIGNoYW5nZVByb3BlcnRpZXMKICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjawogIEBwYXJhbSBbYmluZGluZ10KKi8KRW1iZXIuY2hhbmdlUHJvcGVydGllcyA9IGZ1bmN0aW9uKGNiLCBiaW5kaW5nKSB7CiAgYmVnaW5Qcm9wZXJ0eUNoYW5nZXMoKTsKICB0cnlGaW5hbGx5KGNiLCBlbmRQcm9wZXJ0eUNoYW5nZXMsIGJpbmRpbmcpOwp9OwoKZnVuY3Rpb24gbm90aWZ5QmVmb3JlT2JzZXJ2ZXJzKG9iaiwga2V5TmFtZSkgewogIGlmIChvYmouaXNEZXN0cm95aW5nKSB7IHJldHVybjsgfQoKICB2YXIgZXZlbnROYW1lID0ga2V5TmFtZSArICc6YmVmb3JlJywgbGlzdGVuZXJzLCBkaWZmOwogIGlmIChkZWZlcnJlZCkgewogICAgbGlzdGVuZXJzID0gYmVmb3JlT2JzZXJ2ZXJTZXQuYWRkKG9iaiwga2V5TmFtZSwgZXZlbnROYW1lKTsKICAgIGRpZmYgPSBsaXN0ZW5lcnNEaWZmKG9iaiwgZXZlbnROYW1lLCBsaXN0ZW5lcnMpOwogICAgc2VuZEV2ZW50KG9iaiwgZXZlbnROYW1lLCBbb2JqLCBrZXlOYW1lXSwgZGlmZik7CiAgfSBlbHNlIHsKICAgIHNlbmRFdmVudChvYmosIGV2ZW50TmFtZSwgW29iaiwga2V5TmFtZV0pOwogIH0KfQoKZnVuY3Rpb24gbm90aWZ5T2JzZXJ2ZXJzKG9iaiwga2V5TmFtZSkgewogIGlmIChvYmouaXNEZXN0cm95aW5nKSB7IHJldHVybjsgfQoKICB2YXIgZXZlbnROYW1lID0ga2V5TmFtZSArICc6Y2hhbmdlJywgbGlzdGVuZXJzOwogIGlmIChkZWZlcnJlZCkgewogICAgbGlzdGVuZXJzID0gb2JzZXJ2ZXJTZXQuYWRkKG9iaiwga2V5TmFtZSwgZXZlbnROYW1lKTsKICAgIGxpc3RlbmVyc1VuaW9uKG9iaiwgZXZlbnROYW1lLCBsaXN0ZW5lcnMpOwogIH0gZWxzZSB7CiAgICBzZW5kRXZlbnQob2JqLCBldmVudE5hbWUsIFtvYmosIGtleU5hbWVdKTsKICB9Cn0KCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLy8gTUVUQV9LRVkKLy8gX2dldFBhdGgKLy8gcHJvcGVydHlXaWxsQ2hhbmdlLCBwcm9wZXJ0eURpZENoYW5nZQoKdmFyIE1FVEFfS0VZID0gRW1iZXIuTUVUQV9LRVksCiAgICBNQU5EQVRPUllfU0VUVEVSID0gRW1iZXIuRU5WLk1BTkRBVE9SWV9TRVRURVIsCiAgICBJU19HTE9CQUwgPSAvXihbQS1aJF18KFswLTldW0EtWiRdKSkvLAogICAgZ2V0UGF0aCA9IEVtYmVyLl9nZXRQYXRoOwoKLyoqCiAgU2V0cyB0aGUgdmFsdWUgb2YgYSBwcm9wZXJ0eSBvbiBhbiBvYmplY3QsIHJlc3BlY3RpbmcgY29tcHV0ZWQgcHJvcGVydGllcwogIGFuZCBub3RpZnlpbmcgb2JzZXJ2ZXJzIGFuZCBvdGhlciBsaXN0ZW5lcnMgb2YgdGhlIGNoYW5nZS4gSWYgdGhlCiAgcHJvcGVydHkgaXMgbm90IGRlZmluZWQgYnV0IHRoZSBvYmplY3QgaW1wbGVtZW50cyB0aGUgYHNldFVua25vd25Qcm9wZXJ0eWAKICBtZXRob2QgdGhlbiB0aGF0IHdpbGwgYmUgaW52b2tlZCBhcyB3ZWxsLgoKICBJZiB5b3UgcGxhbiB0byBydW4gb24gSUU4IGFuZCBvbGRlciBicm93c2VycyB0aGVuIHlvdSBzaG91bGQgdXNlIHRoaXMKICBtZXRob2QgYW55dGltZSB5b3Ugd2FudCB0byBzZXQgYSBwcm9wZXJ0eSBvbiBhbiBvYmplY3QgdGhhdCB5b3UgZG9uJ3QKICBrbm93IGZvciBzdXJlIGlzIHByaXZhdGUuIChQcm9wZXJ0aWVzIGJlZ2lubmluZyB3aXRoIGFuIHVuZGVyc2NvcmUgJ18nCiAgYXJlIGNvbnNpZGVyZWQgcHJpdmF0ZS4pCgogIE9uIGFsbCBuZXdlciBicm93c2VycywgeW91IG9ubHkgbmVlZCB0byB1c2UgdGhpcyBtZXRob2QgdG8gc2V0CiAgcHJvcGVydGllcyBpZiB0aGUgcHJvcGVydHkgbWlnaHQgbm90IGJlIGRlZmluZWQgb24gdGhlIG9iamVjdCBhbmQgeW91IHdhbnQKICB0byByZXNwZWN0IHRoZSBgc2V0VW5rbm93blByb3BlcnR5YCBoYW5kbGVyLiBPdGhlcndpc2UgeW91IGNhbiBpZ25vcmUgdGhpcwogIG1ldGhvZC4KCiAgQG1ldGhvZCBzZXQKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtPYmplY3R9IG9iaiBUaGUgb2JqZWN0IHRvIG1vZGlmeS4KICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZSBUaGUgcHJvcGVydHkga2V5IHRvIHNldAogIEBwYXJhbSB7T2JqZWN0fSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2V0CiAgQHJldHVybiB7T2JqZWN0fSB0aGUgcGFzc2VkIHZhbHVlLgoqLwp2YXIgc2V0ID0gZnVuY3Rpb24gc2V0KG9iaiwga2V5TmFtZSwgdmFsdWUsIHRvbGVyYW50KSB7CiAgaWYgKHR5cGVvZiBvYmogPT09ICdzdHJpbmcnKSB7CiAgICBFbWJlci5hc3NlcnQoIlBhdGggJyIgKyBvYmogKyAiJyBtdXN0IGJlIGdsb2JhbCBpZiBubyBvYmogaXMgZ2l2ZW4uIiwgSVNfR0xPQkFMLnRlc3Qob2JqKSk7CiAgICB2YWx1ZSA9IGtleU5hbWU7CiAgICBrZXlOYW1lID0gb2JqOwogICAgb2JqID0gbnVsbDsKICB9CgogIEVtYmVyLmFzc2VydCgiQ2Fubm90IGNhbGwgc2V0IHdpdGggIisga2V5TmFtZSArIiBrZXkuIiwgISFrZXlOYW1lKTsKCiAgaWYgKCFvYmogfHwga2V5TmFtZS5pbmRleE9mKCcuJykgIT09IC0xKSB7CiAgICByZXR1cm4gc2V0UGF0aChvYmosIGtleU5hbWUsIHZhbHVlLCB0b2xlcmFudCk7CiAgfQoKICBFbWJlci5hc3NlcnQoIllvdSBuZWVkIHRvIHByb3ZpZGUgYW4gb2JqZWN0IGFuZCBrZXkgdG8gYHNldGAuIiwgISFvYmogJiYga2V5TmFtZSAhPT0gdW5kZWZpbmVkKTsKICBFbWJlci5hc3NlcnQoJ2NhbGxpbmcgc2V0IG9uIGRlc3Ryb3llZCBvYmplY3QnLCAhb2JqLmlzRGVzdHJveWVkKTsKCiAgdmFyIG1ldGEgPSBvYmpbTUVUQV9LRVldLCBkZXNjID0gbWV0YSAmJiBtZXRhLmRlc2NzW2tleU5hbWVdLAogICAgICBpc1Vua25vd24sIGN1cnJlbnRWYWx1ZTsKICBpZiAoZGVzYykgewogICAgZGVzYy5zZXQob2JqLCBrZXlOYW1lLCB2YWx1ZSk7CiAgfSBlbHNlIHsKICAgIGlzVW5rbm93biA9ICdvYmplY3QnID09PSB0eXBlb2Ygb2JqICYmICEoa2V5TmFtZSBpbiBvYmopOwoKICAgIC8vIHNldFVua25vd25Qcm9wZXJ0eSBpcyBjYWxsZWQgaWYgYG9iamAgaXMgYW4gb2JqZWN0LAogICAgLy8gdGhlIHByb3BlcnR5IGRvZXMgbm90IGFscmVhZHkgZXhpc3QsIGFuZCB0aGUKICAgIC8vIGBzZXRVbmtub3duUHJvcGVydHlgIG1ldGhvZCBleGlzdHMgb24gdGhlIG9iamVjdAogICAgaWYgKGlzVW5rbm93biAmJiAnZnVuY3Rpb24nID09PSB0eXBlb2Ygb2JqLnNldFVua25vd25Qcm9wZXJ0eSkgewogICAgICBvYmouc2V0VW5rbm93blByb3BlcnR5KGtleU5hbWUsIHZhbHVlKTsKICAgIH0gZWxzZSBpZiAobWV0YSAmJiBtZXRhLndhdGNoaW5nW2tleU5hbWVdID4gMCkgewogICAgICBpZiAoTUFOREFUT1JZX1NFVFRFUikgewogICAgICAgIGN1cnJlbnRWYWx1ZSA9IG1ldGEudmFsdWVzW2tleU5hbWVdOwogICAgICB9IGVsc2UgewogICAgICAgIGN1cnJlbnRWYWx1ZSA9IG9ialtrZXlOYW1lXTsKICAgICAgfQogICAgICAvLyBvbmx5IHRyaWdnZXIgYSBjaGFuZ2UgaWYgdGhlIHZhbHVlIGhhcyBjaGFuZ2VkCiAgICAgIGlmICh2YWx1ZSAhPT0gY3VycmVudFZhbHVlKSB7CiAgICAgICAgRW1iZXIucHJvcGVydHlXaWxsQ2hhbmdlKG9iaiwga2V5TmFtZSk7CiAgICAgICAgaWYgKE1BTkRBVE9SWV9TRVRURVIpIHsKICAgICAgICAgIGlmICgoY3VycmVudFZhbHVlID09PSB1bmRlZmluZWQgJiYgIShrZXlOYW1lIGluIG9iaikpIHx8ICFvYmoucHJvcGVydHlJc0VudW1lcmFibGUoa2V5TmFtZSkpIHsKICAgICAgICAgICAgRW1iZXIuZGVmaW5lUHJvcGVydHkob2JqLCBrZXlOYW1lLCBudWxsLCB2YWx1ZSk7IC8vIHNldHVwIG1hbmRhdG9yeSBzZXR0ZXIKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG1ldGEudmFsdWVzW2tleU5hbWVdID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9ialtrZXlOYW1lXSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICBFbWJlci5wcm9wZXJ0eURpZENoYW5nZShvYmosIGtleU5hbWUpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBvYmpba2V5TmFtZV0gPSB2YWx1ZTsKICAgIH0KICB9CiAgcmV0dXJuIHZhbHVlOwp9OwoKLy8gQ3VycmVudGx5IHVzZWQgb25seSBieSBFbWJlciBEYXRhIHRlc3RzCmlmIChFbWJlci5jb25maWcub3ZlcnJpZGVBY2Nlc3NvcnMpIHsKICBFbWJlci5zZXQgPSBzZXQ7CiAgRW1iZXIuY29uZmlnLm92ZXJyaWRlQWNjZXNzb3JzKCk7CiAgc2V0ID0gRW1iZXIuc2V0Owp9CgpmdW5jdGlvbiBzZXRQYXRoKHJvb3QsIHBhdGgsIHZhbHVlLCB0b2xlcmFudCkgewogIHZhciBrZXlOYW1lOwoKICAvLyBnZXQgdGhlIGxhc3QgcGFydCBvZiB0aGUgcGF0aAogIGtleU5hbWUgPSBwYXRoLnNsaWNlKHBhdGgubGFzdEluZGV4T2YoJy4nKSArIDEpOwoKICAvLyBnZXQgdGhlIGZpcnN0IHBhcnQgb2YgdGhlIHBhcnQKICBwYXRoICAgID0gKHBhdGggPT09IGtleU5hbWUpID8ga2V5TmFtZSA6IHBhdGguc2xpY2UoMCwgcGF0aC5sZW5ndGgtKGtleU5hbWUubGVuZ3RoKzEpKTsKCiAgLy8gdW5sZXNzIHRoZSBwYXRoIGlzIHRoaXMsIGxvb2sgdXAgdGhlIGZpcnN0IHBhcnQgdG8KICAvLyBnZXQgdGhlIHJvb3QKICBpZiAocGF0aCAhPT0gJ3RoaXMnKSB7CiAgICByb290ID0gZ2V0UGF0aChyb290LCBwYXRoKTsKICB9CgogIGlmICgha2V5TmFtZSB8fCBrZXlOYW1lLmxlbmd0aCA9PT0gMCkgewogICAgdGhyb3cgbmV3IEVtYmVyLkVycm9yKCdQcm9wZXJ0eSBzZXQgZmFpbGVkOiBZb3UgcGFzc2VkIGFuIGVtcHR5IHBhdGgnKTsKICB9CgogIGlmICghcm9vdCkgewogICAgaWYgKHRvbGVyYW50KSB7IHJldHVybjsgfQogICAgZWxzZSB7IHRocm93IG5ldyBFbWJlci5FcnJvcignUHJvcGVydHkgc2V0IGZhaWxlZDogb2JqZWN0IGluIHBhdGggIicrcGF0aCsnIiBjb3VsZCBub3QgYmUgZm91bmQgb3Igd2FzIGRlc3Ryb3llZC4nKTsgfQogIH0KCiAgcmV0dXJuIHNldChyb290LCBrZXlOYW1lLCB2YWx1ZSk7Cn0KCkVtYmVyLnNldCA9IHNldDsKCi8qKgogIEVycm9yLXRvbGVyYW50IGZvcm0gb2YgYEVtYmVyLnNldGAuIFdpbGwgbm90IGJsb3cgdXAgaWYgYW55IHBhcnQgb2YgdGhlCiAgY2hhaW4gaXMgYHVuZGVmaW5lZGAsIGBudWxsYCwgb3IgZGVzdHJveWVkLgoKICBUaGlzIGlzIHByaW1hcmlseSB1c2VkIHdoZW4gc3luY2luZyBiaW5kaW5ncywgd2hpY2ggbWF5IHRyeSB0byB1cGRhdGUgYWZ0ZXIKICBhbiBvYmplY3QgaGFzIGJlZW4gZGVzdHJveWVkLgoKICBAbWV0aG9kIHRyeVNldAogIEBmb3IgRW1iZXIKICBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgdG8gbW9kaWZ5LgogIEBwYXJhbSB7U3RyaW5nfSBwYXRoIFRoZSBwcm9wZXJ0eSBwYXRoIHRvIHNldAogIEBwYXJhbSB7T2JqZWN0fSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2V0CiovCkVtYmVyLnRyeVNldCA9IGZ1bmN0aW9uKHJvb3QsIHBhdGgsIHZhbHVlKSB7CiAgcmV0dXJuIHNldChyb290LCBwYXRoLCB2YWx1ZSwgdHJ1ZSk7Cn07Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyLW1ldGFsCiovCgovKgogIEphdmFTY3JpcHQgKGJlZm9yZSBFUzYpIGRvZXMgbm90IGhhdmUgYSBNYXAgaW1wbGVtZW50YXRpb24uIE9iamVjdHMsCiAgd2hpY2ggYXJlIG9mdGVuIHVzZWQgYXMgZGljdGlvbmFyaWVzLCBtYXkgb25seSBoYXZlIFN0cmluZ3MgYXMga2V5cy4KCiAgQmVjYXVzZSBFbWJlciBoYXMgYSB3YXkgdG8gZ2V0IGEgdW5pcXVlIGlkZW50aWZpZXIgZm9yIGV2ZXJ5IG9iamVjdAogIHZpYSBgRW1iZXIuZ3VpZEZvcmAsIHdlIGNhbiBpbXBsZW1lbnQgYSBwZXJmb3JtYW50IE1hcCB3aXRoIGFyYml0cmFyeQogIGtleXMuIEJlY2F1c2UgaXQgaXMgY29tbW9ubHkgdXNlZCBpbiBsb3ctbGV2ZWwgYm9va2tlZXBpbmcsIE1hcCBpcwogIGltcGxlbWVudGVkIGFzIGEgcHVyZSBKYXZhU2NyaXB0IG9iamVjdCBmb3IgcGVyZm9ybWFuY2UuCgogIFRoaXMgaW1wbGVtZW50YXRpb24gZm9sbG93cyB0aGUgY3VycmVudCBpdGVyYXRpb24gb2YgdGhlIEVTNiBwcm9wb3NhbCBmb3IKICBtYXBzIChodHRwOi8vd2lraS5lY21hc2NyaXB0Lm9yZy9kb2t1LnBocD9pZD1oYXJtb255OnNpbXBsZV9tYXBzX2FuZF9zZXRzKSwKICB3aXRoIHR3byBleGNlcHRpb25zLiBGaXJzdCwgYmVjYXVzZSB3ZSBuZWVkIG91ciBpbXBsZW1lbnRhdGlvbiB0byBiZSBwbGVhc2FudAogIG9uIG9sZGVyIGJyb3dzZXJzLCB3ZSBkbyBub3QgdXNlIHRoZSBgZGVsZXRlYCBuYW1lICh1c2luZyBgcmVtb3ZlYCBpbnN0ZWFkKS4KICBTZWNvbmQsIGFzIHdlIGRvIG5vdCBoYXZlIHRoZSBsdXh1cnkgb2YgaW4tVk0gaXRlcmF0aW9uLCB3ZSBpbXBsZW1lbnQgYQogIGZvckVhY2ggbWV0aG9kIGZvciBpdGVyYXRpb24uCgogIE1hcCBpcyBtb2NrZWQgb3V0IHRvIGxvb2sgbGlrZSBhbiBFbWJlciBvYmplY3QsIHNvIHlvdSBjYW4gZG8KICBgRW1iZXIuTWFwLmNyZWF0ZSgpYCBmb3Igc3ltbWV0cnkgd2l0aCBvdGhlciBFbWJlciBjbGFzc2VzLgoqLwp2YXIgc2V0ID0gRW1iZXIuc2V0LAogICAgZ3VpZEZvciA9IEVtYmVyLmd1aWRGb3IsCiAgICBpbmRleE9mID0gRW1iZXIuQXJyYXlQb2x5ZmlsbHMuaW5kZXhPZjsKCnZhciBjb3B5ID0gZnVuY3Rpb24ob2JqKSB7CiAgdmFyIG91dHB1dCA9IHt9OwoKICBmb3IgKHZhciBwcm9wIGluIG9iaikgewogICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgeyBvdXRwdXRbcHJvcF0gPSBvYmpbcHJvcF07IH0KICB9CgogIHJldHVybiBvdXRwdXQ7Cn07Cgp2YXIgY29weU1hcCA9IGZ1bmN0aW9uKG9yaWdpbmFsLCBuZXdPYmplY3QpIHsKICB2YXIga2V5cyA9IG9yaWdpbmFsLmtleXMuY29weSgpLAogICAgICB2YWx1ZXMgPSBjb3B5KG9yaWdpbmFsLnZhbHVlcyk7CgogIG5ld09iamVjdC5rZXlzID0ga2V5czsKICBuZXdPYmplY3QudmFsdWVzID0gdmFsdWVzOwogIG5ld09iamVjdC5sZW5ndGggPSBvcmlnaW5hbC5sZW5ndGg7CgogIHJldHVybiBuZXdPYmplY3Q7Cn07CgovKioKICBUaGlzIGNsYXNzIGlzIHVzZWQgaW50ZXJuYWxseSBieSBFbWJlciBhbmQgRW1iZXIgRGF0YS4KICBQbGVhc2UgZG8gbm90IHVzZSBpdCBhdCB0aGlzIHRpbWUuIFdlIHBsYW4gdG8gY2xlYW4gaXQgdXAKICBhbmQgYWRkIG1hbnkgdGVzdHMgc29vbi4KCiAgQGNsYXNzIE9yZGVyZWRTZXQKICBAbmFtZXNwYWNlIEVtYmVyCiAgQGNvbnN0cnVjdG9yCiAgQHByaXZhdGUKKi8KdmFyIE9yZGVyZWRTZXQgPSBFbWJlci5PcmRlcmVkU2V0ID0gZnVuY3Rpb24oKSB7CiAgdGhpcy5jbGVhcigpOwp9OwoKLyoqCiAgQG1ldGhvZCBjcmVhdGUKICBAc3RhdGljCiAgQHJldHVybiB7RW1iZXIuT3JkZXJlZFNldH0KKi8KT3JkZXJlZFNldC5jcmVhdGUgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gbmV3IE9yZGVyZWRTZXQoKTsKfTsKCgpPcmRlcmVkU2V0LnByb3RvdHlwZSA9IHsKICAvKioKICAgIEBtZXRob2QgY2xlYXIKICAqLwogIGNsZWFyOiBmdW5jdGlvbigpIHsKICAgIHRoaXMucHJlc2VuY2VTZXQgPSB7fTsKICAgIHRoaXMubGlzdCA9IFtdOwogIH0sCgogIC8qKgogICAgQG1ldGhvZCBhZGQKICAgIEBwYXJhbSBvYmoKICAqLwogIGFkZDogZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgZ3VpZCA9IGd1aWRGb3Iob2JqKSwKICAgICAgICBwcmVzZW5jZVNldCA9IHRoaXMucHJlc2VuY2VTZXQsCiAgICAgICAgbGlzdCA9IHRoaXMubGlzdDsKCiAgICBpZiAoZ3VpZCBpbiBwcmVzZW5jZVNldCkgeyByZXR1cm47IH0KCiAgICBwcmVzZW5jZVNldFtndWlkXSA9IHRydWU7CiAgICBsaXN0LnB1c2gob2JqKTsKICB9LAoKICAvKioKICAgIEBtZXRob2QgcmVtb3ZlCiAgICBAcGFyYW0gb2JqCiAgKi8KICByZW1vdmU6IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGd1aWQgPSBndWlkRm9yKG9iaiksCiAgICAgICAgcHJlc2VuY2VTZXQgPSB0aGlzLnByZXNlbmNlU2V0LAogICAgICAgIGxpc3QgPSB0aGlzLmxpc3Q7CgogICAgZGVsZXRlIHByZXNlbmNlU2V0W2d1aWRdOwoKICAgIHZhciBpbmRleCA9IGluZGV4T2YuY2FsbChsaXN0LCBvYmopOwogICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgbGlzdC5zcGxpY2UoaW5kZXgsIDEpOwogICAgfQogIH0sCgogIC8qKgogICAgQG1ldGhvZCBpc0VtcHR5CiAgICBAcmV0dXJuIHtCb29sZWFufQogICovCiAgaXNFbXB0eTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5saXN0Lmxlbmd0aCA9PT0gMDsKICB9LAoKICAvKioKICAgIEBtZXRob2QgaGFzCiAgICBAcGFyYW0gb2JqCiAgICBAcmV0dXJuIHtCb29sZWFufQogICovCiAgaGFzOiBmdW5jdGlvbihvYmopIHsKICAgIHZhciBndWlkID0gZ3VpZEZvcihvYmopLAogICAgICAgIHByZXNlbmNlU2V0ID0gdGhpcy5wcmVzZW5jZVNldDsKCiAgICByZXR1cm4gZ3VpZCBpbiBwcmVzZW5jZVNldDsKICB9LAoKICAvKioKICAgIEBtZXRob2QgZm9yRWFjaAogICAgQHBhcmFtIHtGdW5jdGlvbn0gZm4KICAgIEBwYXJhbSBzZWxmCiAgKi8KICBmb3JFYWNoOiBmdW5jdGlvbihmbiwgc2VsZikgewogICAgLy8gYWxsb3cgbXV0YXRpb24gZHVyaW5nIGl0ZXJhdGlvbgogICAgdmFyIGxpc3QgPSB0aGlzLnRvQXJyYXkoKTsKCiAgICBmb3IgKHZhciBpID0gMCwgaiA9IGxpc3QubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgIGZuLmNhbGwoc2VsZiwgbGlzdFtpXSk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIHRvQXJyYXkKICAgIEByZXR1cm4ge0FycmF5fQogICovCiAgdG9BcnJheTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5saXN0LnNsaWNlKCk7CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIGNvcHkKICAgIEByZXR1cm4ge0VtYmVyLk9yZGVyZWRTZXR9CiAgKi8KICBjb3B5OiBmdW5jdGlvbigpIHsKICAgIHZhciBzZXQgPSBuZXcgT3JkZXJlZFNldCgpOwoKICAgIHNldC5wcmVzZW5jZVNldCA9IGNvcHkodGhpcy5wcmVzZW5jZVNldCk7CiAgICBzZXQubGlzdCA9IHRoaXMudG9BcnJheSgpOwoKICAgIHJldHVybiBzZXQ7CiAgfQp9OwoKLyoqCiAgQSBNYXAgc3RvcmVzIHZhbHVlcyBpbmRleGVkIGJ5IGtleXMuIFVubGlrZSBKYXZhU2NyaXB0J3MKICBkZWZhdWx0IE9iamVjdHMsIHRoZSBrZXlzIG9mIGEgTWFwIGNhbiBiZSBhbnkgSmF2YVNjcmlwdAogIG9iamVjdC4KCiAgSW50ZXJuYWxseSwgYSBNYXAgaGFzIHR3byBkYXRhIHN0cnVjdHVyZXM6CgogIDEuIGBrZXlzYDogYW4gT3JkZXJlZFNldCBvZiBhbGwgb2YgdGhlIGV4aXN0aW5nIGtleXMKICAyLiBgdmFsdWVzYDogYSBKYXZhU2NyaXB0IE9iamVjdCBpbmRleGVkIGJ5IHRoZSBgRW1iZXIuZ3VpZEZvcihrZXkpYAoKICBXaGVuIGEga2V5L3ZhbHVlIHBhaXIgaXMgYWRkZWQgZm9yIHRoZSBmaXJzdCB0aW1lLCB3ZQogIGFkZCB0aGUga2V5IHRvIHRoZSBga2V5c2AgT3JkZXJlZFNldCwgYW5kIGNyZWF0ZSBvcgogIHJlcGxhY2UgYW4gZW50cnkgaW4gYHZhbHVlc2AuIFdoZW4gYW4gZW50cnkgaXMgZGVsZXRlZCwKICB3ZSBkZWxldGUgaXRzIGVudHJ5IGluIGBrZXlzYCBhbmQgYHZhbHVlc2AuCgogIEBjbGFzcyBNYXAKICBAbmFtZXNwYWNlIEVtYmVyCiAgQHByaXZhdGUKICBAY29uc3RydWN0b3IKKi8KdmFyIE1hcCA9IEVtYmVyLk1hcCA9IGZ1bmN0aW9uKCkgewogIHRoaXMua2V5cyA9IEVtYmVyLk9yZGVyZWRTZXQuY3JlYXRlKCk7CiAgdGhpcy52YWx1ZXMgPSB7fTsKfTsKCi8qKgogIEBtZXRob2QgY3JlYXRlCiAgQHN0YXRpYwoqLwpNYXAuY3JlYXRlID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIG5ldyBNYXAoKTsKfTsKCk1hcC5wcm90b3R5cGUgPSB7CiAgLyoqCiAgICBUaGlzIHByb3BlcnR5IHdpbGwgY2hhbmdlIGFzIHRoZSBudW1iZXIgb2Ygb2JqZWN0cyBpbiB0aGUgbWFwIGNoYW5nZXMuCiAgIAogICAgQHByb3BlcnR5IGxlbmd0aAogICAgQHR5cGUgbnVtYmVyCiAgICBAZGVmYXVsdCAwCiAgKi8KICBsZW5ndGg6IDAsCiAgICAKICAgIAogIC8qKgogICAgUmV0cmlldmUgdGhlIHZhbHVlIGFzc29jaWF0ZWQgd2l0aCBhIGdpdmVuIGtleS4KCiAgICBAbWV0aG9kIGdldAogICAgQHBhcmFtIHsqfSBrZXkKICAgIEByZXR1cm4geyp9IHRoZSB2YWx1ZSBhc3NvY2lhdGVkIHdpdGggdGhlIGtleSwgb3IgYHVuZGVmaW5lZGAKICAqLwogIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICB2YXIgdmFsdWVzID0gdGhpcy52YWx1ZXMsCiAgICAgICAgZ3VpZCA9IGd1aWRGb3Ioa2V5KTsKCiAgICByZXR1cm4gdmFsdWVzW2d1aWRdOwogIH0sCgogIC8qKgogICAgQWRkcyBhIHZhbHVlIHRvIHRoZSBtYXAuIElmIGEgdmFsdWUgZm9yIHRoZSBnaXZlbiBrZXkgaGFzIGFscmVhZHkgYmVlbgogICAgcHJvdmlkZWQsIHRoZSBuZXcgdmFsdWUgd2lsbCByZXBsYWNlIHRoZSBvbGQgdmFsdWUuCgogICAgQG1ldGhvZCBzZXQKICAgIEBwYXJhbSB7Kn0ga2V5CiAgICBAcGFyYW0geyp9IHZhbHVlCiAgKi8KICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgIHZhciBrZXlzID0gdGhpcy5rZXlzLAogICAgICAgIHZhbHVlcyA9IHRoaXMudmFsdWVzLAogICAgICAgIGd1aWQgPSBndWlkRm9yKGtleSk7CgogICAga2V5cy5hZGQoa2V5KTsKICAgIHZhbHVlc1tndWlkXSA9IHZhbHVlOwogICAgc2V0KHRoaXMsICdsZW5ndGgnLCBrZXlzLmxpc3QubGVuZ3RoKTsKICB9LAoKICAvKioKICAgIFJlbW92ZXMgYSB2YWx1ZSBmcm9tIHRoZSBtYXAgZm9yIGFuIGFzc29jaWF0ZWQga2V5LgoKICAgIEBtZXRob2QgcmVtb3ZlCiAgICBAcGFyYW0geyp9IGtleQogICAgQHJldHVybiB7Qm9vbGVhbn0gdHJ1ZSBpZiBhbiBpdGVtIHdhcyByZW1vdmVkLCBmYWxzZSBvdGhlcndpc2UKICAqLwogIHJlbW92ZTogZnVuY3Rpb24oa2V5KSB7CiAgICAvLyBkb24ndCB1c2UgRVM2ICJkZWxldGUiIGJlY2F1c2UgaXQgd2lsbCBiZSBhbm5veWluZwogICAgLy8gdG8gdXNlIGluIGJyb3dzZXJzIHRoYXQgYXJlIG5vdCBFUzYgZnJpZW5kbHk7CiAgICB2YXIga2V5cyA9IHRoaXMua2V5cywKICAgICAgICB2YWx1ZXMgPSB0aGlzLnZhbHVlcywKICAgICAgICBndWlkID0gZ3VpZEZvcihrZXkpOwoKICAgIGlmICh2YWx1ZXMuaGFzT3duUHJvcGVydHkoZ3VpZCkpIHsKICAgICAga2V5cy5yZW1vdmUoa2V5KTsKICAgICAgZGVsZXRlIHZhbHVlc1tndWlkXTsKICAgICAgc2V0KHRoaXMsICdsZW5ndGgnLCBrZXlzLmxpc3QubGVuZ3RoKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSwKCiAgLyoqCiAgICBDaGVjayB3aGV0aGVyIGEga2V5IGlzIHByZXNlbnQuCgogICAgQG1ldGhvZCBoYXMKICAgIEBwYXJhbSB7Kn0ga2V5CiAgICBAcmV0dXJuIHtCb29sZWFufSB0cnVlIGlmIHRoZSBpdGVtIHdhcyBwcmVzZW50LCBmYWxzZSBvdGhlcndpc2UKICAqLwogIGhhczogZnVuY3Rpb24oa2V5KSB7CiAgICB2YXIgdmFsdWVzID0gdGhpcy52YWx1ZXMsCiAgICAgICAgZ3VpZCA9IGd1aWRGb3Ioa2V5KTsKCiAgICByZXR1cm4gdmFsdWVzLmhhc093blByb3BlcnR5KGd1aWQpOwogIH0sCgogIC8qKgogICAgSXRlcmF0ZSBvdmVyIGFsbCB0aGUga2V5cyBhbmQgdmFsdWVzLiBDYWxscyB0aGUgZnVuY3Rpb24gb25jZQogICAgZm9yIGVhY2gga2V5LCBwYXNzaW5nIGluIHRoZSBrZXkgYW5kIHZhbHVlLCBpbiB0aGF0IG9yZGVyLgoKICAgIFRoZSBrZXlzIGFyZSBndWFyYW50ZWVkIHRvIGJlIGl0ZXJhdGVkIG92ZXIgaW4gaW5zZXJ0aW9uIG9yZGVyLgoKICAgIEBtZXRob2QgZm9yRWFjaAogICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sKICAgIEBwYXJhbSB7Kn0gc2VsZiBpZiBwYXNzZWQsIHRoZSBgdGhpc2AgdmFsdWUgaW5zaWRlIHRoZQogICAgICBjYWxsYmFjay4gQnkgZGVmYXVsdCwgYHRoaXNgIGlzIHRoZSBtYXAuCiAgKi8KICBmb3JFYWNoOiBmdW5jdGlvbihjYWxsYmFjaywgc2VsZikgewogICAgdmFyIGtleXMgPSB0aGlzLmtleXMsCiAgICAgICAgdmFsdWVzID0gdGhpcy52YWx1ZXM7CgogICAga2V5cy5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewogICAgICB2YXIgZ3VpZCA9IGd1aWRGb3Ioa2V5KTsKICAgICAgY2FsbGJhY2suY2FsbChzZWxmLCBrZXksIHZhbHVlc1tndWlkXSk7CiAgICB9KTsKICB9LAoKICAvKioKICAgIEBtZXRob2QgY29weQogICAgQHJldHVybiB7RW1iZXIuTWFwfQogICovCiAgY29weTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weU1hcCh0aGlzLCBuZXcgTWFwKCkpOwogIH0KfTsKCi8qKgogIEBjbGFzcyBNYXBXaXRoRGVmYXVsdAogIEBuYW1lc3BhY2UgRW1iZXIKICBAZXh0ZW5kcyBFbWJlci5NYXAKICBAcHJpdmF0ZQogIEBjb25zdHJ1Y3RvcgogIEBwYXJhbSBbb3B0aW9uc10KICAgIEBwYXJhbSB7Kn0gW29wdGlvbnMuZGVmYXVsdFZhbHVlXQoqLwp2YXIgTWFwV2l0aERlZmF1bHQgPSBFbWJlci5NYXBXaXRoRGVmYXVsdCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICBNYXAuY2FsbCh0aGlzKTsKICB0aGlzLmRlZmF1bHRWYWx1ZSA9IG9wdGlvbnMuZGVmYXVsdFZhbHVlOwp9OwoKLyoqCiAgQG1ldGhvZCBjcmVhdGUKICBAc3RhdGljCiAgQHBhcmFtIFtvcHRpb25zXQogICAgQHBhcmFtIHsqfSBbb3B0aW9ucy5kZWZhdWx0VmFsdWVdCiAgQHJldHVybiB7RW1iZXIuTWFwV2l0aERlZmF1bHR8RW1iZXIuTWFwfSBJZiBvcHRpb25zIGFyZSBwYXNzZWQsIHJldHVybnMKICAgIGBFbWJlci5NYXBXaXRoRGVmYXVsdGAgb3RoZXJ3aXNlIHJldHVybnMgYEVtYmVyLk1hcGAKKi8KTWFwV2l0aERlZmF1bHQuY3JlYXRlID0gZnVuY3Rpb24ob3B0aW9ucykgewogIGlmIChvcHRpb25zKSB7CiAgICByZXR1cm4gbmV3IE1hcFdpdGhEZWZhdWx0KG9wdGlvbnMpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gbmV3IE1hcCgpOwogIH0KfTsKCk1hcFdpdGhEZWZhdWx0LnByb3RvdHlwZSA9IEVtYmVyLmNyZWF0ZShNYXAucHJvdG90eXBlKTsKCi8qKgogIFJldHJpZXZlIHRoZSB2YWx1ZSBhc3NvY2lhdGVkIHdpdGggYSBnaXZlbiBrZXkuCgogIEBtZXRob2QgZ2V0CiAgQHBhcmFtIHsqfSBrZXkKICBAcmV0dXJuIHsqfSB0aGUgdmFsdWUgYXNzb2NpYXRlZCB3aXRoIHRoZSBrZXksIG9yIHRoZSBkZWZhdWx0IHZhbHVlCiovCk1hcFdpdGhEZWZhdWx0LnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbihrZXkpIHsKICB2YXIgaGFzVmFsdWUgPSB0aGlzLmhhcyhrZXkpOwoKICBpZiAoaGFzVmFsdWUpIHsKICAgIHJldHVybiBNYXAucHJvdG90eXBlLmdldC5jYWxsKHRoaXMsIGtleSk7CiAgfSBlbHNlIHsKICAgIHZhciBkZWZhdWx0VmFsdWUgPSB0aGlzLmRlZmF1bHRWYWx1ZShrZXkpOwogICAgdGhpcy5zZXQoa2V5LCBkZWZhdWx0VmFsdWUpOwogICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICB9Cn07CgovKioKICBAbWV0aG9kIGNvcHkKICBAcmV0dXJuIHtFbWJlci5NYXBXaXRoRGVmYXVsdH0KKi8KTWFwV2l0aERlZmF1bHQucHJvdG90eXBlLmNvcHkgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gY29weU1hcCh0aGlzLCBuZXcgTWFwV2l0aERlZmF1bHQoewogICAgZGVmYXVsdFZhbHVlOiB0aGlzLmRlZmF1bHRWYWx1ZQogIH0pKTsKfTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKZnVuY3Rpb24gY29uc29sZU1ldGhvZChuYW1lKSB7CiAgdmFyIGNvbnNvbGVPYmosIGxvZ1RvQ29uc29sZTsKICBpZiAoRW1iZXIuaW1wb3J0cy5jb25zb2xlKSB7CiAgICBjb25zb2xlT2JqID0gRW1iZXIuaW1wb3J0cy5jb25zb2xlOwogIH0gZWxzZSBpZiAodHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnKSB7CiAgICBjb25zb2xlT2JqID0gY29uc29sZTsKICB9CgogIHZhciBtZXRob2QgPSB0eXBlb2YgY29uc29sZU9iaiA9PT0gJ29iamVjdCcgPyBjb25zb2xlT2JqW25hbWVdIDogbnVsbDsKCiAgaWYgKG1ldGhvZCkgewogICAgLy8gT2xkZXIgSUUgZG9lc24ndCBzdXBwb3J0IGFwcGx5LCBidXQgQ2hyb21lIG5lZWRzIGl0CiAgICBpZiAobWV0aG9kLmFwcGx5KSB7CiAgICAgIGxvZ1RvQ29uc29sZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIG1ldGhvZC5hcHBseShjb25zb2xlT2JqLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgICBsb2dUb0NvbnNvbGUuZGlzcGxheU5hbWUgPSAnY29uc29sZS4nICsgbmFtZTsKICAgICAgcmV0dXJuIGxvZ1RvQ29uc29sZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgbWVzc2FnZSA9IEFycmF5LnByb3RvdHlwZS5qb2luLmNhbGwoYXJndW1lbnRzLCAnLCAnKTsKICAgICAgICBtZXRob2QobWVzc2FnZSk7CiAgICAgIH07CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBhc3NlcnRQb2x5ZmlsbCh0ZXN0LCBtZXNzYWdlKSB7CiAgaWYgKCF0ZXN0KSB7CiAgICB0cnkgewogICAgICAvLyBhdHRlbXB0IHRvIHByZXNlcnZlIHRoZSBzdGFjawogICAgICB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoImFzc2VydGlvbiBmYWlsZWQ6ICIgKyBtZXNzYWdlKTsKICAgIH0gY2F0Y2goZXJyb3IpIHsKICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgfSwgMCk7CiAgICB9CiAgfQp9CgovKioKICBJbnNpZGUgRW1iZXItTWV0YWwsIHNpbXBseSB1c2VzIHRoZSBtZXRob2RzIGZyb20gYGltcG9ydHMuY29uc29sZWAuCiAgT3ZlcnJpZGUgdGhpcyB0byBwcm92aWRlIG1vcmUgcm9idXN0IGxvZ2dpbmcgZnVuY3Rpb25hbGl0eS4KCiAgQGNsYXNzIExvZ2dlcgogIEBuYW1lc3BhY2UgRW1iZXIKKi8KRW1iZXIuTG9nZ2VyID0gewogIC8qKgogICBMb2dzIHRoZSBhcmd1bWVudHMgdG8gdGhlIGNvbnNvbGUuCiAgIFlvdSBjYW4gcGFzcyBhcyBtYW55IGFyZ3VtZW50cyBhcyB5b3Ugd2FudCBhbmQgdGhleSB3aWxsIGJlIGpvaW5lZCB0b2dldGhlciB3aXRoIGEgc3BhY2UuCgogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIGZvbyA9IDE7CiAgICBFbWJlci5Mb2dnZXIubG9nKCdsb2cgdmFsdWUgb2YgZm9vOicsIGZvbyk7IC8vICJsb2cgdmFsdWUgb2YgZm9vOiAxIiB3aWxsIGJlIHByaW50ZWQgdG8gdGhlIGNvbnNvbGUKICAgIGBgYAoKICAgQG1ldGhvZCBsb2cKICAgQGZvciBFbWJlci5Mb2dnZXIKICAgQHBhcmFtIHsqfSBhcmd1bWVudHMKICAqLwogIGxvZzogICBjb25zb2xlTWV0aG9kKCdsb2cnKSAgIHx8IEVtYmVyLkssCgogIC8qKgogICBQcmludHMgdGhlIGFyZ3VtZW50cyB0byB0aGUgY29uc29sZSB3aXRoIGEgd2FybmluZyBpY29uLgogICBZb3UgY2FuIHBhc3MgYXMgbWFueSBhcmd1bWVudHMgYXMgeW91IHdhbnQgYW5kIHRoZXkgd2lsbCBiZSBqb2luZWQgdG9nZXRoZXIgd2l0aCBhIHNwYWNlLgoKICAgIGBgYGphdmFzY3JpcHQKICAgIEVtYmVyLkxvZ2dlci53YXJuKCdTb21ldGhpbmcgaGFwcGVuZWQhJyk7IC8vICJTb21ldGhpbmcgaGFwcGVuZWQhIiB3aWxsIGJlIHByaW50ZWQgdG8gdGhlIGNvbnNvbGUgd2l0aCBhIHdhcm5pbmcgaWNvbi4KICAgIGBgYAoKICAgQG1ldGhvZCB3YXJuCiAgIEBmb3IgRW1iZXIuTG9nZ2VyCiAgIEBwYXJhbSB7Kn0gYXJndW1lbnRzCiAgKi8KICB3YXJuOiAgY29uc29sZU1ldGhvZCgnd2FybicpICB8fCBFbWJlci5LLAoKICAvKioKICAgUHJpbnRzIHRoZSBhcmd1bWVudHMgdG8gdGhlIGNvbnNvbGUgd2l0aCBhbiBlcnJvciBpY29uLCByZWQgdGV4dCBhbmQgYSBzdGFjayB0cmFjZS4KICAgWW91IGNhbiBwYXNzIGFzIG1hbnkgYXJndW1lbnRzIGFzIHlvdSB3YW50IGFuZCB0aGV5IHdpbGwgYmUgam9pbmVkIHRvZ2V0aGVyIHdpdGggYSBzcGFjZS4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICBFbWJlci5Mb2dnZXIuZXJyb3IoJ0RhbmdlciEgRGFuZ2VyIScpOyAvLyAiRGFuZ2VyISBEYW5nZXIhIiB3aWxsIGJlIHByaW50ZWQgdG8gdGhlIGNvbnNvbGUgaW4gcmVkIHRleHQuCiAgICBgYGAKCiAgIEBtZXRob2QgZXJyb3IKICAgQGZvciBFbWJlci5Mb2dnZXIKICAgQHBhcmFtIHsqfSBhcmd1bWVudHMKICAqLwogIGVycm9yOiBjb25zb2xlTWV0aG9kKCdlcnJvcicpIHx8IEVtYmVyLkssCgogIC8qKgogICBMb2dzIHRoZSBhcmd1bWVudHMgdG8gdGhlIGNvbnNvbGUuCiAgIFlvdSBjYW4gcGFzcyBhcyBtYW55IGFyZ3VtZW50cyBhcyB5b3Ugd2FudCBhbmQgdGhleSB3aWxsIGJlIGpvaW5lZCB0b2dldGhlciB3aXRoIGEgc3BhY2UuCgogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIGZvbyA9IDE7CiAgICBFbWJlci5Mb2dnZXIuaW5mbygnbG9nIHZhbHVlIG9mIGZvbzonLCBmb28pOyAvLyAibG9nIHZhbHVlIG9mIGZvbzogMSIgd2lsbCBiZSBwcmludGVkIHRvIHRoZSBjb25zb2xlCiAgICBgYGAKCiAgIEBtZXRob2QgaW5mbwogICBAZm9yIEVtYmVyLkxvZ2dlcgogICBAcGFyYW0geyp9IGFyZ3VtZW50cwogICovCiAgaW5mbzogIGNvbnNvbGVNZXRob2QoJ2luZm8nKSAgfHwgRW1iZXIuSywKCiAgLyoqCiAgIExvZ3MgdGhlIGFyZ3VtZW50cyB0byB0aGUgY29uc29sZSBpbiBibHVlIHRleHQuCiAgIFlvdSBjYW4gcGFzcyBhcyBtYW55IGFyZ3VtZW50cyBhcyB5b3Ugd2FudCBhbmQgdGhleSB3aWxsIGJlIGpvaW5lZCB0b2dldGhlciB3aXRoIGEgc3BhY2UuCgogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIGZvbyA9IDE7CiAgICBFbWJlci5Mb2dnZXIuZGVidWcoJ2xvZyB2YWx1ZSBvZiBmb286JywgZm9vKTsgLy8gImxvZyB2YWx1ZSBvZiBmb286IDEiIHdpbGwgYmUgcHJpbnRlZCB0byB0aGUgY29uc29sZQogICAgYGBgCgogICBAbWV0aG9kIGRlYnVnCiAgIEBmb3IgRW1iZXIuTG9nZ2VyCiAgIEBwYXJhbSB7Kn0gYXJndW1lbnRzCiAgKi8KICBkZWJ1ZzogY29uc29sZU1ldGhvZCgnZGVidWcnKSB8fCBjb25zb2xlTWV0aG9kKCdpbmZvJykgfHwgRW1iZXIuSywKCiAgLyoqCiAgIElmIHRoZSB2YWx1ZSBwYXNzZWQgaW50byBgRW1iZXIuTG9nZ2VyLmFzc2VydGAgaXMgbm90IHRydXRoeSBpdCB3aWxsIHRocm93IGFuIGVycm9yIHdpdGggYSBzdGFjayB0cmFjZS4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICBFbWJlci5Mb2dnZXIuYXNzZXJ0KHRydWUpOyAvLyB1bmRlZmluZWQKICAgIEVtYmVyLkxvZ2dlci5hc3NlcnQodHJ1ZSA9PT0gZmFsc2UpOyAvLyBUaHJvd3MgYW4gQXNzZXJ0aW9uIGZhaWxlZCBlcnJvci4KICAgIGBgYAoKICAgQG1ldGhvZCBhc3NlcnQKICAgQGZvciBFbWJlci5Mb2dnZXIKICAgQHBhcmFtIHtCb29sZWFufSBib29sIFZhbHVlIHRvIHRlc3QKICAqLwogIGFzc2VydDogY29uc29sZU1ldGhvZCgnYXNzZXJ0JykgfHwgYXNzZXJ0UG9seWZpbGwKfTsKCgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyLW1ldGFsCiovCgp2YXIgTUVUQV9LRVkgPSBFbWJlci5NRVRBX0tFWSwKICAgIG1ldGFGb3IgPSBFbWJlci5tZXRhLAogICAgb2JqZWN0RGVmaW5lUHJvcGVydHkgPSBFbWJlci5wbGF0Zm9ybS5kZWZpbmVQcm9wZXJ0eTsKCnZhciBNQU5EQVRPUllfU0VUVEVSID0gRW1iZXIuRU5WLk1BTkRBVE9SWV9TRVRURVI7CgovLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCi8vIERFU0NSSVBUT1IKLy8KCi8qKgogIE9iamVjdHMgb2YgdGhpcyB0eXBlIGNhbiBpbXBsZW1lbnQgYW4gaW50ZXJmYWNlIHRvIHJlc3BvbmQgdG8gcmVxdWVzdHMgdG8KICBnZXQgYW5kIHNldC4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaGFuZGxlcyBzaW1wbGUgcHJvcGVydGllcy4KCiAgWW91IGdlbmVyYWxseSB3b24ndCBuZWVkIHRvIGNyZWF0ZSBvciBzdWJjbGFzcyB0aGlzIGRpcmVjdGx5LgoKICBAY2xhc3MgRGVzY3JpcHRvcgogIEBuYW1lc3BhY2UgRW1iZXIKICBAcHJpdmF0ZQogIEBjb25zdHJ1Y3RvcgoqLwpFbWJlci5EZXNjcmlwdG9yID0gZnVuY3Rpb24oKSB7fTsKCi8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KLy8gREVGSU5JTkcgUFJPUEVSVElFUyBBUEkKLy8KCnZhciBNQU5EQVRPUllfU0VUVEVSX0ZVTkNUSU9OID0gRW1iZXIuTUFOREFUT1JZX1NFVFRFUl9GVU5DVElPTiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgRW1iZXIuYXNzZXJ0KCJZb3UgbXVzdCB1c2UgRW1iZXIuc2V0KCkgdG8gYWNjZXNzIHRoaXMgcHJvcGVydHkgKG9mICIgKyB0aGlzICsgIikiLCBmYWxzZSk7Cn07Cgp2YXIgREVGQVVMVF9HRVRURVJfRlVOQ1RJT04gPSBFbWJlci5ERUZBVUxUX0dFVFRFUl9GVU5DVElPTiA9IGZ1bmN0aW9uKG5hbWUpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB2YXIgbWV0YSA9IHRoaXNbTUVUQV9LRVldOwogICAgcmV0dXJuIG1ldGEgJiYgbWV0YS52YWx1ZXNbbmFtZV07CiAgfTsKfTsKCi8qKgogIE5PVEU6IFRoaXMgaXMgYSBsb3ctbGV2ZWwgbWV0aG9kIHVzZWQgYnkgb3RoZXIgcGFydHMgb2YgdGhlIEFQSS4gWW91IGFsbW9zdAogIG5ldmVyIHdhbnQgdG8gY2FsbCB0aGlzIG1ldGhvZCBkaXJlY3RseS4gSW5zdGVhZCB5b3Ugc2hvdWxkIHVzZQogIGBFbWJlci5taXhpbigpYCB0byBkZWZpbmUgbmV3IHByb3BlcnRpZXMuCgogIERlZmluZXMgYSBwcm9wZXJ0eSBvbiBhbiBvYmplY3QuIFRoaXMgbWV0aG9kIHdvcmtzIG11Y2ggbGlrZSB0aGUgRVM1CiAgYE9iamVjdC5kZWZpbmVQcm9wZXJ0eSgpYCBtZXRob2QgZXhjZXB0IHRoYXQgaXQgY2FuIGFsc28gYWNjZXB0IGNvbXB1dGVkCiAgcHJvcGVydGllcyBhbmQgb3RoZXIgc3BlY2lhbCBkZXNjcmlwdG9ycy4KCiAgTm9ybWFsbHkgdGhpcyBtZXRob2QgdGFrZXMgb25seSB0aHJlZSBwYXJhbWV0ZXJzLiBIb3dldmVyIGlmIHlvdSBwYXNzIGFuCiAgaW5zdGFuY2Ugb2YgYEVtYmVyLkRlc2NyaXB0b3JgIGFzIHRoZSB0aGlyZCBwYXJhbSB0aGVuIHlvdSBjYW4gcGFzcyBhbgogIG9wdGlvbmFsIHZhbHVlIGFzIHRoZSBmb3VydGggcGFyYW1ldGVyLiBUaGlzIGlzIG9mdGVuIG1vcmUgZWZmaWNpZW50IHRoYW4KICBjcmVhdGluZyBuZXcgZGVzY3JpcHRvciBoYXNoZXMgZm9yIGVhY2ggcHJvcGVydHkuCgogICMjIEV4YW1wbGVzCgogIGBgYGphdmFzY3JpcHQKICAvLyBFUzUgY29tcGF0aWJsZSBtb2RlCiAgRW1iZXIuZGVmaW5lUHJvcGVydHkoY29udGFjdCwgJ2ZpcnN0TmFtZScsIHsKICAgIHdyaXRhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICB2YWx1ZTogJ0NoYXJsZXMnCiAgfSk7CgogIC8vIGRlZmluZSBhIHNpbXBsZSBwcm9wZXJ0eQogIEVtYmVyLmRlZmluZVByb3BlcnR5KGNvbnRhY3QsICdsYXN0TmFtZScsIHVuZGVmaW5lZCwgJ0pvbGxleScpOwoKICAvLyBkZWZpbmUgYSBjb21wdXRlZCBwcm9wZXJ0eQogIEVtYmVyLmRlZmluZVByb3BlcnR5KGNvbnRhY3QsICdmdWxsTmFtZScsIEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuZmlyc3ROYW1lKycgJyt0aGlzLmxhc3ROYW1lOwogIH0pLnByb3BlcnR5KCdmaXJzdE5hbWUnLCAnbGFzdE5hbWUnKSk7CiAgYGBgCgogIEBwcml2YXRlCiAgQG1ldGhvZCBkZWZpbmVQcm9wZXJ0eQogIEBmb3IgRW1iZXIKICBAcGFyYW0ge09iamVjdH0gb2JqIHRoZSBvYmplY3QgdG8gZGVmaW5lIHRoaXMgcHJvcGVydHkgb24uIFRoaXMgbWF5IGJlIGEgcHJvdG90eXBlLgogIEBwYXJhbSB7U3RyaW5nfSBrZXlOYW1lIHRoZSBuYW1lIG9mIHRoZSBwcm9wZXJ0eQogIEBwYXJhbSB7RW1iZXIuRGVzY3JpcHRvcn0gW2Rlc2NdIGFuIGluc3RhbmNlIG9mIGBFbWJlci5EZXNjcmlwdG9yYCAodHlwaWNhbGx5IGEKICAgIGNvbXB1dGVkIHByb3BlcnR5KSBvciBhbiBFUzUgZGVzY3JpcHRvci4KICAgIFlvdSBtdXN0IHByb3ZpZGUgdGhpcyBvciBgZGF0YWAgYnV0IG5vdCBib3RoLgogIEBwYXJhbSB7Kn0gW2RhdGFdIHNvbWV0aGluZyBvdGhlciB0aGFuIGEgZGVzY3JpcHRvciwgdGhhdCB3aWxsCiAgICBiZWNvbWUgdGhlIGV4cGxpY2l0IHZhbHVlIG9mIHRoaXMgcHJvcGVydHkuCiovCkVtYmVyLmRlZmluZVByb3BlcnR5ID0gZnVuY3Rpb24ob2JqLCBrZXlOYW1lLCBkZXNjLCBkYXRhLCBtZXRhKSB7CiAgdmFyIGRlc2NzLCBleGlzdGluZ0Rlc2MsIHdhdGNoaW5nLCB2YWx1ZTsKCiAgaWYgKCFtZXRhKSBtZXRhID0gbWV0YUZvcihvYmopOwogIGRlc2NzID0gbWV0YS5kZXNjczsKICBleGlzdGluZ0Rlc2MgPSBtZXRhLmRlc2NzW2tleU5hbWVdOwogIHdhdGNoaW5nID0gbWV0YS53YXRjaGluZ1trZXlOYW1lXSA+IDA7CgogIGlmIChleGlzdGluZ0Rlc2MgaW5zdGFuY2VvZiBFbWJlci5EZXNjcmlwdG9yKSB7CiAgICBleGlzdGluZ0Rlc2MudGVhcmRvd24ob2JqLCBrZXlOYW1lKTsKICB9CgogIGlmIChkZXNjIGluc3RhbmNlb2YgRW1iZXIuRGVzY3JpcHRvcikgewogICAgdmFsdWUgPSBkZXNjOwoKICAgIGRlc2NzW2tleU5hbWVdID0gZGVzYzsKICAgIGlmIChNQU5EQVRPUllfU0VUVEVSICYmIHdhdGNoaW5nKSB7CiAgICAgIG9iamVjdERlZmluZVByb3BlcnR5KG9iaiwga2V5TmFtZSwgewogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgIHZhbHVlOiB1bmRlZmluZWQgLy8gbWFrZSBlbnVtZXJhYmxlCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgb2JqW2tleU5hbWVdID0gdW5kZWZpbmVkOyAvLyBtYWtlIGVudW1lcmFibGUKICAgIH0KICB9IGVsc2UgewogICAgZGVzY3Nba2V5TmFtZV0gPSB1bmRlZmluZWQ7IC8vIHNoYWRvdyBkZXNjcmlwdG9yIGluIHByb3RvCiAgICBpZiAoZGVzYyA9PSBudWxsKSB7CiAgICAgIHZhbHVlID0gZGF0YTsKCiAgICAgIGlmIChNQU5EQVRPUllfU0VUVEVSICYmIHdhdGNoaW5nKSB7CiAgICAgICAgbWV0YS52YWx1ZXNba2V5TmFtZV0gPSBkYXRhOwogICAgICAgIG9iamVjdERlZmluZVByb3BlcnR5KG9iaiwga2V5TmFtZSwgewogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgIHNldDogTUFOREFUT1JZX1NFVFRFUl9GVU5DVElPTiwKICAgICAgICAgIGdldDogREVGQVVMVF9HRVRURVJfRlVOQ1RJT04oa2V5TmFtZSkKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvYmpba2V5TmFtZV0gPSBkYXRhOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2YWx1ZSA9IGRlc2M7CgogICAgICAvLyBjb21wYXRpYmlsaXR5IHdpdGggRVM1CiAgICAgIG9iamVjdERlZmluZVByb3BlcnR5KG9iaiwga2V5TmFtZSwgZGVzYyk7CiAgICB9CiAgfQoKICAvLyBpZiBrZXkgaXMgYmVpbmcgd2F0Y2hlZCwgb3ZlcnJpZGUgY2hhaW5zIHRoYXQKICAvLyB3ZXJlIGluaXRpYWxpemVkIHdpdGggdGhlIHByb3RvdHlwZQogIGlmICh3YXRjaGluZykgeyBFbWJlci5vdmVycmlkZUNoYWlucyhvYmosIGtleU5hbWUsIG1ldGEpOyB9CgogIC8vIFRoZSBgdmFsdWVgIHBhc3NlZCB0byB0aGUgYGRpZERlZmluZVByb3BlcnR5YCBob29rIGlzCiAgLy8gZWl0aGVyIHRoZSBkZXNjcmlwdG9yIG9yIGRhdGEsIHdoaWNoZXZlciB3YXMgcGFzc2VkLgogIGlmIChvYmouZGlkRGVmaW5lUHJvcGVydHkpIHsgb2JqLmRpZERlZmluZVByb3BlcnR5KG9iaiwga2V5TmFtZSwgdmFsdWUpOyB9CgogIHJldHVybiB0aGlzOwp9OwoKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKdmFyIGdldCA9IEVtYmVyLmdldDsKCi8qKgogIFRvIGdldCBtdWx0aXBsZSBwcm9wZXJ0aWVzIGF0IG9uY2UsIGNhbGwgYEVtYmVyLmdldFByb3BlcnRpZXNgCiAgd2l0aCBhbiBvYmplY3QgZm9sbG93ZWQgYnkgYSBsaXN0IG9mIHN0cmluZ3Mgb3IgYW4gYXJyYXk6CgogIGBgYGphdmFzY3JpcHQKICBFbWJlci5nZXRQcm9wZXJ0aWVzKHJlY29yZCwgJ2ZpcnN0TmFtZScsICdsYXN0TmFtZScsICd6aXBDb2RlJyk7ICAvLyB7IGZpcnN0TmFtZTogJ0pvaG4nLCBsYXN0TmFtZTogJ0RvZScsIHppcENvZGU6ICcxMDAxMScgfQogIGBgYAoKICBpcyBlcXVpdmFsZW50IHRvOgoKICBgYGBqYXZhc2NyaXB0CiAgRW1iZXIuZ2V0UHJvcGVydGllcyhyZWNvcmQsIFsnZmlyc3ROYW1lJywgJ2xhc3ROYW1lJywgJ3ppcENvZGUnXSk7ICAvLyB7IGZpcnN0TmFtZTogJ0pvaG4nLCBsYXN0TmFtZTogJ0RvZScsIHppcENvZGU6ICcxMDAxMScgfQogIGBgYAoKICBAbWV0aG9kIGdldFByb3BlcnRpZXMKICBAcGFyYW0gb2JqCiAgQHBhcmFtIHtTdHJpbmcuLi58QXJyYXl9IGxpc3Qgb2Yga2V5cyB0byBnZXQKICBAcmV0dXJuIHtIYXNofQoqLwpFbWJlci5nZXRQcm9wZXJ0aWVzID0gZnVuY3Rpb24ob2JqKSB7CiAgdmFyIHJldCA9IHt9LAogICAgICBwcm9wZXJ0eU5hbWVzID0gYXJndW1lbnRzLAogICAgICBpID0gMTsKCiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIgJiYgRW1iZXIudHlwZU9mKGFyZ3VtZW50c1sxXSkgPT09ICdhcnJheScpIHsKICAgIGkgPSAwOwogICAgcHJvcGVydHlOYW1lcyA9IGFyZ3VtZW50c1sxXTsKICB9CiAgZm9yKHZhciBsZW4gPSBwcm9wZXJ0eU5hbWVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICByZXRbcHJvcGVydHlOYW1lc1tpXV0gPSBnZXQob2JqLCBwcm9wZXJ0eU5hbWVzW2ldKTsKICB9CiAgcmV0dXJuIHJldDsKfTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKdmFyIGNoYW5nZVByb3BlcnRpZXMgPSBFbWJlci5jaGFuZ2VQcm9wZXJ0aWVzLAogICAgc2V0ID0gRW1iZXIuc2V0OwoKLyoqCiAgU2V0IGEgbGlzdCBvZiBwcm9wZXJ0aWVzIG9uIGFuIG9iamVjdC4gVGhlc2UgcHJvcGVydGllcyBhcmUgc2V0IGluc2lkZQogIGEgc2luZ2xlIGBiZWdpblByb3BlcnR5Q2hhbmdlc2AgYW5kIGBlbmRQcm9wZXJ0eUNoYW5nZXNgIGJhdGNoLCBzbwogIG9ic2VydmVycyB3aWxsIGJlIGJ1ZmZlcmVkLgoKICBgYGBqYXZhc2NyaXB0CiAgYW5PYmplY3Quc2V0UHJvcGVydGllcyh7CiAgICBmaXJzdE5hbWU6ICJTdGFubGV5IiwKICAgIGxhc3ROYW1lOiAiU3R1YXJ0IiwKICAgIGFnZTogIjIxIgogIH0pCiAgYGBgCgogIEBtZXRob2Qgc2V0UHJvcGVydGllcwogIEBwYXJhbSBzZWxmCiAgQHBhcmFtIHtPYmplY3R9IGhhc2gKICBAcmV0dXJuIHNlbGYKKi8KRW1iZXIuc2V0UHJvcGVydGllcyA9IGZ1bmN0aW9uKHNlbGYsIGhhc2gpIHsKICBjaGFuZ2VQcm9wZXJ0aWVzKGZ1bmN0aW9uKCkgewogICAgZm9yKHZhciBwcm9wIGluIGhhc2gpIHsKICAgICAgaWYgKGhhc2guaGFzT3duUHJvcGVydHkocHJvcCkpIHsgc2V0KHNlbGYsIHByb3AsIGhhc2hbcHJvcF0pOyB9CiAgICB9CiAgfSk7CiAgcmV0dXJuIHNlbGY7Cn07Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7CnZhciBtZXRhRm9yID0gRW1iZXIubWV0YSwgLy8gdXRpbHMuanMKICAgIHR5cGVPZiA9IEVtYmVyLnR5cGVPZiwgLy8gdXRpbHMuanMKICAgIE1BTkRBVE9SWV9TRVRURVIgPSBFbWJlci5FTlYuTUFOREFUT1JZX1NFVFRFUiwKICAgIG9fZGVmaW5lUHJvcGVydHkgPSBFbWJlci5wbGF0Zm9ybS5kZWZpbmVQcm9wZXJ0eTsKCkVtYmVyLndhdGNoS2V5ID0gZnVuY3Rpb24ob2JqLCBrZXlOYW1lKSB7CiAgLy8gY2FuJ3Qgd2F0Y2ggbGVuZ3RoIG9uIEFycmF5IC0gaXQgaXMgc3BlY2lhbC4uLgogIGlmIChrZXlOYW1lID09PSAnbGVuZ3RoJyAmJiB0eXBlT2Yob2JqKSA9PT0gJ2FycmF5JykgeyByZXR1cm47IH0KCiAgdmFyIG0gPSBtZXRhRm9yKG9iaiksIHdhdGNoaW5nID0gbS53YXRjaGluZzsKCiAgLy8gYWN0aXZhdGUgd2F0Y2hpbmcgZmlyc3QgdGltZQogIGlmICghd2F0Y2hpbmdba2V5TmFtZV0pIHsKICAgIHdhdGNoaW5nW2tleU5hbWVdID0gMTsKCiAgICBpZiAoJ2Z1bmN0aW9uJyA9PT0gdHlwZW9mIG9iai53aWxsV2F0Y2hQcm9wZXJ0eSkgewogICAgICBvYmoud2lsbFdhdGNoUHJvcGVydHkoa2V5TmFtZSk7CiAgICB9CgogICAgaWYgKE1BTkRBVE9SWV9TRVRURVIgJiYga2V5TmFtZSBpbiBvYmopIHsKICAgICAgbS52YWx1ZXNba2V5TmFtZV0gPSBvYmpba2V5TmFtZV07CiAgICAgIG9fZGVmaW5lUHJvcGVydHkob2JqLCBrZXlOYW1lLCB7CiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgIGVudW1lcmFibGU6IG9iai5wcm9wZXJ0eUlzRW51bWVyYWJsZShrZXlOYW1lKSwKICAgICAgICBzZXQ6IEVtYmVyLk1BTkRBVE9SWV9TRVRURVJfRlVOQ1RJT04sCiAgICAgICAgZ2V0OiBFbWJlci5ERUZBVUxUX0dFVFRFUl9GVU5DVElPTihrZXlOYW1lKQogICAgICB9KTsKICAgIH0KICB9IGVsc2UgewogICAgd2F0Y2hpbmdba2V5TmFtZV0gPSAod2F0Y2hpbmdba2V5TmFtZV0gfHwgMCkgKyAxOwogIH0KfTsKCgpFbWJlci51bndhdGNoS2V5ID0gZnVuY3Rpb24ob2JqLCBrZXlOYW1lKSB7CiAgdmFyIG0gPSBtZXRhRm9yKG9iaiksIHdhdGNoaW5nID0gbS53YXRjaGluZzsKCiAgaWYgKHdhdGNoaW5nW2tleU5hbWVdID09PSAxKSB7CiAgICB3YXRjaGluZ1trZXlOYW1lXSA9IDA7CgogICAgaWYgKCdmdW5jdGlvbicgPT09IHR5cGVvZiBvYmouZGlkVW53YXRjaFByb3BlcnR5KSB7CiAgICAgIG9iai5kaWRVbndhdGNoUHJvcGVydHkoa2V5TmFtZSk7CiAgICB9CgogICAgaWYgKE1BTkRBVE9SWV9TRVRURVIgJiYga2V5TmFtZSBpbiBvYmopIHsKICAgICAgb19kZWZpbmVQcm9wZXJ0eShvYmosIGtleU5hbWUsIHsKICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgZW51bWVyYWJsZTogb2JqLnByb3BlcnR5SXNFbnVtZXJhYmxlKGtleU5hbWUpLAogICAgICAgIHNldDogZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAvLyByZWRlZmluZSB0byBzZXQgYXMgZW51bWVyYWJsZQogICAgICAgICAgb19kZWZpbmVQcm9wZXJ0eShvYmosIGtleU5hbWUsIHsKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgdmFsdWU6IHZhbAogICAgICAgICAgfSk7CiAgICAgICAgICBkZWxldGUgbS52YWx1ZXNba2V5TmFtZV07CiAgICAgICAgfSwKICAgICAgICBnZXQ6IEVtYmVyLkRFRkFVTFRfR0VUVEVSX0ZVTkNUSU9OKGtleU5hbWUpCiAgICAgIH0pOwogICAgfQogIH0gZWxzZSBpZiAod2F0Y2hpbmdba2V5TmFtZV0gPiAxKSB7CiAgICB3YXRjaGluZ1trZXlOYW1lXS0tOwogIH0KfTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKdmFyIG1ldGFGb3IgPSBFbWJlci5tZXRhLCAvLyB1dGlscy5qcwogICAgZ2V0ID0gRW1iZXIuZ2V0LCAvLyBwcm9wZXJ0eV9nZXQuanMKICAgIG5vcm1hbGl6ZVR1cGxlID0gRW1iZXIubm9ybWFsaXplVHVwbGUsIC8vIHByb3BlcnR5X2dldC5qcwogICAgZm9yRWFjaCA9IEVtYmVyLkFycmF5UG9seWZpbGxzLmZvckVhY2gsIC8vIGFycmF5LmpzCiAgICB3YXJuID0gRW1iZXIud2FybiwKICAgIHdhdGNoS2V5ID0gRW1iZXIud2F0Y2hLZXksCiAgICB1bndhdGNoS2V5ID0gRW1iZXIudW53YXRjaEtleSwKICAgIEZJUlNUX0tFWSA9IC9eKFteXC5cKl0rKS87CgpmdW5jdGlvbiBmaXJzdEtleShwYXRoKSB7CiAgcmV0dXJuIHBhdGgubWF0Y2goRklSU1RfS0VZKVswXTsKfQoKdmFyIHBlbmRpbmdRdWV1ZSA9IFtdOwoKLy8gYXR0ZW1wdHMgdG8gYWRkIHRoZSBwZW5kaW5nUXVldWUgY2hhaW5zIGFnYWluLiBJZiBzb21lIG9mIHRoZW0gZW5kIHVwCi8vIGJhY2sgaW4gdGhlIHF1ZXVlIGFuZCByZXNjaGVkdWxlIGlzIHRydWUsIHNjaGVkdWxlcyBhIHRpbWVvdXQgdG8gdHJ5Ci8vIGFnYWluLgpFbWJlci5mbHVzaFBlbmRpbmdDaGFpbnMgPSBmdW5jdGlvbigpIHsKICBpZiAocGVuZGluZ1F1ZXVlLmxlbmd0aCA9PT0gMCkgeyByZXR1cm47IH0gLy8gbm90aGluZyB0byBkbwoKICB2YXIgcXVldWUgPSBwZW5kaW5nUXVldWU7CiAgcGVuZGluZ1F1ZXVlID0gW107CgogIGZvckVhY2guY2FsbChxdWV1ZSwgZnVuY3Rpb24ocSkgeyBxWzBdLmFkZChxWzFdKTsgfSk7CgogIHdhcm4oJ1dhdGNoaW5nIGFuIHVuZGVmaW5lZCBnbG9iYWwsIEVtYmVyIGV4cGVjdHMgd2F0Y2hlZCBnbG9iYWxzIHRvIGJlIHNldHVwIGJ5IHRoZSB0aW1lIHRoZSBydW4gbG9vcCBpcyBmbHVzaGVkLCBjaGVjayBmb3IgdHlwb3MnLCBwZW5kaW5nUXVldWUubGVuZ3RoID09PSAwKTsKfTsKCgpmdW5jdGlvbiBhZGRDaGFpbldhdGNoZXIob2JqLCBrZXlOYW1lLCBub2RlKSB7CiAgaWYgKCFvYmogfHwgKCdvYmplY3QnICE9PSB0eXBlb2Ygb2JqKSkgeyByZXR1cm47IH0gLy8gbm90aGluZyB0byBkbwoKICB2YXIgbSA9IG1ldGFGb3Iob2JqKSwgbm9kZXMgPSBtLmNoYWluV2F0Y2hlcnM7CgogIGlmICghbS5oYXNPd25Qcm9wZXJ0eSgnY2hhaW5XYXRjaGVycycpKSB7CiAgICBub2RlcyA9IG0uY2hhaW5XYXRjaGVycyA9IHt9OwogIH0KCiAgaWYgKCFub2Rlc1trZXlOYW1lXSkgeyBub2Rlc1trZXlOYW1lXSA9IFtdOyB9CiAgbm9kZXNba2V5TmFtZV0ucHVzaChub2RlKTsKICB3YXRjaEtleShvYmosIGtleU5hbWUpOwp9Cgp2YXIgcmVtb3ZlQ2hhaW5XYXRjaGVyID0gRW1iZXIucmVtb3ZlQ2hhaW5XYXRjaGVyID0gZnVuY3Rpb24ob2JqLCBrZXlOYW1lLCBub2RlKSB7CiAgaWYgKCFvYmogfHwgJ29iamVjdCcgIT09IHR5cGVvZiBvYmopIHsgcmV0dXJuOyB9IC8vIG5vdGhpbmcgdG8gZG8KCiAgdmFyIG0gPSBtZXRhRm9yKG9iaiwgZmFsc2UpOwogIGlmICghbS5oYXNPd25Qcm9wZXJ0eSgnY2hhaW5XYXRjaGVycycpKSB7IHJldHVybjsgfSAvLyBub3RoaW5nIHRvIGRvCgogIHZhciBub2RlcyA9IG0uY2hhaW5XYXRjaGVyczsKCiAgaWYgKG5vZGVzW2tleU5hbWVdKSB7CiAgICBub2RlcyA9IG5vZGVzW2tleU5hbWVdOwogICAgZm9yICh2YXIgaSA9IDAsIGwgPSBub2Rlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgaWYgKG5vZGVzW2ldID09PSBub2RlKSB7IG5vZGVzLnNwbGljZShpLCAxKTsgfQogICAgfQogIH0KICB1bndhdGNoS2V5KG9iaiwga2V5TmFtZSk7Cn07CgovLyBBIENoYWluTm9kZSB3YXRjaGVzIGEgc2luZ2xlIGtleSBvbiBhbiBvYmplY3QuIElmIHlvdSBwcm92aWRlIGEgc3RhcnRpbmcKLy8gdmFsdWUgZm9yIHRoZSBrZXkgdGhlbiB0aGUgbm9kZSB3b24ndCBhY3R1YWxseSB3YXRjaCBpdC4gRm9yIGEgcm9vdCBub2RlCi8vIHBhc3MgbnVsbCBmb3IgcGFyZW50IGFuZCBrZXkgYW5kIG9iamVjdCBmb3IgdmFsdWUuCnZhciBDaGFpbk5vZGUgPSBFbWJlci5fQ2hhaW5Ob2RlID0gZnVuY3Rpb24ocGFyZW50LCBrZXksIHZhbHVlKSB7CiAgdGhpcy5fcGFyZW50ID0gcGFyZW50OwogIHRoaXMuX2tleSAgICA9IGtleTsKCiAgLy8gX3dhdGNoaW5nIGlzIHRydWUgd2hlbiBjYWxsaW5nIGdldCh0aGlzLl9wYXJlbnQsIHRoaXMuX2tleSkgd2lsbAogIC8vIHJldHVybiB0aGUgdmFsdWUgb2YgdGhpcyBub2RlLgogIC8vCiAgLy8gSXQgaXMgZmFsc2UgZm9yIHRoZSByb290IG9mIGEgY2hhaW4gKGJlY2F1c2Ugd2UgaGF2ZSBubyBwYXJlbnQpCiAgLy8gYW5kIGZvciBnbG9iYWwgcGF0aHMgKGJlY2F1c2UgdGhlIHBhcmVudCBub2RlIGlzIHRoZSBvYmplY3Qgd2l0aAogIC8vIHRoZSBvYnNlcnZlciBvbiBpdCkKICB0aGlzLl93YXRjaGluZyA9IHZhbHVlPT09dW5kZWZpbmVkOwoKICB0aGlzLl92YWx1ZSAgPSB2YWx1ZTsKICB0aGlzLl9wYXRocyA9IHt9OwogIGlmICh0aGlzLl93YXRjaGluZykgewogICAgdGhpcy5fb2JqZWN0ID0gcGFyZW50LnZhbHVlKCk7CiAgICBpZiAodGhpcy5fb2JqZWN0KSB7IGFkZENoYWluV2F0Y2hlcih0aGlzLl9vYmplY3QsIHRoaXMuX2tleSwgdGhpcyk7IH0KICB9CgogIC8vIFNwZWNpYWwtY2FzZTogdGhlIEVhY2hQcm94eSByZWxpZXMgb24gaW1tZWRpYXRlIGV2YWx1YXRpb24gdG8KICAvLyBlc3RhYmxpc2ggaXRzIG9ic2VydmVycy4KICAvLwogIC8vIFRPRE86IFJlcGxhY2UgdGhpcyB3aXRoIGFuIGVmZmljaWVudCBjYWxsYmFjayB0aGF0IHRoZSBFYWNoUHJveHkKICAvLyBjYW4gaW1wbGVtZW50LgogIGlmICh0aGlzLl9wYXJlbnQgJiYgdGhpcy5fcGFyZW50Ll9rZXkgPT09ICdAZWFjaCcpIHsKICAgIHRoaXMudmFsdWUoKTsKICB9Cn07Cgp2YXIgQ2hhaW5Ob2RlUHJvdG90eXBlID0gQ2hhaW5Ob2RlLnByb3RvdHlwZTsKCmZ1bmN0aW9uIGxhenlHZXQob2JqLCBrZXkpIHsKICBpZiAoIW9iaikgcmV0dXJuIHVuZGVmaW5lZDsKCiAgdmFyIG1ldGEgPSBtZXRhRm9yKG9iaiwgZmFsc2UpOwogIC8vIGNoZWNrIGlmIG9iamVjdCBtZWFudCBvbmx5IHRvIGJlIGEgcHJvdG90eXBlCiAgaWYgKG1ldGEucHJvdG8gPT09IG9iaikgcmV0dXJuIHVuZGVmaW5lZDsKCiAgaWYgKGtleSA9PT0gIkBlYWNoIikgcmV0dXJuIGdldChvYmosIGtleSk7CgogIC8vIGlmIGEgQ1Agb25seSByZXR1cm4gY2FjaGVkIHZhbHVlCiAgdmFyIGRlc2MgPSBtZXRhLmRlc2NzW2tleV07CiAgaWYgKGRlc2MgJiYgZGVzYy5fY2FjaGVhYmxlKSB7CiAgICBpZiAoa2V5IGluIG1ldGEuY2FjaGUpIHsKICAgICAgcmV0dXJuIG1ldGEuY2FjaGVba2V5XTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICB9CiAgfQoKICByZXR1cm4gZ2V0KG9iaiwga2V5KTsKfQoKQ2hhaW5Ob2RlUHJvdG90eXBlLnZhbHVlID0gZnVuY3Rpb24oKSB7CiAgaWYgKHRoaXMuX3ZhbHVlID09PSB1bmRlZmluZWQgJiYgdGhpcy5fd2F0Y2hpbmcpIHsKICAgIHZhciBvYmogPSB0aGlzLl9wYXJlbnQudmFsdWUoKTsKICAgIHRoaXMuX3ZhbHVlID0gbGF6eUdldChvYmosIHRoaXMuX2tleSk7CiAgfQogIHJldHVybiB0aGlzLl92YWx1ZTsKfTsKCkNoYWluTm9kZVByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgaWYgKHRoaXMuX3dhdGNoaW5nKSB7CiAgICB2YXIgb2JqID0gdGhpcy5fb2JqZWN0OwogICAgaWYgKG9iaikgeyByZW1vdmVDaGFpbldhdGNoZXIob2JqLCB0aGlzLl9rZXksIHRoaXMpOyB9CiAgICB0aGlzLl93YXRjaGluZyA9IGZhbHNlOyAvLyBzbyBmdXR1cmUgY2FsbHMgZG8gbm90aGluZwogIH0KfTsKCi8vIGNvcGllcyBhIHRvcCBsZXZlbCBvYmplY3Qgb25seQpDaGFpbk5vZGVQcm90b3R5cGUuY29weSA9IGZ1bmN0aW9uKG9iaikgewogIHZhciByZXQgPSBuZXcgQ2hhaW5Ob2RlKG51bGwsIG51bGwsIG9iaiksCiAgICAgIHBhdGhzID0gdGhpcy5fcGF0aHMsIHBhdGg7CiAgZm9yIChwYXRoIGluIHBhdGhzKSB7CiAgICBpZiAocGF0aHNbcGF0aF0gPD0gMCkgeyBjb250aW51ZTsgfSAvLyB0aGlzIGNoZWNrIHdpbGwgYWxzbyBjYXRjaCBub24tbnVtYmVyIHZhbHMuCiAgICByZXQuYWRkKHBhdGgpOwogIH0KICByZXR1cm4gcmV0Owp9OwoKLy8gY2FsbGVkIG9uIHRoZSByb290IG5vZGUgb2YgYSBjaGFpbiB0byBzZXR1cCB3YXRjaGVycyBvbiB0aGUgc3BlY2lmaWVkCi8vIHBhdGguCkNoYWluTm9kZVByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbihwYXRoKSB7CiAgdmFyIG9iaiwgdHVwbGUsIGtleSwgc3JjLCBwYXRoczsKCiAgcGF0aHMgPSB0aGlzLl9wYXRoczsKICBwYXRoc1twYXRoXSA9IChwYXRoc1twYXRoXSB8fCAwKSArIDE7CgogIG9iaiA9IHRoaXMudmFsdWUoKTsKICB0dXBsZSA9IG5vcm1hbGl6ZVR1cGxlKG9iaiwgcGF0aCk7CgogIC8vIHRoZSBwYXRoIHdhcyBhIGxvY2FsIHBhdGgKICBpZiAodHVwbGVbMF0gJiYgdHVwbGVbMF0gPT09IG9iaikgewogICAgcGF0aCA9IHR1cGxlWzFdOwogICAga2V5ICA9IGZpcnN0S2V5KHBhdGgpOwogICAgcGF0aCA9IHBhdGguc2xpY2Uoa2V5Lmxlbmd0aCsxKTsKCiAgLy8gZ2xvYmFsIHBhdGgsIGJ1dCBvYmplY3QgZG9lcyBub3QgZXhpc3QgeWV0LgogIC8vIHB1dCBpbnRvIGEgcXVldWUgYW5kIHRyeSB0byBjb25uZWN0IGxhdGVyLgogIH0gZWxzZSBpZiAoIXR1cGxlWzBdKSB7CiAgICBwZW5kaW5nUXVldWUucHVzaChbdGhpcywgcGF0aF0pOwogICAgdHVwbGUubGVuZ3RoID0gMDsKICAgIHJldHVybjsKCiAgLy8gZ2xvYmFsIHBhdGgsIGFuZCBvYmplY3QgYWxyZWFkeSBleGlzdHMKICB9IGVsc2UgewogICAgc3JjICA9IHR1cGxlWzBdOwogICAga2V5ICA9IHBhdGguc2xpY2UoMCwgMC0odHVwbGVbMV0ubGVuZ3RoKzEpKTsKICAgIHBhdGggPSB0dXBsZVsxXTsKICB9CgogIHR1cGxlLmxlbmd0aCA9IDA7CiAgdGhpcy5jaGFpbihrZXksIHBhdGgsIHNyYyk7Cn07CgovLyBjYWxsZWQgb24gdGhlIHJvb3Qgbm9kZSBvZiBhIGNoYWluIHRvIHRlYXJkb3duIHdhdGNoZXIgb24gdGhlIHNwZWNpZmllZAovLyBwYXRoCkNoYWluTm9kZVByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbihwYXRoKSB7CiAgdmFyIG9iaiwgdHVwbGUsIGtleSwgc3JjLCBwYXRoczsKCiAgcGF0aHMgPSB0aGlzLl9wYXRoczsKICBpZiAocGF0aHNbcGF0aF0gPiAwKSB7IHBhdGhzW3BhdGhdLS07IH0KCiAgb2JqID0gdGhpcy52YWx1ZSgpOwogIHR1cGxlID0gbm9ybWFsaXplVHVwbGUob2JqLCBwYXRoKTsKICBpZiAodHVwbGVbMF0gPT09IG9iaikgewogICAgcGF0aCA9IHR1cGxlWzFdOwogICAga2V5ICA9IGZpcnN0S2V5KHBhdGgpOwogICAgcGF0aCA9IHBhdGguc2xpY2Uoa2V5Lmxlbmd0aCsxKTsKICB9IGVsc2UgewogICAgc3JjICA9IHR1cGxlWzBdOwogICAga2V5ICA9IHBhdGguc2xpY2UoMCwgMC0odHVwbGVbMV0ubGVuZ3RoKzEpKTsKICAgIHBhdGggPSB0dXBsZVsxXTsKICB9CgogIHR1cGxlLmxlbmd0aCA9IDA7CiAgdGhpcy51bmNoYWluKGtleSwgcGF0aCk7Cn07CgpDaGFpbk5vZGVQcm90b3R5cGUuY291bnQgPSAwOwoKQ2hhaW5Ob2RlUHJvdG90eXBlLmNoYWluID0gZnVuY3Rpb24oa2V5LCBwYXRoLCBzcmMpIHsKICB2YXIgY2hhaW5zID0gdGhpcy5fY2hhaW5zLCBub2RlOwogIGlmICghY2hhaW5zKSB7IGNoYWlucyA9IHRoaXMuX2NoYWlucyA9IHt9OyB9CgogIG5vZGUgPSBjaGFpbnNba2V5XTsKICBpZiAoIW5vZGUpIHsgbm9kZSA9IGNoYWluc1trZXldID0gbmV3IENoYWluTm9kZSh0aGlzLCBrZXksIHNyYyk7IH0KICBub2RlLmNvdW50Kys7IC8vIGNvdW50IGNoYWlucy4uLgoKICAvLyBjaGFpbiByZXN0IG9mIHBhdGggaWYgdGhlcmUgaXMgb25lCiAgaWYgKHBhdGggJiYgcGF0aC5sZW5ndGg+MCkgewogICAga2V5ID0gZmlyc3RLZXkocGF0aCk7CiAgICBwYXRoID0gcGF0aC5zbGljZShrZXkubGVuZ3RoKzEpOwogICAgbm9kZS5jaGFpbihrZXksIHBhdGgpOyAvLyBOT1RFOiBubyBzcmMgbWVhbnMgaXQgd2lsbCBvYnNlcnZlIGNoYW5nZXMuLi4KICB9Cn07CgpDaGFpbk5vZGVQcm90b3R5cGUudW5jaGFpbiA9IGZ1bmN0aW9uKGtleSwgcGF0aCkgewogIHZhciBjaGFpbnMgPSB0aGlzLl9jaGFpbnMsIG5vZGUgPSBjaGFpbnNba2V5XTsKCiAgLy8gdW5jaGFpbiByZXN0IG9mIHBhdGggZmlyc3QuLi4KICBpZiAocGF0aCAmJiBwYXRoLmxlbmd0aD4xKSB7CiAgICBrZXkgID0gZmlyc3RLZXkocGF0aCk7CiAgICBwYXRoID0gcGF0aC5zbGljZShrZXkubGVuZ3RoKzEpOwogICAgbm9kZS51bmNoYWluKGtleSwgcGF0aCk7CiAgfQoKICAvLyBkZWxldGUgbm9kZSBpZiBuZWVkZWQuCiAgbm9kZS5jb3VudC0tOwogIGlmIChub2RlLmNvdW50PD0wKSB7CiAgICBkZWxldGUgY2hhaW5zW25vZGUuX2tleV07CiAgICBub2RlLmRlc3Ryb3koKTsKICB9Cgp9OwoKQ2hhaW5Ob2RlUHJvdG90eXBlLndpbGxDaGFuZ2UgPSBmdW5jdGlvbihldmVudHMpIHsKICB2YXIgY2hhaW5zID0gdGhpcy5fY2hhaW5zOwogIGlmIChjaGFpbnMpIHsKICAgIGZvcih2YXIga2V5IGluIGNoYWlucykgewogICAgICBpZiAoIWNoYWlucy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7IGNvbnRpbnVlOyB9CiAgICAgIGNoYWluc1trZXldLndpbGxDaGFuZ2UoZXZlbnRzKTsKICAgIH0KICB9CgogIGlmICh0aGlzLl9wYXJlbnQpIHsgdGhpcy5fcGFyZW50LmNoYWluV2lsbENoYW5nZSh0aGlzLCB0aGlzLl9rZXksIDEsIGV2ZW50cyk7IH0KfTsKCkNoYWluTm9kZVByb3RvdHlwZS5jaGFpbldpbGxDaGFuZ2UgPSBmdW5jdGlvbihjaGFpbiwgcGF0aCwgZGVwdGgsIGV2ZW50cykgewogIGlmICh0aGlzLl9rZXkpIHsgcGF0aCA9IHRoaXMuX2tleSArICcuJyArIHBhdGg7IH0KCiAgaWYgKHRoaXMuX3BhcmVudCkgewogICAgdGhpcy5fcGFyZW50LmNoYWluV2lsbENoYW5nZSh0aGlzLCBwYXRoLCBkZXB0aCsxLCBldmVudHMpOwogIH0gZWxzZSB7CiAgICBpZiAoZGVwdGggPiAxKSB7CiAgICAgIGV2ZW50cy5wdXNoKHRoaXMudmFsdWUoKSwgcGF0aCk7CiAgICB9CiAgICBwYXRoID0gJ3RoaXMuJyArIHBhdGg7CiAgICBpZiAodGhpcy5fcGF0aHNbcGF0aF0gPiAwKSB7CiAgICAgIGV2ZW50cy5wdXNoKHRoaXMudmFsdWUoKSwgcGF0aCk7CiAgICB9CiAgfQp9OwoKQ2hhaW5Ob2RlUHJvdG90eXBlLmNoYWluRGlkQ2hhbmdlID0gZnVuY3Rpb24oY2hhaW4sIHBhdGgsIGRlcHRoLCBldmVudHMpIHsKICBpZiAodGhpcy5fa2V5KSB7IHBhdGggPSB0aGlzLl9rZXkgKyAnLicgKyBwYXRoOyB9CiAgaWYgKHRoaXMuX3BhcmVudCkgewogICAgdGhpcy5fcGFyZW50LmNoYWluRGlkQ2hhbmdlKHRoaXMsIHBhdGgsIGRlcHRoKzEsIGV2ZW50cyk7CiAgfSBlbHNlIHsKICAgIGlmIChkZXB0aCA+IDEpIHsKICAgICAgZXZlbnRzLnB1c2godGhpcy52YWx1ZSgpLCBwYXRoKTsKICAgIH0KICAgIHBhdGggPSAndGhpcy4nICsgcGF0aDsKICAgIGlmICh0aGlzLl9wYXRoc1twYXRoXSA+IDApIHsKICAgICAgZXZlbnRzLnB1c2godGhpcy52YWx1ZSgpLCBwYXRoKTsKICAgIH0KICB9Cn07CgpDaGFpbk5vZGVQcm90b3R5cGUuZGlkQ2hhbmdlID0gZnVuY3Rpb24oZXZlbnRzKSB7CiAgLy8gaW52YWxpZGF0ZSBteSBvd24gdmFsdWUgZmlyc3QuCiAgaWYgKHRoaXMuX3dhdGNoaW5nKSB7CiAgICB2YXIgb2JqID0gdGhpcy5fcGFyZW50LnZhbHVlKCk7CiAgICBpZiAob2JqICE9PSB0aGlzLl9vYmplY3QpIHsKICAgICAgcmVtb3ZlQ2hhaW5XYXRjaGVyKHRoaXMuX29iamVjdCwgdGhpcy5fa2V5LCB0aGlzKTsKICAgICAgdGhpcy5fb2JqZWN0ID0gb2JqOwogICAgICBhZGRDaGFpbldhdGNoZXIob2JqLCB0aGlzLl9rZXksIHRoaXMpOwogICAgfQogICAgdGhpcy5fdmFsdWUgID0gdW5kZWZpbmVkOwoKICAgIC8vIFNwZWNpYWwtY2FzZTogdGhlIEVhY2hQcm94eSByZWxpZXMgb24gaW1tZWRpYXRlIGV2YWx1YXRpb24gdG8KICAgIC8vIGVzdGFibGlzaCBpdHMgb2JzZXJ2ZXJzLgogICAgaWYgKHRoaXMuX3BhcmVudCAmJiB0aGlzLl9wYXJlbnQuX2tleSA9PT0gJ0BlYWNoJykKICAgICAgdGhpcy52YWx1ZSgpOwogIH0KCiAgLy8gdGhlbiBub3RpZnkgY2hhaW5zLi4uCiAgdmFyIGNoYWlucyA9IHRoaXMuX2NoYWluczsKICBpZiAoY2hhaW5zKSB7CiAgICBmb3IodmFyIGtleSBpbiBjaGFpbnMpIHsKICAgICAgaWYgKCFjaGFpbnMuaGFzT3duUHJvcGVydHkoa2V5KSkgeyBjb250aW51ZTsgfQogICAgICBjaGFpbnNba2V5XS5kaWRDaGFuZ2UoZXZlbnRzKTsKICAgIH0KICB9CgogIC8vIGlmIG5vIGV2ZW50cyBhcmUgcGFzc2VkIGluIHRoZW4gd2Ugb25seSBjYXJlIGFib3V0IHRoZSBhYm92ZSB3aXJpbmcgdXBkYXRlCiAgaWYgKGV2ZW50cyA9PT0gbnVsbCkgeyByZXR1cm47IH0KCiAgLy8gYW5kIGZpbmFsbHkgdGVsbCBwYXJlbnQgYWJvdXQgbXkgcGF0aCBjaGFuZ2luZy4uLgogIGlmICh0aGlzLl9wYXJlbnQpIHsgdGhpcy5fcGFyZW50LmNoYWluRGlkQ2hhbmdlKHRoaXMsIHRoaXMuX2tleSwgMSwgZXZlbnRzKTsgfQp9OwoKRW1iZXIuZmluaXNoQ2hhaW5zID0gZnVuY3Rpb24ob2JqKSB7CiAgdmFyIG0gPSBtZXRhRm9yKG9iaiwgZmFsc2UpLCBjaGFpbnMgPSBtLmNoYWluczsKICBpZiAoY2hhaW5zKSB7CiAgICBpZiAoY2hhaW5zLnZhbHVlKCkgIT09IG9iaikgewogICAgICBtLmNoYWlucyA9IGNoYWlucyA9IGNoYWlucy5jb3B5KG9iaik7CiAgICB9CiAgICBjaGFpbnMuZGlkQ2hhbmdlKG51bGwpOwogIH0KfTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKdmFyIG1ldGFGb3IgPSBFbWJlci5tZXRhLCAvLyB1dGlscy5qcwogICAgdHlwZU9mID0gRW1iZXIudHlwZU9mLCAvLyB1dGlscy5qcwogICAgQ2hhaW5Ob2RlID0gRW1iZXIuX0NoYWluTm9kZTsgLy8gY2hhaW5zLmpzCgovLyBnZXQgdGhlIGNoYWlucyBmb3IgdGhlIGN1cnJlbnQgb2JqZWN0LiBJZiB0aGUgY3VycmVudCBvYmplY3QgaGFzCi8vIGNoYWlucyBpbmhlcml0ZWQgZnJvbSB0aGUgcHJvdG8gdGhleSB3aWxsIGJlIGNsb25lZCBhbmQgcmVjb25maWd1cmVkIGZvcgovLyB0aGUgY3VycmVudCBvYmplY3QuCmZ1bmN0aW9uIGNoYWluc0ZvcihvYmopIHsKICB2YXIgbSA9IG1ldGFGb3Iob2JqKSwgcmV0ID0gbS5jaGFpbnM7CiAgaWYgKCFyZXQpIHsKICAgIHJldCA9IG0uY2hhaW5zID0gbmV3IENoYWluTm9kZShudWxsLCBudWxsLCBvYmopOwogIH0gZWxzZSBpZiAocmV0LnZhbHVlKCkgIT09IG9iaikgewogICAgcmV0ID0gbS5jaGFpbnMgPSByZXQuY29weShvYmopOwogIH0KICByZXR1cm4gcmV0Owp9CgpFbWJlci53YXRjaFBhdGggPSBmdW5jdGlvbihvYmosIGtleVBhdGgpIHsKICAvLyBjYW4ndCB3YXRjaCBsZW5ndGggb24gQXJyYXkgLSBpdCBpcyBzcGVjaWFsLi4uCiAgaWYgKGtleVBhdGggPT09ICdsZW5ndGgnICYmIHR5cGVPZihvYmopID09PSAnYXJyYXknKSB7IHJldHVybjsgfQoKICB2YXIgbSA9IG1ldGFGb3Iob2JqKSwgd2F0Y2hpbmcgPSBtLndhdGNoaW5nOwoKICBpZiAoIXdhdGNoaW5nW2tleVBhdGhdKSB7IC8vIGFjdGl2YXRlIHdhdGNoaW5nIGZpcnN0IHRpbWUKICAgIHdhdGNoaW5nW2tleVBhdGhdID0gMTsKICAgIGNoYWluc0ZvcihvYmopLmFkZChrZXlQYXRoKTsKICB9IGVsc2UgewogICAgd2F0Y2hpbmdba2V5UGF0aF0gPSAod2F0Y2hpbmdba2V5UGF0aF0gfHwgMCkgKyAxOwogIH0KfTsKCkVtYmVyLnVud2F0Y2hQYXRoID0gZnVuY3Rpb24ob2JqLCBrZXlQYXRoKSB7CiAgdmFyIG0gPSBtZXRhRm9yKG9iaiksIHdhdGNoaW5nID0gbS53YXRjaGluZzsKCiAgaWYgKHdhdGNoaW5nW2tleVBhdGhdID09PSAxKSB7CiAgICB3YXRjaGluZ1trZXlQYXRoXSA9IDA7CiAgICBjaGFpbnNGb3Iob2JqKS5yZW1vdmUoa2V5UGF0aCk7CiAgfSBlbHNlIGlmICh3YXRjaGluZ1trZXlQYXRoXSA+IDEpIHsKICAgIHdhdGNoaW5nW2tleVBhdGhdLS07CiAgfQp9Owp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyLW1ldGFsCiovCgp2YXIgbWV0YUZvciA9IEVtYmVyLm1ldGEsIC8vIHV0aWxzLmpzCiAgICBHVUlEX0tFWSA9IEVtYmVyLkdVSURfS0VZLCAvLyB1dGlscy5qcwogICAgTUVUQV9LRVkgPSBFbWJlci5NRVRBX0tFWSwgLy8gdXRpbHMuanMKICAgIHJlbW92ZUNoYWluV2F0Y2hlciA9IEVtYmVyLnJlbW92ZUNoYWluV2F0Y2hlciwKICAgIHdhdGNoS2V5ID0gRW1iZXIud2F0Y2hLZXksIC8vIHdhdGNoX2tleS5qcwogICAgdW53YXRjaEtleSA9IEVtYmVyLnVud2F0Y2hLZXksCiAgICB3YXRjaFBhdGggPSBFbWJlci53YXRjaFBhdGgsIC8vIHdhdGNoX3BhdGguanMKICAgIHVud2F0Y2hQYXRoID0gRW1iZXIudW53YXRjaFBhdGgsCiAgICB0eXBlT2YgPSBFbWJlci50eXBlT2YsIC8vIHV0aWxzLmpzCiAgICBnZW5lcmF0ZUd1aWQgPSBFbWJlci5nZW5lcmF0ZUd1aWQsCiAgICBJU19QQVRIID0gL1tcLlwqXS87CgovLyByZXR1cm5zIHRydWUgaWYgdGhlIHBhc3NlZCBwYXRoIGlzIGp1c3QgYSBrZXlOYW1lCmZ1bmN0aW9uIGlzS2V5TmFtZShwYXRoKSB7CiAgcmV0dXJuIHBhdGg9PT0nKicgfHwgIUlTX1BBVEgudGVzdChwYXRoKTsKfQoKLyoqCiAgU3RhcnRzIHdhdGNoaW5nIGEgcHJvcGVydHkgb24gYW4gb2JqZWN0LiBXaGVuZXZlciB0aGUgcHJvcGVydHkgY2hhbmdlcywKICBpbnZva2VzIGBFbWJlci5wcm9wZXJ0eVdpbGxDaGFuZ2VgIGFuZCBgRW1iZXIucHJvcGVydHlEaWRDaGFuZ2VgLiBUaGlzIGlzIHRoZQogIHByaW1pdGl2ZSB1c2VkIGJ5IG9ic2VydmVycyBhbmQgZGVwZW5kZW50IGtleXM7IHVzdWFsbHkgeW91IHdpbGwgbmV2ZXIgY2FsbAogIHRoaXMgbWV0aG9kIGRpcmVjdGx5IGJ1dCBpbnN0ZWFkIHVzZSBoaWdoZXIgbGV2ZWwgbWV0aG9kcyBsaWtlCiAgYEVtYmVyLmFkZE9ic2VydmVyKClgCgogIEBwcml2YXRlCiAgQG1ldGhvZCB3YXRjaAogIEBmb3IgRW1iZXIKICBAcGFyYW0gb2JqCiAgQHBhcmFtIHtTdHJpbmd9IGtleU5hbWUKKi8KRW1iZXIud2F0Y2ggPSBmdW5jdGlvbihvYmosIF9rZXlQYXRoKSB7CiAgLy8gY2FuJ3Qgd2F0Y2ggbGVuZ3RoIG9uIEFycmF5IC0gaXQgaXMgc3BlY2lhbC4uLgogIGlmIChfa2V5UGF0aCA9PT0gJ2xlbmd0aCcgJiYgdHlwZU9mKG9iaikgPT09ICdhcnJheScpIHsgcmV0dXJuOyB9CgogIGlmIChpc0tleU5hbWUoX2tleVBhdGgpKSB7CiAgICB3YXRjaEtleShvYmosIF9rZXlQYXRoKTsKICB9IGVsc2UgewogICAgd2F0Y2hQYXRoKG9iaiwgX2tleVBhdGgpOwogIH0KfTsKCkVtYmVyLmlzV2F0Y2hpbmcgPSBmdW5jdGlvbiBpc1dhdGNoaW5nKG9iaiwga2V5KSB7CiAgdmFyIG1ldGEgPSBvYmpbTUVUQV9LRVldOwogIHJldHVybiAobWV0YSAmJiBtZXRhLndhdGNoaW5nW2tleV0pID4gMDsKfTsKCkVtYmVyLndhdGNoLmZsdXNoUGVuZGluZyA9IEVtYmVyLmZsdXNoUGVuZGluZ0NoYWluczsKCkVtYmVyLnVud2F0Y2ggPSBmdW5jdGlvbihvYmosIF9rZXlQYXRoKSB7CiAgLy8gY2FuJ3Qgd2F0Y2ggbGVuZ3RoIG9uIEFycmF5IC0gaXQgaXMgc3BlY2lhbC4uLgogIGlmIChfa2V5UGF0aCA9PT0gJ2xlbmd0aCcgJiYgdHlwZU9mKG9iaikgPT09ICdhcnJheScpIHsgcmV0dXJuOyB9CgogIGlmIChpc0tleU5hbWUoX2tleVBhdGgpKSB7CiAgICB1bndhdGNoS2V5KG9iaiwgX2tleVBhdGgpOwogIH0gZWxzZSB7CiAgICB1bndhdGNoUGF0aChvYmosIF9rZXlQYXRoKTsKICB9Cn07CgovKioKICBDYWxsIG9uIGFuIG9iamVjdCB3aGVuIHlvdSBmaXJzdCBiZWdldCBpdCBmcm9tIGFub3RoZXIgb2JqZWN0LiBUaGlzIHdpbGwKICBzZXR1cCBhbnkgY2hhaW5lZCB3YXRjaGVycyBvbiB0aGUgb2JqZWN0IGluc3RhbmNlIGFzIG5lZWRlZC4gVGhpcyBtZXRob2QgaXMKICBzYWZlIHRvIGNhbGwgbXVsdGlwbGUgdGltZXMuCgogIEBwcml2YXRlCiAgQG1ldGhvZCByZXdhdGNoCiAgQGZvciBFbWJlcgogIEBwYXJhbSBvYmoKKi8KRW1iZXIucmV3YXRjaCA9IGZ1bmN0aW9uKG9iaikgewogIHZhciBtID0gbWV0YUZvcihvYmosIGZhbHNlKSwgY2hhaW5zID0gbS5jaGFpbnM7CgogIC8vIG1ha2Ugc3VyZSB0aGUgb2JqZWN0IGhhcyBpdHMgb3duIGd1aWQuCiAgaWYgKEdVSURfS0VZIGluIG9iaiAmJiAhb2JqLmhhc093blByb3BlcnR5KEdVSURfS0VZKSkgewogICAgZ2VuZXJhdGVHdWlkKG9iaik7CiAgfQoKICAvLyBtYWtlIHN1cmUgYW55IGNoYWluZWQgd2F0Y2hlcnMgdXBkYXRlLgogIGlmIChjaGFpbnMgJiYgY2hhaW5zLnZhbHVlKCkgIT09IG9iaikgewogICAgbS5jaGFpbnMgPSBjaGFpbnMuY29weShvYmopOwogIH0KfTsKCnZhciBOT0RFX1NUQUNLID0gW107CgovKioKICBUZWFycyBkb3duIHRoZSBtZXRhIG9uIGFuIG9iamVjdCBzbyB0aGF0IGl0IGNhbiBiZSBnYXJiYWdlIGNvbGxlY3RlZC4KICBNdWx0aXBsZSBjYWxscyB3aWxsIGhhdmUgbm8gZWZmZWN0LgoKICBAbWV0aG9kIGRlc3Ryb3kKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtPYmplY3R9IG9iaiAgdGhlIG9iamVjdCB0byBkZXN0cm95CiAgQHJldHVybiB7dm9pZH0KKi8KRW1iZXIuZGVzdHJveSA9IGZ1bmN0aW9uIChvYmopIHsKICB2YXIgbWV0YSA9IG9ialtNRVRBX0tFWV0sIG5vZGUsIG5vZGVzLCBrZXksIG5vZGVPYmplY3Q7CiAgaWYgKG1ldGEpIHsKICAgIG9ialtNRVRBX0tFWV0gPSBudWxsOwogICAgLy8gcmVtb3ZlIGNoYWluV2F0Y2hlcnMgdG8gcmVtb3ZlIGNpcmN1bGFyIHJlZmVyZW5jZXMgdGhhdCB3b3VsZCBwcmV2ZW50IEdDCiAgICBub2RlID0gbWV0YS5jaGFpbnM7CiAgICBpZiAobm9kZSkgewogICAgICBOT0RFX1NUQUNLLnB1c2gobm9kZSk7CiAgICAgIC8vIHByb2Nlc3MgdHJlZQogICAgICB3aGlsZSAoTk9ERV9TVEFDSy5sZW5ndGggPiAwKSB7CiAgICAgICAgbm9kZSA9IE5PREVfU1RBQ0sucG9wKCk7CiAgICAgICAgLy8gcHVzaCBjaGlsZHJlbgogICAgICAgIG5vZGVzID0gbm9kZS5fY2hhaW5zOwogICAgICAgIGlmIChub2RlcykgewogICAgICAgICAgZm9yIChrZXkgaW4gbm9kZXMpIHsKICAgICAgICAgICAgaWYgKG5vZGVzLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICBOT0RFX1NUQUNLLnB1c2gobm9kZXNba2V5XSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gcmVtb3ZlIGNoYWluV2F0Y2hlciBpbiBub2RlIG9iamVjdAogICAgICAgIGlmIChub2RlLl93YXRjaGluZykgewogICAgICAgICAgbm9kZU9iamVjdCA9IG5vZGUuX29iamVjdDsKICAgICAgICAgIGlmIChub2RlT2JqZWN0KSB7CiAgICAgICAgICAgIHJlbW92ZUNoYWluV2F0Y2hlcihub2RlT2JqZWN0LCBub2RlLl9rZXksIG5vZGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KfTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXItbWV0YWwKKi8KCkVtYmVyLndhcm4oIlRoZSBDUF9ERUZBVUxUX0NBQ0hFQUJMRSBmbGFnIGhhcyBiZWVuIHJlbW92ZWQgYW5kIGNvbXB1dGVkIHByb3BlcnRpZXMgYXJlIGFsd2F5cyBjYWNoZWQgYnkgZGVmYXVsdC4gVXNlIGB2b2xhdGlsZWAgaWYgeW91IGRvbid0IHdhbnQgY2FjaGluZy4iLCBFbWJlci5FTlYuQ1BfREVGQVVMVF9DQUNIRUFCTEUgIT09IGZhbHNlKTsKCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LAogICAgc2V0ID0gRW1iZXIuc2V0LAogICAgbWV0YUZvciA9IEVtYmVyLm1ldGEsCiAgICBhX3NsaWNlID0gW10uc2xpY2UsCiAgICBvX2NyZWF0ZSA9IEVtYmVyLmNyZWF0ZSwKICAgIE1FVEFfS0VZID0gRW1iZXIuTUVUQV9LRVksCiAgICB3YXRjaCA9IEVtYmVyLndhdGNoLAogICAgdW53YXRjaCA9IEVtYmVyLnVud2F0Y2g7CgoKLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgovLyBERVBFTkRFTlQgS0VZUwovLwoKLy8gZGF0YSBzdHJ1Y3R1cmU6Ci8vICBtZXRhLmRlcHMgPSB7Ci8vICAgJ2RlcEtleSc6IHsKLy8gICAgICdrZXlOYW1lJzogY291bnQsCi8vICAgfQovLyAgfQoKLyoKICBUaGlzIGZ1bmN0aW9uIHJldHVybnMgYSBtYXAgb2YgdW5pcXVlIGRlcGVuZGVuY2llcyBmb3IgYQogIGdpdmVuIG9iamVjdCBhbmQga2V5LgoqLwpmdW5jdGlvbiBrZXlzRm9yRGVwKGRlcHNNZXRhLCBkZXBLZXkpIHsKICB2YXIga2V5cyA9IGRlcHNNZXRhW2RlcEtleV07CiAgaWYgKCFrZXlzKSB7CiAgICAvLyBpZiB0aGVyZSBhcmUgbm8gZGVwZW5kZW5jaWVzIHlldCBmb3IgYSB0aGUgZ2l2ZW4ga2V5CiAgICAvLyBjcmVhdGUgYSBuZXcgZW1wdHkgbGlzdCBvZiBkZXBlbmRlbmNpZXMgZm9yIHRoZSBrZXkKICAgIGtleXMgPSBkZXBzTWV0YVtkZXBLZXldID0ge307CiAgfSBlbHNlIGlmICghZGVwc01ldGEuaGFzT3duUHJvcGVydHkoZGVwS2V5KSkgewogICAgLy8gb3RoZXJ3aXNlIGlmIHRoZSBkZXBlbmRlbmN5IGxpc3QgaXMgaW5oZXJpdGVkIGZyb20KICAgIC8vIGEgc3VwZXJjbGFzcywgY2xvbmUgdGhlIGhhc2gKICAgIGtleXMgPSBkZXBzTWV0YVtkZXBLZXldID0gb19jcmVhdGUoa2V5cyk7CiAgfQogIHJldHVybiBrZXlzOwp9CgpmdW5jdGlvbiBtZXRhRm9yRGVwcyhtZXRhKSB7CiAgcmV0dXJuIGtleXNGb3JEZXAobWV0YSwgJ2RlcHMnKTsKfQoKZnVuY3Rpb24gYWRkRGVwZW5kZW50S2V5cyhkZXNjLCBvYmosIGtleU5hbWUsIG1ldGEpIHsKICAvLyB0aGUgZGVzY3JpcHRvciBoYXMgYSBsaXN0IG9mIGRlcGVuZGVudCBrZXlzLCBzbwogIC8vIGFkZCBhbGwgb2YgaXRzIGRlcGVuZGVudCBrZXlzLgogIHZhciBkZXBLZXlzID0gZGVzYy5fZGVwZW5kZW50S2V5cywgZGVwc01ldGEsIGlkeCwgbGVuLCBkZXBLZXksIGtleXM7CiAgaWYgKCFkZXBLZXlzKSByZXR1cm47CgogIGRlcHNNZXRhID0gbWV0YUZvckRlcHMobWV0YSk7CgogIGZvcihpZHggPSAwLCBsZW4gPSBkZXBLZXlzLmxlbmd0aDsgaWR4IDwgbGVuOyBpZHgrKykgewogICAgZGVwS2V5ID0gZGVwS2V5c1tpZHhdOwogICAgLy8gTG9va3VwIGtleXMgbWV0YSBmb3IgZGVwS2V5CiAgICBrZXlzID0ga2V5c0ZvckRlcChkZXBzTWV0YSwgZGVwS2V5KTsKICAgIC8vIEluY3JlbWVudCB0aGUgbnVtYmVyIG9mIHRpbWVzIGRlcEtleSBkZXBlbmRzIG9uIGtleU5hbWUuCiAgICBrZXlzW2tleU5hbWVdID0gKGtleXNba2V5TmFtZV0gfHwgMCkgKyAxOwogICAgLy8gV2F0Y2ggdGhlIGRlcEtleQogICAgd2F0Y2gob2JqLCBkZXBLZXkpOwogIH0KfQoKZnVuY3Rpb24gcmVtb3ZlRGVwZW5kZW50S2V5cyhkZXNjLCBvYmosIGtleU5hbWUsIG1ldGEpIHsKICAvLyB0aGUgZGVzY3JpcHRvciBoYXMgYSBsaXN0IG9mIGRlcGVuZGVudCBrZXlzLCBzbwogIC8vIGFkZCBhbGwgb2YgaXRzIGRlcGVuZGVudCBrZXlzLgogIHZhciBkZXBLZXlzID0gZGVzYy5fZGVwZW5kZW50S2V5cywgZGVwc01ldGEsIGlkeCwgbGVuLCBkZXBLZXksIGtleXM7CiAgaWYgKCFkZXBLZXlzKSByZXR1cm47CgogIGRlcHNNZXRhID0gbWV0YUZvckRlcHMobWV0YSk7CgogIGZvcihpZHggPSAwLCBsZW4gPSBkZXBLZXlzLmxlbmd0aDsgaWR4IDwgbGVuOyBpZHgrKykgewogICAgZGVwS2V5ID0gZGVwS2V5c1tpZHhdOwogICAgLy8gTG9va3VwIGtleXMgbWV0YSBmb3IgZGVwS2V5CiAgICBrZXlzID0ga2V5c0ZvckRlcChkZXBzTWV0YSwgZGVwS2V5KTsKICAgIC8vIEluY3JlbWVudCB0aGUgbnVtYmVyIG9mIHRpbWVzIGRlcEtleSBkZXBlbmRzIG9uIGtleU5hbWUuCiAgICBrZXlzW2tleU5hbWVdID0gKGtleXNba2V5TmFtZV0gfHwgMCkgLSAxOwogICAgLy8gV2F0Y2ggdGhlIGRlcEtleQogICAgdW53YXRjaChvYmosIGRlcEtleSk7CiAgfQp9CgovLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCi8vIENPTVBVVEVEIFBST1BFUlRZCi8vCgovKioKICBBIGNvbXB1dGVkIHByb3BlcnR5IHRyYW5zZm9ybXMgYW4gb2JqZWN0cyBmdW5jdGlvbiBpbnRvIGEgcHJvcGVydHkuCgogIEJ5IGRlZmF1bHQgdGhlIGZ1bmN0aW9uIGJhY2tpbmcgdGhlIGNvbXB1dGVkIHByb3BlcnR5IHdpbGwgb25seSBiZSBjYWxsZWQKICBvbmNlIGFuZCB0aGUgcmVzdWx0IHdpbGwgYmUgY2FjaGVkLiBZb3UgY2FuIHNwZWNpZnkgdmFyaW91cyBwcm9wZXJ0aWVzCiAgdGhhdCB5b3VyIGNvbXB1dGVkIHByb3BlcnR5IGlzIGRlcGVuZGVudCBvbi4gVGhpcyB3aWxsIGZvcmNlIHRoZSBjYWNoZWQKICByZXN1bHQgdG8gYmUgcmVjb21wdXRlZCBpZiB0aGUgZGVwZW5kZW5jaWVzIGFyZSBtb2RpZmllZC4KCiAgSW4gdGhlIGZvbGxvd2luZyBleGFtcGxlIHdlIGRlY2xhcmUgYSBjb21wdXRlZCBwcm9wZXJ0eSAoYnkgY2FsbGluZwogIGAucHJvcGVydHkoKWAgb24gdGhlIGZ1bGxOYW1lIGZ1bmN0aW9uKSBhbmQgc2V0dXAgdGhlIHByb3BlcnRpZXMKICBkZXBlbmRlbmNpZXMgKGRlcGVuZGluZyBvbiBmaXJzdE5hbWUgYW5kIGxhc3ROYW1lKS4gVGhlIGZ1bGxOYW1lIGZ1bmN0aW9uCiAgd2lsbCBiZSBjYWxsZWQgb25jZSAocmVnYXJkbGVzcyBvZiBob3cgbWFueSB0aW1lcyBpdCBpcyBhY2Nlc3NlZCkgYXMgbG9uZwogIGFzIGl0J3MgZGVwZW5kZW5jaWVzIGhhdmUgbm90IGJlZW4gY2hhbmdlZC4gT25jZSBmaXJzdE5hbWUgb3IgbGFzdE5hbWUgYXJlIHVwZGF0ZWQKICBhbnkgZnV0dXJlIGNhbGxzIChvciBhbnl0aGluZyBib3VuZCkgdG8gZnVsbE5hbWUgd2lsbCBpbmNvcnBvcmF0ZSB0aGUgbmV3CiAgdmFsdWVzLgoKICBgYGBqYXZhc2NyaXB0CiAgUGVyc29uID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CiAgICAvLyB0aGVzZSB3aWxsIGJlIHN1cHBsaWVkIGJ5IGBjcmVhdGVgCiAgICBmaXJzdE5hbWU6IG51bGwsCiAgICBsYXN0TmFtZTogbnVsbCwKCiAgICBmdWxsTmFtZTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBmaXJzdE5hbWUgPSB0aGlzLmdldCgnZmlyc3ROYW1lJyk7CiAgICAgIHZhciBsYXN0TmFtZSA9IHRoaXMuZ2V0KCdsYXN0TmFtZScpOwoKICAgICByZXR1cm4gZmlyc3ROYW1lICsgJyAnICsgbGFzdE5hbWU7CiAgICB9LnByb3BlcnR5KCdmaXJzdE5hbWUnLCAnbGFzdE5hbWUnKQogIH0pOwoKICB2YXIgdG9tID0gUGVyc29uLmNyZWF0ZSh7CiAgICBmaXJzdE5hbWU6ICJUb20iLAogICAgbGFzdE5hbWU6ICJEYWxlIgogIH0pOwoKICB0b20uZ2V0KCdmdWxsTmFtZScpIC8vICJUb20gRGFsZSIKICBgYGAKCiAgWW91IGNhbiBhbHNvIGRlZmluZSB3aGF0IEVtYmVyIHNob3VsZCBkbyB3aGVuIHNldHRpbmcgYSBjb21wdXRlZCBwcm9wZXJ0eS4KICBJZiB5b3UgdHJ5IHRvIHNldCBhIGNvbXB1dGVkIHByb3BlcnR5LCBpdCB3aWxsIGJlIGludm9rZWQgd2l0aCB0aGUga2V5IGFuZAogIHZhbHVlIHlvdSB3YW50IHRvIHNldCBpdCB0by4gWW91IGNhbiBhbHNvIGFjY2VwdCB0aGUgcHJldmlvdXMgdmFsdWUgYXMgdGhlCiAgdGhpcmQgcGFyYW1ldGVyLgoKICBgYGBqYXZhc2NyaXB0CgogUGVyc29uID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CiAgICAvLyB0aGVzZSB3aWxsIGJlIHN1cHBsaWVkIGJ5IGBjcmVhdGVgCiAgICBmaXJzdE5hbWU6IG51bGwsCiAgICBsYXN0TmFtZTogbnVsbCwKCiAgICBmdWxsTmFtZTogZnVuY3Rpb24oa2V5LCB2YWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgLy8gZ2V0dGVyCiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdmFyIGZpcnN0TmFtZSA9IHRoaXMuZ2V0KCdmaXJzdE5hbWUnKTsKICAgICAgICB2YXIgbGFzdE5hbWUgPSB0aGlzLmdldCgnbGFzdE5hbWUnKTsKCiAgICAgICAgcmV0dXJuIGZpcnN0TmFtZSArICcgJyArIGxhc3ROYW1lOwoKICAgICAgLy8gc2V0dGVyCiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIG5hbWUgPSB2YWx1ZS5zcGxpdCgiICIpOwoKICAgICAgICB0aGlzLnNldCgnZmlyc3ROYW1lJywgbmFtZVswXSk7CiAgICAgICAgdGhpcy5zZXQoJ2xhc3ROYW1lJywgbmFtZVsxXSk7CgogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgfS5wcm9wZXJ0eSgnZmlyc3ROYW1lJywgJ2xhc3ROYW1lJykKICB9KTsKCiAgdmFyIHBlcnNvbiA9IFBlcnNvbi5jcmVhdGUoKTsKICBwZXJzb24uc2V0KCdmdWxsTmFtZScsICJQZXRlciBXYWdlbmV0Iik7CiAgcGVyc29uLmdldCgnZmlyc3ROYW1lJykgLy8gUGV0ZXIKICBwZXJzb24uZ2V0KCdsYXN0TmFtZScpIC8vIFdhZ2VuZXQKICBgYGAKCiAgQGNsYXNzIENvbXB1dGVkUHJvcGVydHkKICBAbmFtZXNwYWNlIEVtYmVyCiAgQGV4dGVuZHMgRW1iZXIuRGVzY3JpcHRvcgogIEBjb25zdHJ1Y3RvcgoqLwpmdW5jdGlvbiBDb21wdXRlZFByb3BlcnR5KGZ1bmMsIG9wdHMpIHsKICB0aGlzLmZ1bmMgPSBmdW5jOwoKICB0aGlzLl9jYWNoZWFibGUgPSAob3B0cyAmJiBvcHRzLmNhY2hlYWJsZSAhPT0gdW5kZWZpbmVkKSA/IG9wdHMuY2FjaGVhYmxlIDogdHJ1ZTsKICB0aGlzLl9kZXBlbmRlbnRLZXlzID0gb3B0cyAmJiBvcHRzLmRlcGVuZGVudEtleXM7CiAgdGhpcy5fcmVhZE9ubHkgPSBvcHRzICYmIChvcHRzLnJlYWRPbmx5ICE9PSB1bmRlZmluZWQgfHwgISFvcHRzLnJlYWRPbmx5KTsKfQoKRW1iZXIuQ29tcHV0ZWRQcm9wZXJ0eSA9IENvbXB1dGVkUHJvcGVydHk7CkNvbXB1dGVkUHJvcGVydHkucHJvdG90eXBlID0gbmV3IEVtYmVyLkRlc2NyaXB0b3IoKTsKCnZhciBDb21wdXRlZFByb3BlcnR5UHJvdG90eXBlID0gQ29tcHV0ZWRQcm9wZXJ0eS5wcm90b3R5cGU7CgovKioKICBQcm9wZXJ0aWVzIGFyZSBjYWNoZWFibGUgYnkgZGVmYXVsdC4gQ29tcHV0ZWQgcHJvcGVydHkgd2lsbCBhdXRvbWF0aWNhbGx5CiAgY2FjaGUgdGhlIHJldHVybiB2YWx1ZSBvZiB5b3VyIGZ1bmN0aW9uIHVudGlsIG9uZSBvZiB0aGUgZGVwZW5kZW50IGtleXMgY2hhbmdlcy4KCiAgQ2FsbCBgdm9sYXRpbGUoKWAgdG8gc2V0IGl0IGludG8gbm9uLWNhY2hlZCBtb2RlLiBXaGVuIGluIHRoaXMgbW9kZQogIHRoZSBjb21wdXRlZCBwcm9wZXJ0eSB3aWxsIG5vdCBhdXRvbWF0aWNhbGx5IGNhY2hlIHRoZSByZXR1cm4gdmFsdWUuCgogIEhvd2V2ZXIsIGlmIGEgcHJvcGVydHkgaXMgcHJvcGVybHkgb2JzZXJ2YWJsZSwgdGhlcmUgaXMgbm8gcmVhc29uIHRvIGRpc2FibGUKICBjYWNoaW5nLgoKICBAbWV0aG9kIGNhY2hlYWJsZQogIEBwYXJhbSB7Qm9vbGVhbn0gYUZsYWcgb3B0aW9uYWwgc2V0IHRvIGBmYWxzZWAgdG8gZGlzYWJsZSBjYWNoaW5nCiAgQHJldHVybiB7RW1iZXIuQ29tcHV0ZWRQcm9wZXJ0eX0gdGhpcwogIEBjaGFpbmFibGUKKi8KQ29tcHV0ZWRQcm9wZXJ0eVByb3RvdHlwZS5jYWNoZWFibGUgPSBmdW5jdGlvbihhRmxhZykgewogIHRoaXMuX2NhY2hlYWJsZSA9IGFGbGFnICE9PSBmYWxzZTsKICByZXR1cm4gdGhpczsKfTsKCi8qKgogIENhbGwgb24gYSBjb21wdXRlZCBwcm9wZXJ0eSB0byBzZXQgaXQgaW50byBub24tY2FjaGVkIG1vZGUuIFdoZW4gaW4gdGhpcwogIG1vZGUgdGhlIGNvbXB1dGVkIHByb3BlcnR5IHdpbGwgbm90IGF1dG9tYXRpY2FsbHkgY2FjaGUgdGhlIHJldHVybiB2YWx1ZS4KCiAgYGBgamF2YXNjcmlwdAogIE15QXBwLm91dHNpZGVTZXJ2aWNlID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CiAgICB2YWx1ZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBPdXRzaWRlU2VydmljZS5nZXRWYWx1ZSgpOwogICAgfS5wcm9wZXJ0eSgpLnZvbGF0aWxlKCkKICB9KS5jcmVhdGUoKTsKICBgYGAKCiAgQG1ldGhvZCB2b2xhdGlsZQogIEByZXR1cm4ge0VtYmVyLkNvbXB1dGVkUHJvcGVydHl9IHRoaXMKICBAY2hhaW5hYmxlCiovCkNvbXB1dGVkUHJvcGVydHlQcm90b3R5cGUudm9sYXRpbGUgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5jYWNoZWFibGUoZmFsc2UpOwp9OwoKLyoqCiAgQ2FsbCBvbiBhIGNvbXB1dGVkIHByb3BlcnR5IHRvIHNldCBpdCBpbnRvIHJlYWQtb25seSBtb2RlLiBXaGVuIGluIHRoaXMKICBtb2RlIHRoZSBjb21wdXRlZCBwcm9wZXJ0eSB3aWxsIHRocm93IGFuIGVycm9yIHdoZW4gc2V0LgoKICBgYGBqYXZhc2NyaXB0CiAgTXlBcHAuUGVyc29uID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CiAgICBndWlkOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICdndWlkLWd1aWQtZ3VpZCc7CiAgICB9LnByb3BlcnR5KCkucmVhZE9ubHkoKQogIH0pOwoKICBNeUFwcC5wZXJzb24gPSBNeUFwcC5QZXJzb24uY3JlYXRlKCk7CgogIE15QXBwLnBlcnNvbi5zZXQoJ2d1aWQnLCAnbmV3LWd1aWQnKTsgLy8gd2lsbCB0aHJvdyBhbiBleGNlcHRpb24KICBgYGAKCiAgQG1ldGhvZCByZWFkT25seQogIEByZXR1cm4ge0VtYmVyLkNvbXB1dGVkUHJvcGVydHl9IHRoaXMKICBAY2hhaW5hYmxlCiovCkNvbXB1dGVkUHJvcGVydHlQcm90b3R5cGUucmVhZE9ubHkgPSBmdW5jdGlvbihyZWFkT25seSkgewogIHRoaXMuX3JlYWRPbmx5ID0gcmVhZE9ubHkgPT09IHVuZGVmaW5lZCB8fCAhIXJlYWRPbmx5OwogIHJldHVybiB0aGlzOwp9OwoKLyoqCiAgU2V0cyB0aGUgZGVwZW5kZW50IGtleXMgb24gdGhpcyBjb21wdXRlZCBwcm9wZXJ0eS4gUGFzcyBhbnkgbnVtYmVyIG9mCiAgYXJndW1lbnRzIGNvbnRhaW5pbmcga2V5IHBhdGhzIHRoYXQgdGhpcyBjb21wdXRlZCBwcm9wZXJ0eSBkZXBlbmRzIG9uLgoKICBgYGBqYXZhc2NyaXB0CiAgTXlBcHAuUHJlc2lkZW50ID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CiAgICBmdWxsTmFtZTogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmdldCgnZmlyc3ROYW1lJykgKyAnICcgKyB0aGlzLmdldCgnbGFzdE5hbWUnKTsKCiAgICAgIC8vIFRlbGwgRW1iZXIgdGhhdCB0aGlzIGNvbXB1dGVkIHByb3BlcnR5IGRlcGVuZHMgb24gZmlyc3ROYW1lCiAgICAgIC8vIGFuZCBsYXN0TmFtZQogICAgfSkucHJvcGVydHkoJ2ZpcnN0TmFtZScsICdsYXN0TmFtZScpCiAgfSk7CgogIE15QXBwLnByZXNpZGVudCA9IE15QXBwLlByZXNpZGVudC5jcmVhdGUoewogICAgZmlyc3ROYW1lOiAnQmFyYWNrJywKICAgIGxhc3ROYW1lOiAnT2JhbWEnLAogIH0pOwogIE15QXBwLnByZXNpZGVudC5nZXQoJ2Z1bGxOYW1lJyk7IC8vIEJhcmFjayBPYmFtYQogIGBgYAoKICBAbWV0aG9kIHByb3BlcnR5CiAgQHBhcmFtIHtTdHJpbmd9IHBhdGgqIHplcm8gb3IgbW9yZSBwcm9wZXJ0eSBwYXRocwogIEByZXR1cm4ge0VtYmVyLkNvbXB1dGVkUHJvcGVydHl9IHRoaXMKICBAY2hhaW5hYmxlCiovCkNvbXB1dGVkUHJvcGVydHlQcm90b3R5cGUucHJvcGVydHkgPSBmdW5jdGlvbigpIHsKICB2YXIgYXJnczsKCiAgCiAgICBhcmdzID0gYV9zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgCgogIHRoaXMuX2RlcGVuZGVudEtleXMgPSBhcmdzOwogIHJldHVybiB0aGlzOwp9OwoKLyoqCiAgSW4gc29tZSBjYXNlcywgeW91IG1heSB3YW50IHRvIGFubm90YXRlIGNvbXB1dGVkIHByb3BlcnRpZXMgd2l0aCBhZGRpdGlvbmFsCiAgbWV0YWRhdGEgYWJvdXQgaG93IHRoZXkgZnVuY3Rpb24gb3Igd2hhdCB2YWx1ZXMgdGhleSBvcGVyYXRlIG9uLiBGb3IgZXhhbXBsZSwKICBjb21wdXRlZCBwcm9wZXJ0eSBmdW5jdGlvbnMgbWF5IGNsb3NlIG92ZXIgdmFyaWFibGVzIHRoYXQgYXJlIHRoZW4gbm8gbG9uZ2VyCiAgYXZhaWxhYmxlIGZvciBpbnRyb3NwZWN0aW9uLgoKICBZb3UgY2FuIHBhc3MgYSBoYXNoIG9mIHRoZXNlIHZhbHVlcyB0byBhIGNvbXB1dGVkIHByb3BlcnR5IGxpa2UgdGhpczoKCiAgYGBgCiAgcGVyc29uOiBmdW5jdGlvbigpIHsKICAgIHZhciBwZXJzb25JZCA9IHRoaXMuZ2V0KCdwZXJzb25JZCcpOwogICAgcmV0dXJuIEFwcC5QZXJzb24uY3JlYXRlKHsgaWQ6IHBlcnNvbklkIH0pOwogIH0ucHJvcGVydHkoKS5tZXRhKHsgdHlwZTogQXBwLlBlcnNvbiB9KQogIGBgYAoKICBUaGUgaGFzaCB0aGF0IHlvdSBwYXNzIHRvIHRoZSBgbWV0YSgpYCBmdW5jdGlvbiB3aWxsIGJlIHNhdmVkIG9uIHRoZQogIGNvbXB1dGVkIHByb3BlcnR5IGRlc2NyaXB0b3IgdW5kZXIgdGhlIGBfbWV0YWAga2V5LiBFbWJlciBydW50aW1lCiAgZXhwb3NlcyBhIHB1YmxpYyBBUEkgZm9yIHJldHJpZXZpbmcgdGhlc2UgdmFsdWVzIGZyb20gY2xhc3NlcywKICB2aWEgdGhlIGBtZXRhRm9yUHJvcGVydHkoKWAgZnVuY3Rpb24uCgogIEBtZXRob2QgbWV0YQogIEBwYXJhbSB7SGFzaH0gbWV0YQogIEBjaGFpbmFibGUKKi8KCkNvbXB1dGVkUHJvcGVydHlQcm90b3R5cGUubWV0YSA9IGZ1bmN0aW9uKG1ldGEpIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHRoaXMuX21ldGEgfHwge307CiAgfSBlbHNlIHsKICAgIHRoaXMuX21ldGEgPSBtZXRhOwogICAgcmV0dXJuIHRoaXM7CiAgfQp9OwoKLyogaW1wbCBkZXNjcmlwdG9yIEFQSSAqLwpDb21wdXRlZFByb3BlcnR5UHJvdG90eXBlLmRpZENoYW5nZSA9IGZ1bmN0aW9uKG9iaiwga2V5TmFtZSkgewogIC8vIF9zdXNwZW5kZWQgaXMgc2V0IHZpYSBhIENQLnNldCB0byBlbnN1cmUgd2UgZG9uJ3QgY2xlYXIKICAvLyB0aGUgY2FjaGVkIHZhbHVlIHNldCBieSB0aGUgc2V0dGVyCiAgaWYgKHRoaXMuX2NhY2hlYWJsZSAmJiB0aGlzLl9zdXNwZW5kZWQgIT09IG9iaikgewogICAgdmFyIG1ldGEgPSBtZXRhRm9yKG9iaik7CiAgICBpZiAoa2V5TmFtZSBpbiBtZXRhLmNhY2hlKSB7CiAgICAgIGRlbGV0ZSBtZXRhLmNhY2hlW2tleU5hbWVdOwogICAgICByZW1vdmVEZXBlbmRlbnRLZXlzKHRoaXMsIG9iaiwga2V5TmFtZSwgbWV0YSk7CiAgICB9CiAgfQp9OwoKZnVuY3Rpb24gZmluaXNoQ2hhaW5zKGNoYWluTm9kZXMpCnsKICBmb3IgKHZhciBpPTAsIGw9Y2hhaW5Ob2Rlcy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICBjaGFpbk5vZGVzW2ldLmRpZENoYW5nZShudWxsKTsKICB9Cn0KCi8qKgogIEFjY2VzcyB0aGUgdmFsdWUgb2YgdGhlIGZ1bmN0aW9uIGJhY2tpbmcgdGhlIGNvbXB1dGVkIHByb3BlcnR5LgogIElmIHRoaXMgcHJvcGVydHkgaGFzIGFscmVhZHkgYmVlbiBjYWNoZWQsIHJldHVybiB0aGUgY2FjaGVkIHJlc3VsdC4KICBPdGhlcndpc2UsIGNhbGwgdGhlIGZ1bmN0aW9uIHBhc3NpbmcgdGhlIHByb3BlcnR5IG5hbWUgYXMgYW4gYXJndW1lbnQuCgogIGBgYGphdmFzY3JpcHQKICBQZXJzb24gPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICAgIGZ1bGxOYW1lOiBmdW5jdGlvbihrZXlOYW1lKSB7CiAgICAgIC8vIHRoZSBrZXlOYW1lIHBhcmFtZXRlciBpcyAnZnVsbE5hbWUnIGluIHRoaXMgY2FzZS4KCiAgICAgIHJldHVybiB0aGlzLmdldCgnZmlyc3ROYW1lJykgKyAnICcgKyB0aGlzLmdldCgnbGFzdE5hbWUnKTsKICAgIH0ucHJvcGVydHkoJ2ZpcnN0TmFtZScsICdsYXN0TmFtZScpCiAgfSk7CgoKICB2YXIgdG9tID0gUGVyc29uLmNyZWF0ZSh7CiAgICBmaXJzdE5hbWU6ICJUb20iLAogICAgbGFzdE5hbWU6ICJEYWxlIgogIH0pOwoKICB0b20uZ2V0KCdmdWxsTmFtZScpIC8vICJUb20gRGFsZSIKICBgYGAKCiAgQG1ldGhvZCBnZXQKICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZSBUaGUga2V5IGJlaW5nIGFjY2Vzc2VkLgogIEByZXR1cm4ge09iamVjdH0gVGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgZnVuY3Rpb24gYmFja2luZyB0aGUgQ1AuCiovCkNvbXB1dGVkUHJvcGVydHlQcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24ob2JqLCBrZXlOYW1lKSB7CiAgdmFyIHJldCwgY2FjaGUsIG1ldGEsIGNoYWluTm9kZXM7CiAgaWYgKHRoaXMuX2NhY2hlYWJsZSkgewogICAgbWV0YSA9IG1ldGFGb3Iob2JqKTsKICAgIGNhY2hlID0gbWV0YS5jYWNoZTsKICAgIGlmIChrZXlOYW1lIGluIGNhY2hlKSB7IHJldHVybiBjYWNoZVtrZXlOYW1lXTsgfQogICAgcmV0ID0gY2FjaGVba2V5TmFtZV0gPSB0aGlzLmZ1bmMuY2FsbChvYmosIGtleU5hbWUpOwogICAgY2hhaW5Ob2RlcyA9IG1ldGEuY2hhaW5XYXRjaGVycyAmJiBtZXRhLmNoYWluV2F0Y2hlcnNba2V5TmFtZV07CiAgICBpZiAoY2hhaW5Ob2RlcykgeyBmaW5pc2hDaGFpbnMoY2hhaW5Ob2Rlcyk7IH0KICAgIGFkZERlcGVuZGVudEtleXModGhpcywgb2JqLCBrZXlOYW1lLCBtZXRhKTsKICB9IGVsc2UgewogICAgcmV0ID0gdGhpcy5mdW5jLmNhbGwob2JqLCBrZXlOYW1lKTsKICB9CiAgcmV0dXJuIHJldDsKfTsKCi8qKgogIFNldCB0aGUgdmFsdWUgb2YgYSBjb21wdXRlZCBwcm9wZXJ0eS4gSWYgdGhlIGZ1bmN0aW9uIHRoYXQgYmFja3MgeW91cgogIGNvbXB1dGVkIHByb3BlcnR5IGRvZXMgbm90IGFjY2VwdCBhcmd1bWVudHMgdGhlbiB0aGUgZGVmYXVsdCBhY3Rpb24gZm9yCiAgc2V0dGluZyB3b3VsZCBiZSB0byBkZWZpbmUgdGhlIHByb3BlcnR5IG9uIHRoZSBjdXJyZW50IG9iamVjdCwgYW5kIHNldAogIHRoZSB2YWx1ZSBvZiB0aGUgcHJvcGVydHkgdG8gdGhlIHZhbHVlIGJlaW5nIHNldC4KCiAgR2VuZXJhbGx5IHNwZWFraW5nIGlmIHlvdSBpbnRlbmQgZm9yIHlvdXIgY29tcHV0ZWQgcHJvcGVydHkgdG8gYmUgc2V0CiAgeW91ciBiYWNraW5nIGZ1bmN0aW9uIHNob3VsZCBhY2NlcHQgZWl0aGVyIHR3byBvciB0aHJlZSBhcmd1bWVudHMuCgogIEBtZXRob2Qgc2V0CiAgQHBhcmFtIHtTdHJpbmd9IGtleU5hbWUgVGhlIGtleSBiZWluZyBhY2Nlc3NlZC4KICBAcGFyYW0ge09iamVjdH0gbmV3VmFsdWUgVGhlIG5ldyB2YWx1ZSBiZWluZyBhc3NpZ25lZC4KICBAcGFyYW0ge1N0cmluZ30gb2xkVmFsdWUgVGhlIG9sZCB2YWx1ZSBiZWluZyByZXBsYWNlZC4KICBAcmV0dXJuIHtPYmplY3R9IFRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGZ1bmN0aW9uIGJhY2tpbmcgdGhlIENQLgoqLwpDb21wdXRlZFByb3BlcnR5UHJvdG90eXBlLnNldCA9IGZ1bmN0aW9uKG9iaiwga2V5TmFtZSwgdmFsdWUpIHsKICB2YXIgY2FjaGVhYmxlID0gdGhpcy5fY2FjaGVhYmxlLAogICAgICBmdW5jID0gdGhpcy5mdW5jLAogICAgICBtZXRhID0gbWV0YUZvcihvYmosIGNhY2hlYWJsZSksCiAgICAgIHdhdGNoZWQgPSBtZXRhLndhdGNoaW5nW2tleU5hbWVdLAogICAgICBvbGRTdXNwZW5kZWQgPSB0aGlzLl9zdXNwZW5kZWQsCiAgICAgIGhhZENhY2hlZFZhbHVlID0gZmFsc2UsCiAgICAgIGNhY2hlID0gbWV0YS5jYWNoZSwKICAgICAgZnVuY0FyZ0xlbmd0aCwgY2FjaGVkVmFsdWUsIHJldDsKCiAgaWYgKHRoaXMuX3JlYWRPbmx5KSB7CiAgICB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoJ0Nhbm5vdCBTZXQ6ICcgKyBrZXlOYW1lICsgJyBvbjogJyArIG9iai50b1N0cmluZygpICk7CiAgfQoKICB0aGlzLl9zdXNwZW5kZWQgPSBvYmo7CgogIHRyeSB7CgogICAgaWYgKGNhY2hlYWJsZSAmJiBjYWNoZS5oYXNPd25Qcm9wZXJ0eShrZXlOYW1lKSkgewogICAgICBjYWNoZWRWYWx1ZSA9IGNhY2hlW2tleU5hbWVdOwogICAgICBoYWRDYWNoZWRWYWx1ZSA9IHRydWU7CiAgICB9CgogICAgLy8gQ2hlY2sgaWYgdGhlIENQIGhhcyBiZWVuIHdyYXBwZWQuIElmIGlmIGhhcywgdXNlIHRoZQogICAgLy8gbGVuZ3RoIGZyb20gdGhlIHdyYXBwZWQgZnVuY3Rpb24uCiAgICBmdW5jQXJnTGVuZ3RoID0gKGZ1bmMud3JhcHBlZEZ1bmN0aW9uID8gZnVuYy53cmFwcGVkRnVuY3Rpb24ubGVuZ3RoIDogZnVuYy5sZW5ndGgpOwoKICAgIC8vIEZvciBiYWNrd2FyZHMtY29tcGF0aWJpbGl0eSB3aXRoIGNvbXB1dGVkIHByb3BlcnRpZXMKICAgIC8vIHRoYXQgY2hlY2sgZm9yIGFyZ3VtZW50cy5sZW5ndGggPT09IDIgdG8gZGV0ZXJtaW5lIGlmCiAgICAvLyB0aGV5IGFyZSBiZWluZyBnZXQgb3Igc2V0LCBvbmx5IHBhc3MgdGhlIG9sZCBjYWNoZWQKICAgIC8vIHZhbHVlIGlmIHRoZSBjb21wdXRlZCBwcm9wZXJ0eSBvcHRzIGludG8gYSB0aGlyZAogICAgLy8gYXJndW1lbnQuCiAgICBpZiAoZnVuY0FyZ0xlbmd0aCA9PT0gMykgewogICAgICByZXQgPSBmdW5jLmNhbGwob2JqLCBrZXlOYW1lLCB2YWx1ZSwgY2FjaGVkVmFsdWUpOwogICAgfSBlbHNlIGlmIChmdW5jQXJnTGVuZ3RoID09PSAyKSB7CiAgICAgIHJldCA9IGZ1bmMuY2FsbChvYmosIGtleU5hbWUsIHZhbHVlKTsKICAgIH0gZWxzZSB7CiAgICAgIEVtYmVyLmRlZmluZVByb3BlcnR5KG9iaiwga2V5TmFtZSwgbnVsbCwgY2FjaGVkVmFsdWUpOwogICAgICBFbWJlci5zZXQob2JqLCBrZXlOYW1lLCB2YWx1ZSk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoaGFkQ2FjaGVkVmFsdWUgJiYgY2FjaGVkVmFsdWUgPT09IHJldCkgeyByZXR1cm47IH0KCiAgICBpZiAod2F0Y2hlZCkgeyBFbWJlci5wcm9wZXJ0eVdpbGxDaGFuZ2Uob2JqLCBrZXlOYW1lKTsgfQoKICAgIGlmIChoYWRDYWNoZWRWYWx1ZSkgewogICAgICBkZWxldGUgY2FjaGVba2V5TmFtZV07CiAgICB9CgogICAgaWYgKGNhY2hlYWJsZSkgewogICAgICBpZiAoIWhhZENhY2hlZFZhbHVlKSB7CiAgICAgICAgYWRkRGVwZW5kZW50S2V5cyh0aGlzLCBvYmosIGtleU5hbWUsIG1ldGEpOwogICAgICB9CiAgICAgIGNhY2hlW2tleU5hbWVdID0gcmV0OwogICAgfQoKICAgIGlmICh3YXRjaGVkKSB7IEVtYmVyLnByb3BlcnR5RGlkQ2hhbmdlKG9iaiwga2V5TmFtZSk7IH0KICB9IGZpbmFsbHkgewogICAgdGhpcy5fc3VzcGVuZGVkID0gb2xkU3VzcGVuZGVkOwogIH0KICByZXR1cm4gcmV0Owp9OwoKLyogY2FsbGVkIGJlZm9yZSBwcm9wZXJ0eSBpcyBvdmVycmlkZGVuICovCkNvbXB1dGVkUHJvcGVydHlQcm90b3R5cGUudGVhcmRvd24gPSBmdW5jdGlvbihvYmosIGtleU5hbWUpIHsKICB2YXIgbWV0YSA9IG1ldGFGb3Iob2JqKTsKCiAgaWYgKGtleU5hbWUgaW4gbWV0YS5jYWNoZSkgewogICAgcmVtb3ZlRGVwZW5kZW50S2V5cyh0aGlzLCBvYmosIGtleU5hbWUsIG1ldGEpOwogIH0KCiAgaWYgKHRoaXMuX2NhY2hlYWJsZSkgeyBkZWxldGUgbWV0YS5jYWNoZVtrZXlOYW1lXTsgfQoKICByZXR1cm4gbnVsbDsgLy8gbm8gdmFsdWUgdG8gcmVzdG9yZQp9OwoKCi8qKgogIFRoaXMgaGVscGVyIHJldHVybnMgYSBuZXcgcHJvcGVydHkgZGVzY3JpcHRvciB0aGF0IHdyYXBzIHRoZSBwYXNzZWQKICBjb21wdXRlZCBwcm9wZXJ0eSBmdW5jdGlvbi4gWW91IGNhbiB1c2UgdGhpcyBoZWxwZXIgdG8gZGVmaW5lIHByb3BlcnRpZXMKICB3aXRoIG1peGlucyBvciB2aWEgYEVtYmVyLmRlZmluZVByb3BlcnR5KClgLgoKICBUaGUgZnVuY3Rpb24geW91IHBhc3Mgd2lsbCBiZSB1c2VkIHRvIGJvdGggZ2V0IGFuZCBzZXQgcHJvcGVydHkgdmFsdWVzLgogIFRoZSBmdW5jdGlvbiBzaG91bGQgYWNjZXB0IHR3byBwYXJhbWV0ZXJzLCBrZXkgYW5kIHZhbHVlLiBJZiB2YWx1ZSBpcyBub3QKICB1bmRlZmluZWQgeW91IHNob3VsZCBzZXQgdGhlIHZhbHVlIGZpcnN0LiBJbiBlaXRoZXIgY2FzZSByZXR1cm4gdGhlCiAgY3VycmVudCB2YWx1ZSBvZiB0aGUgcHJvcGVydHkuCiAgQG1ldGhvZCBjb21wdXRlZAogIEBmb3IgRW1iZXIKICBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBjb21wdXRlZCBwcm9wZXJ0eSBmdW5jdGlvbi4KICBAcmV0dXJuIHtFbWJlci5Db21wdXRlZFByb3BlcnR5fSBwcm9wZXJ0eSBkZXNjcmlwdG9yIGluc3RhbmNlCiovCkVtYmVyLmNvbXB1dGVkID0gZnVuY3Rpb24oZnVuYykgewogIHZhciBhcmdzOwoKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDEpIHsKICAgIGFyZ3MgPSBhX3NsaWNlLmNhbGwoYXJndW1lbnRzLCAwLCAtMSk7CiAgICBmdW5jID0gYV9zbGljZS5jYWxsKGFyZ3VtZW50cywgLTEpWzBdOwogIH0KCiAgaWYgKHR5cGVvZiBmdW5jICE9PSAiZnVuY3Rpb24iKSB7CiAgICB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoIkNvbXB1dGVkIFByb3BlcnR5IGRlY2xhcmVkIHdpdGhvdXQgYSBwcm9wZXJ0eSBmdW5jdGlvbiIpOwogIH0KCiAgdmFyIGNwID0gbmV3IENvbXB1dGVkUHJvcGVydHkoZnVuYyk7CgogIGlmIChhcmdzKSB7CiAgICBjcC5wcm9wZXJ0eS5hcHBseShjcCwgYXJncyk7CiAgfQoKICByZXR1cm4gY3A7Cn07CgovKioKICBSZXR1cm5zIHRoZSBjYWNoZWQgdmFsdWUgZm9yIGEgcHJvcGVydHksIGlmIG9uZSBleGlzdHMuCiAgVGhpcyBjYW4gYmUgdXNlZnVsIGZvciBwZWVraW5nIGF0IHRoZSB2YWx1ZSBvZiBhIGNvbXB1dGVkCiAgcHJvcGVydHkgdGhhdCBpcyBnZW5lcmF0ZWQgbGF6aWx5LCB3aXRob3V0IGFjY2lkZW50YWxseSBjYXVzaW5nCiAgaXQgdG8gYmUgY3JlYXRlZC4KCiAgQG1ldGhvZCBjYWNoZUZvcgogIEBmb3IgRW1iZXIKICBAcGFyYW0ge09iamVjdH0gb2JqIHRoZSBvYmplY3Qgd2hvc2UgcHJvcGVydHkgeW91IHdhbnQgdG8gY2hlY2sKICBAcGFyYW0ge1N0cmluZ30ga2V5IHRoZSBuYW1lIG9mIHRoZSBwcm9wZXJ0eSB3aG9zZSBjYWNoZWQgdmFsdWUgeW91IHdhbnQKICAgIHRvIHJldHVybgogIEByZXR1cm4ge09iamVjdH0gdGhlIGNhY2hlZCB2YWx1ZQoqLwpFbWJlci5jYWNoZUZvciA9IGZ1bmN0aW9uIGNhY2hlRm9yKG9iaiwga2V5KSB7CiAgdmFyIGNhY2hlID0gbWV0YUZvcihvYmosIGZhbHNlKS5jYWNoZTsKCiAgaWYgKGNhY2hlICYmIGtleSBpbiBjYWNoZSkgewogICAgcmV0dXJuIGNhY2hlW2tleV07CiAgfQp9OwoKZnVuY3Rpb24gZ2V0UHJvcGVydGllcyhzZWxmLCBwcm9wZXJ0eU5hbWVzKSB7CiAgdmFyIHJldCA9IHt9OwogIGZvcih2YXIgaSA9IDA7IGkgPCBwcm9wZXJ0eU5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICByZXRbcHJvcGVydHlOYW1lc1tpXV0gPSBnZXQoc2VsZiwgcHJvcGVydHlOYW1lc1tpXSk7CiAgfQogIHJldHVybiByZXQ7Cn0KCmZ1bmN0aW9uIHJlZ2lzdGVyQ29tcHV0ZWQobmFtZSwgbWFjcm8pIHsKICBFbWJlci5jb21wdXRlZFtuYW1lXSA9IGZ1bmN0aW9uKGRlcGVuZGVudEtleSkgewogICAgdmFyIGFyZ3MgPSBhX3NsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgIHJldHVybiBFbWJlci5jb21wdXRlZChkZXBlbmRlbnRLZXksIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbWFjcm8uYXBwbHkodGhpcywgYXJncyk7CiAgICB9KTsKICB9Owp9CgpmdW5jdGlvbiByZWdpc3RlckNvbXB1dGVkV2l0aFByb3BlcnRpZXMobmFtZSwgbWFjcm8pIHsKICBFbWJlci5jb21wdXRlZFtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHByb3BlcnRpZXMgPSBhX3NsaWNlLmNhbGwoYXJndW1lbnRzKTsKCiAgICB2YXIgY29tcHV0ZWQgPSBFbWJlci5jb21wdXRlZChmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG1hY3JvLmFwcGx5KHRoaXMsIFtnZXRQcm9wZXJ0aWVzKHRoaXMsIHByb3BlcnRpZXMpXSk7CiAgICB9KTsKCiAgICByZXR1cm4gY29tcHV0ZWQucHJvcGVydHkuYXBwbHkoY29tcHV0ZWQsIHByb3BlcnRpZXMpOwogIH07Cn0KCi8qKgogIEEgY29tcHV0ZWQgcHJvcGVydHkgdGhhdCByZXR1cm5zIHRydWUgaWYgdGhlIHZhbHVlIG9mIHRoZSBkZXBlbmRlbnQKICBwcm9wZXJ0eSBpcyBudWxsLCBhbiBlbXB0eSBzdHJpbmcsIGVtcHR5IGFycmF5LCBvciBlbXB0eSBmdW5jdGlvbi4KCiAgTm90ZTogV2hlbiB1c2luZyBgRW1iZXIuY29tcHV0ZWQuZW1wdHlgIHRvIHdhdGNoIGFuIGFycmF5IG1ha2Ugc3VyZSB0bwogIHVzZSB0aGUgYGFycmF5LltdYCBzeW50YXggc28gdGhlIGNvbXB1dGVkIGNhbiBzdWJzY3JpYmUgdG8gdHJhbnNpdGlvbnMKICBmcm9tIGVtcHR5IHRvIG5vbi1lbXB0eSBzdGF0ZXMuCgogIEV4YW1wbGUKCiAgYGBgamF2YXNjcmlwdAogIHZhciBUb0RvTGlzdCA9IEVtYmVyLk9iamVjdC5leHRlbmQoewogICAgZG9uZTogRW1iZXIuY29tcHV0ZWQuZW1wdHkoJ3RvZG9zLltdJykgLy8gZGV0ZWN0IGFycmF5IGNoYW5nZXMKICB9KTsKICB2YXIgdG9kb0xpc3QgPSBUb0RvTGlzdC5jcmVhdGUoe3RvZG9zOiBbJ1VuaXQgVGVzdCcsICdEb2N1bWVudGF0aW9uJywgJ1JlbGVhc2UnXX0pOwogIHRvZG9MaXN0LmdldCgnZG9uZScpOyAvLyBmYWxzZQogIHRvZG9MaXN0LmdldCgndG9kb3MnKS5jbGVhcigpOyAvLyBbXQogIHRvZG9MaXN0LmdldCgnZG9uZScpOyAvLyB0cnVlCiAgYGBgCgogIEBtZXRob2QgY29tcHV0ZWQuZW1wdHkKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogIEByZXR1cm4ge0VtYmVyLkNvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIG5lZ2F0ZQogIHRoZSBvcmlnaW5hbCB2YWx1ZSBmb3IgcHJvcGVydHkKKi8KcmVnaXN0ZXJDb21wdXRlZCgnZW1wdHknLCBmdW5jdGlvbihkZXBlbmRlbnRLZXkpIHsKICByZXR1cm4gRW1iZXIuaXNFbXB0eShnZXQodGhpcywgZGVwZW5kZW50S2V5KSk7Cn0pOwoKLyoqCiAgQSBjb21wdXRlZCBwcm9wZXJ0eSB0aGF0IHJldHVybnMgdHJ1ZSBpZiB0aGUgdmFsdWUgb2YgdGhlIGRlcGVuZGVudAogIHByb3BlcnR5IGlzIE5PVCBudWxsLCBhbiBlbXB0eSBzdHJpbmcsIGVtcHR5IGFycmF5LCBvciBlbXB0eSBmdW5jdGlvbi4KCiAgTm90ZTogV2hlbiB1c2luZyBgRW1iZXIuY29tcHV0ZWQubm90RW1wdHlgIHRvIHdhdGNoIGFuIGFycmF5IG1ha2Ugc3VyZSB0bwogIHVzZSB0aGUgYGFycmF5LltdYCBzeW50YXggc28gdGhlIGNvbXB1dGVkIGNhbiBzdWJzY3JpYmUgdG8gdHJhbnNpdGlvbnMKICBmcm9tIGVtcHR5IHRvIG5vbi1lbXB0eSBzdGF0ZXMuCgogIEV4YW1wbGUKCiAgYGBgamF2YXNjcmlwdAogIHZhciBIYW1zdGVyID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CiAgICBoYXNTdHVmZjogRW1iZXIuY29tcHV0ZWQubm90RW1wdHkoJ2JhY2twYWNrLltdJykKICB9KTsKICB2YXIgaGFtc3RlciA9IEhhbXN0ZXIuY3JlYXRlKHtiYWNrcGFjazogWydGb29kJywgJ1NsZWVwaW5nIEJhZycsICdUZW50J119KTsKICBoYW1zdGVyLmdldCgnaGFzU3R1ZmYnKTsgLy8gdHJ1ZQogIGhhbXN0ZXIuZ2V0KCdiYWNrcGFjaycpLmNsZWFyKCk7IC8vIFtdCiAgaGFtc3Rlci5nZXQoJ2hhc1N0dWZmJyk7IC8vIGZhbHNlCiAgYGBgCgogIEBtZXRob2QgY29tcHV0ZWQubm90RW1wdHkKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogIEByZXR1cm4ge0VtYmVyLkNvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIHJldHVybnMgdHJ1ZSBpZgogIG9yaWdpbmFsIHZhbHVlIGZvciBwcm9wZXJ0eSBpcyBub3QgZW1wdHkuCiovCnJlZ2lzdGVyQ29tcHV0ZWQoJ25vdEVtcHR5JywgZnVuY3Rpb24oZGVwZW5kZW50S2V5KSB7CiAgcmV0dXJuICFFbWJlci5pc0VtcHR5KGdldCh0aGlzLCBkZXBlbmRlbnRLZXkpKTsKfSk7CgovKioKICBBIGNvbXB1dGVkIHByb3BlcnR5IHRoYXQgcmV0dXJucyB0cnVlIGlmIHRoZSB2YWx1ZSBvZiB0aGUgZGVwZW5kZW50CiAgcHJvcGVydHkgaXMgbnVsbCBvciB1bmRlZmluZWQuIFRoaXMgYXZvaWRzIGVycm9ycyBmcm9tIEpTTGludCBjb21wbGFpbmluZwogIGFib3V0IHVzZSBvZiA9PSwgd2hpY2ggY2FuIGJlIHRlY2huaWNhbGx5IGNvbmZ1c2luZy4KCiAgRXhhbXBsZQoKICBgYGBqYXZhc2NyaXB0CiAgdmFyIEhhbXN0ZXIgPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICAgIGlzSHVuZ3J5OiBFbWJlci5jb21wdXRlZC5ub25lKCdmb29kJykKICB9KTsKICB2YXIgaGFtc3RlciA9IEhhbXN0ZXIuY3JlYXRlKCk7CiAgaGFtc3Rlci5nZXQoJ2lzSHVuZ3J5Jyk7IC8vIHRydWUKICBoYW1zdGVyLnNldCgnZm9vZCcsICdCYW5hbmEnKTsKICBoYW1zdGVyLmdldCgnaXNIdW5ncnknKTsgLy8gZmFsc2UKICBoYW1zdGVyLnNldCgnZm9vZCcsIG51bGwpOwogIGhhbXN0ZXIuZ2V0KCdpc0h1bmdyeScpOyAvLyB0cnVlCiAgYGBgCgogIEBtZXRob2QgY29tcHV0ZWQubm9uZQogIEBmb3IgRW1iZXIKICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5CiAgQHJldHVybiB7RW1iZXIuQ29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZWQgcHJvcGVydHkgd2hpY2gKICByZXR1cm5zIHRydWUgaWYgb3JpZ2luYWwgdmFsdWUgZm9yIHByb3BlcnR5IGlzIG51bGwgb3IgdW5kZWZpbmVkLgoqLwpyZWdpc3RlckNvbXB1dGVkKCdub25lJywgZnVuY3Rpb24oZGVwZW5kZW50S2V5KSB7CiAgcmV0dXJuIEVtYmVyLmlzTm9uZShnZXQodGhpcywgZGVwZW5kZW50S2V5KSk7Cn0pOwoKLyoqCiAgQSBjb21wdXRlZCBwcm9wZXJ0eSB0aGF0IHJldHVybnMgdGhlIGludmVyc2UgYm9vbGVhbiB2YWx1ZQogIG9mIHRoZSBvcmlnaW5hbCB2YWx1ZSBmb3IgdGhlIGRlcGVuZGVudCBwcm9wZXJ0eS4KCiAgRXhhbXBsZQoKICBgYGBqYXZhc2NyaXB0CiAgdmFyIFVzZXIgPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICAgIGlzQW5vbnltb3VzOiBFbWJlci5jb21wdXRlZC5ub3QoJ2xvZ2dlZEluJykKICB9KTsKICB2YXIgdXNlciA9IFVzZXIuY3JlYXRlKHtsb2dnZWRJbjogZmFsc2V9KTsKICB1c2VyLmdldCgnaXNBbm9ueW1vdXMnKTsgLy8gdHJ1ZQogIHVzZXIuc2V0KCdsb2dnZWRJbicsIHRydWUpOwogIHVzZXIuZ2V0KCdpc0Fub255bW91cycpOyAvLyBmYWxzZQogIGBgYAoKICBAbWV0aG9kIGNvbXB1dGVkLm5vdAogIEBmb3IgRW1iZXIKICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5CiAgQHJldHVybiB7RW1iZXIuQ29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggcmV0dXJucwogIGludmVyc2Ugb2YgdGhlIG9yaWdpbmFsIHZhbHVlIGZvciBwcm9wZXJ0eQoqLwpyZWdpc3RlckNvbXB1dGVkKCdub3QnLCBmdW5jdGlvbihkZXBlbmRlbnRLZXkpIHsKICByZXR1cm4gIWdldCh0aGlzLCBkZXBlbmRlbnRLZXkpOwp9KTsKCi8qKgogIEEgY29tcHV0ZWQgcHJvcGVydHkgdGhhdCBjb252ZXJ0cyB0aGUgcHJvdmlkZWQgZGVwZW5kZW50IHByb3BlcnR5CiAgaW50byBhIGJvb2xlYW4gdmFsdWUuCgogIGBgYGphdmFzY3JpcHQKICB2YXIgSGFtc3RlciA9IEVtYmVyLk9iamVjdC5leHRlbmQoewogICAgaGFzQmFuYW5hczogRW1iZXIuY29tcHV0ZWQuYm9vbCgnbnVtQmFuYW5hcycpCiAgfSk7CiAgdmFyIGhhbXN0ZXIgPSBIYW1zdGVyLmNyZWF0ZSgpOwogIGhhbXN0ZXIuZ2V0KCdoYXNCYW5hbmFzJyk7IC8vIGZhbHNlCiAgaGFtc3Rlci5zZXQoJ251bUJhbmFuYXMnLCAwKTsKICBoYW1zdGVyLmdldCgnaGFzQmFuYW5hcycpOyAvLyBmYWxzZQogIGhhbXN0ZXIuc2V0KCdudW1CYW5hbmFzJywgMSk7CiAgaGFtc3Rlci5nZXQoJ2hhc0JhbmFuYXMnKTsgLy8gdHJ1ZQogIGhhbXN0ZXIuc2V0KCdudW1CYW5hbmFzJywgbnVsbCk7CiAgaGFtc3Rlci5nZXQoJ2hhc0JhbmFuYXMnKTsgLy8gZmFsc2UKICBgYGAKCiAgQG1ldGhvZCBjb21wdXRlZC5ib29sCiAgQGZvciBFbWJlcgogIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkKICBAcmV0dXJuIHtFbWJlci5Db21wdXRlZFByb3BlcnR5fSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCBjb252ZXJ0cwogIHRvIGJvb2xlYW4gdGhlIG9yaWdpbmFsIHZhbHVlIGZvciBwcm9wZXJ0eQoqLwpyZWdpc3RlckNvbXB1dGVkKCdib29sJywgZnVuY3Rpb24oZGVwZW5kZW50S2V5KSB7CiAgcmV0dXJuICEhZ2V0KHRoaXMsIGRlcGVuZGVudEtleSk7Cn0pOwoKLyoqCiAgQSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCBtYXRjaGVzIHRoZSBvcmlnaW5hbCB2YWx1ZSBmb3IgdGhlCiAgZGVwZW5kZW50IHByb3BlcnR5IGFnYWluc3QgYSBnaXZlbiBSZWdFeHAsIHJldHVybmluZyBgdHJ1ZWAKICBpZiB0aGV5IHZhbHVlcyBtYXRjaGVzIHRoZSBSZWdFeHAgYW5kIGBmYWxzZWAgaWYgaXQgZG9lcyBub3QuCgogIEV4YW1wbGUKCiAgYGBgamF2YXNjcmlwdAogIHZhciBVc2VyID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CiAgICBoYXNWYWxpZEVtYWlsOiBFbWJlci5jb21wdXRlZC5tYXRjaCgnZW1haWwnLCAvXi4rQC4rXC4uKyQvKQogIH0pOwogIHZhciB1c2VyID0gVXNlci5jcmVhdGUoe2xvZ2dlZEluOiBmYWxzZX0pOwogIHVzZXIuZ2V0KCdoYXNWYWxpZEVtYWlsJyk7IC8vIGZhbHNlCiAgdXNlci5zZXQoJ2VtYWlsJywgJycpOwogIHVzZXIuZ2V0KCdoYXNWYWxpZEVtYWlsJyk7IC8vIGZhbHNlCiAgdXNlci5zZXQoJ2VtYWlsJywgJ2VtYmVyX2hhbXN0ZXJAZXhhbXBsZS5jb20nKTsKICB1c2VyLmdldCgnaGFzVmFsaWRFbWFpbCcpOyAvLyB0cnVlCiAgYGBgCgogIEBtZXRob2QgY29tcHV0ZWQubWF0Y2gKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogIEBwYXJhbSB7UmVnRXhwfSByZWdleHAKICBAcmV0dXJuIHtFbWJlci5Db21wdXRlZFByb3BlcnR5fSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCBtYXRjaAogIHRoZSBvcmlnaW5hbCB2YWx1ZSBmb3IgcHJvcGVydHkgYWdhaW5zdCBhIGdpdmVuIFJlZ0V4cAoqLwpyZWdpc3RlckNvbXB1dGVkKCdtYXRjaCcsIGZ1bmN0aW9uKGRlcGVuZGVudEtleSwgcmVnZXhwKSB7CiAgdmFyIHZhbHVlID0gZ2V0KHRoaXMsIGRlcGVuZGVudEtleSk7CiAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgPyByZWdleHAudGVzdCh2YWx1ZSkgOiBmYWxzZTsKfSk7CgovKioKICBBIGNvbXB1dGVkIHByb3BlcnR5IHRoYXQgcmV0dXJucyB0cnVlIGlmIHRoZSBwcm92aWRlZCBkZXBlbmRlbnQgcHJvcGVydHkKICBpcyBlcXVhbCB0byB0aGUgZ2l2ZW4gdmFsdWUuCgogIEV4YW1wbGUKCiAgYGBgamF2YXNjcmlwdAogIHZhciBIYW1zdGVyID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CiAgICBuYXBUaW1lOiBFbWJlci5jb21wdXRlZC5lcXVhbCgnc3RhdGUnLCAnc2xlZXB5JykKICB9KTsKICB2YXIgaGFtc3RlciA9IEhhbXN0ZXIuY3JlYXRlKCk7CiAgaGFtc3Rlci5nZXQoJ25hcFRpbWUnKTsgLy8gZmFsc2UKICBoYW1zdGVyLnNldCgnc3RhdGUnLCAnc2xlZXB5Jyk7CiAgaGFtc3Rlci5nZXQoJ25hcFRpbWUnKTsgLy8gdHJ1ZQogIGhhbXN0ZXIuc2V0KCdzdGF0ZScsICdodW5ncnknKTsKICBoYW1zdGVyLmdldCgnbmFwVGltZScpOyAvLyBmYWxzZQogIGBgYAoKICBAbWV0aG9kIGNvbXB1dGVkLmVxdWFsCiAgQGZvciBFbWJlcgogIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkKICBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ8T2JqZWN0fSB2YWx1ZQogIEByZXR1cm4ge0VtYmVyLkNvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIHJldHVybnMgdHJ1ZSBpZgogIHRoZSBvcmlnaW5hbCB2YWx1ZSBmb3IgcHJvcGVydHkgaXMgZXF1YWwgdG8gdGhlIGdpdmVuIHZhbHVlLgoqLwpyZWdpc3RlckNvbXB1dGVkKCdlcXVhbCcsIGZ1bmN0aW9uKGRlcGVuZGVudEtleSwgdmFsdWUpIHsKICByZXR1cm4gZ2V0KHRoaXMsIGRlcGVuZGVudEtleSkgPT09IHZhbHVlOwp9KTsKCi8qKgogIEEgY29tcHV0ZWQgcHJvcGVydHkgdGhhdCByZXR1cm5zIHRydWUgaWYgdGhlIHByb3ZpZWQgZGVwZW5kZW50IHByb3BlcnR5CiAgaXMgZ3JlYXRlciB0aGFuIHRoZSBwcm92aWRlZCB2YWx1ZS4KCiAgRXhhbXBsZQoKICBgYGBqYXZhc2NyaXB0CiAgdmFyIEhhbXN0ZXIgPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICAgIGhhc1Rvb01hbnlCYW5hbmFzOiBFbWJlci5jb21wdXRlZC5ndCgnbnVtQmFuYW5hcycsIDEwKQogIH0pOwogIHZhciBoYW1zdGVyID0gSGFtc3Rlci5jcmVhdGUoKTsKICBoYW1zdGVyLmdldCgnaGFzVG9vTWFueUJhbmFuYXMnKTsgLy8gZmFsc2UKICBoYW1zdGVyLnNldCgnbnVtQmFuYW5hcycsIDMpOwogIGhhbXN0ZXIuZ2V0KCdoYXNUb29NYW55QmFuYW5hcycpOyAvLyBmYWxzZQogIGhhbXN0ZXIuc2V0KCdudW1CYW5hbmFzJywgMTEpOwogIGhhbXN0ZXIuZ2V0KCdoYXNUb29NYW55QmFuYW5hcycpOyAvLyB0cnVlCiAgYGBgCgogIEBtZXRob2QgY29tcHV0ZWQuZ3QKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogIEBwYXJhbSB7TnVtYmVyfSB2YWx1ZQogIEByZXR1cm4ge0VtYmVyLkNvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIHJldHVybnMgdHJ1ZSBpZgogIHRoZSBvcmlnaW5hbCB2YWx1ZSBmb3IgcHJvcGVydHkgaXMgZ3JlYXRlciB0aGVuIGdpdmVuIHZhbHVlLgoqLwpyZWdpc3RlckNvbXB1dGVkKCdndCcsIGZ1bmN0aW9uKGRlcGVuZGVudEtleSwgdmFsdWUpIHsKICByZXR1cm4gZ2V0KHRoaXMsIGRlcGVuZGVudEtleSkgPiB2YWx1ZTsKfSk7CgovKioKICBBIGNvbXB1dGVkIHByb3BlcnR5IHRoYXQgcmV0dXJucyB0cnVlIGlmIHRoZSBwcm92aWRlZCBkZXBlbmRlbnQgcHJvcGVydHkKICBpcyBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8gdGhlIHByb3ZpZGVkIHZhbHVlLgoKICBFeGFtcGxlCgogIGBgYGphdmFzY3JpcHQKICB2YXIgSGFtc3RlciA9IEVtYmVyLk9iamVjdC5leHRlbmQoewogICAgaGFzVG9vTWFueUJhbmFuYXM6IEVtYmVyLmNvbXB1dGVkLmd0ZSgnbnVtQmFuYW5hcycsIDEwKQogIH0pOwogIHZhciBoYW1zdGVyID0gSGFtc3Rlci5jcmVhdGUoKTsKICBoYW1zdGVyLmdldCgnaGFzVG9vTWFueUJhbmFuYXMnKTsgLy8gZmFsc2UKICBoYW1zdGVyLnNldCgnbnVtQmFuYW5hcycsIDMpOwogIGhhbXN0ZXIuZ2V0KCdoYXNUb29NYW55QmFuYW5hcycpOyAvLyBmYWxzZQogIGhhbXN0ZXIuc2V0KCdudW1CYW5hbmFzJywgMTApOwogIGhhbXN0ZXIuZ2V0KCdoYXNUb29NYW55QmFuYW5hcycpOyAvLyB0cnVlCiAgYGBgCgogIEBtZXRob2QgY29tcHV0ZWQuZ3RlCiAgQGZvciBFbWJlcgogIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkKICBAcGFyYW0ge051bWJlcn0gdmFsdWUKICBAcmV0dXJuIHtFbWJlci5Db21wdXRlZFByb3BlcnR5fSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCByZXR1cm5zIHRydWUgaWYKICB0aGUgb3JpZ2luYWwgdmFsdWUgZm9yIHByb3BlcnR5IGlzIGdyZWF0ZXIgb3IgZXF1YWwgdGhlbiBnaXZlbiB2YWx1ZS4KKi8KcmVnaXN0ZXJDb21wdXRlZCgnZ3RlJywgZnVuY3Rpb24oZGVwZW5kZW50S2V5LCB2YWx1ZSkgewogIHJldHVybiBnZXQodGhpcywgZGVwZW5kZW50S2V5KSA+PSB2YWx1ZTsKfSk7CgovKioKICBBIGNvbXB1dGVkIHByb3BlcnR5IHRoYXQgcmV0dXJucyB0cnVlIGlmIHRoZSBwcm92aWRlZCBkZXBlbmRlbnQgcHJvcGVydHkKICBpcyBsZXNzIHRoYW4gdGhlIHByb3ZpZGVkIHZhbHVlLgoKICBFeGFtcGxlCgogIGBgYGphdmFzY3JpcHQKICB2YXIgSGFtc3RlciA9IEVtYmVyLk9iamVjdC5leHRlbmQoewogICAgbmVlZHNNb3JlQmFuYW5hczogRW1iZXIuY29tcHV0ZWQubHQoJ251bUJhbmFuYXMnLCAzKQogIH0pOwogIHZhciBoYW1zdGVyID0gSGFtc3Rlci5jcmVhdGUoKTsKICBoYW1zdGVyLmdldCgnbmVlZHNNb3JlQmFuYW5hcycpOyAvLyB0cnVlCiAgaGFtc3Rlci5zZXQoJ251bUJhbmFuYXMnLCAzKTsKICBoYW1zdGVyLmdldCgnbmVlZHNNb3JlQmFuYW5hcycpOyAvLyBmYWxzZQogIGhhbXN0ZXIuc2V0KCdudW1CYW5hbmFzJywgMik7CiAgaGFtc3Rlci5nZXQoJ25lZWRzTW9yZUJhbmFuYXMnKTsgLy8gdHJ1ZQogIGBgYAoKICBAbWV0aG9kIGNvbXB1dGVkLmx0CiAgQGZvciBFbWJlcgogIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkKICBAcGFyYW0ge051bWJlcn0gdmFsdWUKICBAcmV0dXJuIHtFbWJlci5Db21wdXRlZFByb3BlcnR5fSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCByZXR1cm5zIHRydWUgaWYKICB0aGUgb3JpZ2luYWwgdmFsdWUgZm9yIHByb3BlcnR5IGlzIGxlc3MgdGhlbiBnaXZlbiB2YWx1ZS4KKi8KcmVnaXN0ZXJDb21wdXRlZCgnbHQnLCBmdW5jdGlvbihkZXBlbmRlbnRLZXksIHZhbHVlKSB7CiAgcmV0dXJuIGdldCh0aGlzLCBkZXBlbmRlbnRLZXkpIDwgdmFsdWU7Cn0pOwoKLyoqCiAgQSBjb21wdXRlZCBwcm9wZXJ0eSB0aGF0IHJldHVybnMgdHJ1ZSBpZiB0aGUgcHJvdmlkZWQgZGVwZW5kZW50IHByb3BlcnR5CiAgaXMgbGVzcyB0aGFuIG9yIGVxdWFsIHRvIHRoZSBwcm92aWRlZCB2YWx1ZS4KCiAgRXhhbXBsZQoKICBgYGBqYXZhc2NyaXB0CiAgdmFyIEhhbXN0ZXIgPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICAgIG5lZWRzTW9yZUJhbmFuYXM6IEVtYmVyLmNvbXB1dGVkLmx0ZSgnbnVtQmFuYW5hcycsIDMpCiAgfSk7CiAgdmFyIGhhbXN0ZXIgPSBIYW1zdGVyLmNyZWF0ZSgpOwogIGhhbXN0ZXIuZ2V0KCduZWVkc01vcmVCYW5hbmFzJyk7IC8vIHRydWUKICBoYW1zdGVyLnNldCgnbnVtQmFuYW5hcycsIDUpOwogIGhhbXN0ZXIuZ2V0KCduZWVkc01vcmVCYW5hbmFzJyk7IC8vIGZhbHNlCiAgaGFtc3Rlci5zZXQoJ251bUJhbmFuYXMnLCAzKTsKICBoYW1zdGVyLmdldCgnbmVlZHNNb3JlQmFuYW5hcycpOyAvLyB0cnVlCiAgYGBgCgogIEBtZXRob2QgY29tcHV0ZWQubHRlCiAgQGZvciBFbWJlcgogIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkKICBAcGFyYW0ge051bWJlcn0gdmFsdWUKICBAcmV0dXJuIHtFbWJlci5Db21wdXRlZFByb3BlcnR5fSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCByZXR1cm5zIHRydWUgaWYKICB0aGUgb3JpZ2luYWwgdmFsdWUgZm9yIHByb3BlcnR5IGlzIGxlc3Mgb3IgZXF1YWwgdGhlbiBnaXZlbiB2YWx1ZS4KKi8KcmVnaXN0ZXJDb21wdXRlZCgnbHRlJywgZnVuY3Rpb24oZGVwZW5kZW50S2V5LCB2YWx1ZSkgewogIHJldHVybiBnZXQodGhpcywgZGVwZW5kZW50S2V5KSA8PSB2YWx1ZTsKfSk7CgovKioKICBBIGNvbXB1dGVkIHByb3BlcnR5IHRoYXQgcGVyZm9ybXMgYSBsb2dpY2FsIGBhbmRgIG9uIHRoZQogIG9yaWdpbmFsIHZhbHVlcyBmb3IgdGhlIHByb3ZpZGVkIGRlcGVuZGVudCBwcm9wZXJ0aWVzLgoKICBFeGFtcGxlCgogIGBgYGphdmFzY3JpcHQKICB2YXIgSGFtc3RlciA9IEVtYmVyLk9iamVjdC5leHRlbmQoewogICAgcmVhZHlGb3JDYW1wOiBFbWJlci5jb21wdXRlZC5hbmQoJ2hhc1RlbnQnLCAnaGFzQmFja3BhY2snKQogIH0pOwogIHZhciBoYW1zdGVyID0gSGFtc3Rlci5jcmVhdGUoKTsKICBoYW1zdGVyLmdldCgncmVhZHlGb3JDYW1wJyk7IC8vIGZhbHNlCiAgaGFtc3Rlci5zZXQoJ2hhc1RlbnQnLCB0cnVlKTsKICBoYW1zdGVyLmdldCgncmVhZHlGb3JDYW1wJyk7IC8vIGZhbHNlCiAgaGFtc3Rlci5zZXQoJ2hhc0JhY2twYWNrJywgdHJ1ZSk7CiAgaGFtc3Rlci5nZXQoJ3JlYWR5Rm9yQ2FtcCcpOyAvLyB0cnVlCiAgYGBgCgogIEBtZXRob2QgY29tcHV0ZWQuYW5kCiAgQGZvciBFbWJlcgogIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkqCiAgQHJldHVybiB7RW1iZXIuQ29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggcGVyZm9ybXMKICBhIGxvZ2ljYWwgYGFuZGAgb24gdGhlIHZhbHVlcyBvZiBhbGwgdGhlIG9yaWdpbmFsIHZhbHVlcyBmb3IgcHJvcGVydGllcy4KKi8KcmVnaXN0ZXJDb21wdXRlZFdpdGhQcm9wZXJ0aWVzKCdhbmQnLCBmdW5jdGlvbihwcm9wZXJ0aWVzKSB7CiAgZm9yICh2YXIga2V5IGluIHByb3BlcnRpZXMpIHsKICAgIGlmIChwcm9wZXJ0aWVzLmhhc093blByb3BlcnR5KGtleSkgJiYgIXByb3BlcnRpZXNba2V5XSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQogIHJldHVybiB0cnVlOwp9KTsKCi8qKgogIEEgY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggcGVyZm9ybXMgYSBsb2dpY2FsIGBvcmAgb24gdGhlCiAgb3JpZ2luYWwgdmFsdWVzIGZvciB0aGUgcHJvdmlkZWQgZGVwZW5kZW50IHByb3BlcnRpZXMuCgogIEV4YW1wbGUKCiAgYGBgamF2YXNjcmlwdAogIHZhciBIYW1zdGVyID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CiAgICByZWFkeUZvclJhaW46IEVtYmVyLmNvbXB1dGVkLm9yKCdoYXNKYWNrZXQnLCAnaGFzVW1icmVsbGEnKQogIH0pOwogIHZhciBoYW1zdGVyID0gSGFtc3Rlci5jcmVhdGUoKTsKICBoYW1zdGVyLmdldCgncmVhZHlGb3JSYWluJyk7IC8vIGZhbHNlCiAgaGFtc3Rlci5zZXQoJ2hhc0phY2tldCcsIHRydWUpOwogIGhhbXN0ZXIuZ2V0KCdyZWFkeUZvclJhaW4nKTsgLy8gdHJ1ZQogIGBgYAoKICBAbWV0aG9kIGNvbXB1dGVkLm9yCiAgQGZvciBFbWJlcgogIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkqCiAgQHJldHVybiB7RW1iZXIuQ29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggcGVyZm9ybXMKICBhIGxvZ2ljYWwgYG9yYCBvbiB0aGUgdmFsdWVzIG9mIGFsbCB0aGUgb3JpZ2luYWwgdmFsdWVzIGZvciBwcm9wZXJ0aWVzLgoqLwpyZWdpc3RlckNvbXB1dGVkV2l0aFByb3BlcnRpZXMoJ29yJywgZnVuY3Rpb24ocHJvcGVydGllcykgewogIGZvciAodmFyIGtleSBpbiBwcm9wZXJ0aWVzKSB7CiAgICBpZiAocHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIHByb3BlcnRpZXNba2V5XSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9CiAgcmV0dXJuIGZhbHNlOwp9KTsKCi8qKgogIEEgY29tcHV0ZWQgcHJvcGVydHkgdGhhdCByZXR1cm5zIHRoZSBmaXJzdCB0cnV0aHkgdmFsdWUKICBmcm9tIGEgbGlzdCBvZiBkZXBlbmRlbnQgcHJvcGVydGllcy4KCiAgRXhhbXBsZQoKICBgYGBqYXZhc2NyaXB0CiAgdmFyIEhhbXN0ZXIgPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICAgIGhhc0Nsb3RoZXM6IEVtYmVyLmNvbXB1dGVkLmFueSgnaGF0JywgJ3NoaXJ0JykKICB9KTsKICB2YXIgaGFtc3RlciA9IEhhbXN0ZXIuY3JlYXRlKCk7CiAgaGFtc3Rlci5nZXQoJ2hhc0Nsb3RoZXMnKTsgLy8gbnVsbAogIGhhbXN0ZXIuc2V0KCdzaGlydCcsICdIYXdhaWlhbiBTaGlydCcpOwogIGhhbXN0ZXIuZ2V0KCdoYXNDbG90aGVzJyk7IC8vICdIYXdhaWlhbiBTaGlydCcKICBgYGAKCiAgQG1ldGhvZCBjb21wdXRlZC5hbnkKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleSoKICBAcmV0dXJuIHtFbWJlci5Db21wdXRlZFByb3BlcnR5fSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCByZXR1cm5zCiAgdGhlIGZpcnN0IHRydXRoeSB2YWx1ZSBvZiBnaXZlbiBsaXN0IG9mIHByb3BlcnRpZXMuCiovCnJlZ2lzdGVyQ29tcHV0ZWRXaXRoUHJvcGVydGllcygnYW55JywgZnVuY3Rpb24ocHJvcGVydGllcykgewogIGZvciAodmFyIGtleSBpbiBwcm9wZXJ0aWVzKSB7CiAgICBpZiAocHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIHByb3BlcnRpZXNba2V5XSkgewogICAgICByZXR1cm4gcHJvcGVydGllc1trZXldOwogICAgfQogIH0KICByZXR1cm4gbnVsbDsKfSk7CgovKioKICBBIGNvbXB1dGVkIHByb3BlcnR5IHRoYXQgcmV0dXJucyB0aGUgYXJyYXkgb2YgdmFsdWVzCiAgZm9yIHRoZSBwcm92aWRlZCBkZXBlbmRlbnQgcHJvcGVydGllcy4KCiAgRXhhbXBsZQoKICBgYGBqYXZhc2NyaXB0CiAgdmFyIEhhbXN0ZXIgPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICAgIGNsb3RoZXM6IEVtYmVyLmNvbXB1dGVkLmNvbGxlY3QoJ2hhdCcsICdzaGlydCcpCiAgfSk7CiAgdmFyIGhhbXN0ZXIgPSBIYW1zdGVyLmNyZWF0ZSgpOwogIGhhbXN0ZXIuZ2V0KCdjbG90aGVzJyk7IC8vIFtudWxsLCBudWxsXQogIGhhbXN0ZXIuc2V0KCdoYXQnLCAnQ2FtcCBIYXQnKTsKICBoYW1zdGVyLnNldCgnc2hpcnQnLCAnQ2FtcCBTaGlydCcpOwogIGhhbXN0ZXIuZ2V0KCdjbG90aGVzJyk7IC8vIFsnQ2FtcCBIYXQnLCAnQ2FtcCBTaGlydCddCiAgYGBgCgogIEBtZXRob2QgY29tcHV0ZWQuY29sbGVjdAogIEBmb3IgRW1iZXIKICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5KgogIEByZXR1cm4ge0VtYmVyLkNvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIG1hcHMKICB2YWx1ZXMgb2YgYWxsIHBhc3NlZCBwcm9wZXJ0aWVzIGluIHRvIGFuIGFycmF5LgoqLwpyZWdpc3RlckNvbXB1dGVkV2l0aFByb3BlcnRpZXMoJ2NvbGxlY3QnLCBmdW5jdGlvbihwcm9wZXJ0aWVzKSB7CiAgdmFyIHJlcyA9IFtdOwogIGZvciAodmFyIGtleSBpbiBwcm9wZXJ0aWVzKSB7CiAgICBpZiAocHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgIGlmIChFbWJlci5pc05vbmUocHJvcGVydGllc1trZXldKSkgewogICAgICAgIHJlcy5wdXNoKG51bGwpOwogICAgICB9IGVsc2UgewogICAgICAgIHJlcy5wdXNoKHByb3BlcnRpZXNba2V5XSk7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIHJlczsKfSk7CgovKioKICBDcmVhdGVzIGEgbmV3IHByb3BlcnR5IHRoYXQgaXMgYW4gYWxpYXMgZm9yIGFub3RoZXIgcHJvcGVydHkKICBvbiBhbiBvYmplY3QuIENhbGxzIHRvIGBnZXRgIG9yIGBzZXRgIHRoaXMgcHJvcGVydHkgYmVoYXZlIGFzCiAgdGhvdWdoIHRoZXkgd2VyZSBjYWxsZWQgb24gdGhlIG9yaWdpbmFsIHByb3BlcnR5LgoKICBgYGBqYXZhc2NyaXB0CiAgUGVyc29uID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CiAgICBuYW1lOiAnQWxleCBNYXRjaG5lZXInLAogICAgbm9tZW46IEVtYmVyLmNvbXB1dGVkLmFsaWFzKCduYW1lJykKICB9KTsKCiAgYWxleCA9IFBlcnNvbi5jcmVhdGUoKTsKICBhbGV4LmdldCgnbm9tZW4nKTsgLy8gJ0FsZXggTWF0Y2huZWVyJwogIGFsZXguZ2V0KCduYW1lJyk7ICAvLyAnQWxleCBNYXRjaG5lZXInCgogIGFsZXguc2V0KCdub21lbicsICdAbWFjaHR5Jyk7CiAgYWxleC5nZXQoJ25hbWUnKTsgIC8vICdAbWFjaHR5JwogIGBgYAogIEBtZXRob2QgY29tcHV0ZWQuYWxpYXMKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogIEByZXR1cm4ge0VtYmVyLkNvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIGNyZWF0ZXMgYW4KICBhbGlhcyB0byB0aGUgb3JpZ2luYWwgdmFsdWUgZm9yIHByb3BlcnR5LgoqLwpFbWJlci5jb21wdXRlZC5hbGlhcyA9IGZ1bmN0aW9uKGRlcGVuZGVudEtleSkgewogIHJldHVybiBFbWJlci5jb21wdXRlZChkZXBlbmRlbnRLZXksIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewogICAgICBzZXQodGhpcywgZGVwZW5kZW50S2V5LCB2YWx1ZSk7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBnZXQodGhpcywgZGVwZW5kZW50S2V5KTsKICAgIH0KICB9KTsKfTsKCi8qKgogIFdoZXJlIGBjb21wdXRlZC5hbGlhc2AgYWxpYXNlcyBgZ2V0YCBhbmQgYHNldGAsIGFuZCBhbGxvd3MgZm9yIGJpZGlyZWN0aW9uYWwKICBkYXRhIGZsb3csIGBjb21wdXRlZC5vbmVXYXlgIG9ubHkgcHJvdmlkZXMgYW4gYWxpYXNlZCBgZ2V0YC4gVGhlIGBzZXRgIHdpbGwKICBub3QgbXV0YXRlIHRoZSB1cHN0cmVhbSBwcm9wZXJ0eSwgcmF0aGVyIGNhdXNlcyB0aGUgY3VycmVudCBwcm9wZXJ0eSB0bwogIGJlY29tZSB0aGUgdmFsdWUgc2V0LiBUaGlzIGNhdXNlcyB0aGUgZG93bnN0cmVhbSBwcm9wZXJ0eSB0byBwZXJtZW50YW50bHkKICBkaXZlcmdlIGZyb20gdGhlIHVwc3RyZWFtIHByb3BlcnR5LgoKICBFeGFtcGxlCgogIGBgYGphdmFzY3JpcHQKICBVc2VyID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CiAgICBmaXJzdE5hbWU6IG51bGwsCiAgICBsYXN0TmFtZTogbnVsbCwKICAgIG5pY2tOYW1lOiBFbWJlci5jb21wdXRlZC5vbmVXYXkoJ2ZpcnN0TmFtZScpCiAgfSk7CgogIHVzZXIgPSBVc2VyLmNyZWF0ZSh7CiAgICBmaXJzdE5hbWU6ICdUZWRkeScsCiAgICBsYXN0TmFtZTogICdaZWVubnknCiAgfSk7CgogIHVzZXIuZ2V0KCduaWNrTmFtZScpOwogICMgJ1RlZGR5JwoKICB1c2VyLnNldCgnbmlja05hbWUnLCAnVGVkZHlCZWFyJyk7CiAgIyAnVGVkZHlCZWFyJwoKICB1c2VyLmdldCgnZmlyc3ROYW1lJyk7CiAgIyAnVGVkZHknCiAgYGBgCgogIEBtZXRob2QgY29tcHV0ZWQub25lV2F5CiAgQGZvciBFbWJlcgogIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkKICBAcmV0dXJuIHtFbWJlci5Db21wdXRlZFByb3BlcnR5fSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCBjcmVhdGVzIGEKICBvbmUgd2F5IGNvbXB1dGVkIHByb3BlcnR5IHRvIHRoZSBvcmlnaW5hbCB2YWx1ZSBmb3IgcHJvcGVydHkuCiovCkVtYmVyLmNvbXB1dGVkLm9uZVdheSA9IGZ1bmN0aW9uKGRlcGVuZGVudEtleSkgewogIHJldHVybiBFbWJlci5jb21wdXRlZChkZXBlbmRlbnRLZXksIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGdldCh0aGlzLCBkZXBlbmRlbnRLZXkpOwogIH0pOwp9OwoKCi8qKgogIEEgY29tcHV0ZWQgcHJvcGVydHkgdGhhdCBhY3RzIGxpa2UgYSBzdGFuZGFyZCBnZXR0ZXIgYW5kIHNldHRlciwKICBidXQgcmV0dXJucyB0aGUgdmFsdWUgYXQgdGhlIHByb3ZpZGVkIGBkZWZhdWx0UGF0aGAgaWYgdGhlCiAgcHJvcGVydHkgaXRzZWxmIGhhcyBub3QgYmVlbiBzZXQgdG8gYSB2YWx1ZQoKICBFeGFtcGxlCgogIGBgYGphdmFzY3JpcHQKICB2YXIgSGFtc3RlciA9IEVtYmVyLk9iamVjdC5leHRlbmQoewogICAgd2lzaExpc3Q6IEVtYmVyLmNvbXB1dGVkLmRlZmF1bHRUbygnZmF2b3JpdGVGb29kJykKICB9KTsKICB2YXIgaGFtc3RlciA9IEhhbXN0ZXIuY3JlYXRlKHtmYXZvcml0ZUZvb2Q6ICdCYW5hbmEnfSk7CiAgaGFtc3Rlci5nZXQoJ3dpc2hMaXN0Jyk7IC8vICdCYW5hbmEnCiAgaGFtc3Rlci5zZXQoJ3dpc2hMaXN0JywgJ01vcmUgVW5pdCBUZXN0cycpOwogIGhhbXN0ZXIuZ2V0KCd3aXNoTGlzdCcpOyAvLyAnTW9yZSBVbml0IFRlc3RzJwogIGhhbXN0ZXIuZ2V0KCdmYXZvcml0ZUZvb2QnKTsgLy8gJ0JhbmFuYScKICBgYGAKCiAgQG1ldGhvZCBjb21wdXRlZC5kZWZhdWx0VG8KICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtTdHJpbmd9IGRlZmF1bHRQYXRoCiAgQHJldHVybiB7RW1iZXIuQ29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggYWN0cyBsaWtlCiAgYSBzdGFuZGFyZCBnZXR0ZXIgYW5kIHNldHRlciwgYnV0IGRlZmF1bHRzIHRvIHRoZSB2YWx1ZSBmcm9tIGBkZWZhdWx0UGF0aGAuCiovCkVtYmVyLmNvbXB1dGVkLmRlZmF1bHRUbyA9IGZ1bmN0aW9uKGRlZmF1bHRQYXRoKSB7CiAgcmV0dXJuIEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uKGtleSwgbmV3VmFsdWUsIGNhY2hlZFZhbHVlKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgICByZXR1cm4gY2FjaGVkVmFsdWUgIT0gbnVsbCA/IGNhY2hlZFZhbHVlIDogZ2V0KHRoaXMsIGRlZmF1bHRQYXRoKTsKICAgIH0KICAgIHJldHVybiBuZXdWYWx1ZSAhPSBudWxsID8gbmV3VmFsdWUgOiBnZXQodGhpcywgZGVmYXVsdFBhdGgpOwogIH0pOwp9OwoKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLy8gRW1iZXIudHJ5RmluYWxseQovKioKQG1vZHVsZSBlbWJlci1tZXRhbAoqLwoKdmFyIEFGVEVSX09CU0VSVkVSUyA9ICc6Y2hhbmdlJywKICAgIEJFRk9SRV9PQlNFUlZFUlMgPSAnOmJlZm9yZSc7CgpmdW5jdGlvbiBjaGFuZ2VFdmVudChrZXlOYW1lKSB7CiAgcmV0dXJuIGtleU5hbWUrQUZURVJfT0JTRVJWRVJTOwp9CgpmdW5jdGlvbiBiZWZvcmVFdmVudChrZXlOYW1lKSB7CiAgcmV0dXJuIGtleU5hbWUrQkVGT1JFX09CU0VSVkVSUzsKfQoKLyoqCiAgQG1ldGhvZCBhZGRPYnNlcnZlcgogIEBwYXJhbSBvYmoKICBAcGFyYW0ge1N0cmluZ30gcGF0aAogIEBwYXJhbSB7T2JqZWN0fEZ1bmN0aW9ufSB0YXJnZXRPck1ldGhvZAogIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBbbWV0aG9kXQoqLwpFbWJlci5hZGRPYnNlcnZlciA9IGZ1bmN0aW9uKG9iaiwgX3BhdGgsIHRhcmdldCwgbWV0aG9kKSB7CiAgRW1iZXIuYWRkTGlzdGVuZXIob2JqLCBjaGFuZ2VFdmVudChfcGF0aCksIHRhcmdldCwgbWV0aG9kKTsKICBFbWJlci53YXRjaChvYmosIF9wYXRoKTsKCiAgcmV0dXJuIHRoaXM7Cn07CgpFbWJlci5vYnNlcnZlcnNGb3IgPSBmdW5jdGlvbihvYmosIHBhdGgpIHsKICByZXR1cm4gRW1iZXIubGlzdGVuZXJzRm9yKG9iaiwgY2hhbmdlRXZlbnQocGF0aCkpOwp9OwoKLyoqCiAgQG1ldGhvZCByZW1vdmVPYnNlcnZlcgogIEBwYXJhbSBvYmoKICBAcGFyYW0ge1N0cmluZ30gcGF0aAogIEBwYXJhbSB7T2JqZWN0fEZ1bmN0aW9ufSB0YXJnZXRPck1ldGhvZAogIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBbbWV0aG9kXQoqLwpFbWJlci5yZW1vdmVPYnNlcnZlciA9IGZ1bmN0aW9uKG9iaiwgX3BhdGgsIHRhcmdldCwgbWV0aG9kKSB7CiAgRW1iZXIudW53YXRjaChvYmosIF9wYXRoKTsKICBFbWJlci5yZW1vdmVMaXN0ZW5lcihvYmosIGNoYW5nZUV2ZW50KF9wYXRoKSwgdGFyZ2V0LCBtZXRob2QpOwoKICByZXR1cm4gdGhpczsKfTsKCi8qKgogIEBtZXRob2QgYWRkQmVmb3JlT2JzZXJ2ZXIKICBAcGFyYW0gb2JqCiAgQHBhcmFtIHtTdHJpbmd9IHBhdGgKICBAcGFyYW0ge09iamVjdHxGdW5jdGlvbn0gdGFyZ2V0T3JNZXRob2QKICBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gW21ldGhvZF0KKi8KRW1iZXIuYWRkQmVmb3JlT2JzZXJ2ZXIgPSBmdW5jdGlvbihvYmosIF9wYXRoLCB0YXJnZXQsIG1ldGhvZCkgewogIEVtYmVyLmFkZExpc3RlbmVyKG9iaiwgYmVmb3JlRXZlbnQoX3BhdGgpLCB0YXJnZXQsIG1ldGhvZCk7CiAgRW1iZXIud2F0Y2gob2JqLCBfcGF0aCk7CgogIHJldHVybiB0aGlzOwp9OwoKLy8gU3VzcGVuZCBvYnNlcnZlciBkdXJpbmcgY2FsbGJhY2suCi8vCi8vIFRoaXMgc2hvdWxkIG9ubHkgYmUgdXNlZCBieSB0aGUgdGFyZ2V0IG9mIHRoZSBvYnNlcnZlcgovLyB3aGlsZSBpdCBpcyBzZXR0aW5nIHRoZSBvYnNlcnZlZCBwYXRoLgpFbWJlci5fc3VzcGVuZEJlZm9yZU9ic2VydmVyID0gZnVuY3Rpb24ob2JqLCBwYXRoLCB0YXJnZXQsIG1ldGhvZCwgY2FsbGJhY2spIHsKICByZXR1cm4gRW1iZXIuX3N1c3BlbmRMaXN0ZW5lcihvYmosIGJlZm9yZUV2ZW50KHBhdGgpLCB0YXJnZXQsIG1ldGhvZCwgY2FsbGJhY2spOwp9OwoKRW1iZXIuX3N1c3BlbmRPYnNlcnZlciA9IGZ1bmN0aW9uKG9iaiwgcGF0aCwgdGFyZ2V0LCBtZXRob2QsIGNhbGxiYWNrKSB7CiAgcmV0dXJuIEVtYmVyLl9zdXNwZW5kTGlzdGVuZXIob2JqLCBjaGFuZ2VFdmVudChwYXRoKSwgdGFyZ2V0LCBtZXRob2QsIGNhbGxiYWNrKTsKfTsKCnZhciBtYXAgPSBFbWJlci5BcnJheVBvbHlmaWxscy5tYXA7CgpFbWJlci5fc3VzcGVuZEJlZm9yZU9ic2VydmVycyA9IGZ1bmN0aW9uKG9iaiwgcGF0aHMsIHRhcmdldCwgbWV0aG9kLCBjYWxsYmFjaykgewogIHZhciBldmVudHMgPSBtYXAuY2FsbChwYXRocywgYmVmb3JlRXZlbnQpOwogIHJldHVybiBFbWJlci5fc3VzcGVuZExpc3RlbmVycyhvYmosIGV2ZW50cywgdGFyZ2V0LCBtZXRob2QsIGNhbGxiYWNrKTsKfTsKCkVtYmVyLl9zdXNwZW5kT2JzZXJ2ZXJzID0gZnVuY3Rpb24ob2JqLCBwYXRocywgdGFyZ2V0LCBtZXRob2QsIGNhbGxiYWNrKSB7CiAgdmFyIGV2ZW50cyA9IG1hcC5jYWxsKHBhdGhzLCBjaGFuZ2VFdmVudCk7CiAgcmV0dXJuIEVtYmVyLl9zdXNwZW5kTGlzdGVuZXJzKG9iaiwgZXZlbnRzLCB0YXJnZXQsIG1ldGhvZCwgY2FsbGJhY2spOwp9OwoKRW1iZXIuYmVmb3JlT2JzZXJ2ZXJzRm9yID0gZnVuY3Rpb24ob2JqLCBwYXRoKSB7CiAgcmV0dXJuIEVtYmVyLmxpc3RlbmVyc0ZvcihvYmosIGJlZm9yZUV2ZW50KHBhdGgpKTsKfTsKCi8qKgogIEBtZXRob2QgcmVtb3ZlQmVmb3JlT2JzZXJ2ZXIKICBAcGFyYW0gb2JqCiAgQHBhcmFtIHtTdHJpbmd9IHBhdGgKICBAcGFyYW0ge09iamVjdHxGdW5jdGlvbn0gdGFyZ2V0T3JNZXRob2QKICBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gW21ldGhvZF0KKi8KRW1iZXIucmVtb3ZlQmVmb3JlT2JzZXJ2ZXIgPSBmdW5jdGlvbihvYmosIF9wYXRoLCB0YXJnZXQsIG1ldGhvZCkgewogIEVtYmVyLnVud2F0Y2gob2JqLCBfcGF0aCk7CiAgRW1iZXIucmVtb3ZlTGlzdGVuZXIob2JqLCBiZWZvcmVFdmVudChfcGF0aCksIHRhcmdldCwgbWV0aG9kKTsKCiAgcmV0dXJuIHRoaXM7Cn07Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7CmRlZmluZSgiYmFja2J1cm5lci9xdWV1ZSIsCiAgWyJleHBvcnRzIl0sCiAgZnVuY3Rpb24oX19leHBvcnRzX18pIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGZ1bmN0aW9uIFF1ZXVlKGRhcSwgbmFtZSwgb3B0aW9ucykgewogICAgICB0aGlzLmRhcSA9IGRhcTsKICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgICAgdGhpcy5fcXVldWUgPSBbXTsKICAgIH0KCiAgICBRdWV1ZS5wcm90b3R5cGUgPSB7CiAgICAgIGRhcTogbnVsbCwKICAgICAgbmFtZTogbnVsbCwKICAgICAgb3B0aW9uczogbnVsbCwKICAgICAgX3F1ZXVlOiBudWxsLAoKICAgICAgcHVzaDogZnVuY3Rpb24odGFyZ2V0LCBtZXRob2QsIGFyZ3MsIHN0YWNrKSB7CiAgICAgICAgdmFyIHF1ZXVlID0gdGhpcy5fcXVldWU7CiAgICAgICAgcXVldWUucHVzaCh0YXJnZXQsIG1ldGhvZCwgYXJncywgc3RhY2spOwogICAgICAgIHJldHVybiB7cXVldWU6IHRoaXMsIHRhcmdldDogdGFyZ2V0LCBtZXRob2Q6IG1ldGhvZH07CiAgICAgIH0sCgogICAgICBwdXNoVW5pcXVlOiBmdW5jdGlvbih0YXJnZXQsIG1ldGhvZCwgYXJncywgc3RhY2spIHsKICAgICAgICB2YXIgcXVldWUgPSB0aGlzLl9xdWV1ZSwgY3VycmVudFRhcmdldCwgY3VycmVudE1ldGhvZCwgaSwgbDsKCiAgICAgICAgZm9yIChpID0gMCwgbCA9IHF1ZXVlLmxlbmd0aDsgaSA8IGw7IGkgKz0gNCkgewogICAgICAgICAgY3VycmVudFRhcmdldCA9IHF1ZXVlW2ldOwogICAgICAgICAgY3VycmVudE1ldGhvZCA9IHF1ZXVlW2krMV07CgogICAgICAgICAgaWYgKGN1cnJlbnRUYXJnZXQgPT09IHRhcmdldCAmJiBjdXJyZW50TWV0aG9kID09PSBtZXRob2QpIHsKICAgICAgICAgICAgcXVldWVbaSsyXSA9IGFyZ3M7IC8vIHJlcGxhY2UgYXJncwogICAgICAgICAgICBxdWV1ZVtpKzNdID0gc3RhY2s7IC8vIHJlcGxhY2Ugc3RhY2sKICAgICAgICAgICAgcmV0dXJuIHtxdWV1ZTogdGhpcywgdGFyZ2V0OiB0YXJnZXQsIG1ldGhvZDogbWV0aG9kfTsgLy8gVE9ETzogdGVzdCB0aGlzIGNvZGUgcGF0aAogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5fcXVldWUucHVzaCh0YXJnZXQsIG1ldGhvZCwgYXJncywgc3RhY2spOwogICAgICAgIHJldHVybiB7cXVldWU6IHRoaXMsIHRhcmdldDogdGFyZ2V0LCBtZXRob2Q6IG1ldGhvZH07CiAgICAgIH0sCgogICAgICAvLyBUT0RPOiByZW1vdmUgbWUsIG9ubHkgYmVpbmcgdXNlZCBmb3IgRW1iZXIucnVuLnN5bmMKICAgICAgZmx1c2g6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBxdWV1ZSA9IHRoaXMuX3F1ZXVlLAogICAgICAgICAgICBvcHRpb25zID0gdGhpcy5vcHRpb25zLAogICAgICAgICAgICBiZWZvcmUgPSBvcHRpb25zICYmIG9wdGlvbnMuYmVmb3JlLAogICAgICAgICAgICBhZnRlciA9IG9wdGlvbnMgJiYgb3B0aW9ucy5hZnRlciwKICAgICAgICAgICAgdGFyZ2V0LCBtZXRob2QsIGFyZ3MsIHN0YWNrLCBpLCBsID0gcXVldWUubGVuZ3RoOwoKICAgICAgICBpZiAobCAmJiBiZWZvcmUpIHsgYmVmb3JlKCk7IH0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbDsgaSArPSA0KSB7CiAgICAgICAgICB0YXJnZXQgPSBxdWV1ZVtpXTsKICAgICAgICAgIG1ldGhvZCA9IHF1ZXVlW2krMV07CiAgICAgICAgICBhcmdzICAgPSBxdWV1ZVtpKzJdOwogICAgICAgICAgc3RhY2sgID0gcXVldWVbaSszXTsgLy8gRGVidWdnaW5nIGFzc2lzdGFuY2UKCiAgICAgICAgICAvLyBUT0RPOiBlcnJvciBoYW5kbGluZwogICAgICAgICAgaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIG1ldGhvZC5hcHBseSh0YXJnZXQsIGFyZ3MpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbWV0aG9kLmNhbGwodGFyZ2V0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGwgJiYgYWZ0ZXIpIHsgYWZ0ZXIoKTsgfQoKICAgICAgICAvLyBjaGVjayBpZiBuZXcgaXRlbXMgaGF2ZSBiZWVuIGFkZGVkCiAgICAgICAgaWYgKHF1ZXVlLmxlbmd0aCA+IGwpIHsKICAgICAgICAgIHRoaXMuX3F1ZXVlID0gcXVldWUuc2xpY2UobCk7CiAgICAgICAgICB0aGlzLmZsdXNoKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuX3F1ZXVlLmxlbmd0aCA9IDA7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgY2FuY2VsOiBmdW5jdGlvbihhY3Rpb25Ub0NhbmNlbCkgewogICAgICAgIHZhciBxdWV1ZSA9IHRoaXMuX3F1ZXVlLCBjdXJyZW50VGFyZ2V0LCBjdXJyZW50TWV0aG9kLCBpLCBsOwoKICAgICAgICBmb3IgKGkgPSAwLCBsID0gcXVldWUubGVuZ3RoOyBpIDwgbDsgaSArPSA0KSB7CiAgICAgICAgICBjdXJyZW50VGFyZ2V0ID0gcXVldWVbaV07CiAgICAgICAgICBjdXJyZW50TWV0aG9kID0gcXVldWVbaSsxXTsKCiAgICAgICAgICBpZiAoY3VycmVudFRhcmdldCA9PT0gYWN0aW9uVG9DYW5jZWwudGFyZ2V0ICYmIGN1cnJlbnRNZXRob2QgPT09IGFjdGlvblRvQ2FuY2VsLm1ldGhvZCkgewogICAgICAgICAgICBxdWV1ZS5zcGxpY2UoaSwgNCk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gaWYgbm90IGZvdW5kIGluIGN1cnJlbnQgcXVldWUKICAgICAgICAvLyBjb3VsZCBiZSBpbiB0aGUgcXVldWUgdGhhdCBpcyBiZWluZyBmbHVzaGVkCiAgICAgICAgcXVldWUgPSB0aGlzLl9xdWV1ZUJlaW5nRmx1c2hlZDsKICAgICAgICBpZiAoIXF1ZXVlKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IDAsIGwgPSBxdWV1ZS5sZW5ndGg7IGkgPCBsOyBpICs9IDQpIHsKICAgICAgICAgIGN1cnJlbnRUYXJnZXQgPSBxdWV1ZVtpXTsKICAgICAgICAgIGN1cnJlbnRNZXRob2QgPSBxdWV1ZVtpKzFdOwoKICAgICAgICAgIGlmIChjdXJyZW50VGFyZ2V0ID09PSBhY3Rpb25Ub0NhbmNlbC50YXJnZXQgJiYgY3VycmVudE1ldGhvZCA9PT0gYWN0aW9uVG9DYW5jZWwubWV0aG9kKSB7CiAgICAgICAgICAgIC8vIGRvbid0IG1lc3Mgd2l0aCBhcnJheSBkdXJpbmcgZmx1c2gKICAgICAgICAgICAgLy8ganVzdCBudWxsaWZ5IHRoZSBtZXRob2QKICAgICAgICAgICAgcXVldWVbaSsxXSA9IG51bGw7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKCgogICAgX19leHBvcnRzX18uUXVldWUgPSBRdWV1ZTsKICB9KTsKCmRlZmluZSgiYmFja2J1cm5lci9kZWZlcnJlZF9hY3Rpb25fcXVldWVzIiwKICBbImJhY2tidXJuZXIvcXVldWUiLCJleHBvcnRzIl0sCiAgZnVuY3Rpb24oX19kZXBlbmRlbmN5MV9fLCBfX2V4cG9ydHNfXykgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIFF1ZXVlID0gX19kZXBlbmRlbmN5MV9fLlF1ZXVlOwoKICAgIGZ1bmN0aW9uIERlZmVycmVkQWN0aW9uUXVldWVzKHF1ZXVlTmFtZXMsIG9wdGlvbnMpIHsKICAgICAgdmFyIHF1ZXVlcyA9IHRoaXMucXVldWVzID0ge307CiAgICAgIHRoaXMucXVldWVOYW1lcyA9IHF1ZXVlTmFtZXMgPSBxdWV1ZU5hbWVzIHx8IFtdOwoKICAgICAgdmFyIHF1ZXVlTmFtZTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBxdWV1ZU5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHF1ZXVlTmFtZSA9IHF1ZXVlTmFtZXNbaV07CiAgICAgICAgcXVldWVzW3F1ZXVlTmFtZV0gPSBuZXcgUXVldWUodGhpcywgcXVldWVOYW1lLCBvcHRpb25zW3F1ZXVlTmFtZV0pOwogICAgICB9CiAgICB9CgogICAgRGVmZXJyZWRBY3Rpb25RdWV1ZXMucHJvdG90eXBlID0gewogICAgICBxdWV1ZU5hbWVzOiBudWxsLAogICAgICBxdWV1ZXM6IG51bGwsCgogICAgICBzY2hlZHVsZTogZnVuY3Rpb24ocXVldWVOYW1lLCB0YXJnZXQsIG1ldGhvZCwgYXJncywgb25jZUZsYWcsIHN0YWNrKSB7CiAgICAgICAgdmFyIHF1ZXVlcyA9IHRoaXMucXVldWVzLAogICAgICAgICAgICBxdWV1ZSA9IHF1ZXVlc1txdWV1ZU5hbWVdOwoKICAgICAgICBpZiAoIXF1ZXVlKSB7IHRocm93IG5ldyBFcnJvcigiWW91IGF0dGVtcHRlZCB0byBzY2hlZHVsZSBhbiBhY3Rpb24gaW4gYSBxdWV1ZSAoIiArIHF1ZXVlTmFtZSArICIpIHRoYXQgZG9lc24ndCBleGlzdCIpOyB9CgogICAgICAgIGlmIChvbmNlRmxhZykgewogICAgICAgICAgcmV0dXJuIHF1ZXVlLnB1c2hVbmlxdWUodGFyZ2V0LCBtZXRob2QsIGFyZ3MsIHN0YWNrKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIHF1ZXVlLnB1c2godGFyZ2V0LCBtZXRob2QsIGFyZ3MsIHN0YWNrKTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICBmbHVzaDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHF1ZXVlcyA9IHRoaXMucXVldWVzLAogICAgICAgICAgICBxdWV1ZU5hbWVzID0gdGhpcy5xdWV1ZU5hbWVzLAogICAgICAgICAgICBxdWV1ZU5hbWUsIHF1ZXVlLCBxdWV1ZUl0ZW1zLCBwcmlvclF1ZXVlTmFtZUluZGV4LAogICAgICAgICAgICBxdWV1ZU5hbWVJbmRleCA9IDAsIG51bWJlck9mUXVldWVzID0gcXVldWVOYW1lcy5sZW5ndGg7CgogICAgICAgIG91dGVybG9vcDoKICAgICAgICB3aGlsZSAocXVldWVOYW1lSW5kZXggPCBudW1iZXJPZlF1ZXVlcykgewogICAgICAgICAgcXVldWVOYW1lID0gcXVldWVOYW1lc1txdWV1ZU5hbWVJbmRleF07CiAgICAgICAgICBxdWV1ZSA9IHF1ZXVlc1txdWV1ZU5hbWVdOwogICAgICAgICAgcXVldWVJdGVtcyA9IHF1ZXVlLl9xdWV1ZUJlaW5nRmx1c2hlZCA9IHF1ZXVlLl9xdWV1ZS5zbGljZSgpOwogICAgICAgICAgcXVldWUuX3F1ZXVlID0gW107CgogICAgICAgICAgdmFyIG9wdGlvbnMgPSBxdWV1ZS5vcHRpb25zLAogICAgICAgICAgICAgIGJlZm9yZSA9IG9wdGlvbnMgJiYgb3B0aW9ucy5iZWZvcmUsCiAgICAgICAgICAgICAgYWZ0ZXIgPSBvcHRpb25zICYmIG9wdGlvbnMuYWZ0ZXIsCiAgICAgICAgICAgICAgdGFyZ2V0LCBtZXRob2QsIGFyZ3MsIHN0YWNrLAogICAgICAgICAgICAgIHF1ZXVlSW5kZXggPSAwLCBudW1iZXJPZlF1ZXVlSXRlbXMgPSBxdWV1ZUl0ZW1zLmxlbmd0aDsKCiAgICAgICAgICBpZiAobnVtYmVyT2ZRdWV1ZUl0ZW1zICYmIGJlZm9yZSkgeyBiZWZvcmUoKTsgfQogICAgICAgICAgd2hpbGUgKHF1ZXVlSW5kZXggPCBudW1iZXJPZlF1ZXVlSXRlbXMpIHsKICAgICAgICAgICAgdGFyZ2V0ID0gcXVldWVJdGVtc1txdWV1ZUluZGV4XTsKICAgICAgICAgICAgbWV0aG9kID0gcXVldWVJdGVtc1txdWV1ZUluZGV4KzFdOwogICAgICAgICAgICBhcmdzICAgPSBxdWV1ZUl0ZW1zW3F1ZXVlSW5kZXgrMl07CiAgICAgICAgICAgIHN0YWNrICA9IHF1ZXVlSXRlbXNbcXVldWVJbmRleCszXTsgLy8gRGVidWdnaW5nIGFzc2lzdGFuY2UKCiAgICAgICAgICAgIGlmICh0eXBlb2YgbWV0aG9kID09PSAnc3RyaW5nJykgeyBtZXRob2QgPSB0YXJnZXRbbWV0aG9kXTsgfQoKICAgICAgICAgICAgLy8gbWV0aG9kIGNvdWxkIGhhdmUgYmVlbiBudWxsaWZpZWQgLyBjYW5jZWxlZCBkdXJpbmcgZmx1c2gKICAgICAgICAgICAgaWYgKG1ldGhvZCkgewogICAgICAgICAgICAgIC8vIFRPRE86IGVycm9yIGhhbmRsaW5nCiAgICAgICAgICAgICAgaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBtZXRob2QuYXBwbHkodGFyZ2V0LCBhcmdzKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbWV0aG9kLmNhbGwodGFyZ2V0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHF1ZXVlSW5kZXggKz0gNDsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLl9xdWV1ZUJlaW5nRmx1c2hlZCA9IG51bGw7CiAgICAgICAgICBpZiAobnVtYmVyT2ZRdWV1ZUl0ZW1zICYmIGFmdGVyKSB7IGFmdGVyKCk7IH0KCiAgICAgICAgICBpZiAoKHByaW9yUXVldWVOYW1lSW5kZXggPSBpbmRleE9mUHJpb3JRdWV1ZVdpdGhBY3Rpb25zKHRoaXMsIHF1ZXVlTmFtZUluZGV4KSkgIT09IC0xKSB7CiAgICAgICAgICAgIHF1ZXVlTmFtZUluZGV4ID0gcHJpb3JRdWV1ZU5hbWVJbmRleDsKICAgICAgICAgICAgY29udGludWUgb3V0ZXJsb29wOwogICAgICAgICAgfQoKICAgICAgICAgIHF1ZXVlTmFtZUluZGV4Kys7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIGZ1bmN0aW9uIGluZGV4T2ZQcmlvclF1ZXVlV2l0aEFjdGlvbnMoZGFxLCBjdXJyZW50UXVldWVJbmRleCkgewogICAgICB2YXIgcXVldWVOYW1lLCBxdWV1ZTsKCiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY3VycmVudFF1ZXVlSW5kZXg7IGkgPD0gbDsgaSsrKSB7CiAgICAgICAgcXVldWVOYW1lID0gZGFxLnF1ZXVlTmFtZXNbaV07CiAgICAgICAgcXVldWUgPSBkYXEucXVldWVzW3F1ZXVlTmFtZV07CiAgICAgICAgaWYgKHF1ZXVlLl9xdWV1ZS5sZW5ndGgpIHsgcmV0dXJuIGk7IH0KICAgICAgfQoKICAgICAgcmV0dXJuIC0xOwogICAgfQoKCiAgICBfX2V4cG9ydHNfXy5EZWZlcnJlZEFjdGlvblF1ZXVlcyA9IERlZmVycmVkQWN0aW9uUXVldWVzOwogIH0pOwoKZGVmaW5lKCJiYWNrYnVybmVyIiwKICBbImJhY2tidXJuZXIvZGVmZXJyZWRfYWN0aW9uX3F1ZXVlcyIsImV4cG9ydHMiXSwKICBmdW5jdGlvbihfX2RlcGVuZGVuY3kxX18sIF9fZXhwb3J0c19fKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgRGVmZXJyZWRBY3Rpb25RdWV1ZXMgPSBfX2RlcGVuZGVuY3kxX18uRGVmZXJyZWRBY3Rpb25RdWV1ZXM7CgogICAgdmFyIHNsaWNlID0gW10uc2xpY2UsCiAgICAgICAgcG9wID0gW10ucG9wLAogICAgICAgIHRocm90dGxlcnMgPSBbXSwKICAgICAgICBkZWJvdW5jZWVzID0gW10sCiAgICAgICAgdGltZXJzID0gW10sCiAgICAgICAgYXV0b3J1biwgbGF0ZXJUaW1lciwgbGF0ZXJUaW1lckV4cGlyZXNBdCwKICAgICAgICBnbG9iYWwgPSB0aGlzLAogICAgICAgIE5VTUJFUiA9IC9cZCsvOwoKICAgIGZ1bmN0aW9uIGlzQ29lcmNhYmxlTnVtYmVyKG51bWJlcikgewogICAgICByZXR1cm4gdHlwZW9mIG51bWJlciA9PT0gJ251bWJlcicgfHwgTlVNQkVSLnRlc3QobnVtYmVyKTsKICAgIH0KCiAgICBmdW5jdGlvbiBCYWNrYnVybmVyKHF1ZXVlTmFtZXMsIG9wdGlvbnMpIHsKICAgICAgdGhpcy5xdWV1ZU5hbWVzID0gcXVldWVOYW1lczsKICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuZGVmYXVsdFF1ZXVlKSB7CiAgICAgICAgdGhpcy5vcHRpb25zLmRlZmF1bHRRdWV1ZSA9IHF1ZXVlTmFtZXNbMF07CiAgICAgIH0KICAgICAgdGhpcy5pbnN0YW5jZVN0YWNrID0gW107CiAgICB9CgogICAgQmFja2J1cm5lci5wcm90b3R5cGUgPSB7CiAgICAgIHF1ZXVlTmFtZXM6IG51bGwsCiAgICAgIG9wdGlvbnM6IG51bGwsCiAgICAgIGN1cnJlbnRJbnN0YW5jZTogbnVsbCwKICAgICAgaW5zdGFuY2VTdGFjazogbnVsbCwKCiAgICAgIGJlZ2luOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgb25CZWdpbiA9IHRoaXMub3B0aW9ucyAmJiB0aGlzLm9wdGlvbnMub25CZWdpbiwKICAgICAgICAgICAgcHJldmlvdXNJbnN0YW5jZSA9IHRoaXMuY3VycmVudEluc3RhbmNlOwoKICAgICAgICBpZiAocHJldmlvdXNJbnN0YW5jZSkgewogICAgICAgICAgdGhpcy5pbnN0YW5jZVN0YWNrLnB1c2gocHJldmlvdXNJbnN0YW5jZSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmN1cnJlbnRJbnN0YW5jZSA9IG5ldyBEZWZlcnJlZEFjdGlvblF1ZXVlcyh0aGlzLnF1ZXVlTmFtZXMsIHRoaXMub3B0aW9ucyk7CiAgICAgICAgaWYgKG9uQmVnaW4pIHsKICAgICAgICAgIG9uQmVnaW4odGhpcy5jdXJyZW50SW5zdGFuY2UsIHByZXZpb3VzSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIGVuZDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIG9uRW5kID0gdGhpcy5vcHRpb25zICYmIHRoaXMub3B0aW9ucy5vbkVuZCwKICAgICAgICAgICAgY3VycmVudEluc3RhbmNlID0gdGhpcy5jdXJyZW50SW5zdGFuY2UsCiAgICAgICAgICAgIG5leHRJbnN0YW5jZSA9IG51bGw7CgogICAgICAgIHRyeSB7CiAgICAgICAgICBjdXJyZW50SW5zdGFuY2UuZmx1c2goKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgdGhpcy5jdXJyZW50SW5zdGFuY2UgPSBudWxsOwoKICAgICAgICAgIGlmICh0aGlzLmluc3RhbmNlU3RhY2subGVuZ3RoKSB7CiAgICAgICAgICAgIG5leHRJbnN0YW5jZSA9IHRoaXMuaW5zdGFuY2VTdGFjay5wb3AoKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50SW5zdGFuY2UgPSBuZXh0SW5zdGFuY2U7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKG9uRW5kKSB7CiAgICAgICAgICAgIG9uRW5kKGN1cnJlbnRJbnN0YW5jZSwgbmV4dEluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCgogICAgICBydW46IGZ1bmN0aW9uKHRhcmdldCwgbWV0aG9kIC8qLCBhcmdzICovKSB7CiAgICAgICAgdmFyIHJldDsKICAgICAgICB0aGlzLmJlZ2luKCk7CgogICAgICAgIGlmICghbWV0aG9kKSB7CiAgICAgICAgICBtZXRob2QgPSB0YXJnZXQ7CiAgICAgICAgICB0YXJnZXQgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBtZXRob2QgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBtZXRob2QgPSB0YXJnZXRbbWV0aG9kXTsKICAgICAgICB9CgogICAgICAgIC8vIFByZXZlbnQgU2FmYXJpIGRvdWJsZS1maW5hbGx5LgogICAgICAgIHZhciBmaW5hbGx5QWxyZWFkeUNhbGxlZCA9IGZhbHNlOwogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDIpIHsKICAgICAgICAgICAgcmV0ID0gbWV0aG9kLmFwcGx5KHRhcmdldCwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldCA9IG1ldGhvZC5jYWxsKHRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGlmICghZmluYWxseUFscmVhZHlDYWxsZWQpIHsKICAgICAgICAgICAgZmluYWxseUFscmVhZHlDYWxsZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmVuZCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0OwogICAgICB9LAoKICAgICAgZGVmZXI6IGZ1bmN0aW9uKHF1ZXVlTmFtZSwgdGFyZ2V0LCBtZXRob2QgLyogLCBhcmdzICovKSB7CiAgICAgICAgaWYgKCFtZXRob2QpIHsKICAgICAgICAgIG1ldGhvZCA9IHRhcmdldDsKICAgICAgICAgIHRhcmdldCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIG1ldGhvZCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIG1ldGhvZCA9IHRhcmdldFttZXRob2RdOwogICAgICAgIH0KCiAgICAgICAgdmFyIHN0YWNrID0gdGhpcy5ERUJVRyA/IG5ldyBFcnJvcigpIDogdW5kZWZpbmVkLAogICAgICAgICAgICBhcmdzID0gYXJndW1lbnRzLmxlbmd0aCA+IDMgPyBzbGljZS5jYWxsKGFyZ3VtZW50cywgMykgOiB1bmRlZmluZWQ7CiAgICAgICAgaWYgKCF0aGlzLmN1cnJlbnRJbnN0YW5jZSkgeyBjcmVhdGVBdXRvcnVuKHRoaXMpOyB9CiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEluc3RhbmNlLnNjaGVkdWxlKHF1ZXVlTmFtZSwgdGFyZ2V0LCBtZXRob2QsIGFyZ3MsIGZhbHNlLCBzdGFjayk7CiAgICAgIH0sCgogICAgICBkZWZlck9uY2U6IGZ1bmN0aW9uKHF1ZXVlTmFtZSwgdGFyZ2V0LCBtZXRob2QgLyogLCBhcmdzICovKSB7CiAgICAgICAgaWYgKCFtZXRob2QpIHsKICAgICAgICAgIG1ldGhvZCA9IHRhcmdldDsKICAgICAgICAgIHRhcmdldCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIG1ldGhvZCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIG1ldGhvZCA9IHRhcmdldFttZXRob2RdOwogICAgICAgIH0KCiAgICAgICAgdmFyIHN0YWNrID0gdGhpcy5ERUJVRyA/IG5ldyBFcnJvcigpIDogdW5kZWZpbmVkLAogICAgICAgICAgICBhcmdzID0gYXJndW1lbnRzLmxlbmd0aCA+IDMgPyBzbGljZS5jYWxsKGFyZ3VtZW50cywgMykgOiB1bmRlZmluZWQ7CiAgICAgICAgaWYgKCF0aGlzLmN1cnJlbnRJbnN0YW5jZSkgeyBjcmVhdGVBdXRvcnVuKHRoaXMpOyB9CiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEluc3RhbmNlLnNjaGVkdWxlKHF1ZXVlTmFtZSwgdGFyZ2V0LCBtZXRob2QsIGFyZ3MsIHRydWUsIHN0YWNrKTsKICAgICAgfSwKCiAgICAgIHNldFRpbWVvdXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgIHZhciBsZW5ndGggPSBhcmdzLmxlbmd0aDsKICAgICAgICB2YXIgbWV0aG9kLCB3YWl0LCB0YXJnZXQ7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIHZhciBtZXRob2RPclRhcmdldCwgbWV0aG9kT3JXYWl0LCBtZXRob2RPckFyZ3M7CgogICAgICAgIGlmIChsZW5ndGggPT09IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9IGVsc2UgaWYgKGxlbmd0aCA9PT0gMSkgewogICAgICAgICAgbWV0aG9kID0gYXJncy5zaGlmdCgpOwogICAgICAgICAgd2FpdCA9IDA7CiAgICAgICAgfSBlbHNlIGlmIChsZW5ndGggPT09IDIpIHsKICAgICAgICAgIG1ldGhvZE9yVGFyZ2V0ID0gYXJnc1swXTsKICAgICAgICAgIG1ldGhvZE9yV2FpdCA9IGFyZ3NbMV07CgogICAgICAgICAgaWYgKHR5cGVvZiBtZXRob2RPcldhaXQgPT09ICdmdW5jdGlvbicgfHwgdHlwZW9mICBtZXRob2RPclRhcmdldFttZXRob2RPcldhaXRdID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIHRhcmdldCA9IGFyZ3Muc2hpZnQoKTsKICAgICAgICAgICAgbWV0aG9kID0gYXJncy5zaGlmdCgpOwogICAgICAgICAgICB3YWl0ID0gMDsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNDb2VyY2FibGVOdW1iZXIobWV0aG9kT3JXYWl0KSkgewogICAgICAgICAgICBtZXRob2QgPSBhcmdzLnNoaWZ0KCk7CiAgICAgICAgICAgIHdhaXQgPSBhcmdzLnNoaWZ0KCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtZXRob2QgPSBhcmdzLnNoaWZ0KCk7CiAgICAgICAgICAgIHdhaXQgPSAgMDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGxhc3QgPSBhcmdzW2FyZ3MubGVuZ3RoIC0gMV07CgogICAgICAgICAgaWYgKGlzQ29lcmNhYmxlTnVtYmVyKGxhc3QpKSB7CiAgICAgICAgICAgIHdhaXQgPSBhcmdzLnBvcCgpOwogICAgICAgICAgfQoKICAgICAgICAgIG1ldGhvZE9yVGFyZ2V0ID0gYXJnc1swXTsKICAgICAgICAgIG1ldGhvZE9yQXJncyA9IGFyZ3NbMV07CgogICAgICAgICAgaWYgKHR5cGVvZiBtZXRob2RPckFyZ3MgPT09ICdmdW5jdGlvbicgfHwgKHR5cGVvZiBtZXRob2RPckFyZ3MgPT09ICdzdHJpbmcnICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kT3JUYXJnZXQgIT09IG51bGwgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRob2RPckFyZ3MgaW4gbWV0aG9kT3JUYXJnZXQpKSB7CiAgICAgICAgICAgIHRhcmdldCA9IGFyZ3Muc2hpZnQoKTsKICAgICAgICAgICAgbWV0aG9kID0gYXJncy5zaGlmdCgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbWV0aG9kID0gYXJncy5zaGlmdCgpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIGV4ZWN1dGVBdCA9ICgrbmV3IERhdGUoKSkgKyBwYXJzZUludCh3YWl0LCAxMCk7CgogICAgICAgIGlmICh0eXBlb2YgbWV0aG9kID09PSAnc3RyaW5nJykgewogICAgICAgICAgbWV0aG9kID0gdGFyZ2V0W21ldGhvZF07CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBmbigpIHsKICAgICAgICAgIG1ldGhvZC5hcHBseSh0YXJnZXQsIGFyZ3MpOwogICAgICAgIH0KCiAgICAgICAgLy8gZmluZCBwb3NpdGlvbiB0byBpbnNlcnQgLSBUT0RPOiBiaW5hcnkgc2VhcmNoCiAgICAgICAgdmFyIGksIGw7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRpbWVycy5sZW5ndGg7IGkgPCBsOyBpICs9IDIpIHsKICAgICAgICAgIGlmIChleGVjdXRlQXQgPCB0aW1lcnNbaV0pIHsgYnJlYWs7IH0KICAgICAgICB9CgogICAgICAgIHRpbWVycy5zcGxpY2UoaSwgMCwgZXhlY3V0ZUF0LCBmbik7CgogICAgICAgIHVwZGF0ZUxhdGVyVGltZXIoc2VsZiwgZXhlY3V0ZUF0LCB3YWl0KTsKCiAgICAgICAgcmV0dXJuIGZuOwogICAgICB9LAoKICAgICAgdGhyb3R0bGU6IGZ1bmN0aW9uKHRhcmdldCwgbWV0aG9kIC8qICwgYXJncywgd2FpdCAqLykgewogICAgICAgIHZhciBzZWxmID0gdGhpcywKICAgICAgICAgICAgYXJncyA9IGFyZ3VtZW50cywKICAgICAgICAgICAgd2FpdCA9IHBhcnNlSW50KHBvcC5jYWxsKGFyZ3MpLCAxMCksCiAgICAgICAgICAgIHRocm90dGxlciwKICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgIHRpbWVyOwoKICAgICAgICBpbmRleCA9IGZpbmRUaHJvdHRsZXIodGFyZ2V0LCBtZXRob2QpOwogICAgICAgIGlmIChpbmRleCA+IC0xKSB7IHJldHVybiB0aHJvdHRsZXJzW2luZGV4XTsgfSAvLyB0aHJvdHRsZWQKCiAgICAgICAgdGltZXIgPSBnbG9iYWwuc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgIHNlbGYucnVuLmFwcGx5KHNlbGYsIGFyZ3MpOwoKICAgICAgICAgIHZhciBpbmRleCA9IGZpbmRUaHJvdHRsZXIodGFyZ2V0LCBtZXRob2QpOwogICAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsgdGhyb3R0bGVycy5zcGxpY2UoaW5kZXgsIDEpOyB9CiAgICAgICAgfSwgd2FpdCk7CgogICAgICAgIHRocm90dGxlciA9IFt0YXJnZXQsIG1ldGhvZCwgdGltZXJdOwoKICAgICAgICB0aHJvdHRsZXJzLnB1c2godGhyb3R0bGVyKTsKCiAgICAgICAgcmV0dXJuIHRocm90dGxlcjsKICAgICAgfSwKCiAgICAgIGRlYm91bmNlOiBmdW5jdGlvbih0YXJnZXQsIG1ldGhvZCAvKiAsIGFyZ3MsIHdhaXQsIFtpbW1lZGlhdGVdICovKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzLAogICAgICAgICAgICBhcmdzID0gYXJndW1lbnRzLAogICAgICAgICAgICBpbW1lZGlhdGUgPSBwb3AuY2FsbChhcmdzKSwKICAgICAgICAgICAgd2FpdCwKICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgIGRlYm91bmNlZSwKICAgICAgICAgICAgdGltZXI7CgogICAgICAgIGlmICh0eXBlb2YgaW1tZWRpYXRlID09PSAibnVtYmVyIiB8fCB0eXBlb2YgaW1tZWRpYXRlID09PSAic3RyaW5nIikgewogICAgICAgICAgd2FpdCA9IGltbWVkaWF0ZTsKICAgICAgICAgIGltbWVkaWF0ZSA9IGZhbHNlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3YWl0ID0gcG9wLmNhbGwoYXJncyk7CiAgICAgICAgfQoKICAgICAgICB3YWl0ID0gcGFyc2VJbnQod2FpdCwgMTApOwogICAgICAgIC8vIFJlbW92ZSBkZWJvdW5jZWUKICAgICAgICBpbmRleCA9IGZpbmREZWJvdW5jZWUodGFyZ2V0LCBtZXRob2QpOwoKICAgICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgICAgZGVib3VuY2VlID0gZGVib3VuY2Vlc1tpbmRleF07CiAgICAgICAgICBkZWJvdW5jZWVzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICBjbGVhclRpbWVvdXQoZGVib3VuY2VlWzJdKTsKICAgICAgICB9CgogICAgICAgIHRpbWVyID0gZ2xvYmFsLnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoIWltbWVkaWF0ZSkgewogICAgICAgICAgICBzZWxmLnJ1bi5hcHBseShzZWxmLCBhcmdzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbmRleCA9IGZpbmREZWJvdW5jZWUodGFyZ2V0LCBtZXRob2QpOwogICAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgICAgZGVib3VuY2Vlcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgfQogICAgICAgIH0sIHdhaXQpOwoKICAgICAgICBpZiAoaW1tZWRpYXRlICYmIGluZGV4ID09PSAtMSkgewogICAgICAgICAgc2VsZi5ydW4uYXBwbHkoc2VsZiwgYXJncyk7CiAgICAgICAgfQoKICAgICAgICBkZWJvdW5jZWUgPSBbdGFyZ2V0LCBtZXRob2QsIHRpbWVyXTsKCiAgICAgICAgZGVib3VuY2Vlcy5wdXNoKGRlYm91bmNlZSk7CgogICAgICAgIHJldHVybiBkZWJvdW5jZWU7CiAgICAgIH0sCgogICAgICBjYW5jZWxUaW1lcnM6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBpLCBsZW47CgogICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IHRocm90dGxlcnMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGNsZWFyVGltZW91dCh0aHJvdHRsZXJzW2ldWzJdKTsKICAgICAgICB9CiAgICAgICAgdGhyb3R0bGVycyA9IFtdOwoKICAgICAgICBmb3IgKGkgPSAwLCBsZW4gPSBkZWJvdW5jZWVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQoZGVib3VuY2Vlc1tpXVsyXSk7CiAgICAgICAgfQogICAgICAgIGRlYm91bmNlZXMgPSBbXTsKCiAgICAgICAgaWYgKGxhdGVyVGltZXIpIHsKICAgICAgICAgIGNsZWFyVGltZW91dChsYXRlclRpbWVyKTsKICAgICAgICAgIGxhdGVyVGltZXIgPSBudWxsOwogICAgICAgIH0KICAgICAgICB0aW1lcnMgPSBbXTsKCiAgICAgICAgaWYgKGF1dG9ydW4pIHsKICAgICAgICAgIGNsZWFyVGltZW91dChhdXRvcnVuKTsKICAgICAgICAgIGF1dG9ydW4gPSBudWxsOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIGhhc1RpbWVyczogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICEhdGltZXJzLmxlbmd0aCB8fCBhdXRvcnVuOwogICAgICB9LAoKICAgICAgY2FuY2VsOiBmdW5jdGlvbih0aW1lcikgewogICAgICAgIHZhciB0aW1lclR5cGUgPSB0eXBlb2YgdGltZXI7CgogICAgICAgIGlmICh0aW1lciAmJiB0aW1lclR5cGUgPT09ICdvYmplY3QnICYmIHRpbWVyLnF1ZXVlICYmIHRpbWVyLm1ldGhvZCkgeyAvLyB3ZSdyZSBjYW5jZWxsaW5nIGEgZGVmZXJPbmNlCiAgICAgICAgICByZXR1cm4gdGltZXIucXVldWUuY2FuY2VsKHRpbWVyKTsKICAgICAgICB9IGVsc2UgaWYgKHRpbWVyVHlwZSA9PT0gJ2Z1bmN0aW9uJykgeyAvLyB3ZSdyZSBjYW5jZWxsaW5nIGEgc2V0VGltZW91dAogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0aW1lcnMubGVuZ3RoOyBpIDwgbDsgaSArPSAyKSB7CiAgICAgICAgICAgIGlmICh0aW1lcnNbaSArIDFdID09PSB0aW1lcikgewogICAgICAgICAgICAgIHRpbWVycy5zcGxpY2UoaSwgMik7IC8vIHJlbW92ZSB0aGUgdHdvIGVsZW1lbnRzCiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHdpbmRvdy50b1N0cmluZy5jYWxsKHRpbWVyKSA9PT0gIltvYmplY3QgQXJyYXldIil7IC8vIHdlJ3JlIGNhbmNlbGxpbmcgYSB0aHJvdHRsZSBvciBkZWJvdW5jZQogICAgICAgICAgcmV0dXJuIHRoaXMuX2NhbmNlbEl0ZW0oZmluZFRocm90dGxlciwgdGhyb3R0bGVycywgdGltZXIpIHx8IAogICAgICAgICAgICAgICAgICAgdGhpcy5fY2FuY2VsSXRlbShmaW5kRGVib3VuY2VlLCBkZWJvdW5jZWVzLCB0aW1lcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybjsgLy8gdGltZXIgd2FzIG51bGwgb3Igbm90IGEgdGltZXIKICAgICAgICB9CiAgICAgIH0sCgogICAgICBfY2FuY2VsSXRlbTogZnVuY3Rpb24oZmluZE1ldGhvZCwgYXJyYXksIHRpbWVyKXsKICAgICAgICB2YXIgaXRlbSwKICAgICAgICAgICAgaW5kZXg7CgogICAgICAgIGlmICh0aW1lci5sZW5ndGggPCAzKSB7IHJldHVybiBmYWxzZTsgfQoKICAgICAgICBpbmRleCA9IGZpbmRNZXRob2QodGltZXJbMF0sIHRpbWVyWzFdKTsKCiAgICAgICAgaWYoaW5kZXggPiAtMSkgewoKICAgICAgICAgIGl0ZW0gPSBhcnJheVtpbmRleF07CgogICAgICAgICAgaWYoaXRlbVsyXSA9PT0gdGltZXJbMl0pewogICAgICAgICAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXJbMl0pOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgIH07CgogICAgQmFja2J1cm5lci5wcm90b3R5cGUuc2NoZWR1bGUgPSBCYWNrYnVybmVyLnByb3RvdHlwZS5kZWZlcjsKICAgIEJhY2tidXJuZXIucHJvdG90eXBlLnNjaGVkdWxlT25jZSA9IEJhY2tidXJuZXIucHJvdG90eXBlLmRlZmVyT25jZTsKICAgIEJhY2tidXJuZXIucHJvdG90eXBlLmxhdGVyID0gQmFja2J1cm5lci5wcm90b3R5cGUuc2V0VGltZW91dDsKCiAgICBmdW5jdGlvbiBjcmVhdGVBdXRvcnVuKGJhY2tidXJuZXIpIHsKICAgICAgYmFja2J1cm5lci5iZWdpbigpOwogICAgICBhdXRvcnVuID0gZ2xvYmFsLnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgYXV0b3J1biA9IG51bGw7CiAgICAgICAgYmFja2J1cm5lci5lbmQoKTsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlTGF0ZXJUaW1lcihzZWxmLCBleGVjdXRlQXQsIHdhaXQpIHsKICAgICAgaWYgKCFsYXRlclRpbWVyIHx8IGV4ZWN1dGVBdCA8IGxhdGVyVGltZXJFeHBpcmVzQXQpIHsKICAgICAgICBpZiAobGF0ZXJUaW1lcikgewogICAgICAgICAgY2xlYXJUaW1lb3V0KGxhdGVyVGltZXIpOwogICAgICAgIH0KICAgICAgICBsYXRlclRpbWVyID0gZ2xvYmFsLnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICBsYXRlclRpbWVyID0gbnVsbDsKICAgICAgICAgIGxhdGVyVGltZXJFeHBpcmVzQXQgPSBudWxsOwogICAgICAgICAgZXhlY3V0ZVRpbWVycyhzZWxmKTsKICAgICAgICB9LCB3YWl0KTsKICAgICAgICBsYXRlclRpbWVyRXhwaXJlc0F0ID0gZXhlY3V0ZUF0OwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZXhlY3V0ZVRpbWVycyhzZWxmKSB7CiAgICAgIHZhciBub3cgPSArbmV3IERhdGUoKSwKICAgICAgICAgIHRpbWUsIGZucywgaSwgbDsKCiAgICAgIHNlbGYucnVuKGZ1bmN0aW9uKCkgewogICAgICAgIC8vIFRPRE86IGJpbmFyeSBzZWFyY2gKICAgICAgICBmb3IgKGkgPSAwLCBsID0gdGltZXJzLmxlbmd0aDsgaSA8IGw7IGkgKz0gMikgewogICAgICAgICAgdGltZSA9IHRpbWVyc1tpXTsKICAgICAgICAgIGlmICh0aW1lID4gbm93KSB7IGJyZWFrOyB9CiAgICAgICAgfQoKICAgICAgICBmbnMgPSB0aW1lcnMuc3BsaWNlKDAsIGkpOwoKICAgICAgICBmb3IgKGkgPSAxLCBsID0gZm5zLmxlbmd0aDsgaSA8IGw7IGkgKz0gMikgewogICAgICAgICAgc2VsZi5zY2hlZHVsZShzZWxmLm9wdGlvbnMuZGVmYXVsdFF1ZXVlLCBudWxsLCBmbnNbaV0pOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICBpZiAodGltZXJzLmxlbmd0aCkgewogICAgICAgIHVwZGF0ZUxhdGVyVGltZXIoc2VsZiwgdGltZXJzWzBdLCB0aW1lcnNbMF0gLSBub3cpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZmluZERlYm91bmNlZSh0YXJnZXQsIG1ldGhvZCkgewogICAgICB2YXIgZGVib3VuY2VlLAogICAgICAgICAgaW5kZXggPSAtMTsKCiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gZGVib3VuY2Vlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBkZWJvdW5jZWUgPSBkZWJvdW5jZWVzW2ldOwogICAgICAgIGlmIChkZWJvdW5jZWVbMF0gPT09IHRhcmdldCAmJiBkZWJvdW5jZWVbMV0gPT09IG1ldGhvZCkgewogICAgICAgICAgaW5kZXggPSBpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gaW5kZXg7CiAgICB9CgogICAgZnVuY3Rpb24gZmluZFRocm90dGxlcih0YXJnZXQsIG1ldGhvZCkgewogICAgICB2YXIgdGhyb3R0bGVyLAogICAgICAgICAgaW5kZXggPSAtMTsKCiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gdGhyb3R0bGVycy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB0aHJvdHRsZXIgPSB0aHJvdHRsZXJzW2ldOwogICAgICAgIGlmICh0aHJvdHRsZXJbMF0gPT09IHRhcmdldCAmJiB0aHJvdHRsZXJbMV0gPT09IG1ldGhvZCkgewogICAgICAgICAgaW5kZXggPSBpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gaW5kZXg7CiAgICB9CgoKICAgIF9fZXhwb3J0c19fLkJhY2tidXJuZXIgPSBCYWNrYnVybmVyOwogIH0pOwp9KSgpOwoKCgooZnVuY3Rpb24oKSB7CnZhciBvbkJlZ2luID0gZnVuY3Rpb24oY3VycmVudCkgewogIEVtYmVyLnJ1bi5jdXJyZW50UnVuTG9vcCA9IGN1cnJlbnQ7Cn07Cgp2YXIgb25FbmQgPSBmdW5jdGlvbihjdXJyZW50LCBuZXh0KSB7CiAgRW1iZXIucnVuLmN1cnJlbnRSdW5Mb29wID0gbmV4dDsKfTsKCnZhciBCYWNrYnVybmVyID0gcmVxdWlyZU1vZHVsZSgnYmFja2J1cm5lcicpLkJhY2tidXJuZXIsCiAgICBiYWNrYnVybmVyID0gbmV3IEJhY2tidXJuZXIoWydzeW5jJywgJ2FjdGlvbnMnLCAnZGVzdHJveSddLCB7CiAgICAgIHN5bmM6IHsKICAgICAgICBiZWZvcmU6IEVtYmVyLmJlZ2luUHJvcGVydHlDaGFuZ2VzLAogICAgICAgIGFmdGVyOiBFbWJlci5lbmRQcm9wZXJ0eUNoYW5nZXMKICAgICAgfSwKICAgICAgZGVmYXVsdFF1ZXVlOiAnYWN0aW9ucycsCiAgICAgIG9uQmVnaW46IG9uQmVnaW4sCiAgICAgIG9uRW5kOiBvbkVuZAogICAgfSksCiAgICBzbGljZSA9IFtdLnNsaWNlOwoKLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgovLyBFbWJlci5ydW4gLSB0aGlzIGlzIGlkZWFsbHkgdGhlIG9ubHkgcHVibGljIEFQSSB0aGUgZGV2IHNlZXMKLy8KCi8qKgogIFJ1bnMgdGhlIHBhc3NlZCB0YXJnZXQgYW5kIG1ldGhvZCBpbnNpZGUgb2YgYSBSdW5Mb29wLCBlbnN1cmluZyBhbnkKICBkZWZlcnJlZCBhY3Rpb25zIGluY2x1ZGluZyBiaW5kaW5ncyBhbmQgdmlld3MgdXBkYXRlcyBhcmUgZmx1c2hlZCBhdCB0aGUKICBlbmQuCgogIE5vcm1hbGx5IHlvdSBzaG91bGQgbm90IG5lZWQgdG8gaW52b2tlIHRoaXMgbWV0aG9kIHlvdXJzZWxmLiBIb3dldmVyIGlmCiAgeW91IGFyZSBpbXBsZW1lbnRpbmcgcmF3IGV2ZW50IGhhbmRsZXJzIHdoZW4gaW50ZXJmYWNpbmcgd2l0aCBvdGhlcgogIGxpYnJhcmllcyBvciBwbHVnaW5zLCB5b3Ugc2hvdWxkIHByb2JhYmx5IHdyYXAgYWxsIG9mIHlvdXIgY29kZSBpbnNpZGUgdGhpcwogIGNhbGwuCgogIGBgYGphdmFzY3JpcHQKICBFbWJlci5ydW4oZnVuY3Rpb24oKSB7CiAgICAvLyBjb2RlIHRvIGJlIGV4ZWN1dGUgd2l0aGluIGEgUnVuTG9vcAogIH0pOwogIGBgYAoKICBAY2xhc3MgcnVuCiAgQG5hbWVzcGFjZSBFbWJlcgogIEBzdGF0aWMKICBAY29uc3RydWN0b3IKICBAcGFyYW0ge09iamVjdH0gW3RhcmdldF0gdGFyZ2V0IG9mIG1ldGhvZCB0byBjYWxsCiAgQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IG1ldGhvZCBNZXRob2QgdG8gaW52b2tlLgogICAgTWF5IGJlIGEgZnVuY3Rpb24gb3IgYSBzdHJpbmcuIElmIHlvdSBwYXNzIGEgc3RyaW5nCiAgICB0aGVuIGl0IHdpbGwgYmUgbG9va2VkIHVwIG9uIHRoZSBwYXNzZWQgdGFyZ2V0LgogIEBwYXJhbSB7T2JqZWN0fSBbYXJncypdIEFueSBhZGRpdGlvbmFsIGFyZ3VtZW50cyB5b3Ugd2lzaCB0byBwYXNzIHRvIHRoZSBtZXRob2QuCiAgQHJldHVybiB7T2JqZWN0fSByZXR1cm4gdmFsdWUgZnJvbSBpbnZva2luZyB0aGUgcGFzc2VkIGZ1bmN0aW9uLgoqLwpFbWJlci5ydW4gPSBmdW5jdGlvbih0YXJnZXQsIG1ldGhvZCkgewogIHZhciByZXQ7CgogIGlmIChFbWJlci5vbmVycm9yKSB7CiAgICB0cnkgewogICAgICByZXQgPSBiYWNrYnVybmVyLnJ1bi5hcHBseShiYWNrYnVybmVyLCBhcmd1bWVudHMpOwogICAgfSBjYXRjaCAoZSkgewogICAgICBFbWJlci5vbmVycm9yKGUpOwogICAgfQogIH0gZWxzZSB7CiAgICByZXQgPSBiYWNrYnVybmVyLnJ1bi5hcHBseShiYWNrYnVybmVyLCBhcmd1bWVudHMpOwogIH0KCiAgcmV0dXJuIHJldDsKfTsKCi8qKgogIElmIG5vIHJ1bi1sb29wIGlzIHByZXNlbnQsIGl0IGNyZWF0ZXMgYSBuZXcgb25lLiBJZiBhIHJ1biBsb29wIGlzCiAgcHJlc2VudCBpdCB3aWxsIHF1ZXVlIGl0c2VsZiB0byBydW4gb24gdGhlIGV4aXN0aW5nIHJ1bi1sb29wcyBhY3Rpb24KICBxdWV1ZS4KCiAgUGxlYXNlIG5vdGU6IFRoaXMgaXMgbm90IGZvciBub3JtYWwgdXNhZ2UsIGFuZCBzaG91bGQgYmUgdXNlZCBzcGFyaW5nbHkuCgogIElmIGludm9rZWQgd2hlbiBub3Qgd2l0aGluIGEgcnVuIGxvb3A6CgogIGBgYGphdmFzY3JpcHQKICBFbWJlci5ydW4uam9pbihmdW5jdGlvbigpIHsKICAgIC8vIGNyZWF0ZXMgYSBuZXcgcnVuLWxvb3AKICB9KTsKICBgYGAKCiAgQWx0ZXJuYXRpdmVseSwgaWYgY2FsbGVkIHdpdGhpbiBhbiBleGlzdGluZyBydW4gbG9vcDoKCiAgYGBgamF2YXNjcmlwdAogIEVtYmVyLnJ1bihmdW5jdGlvbigpIHsKICAgIC8vIGNyZWF0ZXMgYSBuZXcgcnVuLWxvb3AKICAgIEVtYmVyLnJ1bi5qb2luKGZ1bmN0aW9uKCkgewogICAgICAvLyBqb2lucyB3aXRoIHRoZSBleGlzdGluZyBydW4tbG9vcCwgYW5kIHF1ZXVlcyBmb3IgaW52b2NhdGlvbiBvbgogICAgICAvLyB0aGUgZXhpc3RpbmcgcnVuLWxvb3BzIGFjdGlvbiBxdWV1ZS4KICAgIH0pOwogIH0pOwogIGBgYAoKICBAbWV0aG9kIGpvaW4KICBAbmFtZXNwYWNlIEVtYmVyCiAgQHBhcmFtIHtPYmplY3R9IFt0YXJnZXRdIHRhcmdldCBvZiBtZXRob2QgdG8gY2FsbAogIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBtZXRob2QgTWV0aG9kIHRvIGludm9rZS4KICAgIE1heSBiZSBhIGZ1bmN0aW9uIG9yIGEgc3RyaW5nLiBJZiB5b3UgcGFzcyBhIHN0cmluZwogICAgdGhlbiBpdCB3aWxsIGJlIGxvb2tlZCB1cCBvbiB0aGUgcGFzc2VkIHRhcmdldC4KICBAcGFyYW0ge09iamVjdH0gW2FyZ3MqXSBBbnkgYWRkaXRpb25hbCBhcmd1bWVudHMgeW91IHdpc2ggdG8gcGFzcyB0byB0aGUgbWV0aG9kLgogIEByZXR1cm4ge09iamVjdH0gUmV0dXJuIHZhbHVlIGZyb20gaW52b2tpbmcgdGhlIHBhc3NlZCBmdW5jdGlvbi4gUGxlYXNlIG5vdGUsCiAgd2hlbiBjYWxsZWQgd2l0aGluIGFuIGV4aXN0aW5nIGxvb3AsIG5vIHJldHVybiB2YWx1ZSBpcyBwb3NzaWJsZS4KKi8KRW1iZXIucnVuLmpvaW4gPSBmdW5jdGlvbih0YXJnZXQsIG1ldGhvZCkgewogIGlmICghRW1iZXIucnVuLmN1cnJlbnRSdW5Mb29wKSB7CiAgICByZXR1cm4gRW1iZXIucnVuLmFwcGx5KEVtYmVyLnJ1biwgYXJndW1lbnRzKTsKICB9CgogIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogIGFyZ3MudW5zaGlmdCgnYWN0aW9ucycpOwogIEVtYmVyLnJ1bi5zY2hlZHVsZS5hcHBseShFbWJlci5ydW4sIGFyZ3MpOwp9OwoKRW1iZXIucnVuLmJhY2tidXJuZXIgPSBiYWNrYnVybmVyOwoKdmFyIHJ1biA9IEVtYmVyLnJ1bjsKCkVtYmVyLnJ1bi5jdXJyZW50UnVuTG9vcCA9IG51bGw7CgpFbWJlci5ydW4ucXVldWVzID0gYmFja2J1cm5lci5xdWV1ZU5hbWVzOwoKLyoqCiAgQmVnaW5zIGEgbmV3IFJ1bkxvb3AuIEFueSBkZWZlcnJlZCBhY3Rpb25zIGludm9rZWQgYWZ0ZXIgdGhlIGJlZ2luIHdpbGwKICBiZSBidWZmZXJlZCB1bnRpbCB5b3UgaW52b2tlIGEgbWF0Y2hpbmcgY2FsbCB0byBgRW1iZXIucnVuLmVuZCgpYC4gVGhpcyBpcwogIGEgbG93ZXItbGV2ZWwgd2F5IHRvIHVzZSBhIFJ1bkxvb3AgaW5zdGVhZCBvZiB1c2luZyBgRW1iZXIucnVuKClgLgoKICBgYGBqYXZhc2NyaXB0CiAgRW1iZXIucnVuLmJlZ2luKCk7CiAgLy8gY29kZSB0byBiZSBleGVjdXRlIHdpdGhpbiBhIFJ1bkxvb3AKICBFbWJlci5ydW4uZW5kKCk7CiAgYGBgCgogIEBtZXRob2QgYmVnaW4KICBAcmV0dXJuIHt2b2lkfQoqLwpFbWJlci5ydW4uYmVnaW4gPSBmdW5jdGlvbigpIHsKICBiYWNrYnVybmVyLmJlZ2luKCk7Cn07CgovKioKICBFbmRzIGEgUnVuTG9vcC4gVGhpcyBtdXN0IGJlIGNhbGxlZCBzb21ldGltZSBhZnRlciB5b3UgY2FsbAogIGBFbWJlci5ydW4uYmVnaW4oKWAgdG8gZmx1c2ggYW55IGRlZmVycmVkIGFjdGlvbnMuIFRoaXMgaXMgYSBsb3dlci1sZXZlbCB3YXkKICB0byB1c2UgYSBSdW5Mb29wIGluc3RlYWQgb2YgdXNpbmcgYEVtYmVyLnJ1bigpYC4KCiAgYGBgamF2YXNjcmlwdAogIEVtYmVyLnJ1bi5iZWdpbigpOwogIC8vIGNvZGUgdG8gYmUgZXhlY3V0ZSB3aXRoaW4gYSBSdW5Mb29wCiAgRW1iZXIucnVuLmVuZCgpOwogIGBgYAoKICBAbWV0aG9kIGVuZAogIEByZXR1cm4ge3ZvaWR9CiovCkVtYmVyLnJ1bi5lbmQgPSBmdW5jdGlvbigpIHsKICBiYWNrYnVybmVyLmVuZCgpOwp9OwoKLyoqCiAgQXJyYXkgb2YgbmFtZWQgcXVldWVzLiBUaGlzIGFycmF5IGRldGVybWluZXMgdGhlIG9yZGVyIGluIHdoaWNoIHF1ZXVlcwogIGFyZSBmbHVzaGVkIGF0IHRoZSBlbmQgb2YgdGhlIFJ1bkxvb3AuIFlvdSBjYW4gZGVmaW5lIHlvdXIgb3duIHF1ZXVlcyBieQogIHNpbXBseSBhZGRpbmcgdGhlIHF1ZXVlIG5hbWUgdG8gdGhpcyBhcnJheS4gTm9ybWFsbHkgeW91IHNob3VsZCBub3QgbmVlZAogIHRvIGluc3BlY3Qgb3IgbW9kaWZ5IHRoaXMgcHJvcGVydHkuCgogIEBwcm9wZXJ0eSBxdWV1ZXMKICBAdHlwZSBBcnJheQogIEBkZWZhdWx0IFsnc3luYycsICdhY3Rpb25zJywgJ2Rlc3Ryb3knXQoqLwoKLyoqCiAgQWRkcyB0aGUgcGFzc2VkIHRhcmdldC9tZXRob2QgYW5kIGFueSBvcHRpb25hbCBhcmd1bWVudHMgdG8gdGhlIG5hbWVkCiAgcXVldWUgdG8gYmUgZXhlY3V0ZWQgYXQgdGhlIGVuZCBvZiB0aGUgUnVuTG9vcC4gSWYgeW91IGhhdmUgbm90IGFscmVhZHkKICBzdGFydGVkIGEgUnVuTG9vcCB3aGVuIGNhbGxpbmcgdGhpcyBtZXRob2Qgb25lIHdpbGwgYmUgc3RhcnRlZCBmb3IgeW91CiAgYXV0b21hdGljYWxseS4KCiAgQXQgdGhlIGVuZCBvZiBhIFJ1bkxvb3AsIGFueSBtZXRob2RzIHNjaGVkdWxlZCBpbiB0aGlzIHdheSB3aWxsIGJlIGludm9rZWQuCiAgTWV0aG9kcyB3aWxsIGJlIGludm9rZWQgaW4gYW4gb3JkZXIgbWF0Y2hpbmcgdGhlIG5hbWVkIHF1ZXVlcyBkZWZpbmVkIGluCiAgdGhlIGBFbWJlci5ydW4ucXVldWVzYCBwcm9wZXJ0eS4KCiAgYGBgamF2YXNjcmlwdAogIEVtYmVyLnJ1bi5zY2hlZHVsZSgnc3luYycsIHRoaXMsIGZ1bmN0aW9uKCkgewogICAgLy8gdGhpcyB3aWxsIGJlIGV4ZWN1dGVkIGluIHRoZSBmaXJzdCBSdW5Mb29wIHF1ZXVlLCB3aGVuIGJpbmRpbmdzIGFyZSBzeW5jZWQKICAgIGNvbnNvbGUubG9nKCJzY2hlZHVsZWQgb24gc3luYyBxdWV1ZSIpOwogIH0pOwoKICBFbWJlci5ydW4uc2NoZWR1bGUoJ2FjdGlvbnMnLCB0aGlzLCBmdW5jdGlvbigpIHsKICAgIC8vIHRoaXMgd2lsbCBiZSBleGVjdXRlZCBpbiB0aGUgJ2FjdGlvbnMnIHF1ZXVlLCBhZnRlciBiaW5kaW5ncyBoYXZlIHN5bmNlZC4KICAgIGNvbnNvbGUubG9nKCJzY2hlZHVsZWQgb24gYWN0aW9ucyBxdWV1ZSIpOwogIH0pOwoKICAvLyBOb3RlIHRoZSBmdW5jdGlvbnMgd2lsbCBiZSBydW4gaW4gb3JkZXIgYmFzZWQgb24gdGhlIHJ1biBxdWV1ZXMgb3JkZXIuCiAgLy8gT3V0cHV0IHdvdWxkIGJlOgogIC8vICAgc2NoZWR1bGVkIG9uIHN5bmMgcXVldWUKICAvLyAgIHNjaGVkdWxlZCBvbiBhY3Rpb25zIHF1ZXVlCiAgYGBgCgogIEBtZXRob2Qgc2NoZWR1bGUKICBAcGFyYW0ge1N0cmluZ30gcXVldWUgVGhlIG5hbWUgb2YgdGhlIHF1ZXVlIHRvIHNjaGVkdWxlIGFnYWluc3QuCiAgICBEZWZhdWx0IHF1ZXVlcyBhcmUgJ3N5bmMnIGFuZCAnYWN0aW9ucycKICBAcGFyYW0ge09iamVjdH0gW3RhcmdldF0gdGFyZ2V0IG9iamVjdCB0byB1c2UgYXMgdGhlIGNvbnRleHQgd2hlbiBpbnZva2luZyBhIG1ldGhvZC4KICBAcGFyYW0ge1N0cmluZ3xGdW5jdGlvbn0gbWV0aG9kIFRoZSBtZXRob2QgdG8gaW52b2tlLiBJZiB5b3UgcGFzcyBhIHN0cmluZyBpdAogICAgd2lsbCBiZSByZXNvbHZlZCBvbiB0aGUgdGFyZ2V0IG9iamVjdCBhdCB0aGUgdGltZSB0aGUgc2NoZWR1bGVkIGl0ZW0gaXMKICAgIGludm9rZWQgYWxsb3dpbmcgeW91IHRvIGNoYW5nZSB0aGUgdGFyZ2V0IGZ1bmN0aW9uLgogIEBwYXJhbSB7T2JqZWN0fSBbYXJndW1lbnRzKl0gT3B0aW9uYWwgYXJndW1lbnRzIHRvIGJlIHBhc3NlZCB0byB0aGUgcXVldWVkIG1ldGhvZC4KICBAcmV0dXJuIHt2b2lkfQoqLwpFbWJlci5ydW4uc2NoZWR1bGUgPSBmdW5jdGlvbihxdWV1ZSwgdGFyZ2V0LCBtZXRob2QpIHsKICBjaGVja0F1dG9SdW4oKTsKICBiYWNrYnVybmVyLnNjaGVkdWxlLmFwcGx5KGJhY2tidXJuZXIsIGFyZ3VtZW50cyk7Cn07CgovLyBVc2VkIGJ5IGdsb2JhbCB0ZXN0IHRlYXJkb3duCkVtYmVyLnJ1bi5oYXNTY2hlZHVsZWRUaW1lcnMgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gYmFja2J1cm5lci5oYXNUaW1lcnMoKTsKfTsKCi8vIFVzZWQgYnkgZ2xvYmFsIHRlc3QgdGVhcmRvd24KRW1iZXIucnVuLmNhbmNlbFRpbWVycyA9IGZ1bmN0aW9uICgpIHsKICBiYWNrYnVybmVyLmNhbmNlbFRpbWVycygpOwp9OwoKLyoqCiAgSW1tZWRpYXRlbHkgZmx1c2hlcyBhbnkgZXZlbnRzIHNjaGVkdWxlZCBpbiB0aGUgJ3N5bmMnIHF1ZXVlLiBCaW5kaW5ncwogIHVzZSB0aGlzIHF1ZXVlIHNvIHRoaXMgbWV0aG9kIGlzIGEgdXNlZnVsIHdheSB0byBpbW1lZGlhdGVseSBmb3JjZSBhbGwKICBiaW5kaW5ncyBpbiB0aGUgYXBwbGljYXRpb24gdG8gc3luYy4KCiAgWW91IHNob3VsZCBjYWxsIHRoaXMgbWV0aG9kIGFueXRpbWUgeW91IG5lZWQgYW55IGNoYW5nZWQgc3RhdGUgdG8gcHJvcGFnYXRlCiAgdGhyb3VnaG91dCB0aGUgYXBwIGltbWVkaWF0ZWx5IHdpdGhvdXQgcmVwYWludGluZyB0aGUgVUkgKHdoaWNoIGhhcHBlbnMKICBpbiB0aGUgbGF0ZXIgJ3JlbmRlcicgcXVldWUgYWRkZWQgYnkgdGhlIGBlbWJlci12aWV3c2AgcGFja2FnZSkuCgogIGBgYGphdmFzY3JpcHQKICBFbWJlci5ydW4uc3luYygpOwogIGBgYAoKICBAbWV0aG9kIHN5bmMKICBAcmV0dXJuIHt2b2lkfQoqLwpFbWJlci5ydW4uc3luYyA9IGZ1bmN0aW9uKCkgewogIGlmIChiYWNrYnVybmVyLmN1cnJlbnRJbnN0YW5jZSkgewogICAgYmFja2J1cm5lci5jdXJyZW50SW5zdGFuY2UucXVldWVzLnN5bmMuZmx1c2goKTsKICB9Cn07CgovKioKICBJbnZva2VzIHRoZSBwYXNzZWQgdGFyZ2V0L21ldGhvZCBhbmQgb3B0aW9uYWwgYXJndW1lbnRzIGFmdGVyIGEgc3BlY2lmaWVkCiAgcGVyaW9kIGlmIHRpbWUuIFRoZSBsYXN0IHBhcmFtZXRlciBvZiB0aGlzIG1ldGhvZCBtdXN0IGFsd2F5cyBiZSBhIG51bWJlcgogIG9mIG1pbGxpc2Vjb25kcy4KCiAgWW91IHNob3VsZCB1c2UgdGhpcyBtZXRob2Qgd2hlbmV2ZXIgeW91IG5lZWQgdG8gcnVuIHNvbWUgYWN0aW9uIGFmdGVyIGEKICBwZXJpb2Qgb2YgdGltZSBpbnN0ZWFkIG9mIHVzaW5nIGBzZXRUaW1lb3V0KClgLiBUaGlzIG1ldGhvZCB3aWxsIGVuc3VyZSB0aGF0CiAgaXRlbXMgdGhhdCBleHBpcmUgZHVyaW5nIHRoZSBzYW1lIHNjcmlwdCBleGVjdXRpb24gY3ljbGUgYWxsIGV4ZWN1dGUKICB0b2dldGhlciwgd2hpY2ggaXMgb2Z0ZW4gbW9yZSBlZmZpY2llbnQgdGhhbiB1c2luZyBhIHJlYWwgc2V0VGltZW91dC4KCiAgYGBgamF2YXNjcmlwdAogIEVtYmVyLnJ1bi5sYXRlcihteUNvbnRleHQsIGZ1bmN0aW9uKCkgewogICAgLy8gY29kZSBoZXJlIHdpbGwgZXhlY3V0ZSB3aXRoaW4gYSBSdW5Mb29wIGluIGFib3V0IDUwMG1zIHdpdGggdGhpcyA9PSBteUNvbnRleHQKICB9LCA1MDApOwogIGBgYAoKICBAbWV0aG9kIGxhdGVyCiAgQHBhcmFtIHtPYmplY3R9IFt0YXJnZXRdIHRhcmdldCBvZiBtZXRob2QgdG8gaW52b2tlCiAgQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IG1ldGhvZCBUaGUgbWV0aG9kIHRvIGludm9rZS4KICAgIElmIHlvdSBwYXNzIGEgc3RyaW5nIGl0IHdpbGwgYmUgcmVzb2x2ZWQgb24gdGhlCiAgICB0YXJnZXQgYXQgdGhlIHRpbWUgdGhlIG1ldGhvZCBpcyBpbnZva2VkLgogIEBwYXJhbSB7T2JqZWN0fSBbYXJncypdIE9wdGlvbmFsIGFyZ3VtZW50cyB0byBwYXNzIHRvIHRoZSB0aW1lb3V0LgogIEBwYXJhbSB7TnVtYmVyfSB3YWl0IE51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gd2FpdC4KICBAcmV0dXJuIHtTdHJpbmd9IGEgc3RyaW5nIHlvdSBjYW4gdXNlIHRvIGNhbmNlbCB0aGUgdGltZXIgaW4KICAgIGBFbWJlci5ydW4uY2FuY2VsYCBsYXRlci4KKi8KRW1iZXIucnVuLmxhdGVyID0gZnVuY3Rpb24odGFyZ2V0LCBtZXRob2QpIHsKICByZXR1cm4gYmFja2J1cm5lci5sYXRlci5hcHBseShiYWNrYnVybmVyLCBhcmd1bWVudHMpOwp9OwoKLyoqCiAgU2NoZWR1bGUgYSBmdW5jdGlvbiB0byBydW4gb25lIHRpbWUgZHVyaW5nIHRoZSBjdXJyZW50IFJ1bkxvb3AuIFRoaXMgaXMgZXF1aXZhbGVudAogIHRvIGNhbGxpbmcgYHNjaGVkdWxlT25jZWAgd2l0aCB0aGUgImFjdGlvbnMiIHF1ZXVlLgoKICBAbWV0aG9kIG9uY2UKICBAcGFyYW0ge09iamVjdH0gW3RhcmdldF0gVGhlIHRhcmdldCBvZiB0aGUgbWV0aG9kIHRvIGludm9rZS4KICBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gbWV0aG9kIFRoZSBtZXRob2QgdG8gaW52b2tlLgogICAgSWYgeW91IHBhc3MgYSBzdHJpbmcgaXQgd2lsbCBiZSByZXNvbHZlZCBvbiB0aGUKICAgIHRhcmdldCBhdCB0aGUgdGltZSB0aGUgbWV0aG9kIGlzIGludm9rZWQuCiAgQHBhcmFtIHtPYmplY3R9IFthcmdzKl0gT3B0aW9uYWwgYXJndW1lbnRzIHRvIHBhc3MgdG8gdGhlIHRpbWVvdXQuCiAgQHJldHVybiB7T2JqZWN0fSB0aW1lcgoqLwpFbWJlci5ydW4ub25jZSA9IGZ1bmN0aW9uKHRhcmdldCwgbWV0aG9kKSB7CiAgY2hlY2tBdXRvUnVuKCk7CiAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgYXJncy51bnNoaWZ0KCdhY3Rpb25zJyk7CiAgcmV0dXJuIGJhY2tidXJuZXIuc2NoZWR1bGVPbmNlLmFwcGx5KGJhY2tidXJuZXIsIGFyZ3MpOwp9OwoKLyoqCiAgU2NoZWR1bGVzIGEgZnVuY3Rpb24gdG8gcnVuIG9uZSB0aW1lIGluIGEgZ2l2ZW4gcXVldWUgb2YgdGhlIGN1cnJlbnQgUnVuTG9vcC4KICBDYWxsaW5nIHRoaXMgbWV0aG9kIHdpdGggdGhlIHNhbWUgcXVldWUvdGFyZ2V0L21ldGhvZCBjb21iaW5hdGlvbiB3aWxsIGhhdmUKICBubyBlZmZlY3QgKHBhc3QgdGhlIGluaXRpYWwgY2FsbCkuCgogIE5vdGUgdGhhdCBhbHRob3VnaCB5b3UgY2FuIHBhc3Mgb3B0aW9uYWwgYXJndW1lbnRzIHRoZXNlIHdpbGwgbm90IGJlCiAgY29uc2lkZXJlZCB3aGVuIGxvb2tpbmcgZm9yIGR1cGxpY2F0ZXMuIE5ldyBhcmd1bWVudHMgd2lsbCByZXBsYWNlIHByZXZpb3VzCiAgY2FsbHMuCgogIGBgYGphdmFzY3JpcHQKICBFbWJlci5ydW4oZnVuY3Rpb24oKSB7CiAgICB2YXIgc2F5SGkgPSBmdW5jdGlvbigpIHsgY29uc29sZS5sb2coJ2hpJyk7IH0KICAgIEVtYmVyLnJ1bi5zY2hlZHVsZU9uY2UoJ2FmdGVyUmVuZGVyJywgbXlDb250ZXh0LCBzYXlIaSk7CiAgICBFbWJlci5ydW4uc2NoZWR1bGVPbmNlKCdhZnRlclJlbmRlcicsIG15Q29udGV4dCwgc2F5SGkpOwogICAgLy8gc2F5SGkgd2lsbCBvbmx5IGJlIGV4ZWN1dGVkIG9uY2UsIGluIHRoZSBhZnRlclJlbmRlciBxdWV1ZSBvZiB0aGUgUnVuTG9vcAogIH0pOwogIGBgYAoKICBBbHNvIG5vdGUgdGhhdCBwYXNzaW5nIGFuIGFub255bW91cyBmdW5jdGlvbiB0byBgRW1iZXIucnVuLnNjaGVkdWxlT25jZWAgd2lsbAogIG5vdCBwcmV2ZW50IGFkZGl0aW9uYWwgY2FsbHMgd2l0aCBhbiBpZGVudGljYWwgYW5vbnltb3VzIGZ1bmN0aW9uIGZyb20KICBzY2hlZHVsaW5nIHRoZSBpdGVtcyBtdWx0aXBsZSB0aW1lcywgZS5nLjoKCiAgYGBgamF2YXNjcmlwdAogIGZ1bmN0aW9uIHNjaGVkdWxlSXQoKSB7CiAgICBFbWJlci5ydW4uc2NoZWR1bGVPbmNlKCdhY3Rpb25zJywgbXlDb250ZXh0LCBmdW5jdGlvbigpIHsgY29uc29sZS5sb2coIkNsb3N1cmUiKTsgfSk7CiAgfQogIHNjaGVkdWxlSXQoKTsKICBzY2hlZHVsZUl0KCk7CiAgLy8gIkNsb3N1cmUiIHdpbGwgcHJpbnQgdHdpY2UsIGV2ZW4gdGhvdWdoIHdlJ3JlIHVzaW5nIGBFbWJlci5ydW4uc2NoZWR1bGVPbmNlYCwKICAvLyBiZWNhdXNlIHRoZSBmdW5jdGlvbiB3ZSBwYXNzIHRvIGl0IGlzIGFub255bW91cyBhbmQgd29uJ3QgbWF0Y2ggdGhlCiAgLy8gcHJldmlvdXNseSBzY2hlZHVsZWQgb3BlcmF0aW9uLgogIGBgYAoKICBBdmFpbGFibGUgcXVldWVzLCBhbmQgdGhlaXIgb3JkZXIsIGNhbiBiZSBmb3VuZCBhdCBgRW1iZXIucnVuLnF1ZXVlc2AKCiAgQG1ldGhvZCBzY2hlZHVsZU9uY2UKICBAcGFyYW0ge1N0cmluZ30gW3F1ZXVlXSBUaGUgbmFtZSBvZiB0aGUgcXVldWUgdG8gc2NoZWR1bGUgYWdhaW5zdC4gRGVmYXVsdCBxdWV1ZXMgYXJlICdzeW5jJyBhbmQgJ2FjdGlvbnMnLgogIEBwYXJhbSB7T2JqZWN0fSBbdGFyZ2V0XSBUaGUgdGFyZ2V0IG9mIHRoZSBtZXRob2QgdG8gaW52b2tlLgogIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBtZXRob2QgVGhlIG1ldGhvZCB0byBpbnZva2UuCiAgICBJZiB5b3UgcGFzcyBhIHN0cmluZyBpdCB3aWxsIGJlIHJlc29sdmVkIG9uIHRoZQogICAgdGFyZ2V0IGF0IHRoZSB0aW1lIHRoZSBtZXRob2QgaXMgaW52b2tlZC4KICBAcGFyYW0ge09iamVjdH0gW2FyZ3MqXSBPcHRpb25hbCBhcmd1bWVudHMgdG8gcGFzcyB0byB0aGUgdGltZW91dC4KICBAcmV0dXJuIHtPYmplY3R9IHRpbWVyCiovCkVtYmVyLnJ1bi5zY2hlZHVsZU9uY2UgPSBmdW5jdGlvbihxdWV1ZSwgdGFyZ2V0LCBtZXRob2QpIHsKICBjaGVja0F1dG9SdW4oKTsKICByZXR1cm4gYmFja2J1cm5lci5zY2hlZHVsZU9uY2UuYXBwbHkoYmFja2J1cm5lciwgYXJndW1lbnRzKTsKfTsKCi8qKgogIFNjaGVkdWxlcyBhbiBpdGVtIHRvIHJ1biBmcm9tIHdpdGhpbiBhIHNlcGFyYXRlIHJ1biBsb29wLCBhZnRlcgogIGNvbnRyb2wgaGFzIGJlZW4gcmV0dXJuZWQgdG8gdGhlIHN5c3RlbS4gVGhpcyBpcyBlcXVpdmFsZW50IHRvIGNhbGxpbmcKICBgRW1iZXIucnVuLmxhdGVyYCB3aXRoIGEgd2FpdCB0aW1lIG9mIDFtcy4KCiAgYGBgamF2YXNjcmlwdAogIEVtYmVyLnJ1bi5uZXh0KG15Q29udGV4dCwgZnVuY3Rpb24oKSB7CiAgICAvLyBjb2RlIHRvIGJlIGV4ZWN1dGVkIGluIHRoZSBuZXh0IHJ1biBsb29wLAogICAgLy8gd2hpY2ggd2lsbCBiZSBzY2hlZHVsZWQgYWZ0ZXIgdGhlIGN1cnJlbnQgb25lCiAgfSk7CiAgYGBgCgogIE11bHRpcGxlIG9wZXJhdGlvbnMgc2NoZWR1bGVkIHdpdGggYEVtYmVyLnJ1bi5uZXh0YCB3aWxsIGNvYWxlc2NlCiAgaW50byB0aGUgc2FtZSBsYXRlciBydW4gbG9vcCwgYWxvbmcgd2l0aCBhbnkgb3RoZXIgb3BlcmF0aW9ucwogIHNjaGVkdWxlZCBieSBgRW1iZXIucnVuLmxhdGVyYCB0aGF0IGV4cGlyZSByaWdodCBhcm91bmQgdGhlIHNhbWUKICB0aW1lIHRoYXQgYEVtYmVyLnJ1bi5uZXh0YCBvcGVyYXRpb25zIHdpbGwgZmlyZS4KCiAgTm90ZSB0aGF0IHRoZXJlIGFyZSBvZnRlbiBhbHRlcm5hdGl2ZXMgdG8gdXNpbmcgYEVtYmVyLnJ1bi5uZXh0YC4KICBGb3IgaW5zdGFuY2UsIGlmIHlvdSdkIGxpa2UgdG8gc2NoZWR1bGUgYW4gb3BlcmF0aW9uIHRvIGhhcHBlbgogIGFmdGVyIGFsbCBET00gZWxlbWVudCBvcGVyYXRpb25zIGhhdmUgY29tcGxldGVkIHdpdGhpbiB0aGUgY3VycmVudAogIHJ1biBsb29wLCB5b3UgY2FuIG1ha2UgdXNlIG9mIHRoZSBgYWZ0ZXJSZW5kZXJgIHJ1biBsb29wIHF1ZXVlIChhZGRlZAogIGJ5IHRoZSBgZW1iZXItdmlld3NgIHBhY2thZ2UsIGFsb25nIHdpdGggdGhlIHByZWNlZGluZyBgcmVuZGVyYCBxdWV1ZQogIHdoZXJlIGFsbCB0aGUgRE9NIGVsZW1lbnQgb3BlcmF0aW9ucyBoYXBwZW4pLiBFeGFtcGxlOgoKICBgYGBqYXZhc2NyaXB0CiAgQXBwLk15Q29sbGVjdGlvblZpZXcgPSBFbWJlci5Db2xsZWN0aW9uVmlldy5leHRlbmQoewogICAgZGlkSW5zZXJ0RWxlbWVudDogZnVuY3Rpb24oKSB7CiAgICAgIEVtYmVyLnJ1bi5zY2hlZHVsZU9uY2UoJ2FmdGVyUmVuZGVyJywgdGhpcywgJ3Byb2Nlc3NDaGlsZEVsZW1lbnRzJyk7CiAgICB9LAogICAgcHJvY2Vzc0NoaWxkRWxlbWVudHM6IGZ1bmN0aW9uKCkgewogICAgICAvLyAuLi4gZG8gc29tZXRoaW5nIHdpdGggY29sbGVjdGlvblZpZXcncyBjaGlsZCB2aWV3CiAgICAgIC8vIGVsZW1lbnRzIGFmdGVyIHRoZXkndmUgZmluaXNoZWQgcmVuZGVyaW5nLCB3aGljaAogICAgICAvLyBjYW4ndCBiZSBkb25lIHdpdGhpbiB0aGUgQ29sbGVjdGlvblZpZXcncwogICAgICAvLyBgZGlkSW5zZXJ0RWxlbWVudGAgaG9vayBiZWNhdXNlIHRoYXQgZ2V0cyBydW4KICAgICAgLy8gYmVmb3JlIHRoZSBjaGlsZCBlbGVtZW50cyBoYXZlIGJlZW4gYWRkZWQgdG8gdGhlIERPTS4KICAgIH0KICB9KTsKICBgYGAKCiAgT25lIGJlbmVmaXQgb2YgdGhlIGFib3ZlIGFwcHJvYWNoIGNvbXBhcmVkIHRvIHVzaW5nIGBFbWJlci5ydW4ubmV4dGAgaXMKICB0aGF0IHlvdSB3aWxsIGJlIGFibGUgdG8gcGVyZm9ybSBET00vQ1NTIG9wZXJhdGlvbnMgYmVmb3JlIHVucHJvY2Vzc2VkCiAgZWxlbWVudHMgYXJlIHJlbmRlcmVkIHRvIHRoZSBzY3JlZW4sIHdoaWNoIG1heSBwcmV2ZW50IGZsaWNrZXJpbmcgb3IKICBvdGhlciBhcnRpZmFjdHMgY2F1c2VkIGJ5IGRlbGF5aW5nIHByb2Nlc3NpbmcgdW50aWwgYWZ0ZXIgcmVuZGVyaW5nLgoKICBUaGUgb3RoZXIgbWFqb3IgYmVuZWZpdCB0byB0aGUgYWJvdmUgYXBwcm9hY2ggaXMgdGhhdCBgRW1iZXIucnVuLm5leHRgCiAgaW50cm9kdWNlcyBhbiBlbGVtZW50IG9mIG5vbi1kZXRlcm1pbmlzbSwgd2hpY2ggY2FuIG1ha2UgdGhpbmdzIG11Y2gKICBoYXJkZXIgdG8gdGVzdCwgZHVlIHRvIGl0cyByZWxpYW5jZSBvbiBgc2V0VGltZW91dGA7IGl0J3MgbXVjaCBoYXJkZXIKICB0byBndWFyYW50ZWUgdGhlIG9yZGVyIG9mIHNjaGVkdWxlZCBvcGVyYXRpb25zIHdoZW4gdGhleSBhcmUgc2NoZWR1bGVkCiAgb3V0c2lkZSBvZiB0aGUgY3VycmVudCBydW4gbG9vcCwgaS5lLiB3aXRoIGBFbWJlci5ydW4ubmV4dGAuCgogIEBtZXRob2QgbmV4dAogIEBwYXJhbSB7T2JqZWN0fSBbdGFyZ2V0XSB0YXJnZXQgb2YgbWV0aG9kIHRvIGludm9rZQogIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBtZXRob2QgVGhlIG1ldGhvZCB0byBpbnZva2UuCiAgICBJZiB5b3UgcGFzcyBhIHN0cmluZyBpdCB3aWxsIGJlIHJlc29sdmVkIG9uIHRoZQogICAgdGFyZ2V0IGF0IHRoZSB0aW1lIHRoZSBtZXRob2QgaXMgaW52b2tlZC4KICBAcGFyYW0ge09iamVjdH0gW2FyZ3MqXSBPcHRpb25hbCBhcmd1bWVudHMgdG8gcGFzcyB0byB0aGUgdGltZW91dC4KICBAcmV0dXJuIHtPYmplY3R9IHRpbWVyCiovCkVtYmVyLnJ1bi5uZXh0ID0gZnVuY3Rpb24oKSB7CiAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgYXJncy5wdXNoKDEpOwogIHJldHVybiBiYWNrYnVybmVyLmxhdGVyLmFwcGx5KGJhY2tidXJuZXIsIGFyZ3MpOwp9OwoKLyoqCiAgQ2FuY2VscyBhIHNjaGVkdWxlZCBpdGVtLiBNdXN0IGJlIGEgdmFsdWUgcmV0dXJuZWQgYnkgYEVtYmVyLnJ1bi5sYXRlcigpYCwKICBgRW1iZXIucnVuLm9uY2UoKWAsIG9yIGBFbWJlci5ydW4ubmV4dCgpYC4KCiAgYGBgamF2YXNjcmlwdAogIHZhciBydW5OZXh0ID0gRW1iZXIucnVuLm5leHQobXlDb250ZXh0LCBmdW5jdGlvbigpIHsKICAgIC8vIHdpbGwgbm90IGJlIGV4ZWN1dGVkCiAgfSk7CiAgRW1iZXIucnVuLmNhbmNlbChydW5OZXh0KTsKCiAgdmFyIHJ1bkxhdGVyID0gRW1iZXIucnVuLmxhdGVyKG15Q29udGV4dCwgZnVuY3Rpb24oKSB7CiAgICAvLyB3aWxsIG5vdCBiZSBleGVjdXRlZAogIH0sIDUwMCk7CiAgRW1iZXIucnVuLmNhbmNlbChydW5MYXRlcik7CgogIHZhciBydW5PbmNlID0gRW1iZXIucnVuLm9uY2UobXlDb250ZXh0LCBmdW5jdGlvbigpIHsKICAgIC8vIHdpbGwgbm90IGJlIGV4ZWN1dGVkCiAgfSk7CiAgRW1iZXIucnVuLmNhbmNlbChydW5PbmNlKTsKICBgYGAKCiAgQG1ldGhvZCBjYW5jZWwKICBAcGFyYW0ge09iamVjdH0gdGltZXIgVGltZXIgb2JqZWN0IHRvIGNhbmNlbAogIEByZXR1cm4ge3ZvaWR9CiovCkVtYmVyLnJ1bi5jYW5jZWwgPSBmdW5jdGlvbih0aW1lcikgewogIHJldHVybiBiYWNrYnVybmVyLmNhbmNlbCh0aW1lcik7Cn07CgovKioKICBEZWxheSBjYWxsaW5nIHRoZSB0YXJnZXQgbWV0aG9kIHVudGlsIHRoZSBkZWJvdW5jZSBwZXJpb2QgaGFzIGVsYXBzZWQKICB3aXRoIG5vIGFkZGl0aW9uYWwgZGVib3VuY2UgY2FsbHMuIElmIGBkZWJvdW5jZWAgaXMgY2FsbGVkIGFnYWluIGJlZm9yZQogIHRoZSBzcGVjaWZpZWQgdGltZSBoYXMgZWxhcHNlZCwgdGhlIHRpbWVyIGlzIHJlc2V0IGFuZCB0aGUgZW50aXJlIHBlcmlvZAogIG11c3QgcGFzcyBhZ2FpbiBiZWZvcmUgdGhlIHRhcmdldCBtZXRob2QgaXMgY2FsbGVkLgoKICBUaGlzIG1ldGhvZCBzaG91bGQgYmUgdXNlZCB3aGVuIGFuIGV2ZW50IG1heSBiZSBjYWxsZWQgbXVsdGlwbGUgdGltZXMKICBidXQgdGhlIGFjdGlvbiBzaG91bGQgb25seSBiZSBjYWxsZWQgb25jZSB3aGVuIHRoZSBldmVudCBpcyBkb25lIGZpcmluZy4KICBBIGNvbW1vbiBleGFtcGxlIGlzIGZvciBzY3JvbGwgZXZlbnRzIHdoZXJlIHlvdSBvbmx5IHdhbnQgdXBkYXRlcyB0bwogIGhhcHBlbiBvbmNlIHNjcm9sbGluZyBoYXMgY2Vhc2VkLgoKICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgbXlGdW5jID0gZnVuY3Rpb24oKSB7IGNvbnNvbGUubG9nKHRoaXMubmFtZSArICcgcmFuLicpOyB9OwogICAgdmFyIG15Q29udGV4dCA9IHtuYW1lOiAnZGVib3VuY2UnfTsKCiAgICBFbWJlci5ydW4uZGVib3VuY2UobXlDb250ZXh0LCBteUZ1bmMsIDE1MCk7CgogICAgLy8gbGVzcyB0aGFuIDE1MG1zIHBhc3NlcwoKICAgIEVtYmVyLnJ1bi5kZWJvdW5jZShteUNvbnRleHQsIG15RnVuYywgMTUwKTsKCiAgICAvLyAxNTBtcyBwYXNzZXMKICAgIC8vIG15RnVuYyBpcyBpbnZva2VkIHdpdGggY29udGV4dCBteUNvbnRleHQKICAgIC8vIGNvbnNvbGUgbG9ncyAnZGVib3VuY2UgcmFuLicgb25lIHRpbWUuCiAgYGBgCgogIEBtZXRob2QgZGVib3VuY2UKICBAcGFyYW0ge09iamVjdH0gW3RhcmdldF0gdGFyZ2V0IG9mIG1ldGhvZCB0byBpbnZva2UKICBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gbWV0aG9kIFRoZSBtZXRob2QgdG8gaW52b2tlLgogICAgTWF5IGJlIGEgZnVuY3Rpb24gb3IgYSBzdHJpbmcuIElmIHlvdSBwYXNzIGEgc3RyaW5nCiAgICB0aGVuIGl0IHdpbGwgYmUgbG9va2VkIHVwIG9uIHRoZSBwYXNzZWQgdGFyZ2V0LgogIEBwYXJhbSB7T2JqZWN0fSBbYXJncypdIE9wdGlvbmFsIGFyZ3VtZW50cyB0byBwYXNzIHRvIHRoZSB0aW1lb3V0LgogIEBwYXJhbSB7TnVtYmVyfSB3YWl0IE51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gd2FpdC4KICBAcGFyYW0ge0Jvb2xlYW59IGltbWVkaWF0ZSBUcmlnZ2VyIHRoZSBmdW5jdGlvbiBvbiB0aGUgbGVhZGluZyBpbnN0ZWFkIG9mIHRoZSB0cmFpbGluZyBlZGdlIG9mIHRoZSB3YWl0IGludGVydmFsLgogIEByZXR1cm4ge3ZvaWR9CiovCkVtYmVyLnJ1bi5kZWJvdW5jZSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiBiYWNrYnVybmVyLmRlYm91bmNlLmFwcGx5KGJhY2tidXJuZXIsIGFyZ3VtZW50cyk7Cn07CgovKioKICBFbnN1cmUgdGhhdCB0aGUgdGFyZ2V0IG1ldGhvZCBpcyBuZXZlciBjYWxsZWQgbW9yZSBmcmVxdWVudGx5IHRoYW4KICB0aGUgc3BlY2lmaWVkIHNwYWNpbmcgcGVyaW9kLgoKICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgbXlGdW5jID0gZnVuY3Rpb24oKSB7IGNvbnNvbGUubG9nKHRoaXMubmFtZSArICcgcmFuLicpOyB9OwogICAgdmFyIG15Q29udGV4dCA9IHtuYW1lOiAndGhyb3R0bGUnfTsKCiAgICBFbWJlci5ydW4udGhyb3R0bGUobXlDb250ZXh0LCBteUZ1bmMsIDE1MCk7CgogICAgLy8gNTBtcyBwYXNzZXMKICAgIEVtYmVyLnJ1bi50aHJvdHRsZShteUNvbnRleHQsIG15RnVuYywgMTUwKTsKCiAgICAvLyA1MG1zIHBhc3NlcwogICAgRW1iZXIucnVuLnRocm90dGxlKG15Q29udGV4dCwgbXlGdW5jLCAxNTApOwoKICAgIC8vIDUwbXMgcGFzc2VzCiAgICBFbWJlci5ydW4udGhyb3R0bGUobXlDb250ZXh0LCBteUZ1bmMsIDE1MCk7CgogICAgLy8gMTUwbXMgcGFzc2VzCiAgICAvLyBteUZ1bmMgaXMgaW52b2tlZCB3aXRoIGNvbnRleHQgbXlDb250ZXh0CiAgICAvLyBjb25zb2xlIGxvZ3MgJ3Rocm90dGxlIHJhbi4nIHR3aWNlLCAxNTBtcyBhcGFydC4KICBgYGAKCiAgQG1ldGhvZCB0aHJvdHRsZQogIEBwYXJhbSB7T2JqZWN0fSBbdGFyZ2V0XSB0YXJnZXQgb2YgbWV0aG9kIHRvIGludm9rZQogIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBtZXRob2QgVGhlIG1ldGhvZCB0byBpbnZva2UuCiAgICBNYXkgYmUgYSBmdW5jdGlvbiBvciBhIHN0cmluZy4gSWYgeW91IHBhc3MgYSBzdHJpbmcKICAgIHRoZW4gaXQgd2lsbCBiZSBsb29rZWQgdXAgb24gdGhlIHBhc3NlZCB0YXJnZXQuCiAgQHBhcmFtIHtPYmplY3R9IFthcmdzKl0gT3B0aW9uYWwgYXJndW1lbnRzIHRvIHBhc3MgdG8gdGhlIHRpbWVvdXQuCiAgQHBhcmFtIHtOdW1iZXJ9IHNwYWNpbmcgTnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byBzcGFjZSBvdXQgcmVxdWVzdHMuCiAgQHJldHVybiB7dm9pZH0KKi8KRW1iZXIucnVuLnRocm90dGxlID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIGJhY2tidXJuZXIudGhyb3R0bGUuYXBwbHkoYmFja2J1cm5lciwgYXJndW1lbnRzKTsKfTsKCi8vIE1ha2Ugc3VyZSBpdCdzIG5vdCBhbiBhdXRvcnVuIGR1cmluZyB0ZXN0aW5nCmZ1bmN0aW9uIGNoZWNrQXV0b1J1bigpIHsKICBpZiAoIUVtYmVyLnJ1bi5jdXJyZW50UnVuTG9vcCkgewogICAgRW1iZXIuYXNzZXJ0KCJZb3UgaGF2ZSB0dXJuZWQgb24gdGVzdGluZyBtb2RlLCB3aGljaCBkaXNhYmxlZCB0aGUgcnVuLWxvb3AncyBhdXRvcnVuLiBZb3Ugd2lsbCBuZWVkIHRvIHdyYXAgYW55IGNvZGUgd2l0aCBhc3luY2hyb25vdXMgc2lkZS1lZmZlY3RzIGluIGFuIEVtYmVyLnJ1biIsICFFbWJlci50ZXN0aW5nKTsKICB9Cn0KCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLy8gRW1iZXIuTG9nZ2VyCi8vIGdldAovLyBzZXQKLy8gZ3VpZEZvciwgbWV0YQovLyBhZGRPYnNlcnZlciwgcmVtb3ZlT2JzZXJ2ZXIKLy8gRW1iZXIucnVuLnNjaGVkdWxlCi8qKgpAbW9kdWxlIGVtYmVyLW1ldGFsCiovCgovLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCi8vIENPTlNUQU5UUwovLwoKLyoqCiAgRGVidWcgcGFyYW1ldGVyIHlvdSBjYW4gdHVybiBvbi4gVGhpcyB3aWxsIGxvZyBhbGwgYmluZGluZ3MgdGhhdCBmaXJlIHRvCiAgdGhlIGNvbnNvbGUuIFRoaXMgc2hvdWxkIGJlIGRpc2FibGVkIGluIHByb2R1Y3Rpb24gY29kZS4gTm90ZSB0aGF0IHlvdQogIGNhbiBhbHNvIGVuYWJsZSB0aGlzIGZyb20gdGhlIGNvbnNvbGUgb3IgdGVtcG9yYXJpbHkuCgogIEBwcm9wZXJ0eSBMT0dfQklORElOR1MKICBAZm9yIEVtYmVyCiAgQHR5cGUgQm9vbGVhbgogIEBkZWZhdWx0IGZhbHNlCiovCkVtYmVyLkxPR19CSU5ESU5HUyA9IGZhbHNlIHx8ICEhRW1iZXIuRU5WLkxPR19CSU5ESU5HUzsKCnZhciBnZXQgICAgID0gRW1iZXIuZ2V0LAogICAgc2V0ICAgICA9IEVtYmVyLnNldCwKICAgIGd1aWRGb3IgPSBFbWJlci5ndWlkRm9yLAogICAgSVNfR0xPQkFMID0gL14oW0EtWiRdfChbMC05XVtBLVokXSkpLzsKCi8qKgogIFJldHVybnMgdHJ1ZSBpZiB0aGUgcHJvdmlkZWQgcGF0aCBpcyBnbG9iYWwgKGUuZy4sIGBNeUFwcC5mb29Db250cm9sbGVyLmJhcmApCiAgaW5zdGVhZCBvZiBsb2NhbCAoYGZvby5iYXIuYmF6YCkuCgogIEBtZXRob2QgaXNHbG9iYWxQYXRoCiAgQGZvciBFbWJlcgogIEBwcml2YXRlCiAgQHBhcmFtIHtTdHJpbmd9IHBhdGgKICBAcmV0dXJuIEJvb2xlYW4KKi8KdmFyIGlzR2xvYmFsUGF0aCA9IEVtYmVyLmlzR2xvYmFsUGF0aCA9IGZ1bmN0aW9uKHBhdGgpIHsKICByZXR1cm4gSVNfR0xPQkFMLnRlc3QocGF0aCk7Cn07CgpmdW5jdGlvbiBnZXRXaXRoR2xvYmFscyhvYmosIHBhdGgpIHsKICByZXR1cm4gZ2V0KGlzR2xvYmFsUGF0aChwYXRoKSA/IEVtYmVyLmxvb2t1cCA6IG9iaiwgcGF0aCk7Cn0KCi8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KLy8gQklORElORwovLwoKdmFyIEJpbmRpbmcgPSBmdW5jdGlvbih0b1BhdGgsIGZyb21QYXRoKSB7CiAgdGhpcy5fZGlyZWN0aW9uID0gJ2Z3ZCc7CiAgdGhpcy5fZnJvbSA9IGZyb21QYXRoOwogIHRoaXMuX3RvICAgPSB0b1BhdGg7CiAgdGhpcy5fZGlyZWN0aW9uTWFwID0gRW1iZXIuTWFwLmNyZWF0ZSgpOwp9OwoKLyoqCkBjbGFzcyBCaW5kaW5nCkBuYW1lc3BhY2UgRW1iZXIKKi8KCkJpbmRpbmcucHJvdG90eXBlID0gewogIC8qKgogICAgVGhpcyBjb3BpZXMgdGhlIEJpbmRpbmcgc28gaXQgY2FuIGJlIGNvbm5lY3RlZCB0byBhbm90aGVyIG9iamVjdC4KCiAgICBAbWV0aG9kIGNvcHkKICAgIEByZXR1cm4ge0VtYmVyLkJpbmRpbmd9IGB0aGlzYAogICovCiAgY29weTogZnVuY3Rpb24gKCkgewogICAgdmFyIGNvcHkgPSBuZXcgQmluZGluZyh0aGlzLl90bywgdGhpcy5fZnJvbSk7CiAgICBpZiAodGhpcy5fb25lV2F5KSB7IGNvcHkuX29uZVdheSA9IHRydWU7IH0KICAgIHJldHVybiBjb3B5OwogIH0sCgogIC8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KICAvLyBDT05GSUcKICAvLwoKICAvKioKICAgIFRoaXMgd2lsbCBzZXQgYGZyb21gIHByb3BlcnR5IHBhdGggdG8gdGhlIHNwZWNpZmllZCB2YWx1ZS4gSXQgd2lsbCBub3QKICAgIGF0dGVtcHQgdG8gcmVzb2x2ZSB0aGlzIHByb3BlcnR5IHBhdGggdG8gYW4gYWN0dWFsIG9iamVjdCB1bnRpbCB5b3UKICAgIGNvbm5lY3QgdGhlIGJpbmRpbmcuCgogICAgVGhlIGJpbmRpbmcgd2lsbCBzZWFyY2ggZm9yIHRoZSBwcm9wZXJ0eSBwYXRoIHN0YXJ0aW5nIGF0IHRoZSByb290IG9iamVjdAogICAgeW91IHBhc3Mgd2hlbiB5b3UgYGNvbm5lY3QoKWAgdGhlIGJpbmRpbmcuIEl0IGZvbGxvd3MgdGhlIHNhbWUgcnVsZXMgYXMKICAgIGBnZXQoKWAgLSBzZWUgdGhhdCBtZXRob2QgZm9yIG1vcmUgaW5mb3JtYXRpb24uCgogICAgQG1ldGhvZCBmcm9tCiAgICBAcGFyYW0ge1N0cmluZ30gcGF0aCB0aGUgcHJvcGVydHkgcGF0aCB0byBjb25uZWN0IHRvCiAgICBAcmV0dXJuIHtFbWJlci5CaW5kaW5nfSBgdGhpc2AKICAqLwogIGZyb206IGZ1bmN0aW9uKHBhdGgpIHsKICAgIHRoaXMuX2Zyb20gPSBwYXRoOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICBUaGlzIHdpbGwgc2V0IHRoZSBgdG9gIHByb3BlcnR5IHBhdGggdG8gdGhlIHNwZWNpZmllZCB2YWx1ZS4gSXQgd2lsbCBub3QKICAgIGF0dGVtcHQgdG8gcmVzb2x2ZSB0aGlzIHByb3BlcnR5IHBhdGggdG8gYW4gYWN0dWFsIG9iamVjdCB1bnRpbCB5b3UKICAgIGNvbm5lY3QgdGhlIGJpbmRpbmcuCgogICAgVGhlIGJpbmRpbmcgd2lsbCBzZWFyY2ggZm9yIHRoZSBwcm9wZXJ0eSBwYXRoIHN0YXJ0aW5nIGF0IHRoZSByb290IG9iamVjdAogICAgeW91IHBhc3Mgd2hlbiB5b3UgYGNvbm5lY3QoKWAgdGhlIGJpbmRpbmcuIEl0IGZvbGxvd3MgdGhlIHNhbWUgcnVsZXMgYXMKICAgIGBnZXQoKWAgLSBzZWUgdGhhdCBtZXRob2QgZm9yIG1vcmUgaW5mb3JtYXRpb24uCgogICAgQG1ldGhvZCB0bwogICAgQHBhcmFtIHtTdHJpbmd8VHVwbGV9IHBhdGggQSBwcm9wZXJ0eSBwYXRoIG9yIHR1cGxlCiAgICBAcmV0dXJuIHtFbWJlci5CaW5kaW5nfSBgdGhpc2AKICAqLwogIHRvOiBmdW5jdGlvbihwYXRoKSB7CiAgICB0aGlzLl90byA9IHBhdGg7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvKioKICAgIENvbmZpZ3VyZXMgdGhlIGJpbmRpbmcgYXMgb25lIHdheS4gQSBvbmUtd2F5IGJpbmRpbmcgd2lsbCByZWxheSBjaGFuZ2VzCiAgICBvbiB0aGUgYGZyb21gIHNpZGUgdG8gdGhlIGB0b2Agc2lkZSwgYnV0IG5vdCB0aGUgb3RoZXIgd2F5IGFyb3VuZC4gVGhpcwogICAgbWVhbnMgdGhhdCBpZiB5b3UgY2hhbmdlIHRoZSBgdG9gIHNpZGUgZGlyZWN0bHksIHRoZSBgZnJvbWAgc2lkZSBtYXkgaGF2ZQogICAgYSBkaWZmZXJlbnQgdmFsdWUuCgogICAgQG1ldGhvZCBvbmVXYXkKICAgIEByZXR1cm4ge0VtYmVyLkJpbmRpbmd9IGB0aGlzYAogICovCiAgb25lV2F5OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX29uZVdheSA9IHRydWU7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvKioKICAgIEBtZXRob2QgdG9TdHJpbmcKICAgIEByZXR1cm4ge1N0cmluZ30gc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIGJpbmRpbmcKICAqLwogIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgIHZhciBvbmVXYXkgPSB0aGlzLl9vbmVXYXkgPyAnW29uZVdheV0nIDogJyc7CiAgICByZXR1cm4gIkVtYmVyLkJpbmRpbmc8IiArIGd1aWRGb3IodGhpcykgKyAiPigiICsgdGhpcy5fZnJvbSArICIgLT4gIiArIHRoaXMuX3RvICsgIikiICsgb25lV2F5OwogIH0sCgogIC8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KICAvLyBDT05ORUNUIEFORCBTWU5DCiAgLy8KCiAgLyoqCiAgICBBdHRlbXB0cyB0byBjb25uZWN0IHRoaXMgYmluZGluZyBpbnN0YW5jZSBzbyB0aGF0IGl0IGNhbiByZWNlaXZlIGFuZCByZWxheQogICAgY2hhbmdlcy4gVGhpcyBtZXRob2Qgd2lsbCByYWlzZSBhbiBleGNlcHRpb24gaWYgeW91IGhhdmUgbm90IHNldCB0aGUKICAgIGZyb20vdG8gcHJvcGVydGllcyB5ZXQuCgogICAgQG1ldGhvZCBjb25uZWN0CiAgICBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSByb290IG9iamVjdCBmb3IgdGhpcyBiaW5kaW5nLgogICAgQHJldHVybiB7RW1iZXIuQmluZGluZ30gYHRoaXNgCiAgKi8KICBjb25uZWN0OiBmdW5jdGlvbihvYmopIHsKICAgIEVtYmVyLmFzc2VydCgnTXVzdCBwYXNzIGEgdmFsaWQgb2JqZWN0IHRvIEVtYmVyLkJpbmRpbmcuY29ubmVjdCgpJywgISFvYmopOwoKICAgIHZhciBmcm9tUGF0aCA9IHRoaXMuX2Zyb20sIHRvUGF0aCA9IHRoaXMuX3RvOwogICAgRW1iZXIudHJ5U2V0KG9iaiwgdG9QYXRoLCBnZXRXaXRoR2xvYmFscyhvYmosIGZyb21QYXRoKSk7CgogICAgLy8gYWRkIGFuIG9ic2VydmVyIG9uIHRoZSBvYmplY3QgdG8gYmUgbm90aWZpZWQgd2hlbiB0aGUgYmluZGluZyBzaG91bGQgYmUgdXBkYXRlZAogICAgRW1iZXIuYWRkT2JzZXJ2ZXIob2JqLCBmcm9tUGF0aCwgdGhpcywgdGhpcy5mcm9tRGlkQ2hhbmdlKTsKCiAgICAvLyBpZiB0aGUgYmluZGluZyBpcyBhIHR3by13YXkgYmluZGluZywgYWxzbyBzZXQgdXAgYW4gb2JzZXJ2ZXIgb24gdGhlIHRhcmdldAogICAgaWYgKCF0aGlzLl9vbmVXYXkpIHsgRW1iZXIuYWRkT2JzZXJ2ZXIob2JqLCB0b1BhdGgsIHRoaXMsIHRoaXMudG9EaWRDaGFuZ2UpOyB9CgogICAgdGhpcy5fcmVhZHlUb1N5bmMgPSB0cnVlOwoKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAgRGlzY29ubmVjdHMgdGhlIGJpbmRpbmcgaW5zdGFuY2UuIENoYW5nZXMgd2lsbCBubyBsb25nZXIgYmUgcmVsYXllZC4gWW91CiAgICB3aWxsIG5vdCB1c3VhbGx5IG5lZWQgdG8gY2FsbCB0aGlzIG1ldGhvZC4KCiAgICBAbWV0aG9kIGRpc2Nvbm5lY3QKICAgIEBwYXJhbSB7T2JqZWN0fSBvYmogVGhlIHJvb3Qgb2JqZWN0IHlvdSBwYXNzZWQgd2hlbiBjb25uZWN0aW5nIHRoZSBiaW5kaW5nLgogICAgQHJldHVybiB7RW1iZXIuQmluZGluZ30gYHRoaXNgCiAgKi8KICBkaXNjb25uZWN0OiBmdW5jdGlvbihvYmopIHsKICAgIEVtYmVyLmFzc2VydCgnTXVzdCBwYXNzIGEgdmFsaWQgb2JqZWN0IHRvIEVtYmVyLkJpbmRpbmcuZGlzY29ubmVjdCgpJywgISFvYmopOwoKICAgIHZhciB0d29XYXkgPSAhdGhpcy5fb25lV2F5OwoKICAgIC8vIHJlbW92ZSBhbiBvYnNlcnZlciBvbiB0aGUgb2JqZWN0IHNvIHdlJ3JlIG5vIGxvbmdlciBub3RpZmllZCBvZgogICAgLy8gY2hhbmdlcyB0aGF0IHNob3VsZCB1cGRhdGUgYmluZGluZ3MuCiAgICBFbWJlci5yZW1vdmVPYnNlcnZlcihvYmosIHRoaXMuX2Zyb20sIHRoaXMsIHRoaXMuZnJvbURpZENoYW5nZSk7CgogICAgLy8gaWYgdGhlIGJpbmRpbmcgaXMgdHdvLXdheSwgcmVtb3ZlIHRoZSBvYnNlcnZlciBmcm9tIHRoZSB0YXJnZXQgYXMgd2VsbAogICAgaWYgKHR3b1dheSkgeyBFbWJlci5yZW1vdmVPYnNlcnZlcihvYmosIHRoaXMuX3RvLCB0aGlzLCB0aGlzLnRvRGlkQ2hhbmdlKTsgfQoKICAgIHRoaXMuX3JlYWR5VG9TeW5jID0gZmFsc2U7IC8vIGRpc2FibGUgc2NoZWR1bGVkIHN5bmNzLi4uCiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCiAgLy8gUFJJVkFURQogIC8vCgogIC8qIGNhbGxlZCB3aGVuIHRoZSBmcm9tIHNpZGUgY2hhbmdlcyAqLwogIGZyb21EaWRDaGFuZ2U6IGZ1bmN0aW9uKHRhcmdldCkgewogICAgdGhpcy5fc2NoZWR1bGVTeW5jKHRhcmdldCwgJ2Z3ZCcpOwogIH0sCgogIC8qIGNhbGxlZCB3aGVuIHRoZSB0byBzaWRlIGNoYW5nZXMgKi8KICB0b0RpZENoYW5nZTogZnVuY3Rpb24odGFyZ2V0KSB7CiAgICB0aGlzLl9zY2hlZHVsZVN5bmModGFyZ2V0LCAnYmFjaycpOwogIH0sCgogIF9zY2hlZHVsZVN5bmM6IGZ1bmN0aW9uKG9iaiwgZGlyKSB7CiAgICB2YXIgZGlyZWN0aW9uTWFwID0gdGhpcy5fZGlyZWN0aW9uTWFwOwogICAgdmFyIGV4aXN0aW5nRGlyID0gZGlyZWN0aW9uTWFwLmdldChvYmopOwoKICAgIC8vIGlmIHdlIGhhdmVuJ3Qgc2NoZWR1bGVkIHRoZSBiaW5kaW5nIHlldCwgc2NoZWR1bGUgaXQKICAgIGlmICghZXhpc3RpbmdEaXIpIHsKICAgICAgRW1iZXIucnVuLnNjaGVkdWxlKCdzeW5jJywgdGhpcywgdGhpcy5fc3luYywgb2JqKTsKICAgICAgZGlyZWN0aW9uTWFwLnNldChvYmosIGRpcik7CiAgICB9CgogICAgLy8gSWYgYm90aCBhICdiYWNrJyBhbmQgJ2Z3ZCcgc3luYyBoYXZlIGJlZW4gc2NoZWR1bGVkIG9uIHRoZSBzYW1lIG9iamVjdCwKICAgIC8vIGRlZmF1bHQgdG8gYSAnZndkJyBzeW5jIHNvIHRoYXQgaXQgcmVtYWlucyBkZXRlcm1pbmlzdGljLgogICAgaWYgKGV4aXN0aW5nRGlyID09PSAnYmFjaycgJiYgZGlyID09PSAnZndkJykgewogICAgICBkaXJlY3Rpb25NYXAuc2V0KG9iaiwgJ2Z3ZCcpOwogICAgfQogIH0sCgogIF9zeW5jOiBmdW5jdGlvbihvYmopIHsKICAgIHZhciBsb2cgPSBFbWJlci5MT0dfQklORElOR1M7CgogICAgLy8gZG9uJ3Qgc3luY2hyb25pemUgZGVzdHJveWVkIG9iamVjdHMgb3IgZGlzY29ubmVjdGVkIGJpbmRpbmdzCiAgICBpZiAob2JqLmlzRGVzdHJveWVkIHx8ICF0aGlzLl9yZWFkeVRvU3luYykgeyByZXR1cm47IH0KCiAgICAvLyBnZXQgdGhlIGRpcmVjdGlvbiBvZiB0aGUgYmluZGluZyBmb3IgdGhlIG9iamVjdCB3ZSBhcmUKICAgIC8vIHN5bmNocm9uaXppbmcgZnJvbQogICAgdmFyIGRpcmVjdGlvbk1hcCA9IHRoaXMuX2RpcmVjdGlvbk1hcDsKICAgIHZhciBkaXJlY3Rpb24gPSBkaXJlY3Rpb25NYXAuZ2V0KG9iaik7CgogICAgdmFyIGZyb21QYXRoID0gdGhpcy5fZnJvbSwgdG9QYXRoID0gdGhpcy5fdG87CgogICAgZGlyZWN0aW9uTWFwLnJlbW92ZShvYmopOwoKICAgIC8vIGlmIHdlJ3JlIHN5bmNocm9uaXppbmcgZnJvbSB0aGUgcmVtb3RlIG9iamVjdC4uLgogICAgaWYgKGRpcmVjdGlvbiA9PT0gJ2Z3ZCcpIHsKICAgICAgdmFyIGZyb21WYWx1ZSA9IGdldFdpdGhHbG9iYWxzKG9iaiwgdGhpcy5fZnJvbSk7CiAgICAgIGlmIChsb2cpIHsKICAgICAgICBFbWJlci5Mb2dnZXIubG9nKCcgJywgdGhpcy50b1N0cmluZygpLCAnLT4nLCBmcm9tVmFsdWUsIG9iaik7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuX29uZVdheSkgewogICAgICAgIEVtYmVyLnRyeVNldChvYmosIHRvUGF0aCwgZnJvbVZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBFbWJlci5fc3VzcGVuZE9ic2VydmVyKG9iaiwgdG9QYXRoLCB0aGlzLCB0aGlzLnRvRGlkQ2hhbmdlLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBFbWJlci50cnlTZXQob2JqLCB0b1BhdGgsIGZyb21WYWx1ZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIC8vIGlmIHdlJ3JlIHN5bmNocm9uaXppbmcgKnRvKiB0aGUgcmVtb3RlIG9iamVjdAogICAgfSBlbHNlIGlmIChkaXJlY3Rpb24gPT09ICdiYWNrJykgewogICAgICB2YXIgdG9WYWx1ZSA9IGdldChvYmosIHRoaXMuX3RvKTsKICAgICAgaWYgKGxvZykgewogICAgICAgIEVtYmVyLkxvZ2dlci5sb2coJyAnLCB0aGlzLnRvU3RyaW5nKCksICc8LScsIHRvVmFsdWUsIG9iaik7CiAgICAgIH0KICAgICAgRW1iZXIuX3N1c3BlbmRPYnNlcnZlcihvYmosIGZyb21QYXRoLCB0aGlzLCB0aGlzLmZyb21EaWRDaGFuZ2UsIGZ1bmN0aW9uICgpIHsKICAgICAgICBFbWJlci50cnlTZXQoRW1iZXIuaXNHbG9iYWxQYXRoKGZyb21QYXRoKSA/IEVtYmVyLmxvb2t1cCA6IG9iaiwgZnJvbVBhdGgsIHRvVmFsdWUpOwogICAgICB9KTsKICAgIH0KICB9Cgp9OwoKZnVuY3Rpb24gbWl4aW5Qcm9wZXJ0aWVzKHRvLCBmcm9tKSB7CiAgZm9yICh2YXIga2V5IGluIGZyb20pIHsKICAgIGlmIChmcm9tLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgdG9ba2V5XSA9IGZyb21ba2V5XTsKICAgIH0KICB9Cn0KCm1peGluUHJvcGVydGllcyhCaW5kaW5nLCB7CgogIC8qCiAgICBTZWUgYEVtYmVyLkJpbmRpbmcuZnJvbWAuCgogICAgQG1ldGhvZCBmcm9tCiAgICBAc3RhdGljCiAgKi8KICBmcm9tOiBmdW5jdGlvbigpIHsKICAgIHZhciBDID0gdGhpcywgYmluZGluZyA9IG5ldyBDKCk7CiAgICByZXR1cm4gYmluZGluZy5mcm9tLmFwcGx5KGJpbmRpbmcsIGFyZ3VtZW50cyk7CiAgfSwKCiAgLyoKICAgIFNlZSBgRW1iZXIuQmluZGluZy50b2AuCgogICAgQG1ldGhvZCB0bwogICAgQHN0YXRpYwogICovCiAgdG86IGZ1bmN0aW9uKCkgewogICAgdmFyIEMgPSB0aGlzLCBiaW5kaW5nID0gbmV3IEMoKTsKICAgIHJldHVybiBiaW5kaW5nLnRvLmFwcGx5KGJpbmRpbmcsIGFyZ3VtZW50cyk7CiAgfSwKCiAgLyoqCiAgICBDcmVhdGVzIGEgbmV3IEJpbmRpbmcgaW5zdGFuY2UgYW5kIG1ha2VzIGl0IGFwcGx5IGluIGEgc2luZ2xlIGRpcmVjdGlvbi4KICAgIEEgb25lLXdheSBiaW5kaW5nIHdpbGwgcmVsYXkgY2hhbmdlcyBvbiB0aGUgYGZyb21gIHNpZGUgb2JqZWN0IChzdXBwbGllZAogICAgYXMgdGhlIGBmcm9tYCBhcmd1bWVudCkgdGhlIGB0b2Agc2lkZSwgYnV0IG5vdCB0aGUgb3RoZXIgd2F5IGFyb3VuZC4KICAgIFRoaXMgbWVhbnMgdGhhdCBpZiB5b3UgY2hhbmdlIHRoZSAidG8iIHNpZGUgZGlyZWN0bHksIHRoZSAiZnJvbSIgc2lkZSBtYXkgaGF2ZQogICAgYSBkaWZmZXJlbnQgdmFsdWUuCgogICAgU2VlIGBCaW5kaW5nLm9uZVdheWAuCgogICAgQG1ldGhvZCBvbmVXYXkKICAgIEBwYXJhbSB7U3RyaW5nfSBmcm9tIGZyb20gcGF0aC4KICAgIEBwYXJhbSB7Qm9vbGVhbn0gW2ZsYWddIChPcHRpb25hbCkgcGFzc2luZyBub3RoaW5nIGhlcmUgd2lsbCBtYWtlIHRoZQogICAgICBiaW5kaW5nIGBvbmVXYXlgLiBZb3UgY2FuIGluc3RlYWQgcGFzcyBgZmFsc2VgIHRvIGRpc2FibGUgYG9uZVdheWAsIG1ha2luZyB0aGUKICAgICAgYmluZGluZyB0d28gd2F5IGFnYWluLgogICAgQHJldHVybiB7RW1iZXIuQmluZGluZ30gYHRoaXNgCiAgKi8KICBvbmVXYXk6IGZ1bmN0aW9uKGZyb20sIGZsYWcpIHsKICAgIHZhciBDID0gdGhpcywgYmluZGluZyA9IG5ldyBDKG51bGwsIGZyb20pOwogICAgcmV0dXJuIGJpbmRpbmcub25lV2F5KGZsYWcpOwogIH0KCn0pOwoKLyoqCiAgQW4gYEVtYmVyLkJpbmRpbmdgIGNvbm5lY3RzIHRoZSBwcm9wZXJ0aWVzIG9mIHR3byBvYmplY3RzIHNvIHRoYXQgd2hlbmV2ZXIKICB0aGUgdmFsdWUgb2Ygb25lIHByb3BlcnR5IGNoYW5nZXMsIHRoZSBvdGhlciBwcm9wZXJ0eSB3aWxsIGJlIGNoYW5nZWQgYWxzby4KCiAgIyMgQXV0b21hdGljIENyZWF0aW9uIG9mIEJpbmRpbmdzIHdpdGggYC9eKkJpbmRpbmcvYC1uYW1lZCBQcm9wZXJ0aWVzCgogIFlvdSBkbyBub3QgdXN1YWxseSBjcmVhdGUgQmluZGluZyBvYmplY3RzIGRpcmVjdGx5IGJ1dCBpbnN0ZWFkIGRlc2NyaWJlCiAgYmluZGluZ3MgaW4geW91ciBjbGFzcyBvciBvYmplY3QgZGVmaW5pdGlvbiB1c2luZyBhdXRvbWF0aWMgYmluZGluZwogIGRldGVjdGlvbi4KCiAgUHJvcGVydGllcyBlbmRpbmcgaW4gYSBgQmluZGluZ2Agc3VmZml4IHdpbGwgYmUgY29udmVydGVkIHRvIGBFbWJlci5CaW5kaW5nYAogIGluc3RhbmNlcy4gVGhlIHZhbHVlIG9mIHRoaXMgcHJvcGVydHkgc2hvdWxkIGJlIGEgc3RyaW5nIHJlcHJlc2VudGluZyBhIHBhdGgKICB0byBhbm90aGVyIG9iamVjdCBvciBhIGN1c3RvbSBiaW5kaW5nIGluc3RhbmNlZCBjcmVhdGVkIHVzaW5nIEJpbmRpbmcgaGVscGVycwogIChzZWUgIk9uZSBXYXkgQmluZGluZ3MiKToKCiAgYGBgCiAgdmFsdWVCaW5kaW5nOiAiTXlBcHAuc29tZUNvbnRyb2xsZXIudGl0bGUiCiAgYGBgCgogIFRoaXMgd2lsbCBjcmVhdGUgYSBiaW5kaW5nIGZyb20gYE15QXBwLnNvbWVDb250cm9sbGVyLnRpdGxlYCB0byB0aGUgYHZhbHVlYAogIHByb3BlcnR5IG9mIHlvdXIgb2JqZWN0IGluc3RhbmNlIGF1dG9tYXRpY2FsbHkuIE5vdyB0aGUgdHdvIHZhbHVlcyB3aWxsIGJlCiAga2VwdCBpbiBzeW5jLgoKICAjIyBPbmUgV2F5IEJpbmRpbmdzCgogIE9uZSBlc3BlY2lhbGx5IHVzZWZ1bCBiaW5kaW5nIGN1c3RvbWl6YXRpb24geW91IGNhbiB1c2UgaXMgdGhlIGBvbmVXYXkoKWAKICBoZWxwZXIuIFRoaXMgaGVscGVyIHRlbGxzIEVtYmVyIHRoYXQgeW91IGFyZSBvbmx5IGludGVyZXN0ZWQgaW4KICByZWNlaXZpbmcgY2hhbmdlcyBvbiB0aGUgb2JqZWN0IHlvdSBhcmUgYmluZGluZyBmcm9tLiBGb3IgZXhhbXBsZSwgaWYgeW91CiAgYXJlIGJpbmRpbmcgdG8gYSBwcmVmZXJlbmNlIGFuZCB5b3Ugd2FudCB0byBiZSBub3RpZmllZCBpZiB0aGUgcHJlZmVyZW5jZQogIGhhcyBjaGFuZ2VkLCBidXQgeW91ciBvYmplY3Qgd2lsbCBub3QgYmUgY2hhbmdpbmcgdGhlIHByZWZlcmVuY2UgaXRzZWxmLCB5b3UKICBjb3VsZCBkbzoKCiAgYGBgCiAgYmlnVGl0bGVzQmluZGluZzogRW1iZXIuQmluZGluZy5vbmVXYXkoIk15QXBwLnByZWZlcmVuY2VzQ29udHJvbGxlci5iaWdUaXRsZXMiKQogIGBgYAoKICBUaGlzIHdheSBpZiB0aGUgdmFsdWUgb2YgYE15QXBwLnByZWZlcmVuY2VzQ29udHJvbGxlci5iaWdUaXRsZXNgIGNoYW5nZXMgdGhlCiAgYGJpZ1RpdGxlc2AgcHJvcGVydHkgb2YgeW91ciBvYmplY3Qgd2lsbCBjaGFuZ2UgYWxzby4gSG93ZXZlciwgaWYgeW91CiAgY2hhbmdlIHRoZSB2YWx1ZSBvZiB5b3VyIGBiaWdUaXRsZXNgIHByb3BlcnR5LCBpdCB3aWxsIG5vdCB1cGRhdGUgdGhlCiAgYHByZWZlcmVuY2VzQ29udHJvbGxlcmAuCgogIE9uZSB3YXkgYmluZGluZ3MgYXJlIGFsbW9zdCB0d2ljZSBhcyBmYXN0IHRvIHNldHVwIGFuZCB0d2ljZSBhcyBmYXN0IHRvCiAgZXhlY3V0ZSBiZWNhdXNlIHRoZSBiaW5kaW5nIG9ubHkgaGFzIHRvIHdvcnJ5IGFib3V0IGNoYW5nZXMgdG8gb25lIHNpZGUuCgogIFlvdSBzaG91bGQgY29uc2lkZXIgdXNpbmcgb25lIHdheSBiaW5kaW5ncyBhbnl0aW1lIHlvdSBoYXZlIGFuIG9iamVjdCB0aGF0CiAgbWF5IGJlIGNyZWF0ZWQgZnJlcXVlbnRseSBhbmQgeW91IGRvIG5vdCBpbnRlbmQgdG8gY2hhbmdlIGEgcHJvcGVydHk7IG9ubHkKICB0byBtb25pdG9yIGl0IGZvciBjaGFuZ2VzIChzdWNoIGFzIGluIHRoZSBleGFtcGxlIGFib3ZlKS4KCiAgIyMgQWRkaW5nIEJpbmRpbmdzIE1hbnVhbGx5CgogIEFsbCBvZiB0aGUgZXhhbXBsZXMgYWJvdmUgc2hvdyB5b3UgaG93IHRvIGNvbmZpZ3VyZSBhIGN1c3RvbSBiaW5kaW5nLCBidXQgdGhlCiAgcmVzdWx0IG9mIHRoZXNlIGN1c3RvbWl6YXRpb25zIHdpbGwgYmUgYSBiaW5kaW5nIHRlbXBsYXRlLCBub3QgYSBmdWxseSBhY3RpdmUKICBCaW5kaW5nIGluc3RhbmNlLiBUaGUgYmluZGluZyB3aWxsIGFjdHVhbGx5IGJlY29tZSBhY3RpdmUgb25seSB3aGVuIHlvdQogIGluc3RhbnRpYXRlIHRoZSBvYmplY3QgdGhlIGJpbmRpbmcgYmVsb25ncyB0by4gSXQgaXMgdXNlZnVsIGhvd2V2ZXIsIHRvCiAgdW5kZXJzdGFuZCB3aGF0IGFjdHVhbGx5IGhhcHBlbnMgd2hlbiB0aGUgYmluZGluZyBpcyBhY3RpdmF0ZWQuCgogIEZvciBhIGJpbmRpbmcgdG8gZnVuY3Rpb24gaXQgbXVzdCBoYXZlIGF0IGxlYXN0IGEgYGZyb21gIHByb3BlcnR5IGFuZCBhIGB0b2AKICBwcm9wZXJ0eS4gVGhlIGBmcm9tYCBwcm9wZXJ0eSBwYXRoIHBvaW50cyB0byB0aGUgb2JqZWN0L2tleSB0aGF0IHlvdSB3YW50IHRvCiAgYmluZCBmcm9tIHdoaWxlIHRoZSBgdG9gIHBhdGggcG9pbnRzIHRvIHRoZSBvYmplY3Qva2V5IHlvdSB3YW50IHRvIGJpbmQgdG8uCgogIFdoZW4geW91IGRlZmluZSBhIGN1c3RvbSBiaW5kaW5nLCB5b3UgYXJlIHVzdWFsbHkgZGVzY3JpYmluZyB0aGUgcHJvcGVydHkKICB5b3Ugd2FudCB0byBiaW5kIGZyb20gKHN1Y2ggYXMgYE15QXBwLnNvbWVDb250cm9sbGVyLnZhbHVlYCBpbiB0aGUgZXhhbXBsZXMKICBhYm92ZSkuIFdoZW4geW91ciBvYmplY3QgaXMgY3JlYXRlZCwgaXQgd2lsbCBhdXRvbWF0aWNhbGx5IGFzc2lnbiB0aGUgdmFsdWUKICB5b3Ugd2FudCB0byBiaW5kIGB0b2AgYmFzZWQgb24gdGhlIG5hbWUgb2YgeW91ciBiaW5kaW5nIGtleS4gSW4gdGhlCiAgZXhhbXBsZXMgYWJvdmUsIGR1cmluZyBpbml0LCBFbWJlciBvYmplY3RzIHdpbGwgZWZmZWN0aXZlbHkgY2FsbAogIHNvbWV0aGluZyBsaWtlIHRoaXMgb24geW91ciBiaW5kaW5nOgoKICBgYGBqYXZhc2NyaXB0CiAgYmluZGluZyA9IEVtYmVyLkJpbmRpbmcuZnJvbSh0aGlzLnZhbHVlQmluZGluZykudG8oInZhbHVlIik7CiAgYGBgCgogIFRoaXMgY3JlYXRlcyBhIG5ldyBiaW5kaW5nIGluc3RhbmNlIGJhc2VkIG9uIHRoZSB0ZW1wbGF0ZSB5b3UgcHJvdmlkZSwgYW5kCiAgc2V0cyB0aGUgdG8gcGF0aCB0byB0aGUgYHZhbHVlYCBwcm9wZXJ0eSBvZiB0aGUgbmV3IG9iamVjdC4gTm93IHRoYXQgdGhlCiAgYmluZGluZyBpcyBmdWxseSBjb25maWd1cmVkIHdpdGggYSBgZnJvbWAgYW5kIGEgYHRvYCwgaXQgc2ltcGx5IG5lZWRzIHRvIGJlCiAgY29ubmVjdGVkIHRvIGJlY29tZSBhY3RpdmUuIFRoaXMgaXMgZG9uZSB0aHJvdWdoIHRoZSBgY29ubmVjdCgpYCBtZXRob2Q6CgogIGBgYGphdmFzY3JpcHQKICBiaW5kaW5nLmNvbm5lY3QodGhpcyk7CiAgYGBgCgogIE5vdGUgdGhhdCB3aGVuIHlvdSBjb25uZWN0IGEgYmluZGluZyB5b3UgcGFzcyB0aGUgb2JqZWN0IHlvdSB3YW50IGl0IHRvIGJlCiAgY29ubmVjdGVkIHRvLiBUaGlzIG9iamVjdCB3aWxsIGJlIHVzZWQgYXMgdGhlIHJvb3QgZm9yIGJvdGggdGhlIGZyb20gYW5kCiAgdG8gc2lkZSBvZiB0aGUgYmluZGluZyB3aGVuIGluc3BlY3RpbmcgcmVsYXRpdmUgcGF0aHMuIFRoaXMgYWxsb3dzIHRoZQogIGJpbmRpbmcgdG8gYmUgYXV0b21hdGljYWxseSBpbmhlcml0ZWQgYnkgc3ViY2xhc3NlZCBvYmplY3RzIGFzIHdlbGwuCgogIE5vdyB0aGF0IHRoZSBiaW5kaW5nIGlzIGNvbm5lY3RlZCwgaXQgd2lsbCBvYnNlcnZlIGJvdGggdGhlIGZyb20gYW5kIHRvIHNpZGUKICBhbmQgcmVsYXkgY2hhbmdlcy4KCiAgSWYgeW91IGV2ZXIgbmVlZGVkIHRvIGRvIHNvICh5b3UgYWxtb3N0IG5ldmVyIHdpbGwsIGJ1dCBpdCBpcyB1c2VmdWwgdG8KICB1bmRlcnN0YW5kIHRoaXMgYW55d2F5KSwgeW91IGNvdWxkIG1hbnVhbGx5IGNyZWF0ZSBhbiBhY3RpdmUgYmluZGluZyBieQogIHVzaW5nIHRoZSBgRW1iZXIuYmluZCgpYCBoZWxwZXIgbWV0aG9kLiAoVGhpcyBpcyB0aGUgc2FtZSBtZXRob2QgdXNlZCBieQogIHRvIHNldHVwIHlvdXIgYmluZGluZ3Mgb24gb2JqZWN0cyk6CgogIGBgYGphdmFzY3JpcHQKICBFbWJlci5iaW5kKE15QXBwLmFub3RoZXJPYmplY3QsICJ2YWx1ZSIsICJNeUFwcC5zb21lQ29udHJvbGxlci52YWx1ZSIpOwogIGBgYAoKICBCb3RoIG9mIHRoZXNlIGNvZGUgZnJhZ21lbnRzIGhhdmUgdGhlIHNhbWUgZWZmZWN0IGFzIGRvaW5nIHRoZSBtb3N0IGZyaWVuZGx5CiAgZm9ybSBvZiBiaW5kaW5nIGNyZWF0aW9uIGxpa2Ugc286CgogIGBgYGphdmFzY3JpcHQKICBNeUFwcC5hbm90aGVyT2JqZWN0ID0gRW1iZXIuT2JqZWN0LmNyZWF0ZSh7CiAgICB2YWx1ZUJpbmRpbmc6ICJNeUFwcC5zb21lQ29udHJvbGxlci52YWx1ZSIsCgogICAgLy8gT1RIRVIgQ09ERSBGT1IgVEhJUyBPQkpFQ1QuLi4KICB9KTsKICBgYGAKCiAgRW1iZXIncyBidWlsdCBpbiBiaW5kaW5nIGNyZWF0aW9uIG1ldGhvZCBtYWtlcyBpdCBlYXN5IHRvIGF1dG9tYXRpY2FsbHkKICBjcmVhdGUgYmluZGluZ3MgZm9yIHlvdS4gWW91IHNob3VsZCBhbHdheXMgdXNlIHRoZSBoaWdoZXN0LWxldmVsIEFQSXMKICBhdmFpbGFibGUsIGV2ZW4gaWYgeW91IHVuZGVyc3RhbmQgaG93IGl0IHdvcmtzIHVuZGVybmVhdGguCgogIEBjbGFzcyBCaW5kaW5nCiAgQG5hbWVzcGFjZSBFbWJlcgogIEBzaW5jZSBFbWJlciAwLjkKKi8KRW1iZXIuQmluZGluZyA9IEJpbmRpbmc7CgoKLyoqCiAgR2xvYmFsIGhlbHBlciBtZXRob2QgdG8gY3JlYXRlIGEgbmV3IGJpbmRpbmcuIEp1c3QgcGFzcyB0aGUgcm9vdCBvYmplY3QKICBhbG9uZyB3aXRoIGEgYHRvYCBhbmQgYGZyb21gIHBhdGggdG8gY3JlYXRlIGFuZCBjb25uZWN0IHRoZSBiaW5kaW5nLgoKICBAbWV0aG9kIGJpbmQKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtPYmplY3R9IG9iaiBUaGUgcm9vdCBvYmplY3Qgb2YgdGhlIHRyYW5zZm9ybS4KICBAcGFyYW0ge1N0cmluZ30gdG8gVGhlIHBhdGggdG8gdGhlICd0bycgc2lkZSBvZiB0aGUgYmluZGluZy4KICAgIE11c3QgYmUgcmVsYXRpdmUgdG8gb2JqLgogIEBwYXJhbSB7U3RyaW5nfSBmcm9tIFRoZSBwYXRoIHRvIHRoZSAnZnJvbScgc2lkZSBvZiB0aGUgYmluZGluZy4KICAgIE11c3QgYmUgcmVsYXRpdmUgdG8gb2JqIG9yIGEgZ2xvYmFsIHBhdGguCiAgQHJldHVybiB7RW1iZXIuQmluZGluZ30gYmluZGluZyBpbnN0YW5jZQoqLwpFbWJlci5iaW5kID0gZnVuY3Rpb24ob2JqLCB0bywgZnJvbSkgewogIHJldHVybiBuZXcgRW1iZXIuQmluZGluZyh0bywgZnJvbSkuY29ubmVjdChvYmopOwp9OwoKLyoqCiAgQG1ldGhvZCBvbmVXYXkKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtPYmplY3R9IG9iaiBUaGUgcm9vdCBvYmplY3Qgb2YgdGhlIHRyYW5zZm9ybS4KICBAcGFyYW0ge1N0cmluZ30gdG8gVGhlIHBhdGggdG8gdGhlICd0bycgc2lkZSBvZiB0aGUgYmluZGluZy4KICAgIE11c3QgYmUgcmVsYXRpdmUgdG8gb2JqLgogIEBwYXJhbSB7U3RyaW5nfSBmcm9tIFRoZSBwYXRoIHRvIHRoZSAnZnJvbScgc2lkZSBvZiB0aGUgYmluZGluZy4KICAgIE11c3QgYmUgcmVsYXRpdmUgdG8gb2JqIG9yIGEgZ2xvYmFsIHBhdGguCiAgQHJldHVybiB7RW1iZXIuQmluZGluZ30gYmluZGluZyBpbnN0YW5jZQoqLwpFbWJlci5vbmVXYXkgPSBmdW5jdGlvbihvYmosIHRvLCBmcm9tKSB7CiAgcmV0dXJuIG5ldyBFbWJlci5CaW5kaW5nKHRvLCBmcm9tKS5vbmVXYXkoKS5jb25uZWN0KG9iaik7Cn07Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItbWV0YWwKKi8KCnZhciBNaXhpbiwgUkVRVUlSRUQsIEFsaWFzLAogICAgYV9tYXAgPSBFbWJlci5BcnJheVBvbHlmaWxscy5tYXAsCiAgICBhX2luZGV4T2YgPSBFbWJlci5BcnJheVBvbHlmaWxscy5pbmRleE9mLAogICAgYV9mb3JFYWNoID0gRW1iZXIuQXJyYXlQb2x5ZmlsbHMuZm9yRWFjaCwKICAgIGFfc2xpY2UgPSBbXS5zbGljZSwKICAgIG9fY3JlYXRlID0gRW1iZXIuY3JlYXRlLAogICAgZGVmaW5lUHJvcGVydHkgPSBFbWJlci5kZWZpbmVQcm9wZXJ0eSwKICAgIGd1aWRGb3IgPSBFbWJlci5ndWlkRm9yOwoKCmZ1bmN0aW9uIG1peGluc01ldGEob2JqKSB7CiAgdmFyIG0gPSBFbWJlci5tZXRhKG9iaiwgdHJ1ZSksIHJldCA9IG0ubWl4aW5zOwogIGlmICghcmV0KSB7CiAgICByZXQgPSBtLm1peGlucyA9IHt9OwogIH0gZWxzZSBpZiAoIW0uaGFzT3duUHJvcGVydHkoJ21peGlucycpKSB7CiAgICByZXQgPSBtLm1peGlucyA9IG9fY3JlYXRlKHJldCk7CiAgfQogIHJldHVybiByZXQ7Cn0KCmZ1bmN0aW9uIGluaXRNaXhpbihtaXhpbiwgYXJncykgewogIGlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgbWl4aW4ubWl4aW5zID0gYV9tYXAuY2FsbChhcmdzLCBmdW5jdGlvbih4KSB7CiAgICAgIGlmICh4IGluc3RhbmNlb2YgTWl4aW4pIHsgcmV0dXJuIHg7IH0KCiAgICAgIC8vIE5vdGU6IE1hbnVhbGx5IHNldHVwIGEgcHJpbWl0aXZlIG1peGluIGhlcmUuIFRoaXMgaXMgdGhlIG9ubHkKICAgICAgLy8gd2F5IHRvIGFjdHVhbGx5IGdldCBhIHByaW1pdGl2ZSBtaXhpbi4gVGhpcyB3YXkgbm9ybWFsIGNyZWF0aW9uCiAgICAgIC8vIG9mIG1peGlucyB3aWxsIGdpdmUgeW91IGNvbWJpbmVkIG1peGlucy4uLgogICAgICB2YXIgbWl4aW4gPSBuZXcgTWl4aW4oKTsKICAgICAgbWl4aW4ucHJvcGVydGllcyA9IHg7CiAgICAgIHJldHVybiBtaXhpbjsKICAgIH0pOwogIH0KICByZXR1cm4gbWl4aW47Cn0KCmZ1bmN0aW9uIGlzTWV0aG9kKG9iaikgewogIHJldHVybiAnZnVuY3Rpb24nID09PSB0eXBlb2Ygb2JqICYmCiAgICAgICAgIG9iai5pc01ldGhvZCAhPT0gZmFsc2UgJiYKICAgICAgICAgb2JqICE9PSBCb29sZWFuICYmIG9iaiAhPT0gT2JqZWN0ICYmIG9iaiAhPT0gTnVtYmVyICYmIG9iaiAhPT0gQXJyYXkgJiYgb2JqICE9PSBEYXRlICYmIG9iaiAhPT0gU3RyaW5nOwp9Cgp2YXIgQ09OVElOVUUgPSB7fTsKCmZ1bmN0aW9uIG1peGluUHJvcGVydGllcyhtaXhpbnNNZXRhLCBtaXhpbikgewogIHZhciBndWlkOwoKICBpZiAobWl4aW4gaW5zdGFuY2VvZiBNaXhpbikgewogICAgZ3VpZCA9IGd1aWRGb3IobWl4aW4pOwogICAgaWYgKG1peGluc01ldGFbZ3VpZF0pIHsgcmV0dXJuIENPTlRJTlVFOyB9CiAgICBtaXhpbnNNZXRhW2d1aWRdID0gbWl4aW47CiAgICByZXR1cm4gbWl4aW4ucHJvcGVydGllczsKICB9IGVsc2UgewogICAgcmV0dXJuIG1peGluOyAvLyBhcHBseSBhbm9ueW1vdXMgbWl4aW4gcHJvcGVydGllcwogIH0KfQoKZnVuY3Rpb24gY29uY2F0ZW5hdGVkTWl4aW5Qcm9wZXJ0aWVzKGNvbmNhdFByb3AsIHByb3BzLCB2YWx1ZXMsIGJhc2UpIHsKICB2YXIgY29uY2F0czsKCiAgLy8gcmVzZXQgYmVmb3JlIGFkZGluZyBlYWNoIG5ldyBtaXhpbiB0byBwaWNrdXAgY29uY2F0cyBmcm9tIHByZXZpb3VzCiAgY29uY2F0cyA9IHZhbHVlc1tjb25jYXRQcm9wXSB8fCBiYXNlW2NvbmNhdFByb3BdOwogIGlmIChwcm9wc1tjb25jYXRQcm9wXSkgewogICAgY29uY2F0cyA9IGNvbmNhdHMgPyBjb25jYXRzLmNvbmNhdChwcm9wc1tjb25jYXRQcm9wXSkgOiBwcm9wc1tjb25jYXRQcm9wXTsKICB9CgogIHJldHVybiBjb25jYXRzOwp9CgpmdW5jdGlvbiBnaXZlRGVzY3JpcHRvclN1cGVyKG1ldGEsIGtleSwgcHJvcGVydHksIHZhbHVlcywgZGVzY3MpIHsKICB2YXIgc3VwZXJQcm9wZXJ0eTsKCiAgLy8gQ29tcHV0ZWQgcHJvcGVydGllcyBvdmVycmlkZSBtZXRob2RzLCBhbmQgZG8gbm90IGNhbGwgc3VwZXIgdG8gdGhlbQogIGlmICh2YWx1ZXNba2V5XSA9PT0gdW5kZWZpbmVkKSB7CiAgICAvLyBGaW5kIHRoZSBvcmlnaW5hbCBkZXNjcmlwdG9yIGluIGEgcGFyZW50IG1peGluCiAgICBzdXBlclByb3BlcnR5ID0gZGVzY3Nba2V5XTsKICB9CgogIC8vIElmIHdlIGRpZG4ndCBmaW5kIHRoZSBvcmlnaW5hbCBkZXNjcmlwdG9yIGluIGEgcGFyZW50IG1peGluLCBmaW5kCiAgLy8gaXQgb24gdGhlIG9yaWdpbmFsIG9iamVjdC4KICBzdXBlclByb3BlcnR5ID0gc3VwZXJQcm9wZXJ0eSB8fCBtZXRhLmRlc2NzW2tleV07CgogIGlmICghc3VwZXJQcm9wZXJ0eSB8fCAhKHN1cGVyUHJvcGVydHkgaW5zdGFuY2VvZiBFbWJlci5Db21wdXRlZFByb3BlcnR5KSkgewogICAgcmV0dXJuIHByb3BlcnR5OwogIH0KCiAgLy8gU2luY2UgbXVsdGlwbGUgbWl4aW5zIG1heSBpbmhlcml0IGZyb20gdGhlIHNhbWUgcGFyZW50LCB3ZSBuZWVkCiAgLy8gdG8gY2xvbmUgdGhlIGNvbXB1dGVkIHByb3BlcnR5IHNvIHRoYXQgb3RoZXIgbWl4aW5zIGRvIG5vdCByZWNlaXZlCiAgLy8gdGhlIHdyYXBwZWQgdmVyc2lvbi4KICBwcm9wZXJ0eSA9IG9fY3JlYXRlKHByb3BlcnR5KTsKICBwcm9wZXJ0eS5mdW5jID0gRW1iZXIud3JhcChwcm9wZXJ0eS5mdW5jLCBzdXBlclByb3BlcnR5LmZ1bmMpOwoKICByZXR1cm4gcHJvcGVydHk7Cn0KCmZ1bmN0aW9uIGdpdmVNZXRob2RTdXBlcihvYmosIGtleSwgbWV0aG9kLCB2YWx1ZXMsIGRlc2NzKSB7CiAgdmFyIHN1cGVyTWV0aG9kOwoKICAvLyBNZXRob2RzIG92ZXJ3cml0ZSBjb21wdXRlZCBwcm9wZXJ0aWVzLCBhbmQgZG8gbm90IGNhbGwgc3VwZXIgdG8gdGhlbS4KICBpZiAoZGVzY3Nba2V5XSA9PT0gdW5kZWZpbmVkKSB7CiAgICAvLyBGaW5kIHRoZSBvcmlnaW5hbCBtZXRob2QgaW4gYSBwYXJlbnQgbWl4aW4KICAgIHN1cGVyTWV0aG9kID0gdmFsdWVzW2tleV07CiAgfQoKICAvLyBJZiB3ZSBkaWRuJ3QgZmluZCB0aGUgb3JpZ2luYWwgdmFsdWUgaW4gYSBwYXJlbnQgbWl4aW4sIGZpbmQgaXQgaW4KICAvLyB0aGUgb3JpZ2luYWwgb2JqZWN0CiAgc3VwZXJNZXRob2QgPSBzdXBlck1ldGhvZCB8fCBvYmpba2V5XTsKCiAgLy8gT25seSB3cmFwIHRoZSBuZXcgbWV0aG9kIGlmIHRoZSBvcmlnaW5hbCBtZXRob2Qgd2FzIGEgZnVuY3Rpb24KICBpZiAoJ2Z1bmN0aW9uJyAhPT0gdHlwZW9mIHN1cGVyTWV0aG9kKSB7CiAgICByZXR1cm4gbWV0aG9kOwogIH0KCiAgcmV0dXJuIEVtYmVyLndyYXAobWV0aG9kLCBzdXBlck1ldGhvZCk7Cn0KCmZ1bmN0aW9uIGFwcGx5Q29uY2F0ZW5hdGVkUHJvcGVydGllcyhvYmosIGtleSwgdmFsdWUsIHZhbHVlcykgewogIHZhciBiYXNlVmFsdWUgPSB2YWx1ZXNba2V5XSB8fCBvYmpba2V5XTsKCiAgaWYgKGJhc2VWYWx1ZSkgewogICAgaWYgKCdmdW5jdGlvbicgPT09IHR5cGVvZiBiYXNlVmFsdWUuY29uY2F0KSB7CiAgICAgIHJldHVybiBiYXNlVmFsdWUuY29uY2F0KHZhbHVlKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBFbWJlci5tYWtlQXJyYXkoYmFzZVZhbHVlKS5jb25jYXQodmFsdWUpOwogICAgfQogIH0gZWxzZSB7CiAgICByZXR1cm4gRW1iZXIubWFrZUFycmF5KHZhbHVlKTsKICB9Cn0KCmZ1bmN0aW9uIGFwcGx5TWVyZ2VkUHJvcGVydGllcyhvYmosIGtleSwgdmFsdWUsIHZhbHVlcykgewogIHZhciBiYXNlVmFsdWUgPSB2YWx1ZXNba2V5XSB8fCBvYmpba2V5XTsKCiAgaWYgKCFiYXNlVmFsdWUpIHsgcmV0dXJuIHZhbHVlOyB9CgogIHZhciBuZXdCYXNlID0gRW1iZXIubWVyZ2Uoe30sIGJhc2VWYWx1ZSk7CiAgZm9yICh2YXIgcHJvcCBpbiB2YWx1ZSkgewogICAgaWYgKCF2YWx1ZS5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgeyBjb250aW51ZTsgfQoKICAgIHZhciBwcm9wVmFsdWUgPSB2YWx1ZVtwcm9wXTsKICAgIGlmIChpc01ldGhvZChwcm9wVmFsdWUpKSB7CiAgICAgIC8vIFRPRE86IHN1cHBvcnQgZm9yIENvbXB1dGVkIFByb3BlcnRpZXMsIGV0Yz8KICAgICAgbmV3QmFzZVtwcm9wXSA9IGdpdmVNZXRob2RTdXBlcihvYmosIHByb3AsIHByb3BWYWx1ZSwgYmFzZVZhbHVlLCB7fSk7CiAgICB9IGVsc2UgewogICAgICBuZXdCYXNlW3Byb3BdID0gcHJvcFZhbHVlOwogICAgfQogIH0KCiAgcmV0dXJuIG5ld0Jhc2U7Cn0KCmZ1bmN0aW9uIGFkZE5vcm1hbGl6ZWRQcm9wZXJ0eShiYXNlLCBrZXksIHZhbHVlLCBtZXRhLCBkZXNjcywgdmFsdWVzLCBjb25jYXRzLCBtZXJnaW5ncykgewogIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEVtYmVyLkRlc2NyaXB0b3IpIHsKICAgIGlmICh2YWx1ZSA9PT0gUkVRVUlSRUQgJiYgZGVzY3Nba2V5XSkgeyByZXR1cm4gQ09OVElOVUU7IH0KCiAgICAvLyBXcmFwIGRlc2NyaXB0b3IgZnVuY3Rpb24gdG8gaW1wbGVtZW50CiAgICAvLyBfc3VwZXIoKSBpZiBuZWVkZWQKICAgIGlmICh2YWx1ZS5mdW5jKSB7CiAgICAgIHZhbHVlID0gZ2l2ZURlc2NyaXB0b3JTdXBlcihtZXRhLCBrZXksIHZhbHVlLCB2YWx1ZXMsIGRlc2NzKTsKICAgIH0KCiAgICBkZXNjc1trZXldICA9IHZhbHVlOwogICAgdmFsdWVzW2tleV0gPSB1bmRlZmluZWQ7CiAgfSBlbHNlIHsKICAgIGlmICgoY29uY2F0cyAmJiBhX2luZGV4T2YuY2FsbChjb25jYXRzLCBrZXkpID49IDApIHx8CiAgICAgICAgICAgICAgICBrZXkgPT09ICdjb25jYXRlbmF0ZWRQcm9wZXJ0aWVzJyB8fAogICAgICAgICAgICAgICAga2V5ID09PSAnbWVyZ2VkUHJvcGVydGllcycpIHsKICAgICAgdmFsdWUgPSBhcHBseUNvbmNhdGVuYXRlZFByb3BlcnRpZXMoYmFzZSwga2V5LCB2YWx1ZSwgdmFsdWVzKTsKICAgIH0gZWxzZSBpZiAoKG1lcmdpbmdzICYmIGFfaW5kZXhPZi5jYWxsKG1lcmdpbmdzLCBrZXkpID49IDApKSB7CiAgICAgIHZhbHVlID0gYXBwbHlNZXJnZWRQcm9wZXJ0aWVzKGJhc2UsIGtleSwgdmFsdWUsIHZhbHVlcyk7CiAgICB9IGVsc2UgaWYgKGlzTWV0aG9kKHZhbHVlKSkgewogICAgICB2YWx1ZSA9IGdpdmVNZXRob2RTdXBlcihiYXNlLCBrZXksIHZhbHVlLCB2YWx1ZXMsIGRlc2NzKTsKICAgIH0KCiAgICBkZXNjc1trZXldID0gdW5kZWZpbmVkOwogICAgdmFsdWVzW2tleV0gPSB2YWx1ZTsKICB9Cn0KCmZ1bmN0aW9uIG1lcmdlTWl4aW5zKG1peGlucywgbSwgZGVzY3MsIHZhbHVlcywgYmFzZSwga2V5cykgewogIHZhciBtaXhpbiwgcHJvcHMsIGtleSwgY29uY2F0cywgbWVyZ2luZ3MsIG1ldGE7CgogIGZ1bmN0aW9uIHJlbW92ZUtleXMoa2V5TmFtZSkgewogICAgZGVsZXRlIGRlc2NzW2tleU5hbWVdOwogICAgZGVsZXRlIHZhbHVlc1trZXlOYW1lXTsKICB9CgogIGZvcih2YXIgaT0wLCBsPW1peGlucy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICBtaXhpbiA9IG1peGluc1tpXTsKICAgIEVtYmVyLmFzc2VydCgnRXhwZWN0ZWQgaGFzaCBvciBNaXhpbiBpbnN0YW5jZSwgZ290ICcgKyBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwobWl4aW4pLAogICAgICAgICAgICAgICAgIHR5cGVvZiBtaXhpbiA9PT0gJ29iamVjdCcgJiYgbWl4aW4gIT09IG51bGwgJiYgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG1peGluKSAhPT0gJ1tvYmplY3QgQXJyYXldJyk7CgogICAgcHJvcHMgPSBtaXhpblByb3BlcnRpZXMobSwgbWl4aW4pOwogICAgaWYgKHByb3BzID09PSBDT05USU5VRSkgeyBjb250aW51ZTsgfQoKICAgIGlmIChwcm9wcykgewogICAgICBtZXRhID0gRW1iZXIubWV0YShiYXNlKTsKICAgICAgaWYgKGJhc2Uud2lsbE1lcmdlTWl4aW4pIHsgYmFzZS53aWxsTWVyZ2VNaXhpbihwcm9wcyk7IH0KICAgICAgY29uY2F0cyA9IGNvbmNhdGVuYXRlZE1peGluUHJvcGVydGllcygnY29uY2F0ZW5hdGVkUHJvcGVydGllcycsIHByb3BzLCB2YWx1ZXMsIGJhc2UpOwogICAgICBtZXJnaW5ncyA9IGNvbmNhdGVuYXRlZE1peGluUHJvcGVydGllcygnbWVyZ2VkUHJvcGVydGllcycsIHByb3BzLCB2YWx1ZXMsIGJhc2UpOwoKICAgICAgZm9yIChrZXkgaW4gcHJvcHMpIHsKICAgICAgICBpZiAoIXByb3BzLmhhc093blByb3BlcnR5KGtleSkpIHsgY29udGludWU7IH0KICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgICBhZGROb3JtYWxpemVkUHJvcGVydHkoYmFzZSwga2V5LCBwcm9wc1trZXldLCBtZXRhLCBkZXNjcywgdmFsdWVzLCBjb25jYXRzLCBtZXJnaW5ncyk7CiAgICAgIH0KCiAgICAgIC8vIG1hbnVhbGx5IGNvcHkgdG9TdHJpbmcoKSBiZWNhdXNlIHNvbWUgSlMgZW5naW5lcyBkbyBub3QgZW51bWVyYXRlIGl0CiAgICAgIGlmIChwcm9wcy5oYXNPd25Qcm9wZXJ0eSgndG9TdHJpbmcnKSkgeyBiYXNlLnRvU3RyaW5nID0gcHJvcHMudG9TdHJpbmc7IH0KICAgIH0gZWxzZSBpZiAobWl4aW4ubWl4aW5zKSB7CiAgICAgIG1lcmdlTWl4aW5zKG1peGluLm1peGlucywgbSwgZGVzY3MsIHZhbHVlcywgYmFzZSwga2V5cyk7CiAgICAgIGlmIChtaXhpbi5fd2l0aG91dCkgeyBhX2ZvckVhY2guY2FsbChtaXhpbi5fd2l0aG91dCwgcmVtb3ZlS2V5cyk7IH0KICAgIH0KICB9Cn0KCnZhciBJU19CSU5ESU5HID0gRW1iZXIuSVNfQklORElORyA9IC9eLitCaW5kaW5nJC87CgpmdW5jdGlvbiBkZXRlY3RCaW5kaW5nKG9iaiwga2V5LCB2YWx1ZSwgbSkgewogIGlmIChJU19CSU5ESU5HLnRlc3Qoa2V5KSkgewogICAgdmFyIGJpbmRpbmdzID0gbS5iaW5kaW5nczsKICAgIGlmICghYmluZGluZ3MpIHsKICAgICAgYmluZGluZ3MgPSBtLmJpbmRpbmdzID0ge307CiAgICB9IGVsc2UgaWYgKCFtLmhhc093blByb3BlcnR5KCdiaW5kaW5ncycpKSB7CiAgICAgIGJpbmRpbmdzID0gbS5iaW5kaW5ncyA9IG9fY3JlYXRlKG0uYmluZGluZ3MpOwogICAgfQogICAgYmluZGluZ3Nba2V5XSA9IHZhbHVlOwogIH0KfQoKZnVuY3Rpb24gY29ubmVjdEJpbmRpbmdzKG9iaiwgbSkgewogIC8vIFRPRE8gTWl4aW4uYXBwbHkoaW5zdGFuY2UpIHNob3VsZCBkaXNjb25uZWN0IGJpbmRpbmcgaWYgZXhpc3RzCiAgdmFyIGJpbmRpbmdzID0gbS5iaW5kaW5ncywga2V5LCBiaW5kaW5nLCB0bzsKICBpZiAoYmluZGluZ3MpIHsKICAgIGZvciAoa2V5IGluIGJpbmRpbmdzKSB7CiAgICAgIGJpbmRpbmcgPSBiaW5kaW5nc1trZXldOwogICAgICBpZiAoYmluZGluZykgewogICAgICAgIHRvID0ga2V5LnNsaWNlKDAsIC03KTsgLy8gc3RyaXAgQmluZGluZyBvZmYgZW5kCiAgICAgICAgaWYgKGJpbmRpbmcgaW5zdGFuY2VvZiBFbWJlci5CaW5kaW5nKSB7CiAgICAgICAgICBiaW5kaW5nID0gYmluZGluZy5jb3B5KCk7IC8vIGNvcHkgcHJvdG90eXBlcycgaW5zdGFuY2UKICAgICAgICAgIGJpbmRpbmcudG8odG8pOwogICAgICAgIH0gZWxzZSB7IC8vIGJpbmRpbmcgaXMgc3RyaW5nIHBhdGgKICAgICAgICAgIGJpbmRpbmcgPSBuZXcgRW1iZXIuQmluZGluZyh0bywgYmluZGluZyk7CiAgICAgICAgfQogICAgICAgIGJpbmRpbmcuY29ubmVjdChvYmopOwogICAgICAgIG9ialtrZXldID0gYmluZGluZzsKICAgICAgfQogICAgfQogICAgLy8gbWFyayBhcyBhcHBsaWVkCiAgICBtLmJpbmRpbmdzID0ge307CiAgfQp9CgpmdW5jdGlvbiBmaW5pc2hQYXJ0aWFsKG9iaiwgbSkgewogIGNvbm5lY3RCaW5kaW5ncyhvYmosIG0gfHwgRW1iZXIubWV0YShvYmopKTsKICByZXR1cm4gb2JqOwp9CgpmdW5jdGlvbiBmb2xsb3dBbGlhcyhvYmosIGRlc2MsIG0sIGRlc2NzLCB2YWx1ZXMpIHsKICB2YXIgYWx0S2V5ID0gZGVzYy5tZXRob2ROYW1lLCB2YWx1ZTsKICBpZiAoZGVzY3NbYWx0S2V5XSB8fCB2YWx1ZXNbYWx0S2V5XSkgewogICAgdmFsdWUgPSB2YWx1ZXNbYWx0S2V5XTsKICAgIGRlc2MgID0gZGVzY3NbYWx0S2V5XTsKICB9IGVsc2UgaWYgKG0uZGVzY3NbYWx0S2V5XSkgewogICAgZGVzYyAgPSBtLmRlc2NzW2FsdEtleV07CiAgICB2YWx1ZSA9IHVuZGVmaW5lZDsKICB9IGVsc2UgewogICAgZGVzYyA9IHVuZGVmaW5lZDsKICAgIHZhbHVlID0gb2JqW2FsdEtleV07CiAgfQoKICByZXR1cm4geyBkZXNjOiBkZXNjLCB2YWx1ZTogdmFsdWUgfTsKfQoKZnVuY3Rpb24gdXBkYXRlT2JzZXJ2ZXJzQW5kTGlzdGVuZXJzKG9iaiwga2V5LCBvYnNlcnZlck9yTGlzdGVuZXIsIHBhdGhzS2V5LCB1cGRhdGVNZXRob2QpIHsKICB2YXIgcGF0aHMgPSBvYnNlcnZlck9yTGlzdGVuZXJbcGF0aHNLZXldOwoKICBpZiAocGF0aHMpIHsKICAgIGZvciAodmFyIGk9MCwgbD1wYXRocy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgIEVtYmVyW3VwZGF0ZU1ldGhvZF0ob2JqLCBwYXRoc1tpXSwgbnVsbCwga2V5KTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIHJlcGxhY2VPYnNlcnZlcnNBbmRMaXN0ZW5lcnMob2JqLCBrZXksIG9ic2VydmVyT3JMaXN0ZW5lcikgewogIHZhciBwcmV2ID0gb2JqW2tleV07CgogIGlmICgnZnVuY3Rpb24nID09PSB0eXBlb2YgcHJldikgewogICAgdXBkYXRlT2JzZXJ2ZXJzQW5kTGlzdGVuZXJzKG9iaiwga2V5LCBwcmV2LCAnX19lbWJlcl9vYnNlcnZlc0JlZm9yZV9fJywgJ3JlbW92ZUJlZm9yZU9ic2VydmVyJyk7CiAgICB1cGRhdGVPYnNlcnZlcnNBbmRMaXN0ZW5lcnMob2JqLCBrZXksIHByZXYsICdfX2VtYmVyX29ic2VydmVzX18nLCAncmVtb3ZlT2JzZXJ2ZXInKTsKICAgIHVwZGF0ZU9ic2VydmVyc0FuZExpc3RlbmVycyhvYmosIGtleSwgcHJldiwgJ19fZW1iZXJfbGlzdGVuc19fJywgJ3JlbW92ZUxpc3RlbmVyJyk7CiAgfQoKICBpZiAoJ2Z1bmN0aW9uJyA9PT0gdHlwZW9mIG9ic2VydmVyT3JMaXN0ZW5lcikgewogICAgdXBkYXRlT2JzZXJ2ZXJzQW5kTGlzdGVuZXJzKG9iaiwga2V5LCBvYnNlcnZlck9yTGlzdGVuZXIsICdfX2VtYmVyX29ic2VydmVzQmVmb3JlX18nLCAnYWRkQmVmb3JlT2JzZXJ2ZXInKTsKICAgIHVwZGF0ZU9ic2VydmVyc0FuZExpc3RlbmVycyhvYmosIGtleSwgb2JzZXJ2ZXJPckxpc3RlbmVyLCAnX19lbWJlcl9vYnNlcnZlc19fJywgJ2FkZE9ic2VydmVyJyk7CiAgICB1cGRhdGVPYnNlcnZlcnNBbmRMaXN0ZW5lcnMob2JqLCBrZXksIG9ic2VydmVyT3JMaXN0ZW5lciwgJ19fZW1iZXJfbGlzdGVuc19fJywgJ2FkZExpc3RlbmVyJyk7CiAgfQp9CgpmdW5jdGlvbiBhcHBseU1peGluKG9iaiwgbWl4aW5zLCBwYXJ0aWFsKSB7CiAgdmFyIGRlc2NzID0ge30sIHZhbHVlcyA9IHt9LCBtID0gRW1iZXIubWV0YShvYmopLAogICAgICBrZXksIHZhbHVlLCBkZXNjLCBrZXlzID0gW107CgogIC8vIEdvIHRocm91Z2ggYWxsIG1peGlucyBhbmQgaGFzaGVzIHBhc3NlZCBpbiwgYW5kOgogIC8vCiAgLy8gKiBIYW5kbGUgY29uY2F0ZW5hdGVkIHByb3BlcnRpZXMKICAvLyAqIEhhbmRsZSBtZXJnZWQgcHJvcGVydGllcwogIC8vICogU2V0IHVwIF9zdXBlciB3cmFwcGluZyBpZiBuZWNlc3NhcnkKICAvLyAqIFNldCB1cCBjb21wdXRlZCBwcm9wZXJ0eSBkZXNjcmlwdG9ycwogIC8vICogQ29weWluZyBgdG9TdHJpbmdgIGluIGJyb2tlbiBicm93c2VycwogIG1lcmdlTWl4aW5zKG1peGlucywgbWl4aW5zTWV0YShvYmopLCBkZXNjcywgdmFsdWVzLCBvYmosIGtleXMpOwoKICBmb3IodmFyIGkgPSAwLCBsID0ga2V5cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIGtleSA9IGtleXNbaV07CiAgICBpZiAoa2V5ID09PSAnY29uc3RydWN0b3InIHx8ICF2YWx1ZXMuaGFzT3duUHJvcGVydHkoa2V5KSkgeyBjb250aW51ZTsgfQoKICAgIGRlc2MgPSBkZXNjc1trZXldOwogICAgdmFsdWUgPSB2YWx1ZXNba2V5XTsKCiAgICBpZiAoZGVzYyA9PT0gUkVRVUlSRUQpIHsgY29udGludWU7IH0KCiAgICB3aGlsZSAoZGVzYyAmJiBkZXNjIGluc3RhbmNlb2YgQWxpYXMpIHsKICAgICAgdmFyIGZvbGxvd2VkID0gZm9sbG93QWxpYXMob2JqLCBkZXNjLCBtLCBkZXNjcywgdmFsdWVzKTsKICAgICAgZGVzYyA9IGZvbGxvd2VkLmRlc2M7CiAgICAgIHZhbHVlID0gZm9sbG93ZWQudmFsdWU7CiAgICB9CgogICAgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCAmJiB2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7IGNvbnRpbnVlOyB9CgogICAgcmVwbGFjZU9ic2VydmVyc0FuZExpc3RlbmVycyhvYmosIGtleSwgdmFsdWUpOwogICAgZGV0ZWN0QmluZGluZyhvYmosIGtleSwgdmFsdWUsIG0pOwogICAgZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIGRlc2MsIHZhbHVlLCBtKTsKICB9CgogIGlmICghcGFydGlhbCkgeyAvLyBkb24ndCBhcHBseSB0byBwcm90b3R5cGUKICAgIGZpbmlzaFBhcnRpYWwob2JqLCBtKTsKICB9CgogIHJldHVybiBvYmo7Cn0KCi8qKgogIEBtZXRob2QgbWl4aW4KICBAZm9yIEVtYmVyCiAgQHBhcmFtIG9iagogIEBwYXJhbSBtaXhpbnMqCiAgQHJldHVybiBvYmoKKi8KRW1iZXIubWl4aW4gPSBmdW5jdGlvbihvYmopIHsKICB2YXIgYXJncyA9IGFfc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogIGFwcGx5TWl4aW4ob2JqLCBhcmdzLCBmYWxzZSk7CiAgcmV0dXJuIG9iajsKfTsKCi8qKgogIFRoZSBgRW1iZXIuTWl4aW5gIGNsYXNzIGFsbG93cyB5b3UgdG8gY3JlYXRlIG1peGlucywgd2hvc2UgcHJvcGVydGllcyBjYW4gYmUKICBhZGRlZCB0byBvdGhlciBjbGFzc2VzLiBGb3IgaW5zdGFuY2UsCgogIGBgYGphdmFzY3JpcHQKICBBcHAuRWRpdGFibGUgPSBFbWJlci5NaXhpbi5jcmVhdGUoewogICAgZWRpdDogZnVuY3Rpb24oKSB7CiAgICAgIGNvbnNvbGUubG9nKCdzdGFydGluZyB0byBlZGl0Jyk7CiAgICAgIHRoaXMuc2V0KCdpc0VkaXRpbmcnLCB0cnVlKTsKICAgIH0sCiAgICBpc0VkaXRpbmc6IGZhbHNlCiAgfSk7CgogIC8vIE1peCBtaXhpbnMgaW50byBjbGFzc2VzIGJ5IHBhc3NpbmcgdGhlbSBhcyB0aGUgZmlyc3QgYXJndW1lbnRzIHRvCiAgLy8gLmV4dGVuZC4KICBBcHAuQ29tbWVudFZpZXcgPSBFbWJlci5WaWV3LmV4dGVuZChBcHAuRWRpdGFibGUsIHsKICAgIHRlbXBsYXRlOiBFbWJlci5IYW5kbGViYXJzLmNvbXBpbGUoJ3t7I2lmIHZpZXcuaXNFZGl0aW5nfX0uLi57e2Vsc2V9fS4uLnt7L2lmfX0nKQogIH0pOwoKICBjb21tZW50VmlldyA9IEFwcC5Db21tZW50Vmlldy5jcmVhdGUoKTsKICBjb21tZW50Vmlldy5lZGl0KCk7IC8vIG91dHB1dHMgJ3N0YXJ0aW5nIHRvIGVkaXQnCiAgYGBgCgogIE5vdGUgdGhhdCBNaXhpbnMgYXJlIGNyZWF0ZWQgd2l0aCBgRW1iZXIuTWl4aW4uY3JlYXRlYCwgbm90CiAgYEVtYmVyLk1peGluLmV4dGVuZGAuCgogIE5vdGUgdGhhdCBtaXhpbnMgZXh0ZW5kIGEgY29uc3RydWN0b3IncyBwcm90b3R5cGUgc28gYXJyYXlzIGFuZCBvYmplY3QgbGl0ZXJhbHMKICBkZWZpbmVkIGFzIHByb3BlcnRpZXMgd2lsbCBiZSBzaGFyZWQgYW1vbmdzdCBvYmplY3RzIHRoYXQgaW1wbGVtZW50IHRoZSBtaXhpbi4KICBJZiB5b3Ugd2FudCB0byBkZWZpbmUgYW4gcHJvcGVydHkgaW4gYSBtaXhpbiB0aGF0IGlzIG5vdCBzaGFyZWQsIHlvdSBjYW4gZGVmaW5lCiAgaXQgZWl0aGVyIGFzIGEgY29tcHV0ZWQgcHJvcGVydHkgb3IgaGF2ZSBpdCBiZSBjcmVhdGVkIG9uIGluaXRpYWxpemF0aW9uIG9mIHRoZSBvYmplY3QuCgogIGBgYGphdmFzY3JpcHQKICAvL2ZpbHRlcnMgYXJyYXkgd2lsbCBiZSBzaGFyZWQgYW1vbmdzdCBhbnkgb2JqZWN0IGltcGxlbWVudGluZyBtaXhpbgogIEFwcC5GaWx0ZXJhYmxlID0gRW1iZXIuTWl4aW4uY3JlYXRlKHsKICAgIGZpbHRlcnM6IEVtYmVyLkEoKQogIH0pOwoKICAvL2ZpbHRlcnMgd2lsbCBiZSBhIHNlcGFyYXRlICBhcnJheSBmb3IgZXZlcnkgb2JqZWN0IGltcGxlbWVudGluZyB0aGUgbWl4aW4KICBBcHAuRmlsdGVyYWJsZSA9IEVtYmVyLk1peGluLmNyZWF0ZSh7CiAgICBmaWx0ZXJzOiBFbWJlci5jb21wdXRlZChmdW5jdGlvbigpe3JldHVybiBFbWJlci5BKCk7fSkKICB9KTsKCiAgLy9maWx0ZXJzIHdpbGwgYmUgY3JlYXRlZCBhcyBhIHNlcGFyYXRlIGFycmF5IGR1cmluZyB0aGUgb2JqZWN0J3MgaW5pdGlhbGl6YXRpb24KICBBcHAuRmlsdGVyYWJsZSA9IEVtYmVyLk1peGluLmNyZWF0ZSh7CiAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5fc3VwZXIoKTsKICAgICAgdGhpcy5zZXQoImZpbHRlcnMiLCBFbWJlci5BKCkpOwogICAgfQogIH0pOwogIGBgYAoKICBAY2xhc3MgTWl4aW4KICBAbmFtZXNwYWNlIEVtYmVyCiovCkVtYmVyLk1peGluID0gZnVuY3Rpb24oKSB7IHJldHVybiBpbml0TWl4aW4odGhpcywgYXJndW1lbnRzKTsgfTsKCk1peGluID0gRW1iZXIuTWl4aW47CgpNaXhpbi5wcm90b3R5cGUgPSB7CiAgcHJvcGVydGllczogbnVsbCwKICBtaXhpbnM6IG51bGwsCiAgb3duZXJDb25zdHJ1Y3RvcjogbnVsbAp9OwoKTWl4aW4uX2FwcGx5ID0gYXBwbHlNaXhpbjsKCk1peGluLmFwcGx5UGFydGlhbCA9IGZ1bmN0aW9uKG9iaikgewogIHZhciBhcmdzID0gYV9zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgcmV0dXJuIGFwcGx5TWl4aW4ob2JqLCBhcmdzLCB0cnVlKTsKfTsKCk1peGluLmZpbmlzaFBhcnRpYWwgPSBmaW5pc2hQYXJ0aWFsOwoKRW1iZXIuYW55VW5wcm9jZXNzZWRNaXhpbnMgPSBmYWxzZTsKCi8qKgogIEBtZXRob2QgY3JlYXRlCiAgQHN0YXRpYwogIEBwYXJhbSBhcmd1bWVudHMqCiovCk1peGluLmNyZWF0ZSA9IGZ1bmN0aW9uKCkgewogIEVtYmVyLmFueVVucHJvY2Vzc2VkTWl4aW5zID0gdHJ1ZTsKICB2YXIgTSA9IHRoaXM7CiAgcmV0dXJuIGluaXRNaXhpbihuZXcgTSgpLCBhcmd1bWVudHMpOwp9OwoKdmFyIE1peGluUHJvdG90eXBlID0gTWl4aW4ucHJvdG90eXBlOwoKLyoqCiAgQG1ldGhvZCByZW9wZW4KICBAcGFyYW0gYXJndW1lbnRzKgoqLwpNaXhpblByb3RvdHlwZS5yZW9wZW4gPSBmdW5jdGlvbigpIHsKICB2YXIgbWl4aW4sIHRtcDsKCiAgaWYgKHRoaXMucHJvcGVydGllcykgewogICAgbWl4aW4gPSBNaXhpbi5jcmVhdGUoKTsKICAgIG1peGluLnByb3BlcnRpZXMgPSB0aGlzLnByb3BlcnRpZXM7CiAgICBkZWxldGUgdGhpcy5wcm9wZXJ0aWVzOwogICAgdGhpcy5taXhpbnMgPSBbbWl4aW5dOwogIH0gZWxzZSBpZiAoIXRoaXMubWl4aW5zKSB7CiAgICB0aGlzLm1peGlucyA9IFtdOwogIH0KCiAgdmFyIGxlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIG1peGlucyA9IHRoaXMubWl4aW5zLCBpZHg7CgogIGZvcihpZHg9MDsgaWR4IDwgbGVuOyBpZHgrKykgewogICAgbWl4aW4gPSBhcmd1bWVudHNbaWR4XTsKICAgIEVtYmVyLmFzc2VydCgnRXhwZWN0ZWQgaGFzaCBvciBNaXhpbiBpbnN0YW5jZSwgZ290ICcgKyBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwobWl4aW4pLAogICAgICAgICAgICAgICAgIHR5cGVvZiBtaXhpbiA9PT0gJ29iamVjdCcgJiYgbWl4aW4gIT09IG51bGwgJiYgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG1peGluKSAhPT0gJ1tvYmplY3QgQXJyYXldJyk7CgogICAgaWYgKG1peGluIGluc3RhbmNlb2YgTWl4aW4pIHsKICAgICAgbWl4aW5zLnB1c2gobWl4aW4pOwogICAgfSBlbHNlIHsKICAgICAgdG1wID0gTWl4aW4uY3JlYXRlKCk7CiAgICAgIHRtcC5wcm9wZXJ0aWVzID0gbWl4aW47CiAgICAgIG1peGlucy5wdXNoKHRtcCk7CiAgICB9CiAgfQoKICByZXR1cm4gdGhpczsKfTsKCi8qKgogIEBtZXRob2QgYXBwbHkKICBAcGFyYW0gb2JqCiAgQHJldHVybiBhcHBsaWVkIG9iamVjdAoqLwpNaXhpblByb3RvdHlwZS5hcHBseSA9IGZ1bmN0aW9uKG9iaikgewogIHJldHVybiBhcHBseU1peGluKG9iaiwgW3RoaXNdLCBmYWxzZSk7Cn07CgpNaXhpblByb3RvdHlwZS5hcHBseVBhcnRpYWwgPSBmdW5jdGlvbihvYmopIHsKICByZXR1cm4gYXBwbHlNaXhpbihvYmosIFt0aGlzXSwgdHJ1ZSk7Cn07CgpmdW5jdGlvbiBfZGV0ZWN0KGN1ck1peGluLCB0YXJnZXRNaXhpbiwgc2VlbikgewogIHZhciBndWlkID0gZ3VpZEZvcihjdXJNaXhpbik7CgogIGlmIChzZWVuW2d1aWRdKSB7IHJldHVybiBmYWxzZTsgfQogIHNlZW5bZ3VpZF0gPSB0cnVlOwoKICBpZiAoY3VyTWl4aW4gPT09IHRhcmdldE1peGluKSB7IHJldHVybiB0cnVlOyB9CiAgdmFyIG1peGlucyA9IGN1ck1peGluLm1peGlucywgbG9jID0gbWl4aW5zID8gbWl4aW5zLmxlbmd0aCA6IDA7CiAgd2hpbGUgKC0tbG9jID49IDApIHsKICAgIGlmIChfZGV0ZWN0KG1peGluc1tsb2NdLCB0YXJnZXRNaXhpbiwgc2VlbikpIHsgcmV0dXJuIHRydWU7IH0KICB9CiAgcmV0dXJuIGZhbHNlOwp9CgovKioKICBAbWV0aG9kIGRldGVjdAogIEBwYXJhbSBvYmoKICBAcmV0dXJuIHtCb29sZWFufQoqLwpNaXhpblByb3RvdHlwZS5kZXRlY3QgPSBmdW5jdGlvbihvYmopIHsKICBpZiAoIW9iaikgeyByZXR1cm4gZmFsc2U7IH0KICBpZiAob2JqIGluc3RhbmNlb2YgTWl4aW4pIHsgcmV0dXJuIF9kZXRlY3Qob2JqLCB0aGlzLCB7fSk7IH0KICB2YXIgbWl4aW5zID0gRW1iZXIubWV0YShvYmosIGZhbHNlKS5taXhpbnM7CiAgaWYgKG1peGlucykgewogICAgcmV0dXJuICEhbWl4aW5zW2d1aWRGb3IodGhpcyldOwogIH0KICByZXR1cm4gZmFsc2U7Cn07CgpNaXhpblByb3RvdHlwZS53aXRob3V0ID0gZnVuY3Rpb24oKSB7CiAgdmFyIHJldCA9IG5ldyBNaXhpbih0aGlzKTsKICByZXQuX3dpdGhvdXQgPSBhX3NsaWNlLmNhbGwoYXJndW1lbnRzKTsKICByZXR1cm4gcmV0Owp9OwoKZnVuY3Rpb24gX2tleXMocmV0LCBtaXhpbiwgc2VlbikgewogIGlmIChzZWVuW2d1aWRGb3IobWl4aW4pXSkgeyByZXR1cm47IH0KICBzZWVuW2d1aWRGb3IobWl4aW4pXSA9IHRydWU7CgogIGlmIChtaXhpbi5wcm9wZXJ0aWVzKSB7CiAgICB2YXIgcHJvcHMgPSBtaXhpbi5wcm9wZXJ0aWVzOwogICAgZm9yICh2YXIga2V5IGluIHByb3BzKSB7CiAgICAgIGlmIChwcm9wcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7IHJldFtrZXldID0gdHJ1ZTsgfQogICAgfQogIH0gZWxzZSBpZiAobWl4aW4ubWl4aW5zKSB7CiAgICBhX2ZvckVhY2guY2FsbChtaXhpbi5taXhpbnMsIGZ1bmN0aW9uKHgpIHsgX2tleXMocmV0LCB4LCBzZWVuKTsgfSk7CiAgfQp9CgpNaXhpblByb3RvdHlwZS5rZXlzID0gZnVuY3Rpb24oKSB7CiAgdmFyIGtleXMgPSB7fSwgc2VlbiA9IHt9LCByZXQgPSBbXTsKICBfa2V5cyhrZXlzLCB0aGlzLCBzZWVuKTsKICBmb3IodmFyIGtleSBpbiBrZXlzKSB7CiAgICBpZiAoa2V5cy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7IHJldC5wdXNoKGtleSk7IH0KICB9CiAgcmV0dXJuIHJldDsKfTsKCi8vIHJldHVybnMgdGhlIG1peGlucyBjdXJyZW50bHkgYXBwbGllZCB0byB0aGUgc3BlY2lmaWVkIG9iamVjdAovLyBUT0RPOiBNYWtlIEVtYmVyLm1peGluCk1peGluLm1peGlucyA9IGZ1bmN0aW9uKG9iaikgewogIHZhciBtaXhpbnMgPSBFbWJlci5tZXRhKG9iaiwgZmFsc2UpLm1peGlucywgcmV0ID0gW107CgogIGlmICghbWl4aW5zKSB7IHJldHVybiByZXQ7IH0KCiAgZm9yICh2YXIga2V5IGluIG1peGlucykgewogICAgdmFyIG1peGluID0gbWl4aW5zW2tleV07CgogICAgLy8gc2tpcCBwcmltaXRpdmUgbWl4aW5zIHNpbmNlIHRoZXNlIGFyZSBhbHdheXMgYW5vbnltb3VzCiAgICBpZiAoIW1peGluLnByb3BlcnRpZXMpIHsgcmV0LnB1c2gobWl4aW4pOyB9CiAgfQoKICByZXR1cm4gcmV0Owp9OwoKUkVRVUlSRUQgPSBuZXcgRW1iZXIuRGVzY3JpcHRvcigpOwpSRVFVSVJFRC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gJyhSZXF1aXJlZCBQcm9wZXJ0eSknOyB9OwoKLyoqCiAgRGVub3RlcyBhIHJlcXVpcmVkIHByb3BlcnR5IGZvciBhIG1peGluCgogIEBtZXRob2QgcmVxdWlyZWQKICBAZm9yIEVtYmVyCiovCkVtYmVyLnJlcXVpcmVkID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIFJFUVVJUkVEOwp9OwoKQWxpYXMgPSBmdW5jdGlvbihtZXRob2ROYW1lKSB7CiAgdGhpcy5tZXRob2ROYW1lID0gbWV0aG9kTmFtZTsKfTsKQWxpYXMucHJvdG90eXBlID0gbmV3IEVtYmVyLkRlc2NyaXB0b3IoKTsKCi8qKgogIE1ha2VzIGEgcHJvcGVydHkgb3IgbWV0aG9kIGF2YWlsYWJsZSB2aWEgYW4gYWRkaXRpb25hbCBuYW1lLgoKICBgYGBqYXZhc2NyaXB0CiAgQXBwLlBhaW50U2FtcGxlID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CiAgICBjb2xvcjogJ3JlZCcsCiAgICBjb2xvdXI6IEVtYmVyLmFsaWFzKCdjb2xvcicpLAogICAgbmFtZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAiWmVkIjsKICAgIH0sCiAgICBtb25pa2VyOiBFbWJlci5hbGlhcygibmFtZSIpCiAgfSk7CgogIHZhciBwYWludFNhbXBsZSA9IEFwcC5QYWludFNhbXBsZS5jcmVhdGUoKQogIHBhaW50U2FtcGxlLmdldCgnY29sb3VyJyk7ICAvLyAncmVkJwogIHBhaW50U2FtcGxlLm1vbmlrZXIoKTsgICAgICAvLyAnWmVkJwogIGBgYAoKICBAbWV0aG9kIGFsaWFzCiAgQGZvciBFbWJlcgogIEBwYXJhbSB7U3RyaW5nfSBtZXRob2ROYW1lIG5hbWUgb2YgdGhlIG1ldGhvZCBvciBwcm9wZXJ0eSB0byBhbGlhcwogIEByZXR1cm4ge0VtYmVyLkRlc2NyaXB0b3J9CiAgQGRlcHJlY2F0ZWQgVXNlIGBFbWJlci5hbGlhc01ldGhvZGAgb3IgYEVtYmVyLmNvbXB1dGVkLmFsaWFzYCBpbnN0ZWFkCiovCkVtYmVyLmFsaWFzID0gZnVuY3Rpb24obWV0aG9kTmFtZSkgewogIEVtYmVyLmRlcHJlY2F0ZSgiRW1iZXIuYWxpYXMgaXMgZGVwcmVjYXRlZC4gUGxlYXNlIHVzZSBFbWJlci5hbGlhc01ldGhvZCBvciBFbWJlci5jb21wdXRlZC5hbGlhcyBpbnN0ZWFkLiIpOwogIHJldHVybiBuZXcgQWxpYXMobWV0aG9kTmFtZSk7Cn07CgovKioKICBNYWtlcyBhIG1ldGhvZCBhdmFpbGFibGUgdmlhIGFuIGFkZGl0aW9uYWwgbmFtZS4KCiAgYGBgamF2YXNjcmlwdAogIEFwcC5QZXJzb24gPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICAgIG5hbWU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gJ1RvbWh1ZGEgS2F0emRhbGUnOwogICAgfSwKICAgIG1vbmlrZXI6IEVtYmVyLmFsaWFzTWV0aG9kKCduYW1lJykKICB9KTsKCiAgdmFyIGdvb2RHdXkgPSBBcHAuUGVyc29uLmNyZWF0ZSgpCiAgYGBgCgogIEBtZXRob2QgYWxpYXNNZXRob2QKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtTdHJpbmd9IG1ldGhvZE5hbWUgbmFtZSBvZiB0aGUgbWV0aG9kIHRvIGFsaWFzCiAgQHJldHVybiB7RW1iZXIuRGVzY3JpcHRvcn0KKi8KRW1iZXIuYWxpYXNNZXRob2QgPSBmdW5jdGlvbihtZXRob2ROYW1lKSB7CiAgcmV0dXJuIG5ldyBBbGlhcyhtZXRob2ROYW1lKTsKfTsKCi8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KLy8gT0JTRVJWRVIgSEVMUEVSCi8vCgovKioKICBTcGVjaWZ5IGEgbWV0aG9kIHRoYXQgb2JzZXJ2ZXMgcHJvcGVydHkgY2hhbmdlcy4KCiAgYGBgamF2YXNjcmlwdAogIEVtYmVyLk9iamVjdC5leHRlbmQoewogICAgdmFsdWVPYnNlcnZlcjogRW1iZXIub2JzZXJ2ZXIoJ3ZhbHVlJywgZnVuY3Rpb24oKSB7CiAgICAgIC8vIEV4ZWN1dGVzIHdoZW5ldmVyIHRoZSAidmFsdWUiIHByb3BlcnR5IGNoYW5nZXMKICAgIH0pCiAgfSk7CiAgYGBgCgogIEluIHRoZSBmdXR1cmUgdGhpcyBtZXRob2QgbWF5IGJlY29tZSBhc3luY2hyb25vdXMuIElmIHlvdSB3YW50IHRvIGVuc3VyZQogIHN5bmNocm9ub3VzIGJlaGF2aW9yLCB1c2UgYGltbWVkaWF0ZU9ic2VydmVyYC4KCiAgQWxzbyBhdmFpbGFibGUgYXMgYEZ1bmN0aW9uLnByb3RvdHlwZS5vYnNlcnZlc2AgaWYgcHJvdG90eXBlIGV4dGVuc2lvbnMgYXJlCiAgZW5hYmxlZC4KCiAgQG1ldGhvZCBvYnNlcnZlcgogIEBmb3IgRW1iZXIKICBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHlOYW1lcyoKICBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jCiAgQHJldHVybiBmdW5jCiovCkVtYmVyLm9ic2VydmVyID0gZnVuY3Rpb24oKSB7CiAgdmFyIGZ1bmMgID0gYV9zbGljZS5jYWxsKGFyZ3VtZW50cywgLTEpWzBdOwogIHZhciBwYXRoczsKCiAgCiAgICBwYXRocyA9IGFfc2xpY2UuY2FsbChhcmd1bWVudHMsIDAsIC0xKTsKCiAgICBpZiAodHlwZW9mIGZ1bmMgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgLy8gcmV2ZXJ0IHRvIG9sZCwgc29mdC1kZXByZWNhdGVkIGFyZ3VtZW50IG9yZGVyaW5nCgogICAgICBmdW5jICA9IGFyZ3VtZW50c1swXTsKICAgICAgcGF0aHMgPSBhX3NsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIH0KICAKCiAgaWYgKHR5cGVvZiBmdW5jICE9PSAiZnVuY3Rpb24iKSB7CiAgICB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoIkVtYmVyLm9ic2VydmVyIGNhbGxlZCB3aXRob3V0IGEgZnVuY3Rpb24iKTsKICB9CgogIGZ1bmMuX19lbWJlcl9vYnNlcnZlc19fID0gcGF0aHM7CiAgcmV0dXJuIGZ1bmM7Cn07CgovKioKICBTcGVjaWZ5IGEgbWV0aG9kIHRoYXQgb2JzZXJ2ZXMgcHJvcGVydHkgY2hhbmdlcy4KCiAgYGBgamF2YXNjcmlwdAogIEVtYmVyLk9iamVjdC5leHRlbmQoewogICAgdmFsdWVPYnNlcnZlcjogRW1iZXIuaW1tZWRpYXRlT2JzZXJ2ZXIoJ3ZhbHVlJywgZnVuY3Rpb24oKSB7CiAgICAgIC8vIEV4ZWN1dGVzIHdoZW5ldmVyIHRoZSAidmFsdWUiIHByb3BlcnR5IGNoYW5nZXMKICAgIH0pCiAgfSk7CiAgYGBgCgogIEluIHRoZSBmdXR1cmUsIGBFbWJlci5vYnNlcnZlcmAgbWF5IGJlY29tZSBhc3luY2hyb25vdXMuIEluIHRoaXMgZXZlbnQsCiAgYEVtYmVyLmltbWVkaWF0ZU9ic2VydmVyYCB3aWxsIG1haW50YWluIHRoZSBzeW5jaHJvbm91cyBiZWhhdmlvci4KCiAgQWxzbyBhdmFpbGFibGUgYXMgYEZ1bmN0aW9uLnByb3RvdHlwZS5vYnNlcnZlc0ltbWVkaWF0ZWx5YCBpZiBwcm90b3R5cGUgZXh0ZW5zaW9ucyBhcmUKICBlbmFibGVkLgoKICBAbWV0aG9kIGltbWVkaWF0ZU9ic2VydmVyCiAgQGZvciBFbWJlcgogIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eU5hbWVzKgogIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMKICBAcmV0dXJuIGZ1bmMKKi8KRW1iZXIuaW1tZWRpYXRlT2JzZXJ2ZXIgPSBmdW5jdGlvbigpIHsKICBmb3IgKHZhciBpPTAsIGw9YXJndW1lbnRzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgIHZhciBhcmcgPSBhcmd1bWVudHNbaV07CiAgICBFbWJlci5hc3NlcnQoIkltbWVkaWF0ZSBvYnNlcnZlcnMgbXVzdCBvYnNlcnZlIGludGVybmFsIHByb3BlcnRpZXMgb25seSwgbm90IHByb3BlcnRpZXMgb24gb3RoZXIgb2JqZWN0cy4iLCB0eXBlb2YgYXJnICE9PSAic3RyaW5nIiB8fCBhcmcuaW5kZXhPZignLicpID09PSAtMSk7CiAgfQoKICByZXR1cm4gRW1iZXIub2JzZXJ2ZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfTsKCi8qKgogIFdoZW4gb2JzZXJ2ZXJzIGZpcmUsIHRoZXkgYXJlIGNhbGxlZCB3aXRoIHRoZSBhcmd1bWVudHMgYG9iamAsIGBrZXlOYW1lYC4KCiAgTm90ZSwgYEBlYWNoLnByb3BlcnR5YCBvYnNlcnZlciBpcyBjYWxsZWQgcGVyIGVhY2ggYWRkIG9yIHJlcGxhY2Ugb2YgYW4gZWxlbWVudAogIGFuZCBpdCdzIG5vdCBjYWxsZWQgd2l0aCBhIHNwZWNpZmljIGVudW1lcmF0aW9uIGl0ZW0uCgogIEEgYGJlZm9yZU9ic2VydmVyYCBmaXJlcyBiZWZvcmUgYSBwcm9wZXJ0eSBjaGFuZ2VzLgoKICBBIGBiZWZvcmVPYnNlcnZlcmAgaXMgYW4gYWx0ZXJuYXRpdmUgZm9ybSBvZiBgLm9ic2VydmVzQmVmb3JlKClgLgoKICBgYGBqYXZhc2NyaXB0CiAgQXBwLlBlcnNvblZpZXcgPSBFbWJlci5WaWV3LmV4dGVuZCh7CgogICAgZnJpZW5kczogW3sgbmFtZTogJ1RvbScgfSwgeyBuYW1lOiAnU3RlZmFuJyB9LCB7IG5hbWU6ICdLcmlzJyB9XSwKCiAgICB2YWx1ZVdpbGxDaGFuZ2U6IEVtYmVyLmJlZm9yZU9ic2VydmVyKCdjb250ZW50LnZhbHVlJywgZnVuY3Rpb24ob2JqLCBrZXlOYW1lKSB7CiAgICAgIHRoaXMuY2hhbmdpbmdGcm9tID0gb2JqLmdldChrZXlOYW1lKTsKICAgIH0pLAoKICAgIHZhbHVlRGlkQ2hhbmdlOiBFbWJlci5vYnNlcnZlcignY29udGVudC52YWx1ZScsIGZ1bmN0aW9uKG9iaiwga2V5TmFtZSkgewogICAgICAgIC8vIG9ubHkgcnVuIGlmIHVwZGF0aW5nIGEgdmFsdWUgYWxyZWFkeSBpbiB0aGUgRE9NCiAgICAgICAgaWYgKHRoaXMuZ2V0KCdzdGF0ZScpID09PSAnaW5ET00nKSB7CiAgICAgICAgICB2YXIgY29sb3IgPSBvYmouZ2V0KGtleU5hbWUpID4gdGhpcy5jaGFuZ2luZ0Zyb20gPyAnZ3JlZW4nIDogJ3JlZCc7CiAgICAgICAgICAvLyBsb2dpYwogICAgICAgIH0KICAgIH0pLAoKICAgIGZyaWVuZHNEaWRDaGFuZ2U6IEVtYmVyLm9ic2VydmVyKCdmcmllbmRzLkBlYWNoLm5hbWUnLCBmdW5jdGlvbihvYmosIGtleU5hbWUpIHsKICAgICAgLy8gc29tZSBsb2dpYwogICAgICAvLyBvYmouZ2V0KGtleU5hbWUpIHJldHVybnMgZnJpZW5kcyBhcnJheQogICAgfSkKICB9KTsKICBgYGAKCiAgQWxzbyBhdmFpbGFibGUgYXMgYEZ1bmN0aW9uLnByb3RvdHlwZS5vYnNlcnZlc0JlZm9yZWAgaWYgcHJvdG90eXBlIGV4dGVuc2lvbnMgYXJlCiAgZW5hYmxlZC4KCiAgQG1ldGhvZCBiZWZvcmVPYnNlcnZlcgogIEBmb3IgRW1iZXIKICBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHlOYW1lcyoKICBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jCiAgQHJldHVybiBmdW5jCiovCkVtYmVyLmJlZm9yZU9ic2VydmVyID0gZnVuY3Rpb24oKSB7CiAgdmFyIGZ1bmMgID0gYV9zbGljZS5jYWxsKGFyZ3VtZW50cywgLTEpWzBdOwogIHZhciBwYXRoczsKCiAgCiAgICBwYXRocyA9IGFfc2xpY2UuY2FsbChhcmd1bWVudHMsIDAsIC0xKTsKCiAgICBpZiAodHlwZW9mIGZ1bmMgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgLy8gcmV2ZXJ0IHRvIG9sZCwgc29mdC1kZXByZWNhdGVkIGFyZ3VtZW50IG9yZGVyaW5nCgogICAgICBmdW5jICA9IGFyZ3VtZW50c1swXTsKICAgICAgcGF0aHMgPSBhX3NsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIH0KICAKCiAgaWYgKHR5cGVvZiBmdW5jICE9PSAiZnVuY3Rpb24iKSB7CiAgICB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoIkVtYmVyLmJlZm9yZU9ic2VydmVyIGNhbGxlZCB3aXRob3V0IGEgZnVuY3Rpb24iKTsKICB9CgogIGZ1bmMuX19lbWJlcl9vYnNlcnZlc0JlZm9yZV9fID0gcGF0aHM7CiAgcmV0dXJuIGZ1bmM7Cn07Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8vIFByb3ZpZGVzIGEgd2F5IHRvIHJlZ2lzdGVyIGxpYnJhcnkgdmVyc2lvbnMgd2l0aCBlbWJlci4KdmFyIGZvckVhY2ggPSBFbWJlci5FbnVtZXJhYmxlVXRpbHMuZm9yRWFjaCwKICAgIGluZGV4T2YgPSBFbWJlci5FbnVtZXJhYmxlVXRpbHMuaW5kZXhPZjsKCkVtYmVyLmxpYnJhcmllcyA9IGZ1bmN0aW9uKCkgewogIHZhciBsaWJyYXJpZXMgICAgPSBbXTsKICB2YXIgY29yZUxpYkluZGV4ID0gMDsKCiAgdmFyIGdldExpYnJhcnkgPSBmdW5jdGlvbihuYW1lKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpYnJhcmllcy5sZW5ndGg7IGkrKykgewogICAgICBpZiAobGlicmFyaWVzW2ldLm5hbWUgPT09IG5hbWUpIHsKICAgICAgICByZXR1cm4gbGlicmFyaWVzW2ldOwogICAgICB9CiAgICB9CiAgfTsKCiAgbGlicmFyaWVzLnJlZ2lzdGVyID0gZnVuY3Rpb24obmFtZSwgdmVyc2lvbikgewogICAgaWYgKCFnZXRMaWJyYXJ5KG5hbWUpKSB7CiAgICAgIGxpYnJhcmllcy5wdXNoKHtuYW1lOiBuYW1lLCB2ZXJzaW9uOiB2ZXJzaW9ufSk7CiAgICB9CiAgfTsKCiAgbGlicmFyaWVzLnJlZ2lzdGVyQ29yZUxpYnJhcnkgPSBmdW5jdGlvbihuYW1lLCB2ZXJzaW9uKSB7CiAgICBpZiAoIWdldExpYnJhcnkobmFtZSkpIHsKICAgICAgbGlicmFyaWVzLnNwbGljZShjb3JlTGliSW5kZXgrKywgMCwge25hbWU6IG5hbWUsIHZlcnNpb246IHZlcnNpb259KTsKICAgIH0KICB9OwoKICBsaWJyYXJpZXMuZGVSZWdpc3RlciA9IGZ1bmN0aW9uKG5hbWUpIHsKICAgIHZhciBsaWIgPSBnZXRMaWJyYXJ5KG5hbWUpOwogICAgaWYgKGxpYikgbGlicmFyaWVzLnNwbGljZShpbmRleE9mKGxpYnJhcmllcywgbGliKSwgMSk7CiAgfTsKCiAgbGlicmFyaWVzLmVhY2ggPSBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgIGZvckVhY2gobGlicmFyaWVzLCBmdW5jdGlvbihsaWIpIHsKICAgICAgY2FsbGJhY2sobGliLm5hbWUsIGxpYi52ZXJzaW9uKTsKICAgIH0pOwogIH07CgogIHJldHVybiBsaWJyYXJpZXM7Cn0oKTsKCkVtYmVyLmxpYnJhcmllcy5yZWdpc3RlckNvcmVMaWJyYXJ5KCdFbWJlcicsIEVtYmVyLlZFUlNJT04pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKRW1iZXIgTWV0YWwKCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1tZXRhbAoqLwoKfSkoKTsKCihmdW5jdGlvbigpIHsKLyoqCiAgQGNsYXNzIFJTVlAKICBAbW9kdWxlIFJTVlAKICAqLwpkZWZpbmUoInJzdnAvYWxsIiwgCiAgWyIuL3Byb21pc2UiLCJleHBvcnRzIl0sCiAgZnVuY3Rpb24oX19kZXBlbmRlbmN5MV9fLCBfX2V4cG9ydHNfXykgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIFByb21pc2UgPSBfX2RlcGVuZGVuY3kxX19bImRlZmF1bHQiXTsKCiAgICAvKioKICAgICAgVGhpcyBpcyBhIGNvbnZlbmllbnQgYWxpYXMgZm9yIGBSU1ZQLlByb21pc2UuYWxsYC4KCiAgICAgIEBtZXRob2QgYWxsCiAgICAgIEBmb3IgUlNWUAogICAgICBAcGFyYW0ge0FycmF5fSBhcnJheSBBcnJheSBvZiBwcm9taXNlcy4KICAgICAgQHBhcmFtIHtTdHJpbmd9IGxhYmVsIEFuIG9wdGlvbmFsIGxhYmVsLiBUaGlzIGlzIHVzZWZ1bAogICAgICBmb3IgdG9vbGluZy4KICAgICAgQHN0YXRpYwogICAgKi8KICAgIF9fZXhwb3J0c19fWyJkZWZhdWx0Il0gPSBmdW5jdGlvbiBhbGwoYXJyYXksIGxhYmVsKSB7CiAgICAgIHJldHVybiBQcm9taXNlLmFsbChhcnJheSwgbGFiZWwpOwogICAgfTsKICB9KTsKZGVmaW5lKCJyc3ZwL2FsbF9zZXR0bGVkIiwgCiAgWyIuL3Byb21pc2UiLCIuL3V0aWxzIiwiZXhwb3J0cyJdLAogIGZ1bmN0aW9uKF9fZGVwZW5kZW5jeTFfXywgX19kZXBlbmRlbmN5Ml9fLCBfX2V4cG9ydHNfXykgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIFByb21pc2UgPSBfX2RlcGVuZGVuY3kxX19bImRlZmF1bHQiXTsKICAgIHZhciBpc0FycmF5ID0gX19kZXBlbmRlbmN5Ml9fLmlzQXJyYXk7CiAgICB2YXIgaXNOb25UaGVuYWJsZSA9IF9fZGVwZW5kZW5jeTJfXy5pc05vblRoZW5hYmxlOwoKICAgIC8qKgogICAgICBgUlNWUC5hbGxTZXR0bGVkYCBpcyBzaW1pbGFyIHRvIGBSU1ZQLmFsbGAsIGJ1dCBpbnN0ZWFkIG9mIGltcGxlbWVudGluZwogICAgICBhIGZhaWwtZmFzdCBtZXRob2QsIGl0IHdhaXRzIHVudGlsIGFsbCB0aGUgcHJvbWlzZXMgaGF2ZSByZXR1cm5lZCBhbmQKICAgICAgc2hvd3MgeW91IGFsbCB0aGUgcmVzdWx0cy4gVGhpcyBpcyB1c2VmdWwgaWYgeW91IHdhbnQgdG8gaGFuZGxlIG11bHRpcGxlCiAgICAgIHByb21pc2VzJyBmYWlsdXJlIHN0YXRlcyB0b2dldGhlciBhcyBhIHNldC4KCiAgICAgIFJldHVybnMgYSBwcm9taXNlIHRoYXQgaXMgZnVsZmlsbGVkIHdoZW4gYWxsIHRoZSBnaXZlbiBwcm9taXNlcyBoYXZlIGJlZW4KICAgICAgc2V0dGxlZC4gVGhlIHJldHVybiBwcm9taXNlIGlzIGZ1bGZpbGxlZCB3aXRoIGFuIGFycmF5IG9mIHRoZSBzdGF0ZXMgb2YKICAgICAgdGhlIHByb21pc2VzIHBhc3NlZCBpbnRvIHRoZSBgcHJvbWlzZXNgIGFycmF5IGFyZ3VtZW50LgoKICAgICAgRWFjaCBzdGF0ZSBvYmplY3Qgd2lsbCBlaXRoZXIgaW5kaWNhdGUgZnVsZmlsbG1lbnQgb3IgcmVqZWN0aW9uLCBhbmQKICAgICAgcHJvdmlkZSB0aGUgY29ycmVzcG9uZGluZyB2YWx1ZSBvciByZWFzb24uIFRoZSBzdGF0ZXMgd2lsbCB0YWtlIG9uZSBvZgogICAgICB0aGUgZm9sbG93aW5nIGZvcm1hdHM6CgogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHsgc3RhdGU6ICdmdWxmaWxsZWQnLCB2YWx1ZTogdmFsdWUgfQogICAgICAgIG9yCiAgICAgIHsgc3RhdGU6ICdyZWplY3RlZCcsIHJlYXNvbjogcmVhc29uIH0KICAgICAgYGBgCgogICAgICBFeGFtcGxlOgoKICAgICAgYGBgamF2YXNjcmlwdAogICAgICB2YXIgcHJvbWlzZTEgPSBSU1ZQLlByb21pc2UucmVzb2x2ZSgxKTsKICAgICAgdmFyIHByb21pc2UyID0gUlNWUC5Qcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJzInKSk7CiAgICAgIHZhciBwcm9taXNlMyA9IFJTVlAuUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCczJykpOwogICAgICB2YXIgcHJvbWlzZXMgPSBbIHByb21pc2UxLCBwcm9taXNlMiwgcHJvbWlzZTMgXTsKCiAgICAgIFJTVlAuYWxsU2V0dGxlZChwcm9taXNlcykudGhlbihmdW5jdGlvbihhcnJheSl7CiAgICAgICAgLy8gYXJyYXkgPT0gWwogICAgICAgIC8vICAgeyBzdGF0ZTogJ2Z1bGZpbGxlZCcsIHZhbHVlOiAxIH0sCiAgICAgICAgLy8gICB7IHN0YXRlOiAncmVqZWN0ZWQnLCByZWFzb246IEVycm9yIH0sCiAgICAgICAgLy8gICB7IHN0YXRlOiAncmVqZWN0ZWQnLCByZWFzb246IEVycm9yIH0KICAgICAgICAvLyBdCiAgICAgICAgLy8gTm90ZSB0aGF0IGZvciB0aGUgc2Vjb25kIGl0ZW0sIHJlYXNvbi5tZXNzYWdlIHdpbGwgYmUgIjIiLCBhbmQgZm9yIHRoZQogICAgICAgIC8vIHRoaXJkIGl0ZW0sIHJlYXNvbi5tZXNzYWdlIHdpbGwgYmUgIjMiLgogICAgICB9LCBmdW5jdGlvbihlcnJvcikgewogICAgICAgIC8vIE5vdCBydW4uIChUaGlzIGJsb2NrIHdvdWxkIG9ubHkgYmUgY2FsbGVkIGlmIGFsbFNldHRsZWQgaGFkIGZhaWxlZCwKICAgICAgICAvLyBmb3IgaW5zdGFuY2UgaWYgcGFzc2VkIGFuIGluY29ycmVjdCBhcmd1bWVudCB0eXBlLikKICAgICAgfSk7CiAgICAgIGBgYAoKICAgICAgQG1ldGhvZCBhbGxTZXR0bGVkCiAgICAgIEBmb3IgUlNWUAogICAgICBAcGFyYW0ge0FycmF5fSBwcm9taXNlcwogICAgICBAcGFyYW0ge1N0cmluZ30gbGFiZWwgLSBvcHRpb25hbCBzdHJpbmcgdGhhdCBkZXNjcmliZXMgdGhlIHByb21pc2UuCiAgICAgIFVzZWZ1bCBmb3IgdG9vbGluZy4KICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZSB0aGF0IGlzIGZ1bGZpbGxlZCB3aXRoIGFuIGFycmF5IG9mIHRoZSBzZXR0bGVkCiAgICAgIHN0YXRlcyBvZiB0aGUgY29uc3RpdHVlbnQgcHJvbWlzZXMuCiAgICAgIEBzdGF0aWMKICAgICovCgogICAgX19leHBvcnRzX19bImRlZmF1bHQiXSA9IGZ1bmN0aW9uIGFsbFNldHRsZWQoZW50cmllcywgbGFiZWwpIHsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIGlmICghaXNBcnJheShlbnRyaWVzKSkgewogICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignWW91IG11c3QgcGFzcyBhbiBhcnJheSB0byBhbGxTZXR0bGVkLicpOwogICAgICAgIH0KCiAgICAgICAgdmFyIHJlbWFpbmluZyA9IGVudHJpZXMubGVuZ3RoOwogICAgICAgIHZhciBlbnRyeTsKCiAgICAgICAgaWYgKHJlbWFpbmluZyA9PT0gMCkgewogICAgICAgICAgcmVzb2x2ZShbXSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgcmVzdWx0cyA9IG5ldyBBcnJheShyZW1haW5pbmcpOwoKICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWRSZXNvbHZlcihpbmRleCkgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHJlc29sdmVBbGwoaW5kZXgsIGZ1bGZpbGxlZCh2YWx1ZSkpOwogICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkUmVzb2x2ZXIoaW5kZXgpIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICAgICAgcmVzb2x2ZUFsbChpbmRleCwgcmVqZWN0ZWQocmVhc29uKSk7CiAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUFsbChpbmRleCwgdmFsdWUpIHsKICAgICAgICAgIHJlc3VsdHNbaW5kZXhdID0gdmFsdWU7CiAgICAgICAgICBpZiAoLS1yZW1haW5pbmcgPT09IDApIHsKICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHRzKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGluZGV4ID0gMDsgaW5kZXggPCBlbnRyaWVzLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgZW50cnkgPSBlbnRyaWVzW2luZGV4XTsKCiAgICAgICAgICBpZiAoaXNOb25UaGVuYWJsZShlbnRyeSkpIHsKICAgICAgICAgICAgcmVzb2x2ZUFsbChpbmRleCwgZnVsZmlsbGVkKGVudHJ5KSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBQcm9taXNlLmNhc3QoZW50cnkpLnRoZW4oZnVsZmlsbGVkUmVzb2x2ZXIoaW5kZXgpLCByZWplY3RlZFJlc29sdmVyKGluZGV4KSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCBsYWJlbCk7CiAgICB9OwoKICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgewogICAgICByZXR1cm4geyBzdGF0ZTogJ2Z1bGZpbGxlZCcsIHZhbHVlOiB2YWx1ZSB9OwogICAgfQoKICAgIGZ1bmN0aW9uIHJlamVjdGVkKHJlYXNvbikgewogICAgICByZXR1cm4geyBzdGF0ZTogJ3JlamVjdGVkJywgcmVhc29uOiByZWFzb24gfTsKICAgIH0KICB9KTsKZGVmaW5lKCJyc3ZwL2NvbmZpZyIsIAogIFsiLi9ldmVudHMiLCJleHBvcnRzIl0sCiAgZnVuY3Rpb24oX19kZXBlbmRlbmN5MV9fLCBfX2V4cG9ydHNfXykgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIEV2ZW50VGFyZ2V0ID0gX19kZXBlbmRlbmN5MV9fWyJkZWZhdWx0Il07CgogICAgdmFyIGNvbmZpZyA9IHsKICAgICAgaW5zdHJ1bWVudDogZmFsc2UKICAgIH07CgogICAgRXZlbnRUYXJnZXQubWl4aW4oY29uZmlnKTsKCiAgICBmdW5jdGlvbiBjb25maWd1cmUobmFtZSwgdmFsdWUpIHsKICAgICAgaWYgKG5hbWUgPT09ICdvbmVycm9yJykgewogICAgICAgIC8vIGhhbmRsZSBmb3IgbGVnYWN5IHVzZXJzIHRoYXQgZXhwZWN0IHRoZSBhY3R1YWwKICAgICAgICAvLyBlcnJvciB0byBiZSBwYXNzZWQgdG8gdGhlaXIgZnVuY3Rpb24gYWRkZWQgdmlhCiAgICAgICAgLy8gYFJTVlAuY29uZmlndXJlKCdvbmVycm9yJywgc29tZUZ1bmN0aW9uSGVyZSk7YAogICAgICAgIGNvbmZpZy5vbignZXJyb3InLCB2YWx1ZSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikgewogICAgICAgIGNvbmZpZ1tuYW1lXSA9IHZhbHVlOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBjb25maWdbbmFtZV07CiAgICAgIH0KICAgIH0KCiAgICBfX2V4cG9ydHNfXy5jb25maWcgPSBjb25maWc7CiAgICBfX2V4cG9ydHNfXy5jb25maWd1cmUgPSBjb25maWd1cmU7CiAgfSk7CmRlZmluZSgicnN2cC9kZWZlciIsIAogIFsiLi9wcm9taXNlIiwiZXhwb3J0cyJdLAogIGZ1bmN0aW9uKF9fZGVwZW5kZW5jeTFfXywgX19leHBvcnRzX18pIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBQcm9taXNlID0gX19kZXBlbmRlbmN5MV9fWyJkZWZhdWx0Il07CgogICAgLyoqCiAgICAgIGBSU1ZQLmRlZmVyYCByZXR1cm5zIGFuIG9iamVjdCBzaW1pbGFyIHRvIGpRdWVyeSdzIGAkLkRlZmVycmVkYC4KICAgICAgYFJTVlAuZGVmZXJgIHNob3VsZCBiZSB1c2VkIHdoZW4gcG9ydGluZyBvdmVyIGNvZGUgcmVsaWFudCBvbiBgJC5EZWZlcnJlZGAncwogICAgICBpbnRlcmZhY2UuIE5ldyBjb2RlIHNob3VsZCB1c2UgdGhlIGBSU1ZQLlByb21pc2VgIGNvbnN0cnVjdG9yIGluc3RlYWQuCgogICAgICBUaGUgb2JqZWN0IHJldHVybmVkIGZyb20gYFJTVlAuZGVmZXJgIGlzIGEgcGxhaW4gb2JqZWN0IHdpdGggdGhyZWUgcHJvcGVydGllczoKCiAgICAgICogcHJvbWlzZSAtIGFuIGBSU1ZQLlByb21pc2VgLgogICAgICAqIHJlamVjdCAtIGEgZnVuY3Rpb24gdGhhdCBjYXVzZXMgdGhlIGBwcm9taXNlYCBwcm9wZXJ0eSBvbiB0aGlzIG9iamVjdCB0bwogICAgICAgIGJlY29tZSByZWplY3RlZAogICAgICAqIHJlc29sdmUgLSBhIGZ1bmN0aW9uIHRoYXQgY2F1c2VzIHRoZSBgcHJvbWlzZWAgcHJvcGVydHkgb24gdGhpcyBvYmplY3QgdG8KICAgICAgICBiZWNvbWUgZnVsZmlsbGVkLgoKICAgICAgRXhhbXBsZToKCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgICB2YXIgZGVmZXJyZWQgPSBSU1ZQLmRlZmVyKCk7CgogICAgICAgZGVmZXJyZWQucmVzb2x2ZSgiU3VjY2VzcyEiKTsKCiAgICAgICBkZWZlcmVkLnByb21pc2UudGhlbihmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgIC8vIHZhbHVlIGhlcmUgaXMgIlN1Y2Nlc3MhIgogICAgICAgfSk7CiAgICAgICBgYGAKCiAgICAgIEBtZXRob2QgZGVmZXIKICAgICAgQGZvciBSU1ZQCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBsYWJlbCBvcHRpb25hbCBzdHJpbmcgZm9yIGxhYmVsaW5nIHRoZSBwcm9taXNlLgogICAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICAgIEByZXR1cm4ge09iamVjdH0KICAgICAqLwoKICAgIF9fZXhwb3J0c19fWyJkZWZhdWx0Il0gPSBmdW5jdGlvbiBkZWZlcihsYWJlbCkgewogICAgICB2YXIgZGVmZXJyZWQgPSB7IH07CgogICAgICBkZWZlcnJlZC5wcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSA9IHJlc29sdmU7CiAgICAgICAgZGVmZXJyZWQucmVqZWN0ID0gcmVqZWN0OwogICAgICB9LCBsYWJlbCk7CgogICAgICByZXR1cm4gZGVmZXJyZWQ7CiAgICB9OwogIH0pOwpkZWZpbmUoInJzdnAvZXZlbnRzIiwgCiAgWyJleHBvcnRzIl0sCiAgZnVuY3Rpb24oX19leHBvcnRzX18pIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBpbmRleE9mID0gZnVuY3Rpb24oY2FsbGJhY2tzLCBjYWxsYmFjaykgewogICAgICBmb3IgKHZhciBpPTAsIGw9Y2FsbGJhY2tzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICBpZiAoY2FsbGJhY2tzW2ldID09PSBjYWxsYmFjaykgeyByZXR1cm4gaTsgfQogICAgICB9CgogICAgICByZXR1cm4gLTE7CiAgICB9OwoKICAgIHZhciBjYWxsYmFja3NGb3IgPSBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgdmFyIGNhbGxiYWNrcyA9IG9iamVjdC5fcHJvbWlzZUNhbGxiYWNrczsKCiAgICAgIGlmICghY2FsbGJhY2tzKSB7CiAgICAgICAgY2FsbGJhY2tzID0gb2JqZWN0Ll9wcm9taXNlQ2FsbGJhY2tzID0ge307CiAgICAgIH0KCiAgICAgIHJldHVybiBjYWxsYmFja3M7CiAgICB9OwoKICAgIC8qKgogICAgICBAY2xhc3MgUlNWUC5FdmVudFRhcmdldAogICAgKi8KICAgIF9fZXhwb3J0c19fWyJkZWZhdWx0Il0gPSB7CgogICAgICAvKioKICAgICAgICBgUlNWUC5FdmVudFRhcmdldC5taXhpbmAgZXh0ZW5kcyBhbiBvYmplY3Qgd2l0aCBFdmVudFRhcmdldCBtZXRob2RzLiBGb3IKICAgICAgICBFeGFtcGxlOgoKICAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgICAgdmFyIG9iamVjdCA9IHt9OwoKICAgICAgICBSU1ZQLkV2ZW50VGFyZ2V0Lm1peGluKG9iamVjdCk7CgogICAgICAgIG9iamVjdC5vbigiZmluaXNoZWQiLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgLy8gaGFuZGxlIGV2ZW50CiAgICAgICAgfSk7CgogICAgICAgIG9iamVjdC50cmlnZ2VyKCJmaW5pc2hlZCIsIHsgZGV0YWlsOiB2YWx1ZSB9KTsKICAgICAgICBgYGAKCiAgICAgICAgYEV2ZW50VGFyZ2V0Lm1peGluYCBhbHNvIHdvcmtzIHdpdGggcHJvdG90eXBlczoKCiAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICAgIHZhciBQZXJzb24gPSBmdW5jdGlvbigpIHt9OwogICAgICAgIFJTVlAuRXZlbnRUYXJnZXQubWl4aW4oUGVyc29uLnByb3RvdHlwZSk7CgogICAgICAgIHZhciB5ZWh1ZGEgPSBuZXcgUGVyc29uKCk7CiAgICAgICAgdmFyIHRvbSA9IG5ldyBQZXJzb24oKTsKCiAgICAgICAgeWVodWRhLm9uKCJwb2tlIiwgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKCJZZWh1ZGEgc2F5cyBPVyIpOwogICAgICAgIH0pOwoKICAgICAgICB0b20ub24oInBva2UiLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgY29uc29sZS5sb2coIlRvbSBzYXlzIE9XIik7CiAgICAgICAgfSk7CgogICAgICAgIHllaHVkYS50cmlnZ2VyKCJwb2tlIik7CiAgICAgICAgdG9tLnRyaWdnZXIoInBva2UiKTsKICAgICAgICBgYGAKCiAgICAgICAgQG1ldGhvZCBtaXhpbgogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBvYmplY3Qgb2JqZWN0IHRvIGV4dGVuZCB3aXRoIEV2ZW50VGFyZ2V0IG1ldGhvZHMKICAgICAgICBAcHJpdmF0ZQogICAgICAqLwogICAgICBtaXhpbjogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgb2JqZWN0Lm9uID0gdGhpcy5vbjsKICAgICAgICBvYmplY3Qub2ZmID0gdGhpcy5vZmY7CiAgICAgICAgb2JqZWN0LnRyaWdnZXIgPSB0aGlzLnRyaWdnZXI7CiAgICAgICAgb2JqZWN0Ll9wcm9taXNlQ2FsbGJhY2tzID0gdW5kZWZpbmVkOwogICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICBSZWdpc3RlcnMgYSBjYWxsYmFjayB0byBiZSBleGVjdXRlZCB3aGVuIGBldmVudE5hbWVgIGlzIHRyaWdnZXJlZAoKICAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgICAgb2JqZWN0Lm9uKCdldmVudCcsIGZ1bmN0aW9uKGV2ZW50SW5mbyl7CiAgICAgICAgICAvLyBoYW5kbGUgdGhlIGV2ZW50CiAgICAgICAgfSk7CgogICAgICAgIG9iamVjdC50cmlnZ2VyKCdldmVudCcpOwogICAgICAgIGBgYAoKICAgICAgICBAbWV0aG9kIG9uCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50TmFtZSBuYW1lIG9mIHRoZSBldmVudCB0byBsaXN0ZW4gZm9yCiAgICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHdoZW4gdGhlIGV2ZW50IGlzIHRyaWdnZXJlZC4KICAgICAgICBAcHJpdmF0ZQogICAgICAqLwogICAgICBvbjogZnVuY3Rpb24oZXZlbnROYW1lLCBjYWxsYmFjaykgewogICAgICAgIHZhciBhbGxDYWxsYmFja3MgPSBjYWxsYmFja3NGb3IodGhpcyksIGNhbGxiYWNrczsKCiAgICAgICAgY2FsbGJhY2tzID0gYWxsQ2FsbGJhY2tzW2V2ZW50TmFtZV07CgogICAgICAgIGlmICghY2FsbGJhY2tzKSB7CiAgICAgICAgICBjYWxsYmFja3MgPSBhbGxDYWxsYmFja3NbZXZlbnROYW1lXSA9IFtdOwogICAgICAgIH0KCiAgICAgICAgaWYgKGluZGV4T2YoY2FsbGJhY2tzLCBjYWxsYmFjaykgPT09IC0xKSB7CiAgICAgICAgICBjYWxsYmFja3MucHVzaChjYWxsYmFjayk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAgWW91IGNhbiB1c2UgYG9mZmAgdG8gc3RvcCBmaXJpbmcgYSBwYXJ0aWN1bGFyIGNhbGxiYWNrIGZvciBhbiBldmVudDoKCiAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICAgIGZ1bmN0aW9uIGRvU3R1ZmYoKSB7IC8vIGRvIHN0dWZmISB9CiAgICAgICAgb2JqZWN0Lm9uKCdzdHVmZicsIGRvU3R1ZmYpOwoKICAgICAgICBvYmplY3QudHJpZ2dlcignc3R1ZmYnKTsgLy8gZG9TdHVmZiB3aWxsIGJlIGNhbGxlZAoKICAgICAgICAvLyBVbnJlZ2lzdGVyIE9OTFkgdGhlIGRvU3R1ZmYgY2FsbGJhY2sKICAgICAgICBvYmplY3Qub2ZmKCdzdHVmZicsIGRvU3R1ZmYpOwogICAgICAgIG9iamVjdC50cmlnZ2VyKCdzdHVmZicpOyAvLyBkb1N0dWZmIHdpbGwgTk9UIGJlIGNhbGxlZAogICAgICAgIGBgYAoKICAgICAgICBJZiB5b3UgZG9uJ3QgcGFzcyBhIGBjYWxsYmFja2AgYXJndW1lbnQgdG8gYG9mZmAsIEFMTCBjYWxsYmFja3MgZm9yIHRoZQogICAgICAgIGV2ZW50IHdpbGwgbm90IGJlIGV4ZWN1dGVkIHdoZW4gdGhlIGV2ZW50IGZpcmVzLiBGb3IgZXhhbXBsZToKCiAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICAgIHZhciBjYWxsYmFjazEgPSBmdW5jdGlvbigpe307CiAgICAgICAgdmFyIGNhbGxiYWNrMiA9IGZ1bmN0aW9uKCl7fTsKCiAgICAgICAgb2JqZWN0Lm9uKCdzdHVmZicsIGNhbGxiYWNrMSk7CiAgICAgICAgb2JqZWN0Lm9uKCdzdHVmZicsIGNhbGxiYWNrMik7CgogICAgICAgIG9iamVjdC50cmlnZ2VyKCdzdHVmZicpOyAvLyBjYWxsYmFjazEgYW5kIGNhbGxiYWNrMiB3aWxsIGJlIGV4ZWN1dGVkLgoKICAgICAgICBvYmplY3Qub2ZmKCdzdHVmZicpOwogICAgICAgIG9iamVjdC50cmlnZ2VyKCdzdHVmZicpOyAvLyBjYWxsYmFjazEgYW5kIGNhbGxiYWNrMiB3aWxsIG5vdCBiZSBleGVjdXRlZCEKICAgICAgICBgYGAKCiAgICAgICAgQG1ldGhvZCBvZmYKICAgICAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnROYW1lIGV2ZW50IHRvIHN0b3AgbGlzdGVuaW5nIHRvCiAgICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgb3B0aW9uYWwgYXJndW1lbnQuIElmIGdpdmVuLCBvbmx5IHRoZSBmdW5jdGlvbgogICAgICAgIGdpdmVuIHdpbGwgYmUgcmVtb3ZlZCBmcm9tIHRoZSBldmVudCdzIGNhbGxiYWNrIHF1ZXVlLiBJZiBubyBgY2FsbGJhY2tgCiAgICAgICAgYXJndW1lbnQgaXMgZ2l2ZW4sIGFsbCBjYWxsYmFja3Mgd2lsbCBiZSByZW1vdmVkIGZyb20gdGhlIGV2ZW50J3MgY2FsbGJhY2sKICAgICAgICBxdWV1ZS4KICAgICAgICBAcHJpdmF0ZQoKICAgICAgKi8KICAgICAgb2ZmOiBmdW5jdGlvbihldmVudE5hbWUsIGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIGFsbENhbGxiYWNrcyA9IGNhbGxiYWNrc0Zvcih0aGlzKSwgY2FsbGJhY2tzLCBpbmRleDsKCiAgICAgICAgaWYgKCFjYWxsYmFjaykgewogICAgICAgICAgYWxsQ2FsbGJhY2tzW2V2ZW50TmFtZV0gPSBbXTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNhbGxiYWNrcyA9IGFsbENhbGxiYWNrc1tldmVudE5hbWVdOwoKICAgICAgICBpbmRleCA9IGluZGV4T2YoY2FsbGJhY2tzLCBjYWxsYmFjayk7CgogICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHsgY2FsbGJhY2tzLnNwbGljZShpbmRleCwgMSk7IH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgIFVzZSBgdHJpZ2dlcmAgdG8gZmlyZSBjdXN0b20gZXZlbnRzLiBGb3IgZXhhbXBsZToKCiAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICAgIG9iamVjdC5vbignZm9vJywgZnVuY3Rpb24oKXsKICAgICAgICAgIGNvbnNvbGUubG9nKCdmb28gZXZlbnQgaGFwcGVuZWQhJyk7CiAgICAgICAgfSk7CiAgICAgICAgb2JqZWN0LnRyaWdnZXIoJ2ZvbycpOwogICAgICAgIC8vICdmb28gZXZlbnQgaGFwcGVuZWQhJyBsb2dnZWQgdG8gdGhlIGNvbnNvbGUKICAgICAgICBgYGAKCiAgICAgICAgWW91IGNhbiBhbHNvIHBhc3MgYSB2YWx1ZSBhcyBhIHNlY29uZCBhcmd1bWVudCB0byBgdHJpZ2dlcmAgdGhhdCB3aWxsIGJlCiAgICAgICAgcGFzc2VkIGFzIGFuIGFyZ3VtZW50IHRvIGFsbCBldmVudCBsaXN0ZW5lcnMgZm9yIHRoZSBldmVudDoKCiAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICAgIG9iamVjdC5vbignZm9vJywgZnVuY3Rpb24odmFsdWUpewogICAgICAgICAgY29uc29sZS5sb2codmFsdWUubmFtZSk7CiAgICAgICAgfSk7CgogICAgICAgIG9iamVjdC50cmlnZ2VyKCdmb28nLCB7IG5hbWU6ICdiYXInIH0pOwogICAgICAgIC8vICdiYXInIGxvZ2dlZCB0byB0aGUgY29uc29sZQogICAgICAgIGBgYAoKICAgICAgICBAbWV0aG9kIHRyaWdnZXIKICAgICAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnROYW1lIG5hbWUgb2YgdGhlIGV2ZW50IHRvIGJlIHRyaWdnZXJlZAogICAgICAgIEBwYXJhbSB7QW55fSBvcHRpb25zIG9wdGlvbmFsIHZhbHVlIHRvIGJlIHBhc3NlZCB0byBhbnkgZXZlbnQgaGFuZGxlcnMgZm9yCiAgICAgICAgdGhlIGdpdmVuIGBldmVudE5hbWVgCiAgICAgICAgQHByaXZhdGUKICAgICAgKi8KICAgICAgdHJpZ2dlcjogZnVuY3Rpb24oZXZlbnROYW1lLCBvcHRpb25zKSB7CiAgICAgICAgdmFyIGFsbENhbGxiYWNrcyA9IGNhbGxiYWNrc0Zvcih0aGlzKSwKICAgICAgICAgICAgY2FsbGJhY2tzLCBjYWxsYmFja1R1cGxlLCBjYWxsYmFjaywgYmluZGluZzsKCiAgICAgICAgaWYgKGNhbGxiYWNrcyA9IGFsbENhbGxiYWNrc1tldmVudE5hbWVdKSB7CiAgICAgICAgICAvLyBEb24ndCBjYWNoZSB0aGUgY2FsbGJhY2tzLmxlbmd0aCBzaW5jZSBpdCBtYXkgZ3JvdwogICAgICAgICAgZm9yICh2YXIgaT0wOyBpPGNhbGxiYWNrcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrc1tpXTsKCiAgICAgICAgICAgIGNhbGxiYWNrKG9wdGlvbnMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9KTsKZGVmaW5lKCJyc3ZwL2ZpbHRlciIsIAogIFsiLi9hbGwiLCIuL21hcCIsIi4vdXRpbHMiLCJleHBvcnRzIl0sCiAgZnVuY3Rpb24oX19kZXBlbmRlbmN5MV9fLCBfX2RlcGVuZGVuY3kyX18sIF9fZGVwZW5kZW5jeTNfXywgX19leHBvcnRzX18pIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBhbGwgPSBfX2RlcGVuZGVuY3kxX19bImRlZmF1bHQiXTsKICAgIHZhciBtYXAgPSBfX2RlcGVuZGVuY3kyX19bImRlZmF1bHQiXTsKICAgIHZhciBpc0Z1bmN0aW9uID0gX19kZXBlbmRlbmN5M19fLmlzRnVuY3Rpb247CiAgICB2YXIgaXNBcnJheSA9IF9fZGVwZW5kZW5jeTNfXy5pc0FycmF5OwoKICAgIC8qKgogICAgIGBSU1ZQLmZpbHRlcmAgaXMgc2ltaWxhciB0byBKYXZhU2NyaXB0J3MgbmF0aXZlIGBmaWx0ZXJgIG1ldGhvZCwgZXhjZXB0IHRoYXQgaXQKICAgICAgd2FpdHMgZm9yIGFsbCBwcm9taXNlcyB0byBiZWNvbWUgZnVsZmlsbGVkIGJlZm9yZSBydW5uaW5nIHRoZSBgZmlsdGVyRm5gIG9uCiAgICAgIGVhY2ggaXRlbSBpbiBnaXZlbiB0byBgcHJvbWlzZXNgLiBgUlNWUC5maWx0ZXJgIHJldHVybnMgYSBwcm9taXNlIHRoYXQgd2lsbAogICAgICBiZWNvbWUgZnVsZmlsbGVkIHdpdGggdGhlIHJlc3VsdCBvZiBydW5uaW5nIGBmaWx0ZXJGbmAgb24gdGhlIHZhbHVlcyB0aGUKICAgICAgcHJvbWlzZXMgYmVjb21lIGZ1bGZpbGxlZCB3aXRoLgoKICAgICAgRm9yIGV4YW1wbGU6CgogICAgICBgYGBqYXZhc2NyaXB0CgogICAgICB2YXIgcHJvbWlzZTEgPSBSU1ZQLnJlc29sdmUoMSk7CiAgICAgIHZhciBwcm9taXNlMiA9IFJTVlAucmVzb2x2ZSgyKTsKICAgICAgdmFyIHByb21pc2UzID0gUlNWUC5yZXNvbHZlKDMpOwoKICAgICAgdmFyIGZpbHRlckZuID0gZnVuY3Rpb24oaXRlbSl7CiAgICAgICAgcmV0dXJuIGl0ZW0gPiAxOwogICAgICB9OwoKICAgICAgUlNWUC5maWx0ZXIocHJvbWlzZXMsIGZpbHRlckZuKS50aGVuKGZ1bmN0aW9uKHJlc3VsdCl7CiAgICAgICAgLy8gcmVzdWx0IGlzIFsgMiwgMyBdCiAgICAgIH0pOwogICAgICBgYGAKCiAgICAgIElmIGFueSBvZiB0aGUgYHByb21pc2VzYCBnaXZlbiB0byBgUlNWUC5maWx0ZXJgIGFyZSByZWplY3RlZCwgdGhlIGZpcnN0IHByb21pc2UKICAgICAgdGhhdCBpcyByZWplY3RlZCB3aWxsIGJlIGdpdmVuIGFzIGFuIGFyZ3VtZW50IHRvIHRoZSByZXR1cm5lZCBwcm9taXNlJ3MKICAgICAgcmVqZWN0aW9uIGhhbmRsZXIuIEZvciBleGFtcGxlOgoKICAgICAgYGBgamF2YXNjcmlwdAogICAgICB2YXIgcHJvbWlzZTEgPSBSU1ZQLnJlc29sdmUoMSk7CiAgICAgIHZhciBwcm9taXNlMiA9IFJTVlAucmVqZWN0KG5ldyBFcnJvcigiMiIpKTsKICAgICAgdmFyIHByb21pc2UzID0gUlNWUC5yZWplY3QobmV3IEVycm9yKCIzIikpOwogICAgICB2YXIgcHJvbWlzZXMgPSBbIHByb21pc2UxLCBwcm9taXNlMiwgcHJvbWlzZTMgXTsKCiAgICAgIHZhciBmaWx0ZXJGbiA9IGZ1bmN0aW9uKGl0ZW0pewogICAgICAgIHJldHVybiBpdGVtID4gMTsKICAgICAgfTsKCiAgICAgIFJTVlAuZmlsdGVyKHByb21pc2VzLCBmaWx0ZXJGbikudGhlbihmdW5jdGlvbihhcnJheSl7CiAgICAgICAgLy8gQ29kZSBoZXJlIG5ldmVyIHJ1bnMgYmVjYXVzZSB0aGVyZSBhcmUgcmVqZWN0ZWQgcHJvbWlzZXMhCiAgICAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgIC8vIHJlYXNvbi5tZXNzYWdlID09PSAiMiIKICAgICAgfSk7CiAgICAgIGBgYAoKICAgICAgYFJTVlAuZmlsdGVyYCB3aWxsIGFsc28gd2FpdCBmb3IgYW55IHByb21pc2VzIHJldHVybmVkIGZyb20gYGZpbHRlckZuYC4KICAgICAgRm9yIGluc3RhbmNlLCB5b3UgbWF5IHdhbnQgdG8gZmV0Y2ggYSBsaXN0IG9mIHVzZXJzIHRoZW4gcmV0dXJuIGEgc3Vic2V0CiAgICAgIG9mIHRob3NlIHVzZXJzIGJhc2VkIG9uIHNvbWUgYXN5bmNocm9ub3VzIG9wZXJhdGlvbjoKCiAgICAgIGBgYGphdmFzY3JpcHQKCiAgICAgIHZhciBhbGljZSA9IHsgbmFtZTogJ2FsaWNlJyB9OwogICAgICB2YXIgYm9iICAgPSB7IG5hbWU6ICdib2InIH07CiAgICAgIHZhciB1c2VycyA9IFsgYWxpY2UsIGJvYiBdOwoKICAgICAgdmFyIHByb21pc2VzID0gdXNlcnMubWFwKGZ1bmN0aW9uKHVzZXIpewogICAgICAgIHJldHVybiBSU1ZQLnJlc29sdmUodXNlcik7CiAgICAgIH0pOwoKICAgICAgdmFyIGZpbHRlckZuID0gZnVuY3Rpb24odXNlcil7CiAgICAgICAgLy8gSGVyZSwgQWxpY2UgaGFzIHBlcm1pc3Npb25zIHRvIGNyZWF0ZSBhIGJsb2cgcG9zdCwgYnV0IEJvYiBkb2VzIG5vdC4KICAgICAgICByZXR1cm4gZ2V0UHJpdmlsZWdlc0ZvclVzZXIodXNlcikudGhlbihmdW5jdGlvbihwcml2cyl7CiAgICAgICAgICByZXR1cm4gcHJpdnMuY2FuX2NyZWF0ZV9ibG9nX3Bvc3QgPT09IHRydWU7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFJTVlAuZmlsdGVyKHByb21pc2VzLCBmaWx0ZXJGbikudGhlbihmdW5jdGlvbih1c2Vycyl7CiAgICAgICAgLy8gdHJ1ZSwgYmVjYXVzZSB0aGUgc2VydmVyIHRvbGQgdXMgb25seSBBbGljZSBjYW4gY3JlYXRlIGEgYmxvZyBwb3N0LgogICAgICAgIHVzZXJzLmxlbmd0aCA9PT0gMTsKICAgICAgICAvLyBmYWxzZSwgYmVjYXVzZSBBbGljZSBpcyB0aGUgb25seSB1c2VyIHByZXNlbnQgaW4gYHVzZXJzYAogICAgICAgIHVzZXJzWzBdID09PSBib2I7CiAgICAgIH0pOwogICAgICBgYGAKCiAgICAgIEBtZXRob2QgZmlsdGVyCiAgICAgIEBmb3IgUlNWUAogICAgICBAcGFyYW0ge0FycmF5fSBwcm9taXNlcwogICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBmaWx0ZXJGbiAtIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBvbiBlYWNoIHJlc29sdmVkIHZhbHVlIHRvCiAgICAgIGZpbHRlciB0aGUgZmluYWwgcmVzdWx0cy4KICAgICAgQHBhcmFtIHtTdHJpbmd9IGxhYmVsIG9wdGlvbmFsIHN0cmluZyBkZXNjcmliaW5nIHRoZSBwcm9taXNlLiBVc2VmdWwgZm9yCiAgICAgIHRvb2xpbmcuCiAgICAgIEByZXR1cm4ge1Byb21pc2V9CiAgICAqLwogICAgZnVuY3Rpb24gZmlsdGVyKHByb21pc2VzLCBmaWx0ZXJGbiwgbGFiZWwpIHsKICAgICAgcmV0dXJuIGFsbChwcm9taXNlcywgbGFiZWwpLnRoZW4oZnVuY3Rpb24odmFsdWVzKXsKICAgICAgICBpZiAoIWlzQXJyYXkocHJvbWlzZXMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdZb3UgbXVzdCBwYXNzIGFuIGFycmF5IHRvIGZpbHRlci4nKTsKICAgICAgICB9CgogICAgICAgIGlmICghaXNGdW5jdGlvbihmaWx0ZXJGbikpewogICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiWW91IG11c3QgcGFzcyBhIGZ1bmN0aW9uIHRvIGZpbHRlcidzIHNlY29uZCBhcmd1bWVudC4iKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBtYXAocHJvbWlzZXMsIGZpbHRlckZuLCBsYWJlbCkudGhlbihmdW5jdGlvbihmaWx0ZXJSZXN1bHRzKXsKICAgICAgICAgICB2YXIgaSwKICAgICAgICAgICAgICAgdmFsdWVzTGVuID0gdmFsdWVzLmxlbmd0aCwKICAgICAgICAgICAgICAgZmlsdGVyZWQgPSBbXTsKCiAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHZhbHVlc0xlbjsgaSsrKXsKICAgICAgICAgICAgIGlmKGZpbHRlclJlc3VsdHNbaV0pIGZpbHRlcmVkLnB1c2godmFsdWVzW2ldKTsKICAgICAgICAgICB9CiAgICAgICAgICAgcmV0dXJuIGZpbHRlcmVkOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KCiAgICBfX2V4cG9ydHNfX1siZGVmYXVsdCJdID0gZmlsdGVyOwogIH0pOwpkZWZpbmUoInJzdnAvaGFzaCIsIAogIFsiLi9wcm9taXNlIiwiLi91dGlscyIsImV4cG9ydHMiXSwKICBmdW5jdGlvbihfX2RlcGVuZGVuY3kxX18sIF9fZGVwZW5kZW5jeTJfXywgX19leHBvcnRzX18pIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBQcm9taXNlID0gX19kZXBlbmRlbmN5MV9fWyJkZWZhdWx0Il07CiAgICB2YXIgaXNOb25UaGVuYWJsZSA9IF9fZGVwZW5kZW5jeTJfXy5pc05vblRoZW5hYmxlOwogICAgdmFyIGtleXNPZiA9IF9fZGVwZW5kZW5jeTJfXy5rZXlzT2Y7CgogICAgLyoqCiAgICAgIGBSU1ZQLmhhc2hgIGlzIHNpbWlsYXIgdG8gYFJTVlAuYWxsYCwgYnV0IHRha2VzIGFuIG9iamVjdCBpbnN0ZWFkIG9mIGFuIGFycmF5CiAgICAgIGZvciBpdHMgYHByb21pc2VzYCBhcmd1bWVudC4KCiAgICAgIFJldHVybnMgYSBwcm9taXNlIHRoYXQgaXMgZnVsZmlsbGVkIHdoZW4gYWxsIHRoZSBnaXZlbiBwcm9taXNlcyBoYXZlIGJlZW4KICAgICAgZnVsZmlsbGVkLCBvciByZWplY3RlZCBpZiBhbnkgb2YgdGhlbSBiZWNvbWUgcmVqZWN0ZWQuIFRoZSByZXR1cm5lZCBwcm9taXNlCiAgICAgIGlzIGZ1bGZpbGxlZCB3aXRoIGEgaGFzaCB0aGF0IGhhcyB0aGUgc2FtZSBrZXkgbmFtZXMgYXMgdGhlIGBwcm9taXNlc2Agb2JqZWN0CiAgICAgIGFyZ3VtZW50LiBJZiBhbnkgb2YgdGhlIHZhbHVlcyBpbiB0aGUgb2JqZWN0IGFyZSBub3QgcHJvbWlzZXMsIHRoZXkgd2lsbAogICAgICBzaW1wbHkgYmUgY29waWVkIG92ZXIgdG8gdGhlIGZ1bGZpbGxlZCBvYmplY3QuCgogICAgICBFeGFtcGxlOgoKICAgICAgYGBgamF2YXNjcmlwdAogICAgICB2YXIgcHJvbWlzZXMgPSB7CiAgICAgICAgbXlQcm9taXNlOiBSU1ZQLnJlc29sdmUoMSksCiAgICAgICAgeW91clByb21pc2U6IFJTVlAucmVzb2x2ZSgyKSwKICAgICAgICB0aGVpclByb21pc2U6IFJTVlAucmVzb2x2ZSgzKSwKICAgICAgICBub3RBUHJvbWlzZTogNAogICAgICB9OwoKICAgICAgUlNWUC5oYXNoKHByb21pc2VzKS50aGVuKGZ1bmN0aW9uKGhhc2gpewogICAgICAgIC8vIGhhc2ggaGVyZSBpcyBhbiBvYmplY3QgdGhhdCBsb29rcyBsaWtlOgogICAgICAgIC8vIHsKICAgICAgICAvLyAgIG15UHJvbWlzZTogMSwKICAgICAgICAvLyAgIHlvdXJQcm9taXNlOiAyLAogICAgICAgIC8vICAgdGhlaXJQcm9taXNlOiAzLAogICAgICAgIC8vICAgbm90QVByb21pc2U6IDQKICAgICAgICAvLyB9CiAgICAgIH0pOwogICAgICBgYGBgCgogICAgICBJZiBhbnkgb2YgdGhlIGBwcm9taXNlc2AgZ2l2ZW4gdG8gYFJTVlAuaGFzaGAgYXJlIHJlamVjdGVkLCB0aGUgZmlyc3QgcHJvbWlzZQogICAgICB0aGF0IGlzIHJlamVjdGVkIHdpbGwgYmUgZ2l2ZW4gYXMgdGhlIHJlYXNvbiB0byB0aGUgcmVqZWN0aW9uIGhhbmRsZXIuCgogICAgICBFeGFtcGxlOgoKICAgICAgYGBgamF2YXNjcmlwdAogICAgICB2YXIgcHJvbWlzZXMgPSB7CiAgICAgICAgbXlQcm9taXNlOiBSU1ZQLnJlc29sdmUoMSksCiAgICAgICAgcmVqZWN0ZWRQcm9taXNlOiBSU1ZQLnJlamVjdChuZXcgRXJyb3IoInJlamVjdGVkUHJvbWlzZSIpKSwKICAgICAgICBhbm90aGVyUmVqZWN0ZWRQcm9taXNlOiBSU1ZQLnJlamVjdChuZXcgRXJyb3IoImFub3RoZXJSZWplY3RlZFByb21pc2UiKSksCiAgICAgIH07CgogICAgICBSU1ZQLmhhc2gocHJvbWlzZXMpLnRoZW4oZnVuY3Rpb24oaGFzaCl7CiAgICAgICAgLy8gQ29kZSBoZXJlIG5ldmVyIHJ1bnMgYmVjYXVzZSB0aGVyZSBhcmUgcmVqZWN0ZWQgcHJvbWlzZXMhCiAgICAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgIC8vIHJlYXNvbi5tZXNzYWdlID09PSAicmVqZWN0ZWRQcm9taXNlIgogICAgICB9KTsKICAgICAgYGBgCgogICAgICBBbiBpbXBvcnRhbnQgbm90ZTogYFJTVlAuaGFzaGAgaXMgaW50ZW5kZWQgZm9yIHBsYWluIEphdmFTY3JpcHQgb2JqZWN0cyB0aGF0CiAgICAgIGFyZSBqdXN0IGEgc2V0IG9mIGtleXMgYW5kIHZhbHVlcy4gYFJTVlAuaGFzaGAgd2lsbCBOT1QgcHJlc2VydmUgcHJvdG90eXBlCiAgICAgIGNoYWlucy4KCiAgICAgIEV4YW1wbGU6CgogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGZ1bmN0aW9uIE15Q29uc3RydWN0b3IoKXsKICAgICAgICB0aGlzLmV4YW1wbGUgPSBSU1ZQLnJlc29sdmUoIkV4YW1wbGUiKTsKICAgICAgfQoKICAgICAgTXlDb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSB7CiAgICAgICAgcHJvdG9Qcm9wZXJ0eTogUlNWUC5yZXNvbHZlKCJQcm90byBQcm9wZXJ0eSIpCiAgICAgIH07CgogICAgICB2YXIgbXlPYmplY3QgPSBuZXcgTXlDb25zdHJ1Y3RvcigpOwoKICAgICAgUlNWUC5oYXNoKG15T2JqZWN0KS50aGVuKGZ1bmN0aW9uKGhhc2gpewogICAgICAgIC8vIHByb3RvUHJvcGVydHkgd2lsbCBub3QgYmUgcHJlc2VudCwgaW5zdGVhZCB5b3Ugd2lsbCBqdXN0IGhhdmUgYW4KICAgICAgICAvLyBvYmplY3QgdGhhdCBsb29rcyBsaWtlOgogICAgICAgIC8vIHsKICAgICAgICAvLyAgIGV4YW1wbGU6ICJFeGFtcGxlIgogICAgICAgIC8vIH0KICAgICAgICAvLwogICAgICAgIC8vIGhhc2guaGFzT3duUHJvcGVydHkoJ3Byb3RvUHJvcGVydHknKTsgLy8gZmFsc2UKICAgICAgICAvLyAndW5kZWZpbmVkJyA9PT0gdHlwZW9mIGhhc2gucHJvdG9Qcm9wZXJ0eQogICAgICB9KTsKICAgICAgYGBgCgogICAgICBAbWV0aG9kIGhhc2gKICAgICAgQGZvciBSU1ZQCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBwcm9taXNlcwogICAgICBAcGFyYW0ge1N0cmluZ30gbGFiZWwgb3B0aW9uYWwgc3RyaW5nIHRoYXQgZGVzY3JpYmVzIHRoZSBwcm9taXNlLgogICAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UgdGhhdCBpcyBmdWxmaWxsZWQgd2hlbiBhbGwgcHJvcGVydGllcyBvZiBgcHJvbWlzZXNgCiAgICAgIGhhdmUgYmVlbiBmdWxmaWxsZWQsIG9yIHJlamVjdGVkIGlmIGFueSBvZiB0aGVtIGJlY29tZSByZWplY3RlZC4KICAgICAgQHN0YXRpYwogICAgKi8KICAgIF9fZXhwb3J0c19fWyJkZWZhdWx0Il0gPSBmdW5jdGlvbiBoYXNoKG9iamVjdCwgbGFiZWwpIHsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCl7CiAgICAgICAgdmFyIHJlc3VsdHMgPSB7fTsKICAgICAgICB2YXIga2V5cyA9IGtleXNPZihvYmplY3QpOwogICAgICAgIHZhciByZW1haW5pbmcgPSBrZXlzLmxlbmd0aDsKICAgICAgICB2YXIgZW50cnksIHByb3BlcnR5OwoKICAgICAgICBpZiAocmVtYWluaW5nID09PSAwKSB7CiAgICAgICAgICByZXNvbHZlKHJlc3VsdHMpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWRUbyhwcm9wZXJ0eSkgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHJlc3VsdHNbcHJvcGVydHldID0gdmFsdWU7CiAgICAgICAgICAgIGlmICgtLXJlbWFpbmluZyA9PT0gMCkgewogICAgICAgICAgICAgIHJlc29sdmUocmVzdWx0cyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBvblJlamVjdGlvbihyZWFzb24pIHsKICAgICAgICAgIHJlbWFpbmluZyA9IDA7CiAgICAgICAgICByZWplY3QocmVhc29uKTsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgcHJvcGVydHkgPSBrZXlzW2ldOwogICAgICAgICAgZW50cnkgPSBvYmplY3RbcHJvcGVydHldOwoKICAgICAgICAgIGlmIChpc05vblRoZW5hYmxlKGVudHJ5KSkgewogICAgICAgICAgICByZXN1bHRzW3Byb3BlcnR5XSA9IGVudHJ5OwogICAgICAgICAgICBpZiAoLS1yZW1haW5pbmcgPT09IDApIHsKICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdHMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBQcm9taXNlLmNhc3QoZW50cnkpLnRoZW4oZnVsZmlsbGVkVG8ocHJvcGVydHkpLCBvblJlamVjdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH07CiAgfSk7CmRlZmluZSgicnN2cC9pbnN0cnVtZW50IiwgCiAgWyIuL2NvbmZpZyIsIi4vdXRpbHMiLCJleHBvcnRzIl0sCiAgZnVuY3Rpb24oX19kZXBlbmRlbmN5MV9fLCBfX2RlcGVuZGVuY3kyX18sIF9fZXhwb3J0c19fKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgY29uZmlnID0gX19kZXBlbmRlbmN5MV9fLmNvbmZpZzsKICAgIHZhciBub3cgPSBfX2RlcGVuZGVuY3kyX18ubm93OwoKICAgIF9fZXhwb3J0c19fWyJkZWZhdWx0Il0gPSBmdW5jdGlvbiBpbnN0cnVtZW50KGV2ZW50TmFtZSwgcHJvbWlzZSwgY2hpbGQpIHsKICAgICAgLy8gaW5zdHJ1bWVudGF0aW9uIHNob3VsZCBub3QgZGlzcnVwdCBub3JtYWwgdXNhZ2UuCiAgICAgIHRyeSB7CiAgICAgICAgY29uZmlnLnRyaWdnZXIoZXZlbnROYW1lLCB7CiAgICAgICAgICBndWlkOiBwcm9taXNlLl9ndWlkS2V5ICsgcHJvbWlzZS5faWQsCiAgICAgICAgICBldmVudE5hbWU6IGV2ZW50TmFtZSwKICAgICAgICAgIGRldGFpbDogcHJvbWlzZS5fZGV0YWlsLAogICAgICAgICAgY2hpbGRHdWlkOiBjaGlsZCAmJiBwcm9taXNlLl9ndWlkS2V5ICsgY2hpbGQuX2lkLAogICAgICAgICAgbGFiZWw6IHByb21pc2UuX2xhYmVsLAogICAgICAgICAgdGltZVN0YW1wOiBub3coKSwKICAgICAgICAgIHN0YWNrOiBuZXcgRXJyb3IocHJvbWlzZS5fbGFiZWwpLnN0YWNrCiAgICAgICAgfSk7CiAgICAgIH0gY2F0Y2goZXJyb3IpIHsKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9LCAwKTsKICAgICAgfQogICAgfTsKICB9KTsKZGVmaW5lKCJyc3ZwL21hcCIsIAogIFsiLi9wcm9taXNlIiwiLi9hbGwiLCIuL3V0aWxzIiwiZXhwb3J0cyJdLAogIGZ1bmN0aW9uKF9fZGVwZW5kZW5jeTFfXywgX19kZXBlbmRlbmN5Ml9fLCBfX2RlcGVuZGVuY3kzX18sIF9fZXhwb3J0c19fKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgUHJvbWlzZSA9IF9fZGVwZW5kZW5jeTFfX1siZGVmYXVsdCJdOwogICAgdmFyIGFsbCA9IF9fZGVwZW5kZW5jeTJfX1siZGVmYXVsdCJdOwogICAgdmFyIGlzQXJyYXkgPSBfX2RlcGVuZGVuY3kzX18uaXNBcnJheTsKICAgIHZhciBpc0Z1bmN0aW9uID0gX19kZXBlbmRlbmN5M19fLmlzRnVuY3Rpb247CgogICAgLyoqCiAgICAgYFJTVlAubWFwYCBpcyBzaW1pbGFyIHRvIEphdmFTY3JpcHQncyBuYXRpdmUgYG1hcGAgbWV0aG9kLCBleGNlcHQgdGhhdCBpdAogICAgICB3YWl0cyBmb3IgYWxsIHByb21pc2VzIHRvIGJlY29tZSBmdWxmaWxsZWQgYmVmb3JlIHJ1bm5pbmcgdGhlIGBtYXBGbmAgb24KICAgICAgZWFjaCBpdGVtIGluIGdpdmVuIHRvIGBwcm9taXNlc2AuIGBSU1ZQLm1hcGAgcmV0dXJucyBhIHByb21pc2UgdGhhdCB3aWxsCiAgICAgIGJlY29tZSBmdWxmaWxsZWQgd2l0aCB0aGUgcmVzdWx0IG9mIHJ1bm5pbmcgYG1hcEZuYCBvbiB0aGUgdmFsdWVzIHRoZSBwcm9taXNlcwogICAgICBiZWNvbWUgZnVsZmlsbGVkIHdpdGguCgogICAgICBGb3IgZXhhbXBsZToKCiAgICAgIGBgYGphdmFzY3JpcHQKCiAgICAgIHZhciBwcm9taXNlMSA9IFJTVlAucmVzb2x2ZSgxKTsKICAgICAgdmFyIHByb21pc2UyID0gUlNWUC5yZXNvbHZlKDIpOwogICAgICB2YXIgcHJvbWlzZTMgPSBSU1ZQLnJlc29sdmUoMyk7CiAgICAgIHZhciBwcm9taXNlcyA9IFsgcHJvbWlzZTEsIHByb21pc2UyLCBwcm9taXNlMyBdOwoKICAgICAgdmFyIG1hcEZuID0gZnVuY3Rpb24oaXRlbSl7CiAgICAgICAgcmV0dXJuIGl0ZW0gKyAxOwogICAgICB9OwoKICAgICAgUlNWUC5tYXAocHJvbWlzZXMsIG1hcEZuKS50aGVuKGZ1bmN0aW9uKHJlc3VsdCl7CiAgICAgICAgLy8gcmVzdWx0IGlzIFsgMiwgMywgNCBdCiAgICAgIH0pOwogICAgICBgYGAKCiAgICAgIElmIGFueSBvZiB0aGUgYHByb21pc2VzYCBnaXZlbiB0byBgUlNWUC5tYXBgIGFyZSByZWplY3RlZCwgdGhlIGZpcnN0IHByb21pc2UKICAgICAgdGhhdCBpcyByZWplY3RlZCB3aWxsIGJlIGdpdmVuIGFzIGFuIGFyZ3VtZW50IHRvIHRoZSByZXR1cm5lZCBwcm9taXNlJ3MKICAgICAgcmVqZWN0aW9uIGhhbmRsZXIuIEZvciBleGFtcGxlOgoKICAgICAgYGBgamF2YXNjcmlwdAogICAgICB2YXIgcHJvbWlzZTEgPSBSU1ZQLnJlc29sdmUoMSk7CiAgICAgIHZhciBwcm9taXNlMiA9IFJTVlAucmVqZWN0KG5ldyBFcnJvcigiMiIpKTsKICAgICAgdmFyIHByb21pc2UzID0gUlNWUC5yZWplY3QobmV3IEVycm9yKCIzIikpOwogICAgICB2YXIgcHJvbWlzZXMgPSBbIHByb21pc2UxLCBwcm9taXNlMiwgcHJvbWlzZTMgXTsKCiAgICAgIHZhciBtYXBGbiA9IGZ1bmN0aW9uKGl0ZW0pewogICAgICAgIHJldHVybiBpdGVtICsgMTsKICAgICAgfTsKCiAgICAgIFJTVlAubWFwKHByb21pc2VzLCBtYXBGbikudGhlbihmdW5jdGlvbihhcnJheSl7CiAgICAgICAgLy8gQ29kZSBoZXJlIG5ldmVyIHJ1bnMgYmVjYXVzZSB0aGVyZSBhcmUgcmVqZWN0ZWQgcHJvbWlzZXMhCiAgICAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgIC8vIHJlYXNvbi5tZXNzYWdlID09PSAiMiIKICAgICAgfSk7CiAgICAgIGBgYAoKICAgICAgYFJTVlAubWFwYCB3aWxsIGFsc28gd2FpdCBpZiBhIHByb21pc2UgaXMgcmV0dXJuZWQgZnJvbSBgbWFwRm5gLiBGb3IgZXhhbXBsZSwKICAgICAgc2F5IHlvdSB3YW50IHRvIGdldCBhbGwgY29tbWVudHMgZnJvbSBhIHNldCBvZiBibG9nIHBvc3RzLCBidXQgeW91IG5lZWQKICAgICAgdGhlIGJsb2cgcG9zdHMgZmlyc3QgYmVjdWFzZSB0aGV5IGNvbnRhaW4gYSB1cmwgdG8gdGhvc2UgY29tbWVudHMuCgogICAgICBgYGBqYXZzY3JpcHQKCiAgICAgIHZhciBtYXBGbiA9IGZ1bmN0aW9uKGJsb2dQb3N0KXsKICAgICAgICAvLyBnZXRDb21tZW50cyBkb2VzIHNvbWUgYWpheCBhbmQgcmV0dXJucyBhbiBSU1ZQLlByb21pc2UgdGhhdCBpcyBmdWxmaWxsZWQKICAgICAgICAvLyB3aXRoIHNvbWUgY29tbWVudHMgZGF0YQogICAgICAgIHJldHVybiBnZXRDb21tZW50cyhibG9nUG9zdC5jb21tZW50c191cmwpOwogICAgICB9OwoKICAgICAgLy8gZ2V0QmxvZ1Bvc3RzIGRvZXMgc29tZSBhamF4IGFuZCByZXR1cm5zIGFuIFJTVlAuUHJvbWlzZSB0aGF0IGlzIGZ1bGZpbGxlZAogICAgICAvLyB3aXRoIHNvbWUgYmxvZyBwb3N0IGRhdGEKICAgICAgUlNWUC5tYXAoZ2V0QmxvZ1Bvc3RzKCksIG1hcEZuKS50aGVuKGZ1bmN0aW9uKGNvbW1lbnRzKXsKICAgICAgICAvLyBjb21tZW50cyBpcyB0aGUgcmVzdWx0IG9mIGFza2luZyB0aGUgc2VydmVyIGZvciB0aGUgY29tbWVudHMKICAgICAgICAvLyBvZiBhbGwgYmxvZyBwb3N0cyByZXR1cm5lZCBmcm9tIGdldEJsb2dQb3N0cygpCiAgICAgIH0pOwogICAgICBgYGAKCiAgICAgIEBtZXRob2QgbWFwCiAgICAgIEBmb3IgUlNWUAogICAgICBAcGFyYW0ge0FycmF5fSBwcm9taXNlcwogICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBtYXBGbiBmdW5jdGlvbiB0byBiZSBjYWxsZWQgb24gZWFjaCBmdWxmaWxsZWQgcHJvbWlzZS4KICAgICAgQHBhcmFtIHtTdHJpbmd9IGxhYmVsIG9wdGlvbmFsIHN0cmluZyBmb3IgbGFiZWxpbmcgdGhlIHByb21pc2UuCiAgICAgIFVzZWZ1bCBmb3IgdG9vbGluZy4KICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZSB0aGF0IGlzIGZ1bGZpbGxlZCB3aXRoIHRoZSByZXN1bHQgb2YgY2FsbGluZwogICAgICBgbWFwRm5gIG9uIGVhY2ggZnVsZmlsbGVkIHByb21pc2Ugb3IgdmFsdWUgd2hlbiB0aGV5IGJlY29tZSBmdWxmaWxsZWQuCiAgICAgICBUaGUgcHJvbWlzZSB3aWxsIGJlIHJlamVjdGVkIGlmIGFueSBvZiB0aGUgZ2l2ZW4gYHByb21pc2VzYCBiZWNvbWUgcmVqZWN0ZWQuCiAgICAgIEBzdGF0aWMKICAgICovCiAgICBfX2V4cG9ydHNfX1siZGVmYXVsdCJdID0gZnVuY3Rpb24gbWFwKHByb21pc2VzLCBtYXBGbiwgbGFiZWwpIHsKICAgICAgcmV0dXJuIGFsbChwcm9taXNlcywgbGFiZWwpLnRoZW4oZnVuY3Rpb24ocmVzdWx0cyl7CiAgICAgICAgaWYgKCFpc0FycmF5KHByb21pc2VzKSkgewogICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignWW91IG11c3QgcGFzcyBhbiBhcnJheSB0byBtYXAuJyk7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWlzRnVuY3Rpb24obWFwRm4pKXsKICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIllvdSBtdXN0IHBhc3MgYSBmdW5jdGlvbiB0byBtYXAncyBzZWNvbmQgYXJndW1lbnQuIik7CiAgICAgICAgfQoKCiAgICAgICAgdmFyIHJlc3VsdExlbiA9IHJlc3VsdHMubGVuZ3RoLAogICAgICAgICAgICBtYXBwZWRSZXN1bHRzID0gW10sCiAgICAgICAgICAgIGk7CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCByZXN1bHRMZW47IGkrKyl7CiAgICAgICAgICBtYXBwZWRSZXN1bHRzLnB1c2gobWFwRm4ocmVzdWx0c1tpXSkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGFsbChtYXBwZWRSZXN1bHRzLCBsYWJlbCk7CiAgICAgIH0pOwogICAgfTsKICB9KTsKZGVmaW5lKCJyc3ZwL25vZGUiLCAKICBbIi4vcHJvbWlzZSIsImV4cG9ydHMiXSwKICBmdW5jdGlvbihfX2RlcGVuZGVuY3kxX18sIF9fZXhwb3J0c19fKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgUHJvbWlzZSA9IF9fZGVwZW5kZW5jeTFfX1siZGVmYXVsdCJdOwoKICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKCiAgICBmdW5jdGlvbiBtYWtlTm9kZUNhbGxiYWNrRm9yKHJlc29sdmUsIHJlamVjdCkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKGVycm9yLCB2YWx1ZSkgewogICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICB9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAyKSB7CiAgICAgICAgICByZXNvbHZlKHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc29sdmUodmFsdWUpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAgYFJTVlAuZGVub2RlaWZ5YCB0YWtlcyBhICJub2RlLXN0eWxlIiBmdW5jdGlvbiBhbmQgcmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQKICAgICAgd2lsbCByZXR1cm4gYW4gYFJTVlAuUHJvbWlzZWAuIFlvdSBjYW4gdXNlIGBkZW5vZGVpZnlgIGluIE5vZGUuanMgb3IgdGhlCiAgICAgIGJyb3dzZXIgd2hlbiB5b3UnZCBwcmVmZXIgdG8gdXNlIHByb21pc2VzIG92ZXIgdXNpbmcgY2FsbGJhY2tzLiBGb3IgZXhhbXBsZSwKICAgICAgYGRlbm9kZWlmeWAgdHJhbnNmb3JtcyB0aGUgZm9sbG93aW5nOgoKICAgICAgYGBgamF2YXNjcmlwdAogICAgICB2YXIgZnMgPSByZXF1aXJlKCdmcycpOwoKICAgICAgZnMucmVhZEZpbGUoJ215ZmlsZS50eHQnLCBmdW5jdGlvbihlcnIsIGRhdGEpewogICAgICAgIGlmIChlcnIpIHJldHVybiBoYW5kbGVFcnJvcihlcnIpOwogICAgICAgIGhhbmRsZURhdGEoZGF0YSk7CiAgICAgIH0pOwogICAgICBgYGAKCiAgICAgIGludG86CgogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHZhciBmcyA9IHJlcXVpcmUoJ2ZzJyk7CgogICAgICB2YXIgcmVhZEZpbGUgPSBSU1ZQLmRlbm9kZWlmeShmcy5yZWFkRmlsZSk7CgogICAgICByZWFkRmlsZSgnbXlmaWxlLnR4dCcpLnRoZW4oaGFuZGxlRGF0YSwgaGFuZGxlRXJyb3IpOwogICAgICBgYGAKCiAgICAgIFVzaW5nIGBkZW5vZGVpZnlgIG1ha2VzIGl0IGVhc2llciB0byBjb21wb3NlIGFzeW5jaHJvbm91cyBvcGVyYXRpb25zIGluc3RlYWQKICAgICAgb2YgdXNpbmcgY2FsbGJhY2tzLiBGb3IgZXhhbXBsZSwgaW5zdGVhZCBvZjoKCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgdmFyIGZzID0gcmVxdWlyZSgnZnMnKTsKICAgICAgdmFyIGxvZyA9IHJlcXVpcmUoJ3NvbWUtYXN5bmMtbG9nZ2VyJyk7CgogICAgICBmcy5yZWFkRmlsZSgnbXlmaWxlLnR4dCcsIGZ1bmN0aW9uKGVyciwgZGF0YSl7CiAgICAgICAgaWYgKGVycikgcmV0dXJuIGhhbmRsZUVycm9yKGVycik7CiAgICAgICAgZnMud3JpdGVGaWxlKCdteWZpbGUyLnR4dCcsIGRhdGEsIGZ1bmN0aW9uKGVycil7CiAgICAgICAgICBpZiAoZXJyKSB0aHJvdyBlcnI7CiAgICAgICAgICBsb2coJ3N1Y2Nlc3MnLCBmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgaWYgKGVycikgdGhyb3cgZXJyOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICBgYGAKCiAgICAgIFlvdSBjYW4gY2hhaW4gdGhlIG9wZXJhdGlvbnMgdG9nZXRoZXIgdXNpbmcgYHRoZW5gIGZyb20gdGhlIHJldHVybmVkIHByb21pc2U6CgogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHZhciBmcyA9IHJlcXVpcmUoJ2ZzJyk7CiAgICAgIHZhciBkZW5vZGVpZnkgPSBSU1ZQLmRlbm9kZWlmeTsKICAgICAgdmFyIHJlYWRGaWxlID0gZGVub2RlaWZ5KGZzLnJlYWRGaWxlKTsKICAgICAgdmFyIHdyaXRlRmlsZSA9IGRlbm9kZWlmeShmcy53cml0ZUZpbGUpOwogICAgICB2YXIgbG9nID0gZGVub2RlaWZ5KHJlcXVpcmUoJ3NvbWUtYXN5bmMtbG9nZ2VyJykpOwoKICAgICAgcmVhZEZpbGUoJ215ZmlsZS50eHQnKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgIHJldHVybiB3cml0ZUZpbGUoJ215ZmlsZTIudHh0JywgZGF0YSk7CiAgICAgIH0pLnRoZW4oZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gbG9nKCdTVUNDRVNTJyk7CiAgICAgIH0pLnRoZW4oZnVuY3Rpb24oKXsKICAgICAgICAvLyBzdWNjZXNzIGhhbmRsZXIKICAgICAgfSwgZnVuY3Rpb24ocmVhc29uKXsKICAgICAgICAvLyByZWplY3Rpb24gaGFuZGxlcgogICAgICB9KTsKICAgICAgYGBgCgogICAgICBAbWV0aG9kIGRlbm9kZWlmeQogICAgICBAZm9yIFJTVlAKICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gbm9kZUZ1bmMgYSAibm9kZS1zdHlsZSIgZnVuY3Rpb24gdGhhdCB0YWtlcyBhIGNhbGxiYWNrIGFzCiAgICAgIGl0cyBsYXN0IGFyZ3VtZW50LiBUaGUgY2FsbGJhY2sgZXhwZWN0cyBhbiBlcnJvciB0byBiZSBwYXNzZWQgYXMgaXRzIGZpcnN0CiAgICAgIGFyZ3VtZW50IChpZiBhbiBlcnJvciBvY2N1cnJlZCwgb3RoZXJ3aXNlIG51bGwpLCBhbmQgdGhlIHZhbHVlIGZyb20gdGhlCiAgICAgIG9wZXJhdGlvbiBhcyBpdHMgc2Vjb25kIGFyZ3VtZW50ICgiZnVuY3Rpb24oZXJyLCB2YWx1ZSl7IH0iKS4KICAgICAgQHBhcmFtIHtBbnl9IGJpbmRpbmcgb3B0aW9uYWwgYXJndW1lbnQgZm9yIGJpbmRpbmcgdGhlICJ0aGlzIiB2YWx1ZSB3aGVuCiAgICAgIGNhbGxpbmcgdGhlIGBub2RlRnVuY2AgZnVuY3Rpb24uCiAgICAgIEByZXR1cm4ge0Z1bmN0aW9ufSBhIGZ1bmN0aW9uIHRoYXQgd3JhcHMgYG5vZGVGdW5jYCB0byByZXR1cm4gYW4KICAgICAgYFJTVlAuUHJvbWlzZWAKICAgICAgQHN0YXRpYwogICAgKi8KICAgIF9fZXhwb3J0c19fWyJkZWZhdWx0Il0gPSBmdW5jdGlvbiBkZW5vZGVpZnkobm9kZUZ1bmMsIGJpbmRpbmcpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgIHsKICAgICAgICB2YXIgbm9kZUFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyksIHJlc29sdmUsIHJlamVjdDsKICAgICAgICB2YXIgdGhpc0FyZyA9IHRoaXMgfHwgYmluZGluZzsKCiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgUHJvbWlzZS5hbGwobm9kZUFyZ3MpLnRoZW4oZnVuY3Rpb24obm9kZUFyZ3MpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBub2RlQXJncy5wdXNoKG1ha2VOb2RlQ2FsbGJhY2tGb3IocmVzb2x2ZSwgcmVqZWN0KSk7CiAgICAgICAgICAgICAgbm9kZUZ1bmMuYXBwbHkodGhpc0FyZywgbm9kZUFyZ3MpOwogICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICByZWplY3QoZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9OwogICAgfTsKICB9KTsKZGVmaW5lKCJyc3ZwL3Byb21pc2UiLCAKICBbIi4vY29uZmlnIiwiLi9ldmVudHMiLCIuL2luc3RydW1lbnQiLCIuL3V0aWxzIiwiLi9wcm9taXNlL2Nhc3QiLCIuL3Byb21pc2UvYWxsIiwiLi9wcm9taXNlL3JhY2UiLCIuL3Byb21pc2UvcmVzb2x2ZSIsIi4vcHJvbWlzZS9yZWplY3QiLCJleHBvcnRzIl0sCiAgZnVuY3Rpb24oX19kZXBlbmRlbmN5MV9fLCBfX2RlcGVuZGVuY3kyX18sIF9fZGVwZW5kZW5jeTNfXywgX19kZXBlbmRlbmN5NF9fLCBfX2RlcGVuZGVuY3k1X18sIF9fZGVwZW5kZW5jeTZfXywgX19kZXBlbmRlbmN5N19fLCBfX2RlcGVuZGVuY3k4X18sIF9fZGVwZW5kZW5jeTlfXywgX19leHBvcnRzX18pIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBjb25maWcgPSBfX2RlcGVuZGVuY3kxX18uY29uZmlnOwogICAgdmFyIEV2ZW50VGFyZ2V0ID0gX19kZXBlbmRlbmN5Ml9fWyJkZWZhdWx0Il07CiAgICB2YXIgaW5zdHJ1bWVudCA9IF9fZGVwZW5kZW5jeTNfX1siZGVmYXVsdCJdOwogICAgdmFyIG9iamVjdE9yRnVuY3Rpb24gPSBfX2RlcGVuZGVuY3k0X18ub2JqZWN0T3JGdW5jdGlvbjsKICAgIHZhciBpc0Z1bmN0aW9uID0gX19kZXBlbmRlbmN5NF9fLmlzRnVuY3Rpb247CiAgICB2YXIgbm93ID0gX19kZXBlbmRlbmN5NF9fLm5vdzsKICAgIHZhciBjYXN0ID0gX19kZXBlbmRlbmN5NV9fWyJkZWZhdWx0Il07CiAgICB2YXIgYWxsID0gX19kZXBlbmRlbmN5Nl9fWyJkZWZhdWx0Il07CiAgICB2YXIgcmFjZSA9IF9fZGVwZW5kZW5jeTdfX1siZGVmYXVsdCJdOwogICAgdmFyIFJlc29sdmUgPSBfX2RlcGVuZGVuY3k4X19bImRlZmF1bHQiXTsKICAgIHZhciBSZWplY3QgPSBfX2RlcGVuZGVuY3k5X19bImRlZmF1bHQiXTsKCiAgICB2YXIgZ3VpZEtleSA9ICdyc3ZwXycgKyBub3coKSArICctJzsKICAgIHZhciBjb3VudGVyID0gMDsKCiAgICBmdW5jdGlvbiBub29wKCkge30KCiAgICBfX2V4cG9ydHNfX1siZGVmYXVsdCJdID0gUHJvbWlzZTsKCgogICAgLyoqCiAgICAgIFByb21pc2Ugb2JqZWN0cyByZXByZXNlbnQgdGhlIGV2ZW50dWFsIHJlc3VsdCBvZiBhbiBhc3luY2hyb25vdXMgb3BlcmF0aW9uLiBUaGUKICAgICAgcHJpbWFyeSB3YXkgb2YgaW50ZXJhY3Rpbmcgd2l0aCBhIHByb21pc2UgaXMgdGhyb3VnaCBpdHMgYHRoZW5gIG1ldGhvZCwgd2hpY2gKICAgICAgcmVnaXN0ZXJzIGNhbGxiYWNrcyB0byByZWNlaXZlIGVpdGhlciBhIHByb21pc2XigJlzIGV2ZW50dWFsIHZhbHVlIG9yIHRoZSByZWFzb24KICAgICAgd2h5IHRoZSBwcm9taXNlIGNhbm5vdCBiZSBmdWxmaWxsZWQuCgogICAgICBUZXJtaW5vbG9neQogICAgICAtLS0tLS0tLS0tLQoKICAgICAgLSBgcHJvbWlzZWAgaXMgYW4gb2JqZWN0IG9yIGZ1bmN0aW9uIHdpdGggYSBgdGhlbmAgbWV0aG9kIHdob3NlIGJlaGF2aW9yIGNvbmZvcm1zIHRvIHRoaXMgc3BlY2lmaWNhdGlvbi4KICAgICAgLSBgdGhlbmFibGVgIGlzIGFuIG9iamVjdCBvciBmdW5jdGlvbiB0aGF0IGRlZmluZXMgYSBgdGhlbmAgbWV0aG9kLgogICAgICAtIGB2YWx1ZWAgaXMgYW55IGxlZ2FsIEphdmFTY3JpcHQgdmFsdWUgKGluY2x1ZGluZyB1bmRlZmluZWQsIGEgdGhlbmFibGUsIG9yIGEgcHJvbWlzZSkuCiAgICAgIC0gYGV4Y2VwdGlvbmAgaXMgYSB2YWx1ZSB0aGF0IGlzIHRocm93biB1c2luZyB0aGUgdGhyb3cgc3RhdGVtZW50LgogICAgICAtIGByZWFzb25gIGlzIGEgdmFsdWUgdGhhdCBpbmRpY2F0ZXMgd2h5IGEgcHJvbWlzZSB3YXMgcmVqZWN0ZWQuCiAgICAgIC0gYHNldHRsZWRgIHRoZSBmaW5hbCByZXN0aW5nIHN0YXRlIG9mIGEgcHJvbWlzZSwgZnVsZmlsbGVkIG9yIHJlamVjdGVkLgoKICAgICAgQSBwcm9taXNlIGNhbiBiZSBpbiBvbmUgb2YgdGhyZWUgc3RhdGVzOiBwZW5kaW5nLCBmdWxmaWxsZWQsIG9yIHJlamVjdGVkLgoKICAgICAgUHJvbWlzZXMgdGhhdCBhcmUgZnVsZmlsbGVkIGhhdmUgYSBmdWxmaWxsbWVudCB2YWx1ZSBhbmQgYXJlIGluIHRoZSBmdWxmaWxsZWQKICAgICAgc3RhdGUuICBQcm9taXNlcyB0aGF0IGFyZSByZWplY3RlZCBoYXZlIGEgcmVqZWN0aW9uIHJlYXNvbiBhbmQgYXJlIGluIHRoZQogICAgICByZWplY3RlZCBzdGF0ZS4gIEEgZnVsZmlsbG1lbnQgdmFsdWUgaXMgbmV2ZXIgYSB0aGVuYWJsZS4gIFNpbWlsYXJseSwgYQogICAgICByZWplY3Rpb24gcmVhc29uIGlzIG5ldmVyIGEgdGhlbmFibGUuCgogICAgICBQcm9taXNlcyBjYW4gYWxzbyBiZSBzYWlkIHRvICpyZXNvbHZlKiBhIHZhbHVlLiAgSWYgdGhpcyB2YWx1ZSBpcyBhbHNvIGEKICAgICAgcHJvbWlzZSwgdGhlbiB0aGUgb3JpZ2luYWwgcHJvbWlzZSdzIHNldHRsZWQgc3RhdGUgd2lsbCBtYXRjaCB0aGUgdmFsdWUncwogICAgICBzZXR0bGVkIHN0YXRlLiAgU28gYSBwcm9taXNlIHRoYXQgKnJlc29sdmVzKiBhIHByb21pc2UgdGhhdCByZWplY3RzIHdpbGwKICAgICAgaXRzZWxmIHJlamVjdCwgYW5kIGEgcHJvbWlzZSB0aGF0ICpyZXNvbHZlcyogYSBwcm9taXNlIHRoYXQgZnVsZmlsbHMgd2lsbAogICAgICBpdHNlbGYgZnVsZmlsbC4KCgogICAgICBCYXNpYyBVc2FnZToKICAgICAgLS0tLS0tLS0tLS0tCgogICAgICBgYGBqcwogICAgICB2YXIgcHJvbWlzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIC8vIG9uIHN1Y2Nlc3MKICAgICAgICByZXNvbHZlKHZhbHVlKTsKCiAgICAgICAgLy8gb24gZmFpbHVyZQogICAgICAgIHJlamVjdChyZWFzb24pOwogICAgICB9KTsKCiAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIC8vIG9uIGZ1bGZpbGxtZW50CiAgICAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgIC8vIG9uIHJlamVjdGlvbgogICAgICB9KTsKICAgICAgYGBgCgogICAgICBBZHZhbmNlZCBVc2FnZToKICAgICAgLS0tLS0tLS0tLS0tLS0tCgogICAgICBQcm9taXNlcyBzaGluZSB3aGVuIGFic3RyYWN0aW5nIGF3YXkgYXN5bmNocm9ub3VzIGludGVyYWN0aW9ucyBzdWNoIGFzCiAgICAgIGBYTUxIdHRwUmVxdWVzdGBzLgoKICAgICAgYGBganMKICAgICAgZnVuY3Rpb24gZ2V0SlNPTih1cmwpIHsKICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KXsKICAgICAgICAgIHZhciB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKCiAgICAgICAgICB4aHIub3BlbignR0VUJywgdXJsKTsKICAgICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBoYW5kbGVyOwogICAgICAgICAgeGhyLnJlc3BvbnNlVHlwZSA9ICdqc29uJzsKICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdBY2NlcHQnLCAnYXBwbGljYXRpb24vanNvbicpOwogICAgICAgICAgeGhyLnNlbmQoKTsKCiAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVyKCkgewogICAgICAgICAgICBpZiAodGhpcy5yZWFkeVN0YXRlID09PSB0aGlzLkRPTkUpIHsKICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0dXMgPT09IDIwMCkgewogICAgICAgICAgICAgICAgcmVzb2x2ZSh0aGlzLnJlc3BvbnNlKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcigiZ2V0SlNPTjogYCIgKyB1cmwgKyAiYCBmYWlsZWQgd2l0aCBzdGF0dXM6IFsiICsgdGhpcy5zdGF0dXMgKyAiXSIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgZ2V0SlNPTignL3Bvc3RzLmpzb24nKS50aGVuKGZ1bmN0aW9uKGpzb24pIHsKICAgICAgICAvLyBvbiBmdWxmaWxsbWVudAogICAgICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICAvLyBvbiByZWplY3Rpb24KICAgICAgfSk7CiAgICAgIGBgYAoKICAgICAgVW5saWtlIGNhbGxiYWNrcywgcHJvbWlzZXMgYXJlIGdyZWF0IGNvbXBvc2FibGUgcHJpbWl0aXZlcy4KCiAgICAgIGBgYGpzCiAgICAgIFByb21pc2UuYWxsKFsKICAgICAgICBnZXRKU09OKCcvcG9zdHMnKSwKICAgICAgICBnZXRKU09OKCcvY29tbWVudHMnKQogICAgICBdKS50aGVuKGZ1bmN0aW9uKHZhbHVlcyl7CiAgICAgICAgdmFsdWVzWzBdIC8vID0+IHBvc3RzSlNPTgogICAgICAgIHZhbHVlc1sxXSAvLyA9PiBjb21tZW50c0pTT04KCiAgICAgICAgcmV0dXJuIHZhbHVlczsKICAgICAgfSk7CiAgICAgIGBgYAoKICAgICAgQGNsYXNzIFJTVlAuUHJvbWlzZQogICAgICBAcGFyYW0ge2Z1bmN0aW9ufQogICAgICBAcGFyYW0ge1N0cmluZ30gbGFiZWwgb3B0aW9uYWwgc3RyaW5nIGZvciBsYWJlbGluZyB0aGUgcHJvbWlzZS4KICAgICAgVXNlZnVsIGZvciB0b29saW5nLgogICAgICBAY29uc3RydWN0b3IKICAgICovCiAgICBmdW5jdGlvbiBQcm9taXNlKHJlc29sdmVyLCBsYWJlbCkgewogICAgICBpZiAoIWlzRnVuY3Rpb24ocmVzb2x2ZXIpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignWW91IG11c3QgcGFzcyBhIHJlc29sdmVyIGZ1bmN0aW9uIGFzIHRoZSBmaXJzdCBhcmd1bWVudCB0byB0aGUgcHJvbWlzZSBjb25zdHJ1Y3RvcicpOwogICAgICB9CgogICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgUHJvbWlzZSkpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJGYWlsZWQgdG8gY29uc3RydWN0ICdQcm9taXNlJzogUGxlYXNlIHVzZSB0aGUgJ25ldycgb3BlcmF0b3IsIHRoaXMgb2JqZWN0IGNvbnN0cnVjdG9yIGNhbm5vdCBiZSBjYWxsZWQgYXMgYSBmdW5jdGlvbi4iKTsKICAgICAgfQoKICAgICAgdGhpcy5faWQgPSBjb3VudGVyKys7CiAgICAgIHRoaXMuX2xhYmVsID0gbGFiZWw7CiAgICAgIHRoaXMuX3N1YnNjcmliZXJzID0gW107CgogICAgICBpZiAoY29uZmlnLmluc3RydW1lbnQpIHsKICAgICAgICBpbnN0cnVtZW50KCdjcmVhdGVkJywgdGhpcyk7CiAgICAgIH0KCiAgICAgIGlmIChub29wICE9PSByZXNvbHZlcikgewogICAgICAgIGludm9rZVJlc29sdmVyKHJlc29sdmVyLCB0aGlzKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGludm9rZVJlc29sdmVyKHJlc29sdmVyLCBwcm9taXNlKSB7CiAgICAgIGZ1bmN0aW9uIHJlc29sdmVQcm9taXNlKHZhbHVlKSB7CiAgICAgICAgcmVzb2x2ZShwcm9taXNlLCB2YWx1ZSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHJlamVjdFByb21pc2UocmVhc29uKSB7CiAgICAgICAgcmVqZWN0KHByb21pc2UsIHJlYXNvbik7CiAgICAgIH0KCiAgICAgIHRyeSB7CiAgICAgICAgcmVzb2x2ZXIocmVzb2x2ZVByb21pc2UsIHJlamVjdFByb21pc2UpOwogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICByZWplY3RQcm9taXNlKGUpOwogICAgICB9CiAgICB9CgogICAgUHJvbWlzZS5jYXN0ID0gY2FzdDsKICAgIFByb21pc2UuYWxsID0gYWxsOwogICAgUHJvbWlzZS5yYWNlID0gcmFjZTsKICAgIFByb21pc2UucmVzb2x2ZSA9IFJlc29sdmU7CiAgICBQcm9taXNlLnJlamVjdCA9IFJlamVjdDsKCiAgICB2YXIgUEVORElORyAgID0gdm9pZCAwOwogICAgdmFyIFNFQUxFRCAgICA9IDA7CiAgICB2YXIgRlVMRklMTEVEID0gMTsKICAgIHZhciBSRUpFQ1RFRCAgPSAyOwoKICAgIGZ1bmN0aW9uIHN1YnNjcmliZShwYXJlbnQsIGNoaWxkLCBvbkZ1bGZpbGxtZW50LCBvblJlamVjdGlvbikgewogICAgICB2YXIgc3Vic2NyaWJlcnMgPSBwYXJlbnQuX3N1YnNjcmliZXJzOwogICAgICB2YXIgbGVuZ3RoID0gc3Vic2NyaWJlcnMubGVuZ3RoOwoKICAgICAgc3Vic2NyaWJlcnNbbGVuZ3RoXSA9IGNoaWxkOwogICAgICBzdWJzY3JpYmVyc1tsZW5ndGggKyBGVUxGSUxMRURdID0gb25GdWxmaWxsbWVudDsKICAgICAgc3Vic2NyaWJlcnNbbGVuZ3RoICsgUkVKRUNURURdICA9IG9uUmVqZWN0aW9uOwogICAgfQoKICAgIGZ1bmN0aW9uIHB1Ymxpc2gocHJvbWlzZSwgc2V0dGxlZCkgewogICAgICB2YXIgY2hpbGQsIGNhbGxiYWNrLCBzdWJzY3JpYmVycyA9IHByb21pc2UuX3N1YnNjcmliZXJzLCBkZXRhaWwgPSBwcm9taXNlLl9kZXRhaWw7CgogICAgICBpZiAoY29uZmlnLmluc3RydW1lbnQpIHsKICAgICAgICBpbnN0cnVtZW50KHNldHRsZWQgPT09IEZVTEZJTExFRCA/ICdmdWxmaWxsZWQnIDogJ3JlamVjdGVkJywgcHJvbWlzZSk7CiAgICAgIH0KCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3Vic2NyaWJlcnMubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICBjaGlsZCA9IHN1YnNjcmliZXJzW2ldOwogICAgICAgIGNhbGxiYWNrID0gc3Vic2NyaWJlcnNbaSArIHNldHRsZWRdOwoKICAgICAgICBpbnZva2VDYWxsYmFjayhzZXR0bGVkLCBjaGlsZCwgY2FsbGJhY2ssIGRldGFpbCk7CiAgICAgIH0KCiAgICAgIHByb21pc2UuX3N1YnNjcmliZXJzID0gbnVsbDsKICAgIH0KCiAgICBQcm9taXNlLnByb3RvdHlwZSA9IHsKICAgICAgY29uc3RydWN0b3I6IFByb21pc2UsCgogICAgICBfaWQ6IHVuZGVmaW5lZCwKICAgICAgX2d1aWRLZXk6IGd1aWRLZXksCiAgICAgIF9sYWJlbDogdW5kZWZpbmVkLAoKICAgICAgX3N0YXRlOiB1bmRlZmluZWQsCiAgICAgIF9kZXRhaWw6IHVuZGVmaW5lZCwKICAgICAgX3N1YnNjcmliZXJzOiB1bmRlZmluZWQsCgogICAgICBfb25lcnJvcjogZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgIGNvbmZpZy50cmlnZ2VyKCdlcnJvcicsIHJlYXNvbik7CiAgICAgIH0sCgogICAgLyoqCiAgICAgIFRoZSBwcmltYXJ5IHdheSBvZiBpbnRlcmFjdGluZyB3aXRoIGEgcHJvbWlzZSBpcyB0aHJvdWdoIGl0cyBgdGhlbmAgbWV0aG9kLAogICAgICB3aGljaCByZWdpc3RlcnMgY2FsbGJhY2tzIHRvIHJlY2VpdmUgZWl0aGVyIGEgcHJvbWlzZSdzIGV2ZW50dWFsIHZhbHVlIG9yIHRoZQogICAgICByZWFzb24gd2h5IHRoZSBwcm9taXNlIGNhbm5vdCBiZSBmdWxmaWxsZWQuCgogICAgICBgYGBqcwogICAgICBmaW5kVXNlcigpLnRoZW4oZnVuY3Rpb24odXNlcil7CiAgICAgICAgLy8gdXNlciBpcyBhdmFpbGFibGUKICAgICAgfSwgZnVuY3Rpb24ocmVhc29uKXsKICAgICAgICAvLyB1c2VyIGlzIHVuYXZhaWxhYmxlLCBhbmQgeW91IGFyZSBnaXZlbiB0aGUgcmVhc29uIHdoeQogICAgICB9KTsKICAgICAgYGBgCgogICAgICBDaGFpbmluZwogICAgICAtLS0tLS0tLQoKICAgICAgVGhlIHJldHVybiB2YWx1ZSBvZiBgdGhlbmAgaXMgaXRzZWxmIGEgcHJvbWlzZS4gIFRoaXMgc2Vjb25kLCAiZG93bnN0cmVhbSIKICAgICAgcHJvbWlzZSBpcyByZXNvbHZlZCB3aXRoIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGZpcnN0IHByb21pc2UncyBmdWxmaWxsbWVudAogICAgICBvciByZWplY3Rpb24gaGFuZGxlciwgb3IgcmVqZWN0ZWQgaWYgdGhlIGhhbmRsZXIgdGhyb3dzIGFuIGV4Y2VwdGlvbi4KCiAgICAgIGBgYGpzCiAgICAgIGZpbmRVc2VyKCkudGhlbihmdW5jdGlvbiAodXNlcikgewogICAgICAgIHJldHVybiB1c2VyLm5hbWU7CiAgICAgIH0sIGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICByZXR1cm4gImRlZmF1bHQgbmFtZSI7CiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKHVzZXJOYW1lKSB7CiAgICAgICAgLy8gSWYgYGZpbmRVc2VyYCBmdWxmaWxsZWQsIGB1c2VyTmFtZWAgd2lsbCBiZSB0aGUgdXNlcidzIG5hbWUsIG90aGVyd2lzZSBpdAogICAgICAgIC8vIHdpbGwgYmUgYCJkZWZhdWx0IG5hbWUiYAogICAgICB9KTsKCiAgICAgIGZpbmRVc2VyKCkudGhlbihmdW5jdGlvbiAodXNlcikgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiRm91bmQgdXNlciwgYnV0IHN0aWxsIHVuaGFwcHkiKTsKICAgICAgfSwgZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiYGZpbmRVc2VyYCByZWplY3RlZCBhbmQgd2UncmUgdW5oYXBweSIpOwogICAgICB9KS50aGVuKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIC8vIG5ldmVyIHJlYWNoZWQKICAgICAgfSwgZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgIC8vIGlmIGBmaW5kVXNlcmAgZnVsZmlsbGVkLCBgcmVhc29uYCB3aWxsIGJlICJGb3VuZCB1c2VyLCBidXQgc3RpbGwgdW5oYXBweSIuCiAgICAgICAgLy8gSWYgYGZpbmRVc2VyYCByZWplY3RlZCwgYHJlYXNvbmAgd2lsbCBiZSAiYGZpbmRVc2VyYCByZWplY3RlZCBhbmQgd2UncmUgdW5oYXBweSIuCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgSWYgdGhlIGRvd25zdHJlYW0gcHJvbWlzZSBkb2VzIG5vdCBzcGVjaWZ5IGEgcmVqZWN0aW9uIGhhbmRsZXIsIHJlamVjdGlvbiByZWFzb25zIHdpbGwgYmUgcHJvcGFnYXRlZCBmdXJ0aGVyIGRvd25zdHJlYW0uCgogICAgICBgYGBqcwogICAgICBmaW5kVXNlcigpLnRoZW4oZnVuY3Rpb24gKHVzZXIpIHsKICAgICAgICB0aHJvdyBuZXcgUGVkYWdvZ2ljYWxFeGNlcHRpb24oIlVwc3RyZWFtIGVycm9yIik7CiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgLy8gbmV2ZXIgcmVhY2hlZAogICAgICB9KS50aGVuKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIC8vIG5ldmVyIHJlYWNoZWQKICAgICAgfSwgZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgIC8vIFRoZSBgUGVkZ2Fnb2NpYWxFeGNlcHRpb25gIGlzIHByb3BhZ2F0ZWQgYWxsIHRoZSB3YXkgZG93biB0byBoZXJlCiAgICAgIH0pOwogICAgICBgYGAKCiAgICAgIEFzc2ltaWxhdGlvbgogICAgICAtLS0tLS0tLS0tLS0KCiAgICAgIFNvbWV0aW1lcyB0aGUgdmFsdWUgeW91IHdhbnQgdG8gcHJvcGFnYXRlIHRvIGEgZG93bnN0cmVhbSBwcm9taXNlIGNhbiBvbmx5IGJlCiAgICAgIHJldHJpZXZlZCBhc3luY2hyb25vdXNseS4gVGhpcyBjYW4gYmUgYWNoaWV2ZWQgYnkgcmV0dXJuaW5nIGEgcHJvbWlzZSBpbiB0aGUKICAgICAgZnVsZmlsbG1lbnQgb3IgcmVqZWN0aW9uIGhhbmRsZXIuIFRoZSBkb3duc3RyZWFtIHByb21pc2Ugd2lsbCB0aGVuIGJlIHBlbmRpbmcKICAgICAgdW50aWwgdGhlIHJldHVybmVkIHByb21pc2UgaXMgc2V0dGxlZC4gVGhpcyBpcyBjYWxsZWQgKmFzc2ltaWxhdGlvbiouCgogICAgICBgYGBqcwogICAgICBmaW5kVXNlcigpLnRoZW4oZnVuY3Rpb24gKHVzZXIpIHsKICAgICAgICByZXR1cm4gZmluZENvbW1lbnRzQnlBdXRob3IodXNlcik7CiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKGNvbW1lbnRzKSB7CiAgICAgICAgLy8gVGhlIHVzZXIncyBjb21tZW50cyBhcmUgbm93IGF2YWlsYWJsZQogICAgICB9KTsKICAgICAgYGBgCgogICAgICBJZiB0aGUgYXNzaW1saWF0ZWQgcHJvbWlzZSByZWplY3RzLCB0aGVuIHRoZSBkb3duc3RyZWFtIHByb21pc2Ugd2lsbCBhbHNvIHJlamVjdC4KCiAgICAgIGBgYGpzCiAgICAgIGZpbmRVc2VyKCkudGhlbihmdW5jdGlvbiAodXNlcikgewogICAgICAgIHJldHVybiBmaW5kQ29tbWVudHNCeUF1dGhvcih1c2VyKTsKICAgICAgfSkudGhlbihmdW5jdGlvbiAoY29tbWVudHMpIHsKICAgICAgICAvLyBJZiBgZmluZENvbW1lbnRzQnlBdXRob3JgIGZ1bGZpbGxzLCB3ZSdsbCBoYXZlIHRoZSB2YWx1ZSBoZXJlCiAgICAgIH0sIGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAvLyBJZiBgZmluZENvbW1lbnRzQnlBdXRob3JgIHJlamVjdHMsIHdlJ2xsIGhhdmUgdGhlIHJlYXNvbiBoZXJlCiAgICAgIH0pOwogICAgICBgYGAKCiAgICAgIFNpbXBsZSBFeGFtcGxlCiAgICAgIC0tLS0tLS0tLS0tLS0tCgogICAgICBTeW5jaHJvbm91cyBFeGFtcGxlCgogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHZhciByZXN1bHQ7CgogICAgICB0cnkgewogICAgICAgIHJlc3VsdCA9IGZpbmRSZXN1bHQoKTsKICAgICAgICAvLyBzdWNjZXNzCiAgICAgIH0gY2F0Y2gocmVhc29uKSB7CiAgICAgICAgLy8gZmFpbHVyZQogICAgICB9CiAgICAgIGBgYAoKICAgICAgRXJyYmFjayBFeGFtcGxlCgogICAgICBgYGBqcwogICAgICBmaW5kUmVzdWx0KGZ1bmN0aW9uKHJlc3VsdCwgZXJyKXsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAvLyBmYWlsdXJlCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIHN1Y2Nlc3MKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKCiAgICAgIFByb21pc2UgRXhhbXBsZTsKCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgZmluZFJlc3VsdCgpLnRoZW4oZnVuY3Rpb24ocmVzdWx0KXsKICAgICAgICAvLyBzdWNjZXNzCiAgICAgIH0sIGZ1bmN0aW9uKHJlYXNvbil7CiAgICAgICAgLy8gZmFpbHVyZQogICAgICB9KTsKICAgICAgYGBgCgogICAgICBBZHZhbmNlZCBFeGFtcGxlCiAgICAgIC0tLS0tLS0tLS0tLS0tCgogICAgICBTeW5jaHJvbm91cyBFeGFtcGxlCgogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHZhciBhdXRob3IsIGJvb2tzOwoKICAgICAgdHJ5IHsKICAgICAgICBhdXRob3IgPSBmaW5kQXV0aG9yKCk7CiAgICAgICAgYm9va3MgID0gZmluZEJvb2tzQnlBdXRob3IoYXV0aG9yKTsKICAgICAgICAvLyBzdWNjZXNzCiAgICAgIH0gY2F0Y2gocmVhc29uKSB7CiAgICAgICAgLy8gZmFpbHVyZQogICAgICB9CiAgICAgIGBgYAoKICAgICAgRXJyYmFjayBFeGFtcGxlCgogICAgICBgYGBqcwoKICAgICAgZnVuY3Rpb24gZm91bmRCb29rcyhib29rcykgewoKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZmFpbHVyZShyZWFzb24pIHsKCiAgICAgIH0KCiAgICAgIGZpbmRBdXRob3IoZnVuY3Rpb24oYXV0aG9yLCBlcnIpewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIGZhaWx1cmUoZXJyKTsKICAgICAgICAgIC8vIGZhaWx1cmUKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZmluZEJvb29rc0J5QXV0aG9yKGF1dGhvciwgZnVuY3Rpb24oYm9va3MsIGVycikgewogICAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICAgIGZhaWx1cmUoZXJyKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgZm91bmRCb29rcyhib29rcyk7CiAgICAgICAgICAgICAgICB9IGNhdGNoKHJlYXNvbikgewogICAgICAgICAgICAgICAgICBmYWlsdXJlKHJlYXNvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gY2F0Y2goZXJyb3IpIHsKICAgICAgICAgICAgZmFpbHVyZShlcnIpOwogICAgICAgICAgfQogICAgICAgICAgLy8gc3VjY2VzcwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAoKICAgICAgUHJvbWlzZSBFeGFtcGxlOwoKICAgICAgYGBgamF2YXNjcmlwdAogICAgICBmaW5kQXV0aG9yKCkuCiAgICAgICAgdGhlbihmaW5kQm9va3NCeUF1dGhvcikuCiAgICAgICAgdGhlbihmdW5jdGlvbihib29rcyl7CiAgICAgICAgICAvLyBmb3VuZCBib29rcwogICAgICB9KS5jYXRjaChmdW5jdGlvbihyZWFzb24pewogICAgICAgIC8vIHNvbWV0aGluZyB3ZW50IHdyb25nCiAgICAgIH0pOwogICAgICBgYGAKCiAgICAgIEBtZXRob2QgdGhlbgogICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBvbkZ1bGZpbGxlZAogICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBvblJlamVjdGVkCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBsYWJlbCBvcHRpb25hbCBzdHJpbmcgZm9yIGxhYmVsaW5nIHRoZSBwcm9taXNlLgogICAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICAgIEByZXR1cm4ge1Byb21pc2V9CiAgICAqLwogICAgICB0aGVuOiBmdW5jdGlvbihvbkZ1bGZpbGxtZW50LCBvblJlamVjdGlvbiwgbGFiZWwpIHsKICAgICAgICB2YXIgcHJvbWlzZSA9IHRoaXM7CiAgICAgICAgdGhpcy5fb25lcnJvciA9IG51bGw7CgogICAgICAgIHZhciB0aGVuUHJvbWlzZSA9IG5ldyB0aGlzLmNvbnN0cnVjdG9yKG5vb3AsIGxhYmVsKTsKCiAgICAgICAgaWYgKHRoaXMuX3N0YXRlKSB7CiAgICAgICAgICB2YXIgY2FsbGJhY2tzID0gYXJndW1lbnRzOwogICAgICAgICAgY29uZmlnLmFzeW5jKGZ1bmN0aW9uIGludm9rZVByb21pc2VDYWxsYmFjaygpIHsKICAgICAgICAgICAgaW52b2tlQ2FsbGJhY2socHJvbWlzZS5fc3RhdGUsIHRoZW5Qcm9taXNlLCBjYWxsYmFja3NbcHJvbWlzZS5fc3RhdGUgLSAxXSwgcHJvbWlzZS5fZGV0YWlsKTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdWJzY3JpYmUodGhpcywgdGhlblByb21pc2UsIG9uRnVsZmlsbG1lbnQsIG9uUmVqZWN0aW9uKTsKICAgICAgICB9CgogICAgICAgIGlmIChjb25maWcuaW5zdHJ1bWVudCkgewogICAgICAgICAgaW5zdHJ1bWVudCgnY2hhaW5lZCcsIHByb21pc2UsIHRoZW5Qcm9taXNlKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGVuUHJvbWlzZTsKICAgICAgfSwKCiAgICAvKioKICAgICAgYGNhdGNoYCBpcyBzaW1wbHkgc3VnYXIgZm9yIGB0aGVuKHVuZGVmaW5lZCwgb25SZWplY3Rpb24pYCB3aGljaCBtYWtlcyBpdCB0aGUgc2FtZQogICAgICBhcyB0aGUgY2F0Y2ggYmxvY2sgb2YgYSB0cnkvY2F0Y2ggc3RhdGVtZW50LgoKICAgICAgYGBganMKICAgICAgZnVuY3Rpb24gZmluZEF1dGhvcigpewogICAgICAgIHRocm93IG5ldyBFcnJvcigiY291bGRuJ3QgZmluZCB0aGF0IGF1dGhvciIpOwogICAgICB9CgogICAgICAvLyBzeW5jaHJvbm91cwogICAgICB0cnkgewogICAgICAgIGZpbmRBdXRob3IoKTsKICAgICAgfSBjYXRjaChyZWFzb24pIHsKICAgICAgICAvLyBzb21ldGhpbmcgd2VudCB3cm9uZwogICAgICB9CgogICAgICAvLyBhc3luYyB3aXRoIHByb21pc2VzCiAgICAgIGZpbmRBdXRob3IoKS5jYXRjaChmdW5jdGlvbihyZWFzb24pewogICAgICAgIC8vIHNvbWV0aGluZyB3ZW50IHdyb25nCiAgICAgIH0pOwogICAgICBgYGAKCiAgICAgIEBtZXRob2QgY2F0Y2gKICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gb25SZWplY3Rpb24KICAgICAgQHBhcmFtIHtTdHJpbmd9IGxhYmVsIG9wdGlvbmFsIHN0cmluZyBmb3IgbGFiZWxpbmcgdGhlIHByb21pc2UuCiAgICAgIFVzZWZ1bCBmb3IgdG9vbGluZy4KICAgICAgQHJldHVybiB7UHJvbWlzZX0KICAgICovCiAgICAgICdjYXRjaCc6IGZ1bmN0aW9uKG9uUmVqZWN0aW9uLCBsYWJlbCkgewogICAgICAgIHJldHVybiB0aGlzLnRoZW4obnVsbCwgb25SZWplY3Rpb24sIGxhYmVsKTsKICAgICAgfSwKCiAgICAvKioKICAgICAgYGZpbmFsbHlgIHdpbGwgYmUgaW52b2tlZCByZWdhcmRsZXNzIG9mIHRoZSBwcm9taXNlJ3MgZmF0ZSBqdXN0IGFzIG5hdGl2ZQogICAgICB0cnkvY2F0Y2gvZmluYWxseSBiZWhhdmVzCgogICAgICBTeW5jaHJvbm91cyBleGFtcGxlOgoKICAgICAgYGBganMKICAgICAgZmluZEF1dGhvcigpIHsKICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IDAuNSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgQXV0aG9yKCk7CiAgICAgIH0KCiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIGZpbmRBdXRob3IoKTsgLy8gc3VjY2VlZCBvciBmYWlsCiAgICAgIH0gY2F0Y2goZXJyb3IpIHsKICAgICAgICByZXR1cm4gZmluZE90aGVyQXV0aGVyKCk7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgLy8gYWx3YXlzIHJ1bnMKICAgICAgICAvLyBkb2Vzbid0IGFmZmVjdCB0aGUgcmV0dXJuIHZhbHVlCiAgICAgIH0KICAgICAgYGBgCgogICAgICBBc3luY2hyb25vdXMgZXhhbXBsZToKCiAgICAgIGBgYGpzCiAgICAgIGZpbmRBdXRob3IoKS5jYXRjaChmdW5jdGlvbihyZWFzb24pewogICAgICAgIHJldHVybiBmaW5kT3RoZXJBdXRoZXIoKTsKICAgICAgfSkuZmluYWxseShmdW5jdGlvbigpewogICAgICAgIC8vIGF1dGhvciB3YXMgZWl0aGVyIGZvdW5kLCBvciBub3QKICAgICAgfSk7CiAgICAgIGBgYAoKICAgICAgQG1ldGhvZCBmaW5hbGx5CiAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBsYWJlbCBvcHRpb25hbCBzdHJpbmcgZm9yIGxhYmVsaW5nIHRoZSBwcm9taXNlLgogICAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICAgIEByZXR1cm4ge1Byb21pc2V9CiAgICAqLwogICAgICAnZmluYWxseSc6IGZ1bmN0aW9uKGNhbGxiYWNrLCBsYWJlbCkgewogICAgICAgIHZhciBjb25zdHJ1Y3RvciA9IHRoaXMuY29uc3RydWN0b3I7CgogICAgICAgIHJldHVybiB0aGlzLnRoZW4oZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIHJldHVybiBjb25zdHJ1Y3Rvci5jYXN0KGNhbGxiYWNrKCkpLnRoZW4oZnVuY3Rpb24oKXsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfSk7CiAgICAgICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAgICByZXR1cm4gY29uc3RydWN0b3IuY2FzdChjYWxsYmFjaygpKS50aGVuKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHRocm93IHJlYXNvbjsKICAgICAgICAgIH0pOwogICAgICAgIH0sIGxhYmVsKTsKICAgICAgfQogICAgfTsKCiAgICBmdW5jdGlvbiBpbnZva2VDYWxsYmFjayhzZXR0bGVkLCBwcm9taXNlLCBjYWxsYmFjaywgZGV0YWlsKSB7CiAgICAgIHZhciBoYXNDYWxsYmFjayA9IGlzRnVuY3Rpb24oY2FsbGJhY2spLAogICAgICAgICAgdmFsdWUsIGVycm9yLCBzdWNjZWVkZWQsIGZhaWxlZDsKCiAgICAgIGlmIChoYXNDYWxsYmFjaykgewogICAgICAgIHRyeSB7CiAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrKGRldGFpbCk7CiAgICAgICAgICBzdWNjZWVkZWQgPSB0cnVlOwogICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgZmFpbGVkID0gdHJ1ZTsKICAgICAgICAgIGVycm9yID0gZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFsdWUgPSBkZXRhaWw7CiAgICAgICAgc3VjY2VlZGVkID0gdHJ1ZTsKICAgICAgfQoKICAgICAgaWYgKGhhbmRsZVRoZW5hYmxlKHByb21pc2UsIHZhbHVlKSkgewogICAgICAgIHJldHVybjsKICAgICAgfSBlbHNlIGlmIChoYXNDYWxsYmFjayAmJiBzdWNjZWVkZWQpIHsKICAgICAgICByZXNvbHZlKHByb21pc2UsIHZhbHVlKTsKICAgICAgfSBlbHNlIGlmIChmYWlsZWQpIHsKICAgICAgICByZWplY3QocHJvbWlzZSwgZXJyb3IpOwogICAgICB9IGVsc2UgaWYgKHNldHRsZWQgPT09IEZVTEZJTExFRCkgewogICAgICAgIHJlc29sdmUocHJvbWlzZSwgdmFsdWUpOwogICAgICB9IGVsc2UgaWYgKHNldHRsZWQgPT09IFJFSkVDVEVEKSB7CiAgICAgICAgcmVqZWN0KHByb21pc2UsIHZhbHVlKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGhhbmRsZVRoZW5hYmxlKHByb21pc2UsIHZhbHVlKSB7CiAgICAgIHZhciB0aGVuID0gbnVsbCwKICAgICAgcmVzb2x2ZWQ7CgogICAgICB0cnkgewogICAgICAgIGlmIChwcm9taXNlID09PSB2YWx1ZSkgewogICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQSBwcm9taXNlcyBjYWxsYmFjayBjYW5ub3QgcmV0dXJuIHRoYXQgc2FtZSBwcm9taXNlLiIpOwogICAgICAgIH0KCiAgICAgICAgaWYgKG9iamVjdE9yRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgICB0aGVuID0gdmFsdWUudGhlbjsKCiAgICAgICAgICBpZiAoaXNGdW5jdGlvbih0aGVuKSkgewogICAgICAgICAgICB0aGVuLmNhbGwodmFsdWUsIGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICAgIGlmIChyZXNvbHZlZCkgeyByZXR1cm4gdHJ1ZTsgfQogICAgICAgICAgICAgIHJlc29sdmVkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgaWYgKHZhbHVlICE9PSB2YWwpIHsKICAgICAgICAgICAgICAgIHJlc29sdmUocHJvbWlzZSwgdmFsKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZnVsZmlsbChwcm9taXNlLCB2YWwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgICAgaWYgKHJlc29sdmVkKSB7IHJldHVybiB0cnVlOyB9CiAgICAgICAgICAgICAgcmVzb2x2ZWQgPSB0cnVlOwoKICAgICAgICAgICAgICByZWplY3QocHJvbWlzZSwgdmFsKTsKICAgICAgICAgICAgfSwgJ2Rlcml2ZWQgZnJvbTogJyArIChwcm9taXNlLl9sYWJlbCB8fCAnIHVua25vd24gcHJvbWlzZScpKTsKCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBpZiAocmVzb2x2ZWQpIHsgcmV0dXJuIHRydWU7IH0KICAgICAgICByZWplY3QocHJvbWlzZSwgZXJyb3IpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgZnVuY3Rpb24gcmVzb2x2ZShwcm9taXNlLCB2YWx1ZSkgewogICAgICBpZiAocHJvbWlzZSA9PT0gdmFsdWUpIHsKICAgICAgICBmdWxmaWxsKHByb21pc2UsIHZhbHVlKTsKICAgICAgfSBlbHNlIGlmICghaGFuZGxlVGhlbmFibGUocHJvbWlzZSwgdmFsdWUpKSB7CiAgICAgICAgZnVsZmlsbChwcm9taXNlLCB2YWx1ZSk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBmdWxmaWxsKHByb21pc2UsIHZhbHVlKSB7CiAgICAgIGlmIChwcm9taXNlLl9zdGF0ZSAhPT0gUEVORElORykgeyByZXR1cm47IH0KICAgICAgcHJvbWlzZS5fc3RhdGUgPSBTRUFMRUQ7CiAgICAgIHByb21pc2UuX2RldGFpbCA9IHZhbHVlOwoKICAgICAgY29uZmlnLmFzeW5jKHB1Ymxpc2hGdWxmaWxsbWVudCwgcHJvbWlzZSk7CiAgICB9CgogICAgZnVuY3Rpb24gcmVqZWN0KHByb21pc2UsIHJlYXNvbikgewogICAgICBpZiAocHJvbWlzZS5fc3RhdGUgIT09IFBFTkRJTkcpIHsgcmV0dXJuOyB9CiAgICAgIHByb21pc2UuX3N0YXRlID0gU0VBTEVEOwogICAgICBwcm9taXNlLl9kZXRhaWwgPSByZWFzb247CgogICAgICBjb25maWcuYXN5bmMocHVibGlzaFJlamVjdGlvbiwgcHJvbWlzZSk7CiAgICB9CgogICAgZnVuY3Rpb24gcHVibGlzaEZ1bGZpbGxtZW50KHByb21pc2UpIHsKICAgICAgcHVibGlzaChwcm9taXNlLCBwcm9taXNlLl9zdGF0ZSA9IEZVTEZJTExFRCk7CiAgICB9CgogICAgZnVuY3Rpb24gcHVibGlzaFJlamVjdGlvbihwcm9taXNlKSB7CiAgICAgIGlmIChwcm9taXNlLl9vbmVycm9yKSB7CiAgICAgICAgcHJvbWlzZS5fb25lcnJvcihwcm9taXNlLl9kZXRhaWwpOwogICAgICB9CgogICAgICBwdWJsaXNoKHByb21pc2UsIHByb21pc2UuX3N0YXRlID0gUkVKRUNURUQpOwogICAgfQogIH0pOwpkZWZpbmUoInJzdnAvcHJvbWlzZS9hbGwiLCAKICBbIi4uL3V0aWxzIiwiZXhwb3J0cyJdLAogIGZ1bmN0aW9uKF9fZGVwZW5kZW5jeTFfXywgX19leHBvcnRzX18pIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBpc0FycmF5ID0gX19kZXBlbmRlbmN5MV9fLmlzQXJyYXk7CiAgICB2YXIgaXNOb25UaGVuYWJsZSA9IF9fZGVwZW5kZW5jeTFfXy5pc05vblRoZW5hYmxlOwoKICAgIC8qKgogICAgICBgUlNWUC5Qcm9taXNlLmFsbGAgYWNjZXB0cyBhbiBhcnJheSBvZiBwcm9taXNlcywgYW5kIHJldHVybnMgYSBuZXcgcHJvbWlzZSB3aGljaAogICAgICBpcyBmdWxmaWxsZWQgd2l0aCBhbiBhcnJheSBvZiBmdWxmaWxsbWVudCB2YWx1ZXMgZm9yIHRoZSBwYXNzZWQgcHJvbWlzZXMsIG9yCiAgICAgIHJlamVjdGVkIHdpdGggdGhlIHJlYXNvbiBvZiB0aGUgZmlyc3QgcGFzc2VkIHByb21pc2UgdG8gYmUgcmVqZWN0ZWQuIEl0IGNhc3RzIGFsbAogICAgICBlbGVtZW50cyBvZiB0aGUgcGFzc2VkIGl0ZXJhYmxlIHRvIHByb21pc2VzIGFzIGl0IHJ1bnMgdGhpcyBhbGdvcml0aG0uCgogICAgICBFeGFtcGxlOgoKICAgICAgYGBgamF2YXNjcmlwdAogICAgICB2YXIgcHJvbWlzZTEgPSBSU1ZQLnJlc29sdmUoMSk7CiAgICAgIHZhciBwcm9taXNlMiA9IFJTVlAucmVzb2x2ZSgyKTsKICAgICAgdmFyIHByb21pc2UzID0gUlNWUC5yZXNvbHZlKDMpOwogICAgICB2YXIgcHJvbWlzZXMgPSBbIHByb21pc2UxLCBwcm9taXNlMiwgcHJvbWlzZTMgXTsKCiAgICAgIFJTVlAuUHJvbWlzZS5hbGwocHJvbWlzZXMpLnRoZW4oZnVuY3Rpb24oYXJyYXkpewogICAgICAgIC8vIFRoZSBhcnJheSBoZXJlIHdvdWxkIGJlIFsgMSwgMiwgMyBdOwogICAgICB9KTsKICAgICAgYGBgCgogICAgICBJZiBhbnkgb2YgdGhlIGBwcm9taXNlc2AgZ2l2ZW4gdG8gYFJTVlAuYWxsYCBhcmUgcmVqZWN0ZWQsIHRoZSBmaXJzdCBwcm9taXNlCiAgICAgIHRoYXQgaXMgcmVqZWN0ZWQgd2lsbCBiZSBnaXZlbiBhcyBhbiBhcmd1bWVudCB0byB0aGUgcmV0dXJuZWQgcHJvbWlzZXMncwogICAgICByZWplY3Rpb24gaGFuZGxlci4gRm9yIGV4YW1wbGU6CgogICAgICBFeGFtcGxlOgoKICAgICAgYGBgamF2YXNjcmlwdAogICAgICB2YXIgcHJvbWlzZTEgPSBSU1ZQLnJlc29sdmUoMSk7CiAgICAgIHZhciBwcm9taXNlMiA9IFJTVlAucmVqZWN0KG5ldyBFcnJvcigiMiIpKTsKICAgICAgdmFyIHByb21pc2UzID0gUlNWUC5yZWplY3QobmV3IEVycm9yKCIzIikpOwogICAgICB2YXIgcHJvbWlzZXMgPSBbIHByb21pc2UxLCBwcm9taXNlMiwgcHJvbWlzZTMgXTsKCiAgICAgIFJTVlAuUHJvbWlzZS5hbGwocHJvbWlzZXMpLnRoZW4oZnVuY3Rpb24oYXJyYXkpewogICAgICAgIC8vIENvZGUgaGVyZSBuZXZlciBydW5zIGJlY2F1c2UgdGhlcmUgYXJlIHJlamVjdGVkIHByb21pc2VzIQogICAgICB9LCBmdW5jdGlvbihlcnJvcikgewogICAgICAgIC8vIGVycm9yLm1lc3NhZ2UgPT09ICIyIgogICAgICB9KTsKICAgICAgYGBgCgogICAgICBAbWV0aG9kIGFsbAogICAgICBAZm9yIFJTVlAuUHJvbWlzZQogICAgICBAcGFyYW0ge0FycmF5fSBlbnRyaWVzIGFycmF5IG9mIHByb21pc2VzCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBsYWJlbCBvcHRpb25hbCBzdHJpbmcgZm9yIGxhYmVsaW5nIHRoZSBwcm9taXNlLgogICAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UgdGhhdCBpcyBmdWxmaWxsZWQgd2hlbiBhbGwgYHByb21pc2VzYCBoYXZlIGJlZW4KICAgICAgZnVsZmlsbGVkLCBvciByZWplY3RlZCBpZiBhbnkgb2YgdGhlbSBiZWNvbWUgcmVqZWN0ZWQuCiAgICAgIEBzdGF0aWMKICAgICovCiAgICBfX2V4cG9ydHNfX1siZGVmYXVsdCJdID0gZnVuY3Rpb24gYWxsKGVudHJpZXMsIGxhYmVsKSB7CgogICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqLwogICAgICB2YXIgQ29uc3RydWN0b3IgPSB0aGlzOwoKICAgICAgcmV0dXJuIG5ldyBDb25zdHJ1Y3RvcihmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICBpZiAoIWlzQXJyYXkoZW50cmllcykpIHsKICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1lvdSBtdXN0IHBhc3MgYW4gYXJyYXkgdG8gYWxsLicpOwogICAgICAgIH0KCiAgICAgICAgdmFyIHJlbWFpbmluZyA9IGVudHJpZXMubGVuZ3RoOwogICAgICAgIHZhciByZXN1bHRzID0gbmV3IEFycmF5KHJlbWFpbmluZyk7CiAgICAgICAgdmFyIGVudHJ5LCBwZW5kaW5nID0gdHJ1ZTsKCiAgICAgICAgaWYgKHJlbWFpbmluZyA9PT0gMCkgewogICAgICAgICAgcmVzb2x2ZShyZXN1bHRzKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxtZW50QXQoaW5kZXgpIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICByZXN1bHRzW2luZGV4XSA9IHZhbHVlOwogICAgICAgICAgICBpZiAoLS1yZW1haW5pbmcgPT09IDApIHsKICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdHMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gb25SZWplY3Rpb24ocmVhc29uKSB7CiAgICAgICAgICByZW1haW5pbmcgPSAwOwogICAgICAgICAgcmVqZWN0KHJlYXNvbik7CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBpbmRleCA9IDA7IGluZGV4IDwgZW50cmllcy5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgIGVudHJ5ID0gZW50cmllc1tpbmRleF07CiAgICAgICAgICBpZiAoaXNOb25UaGVuYWJsZShlbnRyeSkpIHsKICAgICAgICAgICAgcmVzdWx0c1tpbmRleF0gPSBlbnRyeTsKICAgICAgICAgICAgaWYgKC0tcmVtYWluaW5nID09PSAwKSB7CiAgICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHRzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgQ29uc3RydWN0b3IuY2FzdChlbnRyeSkudGhlbihmdWxmaWxsbWVudEF0KGluZGV4KSwgb25SZWplY3Rpb24pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwgbGFiZWwpOwogICAgfTsKICB9KTsKZGVmaW5lKCJyc3ZwL3Byb21pc2UvY2FzdCIsIAogIFsiZXhwb3J0cyJdLAogIGZ1bmN0aW9uKF9fZXhwb3J0c19fKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICAvKioKICAgICAgYFJTVlAuUHJvbWlzZS5jYXN0YCBjb2VyY2VzIGl0cyBhcmd1bWVudCB0byBhIHByb21pc2UsIG9yIHJldHVybnMgdGhlCiAgICAgIGFyZ3VtZW50IGlmIGl0IGlzIGFscmVhZHkgYSBwcm9taXNlIHdoaWNoIHNoYXJlcyBhIGNvbnN0cnVjdG9yIHdpdGggdGhlIGNhc3Rlci4KCiAgICAgIEV4YW1wbGU6CgogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHZhciBwcm9taXNlID0gUlNWUC5Qcm9taXNlLnJlc29sdmUoMSk7CiAgICAgIHZhciBjYXN0ZWQgPSBSU1ZQLlByb21pc2UuY2FzdChwcm9taXNlKTsKCiAgICAgIGNvbnNvbGUubG9nKHByb21pc2UgPT09IGNhc3RlZCk7IC8vIHRydWUKICAgICAgYGBgCgogICAgICBJbiB0aGUgY2FzZSBvZiBhIHByb21pc2Ugd2hvc2UgY29uc3RydWN0b3IgZG9lcyBub3QgbWF0Y2gsIGl0IGlzIGFzc2ltaWxhdGVkLgogICAgICBUaGUgcmVzdWx0aW5nIHByb21pc2Ugd2lsbCBmdWxmaWxsIG9yIHJlamVjdCBiYXNlZCBvbiB0aGUgb3V0Y29tZSBvZiB0aGUKICAgICAgcHJvbWlzZSBiZWluZyBjYXN0ZWQuCgogICAgICBFeGFtcGxlOgoKICAgICAgYGBgamF2YXNjcmlwdAogICAgICB2YXIgdGhlbm5hYmxlID0gJC5nZXRKU09OKCcvYXBpL2ZvbycpOwogICAgICB2YXIgY2FzdGVkID0gUlNWUC5Qcm9taXNlLmNhc3QodGhlbm5hYmxlKTsKCiAgICAgIGNvbnNvbGUubG9nKHRoZW5uYWJsZSA9PT0gY2FzdGVkKTsgLy8gZmFsc2UKICAgICAgY29uc29sZS5sb2coY2FzdGVkIGluc3RhbmNlb2YgUlNWUC5Qcm9taXNlKSAvLyB0cnVlCgogICAgICBjYXN0ZWQudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgLy8gZGF0YSBpcyB0aGUgdmFsdWUgZ2V0SlNPTiBmdWxmaWxscyB3aXRoCiAgICAgIH0pOwogICAgICBgYGAKCiAgICAgIEluIHRoZSBjYXNlIG9mIGEgbm9uLXByb21pc2UsIGEgcHJvbWlzZSB3aGljaCB3aWxsIGZ1bGZpbGwgd2l0aCB0aGF0IHZhbHVlIGlzCiAgICAgIHJldHVybmVkLgoKICAgICAgRXhhbXBsZToKCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgdmFyIHZhbHVlID0gMTsgLy8gY291bGQgYmUgYSBudW1iZXIsIGJvb2xlYW4sIHN0cmluZywgdW5kZWZpbmVkLi4uCiAgICAgIHZhciBjYXN0ZWQgPSBSU1ZQLlByb21pc2UuY2FzdCh2YWx1ZSk7CgogICAgICBjb25zb2xlLmxvZyh2YWx1ZSA9PT0gY2FzdGVkKTsgLy8gZmFsc2UKICAgICAgY29uc29sZS5sb2coY2FzdGVkIGluc3RhbmNlb2YgUlNWUC5Qcm9taXNlKSAvLyB0cnVlCgogICAgICBjYXN0ZWQudGhlbihmdW5jdGlvbih2YWwpIHsKICAgICAgICB2YWwgPT09IHZhbHVlIC8vID0+IHRydWUKICAgICAgfSk7CiAgICAgIGBgYAoKICAgICAgYFJTVlAuUHJvbWlzZS5jYXN0YCBpcyBzaW1pbGFyIHRvIGBSU1ZQLlByb21pc2UucmVzb2x2ZWAsIGJ1dCBgUlNWUC5Qcm9taXNlLmNhc3RgIGRpZmZlcnMgaW4gdGhlCiAgICAgIGZvbGxvd2luZyB3YXlzOgoKICAgICAgKiBgUlNWUC5Qcm9taXNlLmNhc3RgIHNlcnZlcyBhcyBhIG1lbW9yeS1lZmZpY2llbnQgd2F5IG9mIGdldHRpbmcgYSBwcm9taXNlLCB3aGVuIHlvdQogICAgICBoYXZlIHNvbWV0aGluZyB0aGF0IGNvdWxkIGVpdGhlciBiZSBhIHByb21pc2Ugb3IgYSB2YWx1ZS4gUlNWUC5yZXNvbHZlCiAgICAgIHdpbGwgaGF2ZSB0aGUgc2FtZSBlZmZlY3QgYnV0IHdpbGwgY3JlYXRlIGEgbmV3IHByb21pc2Ugd3JhcHBlciBpZiB0aGUKICAgICAgYXJndW1lbnQgaXMgYSBwcm9taXNlLgogICAgICAqIGBSU1ZQLlByb21pc2UuY2FzdGAgaXMgYSB3YXkgb2YgY2FzdGluZyBpbmNvbWluZyB0aGVuYWJsZXMgb3IgcHJvbWlzZSBzdWJjbGFzc2VzIHRvCiAgICAgIHByb21pc2VzIG9mIHRoZSBleGFjdCBjbGFzcyBzcGVjaWZpZWQsIHNvIHRoYXQgdGhlIHJlc3VsdGluZyBvYmplY3QncyBgdGhlbmAgaXMKICAgICAgZW5zdXJlZCB0byBoYXZlIHRoZSBiZWhhdmlvciBvZiB0aGUgY29uc3RydWN0b3IgeW91IGFyZSBjYWxsaW5nIGNhc3Qgb24gKGkuZS4sIFJTVlAuUHJvbWlzZSkuCgogICAgICBAbWV0aG9kIGNhc3QKICAgICAgQHBhcmFtIHtPYmplY3R9IG9iamVjdCB0byBiZSBjYXN0ZWQKICAgICAgQHBhcmFtIHtTdHJpbmd9IGxhYmVsIG9wdGlvbmFsIHN0cmluZyBmb3IgbGFiZWxpbmcgdGhlIHByb21pc2UuCiAgICAgIFVzZWZ1bCBmb3IgdG9vbGluZy4KICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICAgICBAc3RhdGljCiAgICAqLwoKICAgIF9fZXhwb3J0c19fWyJkZWZhdWx0Il0gPSBmdW5jdGlvbiBjYXN0KG9iamVjdCwgbGFiZWwpIHsKICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi8KICAgICAgdmFyIENvbnN0cnVjdG9yID0gdGhpczsKCiAgICAgIGlmIChvYmplY3QgJiYgdHlwZW9mIG9iamVjdCA9PT0gJ29iamVjdCcgJiYgb2JqZWN0LmNvbnN0cnVjdG9yID09PSBDb25zdHJ1Y3RvcikgewogICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgIH0KCiAgICAgIHJldHVybiBuZXcgQ29uc3RydWN0b3IoZnVuY3Rpb24ocmVzb2x2ZSkgewogICAgICAgIHJlc29sdmUob2JqZWN0KTsKICAgICAgfSwgbGFiZWwpOwogICAgfTsKICB9KTsKZGVmaW5lKCJyc3ZwL3Byb21pc2UvcmFjZSIsIAogIFsiLi4vdXRpbHMiLCJleHBvcnRzIl0sCiAgZnVuY3Rpb24oX19kZXBlbmRlbmN5MV9fLCBfX2V4cG9ydHNfXykgewogICAgInVzZSBzdHJpY3QiOwogICAgLyogZ2xvYmFsIHRvU3RyaW5nICovCgogICAgdmFyIGlzQXJyYXkgPSBfX2RlcGVuZGVuY3kxX18uaXNBcnJheTsKICAgIHZhciBpc0Z1bmN0aW9uID0gX19kZXBlbmRlbmN5MV9fLmlzRnVuY3Rpb247CiAgICB2YXIgaXNOb25UaGVuYWJsZSA9IF9fZGVwZW5kZW5jeTFfXy5pc05vblRoZW5hYmxlOwoKICAgIC8qKgogICAgICBgUlNWUC5Qcm9taXNlLnJhY2VgIHJldHVybnMgYSBuZXcgcHJvbWlzZSB3aGljaCBpcyBzZXR0bGVkIGluIHRoZSBzYW1lIHdheSBhcyB0aGUKICAgICAgZmlyc3QgcGFzc2VkIHByb21pc2UgdG8gc2V0dGxlLgoKICAgICAgRXhhbXBsZToKCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgdmFyIHByb21pc2UxID0gbmV3IFJTVlAuUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpewogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgIHJlc29sdmUoInByb21pc2UgMSIpOwogICAgICAgIH0sIDIwMCk7CiAgICAgIH0pOwoKICAgICAgdmFyIHByb21pc2UyID0gbmV3IFJTVlAuUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpewogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgIHJlc29sdmUoInByb21pc2UgMiIpOwogICAgICAgIH0sIDEwMCk7CiAgICAgIH0pOwoKICAgICAgUlNWUC5Qcm9taXNlLnJhY2UoW3Byb21pc2UxLCBwcm9taXNlMl0pLnRoZW4oZnVuY3Rpb24ocmVzdWx0KXsKICAgICAgICAvLyByZXN1bHQgPT09ICJwcm9taXNlIDIiIGJlY2F1c2UgaXQgd2FzIHJlc29sdmVkIGJlZm9yZSBwcm9taXNlMQogICAgICAgIC8vIHdhcyByZXNvbHZlZC4KICAgICAgfSk7CiAgICAgIGBgYAoKICAgICAgYFJTVlAuUHJvbWlzZS5yYWNlYCBpcyBkZXRlcm1pbmlzdGljIGluIHRoYXQgb25seSB0aGUgc3RhdGUgb2YgdGhlIGZpcnN0CiAgICAgIHNldHRsZWQgcHJvbWlzZSBtYXR0ZXJzLiBGb3IgZXhhbXBsZSwgZXZlbiBpZiBvdGhlciBwcm9taXNlcyBnaXZlbiB0byB0aGUKICAgICAgYHByb21pc2VzYCBhcnJheSBhcmd1bWVudCBhcmUgcmVzb2x2ZWQsIGJ1dCB0aGUgZmlyc3Qgc2V0dGxlZCBwcm9taXNlIGhhcwogICAgICBiZWNvbWUgcmVqZWN0ZWQgYmVmb3JlIHRoZSBvdGhlciBwcm9taXNlcyBiZWNhbWUgZnVsZmlsbGVkLCB0aGUgcmV0dXJuZWQKICAgICAgcHJvbWlzZSB3aWxsIGJlY29tZSByZWplY3RlZDoKCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgdmFyIHByb21pc2UxID0gbmV3IFJTVlAuUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpewogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgIHJlc29sdmUoInByb21pc2UgMSIpOwogICAgICAgIH0sIDIwMCk7CiAgICAgIH0pOwoKICAgICAgdmFyIHByb21pc2UyID0gbmV3IFJTVlAuUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpewogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoInByb21pc2UgMiIpKTsKICAgICAgICB9LCAxMDApOwogICAgICB9KTsKCiAgICAgIFJTVlAuUHJvbWlzZS5yYWNlKFtwcm9taXNlMSwgcHJvbWlzZTJdKS50aGVuKGZ1bmN0aW9uKHJlc3VsdCl7CiAgICAgICAgLy8gQ29kZSBoZXJlIG5ldmVyIHJ1bnMKICAgICAgfSwgZnVuY3Rpb24ocmVhc29uKXsKICAgICAgICAvLyByZWFzb24ubWVzc2FnZSA9PT0gInByb21pc2UyIiBiZWNhdXNlIHByb21pc2UgMiBiZWNhbWUgcmVqZWN0ZWQgYmVmb3JlCiAgICAgICAgLy8gcHJvbWlzZSAxIGJlY2FtZSBmdWxmaWxsZWQKICAgICAgfSk7CiAgICAgIGBgYAoKICAgICAgQW4gZXhhbXBsZSByZWFsLXdvcmxkIHVzZSBjYXNlIGlzIGltcGxlbWVudGluZyB0aW1lb3V0czoKCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgUlNWUC5Qcm9taXNlLnJhY2UoW2FqYXgoJ2Zvby5qc29uJyksIHRpbWVvdXQoNTAwMCldKQogICAgICBgYGAKCiAgICAgIEBtZXRob2QgcmFjZQogICAgICBAcGFyYW0ge0FycmF5fSBwcm9taXNlcyBhcnJheSBvZiBwcm9taXNlcyB0byBvYnNlcnZlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBsYWJlbCBvcHRpb25hbCBzdHJpbmcgZm9yIGRlc2NyaWJpbmcgdGhlIHByb21pc2UgcmV0dXJuZWQuCiAgICAgIFVzZWZ1bCBmb3IgdG9vbGluZy4KICAgICAgQHJldHVybiB7UHJvbWlzZX0gYSBwcm9taXNlIHdoaWNoIHNldHRsZXMgaW4gdGhlIHNhbWUgd2F5IGFzIHRoZSBmaXJzdCBwYXNzZWQKICAgICAgcHJvbWlzZSB0byBzZXR0bGUuCiAgICAgIEBzdGF0aWMKICAgICovCiAgICBfX2V4cG9ydHNfX1siZGVmYXVsdCJdID0gZnVuY3Rpb24gcmFjZShlbnRyaWVzLCBsYWJlbCkgewogICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqLwogICAgICB2YXIgQ29uc3RydWN0b3IgPSB0aGlzLCBlbnRyeTsKCiAgICAgIHJldHVybiBuZXcgQ29uc3RydWN0b3IoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgaWYgKCFpc0FycmF5KGVudHJpZXMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdZb3UgbXVzdCBwYXNzIGFuIGFycmF5IHRvIHJhY2UuJyk7CiAgICAgICAgfQoKICAgICAgICB2YXIgcGVuZGluZyA9IHRydWU7CgogICAgICAgIGZ1bmN0aW9uIG9uRnVsZmlsbG1lbnQodmFsdWUpIHsgaWYgKHBlbmRpbmcpIHsgcGVuZGluZyA9IGZhbHNlOyByZXNvbHZlKHZhbHVlKTsgfSB9CiAgICAgICAgZnVuY3Rpb24gb25SZWplY3Rpb24ocmVhc29uKSAgeyBpZiAocGVuZGluZykgeyBwZW5kaW5nID0gZmFsc2U7IHJlamVjdChyZWFzb24pOyB9IH0KCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbnRyaWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBlbnRyeSA9IGVudHJpZXNbaV07CiAgICAgICAgICBpZiAoaXNOb25UaGVuYWJsZShlbnRyeSkpIHsKICAgICAgICAgICAgcGVuZGluZyA9IGZhbHNlOwogICAgICAgICAgICByZXNvbHZlKGVudHJ5KTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgQ29uc3RydWN0b3IuY2FzdChlbnRyeSkudGhlbihvbkZ1bGZpbGxtZW50LCBvblJlamVjdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCBsYWJlbCk7CiAgICB9OwogIH0pOwpkZWZpbmUoInJzdnAvcHJvbWlzZS9yZWplY3QiLCAKICBbImV4cG9ydHMiXSwKICBmdW5jdGlvbihfX2V4cG9ydHNfXykgewogICAgInVzZSBzdHJpY3QiOwogICAgLyoqCiAgICAgIGBSU1ZQLlByb21pc2UucmVqZWN0YCByZXR1cm5zIGEgcHJvbWlzZSByZWplY3RlZCB3aXRoIHRoZSBwYXNzZWQgYHJlYXNvbmAuCiAgICAgIEl0IGlzIHNob3J0aGFuZCBmb3IgdGhlIGZvbGxvd2luZzoKCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgdmFyIHByb21pc2UgPSBuZXcgUlNWUC5Qcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCl7CiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcignV0hPT1BTJykpOwogICAgICB9KTsKCiAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgLy8gQ29kZSBoZXJlIGRvZXNuJ3QgcnVuIGJlY2F1c2UgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQhCiAgICAgIH0sIGZ1bmN0aW9uKHJlYXNvbil7CiAgICAgICAgLy8gcmVhc29uLm1lc3NhZ2UgPT09ICdXSE9PUFMnCiAgICAgIH0pOwogICAgICBgYGAKCiAgICAgIEluc3RlYWQgb2Ygd3JpdGluZyB0aGUgYWJvdmUsIHlvdXIgY29kZSBub3cgc2ltcGx5IGJlY29tZXMgdGhlIGZvbGxvd2luZzoKCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgdmFyIHByb21pc2UgPSBSU1ZQLlByb21pc2UucmVqZWN0KG5ldyBFcnJvcignV0hPT1BTJykpOwoKICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICAvLyBDb2RlIGhlcmUgZG9lc24ndCBydW4gYmVjYXVzZSB0aGUgcHJvbWlzZSBpcyByZWplY3RlZCEKICAgICAgfSwgZnVuY3Rpb24ocmVhc29uKXsKICAgICAgICAvLyByZWFzb24ubWVzc2FnZSA9PT0gJ1dIT09QUycKICAgICAgfSk7CiAgICAgIGBgYAoKICAgICAgQG1ldGhvZCByZWplY3QKICAgICAgQHBhcmFtIHtBbnl9IHJlYXNvbiB2YWx1ZSB0aGF0IHRoZSByZXR1cm5lZCBwcm9taXNlIHdpbGwgYmUgcmVqZWN0ZWQgd2l0aC4KICAgICAgQHBhcmFtIHtTdHJpbmd9IGxhYmVsIG9wdGlvbmFsIHN0cmluZyBmb3IgaWRlbnRpZnlpbmcgdGhlIHJldHVybmVkIHByb21pc2UuCiAgICAgIFVzZWZ1bCBmb3IgdG9vbGluZy4KICAgICAgQHJldHVybiB7UHJvbWlzZX0gYSBwcm9taXNlIHJlamVjdGVkIHdpdGggdGhlIGdpdmVuIGByZWFzb25gLgogICAgICBAc3RhdGljCiAgICAqLwogICAgX19leHBvcnRzX19bImRlZmF1bHQiXSA9IGZ1bmN0aW9uIHJlamVjdChyZWFzb24sIGxhYmVsKSB7CiAgICAgIC8qanNoaW50IHZhbGlkdGhpczp0cnVlICovCiAgICAgIHZhciBDb25zdHJ1Y3RvciA9IHRoaXM7CgogICAgICByZXR1cm4gbmV3IENvbnN0cnVjdG9yKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICByZWplY3QocmVhc29uKTsKICAgICAgfSwgbGFiZWwpOwogICAgfTsKICB9KTsKZGVmaW5lKCJyc3ZwL3Byb21pc2UvcmVzb2x2ZSIsIAogIFsiZXhwb3J0cyJdLAogIGZ1bmN0aW9uKF9fZXhwb3J0c19fKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICAvKioKICAgICAgYFJTVlAuUHJvbWlzZS5yZXNvbHZlYCByZXR1cm5zIGEgcHJvbWlzZSB0aGF0IHdpbGwgYmVjb21lIHJlc29sdmVkIHdpdGggdGhlCiAgICAgIHBhc3NlZCBgdmFsdWVgLiBJdCBpcyBzaG9ydGhhbmQgZm9yIHRoZSBmb2xsb3dpbmc6CgogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHZhciBwcm9taXNlID0gbmV3IFJTVlAuUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpewogICAgICAgIHJlc29sdmUoMSk7CiAgICAgIH0pOwoKICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICAvLyB2YWx1ZSA9PT0gMQogICAgICB9KTsKICAgICAgYGBgCgogICAgICBJbnN0ZWFkIG9mIHdyaXRpbmcgdGhlIGFib3ZlLCB5b3VyIGNvZGUgbm93IHNpbXBseSBiZWNvbWVzIHRoZSBmb2xsb3dpbmc6CgogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHZhciBwcm9taXNlID0gUlNWUC5Qcm9taXNlLnJlc29sdmUoMSk7CgogICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24odmFsdWUpewogICAgICAgIC8vIHZhbHVlID09PSAxCiAgICAgIH0pOwogICAgICBgYGAKCiAgICAgIEBtZXRob2QgcmVzb2x2ZQogICAgICBAcGFyYW0ge0FueX0gdmFsdWUgdmFsdWUgdGhhdCB0aGUgcmV0dXJuZWQgcHJvbWlzZSB3aWxsIGJlIHJlc29sdmVkIHdpdGgKICAgICAgQHBhcmFtIHtTdHJpbmd9IGxhYmVsIG9wdGlvbmFsIHN0cmluZyBmb3IgaWRlbnRpZnlpbmcgdGhlIHJldHVybmVkIHByb21pc2UuCiAgICAgIFVzZWZ1bCBmb3IgdG9vbGluZy4KICAgICAgQHJldHVybiB7UHJvbWlzZX0gYSBwcm9taXNlIHRoYXQgd2lsbCBiZWNvbWUgZnVsZmlsbGVkIHdpdGggdGhlIGdpdmVuCiAgICAgIGB2YWx1ZWAKICAgICAgQHN0YXRpYwogICAgKi8KICAgIF9fZXhwb3J0c19fWyJkZWZhdWx0Il0gPSBmdW5jdGlvbiByZXNvbHZlKHZhbHVlLCBsYWJlbCkgewogICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqLwogICAgICB2YXIgQ29uc3RydWN0b3IgPSB0aGlzOwoKICAgICAgcmV0dXJuIG5ldyBDb25zdHJ1Y3RvcihmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICByZXNvbHZlKHZhbHVlKTsKICAgICAgfSwgbGFiZWwpOwogICAgfTsKICB9KTsKZGVmaW5lKCJyc3ZwL3JhY2UiLCAKICBbIi4vcHJvbWlzZSIsImV4cG9ydHMiXSwKICBmdW5jdGlvbihfX2RlcGVuZGVuY3kxX18sIF9fZXhwb3J0c19fKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgUHJvbWlzZSA9IF9fZGVwZW5kZW5jeTFfX1siZGVmYXVsdCJdOwoKICAgIC8qKgogICAgICBUaGlzIGlzIGEgY29udmVuaWVudCBhbGlhcyBmb3IgYFJTVlAuUHJvbWlzZS5yYWNlYC4KCiAgICAgIEBtZXRob2QgcmFjZQogICAgICBAcGFyYW0ge0FycmF5fSBhcnJheSBBcnJheSBvZiBwcm9taXNlcy4KICAgICAgQHBhcmFtIHtTdHJpbmd9IGxhYmVsIEFuIG9wdGlvbmFsIGxhYmVsLiBUaGlzIGlzIHVzZWZ1bAogICAgICBmb3IgdG9vbGluZy4KICAgICAgQHN0YXRpYwogICAgKi8KICAgIF9fZXhwb3J0c19fWyJkZWZhdWx0Il0gPSBmdW5jdGlvbiByYWNlKGFycmF5LCBsYWJlbCkgewogICAgICByZXR1cm4gUHJvbWlzZS5yYWNlKGFycmF5LCBsYWJlbCk7CiAgICB9OwogIH0pOwpkZWZpbmUoInJzdnAvcmVqZWN0IiwgCiAgWyIuL3Byb21pc2UiLCJleHBvcnRzIl0sCiAgZnVuY3Rpb24oX19kZXBlbmRlbmN5MV9fLCBfX2V4cG9ydHNfXykgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIFByb21pc2UgPSBfX2RlcGVuZGVuY3kxX19bImRlZmF1bHQiXTsKCiAgICAvKioKICAgICAgVGhpcyBpcyBhIGNvbnZlbmllbnQgYWxpYXMgZm9yIGBSU1ZQLlByb21pc2UucmVqZWN0YC4KCiAgICAgIEBtZXRob2QgcmVqZWN0CiAgICAgIEBmb3IgUlNWUAogICAgICBAcGFyYW0ge0FueX0gcmVhc29uIHZhbHVlIHRoYXQgdGhlIHJldHVybmVkIHByb21pc2Ugd2lsbCBiZSByZWplY3RlZCB3aXRoLgogICAgICBAcGFyYW0ge1N0cmluZ30gbGFiZWwgb3B0aW9uYWwgc3RyaW5nIGZvciBpZGVudGlmeWluZyB0aGUgcmV0dXJuZWQgcHJvbWlzZS4KICAgICAgVXNlZnVsIGZvciB0b29saW5nLgogICAgICBAcmV0dXJuIHtQcm9taXNlfSBhIHByb21pc2UgcmVqZWN0ZWQgd2l0aCB0aGUgZ2l2ZW4gYHJlYXNvbmAuCiAgICAgIEBzdGF0aWMKICAgICovCiAgICBfX2V4cG9ydHNfX1siZGVmYXVsdCJdID0gZnVuY3Rpb24gcmVqZWN0KHJlYXNvbiwgbGFiZWwpIHsKICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KHJlYXNvbiwgbGFiZWwpOwogICAgfTsKICB9KTsKZGVmaW5lKCJyc3ZwL3Jlc29sdmUiLCAKICBbIi4vcHJvbWlzZSIsImV4cG9ydHMiXSwKICBmdW5jdGlvbihfX2RlcGVuZGVuY3kxX18sIF9fZXhwb3J0c19fKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgUHJvbWlzZSA9IF9fZGVwZW5kZW5jeTFfX1siZGVmYXVsdCJdOwoKICAgIC8qKgogICAgICBUaGlzIGlzIGEgY29udmVuaWVudCBhbGlhcyBmb3IgYFJTVlAuUHJvbWlzZS5yZXNvbHZlYC4KCiAgICAgIEBtZXRob2QgcmVzb2x2ZQogICAgICBAZm9yIFJTVlAKICAgICAgQHBhcmFtIHtBbnl9IHZhbHVlIHZhbHVlIHRoYXQgdGhlIHJldHVybmVkIHByb21pc2Ugd2lsbCBiZSByZXNvbHZlZCB3aXRoCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBsYWJlbCBvcHRpb25hbCBzdHJpbmcgZm9yIGlkZW50aWZ5aW5nIHRoZSByZXR1cm5lZCBwcm9taXNlLgogICAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICAgIEByZXR1cm4ge1Byb21pc2V9IGEgcHJvbWlzZSB0aGF0IHdpbGwgYmVjb21lIGZ1bGZpbGxlZCB3aXRoIHRoZSBnaXZlbgogICAgICBgdmFsdWVgCiAgICAgIEBzdGF0aWMKICAgICovCiAgICBfX2V4cG9ydHNfX1siZGVmYXVsdCJdID0gZnVuY3Rpb24gcmVzb2x2ZSh2YWx1ZSwgbGFiZWwpIHsKICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh2YWx1ZSwgbGFiZWwpOwogICAgfTsKICB9KTsKZGVmaW5lKCJyc3ZwL3JldGhyb3ciLCAKICBbImV4cG9ydHMiXSwKICBmdW5jdGlvbihfX2V4cG9ydHNfXykgewogICAgInVzZSBzdHJpY3QiOwogICAgLyoqCiAgICAgIGBSU1ZQLnJldGhyb3dgIHdpbGwgcmV0aHJvdyBhbiBlcnJvciBvbiB0aGUgbmV4dCB0dXJuIG9mIHRoZSBKYXZhU2NyaXB0IGV2ZW50CiAgICAgIGxvb3AgaW4gb3JkZXIgdG8gYWlkIGRlYnVnZ2luZy4KCiAgICAgIFByb21pc2VzIEErIHNwZWNpZmllcyB0aGF0IGFueSBleGNlcHRpb25zIHRoYXQgb2NjdXIgd2l0aCBhIHByb21pc2UgbXVzdCBiZQogICAgICBjYXVnaHQgYnkgdGhlIHByb21pc2VzIGltcGxlbWVudGF0aW9uIGFuZCBidWJibGVkIHRvIHRoZSBsYXN0IGhhbmRsZXIuIEZvcgogICAgICB0aGlzIHJlYXNvbiwgaXQgaXMgcmVjb21tZW5kZWQgdGhhdCB5b3UgYWx3YXlzIHNwZWNpZnkgYSBzZWNvbmQgcmVqZWN0aW9uCiAgICAgIGhhbmRsZXIgZnVuY3Rpb24gdG8gYHRoZW5gLiBIb3dldmVyLCBgUlNWUC5yZXRocm93YCB3aWxsIHRocm93IHRoZSBleGNlcHRpb24KICAgICAgb3V0c2lkZSBvZiB0aGUgcHJvbWlzZSwgc28gaXQgYnViYmxlcyB1cCB0byB5b3VyIGNvbnNvbGUgaWYgaW4gdGhlIGJyb3dzZXIsCiAgICAgIG9yIGRvbWFpbi9jYXVzZSB1bmNhdWdodCBleGNlcHRpb24gaW4gTm9kZS4gYHJldGhyb3dgIHdpbGwgYWxzbyB0aHJvdyB0aGUKICAgICAgZXJyb3IgYWdhaW4gc28gdGhlIGVycm9yIGNhbiBiZSBoYW5kbGVkIGJ5IHRoZSBwcm9taXNlIHBlciB0aGUgc3BlYy4KCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgZnVuY3Rpb24gdGhyb3dzKCl7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdXaG9vcHMhJyk7CiAgICAgIH0KCiAgICAgIHZhciBwcm9taXNlID0gbmV3IFJTVlAuUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpewogICAgICAgIHRocm93cygpOwogICAgICB9KTsKCiAgICAgIHByb21pc2UuY2F0Y2goUlNWUC5yZXRocm93KS50aGVuKGZ1bmN0aW9uKCl7CiAgICAgICAgLy8gQ29kZSBoZXJlIGRvZXNuJ3QgcnVuIGJlY2F1c2UgdGhlIHByb21pc2UgYmVjYW1lIHJlamVjdGVkIGR1ZSB0byBhbgogICAgICAgIC8vIGVycm9yIQogICAgICB9LCBmdW5jdGlvbiAoZXJyKXsKICAgICAgICAvLyBoYW5kbGUgdGhlIGVycm9yIGhlcmUKICAgICAgfSk7CiAgICAgIGBgYAoKICAgICAgVGhlICdXaG9vcHMnIGVycm9yIHdpbGwgYmUgdGhyb3duIG9uIHRoZSBuZXh0IHR1cm4gb2YgdGhlIGV2ZW50IGxvb3AKICAgICAgYW5kIHlvdSBjYW4gd2F0Y2ggZm9yIGl0IGluIHlvdXIgY29uc29sZS4gWW91IGNhbiBhbHNvIGhhbmRsZSBpdCB1c2luZyBhCiAgICAgIHJlamVjdGlvbiBoYW5kbGVyIGdpdmVuIHRvIGAudGhlbmAgb3IgYC5jYXRjaGAgb24gdGhlIHJldHVybmVkIHByb21pc2UuCgogICAgICBAbWV0aG9kIHJldGhyb3cKICAgICAgQGZvciBSU1ZQCiAgICAgIEBwYXJhbSB7RXJyb3J9IHJlYXNvbiByZWFzb24gdGhlIHByb21pc2UgYmVjYW1lIHJlamVjdGVkLgogICAgICBAdGhyb3dzIEVycm9yCiAgICAgIEBzdGF0aWMKICAgICovCiAgICBfX2V4cG9ydHNfX1siZGVmYXVsdCJdID0gZnVuY3Rpb24gcmV0aHJvdyhyZWFzb24pIHsKICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICB0aHJvdyByZWFzb247CiAgICAgIH0pOwogICAgICB0aHJvdyByZWFzb247CiAgICB9OwogIH0pOwpkZWZpbmUoInJzdnAvdXRpbHMiLCAKICBbImV4cG9ydHMiXSwKICBmdW5jdGlvbihfX2V4cG9ydHNfXykgewogICAgInVzZSBzdHJpY3QiOwogICAgZnVuY3Rpb24gb2JqZWN0T3JGdW5jdGlvbih4KSB7CiAgICAgIHJldHVybiB0eXBlb2YgeCA9PT0gImZ1bmN0aW9uIiB8fCAodHlwZW9mIHggPT09ICJvYmplY3QiICYmIHggIT09IG51bGwpOwogICAgfQoKICAgIF9fZXhwb3J0c19fLm9iamVjdE9yRnVuY3Rpb24gPSBvYmplY3RPckZ1bmN0aW9uO2Z1bmN0aW9uIGlzRnVuY3Rpb24oeCkgewogICAgICByZXR1cm4gdHlwZW9mIHggPT09ICJmdW5jdGlvbiI7CiAgICB9CgogICAgX19leHBvcnRzX18uaXNGdW5jdGlvbiA9IGlzRnVuY3Rpb247ZnVuY3Rpb24gaXNOb25UaGVuYWJsZSh4KSB7CiAgICAgIHJldHVybiAhb2JqZWN0T3JGdW5jdGlvbih4KTsKICAgIH0KCiAgICBfX2V4cG9ydHNfXy5pc05vblRoZW5hYmxlID0gaXNOb25UaGVuYWJsZTtmdW5jdGlvbiBpc0FycmF5KHgpIHsKICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh4KSA9PT0gIltvYmplY3QgQXJyYXldIjsKICAgIH0KCiAgICBfX2V4cG9ydHNfXy5pc0FycmF5ID0gaXNBcnJheTsvLyBEYXRlLm5vdyBpcyBub3QgYXZhaWxhYmxlIGluIGJyb3dzZXJzIDwgSUU5CiAgICAvLyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9KYXZhU2NyaXB0L1JlZmVyZW5jZS9HbG9iYWxfT2JqZWN0cy9EYXRlL25vdyNDb21wYXRpYmlsaXR5CiAgICB2YXIgbm93ID0gRGF0ZS5ub3cgfHwgZnVuY3Rpb24oKSB7IHJldHVybiBuZXcgRGF0ZSgpLmdldFRpbWUoKTsgfTsKICAgIF9fZXhwb3J0c19fLm5vdyA9IG5vdzsKICAgIHZhciBrZXlzT2YgPSBPYmplY3Qua2V5cyB8fCBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwoKICAgICAgZm9yICh2YXIgcHJvcCBpbiBvYmplY3QpIHsKICAgICAgICByZXN1bHQucHVzaChwcm9wKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgICBfX2V4cG9ydHNfXy5rZXlzT2YgPSBrZXlzT2Y7CiAgfSk7CmRlZmluZSgicnN2cCIsIAogIFsiLi9yc3ZwL3Byb21pc2UiLCIuL3JzdnAvZXZlbnRzIiwiLi9yc3ZwL25vZGUiLCIuL3JzdnAvYWxsIiwiLi9yc3ZwL2FsbF9zZXR0bGVkIiwiLi9yc3ZwL3JhY2UiLCIuL3JzdnAvaGFzaCIsIi4vcnN2cC9yZXRocm93IiwiLi9yc3ZwL2RlZmVyIiwiLi9yc3ZwL2NvbmZpZyIsIi4vcnN2cC9tYXAiLCIuL3JzdnAvcmVzb2x2ZSIsIi4vcnN2cC9yZWplY3QiLCIuL3JzdnAvZmlsdGVyIiwiZXhwb3J0cyJdLAogIGZ1bmN0aW9uKF9fZGVwZW5kZW5jeTFfXywgX19kZXBlbmRlbmN5Ml9fLCBfX2RlcGVuZGVuY3kzX18sIF9fZGVwZW5kZW5jeTRfXywgX19kZXBlbmRlbmN5NV9fLCBfX2RlcGVuZGVuY3k2X18sIF9fZGVwZW5kZW5jeTdfXywgX19kZXBlbmRlbmN5OF9fLCBfX2RlcGVuZGVuY3k5X18sIF9fZGVwZW5kZW5jeTEwX18sIF9fZGVwZW5kZW5jeTExX18sIF9fZGVwZW5kZW5jeTEyX18sIF9fZGVwZW5kZW5jeTEzX18sIF9fZGVwZW5kZW5jeTE0X18sIF9fZXhwb3J0c19fKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgUHJvbWlzZSA9IF9fZGVwZW5kZW5jeTFfX1siZGVmYXVsdCJdOwogICAgdmFyIEV2ZW50VGFyZ2V0ID0gX19kZXBlbmRlbmN5Ml9fWyJkZWZhdWx0Il07CiAgICB2YXIgZGVub2RlaWZ5ID0gX19kZXBlbmRlbmN5M19fWyJkZWZhdWx0Il07CiAgICB2YXIgYWxsID0gX19kZXBlbmRlbmN5NF9fWyJkZWZhdWx0Il07CiAgICB2YXIgYWxsU2V0dGxlZCA9IF9fZGVwZW5kZW5jeTVfX1siZGVmYXVsdCJdOwogICAgdmFyIHJhY2UgPSBfX2RlcGVuZGVuY3k2X19bImRlZmF1bHQiXTsKICAgIHZhciBoYXNoID0gX19kZXBlbmRlbmN5N19fWyJkZWZhdWx0Il07CiAgICB2YXIgcmV0aHJvdyA9IF9fZGVwZW5kZW5jeThfX1siZGVmYXVsdCJdOwogICAgdmFyIGRlZmVyID0gX19kZXBlbmRlbmN5OV9fWyJkZWZhdWx0Il07CiAgICB2YXIgY29uZmlnID0gX19kZXBlbmRlbmN5MTBfXy5jb25maWc7CiAgICB2YXIgY29uZmlndXJlID0gX19kZXBlbmRlbmN5MTBfXy5jb25maWd1cmU7CiAgICB2YXIgbWFwID0gX19kZXBlbmRlbmN5MTFfX1siZGVmYXVsdCJdOwogICAgdmFyIHJlc29sdmUgPSBfX2RlcGVuZGVuY3kxMl9fWyJkZWZhdWx0Il07CiAgICB2YXIgcmVqZWN0ID0gX19kZXBlbmRlbmN5MTNfX1siZGVmYXVsdCJdOwogICAgdmFyIGZpbHRlciA9IF9fZGVwZW5kZW5jeTE0X19bImRlZmF1bHQiXTsKCiAgICBmdW5jdGlvbiBhc3luYyhjYWxsYmFjaywgYXJnKSB7CiAgICAgIGNvbmZpZy5hc3luYyhjYWxsYmFjaywgYXJnKTsKICAgIH0KCiAgICBmdW5jdGlvbiBvbigpIHsKICAgICAgY29uZmlnLm9uLmFwcGx5KGNvbmZpZywgYXJndW1lbnRzKTsKICAgIH0KCiAgICBmdW5jdGlvbiBvZmYoKSB7CiAgICAgIGNvbmZpZy5vZmYuYXBwbHkoY29uZmlnLCBhcmd1bWVudHMpOwogICAgfQoKICAgIC8vIFNldCB1cCBpbnN0cnVtZW50YXRpb24gdGhyb3VnaCBgd2luZG93Ll9fUFJPTUlTRV9JTlRSVU1FTlRBVElPTl9fYAogICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiB3aW5kb3cuX19QUk9NSVNFX0lOU1RSVU1FTlRBVElPTl9fID09PSAnb2JqZWN0JykgewogICAgICB2YXIgY2FsbGJhY2tzID0gd2luZG93Ll9fUFJPTUlTRV9JTlNUUlVNRU5UQVRJT05fXzsKICAgICAgY29uZmlndXJlKCdpbnN0cnVtZW50JywgdHJ1ZSk7CiAgICAgIGZvciAodmFyIGV2ZW50TmFtZSBpbiBjYWxsYmFja3MpIHsKICAgICAgICBpZiAoY2FsbGJhY2tzLmhhc093blByb3BlcnR5KGV2ZW50TmFtZSkpIHsKICAgICAgICAgIG9uKGV2ZW50TmFtZSwgY2FsbGJhY2tzW2V2ZW50TmFtZV0pOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIF9fZXhwb3J0c19fLlByb21pc2UgPSBQcm9taXNlOwogICAgX19leHBvcnRzX18uRXZlbnRUYXJnZXQgPSBFdmVudFRhcmdldDsKICAgIF9fZXhwb3J0c19fLmFsbCA9IGFsbDsKICAgIF9fZXhwb3J0c19fLmFsbFNldHRsZWQgPSBhbGxTZXR0bGVkOwogICAgX19leHBvcnRzX18ucmFjZSA9IHJhY2U7CiAgICBfX2V4cG9ydHNfXy5oYXNoID0gaGFzaDsKICAgIF9fZXhwb3J0c19fLnJldGhyb3cgPSByZXRocm93OwogICAgX19leHBvcnRzX18uZGVmZXIgPSBkZWZlcjsKICAgIF9fZXhwb3J0c19fLmRlbm9kZWlmeSA9IGRlbm9kZWlmeTsKICAgIF9fZXhwb3J0c19fLmNvbmZpZ3VyZSA9IGNvbmZpZ3VyZTsKICAgIF9fZXhwb3J0c19fLm9uID0gb247CiAgICBfX2V4cG9ydHNfXy5vZmYgPSBvZmY7CiAgICBfX2V4cG9ydHNfXy5yZXNvbHZlID0gcmVzb2x2ZTsKICAgIF9fZXhwb3J0c19fLnJlamVjdCA9IHJlamVjdDsKICAgIF9fZXhwb3J0c19fLmFzeW5jID0gYXN5bmM7CiAgICBfX2V4cG9ydHNfXy5tYXAgPSBtYXA7CiAgICBfX2V4cG9ydHNfXy5maWx0ZXIgPSBmaWx0ZXI7CiAgfSk7Cgp9KSgpOwoKKGZ1bmN0aW9uKCkgewovKioKUHVibGljIGFwaSBmb3IgdGhlIGNvbnRhaW5lciBpcyBzdGlsbCBpbiBmbHV4LgpUaGUgcHVibGljIGFwaSwgc3BlY2lmaWVkIG9uIHRoZSBhcHBsaWNhdGlvbiBuYW1lc3BhY2Ugc2hvdWxkIGJlIGNvbnNpZGVyZWQgdGhlIHN0YWJsZSBhcGkuCi8vIEBtb2R1bGUgY29udGFpbmVyCiAgQHByaXZhdGUKKi8KCi8qCiBGbGFnIHRvIGVuYWJsZS9kaXNhYmxlIG1vZGVsIGZhY3RvcnkgaW5qZWN0aW9ucyAoZGlzYWJsZWQgYnkgZGVmYXVsdCkKIElmIG1vZGVsIGZhY3RvcnkgaW5qZWN0aW9ucyBhcmUgZW5hYmxlZCwgbW9kZWxzIHNob3VsZCBub3QgYmUKIGFjY2Vzc2VkIGdsb2JhbGx5IChvbmx5IHRocm91Z2ggYGNvbnRhaW5lci5sb29rdXBGYWN0b3J5KCdtb2RlbDptb2RlbE5hbWUnKSlgKTsKKi8KRW1iZXIuTU9ERUxfRkFDVE9SWV9JTkpFQ1RJT05TID0gZmFsc2UgfHwgISFFbWJlci5FTlYuTU9ERUxfRkFDVE9SWV9JTkpFQ1RJT05TOwoKZGVmaW5lKCJjb250YWluZXIiLAogIFtdLAogIGZ1bmN0aW9uKCkgewoKICAgIC8vIEEgc2FmZSBhbmQgc2ltcGxlIGluaGVyaXRpbmcgb2JqZWN0LgogICAgZnVuY3Rpb24gSW5oZXJpdGluZ0RpY3QocGFyZW50KSB7CiAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgICB0aGlzLmRpY3QgPSB7fTsKICAgIH0KCiAgICBJbmhlcml0aW5nRGljdC5wcm90b3R5cGUgPSB7CgogICAgICAvKioKICAgICAgICBAcHJvcGVydHkgcGFyZW50CiAgICAgICAgQHR5cGUgSW5oZXJpdGluZ0RpY3QKICAgICAgICBAZGVmYXVsdCBudWxsCiAgICAgICovCgogICAgICBwYXJlbnQ6IG51bGwsCgogICAgICAvKioKICAgICAgICBPYmplY3QgdXNlZCB0byBzdG9yZSB0aGUgY3VycmVudCBub2RlcyBkYXRhLgoKICAgICAgICBAcHJvcGVydHkgZGljdAogICAgICAgIEB0eXBlIE9iamVjdAogICAgICAgIEBkZWZhdWx0IE9iamVjdAogICAgICAqLwogICAgICBkaWN0OiBudWxsLAoKICAgICAgLyoqCiAgICAgICAgUmV0cmlldmUgdGhlIHZhbHVlIGdpdmVuIGEga2V5LCBpZiB0aGUgdmFsdWUgaXMgcHJlc2VudCBhdCB0aGUgY3VycmVudAogICAgICAgIGxldmVsIHVzZSBpdCwgb3RoZXJ3aXNlIHdhbGsgdXAgdGhlIHBhcmVudCBoaWVyYXJjaHkgYW5kIHRyeSBhZ2Fpbi4gSWYKICAgICAgICBubyBtYXRjaGluZyBrZXkgaXMgZm91bmQsIHJldHVybiB1bmRlZmluZWQuCgogICAgICAgIEBtZXRob2QgZ2V0CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGtleQogICAgICAgIEByZXR1cm4ge2FueX0KICAgICAgKi8KICAgICAgZ2V0OiBmdW5jdGlvbihrZXkpIHsKICAgICAgICB2YXIgZGljdCA9IHRoaXMuZGljdDsKCiAgICAgICAgaWYgKGRpY3QuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgcmV0dXJuIGRpY3Rba2V5XTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnBhcmVudCkgewogICAgICAgICAgcmV0dXJuIHRoaXMucGFyZW50LmdldChrZXkpOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgIFNldCB0aGUgZ2l2ZW4gdmFsdWUgZm9yIHRoZSBnaXZlbiBrZXksIGF0IHRoZSBjdXJyZW50IGxldmVsLgoKICAgICAgICBAbWV0aG9kIHNldAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBrZXkKICAgICAgICBAcGFyYW0ge0FueX0gdmFsdWUKICAgICAgKi8KICAgICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgdGhpcy5kaWN0W2tleV0gPSB2YWx1ZTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgIERlbGV0ZSB0aGUgZ2l2ZW4ga2V5CgogICAgICAgIEBtZXRob2QgcmVtb3ZlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGtleQogICAgICAqLwogICAgICByZW1vdmU6IGZ1bmN0aW9uKGtleSkgewogICAgICAgIGRlbGV0ZSB0aGlzLmRpY3Rba2V5XTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgIENoZWNrIGZvciB0aGUgZXhpc3RlbmNlIG9mIGdpdmVuIGEga2V5LCBpZiB0aGUga2V5IGlzIHByZXNlbnQgYXQgdGhlIGN1cnJlbnQKICAgICAgICBsZXZlbCByZXR1cm4gdHJ1ZSwgb3RoZXJ3aXNlIHdhbGsgdXAgdGhlIHBhcmVudCBoaWVyYXJjaHkgYW5kIHRyeSBhZ2Fpbi4gSWYKICAgICAgICBubyBtYXRjaGluZyBrZXkgaXMgZm91bmQsIHJldHVybiBmYWxzZS4KCiAgICAgICAgQG1ldGhvZCBoYXMKICAgICAgICBAcGFyYW0ge1N0cmluZ30ga2V5CiAgICAgICAgQHJldHVybiB7Qm9vbGVhbn0KICAgICAgKi8KICAgICAgaGFzOiBmdW5jdGlvbihrZXkpIHsKICAgICAgICB2YXIgZGljdCA9IHRoaXMuZGljdDsKCiAgICAgICAgaWYgKGRpY3QuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5wYXJlbnQpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnBhcmVudC5oYXMoa2V5KTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgIEl0ZXJhdGUgYW5kIGludm9rZSBhIGNhbGxiYWNrIGZvciBlYWNoIGxvY2FsIGtleS12YWx1ZSBwYWlyLgoKICAgICAgICBAbWV0aG9kIGVhY2hMb2NhbAogICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGJpbmRpbmcKICAgICAgKi8KICAgICAgZWFjaExvY2FsOiBmdW5jdGlvbihjYWxsYmFjaywgYmluZGluZykgewogICAgICAgIHZhciBkaWN0ID0gdGhpcy5kaWN0OwoKICAgICAgICBmb3IgKHZhciBwcm9wIGluIGRpY3QpIHsKICAgICAgICAgIGlmIChkaWN0Lmhhc093blByb3BlcnR5KHByb3ApKSB7CiAgICAgICAgICAgIGNhbGxiYWNrLmNhbGwoYmluZGluZywgcHJvcCwgZGljdFtwcm9wXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKCiAgICAvLyBBIGxpZ2h0d2VpZ2h0IGNvbnRhaW5lciB0aGF0IGhlbHBzIHRvIGFzc2VtYmxlIGFuZCBkZWNvdXBsZSBjb21wb25lbnRzLgogICAgLy8gUHVibGljIGFwaSBmb3IgdGhlIGNvbnRhaW5lciBpcyBzdGlsbCBpbiBmbHV4LgogICAgLy8gVGhlIHB1YmxpYyBhcGksIHNwZWNpZmllZCBvbiB0aGUgYXBwbGljYXRpb24gbmFtZXNwYWNlIHNob3VsZCBiZSBjb25zaWRlcmVkIHRoZSBzdGFibGUgYXBpLgogICAgZnVuY3Rpb24gQ29udGFpbmVyKHBhcmVudCkgewogICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgICAgdGhpcy5jaGlsZHJlbiA9IFtdOwoKICAgICAgdGhpcy5yZXNvbHZlciA9IHBhcmVudCAmJiBwYXJlbnQucmVzb2x2ZXIgfHwgZnVuY3Rpb24oKSB7fTsKCiAgICAgIHRoaXMucmVnaXN0cnkgPSBuZXcgSW5oZXJpdGluZ0RpY3QocGFyZW50ICYmIHBhcmVudC5yZWdpc3RyeSk7CiAgICAgIHRoaXMuY2FjaGUgPSBuZXcgSW5oZXJpdGluZ0RpY3QocGFyZW50ICYmIHBhcmVudC5jYWNoZSk7CiAgICAgIHRoaXMuZmFjdG9yeUNhY2hlID0gbmV3IEluaGVyaXRpbmdEaWN0KHBhcmVudCAmJiBwYXJlbnQuY2FjaGUpOwogICAgICB0aGlzLnR5cGVJbmplY3Rpb25zID0gbmV3IEluaGVyaXRpbmdEaWN0KHBhcmVudCAmJiBwYXJlbnQudHlwZUluamVjdGlvbnMpOwogICAgICB0aGlzLmluamVjdGlvbnMgPSB7fTsKCiAgICAgIHRoaXMuZmFjdG9yeVR5cGVJbmplY3Rpb25zID0gbmV3IEluaGVyaXRpbmdEaWN0KHBhcmVudCAmJiBwYXJlbnQuZmFjdG9yeVR5cGVJbmplY3Rpb25zKTsKICAgICAgdGhpcy5mYWN0b3J5SW5qZWN0aW9ucyA9IHt9OwoKICAgICAgdGhpcy5fb3B0aW9ucyA9IG5ldyBJbmhlcml0aW5nRGljdChwYXJlbnQgJiYgcGFyZW50Ll9vcHRpb25zKTsKICAgICAgdGhpcy5fdHlwZU9wdGlvbnMgPSBuZXcgSW5oZXJpdGluZ0RpY3QocGFyZW50ICYmIHBhcmVudC5fdHlwZU9wdGlvbnMpOwogICAgfQoKICAgIENvbnRhaW5lci5wcm90b3R5cGUgPSB7CgogICAgICAvKioKICAgICAgICBAcHJvcGVydHkgcGFyZW50CiAgICAgICAgQHR5cGUgQ29udGFpbmVyCiAgICAgICAgQGRlZmF1bHQgbnVsbAogICAgICAqLwogICAgICBwYXJlbnQ6IG51bGwsCgogICAgICAvKioKICAgICAgICBAcHJvcGVydHkgY2hpbGRyZW4KICAgICAgICBAdHlwZSBBcnJheQogICAgICAgIEBkZWZhdWx0IFtdCiAgICAgICovCiAgICAgIGNoaWxkcmVuOiBudWxsLAoKICAgICAgLyoqCiAgICAgICAgQHByb3BlcnR5IHJlc29sdmVyCiAgICAgICAgQHR5cGUgZnVuY3Rpb24KICAgICAgKi8KICAgICAgcmVzb2x2ZXI6IG51bGwsCgogICAgICAvKioKICAgICAgICBAcHJvcGVydHkgcmVnaXN0cnkKICAgICAgICBAdHlwZSBJbmhlcml0aW5nRGljdAogICAgICAqLwogICAgICByZWdpc3RyeTogbnVsbCwKCiAgICAgIC8qKgogICAgICAgIEBwcm9wZXJ0eSBjYWNoZQogICAgICAgIEB0eXBlIEluaGVyaXRpbmdEaWN0CiAgICAgICovCiAgICAgIGNhY2hlOiBudWxsLAoKICAgICAgLyoqCiAgICAgICAgQHByb3BlcnR5IHR5cGVJbmplY3Rpb25zCiAgICAgICAgQHR5cGUgSW5oZXJpdGluZ0RpY3QKICAgICAgKi8KICAgICAgdHlwZUluamVjdGlvbnM6IG51bGwsCgogICAgICAvKioKICAgICAgICBAcHJvcGVydHkgaW5qZWN0aW9ucwogICAgICAgIEB0eXBlIE9iamVjdAogICAgICAgIEBkZWZhdWx0IHt9CiAgICAgICovCiAgICAgIGluamVjdGlvbnM6IG51bGwsCgogICAgICAvKioKICAgICAgICBAcHJpdmF0ZQoKICAgICAgICBAcHJvcGVydHkgX29wdGlvbnMKICAgICAgICBAdHlwZSBJbmhlcml0aW5nRGljdAogICAgICAgIEBkZWZhdWx0IG51bGwKICAgICAgKi8KICAgICAgX29wdGlvbnM6IG51bGwsCgogICAgICAvKioKICAgICAgICBAcHJpdmF0ZQoKICAgICAgICBAcHJvcGVydHkgX3R5cGVPcHRpb25zCiAgICAgICAgQHR5cGUgSW5oZXJpdGluZ0RpY3QKICAgICAgKi8KICAgICAgX3R5cGVPcHRpb25zOiBudWxsLAoKICAgICAgLyoqCiAgICAgICAgUmV0dXJucyBhIG5ldyBjaGlsZCBvZiB0aGUgY3VycmVudCBjb250YWluZXIuIFRoZXNlIGNoaWxkcmVuIGFyZSBjb25maWd1cmVkCiAgICAgICAgdG8gY29ycmVjdGx5IGluaGVyaXQgZnJvbSB0aGUgY3VycmVudCBjb250YWluZXIuCgogICAgICAgIEBtZXRob2QgY2hpbGQKICAgICAgICBAcmV0dXJuIHtDb250YWluZXJ9CiAgICAgICovCiAgICAgIGNoaWxkOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgY29udGFpbmVyID0gbmV3IENvbnRhaW5lcih0aGlzKTsKICAgICAgICB0aGlzLmNoaWxkcmVuLnB1c2goY29udGFpbmVyKTsKICAgICAgICByZXR1cm4gY29udGFpbmVyOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAgU2V0cyBhIGtleS12YWx1ZSBwYWlyIG9uIHRoZSBjdXJyZW50IGNvbnRhaW5lci4gSWYgYSBwYXJlbnQgY29udGFpbmVyLAogICAgICAgIGhhcyB0aGUgc2FtZSBrZXksIG9uY2Ugc2V0IG9uIGEgY2hpbGQsIHRoZSBwYXJlbnQgYW5kIGNoaWxkIHdpbGwgZGl2ZXJnZQogICAgICAgIGFzIGV4cGVjdGVkLgoKICAgICAgICBAbWV0aG9kIHNldAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QKICAgICAgICBAcGFyYW0ge1N0cmluZ30ga2V5CiAgICAgICAgQHBhcmFtIHthbnl9IHZhbHVlCiAgICAgICovCiAgICAgIHNldDogZnVuY3Rpb24ob2JqZWN0LCBrZXksIHZhbHVlKSB7CiAgICAgICAgb2JqZWN0W2tleV0gPSB2YWx1ZTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgIFJlZ2lzdGVycyBhIGZhY3RvcnkgZm9yIGxhdGVyIGluamVjdGlvbi4KCiAgICAgICAgRXhhbXBsZToKCiAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICAgIHZhciBjb250YWluZXIgPSBuZXcgQ29udGFpbmVyKCk7CgogICAgICAgIGNvbnRhaW5lci5yZWdpc3RlcignbW9kZWw6dXNlcicsIFBlcnNvbiwge3NpbmdsZXRvbjogZmFsc2UgfSk7CiAgICAgICAgY29udGFpbmVyLnJlZ2lzdGVyKCdmcnVpdDpmYXZvcml0ZScsIE9yYW5nZSk7CiAgICAgICAgY29udGFpbmVyLnJlZ2lzdGVyKCdjb21tdW5pY2F0aW9uOm1haW4nLCBFbWFpbCwge3NpbmdsZXRvbjogZmFsc2V9KTsKICAgICAgICBgYGAKCiAgICAgICAgQG1ldGhvZCByZWdpc3RlcgogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBmdWxsTmFtZQogICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGZhY3RvcnkKICAgICAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAgICAqLwogICAgICByZWdpc3RlcjogZnVuY3Rpb24oZnVsbE5hbWUsIGZhY3RvcnksIG9wdGlvbnMpIHsKICAgICAgICBpZiAoZnVsbE5hbWUuaW5kZXhPZignOicpID09PSAtMSkgewogICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigibWFsZm9ybWVkIGZ1bGxOYW1lLCBleHBlY3RlZDogYHR5cGU6bmFtZWAgZ290OiAiICsgZnVsbE5hbWUgKyAiIik7CiAgICAgICAgfQoKICAgICAgICBpZiAoZmFjdG9yeSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdBdHRlbXB0aW5nIHRvIHJlZ2lzdGVyIGFuIHVua25vd24gZmFjdG9yeTogYCcgKyBmdWxsTmFtZSArICdgJyk7CiAgICAgICAgfQoKICAgICAgICB2YXIgbm9ybWFsaXplZE5hbWUgPSB0aGlzLm5vcm1hbGl6ZShmdWxsTmFtZSk7CgogICAgICAgIGlmICh0aGlzLmNhY2hlLmhhcyhub3JtYWxpemVkTmFtZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHJlLXJlZ2lzdGVyOiBgJyArIGZ1bGxOYW1lICsnYCwgYXMgaXQgaGFzIGFscmVhZHkgYmVlbiBsb29rZWQgdXAuJyk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnJlZ2lzdHJ5LnNldChub3JtYWxpemVkTmFtZSwgZmFjdG9yeSk7CiAgICAgICAgdGhpcy5fb3B0aW9ucy5zZXQobm9ybWFsaXplZE5hbWUsIG9wdGlvbnMgfHwge30pOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAgVW5yZWdpc3RlciBhIGZ1bGxOYW1lCgogICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgICB2YXIgY29udGFpbmVyID0gbmV3IENvbnRhaW5lcigpOwogICAgICAgIGNvbnRhaW5lci5yZWdpc3RlcignbW9kZWw6dXNlcicsIFVzZXIpOwoKICAgICAgICBjb250YWluZXIubG9va3VwKCdtb2RlbDp1c2VyJykgaW5zdGFuY2VvZiBVc2VyIC8vPT4gdHJ1ZQoKICAgICAgICBjb250YWluZXIudW5yZWdpc3RlcignbW9kZWw6dXNlcicpCiAgICAgICAgY29udGFpbmVyLmxvb2t1cCgnbW9kZWw6dXNlcicpID09PSB1bmRlZmluZWQgLy89PiB0cnVlCiAgICAgICAgYGBgCgogICAgICAgIEBtZXRob2QgdW5yZWdpc3RlcgogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBmdWxsTmFtZQogICAgICAgKi8KICAgICAgdW5yZWdpc3RlcjogZnVuY3Rpb24oZnVsbE5hbWUpIHsKICAgICAgICB2YXIgbm9ybWFsaXplZE5hbWUgPSB0aGlzLm5vcm1hbGl6ZShmdWxsTmFtZSk7CgogICAgICAgIHRoaXMucmVnaXN0cnkucmVtb3ZlKG5vcm1hbGl6ZWROYW1lKTsKICAgICAgICB0aGlzLmNhY2hlLnJlbW92ZShub3JtYWxpemVkTmFtZSk7CiAgICAgICAgdGhpcy5mYWN0b3J5Q2FjaGUucmVtb3ZlKG5vcm1hbGl6ZWROYW1lKTsKICAgICAgICB0aGlzLl9vcHRpb25zLnJlbW92ZShub3JtYWxpemVkTmFtZSk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICBHaXZlbiBhIGZ1bGxOYW1lIHJldHVybiB0aGUgY29ycmVzcG9uZGluZyBmYWN0b3J5LgoKICAgICAgICBCeSBkZWZhdWx0IGByZXNvbHZlYCB3aWxsIHJldHJpZXZlIHRoZSBmYWN0b3J5IGZyb20KICAgICAgICBpdHMgY29udGFpbmVyJ3MgcmVnaXN0cnkuCgogICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgICB2YXIgY29udGFpbmVyID0gbmV3IENvbnRhaW5lcigpOwogICAgICAgIGNvbnRhaW5lci5yZWdpc3RlcignYXBpOnR3aXR0ZXInLCBUd2l0dGVyKTsKCiAgICAgICAgY29udGFpbmVyLnJlc29sdmUoJ2FwaTp0d2l0dGVyJykgLy8gPT4gVHdpdHRlcgogICAgICAgIGBgYAoKICAgICAgICBPcHRpb25hbGx5IHRoZSBjb250YWluZXIgY2FuIGJlIHByb3ZpZGVkIHdpdGggYSBjdXN0b20gcmVzb2x2ZXIuCiAgICAgICAgSWYgcHJvdmlkZWQsIGByZXNvbHZlYCB3aWxsIGZpcnN0IHByb3ZpZGUgdGhlIGN1c3RvbSByZXNvbHZlcgogICAgICAgIHRoZSBvcHBlcnR1bml0eSB0byByZXNvbHZlIHRoZSBmdWxsTmFtZSwgb3RoZXJ3aXNlIGl0IHdpbGwgZmFsbGJhY2sKICAgICAgICB0byB0aGUgcmVnaXN0cnkuCgogICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgICB2YXIgY29udGFpbmVyID0gbmV3IENvbnRhaW5lcigpOwogICAgICAgIGNvbnRhaW5lci5yZXNvbHZlciA9IGZ1bmN0aW9uKGZ1bGxOYW1lKSB7CiAgICAgICAgICAvLyBsb29rdXAgdmlhIHRoZSBtb2R1bGUgc3lzdGVtIG9mIGNob2ljZQogICAgICAgIH07CgogICAgICAgIC8vIHRoZSB0d2l0dGVyIGZhY3RvcnkgaXMgYWRkZWQgdG8gdGhlIG1vZHVsZSBzeXN0ZW0KICAgICAgICBjb250YWluZXIucmVzb2x2ZSgnYXBpOnR3aXR0ZXInKSAvLyA9PiBUd2l0dGVyCiAgICAgICAgYGBgCgogICAgICAgIEBtZXRob2QgcmVzb2x2ZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBmdWxsTmFtZQogICAgICAgIEByZXR1cm4ge0Z1bmN0aW9ufSBmdWxsTmFtZSdzIGZhY3RvcnkKICAgICAgKi8KICAgICAgcmVzb2x2ZTogZnVuY3Rpb24oZnVsbE5hbWUpIHsKICAgICAgICByZXR1cm4gdGhpcy5yZXNvbHZlcihmdWxsTmFtZSkgfHwgdGhpcy5yZWdpc3RyeS5nZXQoZnVsbE5hbWUpOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAgQSBob29rIHRoYXQgY2FuIGJlIHVzZWQgdG8gZGVzY3JpYmUgaG93IHRoZSByZXNvbHZlciB3aWxsCiAgICAgICAgYXR0ZW1wdCB0byBmaW5kIHRoZSBmYWN0b3J5LgoKICAgICAgICBGb3IgZXhhbXBsZSwgdGhlIGRlZmF1bHQgRW1iZXIgYC5kZXNjcmliZWAgcmV0dXJucyB0aGUgZnVsbAogICAgICAgIGNsYXNzIG5hbWUgKGluY2x1ZGluZyBuYW1lc3BhY2UpIHdoZXJlIEVtYmVyJ3MgcmVzb2x2ZXIgZXhwZWN0cwogICAgICAgIHRvIGZpbmQgdGhlIGBmdWxsTmFtZWAuCgogICAgICAgIEBtZXRob2QgZGVzY3JpYmUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gZnVsbE5hbWUKICAgICAgICBAcmV0dXJuIHtzdHJpbmd9IGRlc2NyaWJlZCBmdWxsTmFtZQogICAgICAqLwogICAgICBkZXNjcmliZTogZnVuY3Rpb24oZnVsbE5hbWUpIHsKICAgICAgICByZXR1cm4gZnVsbE5hbWU7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICBBIGhvb2sgdG8gZW5hYmxlIGN1c3RvbSBmdWxsTmFtZSBub3JtYWxpemF0aW9uIGJlaGF2aW91cgoKICAgICAgICBAbWV0aG9kIG5vcm1hbGl6ZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBmdWxsTmFtZQogICAgICAgIEByZXR1cm4ge3N0cmluZ30gbm9ybWFsaXplZCBmdWxsTmFtZQogICAgICAqLwogICAgICBub3JtYWxpemU6IGZ1bmN0aW9uKGZ1bGxOYW1lKSB7CiAgICAgICAgcmV0dXJuIGZ1bGxOYW1lOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAgQG1ldGhvZCBtYWtlVG9TdHJpbmcKCiAgICAgICAgQHBhcmFtIHthbnl9IGZhY3RvcnkKICAgICAgICBAcGFyYW0ge3N0cmluZ30gZnVsbE5hbWUKICAgICAgICBAcmV0dXJuIHtmdW5jdGlvbn0gdG9TdHJpbmcgZnVuY3Rpb24KICAgICAgKi8KICAgICAgbWFrZVRvU3RyaW5nOiBmdW5jdGlvbihmYWN0b3J5LCBmdWxsTmFtZSkgewogICAgICAgIHJldHVybiBmYWN0b3J5LnRvU3RyaW5nKCk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICBHaXZlbiBhIGZ1bGxOYW1lIHJldHVybiBhIGNvcnJlc3BvbmRpbmcgaW5zdGFuY2UuCgogICAgICAgIFRoZSBkZWZhdWx0IGJlaGF2aW91ciBpcyBmb3IgbG9va3VwIHRvIHJldHVybiBhIHNpbmdsZXRvbiBpbnN0YW5jZS4KICAgICAgICBUaGUgc2luZ2xldG9uIGlzIHNjb3BlZCB0byB0aGUgY29udGFpbmVyLCBhbGxvd2luZyBtdWx0aXBsZSBjb250YWluZXJzCiAgICAgICAgdG8gYWxsIGhhdmUgdGhlaXIgb3duIGxvY2FsbHkgc2NvcGVkIHNpbmdsZXRvbnMuCgogICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgICB2YXIgY29udGFpbmVyID0gbmV3IENvbnRhaW5lcigpOwogICAgICAgIGNvbnRhaW5lci5yZWdpc3RlcignYXBpOnR3aXR0ZXInLCBUd2l0dGVyKTsKCiAgICAgICAgdmFyIHR3aXR0ZXIgPSBjb250YWluZXIubG9va3VwKCdhcGk6dHdpdHRlcicpOwoKICAgICAgICB0d2l0dGVyIGluc3RhbmNlb2YgVHdpdHRlcjsgLy8gPT4gdHJ1ZQoKICAgICAgICAvLyBieSBkZWZhdWx0IHRoZSBjb250YWluZXIgd2lsbCByZXR1cm4gc2luZ2xldG9ucwogICAgICAgIHZhciB0d2l0dGVyMiA9IGNvbnRhaW5lci5sb29rdXAoJ2FwaTp0d2l0dGVyJyk7CiAgICAgICAgdHdpdHRlciBpbnN0YW5jZW9mIFR3aXR0ZXI7IC8vID0+IHRydWUKCiAgICAgICAgdHdpdHRlciA9PT0gdHdpdHRlcjI7IC8vPT4gdHJ1ZQogICAgICAgIGBgYAoKICAgICAgICBJZiBzaW5nbGV0b25zIGFyZSBub3Qgd2FudGVkIGFuIG9wdGlvbmFsIGZsYWcgY2FuIGJlIHByb3ZpZGVkIGF0IGxvb2t1cC4KCiAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICAgIHZhciBjb250YWluZXIgPSBuZXcgQ29udGFpbmVyKCk7CiAgICAgICAgY29udGFpbmVyLnJlZ2lzdGVyKCdhcGk6dHdpdHRlcicsIFR3aXR0ZXIpOwoKICAgICAgICB2YXIgdHdpdHRlciA9IGNvbnRhaW5lci5sb29rdXAoJ2FwaTp0d2l0dGVyJywgeyBzaW5nbGV0b246IGZhbHNlIH0pOwogICAgICAgIHZhciB0d2l0dGVyMiA9IGNvbnRhaW5lci5sb29rdXAoJ2FwaTp0d2l0dGVyJywgeyBzaW5nbGV0b246IGZhbHNlIH0pOwoKICAgICAgICB0d2l0dGVyID09PSB0d2l0dGVyMjsgLy89PiBmYWxzZQogICAgICAgIGBgYAoKICAgICAgICBAbWV0aG9kIGxvb2t1cAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBmdWxsTmFtZQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICAgICAgQHJldHVybiB7YW55fQogICAgICAqLwogICAgICBsb29rdXA6IGZ1bmN0aW9uKGZ1bGxOYW1lLCBvcHRpb25zKSB7CiAgICAgICAgZnVsbE5hbWUgPSB0aGlzLm5vcm1hbGl6ZShmdWxsTmFtZSk7CgogICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgICAgICBpZiAodGhpcy5jYWNoZS5oYXMoZnVsbE5hbWUpICYmIG9wdGlvbnMuc2luZ2xldG9uICE9PSBmYWxzZSkgewogICAgICAgICAgcmV0dXJuIHRoaXMuY2FjaGUuZ2V0KGZ1bGxOYW1lKTsKICAgICAgICB9CgogICAgICAgIHZhciB2YWx1ZSA9IGluc3RhbnRpYXRlKHRoaXMsIGZ1bGxOYW1lKTsKCiAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsgcmV0dXJuOyB9CgogICAgICAgIGlmIChpc1NpbmdsZXRvbih0aGlzLCBmdWxsTmFtZSkgJiYgb3B0aW9ucy5zaW5nbGV0b24gIT09IGZhbHNlKSB7CiAgICAgICAgICB0aGlzLmNhY2hlLnNldChmdWxsTmFtZSwgdmFsdWUpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAgR2l2ZW4gYSBmdWxsTmFtZSByZXR1cm4gdGhlIGNvcnJlc3BvbmRpbmcgZmFjdG9yeS4KCiAgICAgICAgQG1ldGhvZCBsb29rdXBGYWN0b3J5CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGZ1bGxOYW1lCiAgICAgICAgQHJldHVybiB7YW55fQogICAgICAqLwogICAgICBsb29rdXBGYWN0b3J5OiBmdW5jdGlvbihmdWxsTmFtZSkgewogICAgICAgIHJldHVybiBmYWN0b3J5Rm9yKHRoaXMsIGZ1bGxOYW1lKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgIEdpdmVuIGEgZnVsbE5hbWUgY2hlY2sgaWYgdGhlIGNvbnRhaW5lciBpcyBhd2FyZSBvZiBpdHMgZmFjdG9yeQogICAgICAgIG9yIHNpbmdsZXRvbiBpbnN0YW5jZS4KCiAgICAgICAgQG1ldGhvZCBoYXMKICAgICAgICBAcGFyYW0ge1N0cmluZ30gZnVsbE5hbWUKICAgICAgICBAcmV0dXJuIHtCb29sZWFufQogICAgICAqLwogICAgICBoYXM6IGZ1bmN0aW9uKGZ1bGxOYW1lKSB7CiAgICAgICAgaWYgKHRoaXMuY2FjaGUuaGFzKGZ1bGxOYW1lKSkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gISF0aGlzLnJlc29sdmUoZnVsbE5hbWUpOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAgQWxsb3cgcmVnaXN0ZXJpbmcgb3B0aW9ucyBmb3IgYWxsIGZhY3RvcmllcyBvZiBhIHR5cGUuCgogICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgICB2YXIgY29udGFpbmVyID0gbmV3IENvbnRhaW5lcigpOwoKICAgICAgICAvLyBpZiBhbGwgb2YgdHlwZSBgY29ubmVjdGlvbmAgbXVzdCBub3QgYmUgc2luZ2xldG9ucwogICAgICAgIGNvbnRhaW5lci5vcHRpb25zRm9yVHlwZSgnY29ubmVjdGlvbicsIHsgc2luZ2xldG9uOiBmYWxzZSB9KTsKCiAgICAgICAgY29udGFpbmVyLnJlZ2lzdGVyKCdjb25uZWN0aW9uOnR3aXR0ZXInLCBUd2l0dGVyQ29ubmVjdGlvbik7CiAgICAgICAgY29udGFpbmVyLnJlZ2lzdGVyKCdjb25uZWN0aW9uOmZhY2Vib29rJywgRmFjZWJvb2tDb25uZWN0aW9uKTsKCiAgICAgICAgdmFyIHR3aXR0ZXIgPSBjb250YWluZXIubG9va3VwKCdjb25uZWN0aW9uOnR3aXR0ZXInKTsKICAgICAgICB2YXIgdHdpdHRlcjIgPSBjb250YWluZXIubG9va3VwKCdjb25uZWN0aW9uOnR3aXR0ZXInKTsKCiAgICAgICAgdHdpdHRlciA9PT0gdHdpdHRlcjI7IC8vID0+IGZhbHNlCgogICAgICAgIHZhciBmYWNlYm9vayA9IGNvbnRhaW5lci5sb29rdXAoJ2Nvbm5lY3Rpb246ZmFjZWJvb2snKTsKICAgICAgICB2YXIgZmFjZWJvb2syID0gY29udGFpbmVyLmxvb2t1cCgnY29ubmVjdGlvbjpmYWNlYm9vaycpOwoKICAgICAgICBmYWNlYm9vayA9PT0gZmFjZWJvb2syOyAvLyA9PiBmYWxzZQogICAgICAgIGBgYAoKICAgICAgICBAbWV0aG9kIG9wdGlvbnNGb3JUeXBlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUKICAgICAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAgICAqLwogICAgICBvcHRpb25zRm9yVHlwZTogZnVuY3Rpb24odHlwZSwgb3B0aW9ucykgewogICAgICAgIGlmICh0aGlzLnBhcmVudCkgeyBpbGxlZ2FsQ2hpbGRPcGVyYXRpb24oJ29wdGlvbnNGb3JUeXBlJyk7IH0KCiAgICAgICAgdGhpcy5fdHlwZU9wdGlvbnMuc2V0KHR5cGUsIG9wdGlvbnMpOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAgQG1ldGhvZCBvcHRpb25zCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUKICAgICAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAgICAqLwogICAgICBvcHRpb25zOiBmdW5jdGlvbih0eXBlLCBvcHRpb25zKSB7CiAgICAgICAgdGhpcy5vcHRpb25zRm9yVHlwZSh0eXBlLCBvcHRpb25zKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgIFVzZWQgb25seSB2aWEgYGluamVjdGlvbmAuCgogICAgICAgIFByb3ZpZGVzIGEgc3BlY2lhbGl6ZWQgZm9ybSBvZiBpbmplY3Rpb24sIHNwZWNpZmljYWxseSBlbmFibGluZwogICAgICAgIGFsbCBvYmplY3RzIG9mIG9uZSB0eXBlIHRvIGJlIGluamVjdGVkIHdpdGggYSByZWZlcmVuY2UgdG8gYW5vdGhlcgogICAgICAgIG9iamVjdC4KCiAgICAgICAgRm9yIGV4YW1wbGUsIHByb3ZpZGVkIGVhY2ggb2JqZWN0IG9mIHR5cGUgYGNvbnRyb2xsZXJgIG5lZWRlZCBhIGByb3V0ZXJgLgogICAgICAgIG9uZSB3b3VsZCBkbyB0aGUgZm9sbG93aW5nOgoKICAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgICAgdmFyIGNvbnRhaW5lciA9IG5ldyBDb250YWluZXIoKTsKCiAgICAgICAgY29udGFpbmVyLnJlZ2lzdGVyKCdyb3V0ZXI6bWFpbicsIFJvdXRlcik7CiAgICAgICAgY29udGFpbmVyLnJlZ2lzdGVyKCdjb250cm9sbGVyOnVzZXInLCBVc2VyQ29udHJvbGxlcik7CiAgICAgICAgY29udGFpbmVyLnJlZ2lzdGVyKCdjb250cm9sbGVyOnBvc3QnLCBQb3N0Q29udHJvbGxlcik7CgogICAgICAgIGNvbnRhaW5lci50eXBlSW5qZWN0aW9uKCdjb250cm9sbGVyJywgJ3JvdXRlcicsICdyb3V0ZXI6bWFpbicpOwoKICAgICAgICB2YXIgdXNlciA9IGNvbnRhaW5lci5sb29rdXAoJ2NvbnRyb2xsZXI6dXNlcicpOwogICAgICAgIHZhciBwb3N0ID0gY29udGFpbmVyLmxvb2t1cCgnY29udHJvbGxlcjpwb3N0Jyk7CgogICAgICAgIHVzZXIucm91dGVyIGluc3RhbmNlb2YgUm91dGVyOyAvLz0+IHRydWUKICAgICAgICBwb3N0LnJvdXRlciBpbnN0YW5jZW9mIFJvdXRlcjsgLy89PiB0cnVlCgogICAgICAgIC8vIGJvdGggY29udHJvbGxlcnMgc2hhcmUgdGhlIHNhbWUgcm91dGVyCiAgICAgICAgdXNlci5yb3V0ZXIgPT09IHBvc3Qucm91dGVyOyAvLz0+IHRydWUKICAgICAgICBgYGAKCiAgICAgICAgQHByaXZhdGUKICAgICAgICBAbWV0aG9kIHR5cGVJbmplY3Rpb24KICAgICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBmdWxsTmFtZQogICAgICAqLwogICAgICB0eXBlSW5qZWN0aW9uOiBmdW5jdGlvbih0eXBlLCBwcm9wZXJ0eSwgZnVsbE5hbWUpIHsKICAgICAgICBpZiAodGhpcy5wYXJlbnQpIHsgaWxsZWdhbENoaWxkT3BlcmF0aW9uKCd0eXBlSW5qZWN0aW9uJyk7IH0KCiAgICAgICAgYWRkVHlwZUluamVjdGlvbih0aGlzLnR5cGVJbmplY3Rpb25zLCB0eXBlLCBwcm9wZXJ0eSwgZnVsbE5hbWUpOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAgRGVmaW5lcyBpbmplY3Rpb24gcnVsZXMuCgogICAgICAgIFRoZXNlIHJ1bGVzIGFyZSB1c2VkIHRvIGluamVjdCBkZXBlbmRlbmNpZXMgb250byBvYmplY3RzIHdoZW4gdGhleQogICAgICAgIGFyZSBpbnN0YW50aWF0ZWQuCgogICAgICAgIFR3byBmb3JtcyBvZiBpbmplY3Rpb25zIGFyZSBwb3NzaWJsZToKCiAgICAgICAgKiBJbmplY3Rpbmcgb25lIGZ1bGxOYW1lIG9uIGFub3RoZXIgZnVsbE5hbWUKICAgICAgICAqIEluamVjdGluZyBvbmUgZnVsbE5hbWUgb24gYSB0eXBlCgogICAgICAgIEV4YW1wbGU6CgogICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgICB2YXIgY29udGFpbmVyID0gbmV3IENvbnRhaW5lcigpOwoKICAgICAgICBjb250YWluZXIucmVnaXN0ZXIoJ3NvdXJjZTptYWluJywgU291cmNlKTsKICAgICAgICBjb250YWluZXIucmVnaXN0ZXIoJ21vZGVsOnVzZXInLCBVc2VyKTsKICAgICAgICBjb250YWluZXIucmVnaXN0ZXIoJ21vZGVsOnBvc3QnLCBQb3N0KTsKCiAgICAgICAgLy8gaW5qZWN0aW5nIG9uZSBmdWxsTmFtZSBvbiBhbm90aGVyIGZ1bGxOYW1lCiAgICAgICAgLy8gZWcuIGVhY2ggdXNlciBtb2RlbCBnZXRzIGEgcG9zdCBtb2RlbAogICAgICAgIGNvbnRhaW5lci5pbmplY3Rpb24oJ21vZGVsOnVzZXInLCAncG9zdCcsICdtb2RlbDpwb3N0Jyk7CgogICAgICAgIC8vIGluamVjdGluZyBvbmUgZnVsbE5hbWUgb24gYW5vdGhlciB0eXBlCiAgICAgICAgY29udGFpbmVyLmluamVjdGlvbignbW9kZWwnLCAnc291cmNlJywgJ3NvdXJjZTptYWluJyk7CgogICAgICAgIHZhciB1c2VyID0gY29udGFpbmVyLmxvb2t1cCgnbW9kZWw6dXNlcicpOwogICAgICAgIHZhciBwb3N0ID0gY29udGFpbmVyLmxvb2t1cCgnbW9kZWw6cG9zdCcpOwoKICAgICAgICB1c2VyLnNvdXJjZSBpbnN0YW5jZW9mIFNvdXJjZTsgLy89PiB0cnVlCiAgICAgICAgcG9zdC5zb3VyY2UgaW5zdGFuY2VvZiBTb3VyY2U7IC8vPT4gdHJ1ZQoKICAgICAgICB1c2VyLnBvc3QgaW5zdGFuY2VvZiBQb3N0OyAvLz0+IHRydWUKCiAgICAgICAgLy8gYW5kIGJvdGggbW9kZWxzIHNoYXJlIHRoZSBzYW1lIHNvdXJjZQogICAgICAgIHVzZXIuc291cmNlID09PSBwb3N0LnNvdXJjZTsgLy89PiB0cnVlCiAgICAgICAgYGBgCgogICAgICAgIEBtZXRob2QgaW5qZWN0aW9uCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGZhY3RvcnlOYW1lCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGluamVjdGlvbk5hbWUKICAgICAgKi8KICAgICAgaW5qZWN0aW9uOiBmdW5jdGlvbihmYWN0b3J5TmFtZSwgcHJvcGVydHksIGluamVjdGlvbk5hbWUpIHsKICAgICAgICBpZiAodGhpcy5wYXJlbnQpIHsgaWxsZWdhbENoaWxkT3BlcmF0aW9uKCdpbmplY3Rpb24nKTsgfQoKICAgICAgICBpZiAoZmFjdG9yeU5hbWUuaW5kZXhPZignOicpID09PSAtMSkgewogICAgICAgICAgcmV0dXJuIHRoaXMudHlwZUluamVjdGlvbihmYWN0b3J5TmFtZSwgcHJvcGVydHksIGluamVjdGlvbk5hbWUpOwogICAgICAgIH0KCiAgICAgICAgYWRkSW5qZWN0aW9uKHRoaXMuaW5qZWN0aW9ucywgZmFjdG9yeU5hbWUsIHByb3BlcnR5LCBpbmplY3Rpb25OYW1lKTsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICBVc2VkIG9ubHkgdmlhIGBmYWN0b3J5SW5qZWN0aW9uYC4KCiAgICAgICAgUHJvdmlkZXMgYSBzcGVjaWFsaXplZCBmb3JtIG9mIGluamVjdGlvbiwgc3BlY2lmaWNhbGx5IGVuYWJsaW5nCiAgICAgICAgYWxsIGZhY3Rvcnkgb2Ygb25lIHR5cGUgdG8gYmUgaW5qZWN0ZWQgd2l0aCBhIHJlZmVyZW5jZSB0byBhbm90aGVyCiAgICAgICAgb2JqZWN0LgoKICAgICAgICBGb3IgZXhhbXBsZSwgcHJvdmlkZWQgZWFjaCBmYWN0b3J5IG9mIHR5cGUgYG1vZGVsYCBuZWVkZWQgYSBgc3RvcmVgLgogICAgICAgIG9uZSB3b3VsZCBkbyB0aGUgZm9sbG93aW5nOgoKICAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgICAgdmFyIGNvbnRhaW5lciA9IG5ldyBDb250YWluZXIoKTsKCiAgICAgICAgY29udGFpbmVyLnJlZ2lzdGVyKCdzdG9yZTptYWluJywgU29tZVN0b3JlKTsKCiAgICAgICAgY29udGFpbmVyLmZhY3RvcnlUeXBlSW5qZWN0aW9uKCdtb2RlbCcsICdzdG9yZScsICdzdG9yZTptYWluJyk7CgogICAgICAgIHZhciBzdG9yZSA9IGNvbnRhaW5lci5sb29rdXAoJ3N0b3JlOm1haW4nKTsKICAgICAgICB2YXIgVXNlckZhY3RvcnkgPSBjb250YWluZXIubG9va3VwRmFjdG9yeSgnbW9kZWw6dXNlcicpOwoKICAgICAgICBVc2VyRmFjdG9yeS5zdG9yZSBpbnN0YW5jZW9mIFNvbWVTdG9yZTsgLy89PiB0cnVlCiAgICAgICAgYGBgCgogICAgICAgIEBwcml2YXRlCiAgICAgICAgQG1ldGhvZCBmYWN0b3J5VHlwZUluamVjdGlvbgogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGZ1bGxOYW1lCiAgICAgICovCiAgICAgIGZhY3RvcnlUeXBlSW5qZWN0aW9uOiBmdW5jdGlvbih0eXBlLCBwcm9wZXJ0eSwgZnVsbE5hbWUpIHsKICAgICAgICBpZiAodGhpcy5wYXJlbnQpIHsgaWxsZWdhbENoaWxkT3BlcmF0aW9uKCdmYWN0b3J5VHlwZUluamVjdGlvbicpOyB9CgogICAgICAgIGFkZFR5cGVJbmplY3Rpb24odGhpcy5mYWN0b3J5VHlwZUluamVjdGlvbnMsIHR5cGUsIHByb3BlcnR5LCBmdWxsTmFtZSk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICBEZWZpbmVzIGZhY3RvcnkgaW5qZWN0aW9uIHJ1bGVzLgoKICAgICAgICBTaW1pbGFyIHRvIHJlZ3VsYXIgaW5qZWN0aW9uIHJ1bGVzLCBidXQgYXJlIHJ1biBhZ2FpbnN0IGZhY3RvcmllcywgdmlhCiAgICAgICAgYENvbnRhaW5lciNsb29rdXBGYWN0b3J5YC4KCiAgICAgICAgVGhlc2UgcnVsZXMgYXJlIHVzZWQgdG8gaW5qZWN0IG9iamVjdHMgb250byBmYWN0b3JpZXMgd2hlbiB0aGV5CiAgICAgICAgYXJlIGxvb2tlZCB1cC4KCiAgICAgICAgVHdvIGZvcm1zIG9mIGluamVjdGlvbnMgYXJlIHBvc3NpYmxlOgoKICAgICAgKiBJbmplY3Rpbmcgb25lIGZ1bGxOYW1lIG9uIGFub3RoZXIgZnVsbE5hbWUKICAgICAgKiBJbmplY3Rpbmcgb25lIGZ1bGxOYW1lIG9uIGEgdHlwZQoKICAgICAgICBFeGFtcGxlOgoKICAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgICAgdmFyIGNvbnRhaW5lciA9IG5ldyBDb250YWluZXIoKTsKCiAgICAgICAgY29udGFpbmVyLnJlZ2lzdGVyKCdzdG9yZTptYWluJywgU3RvcmUpOwogICAgICAgIGNvbnRhaW5lci5yZWdpc3Rlcignc3RvcmU6c2Vjb25kYXJ5JywgT3RoZXJTdG9yZSk7CiAgICAgICAgY29udGFpbmVyLnJlZ2lzdGVyKCdtb2RlbDp1c2VyJywgVXNlcik7CiAgICAgICAgY29udGFpbmVyLnJlZ2lzdGVyKCdtb2RlbDpwb3N0JywgUG9zdCk7CgogICAgICAgIC8vIGluamVjdGluZyBvbmUgZnVsbE5hbWUgb24gYW5vdGhlciB0eXBlCiAgICAgICAgY29udGFpbmVyLmZhY3RvcnlJbmplY3Rpb24oJ21vZGVsJywgJ3N0b3JlJywgJ3N0b3JlOm1haW4nKTsKCiAgICAgICAgLy8gaW5qZWN0aW5nIG9uZSBmdWxsTmFtZSBvbiBhbm90aGVyIGZ1bGxOYW1lCiAgICAgICAgY29udGFpbmVyLmZhY3RvcnlJbmplY3Rpb24oJ21vZGVsOnBvc3QnLCAnc2Vjb25kYXJ5U3RvcmUnLCAnc3RvcmU6c2Vjb25kYXJ5Jyk7CgogICAgICAgIHZhciBVc2VyRmFjdG9yeSA9IGNvbnRhaW5lci5sb29rdXBGYWN0b3J5KCdtb2RlbDp1c2VyJyk7CiAgICAgICAgdmFyIFBvc3RGYWN0b3J5ID0gY29udGFpbmVyLmxvb2t1cEZhY3RvcnkoJ21vZGVsOnBvc3QnKTsKICAgICAgICB2YXIgc3RvcmUgPSBjb250YWluZXIubG9va3VwKCdzdG9yZTptYWluJyk7CgogICAgICAgIFVzZXJGYWN0b3J5LnN0b3JlIGluc3RhbmNlb2YgU3RvcmU7IC8vPT4gdHJ1ZQogICAgICAgIFVzZXJGYWN0b3J5LnNlY29uZGFyeVN0b3JlIGluc3RhbmNlb2YgT3RoZXJTdG9yZTsgLy89PiBmYWxzZQoKICAgICAgICBQb3N0RmFjdG9yeS5zdG9yZSBpbnN0YW5jZW9mIFN0b3JlOyAvLz0+IHRydWUKICAgICAgICBQb3N0RmFjdG9yeS5zZWNvbmRhcnlTdG9yZSBpbnN0YW5jZW9mIE90aGVyU3RvcmU7IC8vPT4gdHJ1ZQoKICAgICAgICAvLyBhbmQgYm90aCBtb2RlbHMgc2hhcmUgdGhlIHNhbWUgc291cmNlIGluc3RhbmNlCiAgICAgICAgVXNlckZhY3Rvcnkuc3RvcmUgPT09IFBvc3RGYWN0b3J5LnN0b3JlOyAvLz0+IHRydWUKICAgICAgICBgYGAKCiAgICAgICAgQG1ldGhvZCBmYWN0b3J5SW5qZWN0aW9uCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGZhY3RvcnlOYW1lCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGluamVjdGlvbk5hbWUKICAgICAgKi8KICAgICAgZmFjdG9yeUluamVjdGlvbjogZnVuY3Rpb24oZmFjdG9yeU5hbWUsIHByb3BlcnR5LCBpbmplY3Rpb25OYW1lKSB7CiAgICAgICAgaWYgKHRoaXMucGFyZW50KSB7IGlsbGVnYWxDaGlsZE9wZXJhdGlvbignaW5qZWN0aW9uJyk7IH0KCiAgICAgICAgaWYgKGZhY3RvcnlOYW1lLmluZGV4T2YoJzonKSA9PT0gLTEpIHsKICAgICAgICAgIHJldHVybiB0aGlzLmZhY3RvcnlUeXBlSW5qZWN0aW9uKGZhY3RvcnlOYW1lLCBwcm9wZXJ0eSwgaW5qZWN0aW9uTmFtZSk7CiAgICAgICAgfQoKICAgICAgICBhZGRJbmplY3Rpb24odGhpcy5mYWN0b3J5SW5qZWN0aW9ucywgZmFjdG9yeU5hbWUsIHByb3BlcnR5LCBpbmplY3Rpb25OYW1lKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgIEEgZGVwdGggZmlyc3QgdHJhdmVyc2FsLCBkZXN0cm95aW5nIHRoZSBjb250YWluZXIsIGl0cyBkZXNjZW5kYW50IGNvbnRhaW5lcnMgYW5kIGFsbAogICAgICAgIHRoZWlyIG1hbmFnZWQgb2JqZWN0cy4KCiAgICAgICAgQG1ldGhvZCBkZXN0cm95CiAgICAgICovCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewoKICAgICAgICBmb3IgKHZhciBpPTAsIGw9dGhpcy5jaGlsZHJlbi5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgICB0aGlzLmNoaWxkcmVuW2ldLmRlc3Ryb3koKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuY2hpbGRyZW4gPSBbXTsKCiAgICAgICAgZWFjaERlc3Ryb3lhYmxlKHRoaXMsIGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgIGl0ZW0uZGVzdHJveSgpOwogICAgICAgIH0pOwoKICAgICAgICB0aGlzLnBhcmVudCA9IHVuZGVmaW5lZDsKICAgICAgICB0aGlzLmlzRGVzdHJveWVkID0gdHJ1ZTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgIEBtZXRob2QgcmVzZXQKICAgICAgKi8KICAgICAgcmVzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIGk9MCwgbD10aGlzLmNoaWxkcmVuLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICAgIHJlc2V0Q2FjaGUodGhpcy5jaGlsZHJlbltpXSk7CiAgICAgICAgfQogICAgICAgIHJlc2V0Q2FjaGUodGhpcyk7CiAgICAgIH0KICAgIH07CgogICAgZnVuY3Rpb24gaWxsZWdhbENoaWxkT3BlcmF0aW9uKG9wZXJhdGlvbikgewogICAgICB0aHJvdyBuZXcgRXJyb3Iob3BlcmF0aW9uICsgIiBpcyBub3QgY3VycmVudGx5IHN1cHBvcnRlZCBvbiBjaGlsZCBjb250YWluZXJzIik7CiAgICB9CgogICAgZnVuY3Rpb24gaXNTaW5nbGV0b24oY29udGFpbmVyLCBmdWxsTmFtZSkgewogICAgICB2YXIgc2luZ2xldG9uID0gb3B0aW9uKGNvbnRhaW5lciwgZnVsbE5hbWUsICdzaW5nbGV0b24nKTsKCiAgICAgIHJldHVybiBzaW5nbGV0b24gIT09IGZhbHNlOwogICAgfQoKICAgIGZ1bmN0aW9uIGJ1aWxkSW5qZWN0aW9ucyhjb250YWluZXIsIGluamVjdGlvbnMpIHsKICAgICAgdmFyIGhhc2ggPSB7fTsKCiAgICAgIGlmICghaW5qZWN0aW9ucykgeyByZXR1cm4gaGFzaDsgfQoKICAgICAgdmFyIGluamVjdGlvbiwgbG9va3VwOwoKICAgICAgZm9yICh2YXIgaT0wLCBsPWluamVjdGlvbnMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIGluamVjdGlvbiA9IGluamVjdGlvbnNbaV07CiAgICAgICAgbG9va3VwID0gY29udGFpbmVyLmxvb2t1cChpbmplY3Rpb24uZnVsbE5hbWUpOwoKICAgICAgICBpZiAobG9va3VwICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGhhc2hbaW5qZWN0aW9uLnByb3BlcnR5XSA9IGxvb2t1cDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBdHRlbXB0aW5nIHRvIGluamVjdCBhbiB1bmtub3duIGluamVjdGlvbjogYCcgKyBpbmplY3Rpb24uZnVsbE5hbWUgKyAnYCcpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGhhc2g7CiAgICB9CgogICAgZnVuY3Rpb24gb3B0aW9uKGNvbnRhaW5lciwgZnVsbE5hbWUsIG9wdGlvbk5hbWUpIHsKICAgICAgdmFyIG9wdGlvbnMgPSBjb250YWluZXIuX29wdGlvbnMuZ2V0KGZ1bGxOYW1lKTsKCiAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnNbb3B0aW9uTmFtZV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiBvcHRpb25zW29wdGlvbk5hbWVdOwogICAgICB9CgogICAgICB2YXIgdHlwZSA9IGZ1bGxOYW1lLnNwbGl0KCI6IilbMF07CiAgICAgIG9wdGlvbnMgPSBjb250YWluZXIuX3R5cGVPcHRpb25zLmdldCh0eXBlKTsKCiAgICAgIGlmIChvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIG9wdGlvbnNbb3B0aW9uTmFtZV07CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBmYWN0b3J5Rm9yKGNvbnRhaW5lciwgZnVsbE5hbWUpIHsKICAgICAgdmFyIG5hbWUgPSBjb250YWluZXIubm9ybWFsaXplKGZ1bGxOYW1lKTsKICAgICAgdmFyIGZhY3RvcnkgPSBjb250YWluZXIucmVzb2x2ZShuYW1lKTsKICAgICAgdmFyIGluamVjdGVkRmFjdG9yeTsKICAgICAgdmFyIGNhY2hlID0gY29udGFpbmVyLmZhY3RvcnlDYWNoZTsKICAgICAgdmFyIHR5cGUgPSBmdWxsTmFtZS5zcGxpdCgiOiIpWzBdOwoKICAgICAgaWYgKGZhY3RvcnkgPT09IHVuZGVmaW5lZCkgeyByZXR1cm47IH0KCiAgICAgIGlmIChjYWNoZS5oYXMoZnVsbE5hbWUpKSB7CiAgICAgICAgcmV0dXJuIGNhY2hlLmdldChmdWxsTmFtZSk7CiAgICAgIH0KCiAgICAgIGlmICghZmFjdG9yeSB8fCB0eXBlb2YgZmFjdG9yeS5leHRlbmQgIT09ICdmdW5jdGlvbicgfHwgKCFFbWJlci5NT0RFTF9GQUNUT1JZX0lOSkVDVElPTlMgJiYgdHlwZSA9PT0gJ21vZGVsJykpIHsKICAgICAgICAvLyBUT0RPOiB0aGluayBhYm91dCBhICdzYWZlJyBtZXJnZSBzdHlsZSBleHRlbnNpb24KICAgICAgICAvLyBmb3Igbm93IGp1c3QgZmFsbGJhY2sgdG8gY3JlYXRlIHRpbWUgaW5qZWN0aW9uCiAgICAgICAgcmV0dXJuIGZhY3Rvcnk7CiAgICAgIH0gZWxzZSB7CgogICAgICAgIHZhciBpbmplY3Rpb25zICAgICAgICA9IGluamVjdGlvbnNGb3IoY29udGFpbmVyLCBmdWxsTmFtZSk7CiAgICAgICAgdmFyIGZhY3RvcnlJbmplY3Rpb25zID0gZmFjdG9yeUluamVjdGlvbnNGb3IoY29udGFpbmVyLCBmdWxsTmFtZSk7CgogICAgICAgIGZhY3RvcnlJbmplY3Rpb25zLl90b1N0cmluZyA9IGNvbnRhaW5lci5tYWtlVG9TdHJpbmcoZmFjdG9yeSwgZnVsbE5hbWUpOwoKICAgICAgICBpbmplY3RlZEZhY3RvcnkgPSBmYWN0b3J5LmV4dGVuZChpbmplY3Rpb25zKTsKICAgICAgICBpbmplY3RlZEZhY3RvcnkucmVvcGVuQ2xhc3MoZmFjdG9yeUluamVjdGlvbnMpOwoKICAgICAgICBjYWNoZS5zZXQoZnVsbE5hbWUsIGluamVjdGVkRmFjdG9yeSk7CgogICAgICAgIHJldHVybiBpbmplY3RlZEZhY3Rvcnk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpbmplY3Rpb25zRm9yKGNvbnRhaW5lciAsZnVsbE5hbWUpIHsKICAgICAgdmFyIHNwbGl0TmFtZSA9IGZ1bGxOYW1lLnNwbGl0KCI6IiksCiAgICAgICAgdHlwZSA9IHNwbGl0TmFtZVswXSwKICAgICAgICBpbmplY3Rpb25zID0gW107CgogICAgICBpbmplY3Rpb25zID0gaW5qZWN0aW9ucy5jb25jYXQoY29udGFpbmVyLnR5cGVJbmplY3Rpb25zLmdldCh0eXBlKSB8fCBbXSk7CiAgICAgIGluamVjdGlvbnMgPSBpbmplY3Rpb25zLmNvbmNhdChjb250YWluZXIuaW5qZWN0aW9uc1tmdWxsTmFtZV0gfHwgW10pOwoKICAgICAgaW5qZWN0aW9ucyA9IGJ1aWxkSW5qZWN0aW9ucyhjb250YWluZXIsIGluamVjdGlvbnMpOwogICAgICBpbmplY3Rpb25zLl9kZWJ1Z0NvbnRhaW5lcktleSA9IGZ1bGxOYW1lOwogICAgICBpbmplY3Rpb25zLmNvbnRhaW5lciA9IGNvbnRhaW5lcjsKCiAgICAgIHJldHVybiBpbmplY3Rpb25zOwogICAgfQoKICAgIGZ1bmN0aW9uIGZhY3RvcnlJbmplY3Rpb25zRm9yKGNvbnRhaW5lciwgZnVsbE5hbWUpIHsKICAgICAgdmFyIHNwbGl0TmFtZSA9IGZ1bGxOYW1lLnNwbGl0KCI6IiksCiAgICAgICAgdHlwZSA9IHNwbGl0TmFtZVswXSwKICAgICAgICBmYWN0b3J5SW5qZWN0aW9ucyA9IFtdOwoKICAgICAgZmFjdG9yeUluamVjdGlvbnMgPSBmYWN0b3J5SW5qZWN0aW9ucy5jb25jYXQoY29udGFpbmVyLmZhY3RvcnlUeXBlSW5qZWN0aW9ucy5nZXQodHlwZSkgfHwgW10pOwogICAgICBmYWN0b3J5SW5qZWN0aW9ucyA9IGZhY3RvcnlJbmplY3Rpb25zLmNvbmNhdChjb250YWluZXIuZmFjdG9yeUluamVjdGlvbnNbZnVsbE5hbWVdIHx8IFtdKTsKCiAgICAgIGZhY3RvcnlJbmplY3Rpb25zID0gYnVpbGRJbmplY3Rpb25zKGNvbnRhaW5lciwgZmFjdG9yeUluamVjdGlvbnMpOwogICAgICBmYWN0b3J5SW5qZWN0aW9ucy5fZGVidWdDb250YWluZXJLZXkgPSBmdWxsTmFtZTsKCiAgICAgIHJldHVybiBmYWN0b3J5SW5qZWN0aW9uczsKICAgIH0KCiAgICBmdW5jdGlvbiBpbnN0YW50aWF0ZShjb250YWluZXIsIGZ1bGxOYW1lKSB7CiAgICAgIHZhciBmYWN0b3J5ID0gZmFjdG9yeUZvcihjb250YWluZXIsIGZ1bGxOYW1lKTsKCiAgICAgIGlmIChvcHRpb24oY29udGFpbmVyLCBmdWxsTmFtZSwgJ2luc3RhbnRpYXRlJykgPT09IGZhbHNlKSB7CiAgICAgICAgcmV0dXJuIGZhY3Rvcnk7CiAgICAgIH0KCiAgICAgIGlmIChmYWN0b3J5KSB7CiAgICAgICAgaWYgKHR5cGVvZiBmYWN0b3J5LmV4dGVuZCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgLy8gYXNzdW1lIHRoZSBmYWN0b3J5IHdhcyBleHRlbmRhYmxlIGFuZCBpcyBhbHJlYWR5IGluamVjdGVkCiAgICAgICAgICByZXR1cm4gZmFjdG9yeS5jcmVhdGUoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gYXNzdW1lIHRoZSBmYWN0b3J5IHdhcyBleHRlbmRhYmxlCiAgICAgICAgICAvLyB0byBjcmVhdGUgdGltZSBpbmplY3Rpb25zCiAgICAgICAgICAvLyBUT0RPOiBzdXBwb3J0IG5ldydpbmcgZm9yIGluc3RhbnRpYXRpb24gYW5kIG1lcmdlIGluamVjdGlvbnMgZm9yIHB1cmUgSlMgRnVuY3Rpb25zCiAgICAgICAgICByZXR1cm4gZmFjdG9yeS5jcmVhdGUoaW5qZWN0aW9uc0Zvcihjb250YWluZXIsIGZ1bGxOYW1lKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZWFjaERlc3Ryb3lhYmxlKGNvbnRhaW5lciwgY2FsbGJhY2spIHsKICAgICAgY29udGFpbmVyLmNhY2hlLmVhY2hMb2NhbChmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgaWYgKG9wdGlvbihjb250YWluZXIsIGtleSwgJ2luc3RhbnRpYXRlJykgPT09IGZhbHNlKSB7IHJldHVybjsgfQogICAgICAgIGNhbGxiYWNrKHZhbHVlKTsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gcmVzZXRDYWNoZShjb250YWluZXIpIHsKICAgICAgY29udGFpbmVyLmNhY2hlLmVhY2hMb2NhbChmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgaWYgKG9wdGlvbihjb250YWluZXIsIGtleSwgJ2luc3RhbnRpYXRlJykgPT09IGZhbHNlKSB7IHJldHVybjsgfQogICAgICAgIHZhbHVlLmRlc3Ryb3koKTsKICAgICAgfSk7CiAgICAgIGNvbnRhaW5lci5jYWNoZS5kaWN0ID0ge307CiAgICB9CgogICAgZnVuY3Rpb24gYWRkVHlwZUluamVjdGlvbihydWxlcywgdHlwZSwgcHJvcGVydHksIGZ1bGxOYW1lKSB7CiAgICAgIHZhciBpbmplY3Rpb25zID0gcnVsZXMuZ2V0KHR5cGUpOwoKICAgICAgaWYgKCFpbmplY3Rpb25zKSB7CiAgICAgICAgaW5qZWN0aW9ucyA9IFtdOwogICAgICAgIHJ1bGVzLnNldCh0eXBlLCBpbmplY3Rpb25zKTsKICAgICAgfQoKICAgICAgaW5qZWN0aW9ucy5wdXNoKHsKICAgICAgICBwcm9wZXJ0eTogcHJvcGVydHksCiAgICAgICAgZnVsbE5hbWU6IGZ1bGxOYW1lCiAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGFkZEluamVjdGlvbihydWxlcywgZmFjdG9yeU5hbWUsIHByb3BlcnR5LCBpbmplY3Rpb25OYW1lKSB7CiAgICAgIHZhciBpbmplY3Rpb25zID0gcnVsZXNbZmFjdG9yeU5hbWVdID0gcnVsZXNbZmFjdG9yeU5hbWVdIHx8IFtdOwogICAgICBpbmplY3Rpb25zLnB1c2goeyBwcm9wZXJ0eTogcHJvcGVydHksIGZ1bGxOYW1lOiBpbmplY3Rpb25OYW1lIH0pOwogICAgfQoKICAgIHJldHVybiBDb250YWluZXI7Cn0pOwoKfSkoKTsKCihmdW5jdGlvbigpIHsKLypnbG9iYWxzIEVOViAqLwovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLXJ1bnRpbWUKKi8KCnZhciBpbmRleE9mID0gRW1iZXIuRW51bWVyYWJsZVV0aWxzLmluZGV4T2Y7CgovKioKIFRoaXMgd2lsbCBjb21wYXJlIHR3byBqYXZhc2NyaXB0IHZhbHVlcyBvZiBwb3NzaWJseSBkaWZmZXJlbnQgdHlwZXMuCiBJdCB3aWxsIHRlbGwgeW91IHdoaWNoIG9uZSBpcyBncmVhdGVyIHRoYW4gdGhlIG90aGVyIGJ5IHJldHVybmluZzoKCiAgLSAtMSBpZiB0aGUgZmlyc3QgaXMgc21hbGxlciB0aGFuIHRoZSBzZWNvbmQsCiAgLSAwIGlmIGJvdGggYXJlIGVxdWFsLAogIC0gMSBpZiB0aGUgZmlyc3QgaXMgZ3JlYXRlciB0aGFuIHRoZSBzZWNvbmQuCgogVGhlIG9yZGVyIGlzIGNhbGN1bGF0ZWQgYmFzZWQgb24gYEVtYmVyLk9SREVSX0RFRklOSVRJT05gLCBpZiB0eXBlcyBhcmUgZGlmZmVyZW50LgogSW4gY2FzZSB0aGV5IGhhdmUgdGhlIHNhbWUgdHlwZSBhbiBhcHByb3ByaWF0ZSBjb21wYXJpc29uIGZvciB0aGlzIHR5cGUgaXMgbWFkZS4KCiAgYGBgamF2YXNjcmlwdAogIEVtYmVyLmNvbXBhcmUoJ2hlbGxvJywgJ2hlbGxvJyk7ICAvLyAwCiAgRW1iZXIuY29tcGFyZSgnYWJjJywgJ2RmZycpOyAgICAgIC8vIC0xCiAgRW1iZXIuY29tcGFyZSgyLCAxKTsgICAgICAgICAgICAgIC8vIDEKICBgYGAKCiBAbWV0aG9kIGNvbXBhcmUKIEBmb3IgRW1iZXIKIEBwYXJhbSB7T2JqZWN0fSB2IEZpcnN0IHZhbHVlIHRvIGNvbXBhcmUKIEBwYXJhbSB7T2JqZWN0fSB3IFNlY29uZCB2YWx1ZSB0byBjb21wYXJlCiBAcmV0dXJuIHtOdW1iZXJ9IC0xIGlmIHYgPCB3LCAwIGlmIHYgPSB3IGFuZCAxIGlmIHYgPiB3LgoqLwpFbWJlci5jb21wYXJlID0gZnVuY3Rpb24gY29tcGFyZSh2LCB3KSB7CiAgaWYgKHYgPT09IHcpIHsgcmV0dXJuIDA7IH0KCiAgdmFyIHR5cGUxID0gRW1iZXIudHlwZU9mKHYpOwogIHZhciB0eXBlMiA9IEVtYmVyLnR5cGVPZih3KTsKCiAgdmFyIENvbXBhcmFibGUgPSBFbWJlci5Db21wYXJhYmxlOwogIGlmIChDb21wYXJhYmxlKSB7CiAgICBpZiAodHlwZTE9PT0naW5zdGFuY2UnICYmIENvbXBhcmFibGUuZGV0ZWN0KHYuY29uc3RydWN0b3IpKSB7CiAgICAgIHJldHVybiB2LmNvbnN0cnVjdG9yLmNvbXBhcmUodiwgdyk7CiAgICB9CgogICAgaWYgKHR5cGUyID09PSAnaW5zdGFuY2UnICYmIENvbXBhcmFibGUuZGV0ZWN0KHcuY29uc3RydWN0b3IpKSB7CiAgICAgIHJldHVybiAxLXcuY29uc3RydWN0b3IuY29tcGFyZSh3LCB2KTsKICAgIH0KICB9CgogIC8vIElmIHdlIGhhdmVuJ3QgeWV0IGdlbmVyYXRlZCBhIHJldmVyc2UtbWFwcGluZyBvZiBFbWJlci5PUkRFUl9ERUZJTklUSU9OLAogIC8vIGRvIHNvIG5vdy4KICB2YXIgbWFwcGluZyA9IEVtYmVyLk9SREVSX0RFRklOSVRJT05fTUFQUElORzsKICBpZiAoIW1hcHBpbmcpIHsKICAgIHZhciBvcmRlciA9IEVtYmVyLk9SREVSX0RFRklOSVRJT047CiAgICBtYXBwaW5nID0gRW1iZXIuT1JERVJfREVGSU5JVElPTl9NQVBQSU5HID0ge307CiAgICB2YXIgaWR4LCBsZW47CiAgICBmb3IgKGlkeCA9IDAsIGxlbiA9IG9yZGVyLmxlbmd0aDsgaWR4IDwgbGVuOyAgKytpZHgpIHsKICAgICAgbWFwcGluZ1tvcmRlcltpZHhdXSA9IGlkeDsKICAgIH0KCiAgICAvLyBXZSBubyBsb25nZXIgbmVlZCBFbWJlci5PUkRFUl9ERUZJTklUSU9OLgogICAgZGVsZXRlIEVtYmVyLk9SREVSX0RFRklOSVRJT047CiAgfQoKICB2YXIgdHlwZTFJbmRleCA9IG1hcHBpbmdbdHlwZTFdOwogIHZhciB0eXBlMkluZGV4ID0gbWFwcGluZ1t0eXBlMl07CgogIGlmICh0eXBlMUluZGV4IDwgdHlwZTJJbmRleCkgeyByZXR1cm4gLTE7IH0KICBpZiAodHlwZTFJbmRleCA+IHR5cGUySW5kZXgpIHsgcmV0dXJuIDE7IH0KCiAgLy8gdHlwZXMgYXJlIGVxdWFsIC0gc28gd2UgaGF2ZSB0byBjaGVjayB2YWx1ZXMgbm93CiAgc3dpdGNoICh0eXBlMSkgewogICAgY2FzZSAnYm9vbGVhbic6CiAgICBjYXNlICdudW1iZXInOgogICAgICBpZiAodiA8IHcpIHsgcmV0dXJuIC0xOyB9CiAgICAgIGlmICh2ID4gdykgeyByZXR1cm4gMTsgfQogICAgICByZXR1cm4gMDsKCiAgICBjYXNlICdzdHJpbmcnOgogICAgICB2YXIgY29tcCA9IHYubG9jYWxlQ29tcGFyZSh3KTsKICAgICAgaWYgKGNvbXAgPCAwKSB7IHJldHVybiAtMTsgfQogICAgICBpZiAoY29tcCA+IDApIHsgcmV0dXJuIDE7IH0KICAgICAgcmV0dXJuIDA7CgogICAgY2FzZSAnYXJyYXknOgogICAgICB2YXIgdkxlbiA9IHYubGVuZ3RoOwogICAgICB2YXIgd0xlbiA9IHcubGVuZ3RoOwogICAgICB2YXIgbCA9IE1hdGgubWluKHZMZW4sIHdMZW4pOwogICAgICB2YXIgciA9IDA7CiAgICAgIHZhciBpID0gMDsKICAgICAgd2hpbGUgKHIgPT09IDAgJiYgaSA8IGwpIHsKICAgICAgICByID0gY29tcGFyZSh2W2ldLHdbaV0pOwogICAgICAgIGkrKzsKICAgICAgfQogICAgICBpZiAociAhPT0gMCkgeyByZXR1cm4gcjsgfQoKICAgICAgLy8gYWxsIGVsZW1lbnRzIGFyZSBlcXVhbCBub3cKICAgICAgLy8gc2hvcnRlciBhcnJheSBzaG91bGQgYmUgb3JkZXJlZCBmaXJzdAogICAgICBpZiAodkxlbiA8IHdMZW4pIHsgcmV0dXJuIC0xOyB9CiAgICAgIGlmICh2TGVuID4gd0xlbikgeyByZXR1cm4gMTsgfQogICAgICAvLyBhcnJheXMgYXJlIGVxdWFsIG5vdwogICAgICByZXR1cm4gMDsKCiAgICBjYXNlICdpbnN0YW5jZSc6CiAgICAgIGlmIChFbWJlci5Db21wYXJhYmxlICYmIEVtYmVyLkNvbXBhcmFibGUuZGV0ZWN0KHYpKSB7CiAgICAgICAgcmV0dXJuIHYuY29tcGFyZSh2LCB3KTsKICAgICAgfQogICAgICByZXR1cm4gMDsKCiAgICBjYXNlICdkYXRlJzoKICAgICAgdmFyIHZOdW0gPSB2LmdldFRpbWUoKTsKICAgICAgdmFyIHdOdW0gPSB3LmdldFRpbWUoKTsKICAgICAgaWYgKHZOdW0gPCB3TnVtKSB7IHJldHVybiAtMTsgfQogICAgICBpZiAodk51bSA+IHdOdW0pIHsgcmV0dXJuIDE7IH0KICAgICAgcmV0dXJuIDA7CgogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIDA7CiAgfQp9OwoKZnVuY3Rpb24gX2NvcHkob2JqLCBkZWVwLCBzZWVuLCBjb3BpZXMpIHsKICB2YXIgcmV0LCBsb2MsIGtleTsKCiAgLy8gcHJpbWl0aXZlIGRhdGEgdHlwZXMgYXJlIGltbXV0YWJsZSwganVzdCByZXR1cm4gdGhlbS4KICBpZiAoJ29iamVjdCcgIT09IHR5cGVvZiBvYmogfHwgb2JqPT09bnVsbCkgcmV0dXJuIG9iajsKCiAgLy8gYXZvaWQgY3ljbGljYWwgbG9vcHMKICBpZiAoZGVlcCAmJiAobG9jPWluZGV4T2Yoc2Vlbiwgb2JqKSk+PTApIHJldHVybiBjb3BpZXNbbG9jXTsKCiAgRW1iZXIuYXNzZXJ0KCdDYW5ub3QgY2xvbmUgYW4gRW1iZXIuT2JqZWN0IHRoYXQgZG9lcyBub3QgaW1wbGVtZW50IEVtYmVyLkNvcHlhYmxlJywgIShvYmogaW5zdGFuY2VvZiBFbWJlci5PYmplY3QpIHx8IChFbWJlci5Db3B5YWJsZSAmJiBFbWJlci5Db3B5YWJsZS5kZXRlY3Qob2JqKSkpOwoKICAvLyBJTVBPUlRBTlQ6IHRoaXMgc3BlY2lmaWMgdGVzdCB3aWxsIGRldGVjdCBhIG5hdGl2ZSBhcnJheSBvbmx5LiBBbnkgb3RoZXIKICAvLyBvYmplY3Qgd2lsbCBuZWVkIHRvIGltcGxlbWVudCBDb3B5YWJsZS4KICBpZiAoRW1iZXIudHlwZU9mKG9iaikgPT09ICdhcnJheScpIHsKICAgIHJldCA9IG9iai5zbGljZSgpOwogICAgaWYgKGRlZXApIHsKICAgICAgbG9jID0gcmV0Lmxlbmd0aDsKICAgICAgd2hpbGUoLS1sb2M+PTApIHJldFtsb2NdID0gX2NvcHkocmV0W2xvY10sIGRlZXAsIHNlZW4sIGNvcGllcyk7CiAgICB9CiAgfSBlbHNlIGlmIChFbWJlci5Db3B5YWJsZSAmJiBFbWJlci5Db3B5YWJsZS5kZXRlY3Qob2JqKSkgewogICAgcmV0ID0gb2JqLmNvcHkoZGVlcCwgc2VlbiwgY29waWVzKTsKICB9IGVsc2UgewogICAgcmV0ID0ge307CiAgICBmb3Ioa2V5IGluIG9iaikgewogICAgICBpZiAoIW9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSBjb250aW51ZTsKCiAgICAgIC8vIFByZXZlbnRzIGJyb3dzZXJzIHRoYXQgZG9uJ3QgcmVzcGVjdCBub24tZW51bWVyYWJpbGl0eSBmcm9tCiAgICAgIC8vIGNvcHlpbmcgaW50ZXJuYWwgRW1iZXIgcHJvcGVydGllcwogICAgICBpZiAoa2V5LnN1YnN0cmluZygwLDIpID09PSAnX18nKSBjb250aW51ZTsKCiAgICAgIHJldFtrZXldID0gZGVlcCA/IF9jb3B5KG9ialtrZXldLCBkZWVwLCBzZWVuLCBjb3BpZXMpIDogb2JqW2tleV07CiAgICB9CiAgfQoKICBpZiAoZGVlcCkgewogICAgc2Vlbi5wdXNoKG9iaik7CiAgICBjb3BpZXMucHVzaChyZXQpOwogIH0KCiAgcmV0dXJuIHJldDsKfQoKLyoqCiAgQ3JlYXRlcyBhIGNsb25lIG9mIHRoZSBwYXNzZWQgb2JqZWN0LiBUaGlzIGZ1bmN0aW9uIGNhbiB0YWtlIGp1c3QgYWJvdXQKICBhbnkgdHlwZSBvZiBvYmplY3QgYW5kIGNyZWF0ZSBhIGNsb25lIG9mIGl0LCBpbmNsdWRpbmcgcHJpbWl0aXZlIHZhbHVlcwogICh3aGljaCBhcmUgbm90IGFjdHVhbGx5IGNsb25lZCBiZWNhdXNlIHRoZXkgYXJlIGltbXV0YWJsZSkuCgogIElmIHRoZSBwYXNzZWQgb2JqZWN0IGltcGxlbWVudHMgdGhlIGBjbG9uZSgpYCBtZXRob2QsIHRoZW4gdGhpcyBmdW5jdGlvbgogIHdpbGwgc2ltcGx5IGNhbGwgdGhhdCBtZXRob2QgYW5kIHJldHVybiB0aGUgcmVzdWx0LgoKICBAbWV0aG9kIGNvcHkKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtPYmplY3R9IG9iaiBUaGUgb2JqZWN0IHRvIGNsb25lCiAgQHBhcmFtIHtCb29sZWFufSBkZWVwIElmIHRydWUsIGEgZGVlcCBjb3B5IG9mIHRoZSBvYmplY3QgaXMgbWFkZQogIEByZXR1cm4ge09iamVjdH0gVGhlIGNsb25lZCBvYmplY3QKKi8KRW1iZXIuY29weSA9IGZ1bmN0aW9uKG9iaiwgZGVlcCkgewogIC8vIGZhc3QgcGF0aHMKICBpZiAoJ29iamVjdCcgIT09IHR5cGVvZiBvYmogfHwgb2JqPT09bnVsbCkgcmV0dXJuIG9iajsgLy8gY2FuJ3QgY29weSBwcmltaXRpdmVzCiAgaWYgKEVtYmVyLkNvcHlhYmxlICYmIEVtYmVyLkNvcHlhYmxlLmRldGVjdChvYmopKSByZXR1cm4gb2JqLmNvcHkoZGVlcCk7CiAgcmV0dXJuIF9jb3B5KG9iaiwgZGVlcCwgZGVlcCA/IFtdIDogbnVsbCwgZGVlcCA/IFtdIDogbnVsbCk7Cn07CgovKioKICBDb252ZW5pZW5jZSBtZXRob2QgdG8gaW5zcGVjdCBhbiBvYmplY3QuIFRoaXMgbWV0aG9kIHdpbGwgYXR0ZW1wdCB0bwogIGNvbnZlcnQgdGhlIG9iamVjdCBpbnRvIGEgdXNlZnVsIHN0cmluZyBkZXNjcmlwdGlvbi4KCiAgSXQgaXMgYSBwcmV0dHkgc2ltcGxlIGltcGxlbWVudGF0aW9uLiBJZiB5b3Ugd2FudCBzb21ldGhpbmcgbW9yZSByb2J1c3QsCiAgdXNlIHNvbWV0aGluZyBsaWtlIEpTRHVtcDogaHR0cHM6Ly9naXRodWIuY29tL05WL2pzRHVtcAoKICBAbWV0aG9kIGluc3BlY3QKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtPYmplY3R9IG9iaiBUaGUgb2JqZWN0IHlvdSB3YW50IHRvIGluc3BlY3QuCiAgQHJldHVybiB7U3RyaW5nfSBBIGRlc2NyaXB0aW9uIG9mIHRoZSBvYmplY3QKKi8KRW1iZXIuaW5zcGVjdCA9IGZ1bmN0aW9uKG9iaikgewogIHZhciB0eXBlID0gRW1iZXIudHlwZU9mKG9iaik7CiAgaWYgKHR5cGUgPT09ICdhcnJheScpIHsKICAgIHJldHVybiAnWycgKyBvYmogKyAnXSc7CiAgfQogIGlmICh0eXBlICE9PSAnb2JqZWN0JykgewogICAgcmV0dXJuIG9iaiArICcnOwogIH0KCiAgdmFyIHYsIHJldCA9IFtdOwogIGZvcih2YXIga2V5IGluIG9iaikgewogICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgIHYgPSBvYmpba2V5XTsKICAgICAgaWYgKHYgPT09ICd0b1N0cmluZycpIHsgY29udGludWU7IH0gLy8gaWdub3JlIHVzZWxlc3MgaXRlbXMKICAgICAgaWYgKEVtYmVyLnR5cGVPZih2KSA9PT0gJ2Z1bmN0aW9uJykgeyB2ID0gImZ1bmN0aW9uKCkgeyAuLi4gfSI7IH0KICAgICAgcmV0LnB1c2goa2V5ICsgIjogIiArIHYpOwogICAgfQogIH0KICByZXR1cm4gInsiICsgcmV0LmpvaW4oIiwgIikgKyAifSI7Cn07CgovKioKICBDb21wYXJlcyB0d28gb2JqZWN0cywgcmV0dXJuaW5nIHRydWUgaWYgdGhleSBhcmUgbG9naWNhbGx5IGVxdWFsLiBUaGlzIGlzCiAgYSBkZWVwZXIgY29tcGFyaXNvbiB0aGFuIGEgc2ltcGxlIHRyaXBsZSBlcXVhbC4gRm9yIHNldHMgaXQgd2lsbCBjb21wYXJlIHRoZQogIGludGVybmFsIG9iamVjdHMuIEZvciBhbnkgb3RoZXIgb2JqZWN0IHRoYXQgaW1wbGVtZW50cyBgaXNFcXVhbCgpYCBpdCB3aWxsCiAgcmVzcGVjdCB0aGF0IG1ldGhvZC4KCiAgYGBgamF2YXNjcmlwdAogIEVtYmVyLmlzRXF1YWwoJ2hlbGxvJywgJ2hlbGxvJyk7ICAvLyB0cnVlCiAgRW1iZXIuaXNFcXVhbCgxLCAyKTsgICAgICAgICAgICAgIC8vIGZhbHNlCiAgRW1iZXIuaXNFcXVhbChbNCwyXSwgWzQsMl0pOyAgICAgIC8vIGZhbHNlCiAgYGBgCgogIEBtZXRob2QgaXNFcXVhbAogIEBmb3IgRW1iZXIKICBAcGFyYW0ge09iamVjdH0gYSBmaXJzdCBvYmplY3QgdG8gY29tcGFyZQogIEBwYXJhbSB7T2JqZWN0fSBiIHNlY29uZCBvYmplY3QgdG8gY29tcGFyZQogIEByZXR1cm4ge0Jvb2xlYW59CiovCkVtYmVyLmlzRXF1YWwgPSBmdW5jdGlvbihhLCBiKSB7CiAgaWYgKGEgJiYgJ2Z1bmN0aW9uJz09PXR5cGVvZiBhLmlzRXF1YWwpIHJldHVybiBhLmlzRXF1YWwoYik7CiAgcmV0dXJuIGEgPT09IGI7Cn07CgovLyBVc2VkIGJ5IEVtYmVyLmNvbXBhcmUKRW1iZXIuT1JERVJfREVGSU5JVElPTiA9IEVtYmVyLkVOVi5PUkRFUl9ERUZJTklUSU9OIHx8IFsKICAndW5kZWZpbmVkJywKICAnbnVsbCcsCiAgJ2Jvb2xlYW4nLAogICdudW1iZXInLAogICdzdHJpbmcnLAogICdhcnJheScsCiAgJ29iamVjdCcsCiAgJ2luc3RhbmNlJywKICAnZnVuY3Rpb24nLAogICdjbGFzcycsCiAgJ2RhdGUnCl07CgovKioKICBSZXR1cm5zIGFsbCBvZiB0aGUga2V5cyBkZWZpbmVkIG9uIGFuIG9iamVjdCBvciBoYXNoLiBUaGlzIGlzIHVzZWZ1bAogIHdoZW4gaW5zcGVjdGluZyBvYmplY3RzIGZvciBkZWJ1Z2dpbmcuIE9uIGJyb3dzZXJzIHRoYXQgc3VwcG9ydCBpdCwgdGhpcwogIHVzZXMgdGhlIG5hdGl2ZSBgT2JqZWN0LmtleXNgIGltcGxlbWVudGF0aW9uLgoKICBAbWV0aG9kIGtleXMKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtPYmplY3R9IG9iagogIEByZXR1cm4ge0FycmF5fSBBcnJheSBjb250YWluaW5nIGtleXMgb2Ygb2JqCiovCkVtYmVyLmtleXMgPSBPYmplY3Qua2V5czsKCmlmICghRW1iZXIua2V5cyB8fCBFbWJlci5jcmVhdGUuaXNTaW11bGF0ZWQpIHsKICB2YXIgcHJvdG90eXBlUHJvcGVydGllcyA9IFsKICAgICdjb25zdHJ1Y3RvcicsCiAgICAnaGFzT3duUHJvcGVydHknLAogICAgJ2lzUHJvdG90eXBlT2YnLAogICAgJ3Byb3BlcnR5SXNFbnVtZXJhYmxlJywKICAgICd2YWx1ZU9mJywKICAgICd0b0xvY2FsZVN0cmluZycsCiAgICAndG9TdHJpbmcnCiAgXSwKICBwdXNoUHJvcGVydHlOYW1lID0gZnVuY3Rpb24ob2JqLCBhcnJheSwga2V5KSB7CiAgICAvLyBQcmV2ZW50cyBicm93c2VycyB0aGF0IGRvbid0IHJlc3BlY3Qgbm9uLWVudW1lcmFiaWxpdHkgZnJvbQogICAgLy8gY29weWluZyBpbnRlcm5hbCBFbWJlciBwcm9wZXJ0aWVzCiAgICBpZiAoa2V5LnN1YnN0cmluZygwLDIpID09PSAnX18nKSByZXR1cm47CiAgICBpZiAoa2V5ID09PSAnX3N1cGVyJykgcmV0dXJuOwogICAgaWYgKGluZGV4T2YoYXJyYXksIGtleSkgPj0gMCkgcmV0dXJuOwogICAgaWYgKCFvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgcmV0dXJuOwoKICAgIGFycmF5LnB1c2goa2V5KTsKICB9OwoKICBFbWJlci5rZXlzID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgcmV0ID0gW10sIGtleTsKICAgIGZvciAoa2V5IGluIG9iaikgewogICAgICBwdXNoUHJvcGVydHlOYW1lKG9iaiwgcmV0LCBrZXkpOwogICAgfQoKICAgIC8vIElFOCBkb2Vzbid0IGVudW1lcmF0ZSBwcm9wZXJ0eSB0aGF0IG5hbWVkIHRoZSBzYW1lIGFzIHByb3RvdHlwZSBwcm9wZXJ0aWVzLgogICAgZm9yICh2YXIgaSA9IDAsIGwgPSBwcm90b3R5cGVQcm9wZXJ0aWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICBrZXkgPSBwcm90b3R5cGVQcm9wZXJ0aWVzW2ldOwoKICAgICAgcHVzaFByb3BlcnR5TmFtZShvYmosIHJldCwga2V5KTsKICAgIH0KCiAgICByZXR1cm4gcmV0OwogIH07Cn0KCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1ydW50aW1lCiovCgp2YXIgU1RSSU5HX0RBU0hFUklaRV9SRUdFWFAgPSAoL1sgX10vZyk7CnZhciBTVFJJTkdfREFTSEVSSVpFX0NBQ0hFID0ge307CnZhciBTVFJJTkdfREVDQU1FTElaRV9SRUdFWFAgPSAoLyhbYS16XGRdKShbQS1aXSkvZyk7CnZhciBTVFJJTkdfQ0FNRUxJWkVfUkVHRVhQID0gKC8oXC18X3xcLnxccykrKC4pPy9nKTsKdmFyIFNUUklOR19VTkRFUlNDT1JFX1JFR0VYUF8xID0gKC8oW2EtelxkXSkoW0EtWl0rKS9nKTsKdmFyIFNUUklOR19VTkRFUlNDT1JFX1JFR0VYUF8yID0gKC9cLXxccysvZyk7CgovKioKICBEZWZpbmVzIHRoZSBoYXNoIG9mIGxvY2FsaXplZCBzdHJpbmdzIGZvciB0aGUgY3VycmVudCBsYW5ndWFnZS4gVXNlZCBieQogIHRoZSBgRW1iZXIuU3RyaW5nLmxvYygpYCBoZWxwZXIuIFRvIGxvY2FsaXplLCBhZGQgc3RyaW5nIHZhbHVlcyB0byB0aGlzCiAgaGFzaC4KCiAgQHByb3BlcnR5IFNUUklOR1MKICBAZm9yIEVtYmVyCiAgQHR5cGUgSGFzaAoqLwpFbWJlci5TVFJJTkdTID0ge307CgovKioKICBEZWZpbmVzIHN0cmluZyBoZWxwZXIgbWV0aG9kcyBpbmNsdWRpbmcgc3RyaW5nIGZvcm1hdHRpbmcgYW5kIGxvY2FsaXphdGlvbi4KICBVbmxlc3MgYEVtYmVyLkVYVEVORF9QUk9UT1RZUEVTLlN0cmluZ2AgaXMgYGZhbHNlYCB0aGVzZSBtZXRob2RzIHdpbGwgYWxzbyBiZQogIGFkZGVkIHRvIHRoZSBgU3RyaW5nLnByb3RvdHlwZWAgYXMgd2VsbC4KCiAgQGNsYXNzIFN0cmluZwogIEBuYW1lc3BhY2UgRW1iZXIKICBAc3RhdGljCiovCkVtYmVyLlN0cmluZyA9IHsKCiAgLyoqCiAgICBBcHBseSBmb3JtYXR0aW5nIG9wdGlvbnMgdG8gdGhlIHN0cmluZy4gVGhpcyB3aWxsIGxvb2sgZm9yIG9jY3VycmVuY2VzCiAgICBvZiAiJUAiIGluIHlvdXIgc3RyaW5nIGFuZCBzdWJzdGl0dXRlIHRoZW0gd2l0aCB0aGUgYXJndW1lbnRzIHlvdSBwYXNzIGludG8KICAgIHRoaXMgbWV0aG9kLiBJZiB5b3Ugd2FudCB0byBjb250cm9sIHRoZSBzcGVjaWZpYyBvcmRlciBvZiByZXBsYWNlbWVudCwKICAgIHlvdSBjYW4gYWRkIGEgbnVtYmVyIGFmdGVyIHRoZSBrZXkgYXMgd2VsbCB0byBpbmRpY2F0ZSB3aGljaCBhcmd1bWVudAogICAgeW91IHdhbnQgdG8gaW5zZXJ0LgoKICAgIE9yZGVyZWQgaW5zZXJ0aW9ucyBhcmUgbW9zdCB1c2VmdWwgd2hlbiBidWlsZGluZyBsb2Mgc3RyaW5ncyB3aGVyZSB2YWx1ZXMKICAgIHlvdSBuZWVkIHRvIGluc2VydCBtYXkgYXBwZWFyIGluIGRpZmZlcmVudCBvcmRlcnMuCgogICAgYGBgamF2YXNjcmlwdAogICAgIkhlbGxvICVAICVAIi5mbXQoJ0pvaG4nLCAnRG9lJyk7ICAgICAvLyAiSGVsbG8gSm9obiBEb2UiCiAgICAiSGVsbG8gJUAyLCAlQDEiLmZtdCgnSm9obicsICdEb2UnKTsgIC8vICJIZWxsbyBEb2UsIEpvaG4iCiAgICBgYGAKCiAgICBAbWV0aG9kIGZtdAogICAgQHBhcmFtIHtTdHJpbmd9IHN0ciBUaGUgc3RyaW5nIHRvIGZvcm1hdAogICAgQHBhcmFtIHtBcnJheX0gZm9ybWF0cyBBbiBhcnJheSBvZiBwYXJhbWV0ZXJzIHRvIGludGVycG9sYXRlIGludG8gc3RyaW5nLgogICAgQHJldHVybiB7U3RyaW5nfSBmb3JtYXR0ZWQgc3RyaW5nCiAgKi8KICBmbXQ6IGZ1bmN0aW9uKHN0ciwgZm9ybWF0cykgewogICAgLy8gZmlyc3QsIHJlcGxhY2UgYW55IE9SREVSRUQgcmVwbGFjZW1lbnRzLgogICAgdmFyIGlkeCAgPSAwOyAvLyB0aGUgY3VycmVudCBpbmRleCBmb3Igbm9uLW51bWVyaWNhbCByZXBsYWNlbWVudHMKICAgIHJldHVybiBzdHIucmVwbGFjZSgvJUAoWzAtOV0rKT8vZywgZnVuY3Rpb24ocywgYXJnSW5kZXgpIHsKICAgICAgYXJnSW5kZXggPSAoYXJnSW5kZXgpID8gcGFyc2VJbnQoYXJnSW5kZXgsIDEwKSAtIDEgOiBpZHgrKzsKICAgICAgcyA9IGZvcm1hdHNbYXJnSW5kZXhdOwogICAgICByZXR1cm4gKHMgPT09IG51bGwpID8gJyhudWxsKScgOiAocyA9PT0gdW5kZWZpbmVkKSA/ICcnIDogRW1iZXIuaW5zcGVjdChzKTsKICAgIH0pIDsKICB9LAoKICAvKioKICAgIEZvcm1hdHMgdGhlIHBhc3NlZCBzdHJpbmcsIGJ1dCBmaXJzdCBsb29rcyB1cCB0aGUgc3RyaW5nIGluIHRoZSBsb2NhbGl6ZWQKICAgIHN0cmluZ3MgaGFzaC4gVGhpcyBpcyBhIGNvbnZlbmllbnQgd2F5IHRvIGxvY2FsaXplIHRleHQuIFNlZQogICAgYEVtYmVyLlN0cmluZy5mbXQoKWAgZm9yIG1vcmUgaW5mb3JtYXRpb24gb24gZm9ybWF0dGluZy4KCiAgICBOb3RlIHRoYXQgaXQgaXMgdHJhZGl0aW9uYWwgYnV0IG5vdCByZXF1aXJlZCB0byBwcmVmaXggbG9jYWxpemVkIHN0cmluZwogICAga2V5cyB3aXRoIGFuIHVuZGVyc2NvcmUgb3Igb3RoZXIgY2hhcmFjdGVyIHNvIHlvdSBjYW4gZWFzaWx5IGlkZW50aWZ5CiAgICBsb2NhbGl6ZWQgc3RyaW5ncy4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICBFbWJlci5TVFJJTkdTID0gewogICAgICAnX0hlbGxvIFdvcmxkJzogJ0JvbmpvdXIgbGUgbW9uZGUnLAogICAgICAnX0hlbGxvICVAICVAJzogJ0JvbmpvdXIgJUAgJUAnCiAgICB9OwoKICAgIEVtYmVyLlN0cmluZy5sb2MoIl9IZWxsbyBXb3JsZCIpOyAgLy8gJ0JvbmpvdXIgbGUgbW9uZGUnOwogICAgRW1iZXIuU3RyaW5nLmxvYygiX0hlbGxvICVAICVAIiwgWyJKb2huIiwgIlNtaXRoIl0pOyAgLy8gIkJvbmpvdXIgSm9obiBTbWl0aCI7CiAgICBgYGAKCiAgICBAbWV0aG9kIGxvYwogICAgQHBhcmFtIHtTdHJpbmd9IHN0ciBUaGUgc3RyaW5nIHRvIGZvcm1hdAogICAgQHBhcmFtIHtBcnJheX0gZm9ybWF0cyBPcHRpb25hbCBhcnJheSBvZiBwYXJhbWV0ZXJzIHRvIGludGVycG9sYXRlIGludG8gc3RyaW5nLgogICAgQHJldHVybiB7U3RyaW5nfSBmb3JtYXR0ZWQgc3RyaW5nCiAgKi8KICBsb2M6IGZ1bmN0aW9uKHN0ciwgZm9ybWF0cykgewogICAgc3RyID0gRW1iZXIuU1RSSU5HU1tzdHJdIHx8IHN0cjsKICAgIHJldHVybiBFbWJlci5TdHJpbmcuZm10KHN0ciwgZm9ybWF0cykgOwogIH0sCgogIC8qKgogICAgU3BsaXRzIGEgc3RyaW5nIGludG8gc2VwYXJhdGUgdW5pdHMgc2VwYXJhdGVkIGJ5IHNwYWNlcywgZWxpbWluYXRpbmcgYW55CiAgICBlbXB0eSBzdHJpbmdzIGluIHRoZSBwcm9jZXNzLiBUaGlzIGlzIGEgY29udmVuaWVuY2UgbWV0aG9kIGZvciBzcGxpdCB0aGF0CiAgICBpcyBtb3N0bHkgdXNlZnVsIHdoZW4gYXBwbGllZCB0byB0aGUgYFN0cmluZy5wcm90b3R5cGVgLgoKICAgIGBgYGphdmFzY3JpcHQKICAgIEVtYmVyLlN0cmluZy53KCJhbHBoYSBiZXRhIGdhbW1hIikuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKICAgICAgY29uc29sZS5sb2coa2V5KTsKICAgIH0pOwoKICAgIC8vID4gYWxwaGEKICAgIC8vID4gYmV0YQogICAgLy8gPiBnYW1tYQogICAgYGBgCgogICAgQG1ldGhvZCB3CiAgICBAcGFyYW0ge1N0cmluZ30gc3RyIFRoZSBzdHJpbmcgdG8gc3BsaXQKICAgIEByZXR1cm4ge1N0cmluZ30gc3BsaXQgc3RyaW5nCiAgKi8KICB3OiBmdW5jdGlvbihzdHIpIHsgcmV0dXJuIHN0ci5zcGxpdCgvXHMrLyk7IH0sCgogIC8qKgogICAgQ29udmVydHMgYSBjYW1lbGl6ZWQgc3RyaW5nIGludG8gYWxsIGxvd2VyIGNhc2Ugc2VwYXJhdGVkIGJ5IHVuZGVyc2NvcmVzLgoKICAgIGBgYGphdmFzY3JpcHQKICAgICdpbm5lckhUTUwnLmRlY2FtZWxpemUoKTsgICAgICAgICAgIC8vICdpbm5lcl9odG1sJwogICAgJ2FjdGlvbl9uYW1lJy5kZWNhbWVsaXplKCk7ICAgICAgICAvLyAnYWN0aW9uX25hbWUnCiAgICAnY3NzLWNsYXNzLW5hbWUnLmRlY2FtZWxpemUoKTsgICAgIC8vICdjc3MtY2xhc3MtbmFtZScKICAgICdteSBmYXZvcml0ZSBpdGVtcycuZGVjYW1lbGl6ZSgpOyAgLy8gJ215IGZhdm9yaXRlIGl0ZW1zJwogICAgYGBgCgogICAgQG1ldGhvZCBkZWNhbWVsaXplCiAgICBAcGFyYW0ge1N0cmluZ30gc3RyIFRoZSBzdHJpbmcgdG8gZGVjYW1lbGl6ZS4KICAgIEByZXR1cm4ge1N0cmluZ30gdGhlIGRlY2FtZWxpemVkIHN0cmluZy4KICAqLwogIGRlY2FtZWxpemU6IGZ1bmN0aW9uKHN0cikgewogICAgcmV0dXJuIHN0ci5yZXBsYWNlKFNUUklOR19ERUNBTUVMSVpFX1JFR0VYUCwgJyQxXyQyJykudG9Mb3dlckNhc2UoKTsKICB9LAoKICAvKioKICAgIFJlcGxhY2VzIHVuZGVyc2NvcmVzLCBzcGFjZXMsIG9yIGNhbWVsQ2FzZSB3aXRoIGRhc2hlcy4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICAnaW5uZXJIVE1MJy5kYXNoZXJpemUoKTsgICAgICAgICAgLy8gJ2lubmVyLWh0bWwnCiAgICAnYWN0aW9uX25hbWUnLmRhc2hlcml6ZSgpOyAgICAgICAgLy8gJ2FjdGlvbi1uYW1lJwogICAgJ2Nzcy1jbGFzcy1uYW1lJy5kYXNoZXJpemUoKTsgICAgIC8vICdjc3MtY2xhc3MtbmFtZScKICAgICdteSBmYXZvcml0ZSBpdGVtcycuZGFzaGVyaXplKCk7ICAvLyAnbXktZmF2b3JpdGUtaXRlbXMnCiAgICBgYGAKCiAgICBAbWV0aG9kIGRhc2hlcml6ZQogICAgQHBhcmFtIHtTdHJpbmd9IHN0ciBUaGUgc3RyaW5nIHRvIGRhc2hlcml6ZS4KICAgIEByZXR1cm4ge1N0cmluZ30gdGhlIGRhc2hlcml6ZWQgc3RyaW5nLgogICovCiAgZGFzaGVyaXplOiBmdW5jdGlvbihzdHIpIHsKICAgIHZhciBjYWNoZSA9IFNUUklOR19EQVNIRVJJWkVfQ0FDSEUsCiAgICAgICAgaGl0ICAgPSBjYWNoZS5oYXNPd25Qcm9wZXJ0eShzdHIpLAogICAgICAgIHJldDsKCiAgICBpZiAoaGl0KSB7CiAgICAgIHJldHVybiBjYWNoZVtzdHJdOwogICAgfSBlbHNlIHsKICAgICAgcmV0ID0gRW1iZXIuU3RyaW5nLmRlY2FtZWxpemUoc3RyKS5yZXBsYWNlKFNUUklOR19EQVNIRVJJWkVfUkVHRVhQLCctJyk7CiAgICAgIGNhY2hlW3N0cl0gPSByZXQ7CiAgICB9CgogICAgcmV0dXJuIHJldDsKICB9LAoKICAvKioKICAgIFJldHVybnMgdGhlIGxvd2VyQ2FtZWxDYXNlIGZvcm0gb2YgYSBzdHJpbmcuCgogICAgYGBgamF2YXNjcmlwdAogICAgJ2lubmVySFRNTCcuY2FtZWxpemUoKTsgICAgICAgICAgLy8gJ2lubmVySFRNTCcKICAgICdhY3Rpb25fbmFtZScuY2FtZWxpemUoKTsgICAgICAgIC8vICdhY3Rpb25OYW1lJwogICAgJ2Nzcy1jbGFzcy1uYW1lJy5jYW1lbGl6ZSgpOyAgICAgLy8gJ2Nzc0NsYXNzTmFtZScKICAgICdteSBmYXZvcml0ZSBpdGVtcycuY2FtZWxpemUoKTsgIC8vICdteUZhdm9yaXRlSXRlbXMnCiAgICAnTXkgRmF2b3JpdGUgSXRlbXMnLmNhbWVsaXplKCk7ICAvLyAnbXlGYXZvcml0ZUl0ZW1zJwogICAgYGBgCgogICAgQG1ldGhvZCBjYW1lbGl6ZQogICAgQHBhcmFtIHtTdHJpbmd9IHN0ciBUaGUgc3RyaW5nIHRvIGNhbWVsaXplLgogICAgQHJldHVybiB7U3RyaW5nfSB0aGUgY2FtZWxpemVkIHN0cmluZy4KICAqLwogIGNhbWVsaXplOiBmdW5jdGlvbihzdHIpIHsKICAgIHJldHVybiBzdHIucmVwbGFjZShTVFJJTkdfQ0FNRUxJWkVfUkVHRVhQLCBmdW5jdGlvbihtYXRjaCwgc2VwYXJhdG9yLCBjaHIpIHsKICAgICAgcmV0dXJuIGNociA/IGNoci50b1VwcGVyQ2FzZSgpIDogJyc7CiAgICB9KS5yZXBsYWNlKC9eKFtBLVpdKS8sIGZ1bmN0aW9uKG1hdGNoLCBzZXBhcmF0b3IsIGNocikgewogICAgICByZXR1cm4gbWF0Y2gudG9Mb3dlckNhc2UoKTsKICAgIH0pOwogIH0sCgogIC8qKgogICAgUmV0dXJucyB0aGUgVXBwZXJDYW1lbENhc2UgZm9ybSBvZiBhIHN0cmluZy4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICAnaW5uZXJIVE1MJy5jbGFzc2lmeSgpOyAgICAgICAgICAvLyAnSW5uZXJIVE1MJwogICAgJ2FjdGlvbl9uYW1lJy5jbGFzc2lmeSgpOyAgICAgICAgLy8gJ0FjdGlvbk5hbWUnCiAgICAnY3NzLWNsYXNzLW5hbWUnLmNsYXNzaWZ5KCk7ICAgICAvLyAnQ3NzQ2xhc3NOYW1lJwogICAgJ215IGZhdm9yaXRlIGl0ZW1zJy5jbGFzc2lmeSgpOyAgLy8gJ015RmF2b3JpdGVJdGVtcycKICAgIGBgYAoKICAgIEBtZXRob2QgY2xhc3NpZnkKICAgIEBwYXJhbSB7U3RyaW5nfSBzdHIgdGhlIHN0cmluZyB0byBjbGFzc2lmeQogICAgQHJldHVybiB7U3RyaW5nfSB0aGUgY2xhc3NpZmllZCBzdHJpbmcKICAqLwogIGNsYXNzaWZ5OiBmdW5jdGlvbihzdHIpIHsKICAgIHZhciBwYXJ0cyA9IHN0ci5zcGxpdCgiLiIpLAogICAgICAgIG91dCA9IFtdOwoKICAgIGZvciAodmFyIGk9MCwgbD1wYXJ0cy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgIHZhciBjYW1lbGl6ZWQgPSBFbWJlci5TdHJpbmcuY2FtZWxpemUocGFydHNbaV0pOwogICAgICBvdXQucHVzaChjYW1lbGl6ZWQuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBjYW1lbGl6ZWQuc3Vic3RyKDEpKTsKICAgIH0KCiAgICByZXR1cm4gb3V0LmpvaW4oIi4iKTsKICB9LAoKICAvKioKICAgIE1vcmUgZ2VuZXJhbCB0aGFuIGRlY2FtZWxpemUuIFJldHVybnMgdGhlIGxvd2VyXF9jYXNlXF9hbmRcX3VuZGVyc2NvcmVkCiAgICBmb3JtIG9mIGEgc3RyaW5nLgoKICAgIGBgYGphdmFzY3JpcHQKICAgICdpbm5lckhUTUwnLnVuZGVyc2NvcmUoKTsgICAgICAgICAgLy8gJ2lubmVyX2h0bWwnCiAgICAnYWN0aW9uX25hbWUnLnVuZGVyc2NvcmUoKTsgICAgICAgIC8vICdhY3Rpb25fbmFtZScKICAgICdjc3MtY2xhc3MtbmFtZScudW5kZXJzY29yZSgpOyAgICAgLy8gJ2Nzc19jbGFzc19uYW1lJwogICAgJ215IGZhdm9yaXRlIGl0ZW1zJy51bmRlcnNjb3JlKCk7ICAvLyAnbXlfZmF2b3JpdGVfaXRlbXMnCiAgICBgYGAKCiAgICBAbWV0aG9kIHVuZGVyc2NvcmUKICAgIEBwYXJhbSB7U3RyaW5nfSBzdHIgVGhlIHN0cmluZyB0byB1bmRlcnNjb3JlLgogICAgQHJldHVybiB7U3RyaW5nfSB0aGUgdW5kZXJzY29yZWQgc3RyaW5nLgogICovCiAgdW5kZXJzY29yZTogZnVuY3Rpb24oc3RyKSB7CiAgICByZXR1cm4gc3RyLnJlcGxhY2UoU1RSSU5HX1VOREVSU0NPUkVfUkVHRVhQXzEsICckMV8kMicpLgogICAgICByZXBsYWNlKFNUUklOR19VTkRFUlNDT1JFX1JFR0VYUF8yLCAnXycpLnRvTG93ZXJDYXNlKCk7CiAgfSwKCiAgLyoqCiAgICBSZXR1cm5zIHRoZSBDYXBpdGFsaXplZCBmb3JtIG9mIGEgc3RyaW5nCgogICAgYGBgamF2YXNjcmlwdAogICAgJ2lubmVySFRNTCcuY2FwaXRhbGl6ZSgpICAgICAgICAgLy8gJ0lubmVySFRNTCcKICAgICdhY3Rpb25fbmFtZScuY2FwaXRhbGl6ZSgpICAgICAgIC8vICdBY3Rpb25fbmFtZScKICAgICdjc3MtY2xhc3MtbmFtZScuY2FwaXRhbGl6ZSgpICAgIC8vICdDc3MtY2xhc3MtbmFtZScKICAgICdteSBmYXZvcml0ZSBpdGVtcycuY2FwaXRhbGl6ZSgpIC8vICdNeSBmYXZvcml0ZSBpdGVtcycKICAgIGBgYAoKICAgIEBtZXRob2QgY2FwaXRhbGl6ZQogICAgQHBhcmFtIHtTdHJpbmd9IHN0ciBUaGUgc3RyaW5nIHRvIGNhcGl0YWxpemUuCiAgICBAcmV0dXJuIHtTdHJpbmd9IFRoZSBjYXBpdGFsaXplZCBzdHJpbmcuCiAgKi8KICBjYXBpdGFsaXplOiBmdW5jdGlvbihzdHIpIHsKICAgIHJldHVybiBzdHIuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBzdHIuc3Vic3RyKDEpOwogIH0KfTsKCgoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLXJ1bnRpbWUKKi8KCgoKdmFyIGZtdCA9IEVtYmVyLlN0cmluZy5mbXQsCiAgICB3ICAgPSBFbWJlci5TdHJpbmcudywKICAgIGxvYyA9IEVtYmVyLlN0cmluZy5sb2MsCiAgICBjYW1lbGl6ZSA9IEVtYmVyLlN0cmluZy5jYW1lbGl6ZSwKICAgIGRlY2FtZWxpemUgPSBFbWJlci5TdHJpbmcuZGVjYW1lbGl6ZSwKICAgIGRhc2hlcml6ZSA9IEVtYmVyLlN0cmluZy5kYXNoZXJpemUsCiAgICB1bmRlcnNjb3JlID0gRW1iZXIuU3RyaW5nLnVuZGVyc2NvcmUsCiAgICBjYXBpdGFsaXplID0gRW1iZXIuU3RyaW5nLmNhcGl0YWxpemUsCiAgICBjbGFzc2lmeSA9IEVtYmVyLlN0cmluZy5jbGFzc2lmeTsKCgppZiAoRW1iZXIuRVhURU5EX1BST1RPVFlQRVMgPT09IHRydWUgfHwgRW1iZXIuRVhURU5EX1BST1RPVFlQRVMuU3RyaW5nKSB7CgogIC8qKgogICAgU2VlIFtFbWJlci5TdHJpbmcuZm10XSgvYXBpL2NsYXNzZXMvRW1iZXIuU3RyaW5nLmh0bWwjbWV0aG9kX2ZtdCkuCgogICAgQG1ldGhvZCBmbXQKICAgIEBmb3IgU3RyaW5nCiAgKi8KICBTdHJpbmcucHJvdG90eXBlLmZtdCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGZtdCh0aGlzLCBhcmd1bWVudHMpOwogIH07CgogIC8qKgogICAgU2VlIFtFbWJlci5TdHJpbmcud10oL2FwaS9jbGFzc2VzL0VtYmVyLlN0cmluZy5odG1sI21ldGhvZF93KS4KCiAgICBAbWV0aG9kIHcKICAgIEBmb3IgU3RyaW5nCiAgKi8KICBTdHJpbmcucHJvdG90eXBlLncgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB3KHRoaXMpOwogIH07CgogIC8qKgogICAgU2VlIFtFbWJlci5TdHJpbmcubG9jXSgvYXBpL2NsYXNzZXMvRW1iZXIuU3RyaW5nLmh0bWwjbWV0aG9kX2xvYykuCgogICAgQG1ldGhvZCBsb2MKICAgIEBmb3IgU3RyaW5nCiAgKi8KICBTdHJpbmcucHJvdG90eXBlLmxvYyA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGxvYyh0aGlzLCBhcmd1bWVudHMpOwogIH07CgogIC8qKgogICAgU2VlIFtFbWJlci5TdHJpbmcuY2FtZWxpemVdKC9hcGkvY2xhc3Nlcy9FbWJlci5TdHJpbmcuaHRtbCNtZXRob2RfY2FtZWxpemUpLgoKICAgIEBtZXRob2QgY2FtZWxpemUKICAgIEBmb3IgU3RyaW5nCiAgKi8KICBTdHJpbmcucHJvdG90eXBlLmNhbWVsaXplID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY2FtZWxpemUodGhpcyk7CiAgfTsKCiAgLyoqCiAgICBTZWUgW0VtYmVyLlN0cmluZy5kZWNhbWVsaXplXSgvYXBpL2NsYXNzZXMvRW1iZXIuU3RyaW5nLmh0bWwjbWV0aG9kX2RlY2FtZWxpemUpLgoKICAgIEBtZXRob2QgZGVjYW1lbGl6ZQogICAgQGZvciBTdHJpbmcKICAqLwogIFN0cmluZy5wcm90b3R5cGUuZGVjYW1lbGl6ZSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGRlY2FtZWxpemUodGhpcyk7CiAgfTsKCiAgLyoqCiAgICBTZWUgW0VtYmVyLlN0cmluZy5kYXNoZXJpemVdKC9hcGkvY2xhc3Nlcy9FbWJlci5TdHJpbmcuaHRtbCNtZXRob2RfZGFzaGVyaXplKS4KCiAgICBAbWV0aG9kIGRhc2hlcml6ZQogICAgQGZvciBTdHJpbmcKICAqLwogIFN0cmluZy5wcm90b3R5cGUuZGFzaGVyaXplID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gZGFzaGVyaXplKHRoaXMpOwogIH07CgogIC8qKgogICAgU2VlIFtFbWJlci5TdHJpbmcudW5kZXJzY29yZV0oL2FwaS9jbGFzc2VzL0VtYmVyLlN0cmluZy5odG1sI21ldGhvZF91bmRlcnNjb3JlKS4KCiAgICBAbWV0aG9kIHVuZGVyc2NvcmUKICAgIEBmb3IgU3RyaW5nCiAgKi8KICBTdHJpbmcucHJvdG90eXBlLnVuZGVyc2NvcmUgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB1bmRlcnNjb3JlKHRoaXMpOwogIH07CgogIC8qKgogICAgU2VlIFtFbWJlci5TdHJpbmcuY2xhc3NpZnldKC9hcGkvY2xhc3Nlcy9FbWJlci5TdHJpbmcuaHRtbCNtZXRob2RfY2xhc3NpZnkpLgoKICAgIEBtZXRob2QgY2xhc3NpZnkKICAgIEBmb3IgU3RyaW5nCiAgKi8KICBTdHJpbmcucHJvdG90eXBlLmNsYXNzaWZ5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY2xhc3NpZnkodGhpcyk7CiAgfTsKCiAgLyoqCiAgICBTZWUgW0VtYmVyLlN0cmluZy5jYXBpdGFsaXplXSgvYXBpL2NsYXNzZXMvRW1iZXIuU3RyaW5nLmh0bWwjbWV0aG9kX2NhcGl0YWxpemUpLgoKICAgIEBtZXRob2QgY2FwaXRhbGl6ZQogICAgQGZvciBTdHJpbmcKICAqLwogIFN0cmluZy5wcm90b3R5cGUuY2FwaXRhbGl6ZSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNhcGl0YWxpemUodGhpcyk7CiAgfTsKCiAgCn0KCgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItcnVudGltZQoqLwoKdmFyIGdldCA9IEVtYmVyLmdldCwKICAgIHNldCA9IEVtYmVyLnNldCwKICAgIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLAogICAgZ2V0UHJvcGVydGllcyA9IEVtYmVyLmdldFByb3BlcnRpZXM7CgovKioKICAjIyBPdmVydmlldwoKICBUaGlzIG1peGluIHByb3ZpZGVzIHByb3BlcnRpZXMgYW5kIHByb3BlcnR5IG9ic2VydmluZyBmdW5jdGlvbmFsaXR5LCBjb3JlCiAgZmVhdHVyZXMgb2YgdGhlIEVtYmVyIG9iamVjdCBtb2RlbC4KCiAgUHJvcGVydGllcyBhbmQgb2JzZXJ2ZXJzIGFsbG93IG9uZSBvYmplY3QgdG8gb2JzZXJ2ZSBjaGFuZ2VzIHRvIGEKICBwcm9wZXJ0eSBvbiBhbm90aGVyIG9iamVjdC4gVGhpcyBpcyBvbmUgb2YgdGhlIGZ1bmRhbWVudGFsIHdheXMgdGhhdAogIG1vZGVscywgY29udHJvbGxlcnMgYW5kIHZpZXdzIGNvbW11bmljYXRlIHdpdGggZWFjaCBvdGhlciBpbiBhbiBFbWJlcgogIGFwcGxpY2F0aW9uLgoKICBBbnkgb2JqZWN0IHRoYXQgaGFzIHRoaXMgbWl4aW4gYXBwbGllZCBjYW4gYmUgdXNlZCBpbiBvYnNlcnZlcgogIG9wZXJhdGlvbnMuIFRoYXQgaW5jbHVkZXMgYEVtYmVyLk9iamVjdGAgYW5kIG1vc3Qgb2JqZWN0cyB5b3Ugd2lsbAogIGludGVyYWN0IHdpdGggYXMgeW91IHdyaXRlIHlvdXIgRW1iZXIgYXBwbGljYXRpb24uCgogIE5vdGUgdGhhdCB5b3Ugd2lsbCBub3QgZ2VuZXJhbGx5IGFwcGx5IHRoaXMgbWl4aW4gdG8gY2xhc3NlcyB5b3Vyc2VsZiwKICBidXQgeW91IHdpbGwgdXNlIHRoZSBmZWF0dXJlcyBwcm92aWRlZCBieSB0aGlzIG1vZHVsZSBmcmVxdWVudGx5LCBzbyBpdAogIGlzIGltcG9ydGFudCB0byB1bmRlcnN0YW5kIGhvdyB0byB1c2UgaXQuCgogICMjIFVzaW5nIGBnZXQoKWAgYW5kIGBzZXQoKWAKCiAgQmVjYXVzZSBvZiBFbWJlcidzIHN1cHBvcnQgZm9yIGJpbmRpbmdzIGFuZCBvYnNlcnZlcnMsIHlvdSB3aWxsIGFsd2F5cwogIGFjY2VzcyBwcm9wZXJ0aWVzIHVzaW5nIHRoZSBnZXQgbWV0aG9kLCBhbmQgc2V0IHByb3BlcnRpZXMgdXNpbmcgdGhlCiAgc2V0IG1ldGhvZC4gVGhpcyBhbGxvd3MgdGhlIG9ic2VydmluZyBvYmplY3RzIHRvIGJlIG5vdGlmaWVkIGFuZAogIGNvbXB1dGVkIHByb3BlcnRpZXMgdG8gYmUgaGFuZGxlZCBwcm9wZXJseS4KCiAgTW9yZSBkb2N1bWVudGF0aW9uIGFib3V0IGBnZXRgIGFuZCBgc2V0YCBhcmUgYmVsb3cuCgogICMjIE9ic2VydmluZyBQcm9wZXJ0eSBDaGFuZ2VzCgogIFlvdSB0eXBpY2FsbHkgb2JzZXJ2ZSBwcm9wZXJ0eSBjaGFuZ2VzIHNpbXBseSBieSBhZGRpbmcgdGhlIGBvYnNlcnZlc2AKICBjYWxsIHRvIHRoZSBlbmQgb2YgeW91ciBtZXRob2QgZGVjbGFyYXRpb25zIGluIGNsYXNzZXMgdGhhdCB5b3Ugd3JpdGUuCiAgRm9yIGV4YW1wbGU6CgogIGBgYGphdmFzY3JpcHQKICBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICAgIHZhbHVlT2JzZXJ2ZXI6IGZ1bmN0aW9uKCkgewogICAgICAvLyBFeGVjdXRlcyB3aGVuZXZlciB0aGUgInZhbHVlIiBwcm9wZXJ0eSBjaGFuZ2VzCiAgICB9Lm9ic2VydmVzKCd2YWx1ZScpCiAgfSk7CiAgYGBgCgogIEFsdGhvdWdoIHRoaXMgaXMgdGhlIG1vc3QgY29tbW9uIHdheSB0byBhZGQgYW4gb2JzZXJ2ZXIsIHRoaXMgY2FwYWJpbGl0eQogIGlzIGFjdHVhbGx5IGJ1aWx0IGludG8gdGhlIGBFbWJlci5PYmplY3RgIGNsYXNzIG9uIHRvcCBvZiB0d28gbWV0aG9kcwogIGRlZmluZWQgaW4gdGhpcyBtaXhpbjogYGFkZE9ic2VydmVyYCBhbmQgYHJlbW92ZU9ic2VydmVyYC4gWW91IGNhbiB1c2UKICB0aGVzZSB0d28gbWV0aG9kcyB0byBhZGQgYW5kIHJlbW92ZSBvYnNlcnZlcnMgeW91cnNlbGYgaWYgeW91IG5lZWQgdG8KICBkbyBzbyBhdCBydW50aW1lLgoKICBUbyBhZGQgYW4gb2JzZXJ2ZXIgZm9yIGEgcHJvcGVydHksIGNhbGw6CgogIGBgYGphdmFzY3JpcHQKICBvYmplY3QuYWRkT2JzZXJ2ZXIoJ3Byb3BlcnR5S2V5JywgdGFyZ2V0T2JqZWN0LCB0YXJnZXRBY3Rpb24pCiAgYGBgCgogIFRoaXMgd2lsbCBjYWxsIHRoZSBgdGFyZ2V0QWN0aW9uYCBtZXRob2Qgb24gdGhlIGB0YXJnZXRPYmplY3RgIHdoZW5ldmVyCiAgdGhlIHZhbHVlIG9mIHRoZSBgcHJvcGVydHlLZXlgIGNoYW5nZXMuCgogIE5vdGUgdGhhdCBpZiBgcHJvcGVydHlLZXlgIGlzIGEgY29tcHV0ZWQgcHJvcGVydHksIHRoZSBvYnNlcnZlciB3aWxsIGJlCiAgY2FsbGVkIHdoZW4gYW55IG9mIHRoZSBwcm9wZXJ0eSBkZXBlbmRlbmNpZXMgYXJlIGNoYW5nZWQsIGV2ZW4gaWYgdGhlCiAgcmVzdWx0aW5nIHZhbHVlIG9mIHRoZSBjb21wdXRlZCBwcm9wZXJ0eSBpcyB1bmNoYW5nZWQuIFRoaXMgaXMgbmVjZXNzYXJ5CiAgYmVjYXVzZSBjb21wdXRlZCBwcm9wZXJ0aWVzIGFyZSBub3QgY29tcHV0ZWQgdW50aWwgYGdldGAgaXMgY2FsbGVkLgoKICBAY2xhc3MgT2JzZXJ2YWJsZQogIEBuYW1lc3BhY2UgRW1iZXIKKi8KRW1iZXIuT2JzZXJ2YWJsZSA9IEVtYmVyLk1peGluLmNyZWF0ZSh7CgogIC8qKgogICAgUmV0cmlldmVzIHRoZSB2YWx1ZSBvZiBhIHByb3BlcnR5IGZyb20gdGhlIG9iamVjdC4KCiAgICBUaGlzIG1ldGhvZCBpcyB1c3VhbGx5IHNpbWlsYXIgdG8gdXNpbmcgYG9iamVjdFtrZXlOYW1lXWAgb3IgYG9iamVjdC5rZXlOYW1lYCwKICAgIGhvd2V2ZXIgaXQgc3VwcG9ydHMgYm90aCBjb21wdXRlZCBwcm9wZXJ0aWVzIGFuZCB0aGUgdW5rbm93blByb3BlcnR5CiAgICBoYW5kbGVyLgoKICAgIEJlY2F1c2UgYGdldGAgdW5pZmllcyB0aGUgc3ludGF4IGZvciBhY2Nlc3NpbmcgYWxsIHRoZXNlIGtpbmRzCiAgICBvZiBwcm9wZXJ0aWVzLCBpdCBjYW4gbWFrZSBtYW55IHJlZmFjdG9yaW5ncyBlYXNpZXIsIHN1Y2ggYXMgcmVwbGFjaW5nIGEKICAgIHNpbXBsZSBwcm9wZXJ0eSB3aXRoIGEgY29tcHV0ZWQgcHJvcGVydHksIG9yIHZpY2UgdmVyc2EuCgogICAgIyMjIENvbXB1dGVkIFByb3BlcnRpZXMKCiAgICBDb21wdXRlZCBwcm9wZXJ0aWVzIGFyZSBtZXRob2RzIGRlZmluZWQgd2l0aCB0aGUgYHByb3BlcnR5YCBtb2RpZmllcgogICAgZGVjbGFyZWQgYXQgdGhlIGVuZCwgc3VjaCBhczoKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBmdWxsTmFtZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmdldCgnZmlyc3ROYW1lJykgKyAnICcgKyB0aGlzLmdldCgnbGFzdE5hbWUnKTsKICAgIH0ucHJvcGVydHkoJ2ZpcnN0TmFtZScsICdsYXN0TmFtZScpCiAgICBgYGAKCiAgICBXaGVuIHlvdSBjYWxsIGBnZXRgIG9uIGEgY29tcHV0ZWQgcHJvcGVydHksIHRoZSBmdW5jdGlvbiB3aWxsIGJlCiAgICBjYWxsZWQgYW5kIHRoZSByZXR1cm4gdmFsdWUgd2lsbCBiZSByZXR1cm5lZCBpbnN0ZWFkIG9mIHRoZSBmdW5jdGlvbgogICAgaXRzZWxmLgoKICAgICMjIyBVbmtub3duIFByb3BlcnRpZXMKCiAgICBMaWtld2lzZSwgaWYgeW91IHRyeSB0byBjYWxsIGBnZXRgIG9uIGEgcHJvcGVydHkgd2hvc2UgdmFsdWUgaXMKICAgIGB1bmRlZmluZWRgLCB0aGUgYHVua25vd25Qcm9wZXJ0eSgpYCBtZXRob2Qgd2lsbCBiZSBjYWxsZWQgb24gdGhlIG9iamVjdC4KICAgIElmIHRoaXMgbWV0aG9kIHJldHVybnMgYW55IHZhbHVlIG90aGVyIHRoYW4gYHVuZGVmaW5lZGAsIGl0IHdpbGwgYmUgcmV0dXJuZWQKICAgIGluc3RlYWQuIFRoaXMgYWxsb3dzIHlvdSB0byBpbXBsZW1lbnQgInZpcnR1YWwiIHByb3BlcnRpZXMgdGhhdCBhcmUKICAgIG5vdCBkZWZpbmVkIHVwZnJvbnQuCgogICAgQG1ldGhvZCBnZXQKICAgIEBwYXJhbSB7U3RyaW5nfSBrZXlOYW1lIFRoZSBwcm9wZXJ0eSB0byByZXRyaWV2ZQogICAgQHJldHVybiB7T2JqZWN0fSBUaGUgcHJvcGVydHkgdmFsdWUgb3IgdW5kZWZpbmVkLgogICovCiAgZ2V0OiBmdW5jdGlvbihrZXlOYW1lKSB7CiAgICByZXR1cm4gZ2V0KHRoaXMsIGtleU5hbWUpOwogIH0sCgogIC8qKgogICAgVG8gZ2V0IG11bHRpcGxlIHByb3BlcnRpZXMgYXQgb25jZSwgY2FsbCBgZ2V0UHJvcGVydGllc2AKICAgIHdpdGggYSBsaXN0IG9mIHN0cmluZ3Mgb3IgYW4gYXJyYXk6CgogICAgYGBgamF2YXNjcmlwdAogICAgcmVjb3JkLmdldFByb3BlcnRpZXMoJ2ZpcnN0TmFtZScsICdsYXN0TmFtZScsICd6aXBDb2RlJyk7ICAvLyB7IGZpcnN0TmFtZTogJ0pvaG4nLCBsYXN0TmFtZTogJ0RvZScsIHppcENvZGU6ICcxMDAxMScgfQogICAgYGBgCgogICAgaXMgZXF1aXZhbGVudCB0bzoKCiAgICBgYGBqYXZhc2NyaXB0CiAgICByZWNvcmQuZ2V0UHJvcGVydGllcyhbJ2ZpcnN0TmFtZScsICdsYXN0TmFtZScsICd6aXBDb2RlJ10pOyAgLy8geyBmaXJzdE5hbWU6ICdKb2huJywgbGFzdE5hbWU6ICdEb2UnLCB6aXBDb2RlOiAnMTAwMTEnIH0KICAgIGBgYAoKICAgIEBtZXRob2QgZ2V0UHJvcGVydGllcwogICAgQHBhcmFtIHtTdHJpbmcuLi58QXJyYXl9IGxpc3Qgb2Yga2V5cyB0byBnZXQKICAgIEByZXR1cm4ge0hhc2h9CiAgKi8KICBnZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBnZXRQcm9wZXJ0aWVzLmFwcGx5KG51bGwsIFt0aGlzXS5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgfSwKCiAgLyoqCiAgICBTZXRzIHRoZSBwcm92aWRlZCBrZXkgb3IgcGF0aCB0byB0aGUgdmFsdWUuCgogICAgVGhpcyBtZXRob2QgaXMgZ2VuZXJhbGx5IHZlcnkgc2ltaWxhciB0byBjYWxsaW5nIGBvYmplY3Rba2V5XSA9IHZhbHVlYCBvcgogICAgYG9iamVjdC5rZXkgPSB2YWx1ZWAsIGV4Y2VwdCB0aGF0IGl0IHByb3ZpZGVzIHN1cHBvcnQgZm9yIGNvbXB1dGVkCiAgICBwcm9wZXJ0aWVzLCB0aGUgYHNldFVua25vd25Qcm9wZXJ0eSgpYCBtZXRob2QgYW5kIHByb3BlcnR5IG9ic2VydmVycy4KCiAgICAjIyMgQ29tcHV0ZWQgUHJvcGVydGllcwoKICAgIElmIHlvdSB0cnkgdG8gc2V0IGEgdmFsdWUgb24gYSBrZXkgdGhhdCBoYXMgYSBjb21wdXRlZCBwcm9wZXJ0eSBoYW5kbGVyCiAgICBkZWZpbmVkIChzZWUgdGhlIGBnZXQoKWAgbWV0aG9kIGZvciBhbiBleGFtcGxlKSwgdGhlbiBgc2V0KClgIHdpbGwgY2FsbAogICAgdGhhdCBtZXRob2QsIHBhc3NpbmcgYm90aCB0aGUgdmFsdWUgYW5kIGtleSBpbnN0ZWFkIG9mIHNpbXBseSBjaGFuZ2luZwogICAgdGhlIHZhbHVlIGl0c2VsZi4gVGhpcyBpcyB1c2VmdWwgZm9yIHRob3NlIHRpbWVzIHdoZW4geW91IG5lZWQgdG8KICAgIGltcGxlbWVudCBhIHByb3BlcnR5IHRoYXQgaXMgY29tcG9zZWQgb2Ygb25lIG9yIG1vcmUgbWVtYmVyCiAgICBwcm9wZXJ0aWVzLgoKICAgICMjIyBVbmtub3duIFByb3BlcnRpZXMKCiAgICBJZiB5b3UgdHJ5IHRvIHNldCBhIHZhbHVlIG9uIGEga2V5IHRoYXQgaXMgdW5kZWZpbmVkIGluIHRoZSB0YXJnZXQKICAgIG9iamVjdCwgdGhlbiB0aGUgYHNldFVua25vd25Qcm9wZXJ0eSgpYCBoYW5kbGVyIHdpbGwgYmUgY2FsbGVkIGluc3RlYWQuIFRoaXMKICAgIGdpdmVzIHlvdSBhbiBvcHBvcnR1bml0eSB0byBpbXBsZW1lbnQgY29tcGxleCAidmlydHVhbCIgcHJvcGVydGllcyB0aGF0CiAgICBhcmUgbm90IHByZWRlZmluZWQgb24gdGhlIG9iamVjdC4gSWYgYHNldFVua25vd25Qcm9wZXJ0eSgpYCByZXR1cm5zCiAgICB1bmRlZmluZWQsIHRoZW4gYHNldCgpYCB3aWxsIHNpbXBseSBzZXQgdGhlIHZhbHVlIG9uIHRoZSBvYmplY3QuCgogICAgIyMjIFByb3BlcnR5IE9ic2VydmVycwoKICAgIEluIGFkZGl0aW9uIHRvIGNoYW5naW5nIHRoZSBwcm9wZXJ0eSwgYHNldCgpYCB3aWxsIGFsc28gcmVnaXN0ZXIgYSBwcm9wZXJ0eQogICAgY2hhbmdlIHdpdGggdGhlIG9iamVjdC4gVW5sZXNzIHlvdSBoYXZlIHBsYWNlZCB0aGlzIGNhbGwgaW5zaWRlIG9mIGEKICAgIGBiZWdpblByb3BlcnR5Q2hhbmdlcygpYCBhbmQgYGVuZFByb3BlcnR5Q2hhbmdlcygpLGAgYW55ICJsb2NhbCIgb2JzZXJ2ZXJzCiAgICAoaS5lLiBvYnNlcnZlciBtZXRob2RzIGRlY2xhcmVkIG9uIHRoZSBzYW1lIG9iamVjdCksIHdpbGwgYmUgY2FsbGVkCiAgICBpbW1lZGlhdGVseS4gQW55ICJyZW1vdGUiIG9ic2VydmVycyAoaS5lLiBvYnNlcnZlciBtZXRob2RzIGRlY2xhcmVkIG9uCiAgICBhbm90aGVyIG9iamVjdCkgd2lsbCBiZSBwbGFjZWQgaW4gYSBxdWV1ZSBhbmQgY2FsbGVkIGF0IGEgbGF0ZXIgdGltZSBpbiBhCiAgICBjb2FsZXNjZWQgbWFubmVyLgoKICAgICMjIyBDaGFpbmluZwoKICAgIEluIGFkZGl0aW9uIHRvIHByb3BlcnR5IGNoYW5nZXMsIGBzZXQoKWAgcmV0dXJucyB0aGUgdmFsdWUgb2YgdGhlIG9iamVjdAogICAgaXRzZWxmIHNvIHlvdSBjYW4gZG8gY2hhaW5pbmcgbGlrZSB0aGlzOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIHJlY29yZC5zZXQoJ2ZpcnN0TmFtZScsICdDaGFybGVzJykuc2V0KCdsYXN0TmFtZScsICdKb2xsZXknKTsKICAgIGBgYAoKICAgIEBtZXRob2Qgc2V0CiAgICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZSBUaGUgcHJvcGVydHkgdG8gc2V0CiAgICBAcGFyYW0ge09iamVjdH0gdmFsdWUgVGhlIHZhbHVlIHRvIHNldCBvciBgbnVsbGAuCiAgICBAcmV0dXJuIHtFbWJlci5PYnNlcnZhYmxlfQogICovCiAgc2V0OiBmdW5jdGlvbihrZXlOYW1lLCB2YWx1ZSkgewogICAgc2V0KHRoaXMsIGtleU5hbWUsIHZhbHVlKTsKICAgIHJldHVybiB0aGlzOwogIH0sCgoKICAvKioKICAgIFNldHMgYSBsaXN0IG9mIHByb3BlcnRpZXMgYXQgb25jZS4gVGhlc2UgcHJvcGVydGllcyBhcmUgc2V0IGluc2lkZQogICAgYSBzaW5nbGUgYGJlZ2luUHJvcGVydHlDaGFuZ2VzYCBhbmQgYGVuZFByb3BlcnR5Q2hhbmdlc2AgYmF0Y2gsIHNvCiAgICBvYnNlcnZlcnMgd2lsbCBiZSBidWZmZXJlZC4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICByZWNvcmQuc2V0UHJvcGVydGllcyh7IGZpcnN0TmFtZTogJ0NoYXJsZXMnLCBsYXN0TmFtZTogJ0pvbGxleScgfSk7CiAgICBgYGAKCiAgICBAbWV0aG9kIHNldFByb3BlcnRpZXMKICAgIEBwYXJhbSB7SGFzaH0gaGFzaCB0aGUgaGFzaCBvZiBrZXlzIGFuZCB2YWx1ZXMgdG8gc2V0CiAgICBAcmV0dXJuIHtFbWJlci5PYnNlcnZhYmxlfQogICovCiAgc2V0UHJvcGVydGllczogZnVuY3Rpb24oaGFzaCkgewogICAgcmV0dXJuIEVtYmVyLnNldFByb3BlcnRpZXModGhpcywgaGFzaCk7CiAgfSwKCiAgLyoqCiAgICBCZWdpbnMgYSBncm91cGluZyBvZiBwcm9wZXJ0eSBjaGFuZ2VzLgoKICAgIFlvdSBjYW4gdXNlIHRoaXMgbWV0aG9kIHRvIGdyb3VwIHByb3BlcnR5IGNoYW5nZXMgc28gdGhhdCBub3RpZmljYXRpb25zCiAgICB3aWxsIG5vdCBiZSBzZW50IHVudGlsIHRoZSBjaGFuZ2VzIGFyZSBmaW5pc2hlZC4gSWYgeW91IHBsYW4gdG8gbWFrZSBhCiAgICBsYXJnZSBudW1iZXIgb2YgY2hhbmdlcyB0byBhbiBvYmplY3QgYXQgb25lIHRpbWUsIHlvdSBzaG91bGQgY2FsbCB0aGlzCiAgICBtZXRob2QgYXQgdGhlIGJlZ2lubmluZyBvZiB0aGUgY2hhbmdlcyB0byBiZWdpbiBkZWZlcnJpbmcgY2hhbmdlCiAgICBub3RpZmljYXRpb25zLiBXaGVuIHlvdSBhcmUgZG9uZSBtYWtpbmcgY2hhbmdlcywgY2FsbAogICAgYGVuZFByb3BlcnR5Q2hhbmdlcygpYCB0byBkZWxpdmVyIHRoZSBkZWZlcnJlZCBjaGFuZ2Ugbm90aWZpY2F0aW9ucyBhbmQgZW5kCiAgICBkZWZlcnJpbmcuCgogICAgQG1ldGhvZCBiZWdpblByb3BlcnR5Q2hhbmdlcwogICAgQHJldHVybiB7RW1iZXIuT2JzZXJ2YWJsZX0KICAqLwogIGJlZ2luUHJvcGVydHlDaGFuZ2VzOiBmdW5jdGlvbigpIHsKICAgIEVtYmVyLmJlZ2luUHJvcGVydHlDaGFuZ2VzKCk7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvKioKICAgIEVuZHMgYSBncm91cGluZyBvZiBwcm9wZXJ0eSBjaGFuZ2VzLgoKICAgIFlvdSBjYW4gdXNlIHRoaXMgbWV0aG9kIHRvIGdyb3VwIHByb3BlcnR5IGNoYW5nZXMgc28gdGhhdCBub3RpZmljYXRpb25zCiAgICB3aWxsIG5vdCBiZSBzZW50IHVudGlsIHRoZSBjaGFuZ2VzIGFyZSBmaW5pc2hlZC4gSWYgeW91IHBsYW4gdG8gbWFrZSBhCiAgICBsYXJnZSBudW1iZXIgb2YgY2hhbmdlcyB0byBhbiBvYmplY3QgYXQgb25lIHRpbWUsIHlvdSBzaG91bGQgY2FsbAogICAgYGJlZ2luUHJvcGVydHlDaGFuZ2VzKClgIGF0IHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNoYW5nZXMgdG8gZGVmZXIgY2hhbmdlCiAgICBub3RpZmljYXRpb25zLiBXaGVuIHlvdSBhcmUgZG9uZSBtYWtpbmcgY2hhbmdlcywgY2FsbCB0aGlzIG1ldGhvZCB0bwogICAgZGVsaXZlciB0aGUgZGVmZXJyZWQgY2hhbmdlIG5vdGlmaWNhdGlvbnMgYW5kIGVuZCBkZWZlcnJpbmcuCgogICAgQG1ldGhvZCBlbmRQcm9wZXJ0eUNoYW5nZXMKICAgIEByZXR1cm4ge0VtYmVyLk9ic2VydmFibGV9CiAgKi8KICBlbmRQcm9wZXJ0eUNoYW5nZXM6IGZ1bmN0aW9uKCkgewogICAgRW1iZXIuZW5kUHJvcGVydHlDaGFuZ2VzKCk7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvKioKICAgIE5vdGlmeSB0aGUgb2JzZXJ2ZXIgc3lzdGVtIHRoYXQgYSBwcm9wZXJ0eSBpcyBhYm91dCB0byBjaGFuZ2UuCgogICAgU29tZXRpbWVzIHlvdSBuZWVkIHRvIGNoYW5nZSBhIHZhbHVlIGRpcmVjdGx5IG9yIGluZGlyZWN0bHkgd2l0aG91dAogICAgYWN0dWFsbHkgY2FsbGluZyBgZ2V0KClgIG9yIGBzZXQoKWAgb24gaXQuIEluIHRoaXMgY2FzZSwgeW91IGNhbiB1c2UgdGhpcwogICAgbWV0aG9kIGFuZCBgcHJvcGVydHlEaWRDaGFuZ2UoKWAgaW5zdGVhZC4gQ2FsbGluZyB0aGVzZSB0d28gbWV0aG9kcwogICAgdG9nZXRoZXIgd2lsbCBub3RpZnkgYWxsIG9ic2VydmVycyB0aGF0IHRoZSBwcm9wZXJ0eSBoYXMgcG90ZW50aWFsbHkKICAgIGNoYW5nZWQgdmFsdWUuCgogICAgTm90ZSB0aGF0IHlvdSBtdXN0IGFsd2F5cyBjYWxsIGBwcm9wZXJ0eVdpbGxDaGFuZ2VgIGFuZCBgcHJvcGVydHlEaWRDaGFuZ2VgCiAgICBhcyBhIHBhaXIuIElmIHlvdSBkbyBub3QsIGl0IG1heSBnZXQgdGhlIHByb3BlcnR5IGNoYW5nZSBncm91cHMgb3V0IG9mCiAgICBvcmRlciBhbmQgY2F1c2Ugbm90aWZpY2F0aW9ucyB0byBiZSBkZWxpdmVyZWQgbW9yZSBvZnRlbiB0aGFuIHlvdSB3b3VsZAogICAgbGlrZS4KCiAgICBAbWV0aG9kIHByb3BlcnR5V2lsbENoYW5nZQogICAgQHBhcmFtIHtTdHJpbmd9IGtleU5hbWUgVGhlIHByb3BlcnR5IGtleSB0aGF0IGlzIGFib3V0IHRvIGNoYW5nZS4KICAgIEByZXR1cm4ge0VtYmVyLk9ic2VydmFibGV9CiAgKi8KICBwcm9wZXJ0eVdpbGxDaGFuZ2U6IGZ1bmN0aW9uKGtleU5hbWUpIHsKICAgIEVtYmVyLnByb3BlcnR5V2lsbENoYW5nZSh0aGlzLCBrZXlOYW1lKTsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAgTm90aWZ5IHRoZSBvYnNlcnZlciBzeXN0ZW0gdGhhdCBhIHByb3BlcnR5IGhhcyBqdXN0IGNoYW5nZWQuCgogICAgU29tZXRpbWVzIHlvdSBuZWVkIHRvIGNoYW5nZSBhIHZhbHVlIGRpcmVjdGx5IG9yIGluZGlyZWN0bHkgd2l0aG91dAogICAgYWN0dWFsbHkgY2FsbGluZyBgZ2V0KClgIG9yIGBzZXQoKWAgb24gaXQuIEluIHRoaXMgY2FzZSwgeW91IGNhbiB1c2UgdGhpcwogICAgbWV0aG9kIGFuZCBgcHJvcGVydHlXaWxsQ2hhbmdlKClgIGluc3RlYWQuIENhbGxpbmcgdGhlc2UgdHdvIG1ldGhvZHMKICAgIHRvZ2V0aGVyIHdpbGwgbm90aWZ5IGFsbCBvYnNlcnZlcnMgdGhhdCB0aGUgcHJvcGVydHkgaGFzIHBvdGVudGlhbGx5CiAgICBjaGFuZ2VkIHZhbHVlLgoKICAgIE5vdGUgdGhhdCB5b3UgbXVzdCBhbHdheXMgY2FsbCBgcHJvcGVydHlXaWxsQ2hhbmdlYCBhbmQgYHByb3BlcnR5RGlkQ2hhbmdlYAogICAgYXMgYSBwYWlyLiBJZiB5b3UgZG8gbm90LCBpdCBtYXkgZ2V0IHRoZSBwcm9wZXJ0eSBjaGFuZ2UgZ3JvdXBzIG91dCBvZgogICAgb3JkZXIgYW5kIGNhdXNlIG5vdGlmaWNhdGlvbnMgdG8gYmUgZGVsaXZlcmVkIG1vcmUgb2Z0ZW4gdGhhbiB5b3Ugd291bGQKICAgIGxpa2UuCgogICAgQG1ldGhvZCBwcm9wZXJ0eURpZENoYW5nZQogICAgQHBhcmFtIHtTdHJpbmd9IGtleU5hbWUgVGhlIHByb3BlcnR5IGtleSB0aGF0IGhhcyBqdXN0IGNoYW5nZWQuCiAgICBAcmV0dXJuIHtFbWJlci5PYnNlcnZhYmxlfQogICovCiAgcHJvcGVydHlEaWRDaGFuZ2U6IGZ1bmN0aW9uKGtleU5hbWUpIHsKICAgIEVtYmVyLnByb3BlcnR5RGlkQ2hhbmdlKHRoaXMsIGtleU5hbWUpOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICBDb252ZW5pZW5jZSBtZXRob2QgdG8gY2FsbCBgcHJvcGVydHlXaWxsQ2hhbmdlYCBhbmQgYHByb3BlcnR5RGlkQ2hhbmdlYCBpbgogICAgc3VjY2Vzc2lvbi4KCiAgICBAbWV0aG9kIG5vdGlmeVByb3BlcnR5Q2hhbmdlCiAgICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZSBUaGUgcHJvcGVydHkga2V5IHRvIGJlIG5vdGlmaWVkIGFib3V0LgogICAgQHJldHVybiB7RW1iZXIuT2JzZXJ2YWJsZX0KICAqLwogIG5vdGlmeVByb3BlcnR5Q2hhbmdlOiBmdW5jdGlvbihrZXlOYW1lKSB7CiAgICB0aGlzLnByb3BlcnR5V2lsbENoYW5nZShrZXlOYW1lKTsKICAgIHRoaXMucHJvcGVydHlEaWRDaGFuZ2Uoa2V5TmFtZSk7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICBhZGRCZWZvcmVPYnNlcnZlcjogZnVuY3Rpb24oa2V5LCB0YXJnZXQsIG1ldGhvZCkgewogICAgRW1iZXIuYWRkQmVmb3JlT2JzZXJ2ZXIodGhpcywga2V5LCB0YXJnZXQsIG1ldGhvZCk7CiAgfSwKCiAgLyoqCiAgICBBZGRzIGFuIG9ic2VydmVyIG9uIGEgcHJvcGVydHkuCgogICAgVGhpcyBpcyB0aGUgY29yZSBtZXRob2QgdXNlZCB0byByZWdpc3RlciBhbiBvYnNlcnZlciBmb3IgYSBwcm9wZXJ0eS4KCiAgICBPbmNlIHlvdSBjYWxsIHRoaXMgbWV0aG9kLCBhbnkgdGltZSB0aGUga2V5J3MgdmFsdWUgaXMgc2V0LCB5b3VyIG9ic2VydmVyCiAgICB3aWxsIGJlIG5vdGlmaWVkLiBOb3RlIHRoYXQgdGhlIG9ic2VydmVycyBhcmUgdHJpZ2dlcmVkIGFueSB0aW1lIHRoZQogICAgdmFsdWUgaXMgc2V0LCByZWdhcmRsZXNzIG9mIHdoZXRoZXIgaXQgaGFzIGFjdHVhbGx5IGNoYW5nZWQuIFlvdXIKICAgIG9ic2VydmVyIHNob3VsZCBiZSBwcmVwYXJlZCB0byBoYW5kbGUgdGhhdC4KCiAgICBZb3UgY2FuIGFsc28gcGFzcyBhbiBvcHRpb25hbCBjb250ZXh0IHBhcmFtZXRlciB0byB0aGlzIG1ldGhvZC4gVGhlCiAgICBjb250ZXh0IHdpbGwgYmUgcGFzc2VkIHRvIHlvdXIgb2JzZXJ2ZXIgbWV0aG9kIHdoZW5ldmVyIGl0IGlzIHRyaWdnZXJlZC4KICAgIE5vdGUgdGhhdCBpZiB5b3UgYWRkIHRoZSBzYW1lIHRhcmdldC9tZXRob2QgcGFpciBvbiBhIGtleSBtdWx0aXBsZSB0aW1lcwogICAgd2l0aCBkaWZmZXJlbnQgY29udGV4dCBwYXJhbWV0ZXJzLCB5b3VyIG9ic2VydmVyIHdpbGwgb25seSBiZSBjYWxsZWQgb25jZQogICAgd2l0aCB0aGUgbGFzdCBjb250ZXh0IHlvdSBwYXNzZWQuCgogICAgIyMjIE9ic2VydmVyIE1ldGhvZHMKCiAgICBPYnNlcnZlciBtZXRob2RzIHlvdSBwYXNzIHNob3VsZCBnZW5lcmFsbHkgaGF2ZSB0aGUgZm9sbG93aW5nIHNpZ25hdHVyZSBpZgogICAgeW91IGRvIG5vdCBwYXNzIGEgYGNvbnRleHRgIHBhcmFtZXRlcjoKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBmb29EaWRDaGFuZ2U6IGZ1bmN0aW9uKHNlbmRlciwga2V5LCB2YWx1ZSwgcmV2KSB7IH07CiAgICBgYGAKCiAgICBUaGUgc2VuZGVyIGlzIHRoZSBvYmplY3QgdGhhdCBjaGFuZ2VkLiBUaGUga2V5IGlzIHRoZSBwcm9wZXJ0eSB0aGF0CiAgICBjaGFuZ2VzLiBUaGUgdmFsdWUgcHJvcGVydHkgaXMgY3VycmVudGx5IHJlc2VydmVkIGFuZCB1bnVzZWQuIFRoZSByZXYKICAgIGlzIHRoZSBsYXN0IHByb3BlcnR5IHJldmlzaW9uIG9mIHRoZSBvYmplY3Qgd2hlbiBpdCBjaGFuZ2VkLCB3aGljaCB5b3UgY2FuCiAgICB1c2UgdG8gZGV0ZWN0IGlmIHRoZSBrZXkgdmFsdWUgaGFzIHJlYWxseSBjaGFuZ2VkIG9yIG5vdC4KCiAgICBJZiB5b3UgcGFzcyBhIGBjb250ZXh0YCBwYXJhbWV0ZXIsIHRoZSBjb250ZXh0IHdpbGwgYmUgcGFzc2VkIGJlZm9yZSB0aGUKICAgIHJldmlzaW9uIGxpa2Ugc286CgogICAgYGBgamF2YXNjcmlwdAogICAgZm9vRGlkQ2hhbmdlOiBmdW5jdGlvbihzZW5kZXIsIGtleSwgdmFsdWUsIGNvbnRleHQsIHJldikgeyB9OwogICAgYGBgCgogICAgVXN1YWxseSB5b3Ugd2lsbCBub3QgbmVlZCB0aGUgdmFsdWUsIGNvbnRleHQgb3IgcmV2aXNpb24gcGFyYW1ldGVycyBhdAogICAgdGhlIGVuZC4gSW4gdGhpcyBjYXNlLCBpdCBpcyBjb21tb24gdG8gd3JpdGUgb2JzZXJ2ZXIgbWV0aG9kcyB0aGF0IHRha2UKICAgIG9ubHkgYSBzZW5kZXIgYW5kIGtleSB2YWx1ZSBhcyBwYXJhbWV0ZXJzIG9yLCBpZiB5b3UgYXJlbid0IGludGVyZXN0ZWQgaW4KICAgIGFueSBvZiB0aGVzZSB2YWx1ZXMsIHRvIHdyaXRlIGFuIG9ic2VydmVyIHRoYXQgaGFzIG5vIHBhcmFtZXRlcnMgYXQgYWxsLgoKICAgIEBtZXRob2QgYWRkT2JzZXJ2ZXIKICAgIEBwYXJhbSB7U3RyaW5nfSBrZXkgVGhlIGtleSB0byBvYnNlcnZlcgogICAgQHBhcmFtIHtPYmplY3R9IHRhcmdldCBUaGUgdGFyZ2V0IG9iamVjdCB0byBpbnZva2UKICAgIEBwYXJhbSB7U3RyaW5nfEZ1bmN0aW9ufSBtZXRob2QgVGhlIG1ldGhvZCB0byBpbnZva2UuCiAgICBAcmV0dXJuIHtFbWJlci5PYmplY3R9IHNlbGYKICAqLwogIGFkZE9ic2VydmVyOiBmdW5jdGlvbihrZXksIHRhcmdldCwgbWV0aG9kKSB7CiAgICBFbWJlci5hZGRPYnNlcnZlcih0aGlzLCBrZXksIHRhcmdldCwgbWV0aG9kKTsKICB9LAoKICAvKioKICAgIFJlbW92ZSBhbiBvYnNlcnZlciB5b3UgaGF2ZSBwcmV2aW91c2x5IHJlZ2lzdGVyZWQgb24gdGhpcyBvYmplY3QuIFBhc3MKICAgIHRoZSBzYW1lIGtleSwgdGFyZ2V0LCBhbmQgbWV0aG9kIHlvdSBwYXNzZWQgdG8gYGFkZE9ic2VydmVyKClgIGFuZCB5b3VyCiAgICB0YXJnZXQgd2lsbCBubyBsb25nZXIgcmVjZWl2ZSBub3RpZmljYXRpb25zLgoKICAgIEBtZXRob2QgcmVtb3ZlT2JzZXJ2ZXIKICAgIEBwYXJhbSB7U3RyaW5nfSBrZXkgVGhlIGtleSB0byBvYnNlcnZlcgogICAgQHBhcmFtIHtPYmplY3R9IHRhcmdldCBUaGUgdGFyZ2V0IG9iamVjdCB0byBpbnZva2UKICAgIEBwYXJhbSB7U3RyaW5nfEZ1bmN0aW9ufSBtZXRob2QgVGhlIG1ldGhvZCB0byBpbnZva2UuCiAgICBAcmV0dXJuIHtFbWJlci5PYnNlcnZhYmxlfSByZWNlaXZlcgogICovCiAgcmVtb3ZlT2JzZXJ2ZXI6IGZ1bmN0aW9uKGtleSwgdGFyZ2V0LCBtZXRob2QpIHsKICAgIEVtYmVyLnJlbW92ZU9ic2VydmVyKHRoaXMsIGtleSwgdGFyZ2V0LCBtZXRob2QpOwogIH0sCgogIC8qKgogICAgUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIG9iamVjdCBjdXJyZW50bHkgaGFzIG9ic2VydmVycyByZWdpc3RlcmVkIGZvciBhCiAgICBwYXJ0aWN1bGFyIGtleS4gWW91IGNhbiB1c2UgdGhpcyBtZXRob2QgdG8gcG90ZW50aWFsbHkgZGVmZXIgcGVyZm9ybWluZwogICAgYW4gZXhwZW5zaXZlIGFjdGlvbiB1bnRpbCBzb21lb25lIGJlZ2lucyBvYnNlcnZpbmcgYSBwYXJ0aWN1bGFyIHByb3BlcnR5CiAgICBvbiB0aGUgb2JqZWN0LgoKICAgIEBtZXRob2QgaGFzT2JzZXJ2ZXJGb3IKICAgIEBwYXJhbSB7U3RyaW5nfSBrZXkgS2V5IHRvIGNoZWNrCiAgICBAcmV0dXJuIHtCb29sZWFufQogICovCiAgaGFzT2JzZXJ2ZXJGb3I6IGZ1bmN0aW9uKGtleSkgewogICAgcmV0dXJuIEVtYmVyLmhhc0xpc3RlbmVycyh0aGlzLCBrZXkrJzpjaGFuZ2UnKTsKICB9LAoKICAvKioKICAgIFJldHJpZXZlcyB0aGUgdmFsdWUgb2YgYSBwcm9wZXJ0eSwgb3IgYSBkZWZhdWx0IHZhbHVlIGluIHRoZSBjYXNlIHRoYXQgdGhlCiAgICBwcm9wZXJ0eSByZXR1cm5zIGB1bmRlZmluZWRgLgoKICAgIGBgYGphdmFzY3JpcHQKICAgIHBlcnNvbi5nZXRXaXRoRGVmYXVsdCgnbGFzdE5hbWUnLCAnRG9lJyk7CiAgICBgYGAKCiAgICBAbWV0aG9kIGdldFdpdGhEZWZhdWx0CiAgICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZSBUaGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgdG8gcmV0cmlldmUKICAgIEBwYXJhbSB7T2JqZWN0fSBkZWZhdWx0VmFsdWUgVGhlIHZhbHVlIHRvIHJldHVybiBpZiB0aGUgcHJvcGVydHkgdmFsdWUgaXMgdW5kZWZpbmVkCiAgICBAcmV0dXJuIHtPYmplY3R9IFRoZSBwcm9wZXJ0eSB2YWx1ZSBvciB0aGUgZGVmYXVsdFZhbHVlLgogICovCiAgZ2V0V2l0aERlZmF1bHQ6IGZ1bmN0aW9uKGtleU5hbWUsIGRlZmF1bHRWYWx1ZSkgewogICAgcmV0dXJuIEVtYmVyLmdldFdpdGhEZWZhdWx0KHRoaXMsIGtleU5hbWUsIGRlZmF1bHRWYWx1ZSk7CiAgfSwKCiAgLyoqCiAgICBTZXQgdGhlIHZhbHVlIG9mIGEgcHJvcGVydHkgdG8gdGhlIGN1cnJlbnQgdmFsdWUgcGx1cyBzb21lIGFtb3VudC4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICBwZXJzb24uaW5jcmVtZW50UHJvcGVydHkoJ2FnZScpOwogICAgdGVhbS5pbmNyZW1lbnRQcm9wZXJ0eSgnc2NvcmUnLCAyKTsKICAgIGBgYAoKICAgIEBtZXRob2QgaW5jcmVtZW50UHJvcGVydHkKICAgIEBwYXJhbSB7U3RyaW5nfSBrZXlOYW1lIFRoZSBuYW1lIG9mIHRoZSBwcm9wZXJ0eSB0byBpbmNyZW1lbnQKICAgIEBwYXJhbSB7TnVtYmVyfSBpbmNyZW1lbnQgVGhlIGFtb3VudCB0byBpbmNyZW1lbnQgYnkuIERlZmF1bHRzIHRvIDEKICAgIEByZXR1cm4ge051bWJlcn0gVGhlIG5ldyBwcm9wZXJ0eSB2YWx1ZQogICovCiAgaW5jcmVtZW50UHJvcGVydHk6IGZ1bmN0aW9uKGtleU5hbWUsIGluY3JlbWVudCkgewogICAgaWYgKEVtYmVyLmlzTm9uZShpbmNyZW1lbnQpKSB7IGluY3JlbWVudCA9IDE7IH0KICAgIEVtYmVyLmFzc2VydCgiTXVzdCBwYXNzIGEgbnVtZXJpYyB2YWx1ZSB0byBpbmNyZW1lbnRQcm9wZXJ0eSIsICghaXNOYU4ocGFyc2VGbG9hdChpbmNyZW1lbnQpKSAmJiBpc0Zpbml0ZShpbmNyZW1lbnQpKSk7CiAgICBzZXQodGhpcywga2V5TmFtZSwgKGdldCh0aGlzLCBrZXlOYW1lKSB8fCAwKSArIGluY3JlbWVudCk7CiAgICByZXR1cm4gZ2V0KHRoaXMsIGtleU5hbWUpOwogIH0sCgogIC8qKgogICAgU2V0IHRoZSB2YWx1ZSBvZiBhIHByb3BlcnR5IHRvIHRoZSBjdXJyZW50IHZhbHVlIG1pbnVzIHNvbWUgYW1vdW50LgoKICAgIGBgYGphdmFzY3JpcHQKICAgIHBsYXllci5kZWNyZW1lbnRQcm9wZXJ0eSgnbGl2ZXMnKTsKICAgIG9yYy5kZWNyZW1lbnRQcm9wZXJ0eSgnaGVhbHRoJywgNSk7CiAgICBgYGAKCiAgICBAbWV0aG9kIGRlY3JlbWVudFByb3BlcnR5CiAgICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZSBUaGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgdG8gZGVjcmVtZW50CiAgICBAcGFyYW0ge051bWJlcn0gZGVjcmVtZW50IFRoZSBhbW91bnQgdG8gZGVjcmVtZW50IGJ5LiBEZWZhdWx0cyB0byAxCiAgICBAcmV0dXJuIHtOdW1iZXJ9IFRoZSBuZXcgcHJvcGVydHkgdmFsdWUKICAqLwogIGRlY3JlbWVudFByb3BlcnR5OiBmdW5jdGlvbihrZXlOYW1lLCBkZWNyZW1lbnQpIHsKICAgIGlmIChFbWJlci5pc05vbmUoZGVjcmVtZW50KSkgeyBkZWNyZW1lbnQgPSAxOyB9CiAgICBFbWJlci5hc3NlcnQoIk11c3QgcGFzcyBhIG51bWVyaWMgdmFsdWUgdG8gZGVjcmVtZW50UHJvcGVydHkiLCAoIWlzTmFOKHBhcnNlRmxvYXQoZGVjcmVtZW50KSkgJiYgaXNGaW5pdGUoZGVjcmVtZW50KSkpOwogICAgc2V0KHRoaXMsIGtleU5hbWUsIChnZXQodGhpcywga2V5TmFtZSkgfHwgMCkgLSBkZWNyZW1lbnQpOwogICAgcmV0dXJuIGdldCh0aGlzLCBrZXlOYW1lKTsKICB9LAoKICAvKioKICAgIFNldCB0aGUgdmFsdWUgb2YgYSBib29sZWFuIHByb3BlcnR5IHRvIHRoZSBvcHBvc2l0ZSBvZiBpdCdzCiAgICBjdXJyZW50IHZhbHVlLgoKICAgIGBgYGphdmFzY3JpcHQKICAgIHN0YXJzaGlwLnRvZ2dsZVByb3BlcnR5KCd3YXJwRHJpdmVFbmdhZ2VkJyk7CiAgICBgYGAKCiAgICBAbWV0aG9kIHRvZ2dsZVByb3BlcnR5CiAgICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZSBUaGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgdG8gdG9nZ2xlCiAgICBAcmV0dXJuIHtPYmplY3R9IFRoZSBuZXcgcHJvcGVydHkgdmFsdWUKICAqLwogIHRvZ2dsZVByb3BlcnR5OiBmdW5jdGlvbihrZXlOYW1lKSB7CiAgICBzZXQodGhpcywga2V5TmFtZSwgIWdldCh0aGlzLCBrZXlOYW1lKSk7CiAgICByZXR1cm4gZ2V0KHRoaXMsIGtleU5hbWUpOwogIH0sCgogIC8qKgogICAgUmV0dXJucyB0aGUgY2FjaGVkIHZhbHVlIG9mIGEgY29tcHV0ZWQgcHJvcGVydHksIGlmIGl0IGV4aXN0cy4KICAgIFRoaXMgYWxsb3dzIHlvdSB0byBpbnNwZWN0IHRoZSB2YWx1ZSBvZiBhIGNvbXB1dGVkIHByb3BlcnR5CiAgICB3aXRob3V0IGFjY2lkZW50YWxseSBpbnZva2luZyBpdCBpZiBpdCBpcyBpbnRlbmRlZCB0byBiZQogICAgZ2VuZXJhdGVkIGxhemlseS4KCiAgICBAbWV0aG9kIGNhY2hlRm9yCiAgICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZQogICAgQHJldHVybiB7T2JqZWN0fSBUaGUgY2FjaGVkIHZhbHVlIG9mIHRoZSBjb21wdXRlZCBwcm9wZXJ0eSwgaWYgYW55CiAgKi8KICBjYWNoZUZvcjogZnVuY3Rpb24oa2V5TmFtZSkgewogICAgcmV0dXJuIEVtYmVyLmNhY2hlRm9yKHRoaXMsIGtleU5hbWUpOwogIH0sCgogIC8vIGludGVuZGVkIGZvciBkZWJ1Z2dpbmcgcHVycG9zZXMKICBvYnNlcnZlcnNGb3JLZXk6IGZ1bmN0aW9uKGtleU5hbWUpIHsKICAgIHJldHVybiBFbWJlci5vYnNlcnZlcnNGb3IodGhpcywga2V5TmFtZSk7CiAgfQp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCiAgQG1vZHVsZSBlbWJlcgogIEBzdWJtb2R1bGUgZW1iZXItcnVudGltZQoqLwoKCi8vIE5PVEU6IHRoaXMgb2JqZWN0IHNob3VsZCBuZXZlciBiZSBpbmNsdWRlZCBkaXJlY3RseS4gSW5zdGVhZCB1c2UgYEVtYmVyLk9iamVjdGAuCi8vIFdlIG9ubHkgZGVmaW5lIHRoaXMgc2VwYXJhdGVseSBzbyB0aGF0IGBFbWJlci5TZXRgIGNhbiBkZXBlbmQgb24gaXQuCgoKdmFyIHNldCA9IEVtYmVyLnNldCwgZ2V0ID0gRW1iZXIuZ2V0LAogICAgb19jcmVhdGUgPSBFbWJlci5jcmVhdGUsCiAgICBvX2RlZmluZVByb3BlcnR5ID0gRW1iZXIucGxhdGZvcm0uZGVmaW5lUHJvcGVydHksCiAgICBHVUlEX0tFWSA9IEVtYmVyLkdVSURfS0VZLAogICAgZ3VpZEZvciA9IEVtYmVyLmd1aWRGb3IsCiAgICBnZW5lcmF0ZUd1aWQgPSBFbWJlci5nZW5lcmF0ZUd1aWQsCiAgICBtZXRhID0gRW1iZXIubWV0YSwKICAgIHJld2F0Y2ggPSBFbWJlci5yZXdhdGNoLAogICAgZmluaXNoQ2hhaW5zID0gRW1iZXIuZmluaXNoQ2hhaW5zLAogICAgc2VuZEV2ZW50ID0gRW1iZXIuc2VuZEV2ZW50LAogICAgZGVzdHJveSA9IEVtYmVyLmRlc3Ryb3ksCiAgICBzY2hlZHVsZSA9IEVtYmVyLnJ1bi5zY2hlZHVsZSwKICAgIE1peGluID0gRW1iZXIuTWl4aW4sCiAgICBhcHBseU1peGluID0gTWl4aW4uX2FwcGx5LAogICAgZmluaXNoUGFydGlhbCA9IE1peGluLmZpbmlzaFBhcnRpYWwsCiAgICByZW9wZW4gPSBNaXhpbi5wcm90b3R5cGUucmVvcGVuLAogICAgTUFOREFUT1JZX1NFVFRFUiA9IEVtYmVyLkVOVi5NQU5EQVRPUllfU0VUVEVSLAogICAgaW5kZXhPZiA9IEVtYmVyLkVudW1lcmFibGVVdGlscy5pbmRleE9mOwoKdmFyIHVuZGVmaW5lZERlc2NyaXB0b3IgPSB7CiAgY29uZmlndXJhYmxlOiB0cnVlLAogIHdyaXRhYmxlOiB0cnVlLAogIGVudW1lcmFibGU6IGZhbHNlLAogIHZhbHVlOiB1bmRlZmluZWQKfTsKCmZ1bmN0aW9uIG1ha2VDdG9yKCkgewoKICAvLyBOb3RlOiBhdm9pZCBhY2Nlc3NpbmcgYW55IHByb3BlcnRpZXMgb24gdGhlIG9iamVjdCBzaW5jZSBpdCBtYWtlcyB0aGUKICAvLyBtZXRob2QgYSBsb3QgZmFzdGVyLiBUaGlzIGlzIGdsdWUgY29kZSBzbyB3ZSB3YW50IGl0IHRvIGJlIGFzIGZhc3QgYXMKICAvLyBwb3NzaWJsZS4KCiAgdmFyIHdhc0FwcGxpZWQgPSBmYWxzZSwgaW5pdE1peGlucywgaW5pdFByb3BlcnRpZXM7CgogIHZhciBDbGFzcyA9IGZ1bmN0aW9uKCkgewogICAgaWYgKCF3YXNBcHBsaWVkKSB7CiAgICAgIENsYXNzLnByb3RvKCk7IC8vIHByZXBhcmUgcHJvdG90eXBlLi4uCiAgICB9CiAgICBvX2RlZmluZVByb3BlcnR5KHRoaXMsIEdVSURfS0VZLCB1bmRlZmluZWREZXNjcmlwdG9yKTsKICAgIG9fZGVmaW5lUHJvcGVydHkodGhpcywgJ19zdXBlcicsIHVuZGVmaW5lZERlc2NyaXB0b3IpOwogICAgdmFyIG0gPSBtZXRhKHRoaXMpLCBwcm90byA9IG0ucHJvdG87CiAgICBtLnByb3RvID0gdGhpczsKICAgIGlmIChpbml0TWl4aW5zKSB7CiAgICAgIC8vIGNhcHR1cmUgbG9jYWxseSBzbyB3ZSBjYW4gY2xlYXIgdGhlIGNsb3NlZCBvdmVyIHZhcmlhYmxlCiAgICAgIHZhciBtaXhpbnMgPSBpbml0TWl4aW5zOwogICAgICBpbml0TWl4aW5zID0gbnVsbDsKICAgICAgdGhpcy5yZW9wZW4uYXBwbHkodGhpcywgbWl4aW5zKTsKICAgIH0KICAgIGlmIChpbml0UHJvcGVydGllcykgewogICAgICAvLyBjYXB0dXJlIGxvY2FsbHkgc28gd2UgY2FuIGNsZWFyIHRoZSBjbG9zZWQgb3ZlciB2YXJpYWJsZQogICAgICB2YXIgcHJvcHMgPSBpbml0UHJvcGVydGllczsKICAgICAgaW5pdFByb3BlcnRpZXMgPSBudWxsOwoKICAgICAgdmFyIGNvbmNhdGVuYXRlZFByb3BlcnRpZXMgPSB0aGlzLmNvbmNhdGVuYXRlZFByb3BlcnRpZXM7CgogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHByb3BzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHZhciBwcm9wZXJ0aWVzID0gcHJvcHNbaV07CgogICAgICAgIEVtYmVyLmFzc2VydCgiRW1iZXIuT2JqZWN0LmNyZWF0ZSBubyBsb25nZXIgc3VwcG9ydHMgbWl4aW5nIGluIG90aGVyIGRlZmluaXRpb25zLCB1c2UgY3JlYXRlV2l0aE1peGlucyBpbnN0ZWFkLiIsICEocHJvcGVydGllcyBpbnN0YW5jZW9mIEVtYmVyLk1peGluKSk7CgogICAgICAgIGlmICh0eXBlb2YgcHJvcGVydGllcyAhPT0gJ29iamVjdCcgJiYgcHJvcGVydGllcyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoIkVtYmVyLk9iamVjdC5jcmVhdGUgb25seSBhY2NlcHRzIG9iamVjdHMuIik7CiAgICAgICAgfQoKICAgICAgICBpZiAoIXByb3BlcnRpZXMpIHsgY29udGludWU7IH0KCiAgICAgICAgdmFyIGtleU5hbWVzID0gRW1iZXIua2V5cyhwcm9wZXJ0aWVzKTsKCiAgICAgICAgZm9yICh2YXIgaiA9IDAsIGxsID0ga2V5TmFtZXMubGVuZ3RoOyBqIDwgbGw7IGorKykgewogICAgICAgICAgdmFyIGtleU5hbWUgPSBrZXlOYW1lc1tqXTsKICAgICAgICAgIGlmICghcHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShrZXlOYW1lKSkgeyBjb250aW51ZTsgfQoKICAgICAgICAgIHZhciB2YWx1ZSA9IHByb3BlcnRpZXNba2V5TmFtZV0sCiAgICAgICAgICAgICAgSVNfQklORElORyA9IEVtYmVyLklTX0JJTkRJTkc7CgogICAgICAgICAgaWYgKElTX0JJTkRJTkcudGVzdChrZXlOYW1lKSkgewogICAgICAgICAgICB2YXIgYmluZGluZ3MgPSBtLmJpbmRpbmdzOwogICAgICAgICAgICBpZiAoIWJpbmRpbmdzKSB7CiAgICAgICAgICAgICAgYmluZGluZ3MgPSBtLmJpbmRpbmdzID0ge307CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIW0uaGFzT3duUHJvcGVydHkoJ2JpbmRpbmdzJykpIHsKICAgICAgICAgICAgICBiaW5kaW5ncyA9IG0uYmluZGluZ3MgPSBvX2NyZWF0ZShtLmJpbmRpbmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBiaW5kaW5nc1trZXlOYW1lXSA9IHZhbHVlOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBkZXNjID0gbS5kZXNjc1trZXlOYW1lXTsKCiAgICAgICAgICBFbWJlci5hc3NlcnQoIkVtYmVyLk9iamVjdC5jcmVhdGUgbm8gbG9uZ2VyIHN1cHBvcnRzIGRlZmluaW5nIGNvbXB1dGVkIHByb3BlcnRpZXMuIiwgISh2YWx1ZSBpbnN0YW5jZW9mIEVtYmVyLkNvbXB1dGVkUHJvcGVydHkpKTsKICAgICAgICAgIEVtYmVyLmFzc2VydCgiRW1iZXIuT2JqZWN0LmNyZWF0ZSBubyBsb25nZXIgc3VwcG9ydHMgZGVmaW5pbmcgbWV0aG9kcyB0aGF0IGNhbGwgX3N1cGVyLiIsICEodHlwZW9mIHZhbHVlID09PSAnZnVuY3Rpb24nICYmIHZhbHVlLnRvU3RyaW5nKCkuaW5kZXhPZignLl9zdXBlcicpICE9PSAtMSkpOwogICAgICAgICAgRW1iZXIuYXNzZXJ0KCJgYWN0aW9uc2AgbXVzdCBiZSBwcm92aWRlZCBhdCBleHRlbmQgdGltZSwgbm90IGF0IGNyZWF0ZSAiICsKICAgICAgICAgICAgICAgICAgICAgICAidGltZSwgd2hlbiBFbWJlci5BY3Rpb25IYW5kbGVyIGlzIHVzZWQgKGkuZS4gdmlld3MsICIgKwogICAgICAgICAgICAgICAgICAgICAgICJjb250cm9sbGVycyAmIHJvdXRlcykuIiwgISgoa2V5TmFtZSA9PT0gJ2FjdGlvbnMnKSAmJiBFbWJlci5BY3Rpb25IYW5kbGVyLmRldGVjdCh0aGlzKSkpOwoKICAgICAgICAgIGlmIChjb25jYXRlbmF0ZWRQcm9wZXJ0aWVzICYmIGluZGV4T2YoY29uY2F0ZW5hdGVkUHJvcGVydGllcywga2V5TmFtZSkgPj0gMCkgewogICAgICAgICAgICB2YXIgYmFzZVZhbHVlID0gdGhpc1trZXlOYW1lXTsKCiAgICAgICAgICAgIGlmIChiYXNlVmFsdWUpIHsKICAgICAgICAgICAgICBpZiAoJ2Z1bmN0aW9uJyA9PT0gdHlwZW9mIGJhc2VWYWx1ZS5jb25jYXQpIHsKICAgICAgICAgICAgICAgIHZhbHVlID0gYmFzZVZhbHVlLmNvbmNhdCh2YWx1ZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhbHVlID0gRW1iZXIubWFrZUFycmF5KGJhc2VWYWx1ZSkuY29uY2F0KHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFsdWUgPSBFbWJlci5tYWtlQXJyYXkodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGRlc2MpIHsKICAgICAgICAgICAgZGVzYy5zZXQodGhpcywga2V5TmFtZSwgdmFsdWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLnNldFVua25vd25Qcm9wZXJ0eSA9PT0gJ2Z1bmN0aW9uJyAmJiAhKGtleU5hbWUgaW4gdGhpcykpIHsKICAgICAgICAgICAgICB0aGlzLnNldFVua25vd25Qcm9wZXJ0eShrZXlOYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoTUFOREFUT1JZX1NFVFRFUikgewogICAgICAgICAgICAgIEVtYmVyLmRlZmluZVByb3BlcnR5KHRoaXMsIGtleU5hbWUsIG51bGwsIHZhbHVlKTsgLy8gc2V0dXAgbWFuZGF0b3J5IHNldHRlcgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXNba2V5TmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZmluaXNoUGFydGlhbCh0aGlzLCBtKTsKICAgIHRoaXMuaW5pdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgbS5wcm90byA9IHByb3RvOwogICAgZmluaXNoQ2hhaW5zKHRoaXMpOwogICAgc2VuZEV2ZW50KHRoaXMsICJpbml0Iik7CiAgfTsKCiAgQ2xhc3MudG9TdHJpbmcgPSBNaXhpbi5wcm90b3R5cGUudG9TdHJpbmc7CiAgQ2xhc3Mud2lsbFJlb3BlbiA9IGZ1bmN0aW9uKCkgewogICAgaWYgKHdhc0FwcGxpZWQpIHsKICAgICAgQ2xhc3MuUHJvdG90eXBlTWl4aW4gPSBNaXhpbi5jcmVhdGUoQ2xhc3MuUHJvdG90eXBlTWl4aW4pOwogICAgfQoKICAgIHdhc0FwcGxpZWQgPSBmYWxzZTsKICB9OwogIENsYXNzLl9pbml0TWl4aW5zID0gZnVuY3Rpb24oYXJncykgeyBpbml0TWl4aW5zID0gYXJnczsgfTsKICBDbGFzcy5faW5pdFByb3BlcnRpZXMgPSBmdW5jdGlvbihhcmdzKSB7IGluaXRQcm9wZXJ0aWVzID0gYXJnczsgfTsKCiAgQ2xhc3MucHJvdG8gPSBmdW5jdGlvbigpIHsKICAgIHZhciBzdXBlcmNsYXNzID0gQ2xhc3Muc3VwZXJjbGFzczsKICAgIGlmIChzdXBlcmNsYXNzKSB7IHN1cGVyY2xhc3MucHJvdG8oKTsgfQoKICAgIGlmICghd2FzQXBwbGllZCkgewogICAgICB3YXNBcHBsaWVkID0gdHJ1ZTsKICAgICAgQ2xhc3MuUHJvdG90eXBlTWl4aW4uYXBwbHlQYXJ0aWFsKENsYXNzLnByb3RvdHlwZSk7CiAgICAgIHJld2F0Y2goQ2xhc3MucHJvdG90eXBlKTsKICAgIH0KCiAgICByZXR1cm4gdGhpcy5wcm90b3R5cGU7CiAgfTsKCiAgcmV0dXJuIENsYXNzOwoKfQoKLyoqCiAgQGNsYXNzIENvcmVPYmplY3QKICBAbmFtZXNwYWNlIEVtYmVyCiovCnZhciBDb3JlT2JqZWN0ID0gbWFrZUN0b3IoKTsKQ29yZU9iamVjdC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gIkVtYmVyLkNvcmVPYmplY3QiOyB9OwoKQ29yZU9iamVjdC5Qcm90b3R5cGVNaXhpbiA9IE1peGluLmNyZWF0ZSh7CiAgcmVvcGVuOiBmdW5jdGlvbigpIHsKICAgIGFwcGx5TWl4aW4odGhpcywgYXJndW1lbnRzLCB0cnVlKTsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAgQW4gb3ZlcnJpZGFibGUgbWV0aG9kIGNhbGxlZCB3aGVuIG9iamVjdHMgYXJlIGluc3RhbnRpYXRlZC4gQnkgZGVmYXVsdCwKICAgIGRvZXMgbm90aGluZyB1bmxlc3MgaXQgaXMgb3ZlcnJpZGRlbiBkdXJpbmcgY2xhc3MgZGVmaW5pdGlvbi4KCiAgICBFeGFtcGxlOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIEFwcC5QZXJzb24gPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgYWxlcnQoJ05hbWUgaXMgJyArIHRoaXMuZ2V0KCduYW1lJykpOwogICAgICB9CiAgICB9KTsKCiAgICB2YXIgc3RldmUgPSBBcHAuUGVyc29uLmNyZWF0ZSh7CiAgICAgIG5hbWU6ICJTdGV2ZSIKICAgIH0pOwoKICAgIC8vIGFsZXJ0cyAnTmFtZSBpcyBTdGV2ZScuCiAgICBgYGAKCiAgICBOT1RFOiBJZiB5b3UgZG8gb3ZlcnJpZGUgYGluaXRgIGZvciBhIGZyYW1ld29yayBjbGFzcyBsaWtlIGBFbWJlci5WaWV3YCBvcgogICAgYEVtYmVyLkFycmF5Q29udHJvbGxlcmAsIGJlIHN1cmUgdG8gY2FsbCBgdGhpcy5fc3VwZXIoKWAgaW4geW91cgogICAgYGluaXRgIGRlY2xhcmF0aW9uISBJZiB5b3UgZG9uJ3QsIEVtYmVyIG1heSBub3QgaGF2ZSBhbiBvcHBvcnR1bml0eSB0bwogICAgZG8gaW1wb3J0YW50IHNldHVwIHdvcmssIGFuZCB5b3UnbGwgc2VlIHN0cmFuZ2UgYmVoYXZpb3IgaW4geW91cgogICAgYXBwbGljYXRpb24uCgogICAgQG1ldGhvZCBpbml0CiAgKi8KICBpbml0OiBmdW5jdGlvbigpIHt9LAoKICAvKioKICAgIERlZmluZXMgdGhlIHByb3BlcnRpZXMgdGhhdCB3aWxsIGJlIGNvbmNhdGVuYXRlZCBmcm9tIHRoZSBzdXBlcmNsYXNzCiAgICAoaW5zdGVhZCBvZiBvdmVycmlkZGVuKS4KCiAgICBCeSBkZWZhdWx0LCB3aGVuIHlvdSBleHRlbmQgYW4gRW1iZXIgY2xhc3MgYSBwcm9wZXJ0eSBkZWZpbmVkIGluCiAgICB0aGUgc3ViY2xhc3Mgb3ZlcnJpZGVzIGEgcHJvcGVydHkgd2l0aCB0aGUgc2FtZSBuYW1lIHRoYXQgaXMgZGVmaW5lZAogICAgaW4gdGhlIHN1cGVyY2xhc3MuIEhvd2V2ZXIsIHRoZXJlIGFyZSBzb21lIGNhc2VzIHdoZXJlIGl0IGlzIHByZWZlcmFibGUKICAgIHRvIGJ1aWxkIHVwIGEgcHJvcGVydHkncyB2YWx1ZSBieSBjb21iaW5pbmcgdGhlIHN1cGVyY2xhc3MnIHByb3BlcnR5CiAgICB2YWx1ZSB3aXRoIHRoZSBzdWJjbGFzcycgdmFsdWUuIEFuIGV4YW1wbGUgb2YgdGhpcyBpbiB1c2Ugd2l0aGluIEVtYmVyCiAgICBpcyB0aGUgYGNsYXNzTmFtZXNgIHByb3BlcnR5IG9mIGBFbWJlci5WaWV3YC4KCiAgICBIZXJlIGlzIHNvbWUgc2FtcGxlIGNvZGUgc2hvd2luZyB0aGUgZGlmZmVyZW5jZSBiZXR3ZWVuIGEgY29uY2F0ZW5hdGVkCiAgICBwcm9wZXJ0eSBhbmQgYSBub3JtYWwgb25lOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIEFwcC5CYXJWaWV3ID0gRW1iZXIuVmlldy5leHRlbmQoewogICAgICBzb21lTm9uQ29uY2F0ZW5hdGVkUHJvcGVydHk6IFsnYmFyJ10sCiAgICAgIGNsYXNzTmFtZXM6IFsnYmFyJ10KICAgIH0pOwoKICAgIEFwcC5Gb29CYXJWaWV3ID0gQXBwLkJhclZpZXcuZXh0ZW5kKHsKICAgICAgc29tZU5vbkNvbmNhdGVuYXRlZFByb3BlcnR5OiBbJ2ZvbyddLAogICAgICBjbGFzc05hbWVzOiBbJ2ZvbyddLAogICAgfSk7CgogICAgdmFyIGZvb0JhclZpZXcgPSBBcHAuRm9vQmFyVmlldy5jcmVhdGUoKTsKICAgIGZvb0JhclZpZXcuZ2V0KCdzb21lTm9uQ29uY2F0ZW5hdGVkUHJvcGVydHknKTsgLy8gWydmb28nXQogICAgZm9vQmFyVmlldy5nZXQoJ2NsYXNzTmFtZXMnKTsgLy8gWydlbWJlci12aWV3JywgJ2JhcicsICdmb28nXQogICAgYGBgCgogICAgVGhpcyBiZWhhdmlvciBleHRlbmRzIHRvIG9iamVjdCBjcmVhdGlvbiBhcyB3ZWxsLiBDb250aW51aW5nIHRoZQogICAgYWJvdmUgZXhhbXBsZToKCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgdmlldyA9IEFwcC5Gb29CYXJWaWV3LmNyZWF0ZSh7CiAgICAgIHNvbWVOb25Db25jYXRlbmF0ZWRQcm9wZXJ0eTogWydiYXonXSwKICAgICAgY2xhc3NOYW1lczogWydiYXonXQogICAgfSkKICAgIHZpZXcuZ2V0KCdzb21lTm9uQ29uY2F0ZW5hdGVkUHJvcGVydHknKTsgLy8gWydiYXonXQogICAgdmlldy5nZXQoJ2NsYXNzTmFtZXMnKTsgLy8gWydlbWJlci12aWV3JywgJ2JhcicsICdmb28nLCAnYmF6J10KICAgIGBgYAogICAgQWRkaW5nIGEgc2luZ2xlIHByb3BlcnR5IHRoYXQgaXMgbm90IGFuIGFycmF5IHdpbGwganVzdCBhZGQgaXQgaW4gdGhlIGFycmF5OgoKICAgIGBgYGphdmFzY3JpcHQKICAgIHZhciB2aWV3ID0gQXBwLkZvb0JhclZpZXcuY3JlYXRlKHsKICAgICAgY2xhc3NOYW1lczogJ2JheicKICAgIH0pCiAgICB2aWV3LmdldCgnY2xhc3NOYW1lcycpOyAvLyBbJ2VtYmVyLXZpZXcnLCAnYmFyJywgJ2ZvbycsICdiYXonXQogICAgYGBgCgogICAgVXNpbmcgdGhlIGBjb25jYXRlbmF0ZWRQcm9wZXJ0aWVzYCBwcm9wZXJ0eSwgd2UgY2FuIHRlbGwgdG8gRW1iZXIgdGhhdCBtaXgKICAgIHRoZSBjb250ZW50IG9mIHRoZSBwcm9wZXJ0aWVzLgoKICAgIEluIGBFbWJlci5WaWV3YCB0aGUgYGNsYXNzTmFtZUJpbmRpbmdzYCBhbmQgYGF0dHJpYnV0ZUJpbmRpbmdzYCBwcm9wZXJ0aWVzCiAgICBhcmUgYWxzbyBjb25jYXRlbmF0ZWQsIGluIGFkZGl0aW9uIHRvIGBjbGFzc05hbWVzYC4KCiAgICBUaGlzIGZlYXR1cmUgaXMgYXZhaWxhYmxlIGZvciB5b3UgdG8gdXNlIHRocm91Z2hvdXQgdGhlIEVtYmVyIG9iamVjdCBtb2RlbCwKICAgIGFsdGhvdWdoIHR5cGljYWwgYXBwIGRldmVsb3BlcnMgYXJlIGxpa2VseSB0byB1c2UgaXQgaW5mcmVxdWVudGx5LiBTaW5jZQogICAgaXQgY2hhbmdlcyBleHBlY3RhdGlvbnMgYWJvdXQgYmVoYXZpb3Igb2YgcHJvcGVydGllcywgeW91IHNob3VsZCBwcm9wZXJseQogICAgZG9jdW1lbnQgaXRzIHVzYWdlIGluIGVhY2ggaW5kaXZpZHVhbCBjb25jYXRlbmF0ZWQgcHJvcGVydHkgKHRvIG5vdAogICAgbWlzbGVhZCB5b3VyIHVzZXJzIHRvIHRoaW5rIHRoZXkgY2FuIG92ZXJyaWRlIHRoZSBwcm9wZXJ0eSBpbiBhIHN1YmNsYXNzKS4KCiAgICBAcHJvcGVydHkgY29uY2F0ZW5hdGVkUHJvcGVydGllcwogICAgQHR5cGUgQXJyYXkKICAgIEBkZWZhdWx0IG51bGwKICAqLwogIGNvbmNhdGVuYXRlZFByb3BlcnRpZXM6IG51bGwsCgogIC8qKgogICAgRGVzdHJveWVkIG9iamVjdCBwcm9wZXJ0eSBmbGFnLgoKICAgIGlmIHRoaXMgcHJvcGVydHkgaXMgYHRydWVgIHRoZSBvYnNlcnZlcnMgYW5kIGJpbmRpbmdzIHdlcmUgYWxyZWFkeQogICAgcmVtb3ZlZCBieSB0aGUgZWZmZWN0IG9mIGNhbGxpbmcgdGhlIGBkZXN0cm95KClgIG1ldGhvZC4KCiAgICBAcHJvcGVydHkgaXNEZXN0cm95ZWQKICAgIEBkZWZhdWx0IGZhbHNlCiAgKi8KICBpc0Rlc3Ryb3llZDogZmFsc2UsCgogIC8qKgogICAgRGVzdHJ1Y3Rpb24gc2NoZWR1bGVkIGZsYWcuIFRoZSBgZGVzdHJveSgpYCBtZXRob2QgaGFzIGJlZW4gY2FsbGVkLgoKICAgIFRoZSBvYmplY3Qgc3RheXMgaW50YWN0IHVudGlsIHRoZSBlbmQgb2YgdGhlIHJ1biBsb29wIGF0IHdoaWNoIHBvaW50CiAgICB0aGUgYGlzRGVzdHJveWVkYCBmbGFnIGlzIHNldC4KCiAgICBAcHJvcGVydHkgaXNEZXN0cm95aW5nCiAgICBAZGVmYXVsdCBmYWxzZQogICovCiAgaXNEZXN0cm95aW5nOiBmYWxzZSwKCiAgLyoqCiAgICBEZXN0cm95cyBhbiBvYmplY3QgYnkgc2V0dGluZyB0aGUgYGlzRGVzdHJveWVkYCBmbGFnIGFuZCByZW1vdmluZyBpdHMKICAgIG1ldGFkYXRhLCB3aGljaCBlZmZlY3RpdmVseSBkZXN0cm95cyBvYnNlcnZlcnMgYW5kIGJpbmRpbmdzLgoKICAgIElmIHlvdSB0cnkgdG8gc2V0IGEgcHJvcGVydHkgb24gYSBkZXN0cm95ZWQgb2JqZWN0LCBhbiBleGNlcHRpb24gd2lsbCBiZQogICAgcmFpc2VkLgoKICAgIE5vdGUgdGhhdCBkZXN0cnVjdGlvbiBpcyBzY2hlZHVsZWQgZm9yIHRoZSBlbmQgb2YgdGhlIHJ1biBsb29wIGFuZCBkb2VzIG5vdAogICAgaGFwcGVuIGltbWVkaWF0ZWx5LiAgSXQgd2lsbCBzZXQgYW4gaXNEZXN0cm95aW5nIGZsYWcgaW1tZWRpYXRlbHkuCgogICAgQG1ldGhvZCBkZXN0cm95CiAgICBAcmV0dXJuIHtFbWJlci5PYmplY3R9IHJlY2VpdmVyCiAgKi8KICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLmlzRGVzdHJveWluZykgeyByZXR1cm47IH0KICAgIHRoaXMuaXNEZXN0cm95aW5nID0gdHJ1ZTsKCiAgICBzY2hlZHVsZSgnYWN0aW9ucycsIHRoaXMsIHRoaXMud2lsbERlc3Ryb3kpOwogICAgc2NoZWR1bGUoJ2Rlc3Ryb3knLCB0aGlzLCB0aGlzLl9zY2hlZHVsZWREZXN0cm95KTsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAgT3ZlcnJpZGUgdG8gaW1wbGVtZW50IHRlYXJkb3duLgoKICAgIEBtZXRob2Qgd2lsbERlc3Ryb3kKICAgKi8KICB3aWxsRGVzdHJveTogRW1iZXIuSywKCiAgLyoqCiAgICBJbnZva2VkIGJ5IHRoZSBydW4gbG9vcCB0byBhY3R1YWxseSBkZXN0cm95IHRoZSBvYmplY3QuIFRoaXMgaXMKICAgIHNjaGVkdWxlZCBmb3IgZXhlY3V0aW9uIGJ5IHRoZSBgZGVzdHJveWAgbWV0aG9kLgoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIF9zY2hlZHVsZWREZXN0cm95CiAgKi8KICBfc2NoZWR1bGVkRGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5pc0Rlc3Ryb3llZCkgeyByZXR1cm47IH0KICAgIGRlc3Ryb3kodGhpcyk7CiAgICB0aGlzLmlzRGVzdHJveWVkID0gdHJ1ZTsKICB9LAoKICBiaW5kOiBmdW5jdGlvbih0bywgZnJvbSkgewogICAgaWYgKCEoZnJvbSBpbnN0YW5jZW9mIEVtYmVyLkJpbmRpbmcpKSB7IGZyb20gPSBFbWJlci5CaW5kaW5nLmZyb20oZnJvbSk7IH0KICAgIGZyb20udG8odG8pLmNvbm5lY3QodGhpcyk7CiAgICByZXR1cm4gZnJvbTsKICB9LAoKICAvKioKICAgIFJldHVybnMgYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gd2hpY2ggYXR0ZW1wdHMgdG8gcHJvdmlkZSBtb3JlIGluZm9ybWF0aW9uCiAgICB0aGFuIEphdmFzY3JpcHQncyBgdG9TdHJpbmdgIHR5cGljYWxseSBkb2VzLCBpbiBhIGdlbmVyaWMgd2F5IGZvciBhbGwgRW1iZXIKICAgIG9iamVjdHMuCgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLlBlcnNvbiA9IEVtLk9iamVjdC5leHRlbmQoKQogICAgcGVyc29uID0gQXBwLlBlcnNvbi5jcmVhdGUoKQogICAgcGVyc29uLnRvU3RyaW5nKCkgLy89PiAiPEFwcC5QZXJzb246ZW1iZXIxMDI0PiIKICAgIGBgYAoKICAgIElmIHRoZSBvYmplY3QncyBjbGFzcyBpcyBub3QgZGVmaW5lZCBvbiBhbiBFbWJlciBuYW1lc3BhY2UsIGl0IHdpbGwKICAgIGluZGljYXRlIGl0IGlzIGEgc3ViY2xhc3Mgb2YgdGhlIHJlZ2lzdGVyZWQgc3VwZXJjbGFzczoKCiAgIGBgYGphdmFzY3JpcHQKICAgIFN0dWRlbnQgPSBBcHAuUGVyc29uLmV4dGVuZCgpCiAgICBzdHVkZW50ID0gU3R1ZGVudC5jcmVhdGUoKQogICAgc3R1ZGVudC50b1N0cmluZygpIC8vPT4gIjwoc3ViY2xhc3Mgb2YgQXBwLlBlcnNvbik6ZW1iZXIxMDI1PiIKICAgIGBgYAoKICAgIElmIHRoZSBtZXRob2QgYHRvU3RyaW5nRXh0ZW5zaW9uYCBpcyBkZWZpbmVkLCBpdHMgcmV0dXJuIHZhbHVlIHdpbGwgYmUKICAgIGluY2x1ZGVkIGluIHRoZSBvdXRwdXQuCgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLlRlYWNoZXIgPSBBcHAuUGVyc29uLmV4dGVuZCh7CiAgICAgIHRvU3RyaW5nRXh0ZW5zaW9uOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXQoJ2Z1bGxOYW1lJyk7CiAgICAgIH0KICAgIH0pOwogICAgdGVhY2hlciA9IEFwcC5UZWFjaGVyLmNyZWF0ZSgpCiAgICB0ZWFjaGVyLnRvU3RyaW5nKCk7IC8vPT4gIjxBcHAuVGVhY2hlcjplbWJlcjEwMjY6VG9tIERhbGU+IgogICAgYGBgCgogICAgQG1ldGhvZCB0b1N0cmluZwogICAgQHJldHVybiB7U3RyaW5nfSBzdHJpbmcgcmVwcmVzZW50YXRpb24KICAqLwogIHRvU3RyaW5nOiBmdW5jdGlvbiB0b1N0cmluZygpIHsKICAgIHZhciBoYXNUb1N0cmluZ0V4dGVuc2lvbiA9IHR5cGVvZiB0aGlzLnRvU3RyaW5nRXh0ZW5zaW9uID09PSAnZnVuY3Rpb24nLAogICAgICAgIGV4dGVuc2lvbiA9IGhhc1RvU3RyaW5nRXh0ZW5zaW9uID8gIjoiICsgdGhpcy50b1N0cmluZ0V4dGVuc2lvbigpIDogJyc7CiAgICB2YXIgcmV0ID0gJzwnK3RoaXMuY29uc3RydWN0b3IudG9TdHJpbmcoKSsnOicrZ3VpZEZvcih0aGlzKStleHRlbnNpb24rJz4nOwogICAgdGhpcy50b1N0cmluZyA9IG1ha2VUb1N0cmluZyhyZXQpOwogICAgcmV0dXJuIHJldDsKICB9Cn0pOwoKQ29yZU9iamVjdC5Qcm90b3R5cGVNaXhpbi5vd25lckNvbnN0cnVjdG9yID0gQ29yZU9iamVjdDsKCmZ1bmN0aW9uIG1ha2VUb1N0cmluZyhyZXQpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7IHJldHVybiByZXQ7IH07Cn0KCmlmIChFbWJlci5jb25maWcub3ZlcnJpZGVQcm90b3R5cGVNaXhpbikgewogIEVtYmVyLmNvbmZpZy5vdmVycmlkZVByb3RvdHlwZU1peGluKENvcmVPYmplY3QuUHJvdG90eXBlTWl4aW4pOwp9CgpDb3JlT2JqZWN0Ll9fc3VwZXJfXyA9IG51bGw7Cgp2YXIgQ2xhc3NNaXhpbiA9IE1peGluLmNyZWF0ZSh7CgogIENsYXNzTWl4aW46IEVtYmVyLnJlcXVpcmVkKCksCgogIFByb3RvdHlwZU1peGluOiBFbWJlci5yZXF1aXJlZCgpLAoKICBpc0NsYXNzOiB0cnVlLAoKICBpc01ldGhvZDogZmFsc2UsCgogIC8qKgogICAgQ3JlYXRlcyBhIG5ldyBzdWJjbGFzcy4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuUGVyc29uID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CiAgICAgIHNheTogZnVuY3Rpb24odGhpbmcpIHsKICAgICAgICBhbGVydCh0aGluZyk7CiAgICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgIFRoaXMgZGVmaW5lcyBhIG5ldyBzdWJjbGFzcyBvZiBFbWJlci5PYmplY3Q6IGBBcHAuUGVyc29uYC4gSXQgY29udGFpbnMgb25lIG1ldGhvZDogYHNheSgpYC4KCiAgICBZb3UgY2FuIGFsc28gY3JlYXRlIGEgc3ViY2xhc3MgZnJvbSBhbnkgZXhpc3RpbmcgY2xhc3MgYnkgY2FsbGluZyBpdHMgYGV4dGVuZCgpYCAgbWV0aG9kLiBGb3IgZXhhbXBsZSwgeW91IG1pZ2h0IHdhbnQgdG8gY3JlYXRlIGEgc3ViY2xhc3Mgb2YgRW1iZXIncyBidWlsdC1pbiBgRW1iZXIuVmlld2AgY2xhc3M6CgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLlBlcnNvblZpZXcgPSBFbWJlci5WaWV3LmV4dGVuZCh7CiAgICAgIHRhZ05hbWU6ICdsaScsCiAgICAgIGNsYXNzTmFtZUJpbmRpbmdzOiBbJ2lzQWRtaW5pc3RyYXRvciddCiAgICB9KTsKICAgIGBgYAoKICAgIFdoZW4gZGVmaW5pbmcgYSBzdWJjbGFzcywgeW91IGNhbiBvdmVycmlkZSBtZXRob2RzIGJ1dCBzdGlsbCBhY2Nlc3MgdGhlIGltcGxlbWVudGF0aW9uIG9mIHlvdXIgcGFyZW50IGNsYXNzIGJ5IGNhbGxpbmcgdGhlIHNwZWNpYWwgYF9zdXBlcigpYCBtZXRob2Q6CgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLlBlcnNvbiA9IEVtYmVyLk9iamVjdC5leHRlbmQoewogICAgICBzYXk6IGZ1bmN0aW9uKHRoaW5nKSB7CiAgICAgICAgdmFyIG5hbWUgPSB0aGlzLmdldCgnbmFtZScpOwogICAgICAgIGFsZXJ0KG5hbWUgKyAnIHNheXM6ICcgKyB0aGluZyk7CiAgICAgIH0KICAgIH0pOwoKICAgIEFwcC5Tb2xkaWVyID0gQXBwLlBlcnNvbi5leHRlbmQoewogICAgICBzYXk6IGZ1bmN0aW9uKHRoaW5nKSB7CiAgICAgICAgdGhpcy5fc3VwZXIodGhpbmcgKyAiLCBzaXIhIik7CiAgICAgIH0sCiAgICAgIG1hcmNoOiBmdW5jdGlvbihudW1iZXJPZkhvdXJzKSB7CiAgICAgICAgYWxlcnQodGhpcy5nZXQoJ25hbWUnKSArICcgbWFyY2hlcyBmb3IgJyArIG51bWJlck9mSG91cnMgKyAnIGhvdXJzLicpCiAgICAgIH0KICAgIH0pOwoKICAgIHZhciB5ZWh1ZGEgPSBBcHAuU29sZGllci5jcmVhdGUoewogICAgICBuYW1lOiAiWWVodWRhIEthdHoiCiAgICB9KTsKCiAgICB5ZWh1ZGEuc2F5KCJZZXMiKTsgIC8vIGFsZXJ0cyAiWWVodWRhIEthdHogc2F5czogWWVzLCBzaXIhIgogICAgYGBgCgogICAgVGhlIGBjcmVhdGUoKWAgb24gbGluZSAjMTcgY3JlYXRlcyBhbiAqaW5zdGFuY2UqIG9mIHRoZSBgQXBwLlNvbGRpZXJgIGNsYXNzLiBUaGUgYGV4dGVuZCgpYCBvbiBsaW5lICM4IGNyZWF0ZXMgYSAqc3ViY2xhc3MqIG9mIGBBcHAuUGVyc29uYC4gQW55IGluc3RhbmNlIG9mIHRoZSBgQXBwLlBlcnNvbmAgY2xhc3Mgd2lsbCAqbm90KiBoYXZlIHRoZSBgbWFyY2goKWAgbWV0aG9kLgoKICAgIFlvdSBjYW4gYWxzbyBwYXNzIGBFbWJlci5NaXhpbmAgY2xhc3NlcyB0byBhZGQgYWRkaXRpb25hbCBwcm9wZXJ0aWVzIHRvIHRoZSBzdWJjbGFzcy4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuUGVyc29uID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CiAgICAgIHNheTogZnVuY3Rpb24odGhpbmcpIHsKICAgICAgICBhbGVydCh0aGlzLmdldCgnbmFtZScpICsgJyBzYXlzOiAnICsgdGhpbmcpOwogICAgICB9CiAgICB9KTsKCiAgICBBcHAuU2luZ2luZ01peGluID0gRW1iZXIuTWl4aW4uY3JlYXRlKHsKICAgICAgc2luZzogZnVuY3Rpb24odGhpbmcpewogICAgICAgIGFsZXJ0KHRoaXMuZ2V0KCduYW1lJykgKyAnIHNpbmdzOiBsYSBsYSBsYSAnICsgdGhpbmcpOwogICAgICB9CiAgICB9KTsKCiAgICBBcHAuQnJvYWR3YXlTdGFyID0gQXBwLlBlcnNvbi5leHRlbmQoQXBwLlNpbmdpbmdNaXhpbiwgewogICAgICBkYW5jZTogZnVuY3Rpb24oKSB7CiAgICAgICAgYWxlcnQodGhpcy5nZXQoJ25hbWUnKSArICcgZGFuY2VzOiB0YXAgdGFwIHRhcCB0YXAgJyk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgVGhlIGBBcHAuQnJvYWR3YXlTdGFyYCBjbGFzcyBjb250YWlucyB0aHJlZSBtZXRob2RzOiBgc2F5KClgLCBgc2luZygpYCwgYW5kIGBkYW5jZSgpYC4KCiAgICBAbWV0aG9kIGV4dGVuZAogICAgQHN0YXRpYwoKICAgIEBwYXJhbSB7RW1iZXIuTWl4aW59IFttaXhpbnNdKiBPbmUgb3IgbW9yZSBFbWJlci5NaXhpbiBjbGFzc2VzCiAgICBAcGFyYW0ge09iamVjdH0gW2FyZ3VtZW50c10qIE9iamVjdCBjb250YWluaW5nIHZhbHVlcyB0byB1c2Ugd2l0aGluIHRoZSBuZXcgY2xhc3MKICAqLwogIGV4dGVuZDogZnVuY3Rpb24oKSB7CiAgICB2YXIgQ2xhc3MgPSBtYWtlQ3RvcigpLCBwcm90bzsKICAgIENsYXNzLkNsYXNzTWl4aW4gPSBNaXhpbi5jcmVhdGUodGhpcy5DbGFzc01peGluKTsKICAgIENsYXNzLlByb3RvdHlwZU1peGluID0gTWl4aW4uY3JlYXRlKHRoaXMuUHJvdG90eXBlTWl4aW4pOwoKICAgIENsYXNzLkNsYXNzTWl4aW4ub3duZXJDb25zdHJ1Y3RvciA9IENsYXNzOwogICAgQ2xhc3MuUHJvdG90eXBlTWl4aW4ub3duZXJDb25zdHJ1Y3RvciA9IENsYXNzOwoKICAgIHJlb3Blbi5hcHBseShDbGFzcy5Qcm90b3R5cGVNaXhpbiwgYXJndW1lbnRzKTsKCiAgICBDbGFzcy5zdXBlcmNsYXNzID0gdGhpczsKICAgIENsYXNzLl9fc3VwZXJfXyAgPSB0aGlzLnByb3RvdHlwZTsKCiAgICBwcm90byA9IENsYXNzLnByb3RvdHlwZSA9IG9fY3JlYXRlKHRoaXMucHJvdG90eXBlKTsKICAgIHByb3RvLmNvbnN0cnVjdG9yID0gQ2xhc3M7CiAgICBnZW5lcmF0ZUd1aWQocHJvdG8pOwogICAgbWV0YShwcm90bykucHJvdG8gPSBwcm90bzsgLy8gdGhpcyB3aWxsIGRpc2FibGUgb2JzZXJ2ZXJzIG9uIHByb3RvdHlwZQoKICAgIENsYXNzLkNsYXNzTWl4aW4uYXBwbHkoQ2xhc3MpOwogICAgcmV0dXJuIENsYXNzOwogIH0sCgogIC8qKgogICAgRXF1aXZhbGVudCB0byBkb2luZyBgZXh0ZW5kKGFyZ3VtZW50cykuY3JlYXRlKClgLgogICAgSWYgcG9zc2libGUgdXNlIHRoZSBub3JtYWwgYGNyZWF0ZWAgbWV0aG9kIGluc3RlYWQuCgogICAgQG1ldGhvZCBjcmVhdGVXaXRoTWl4aW5zCiAgICBAc3RhdGljCiAgICBAcGFyYW0gW2FyZ3VtZW50c10qCiAgKi8KICBjcmVhdGVXaXRoTWl4aW5zOiBmdW5jdGlvbigpIHsKICAgIHZhciBDID0gdGhpczsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoPjApIHsgdGhpcy5faW5pdE1peGlucyhhcmd1bWVudHMpOyB9CiAgICByZXR1cm4gbmV3IEMoKTsKICB9LAoKICAvKioKICAgIENyZWF0ZXMgYW4gaW5zdGFuY2Ugb2YgYSBjbGFzcy4gQWNjZXB0cyBlaXRoZXIgbm8gYXJndW1lbnRzLCBvciBhbiBvYmplY3QKICAgIGNvbnRhaW5pbmcgdmFsdWVzIHRvIGluaXRpYWxpemUgdGhlIG5ld2x5IGluc3RhbnRpYXRlZCBvYmplY3Qgd2l0aC4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuUGVyc29uID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CiAgICAgIGhlbGxvV29ybGQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGFsZXJ0KCJIaSwgbXkgbmFtZSBpcyAiICsgdGhpcy5nZXQoJ25hbWUnKSk7CiAgICAgIH0KICAgIH0pOwoKICAgIHZhciB0b20gPSBBcHAuUGVyc29uLmNyZWF0ZSh7CiAgICAgIG5hbWU6ICdUb20gRGFsZScKICAgIH0pOwoKICAgIHRvbS5oZWxsb1dvcmxkKCk7IC8vIGFsZXJ0cyAiSGksIG15IG5hbWUgaXMgVG9tIERhbGUiLgogICAgYGBgCgogICAgYGNyZWF0ZWAgd2lsbCBjYWxsIHRoZSBgaW5pdGAgZnVuY3Rpb24gaWYgZGVmaW5lZCBkdXJpbmcKICAgIGBFbWJlci5BbnlPYmplY3QuZXh0ZW5kYAoKICAgIElmIG5vIGFyZ3VtZW50cyBhcmUgcGFzc2VkIHRvIGBjcmVhdGVgLCBpdCB3aWxsIG5vdCBzZXQgdmFsdWVzIHRvIHRoZSBuZXcKICAgIGluc3RhbmNlIGR1cmluZyBpbml0aWFsaXphdGlvbjoKCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgbm9OYW1lID0gQXBwLlBlcnNvbi5jcmVhdGUoKTsKICAgIG5vTmFtZS5oZWxsb1dvcmxkKCk7IC8vIGFsZXJ0cyB1bmRlZmluZWQKICAgIGBgYAoKICAgIE5PVEU6IEZvciBwZXJmb3JtYW5jZSByZWFzb25zLCB5b3UgY2Fubm90IGRlY2xhcmUgbWV0aG9kcyBvciBjb21wdXRlZAogICAgcHJvcGVydGllcyBkdXJpbmcgYGNyZWF0ZWAuIFlvdSBzaG91bGQgaW5zdGVhZCBkZWNsYXJlIG1ldGhvZHMgYW5kIGNvbXB1dGVkCiAgICBwcm9wZXJ0aWVzIHdoZW4gdXNpbmcgYGV4dGVuZGAgb3IgdXNlIHRoZSBgY3JlYXRlV2l0aE1peGluc2Agc2hvcnRoYW5kLgoKICAgIEBtZXRob2QgY3JlYXRlCiAgICBAc3RhdGljCiAgICBAcGFyYW0gW2FyZ3VtZW50c10qCiAgKi8KICBjcmVhdGU6IGZ1bmN0aW9uKCkgewogICAgdmFyIEMgPSB0aGlzOwogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGg+MCkgeyB0aGlzLl9pbml0UHJvcGVydGllcyhhcmd1bWVudHMpOyB9CiAgICByZXR1cm4gbmV3IEMoKTsKICB9LAoKICAvKioKICAgIEF1Z21lbnRzIGEgY29uc3RydWN0b3IncyBwcm90b3R5cGUgd2l0aCBhZGRpdGlvbmFsCiAgICBwcm9wZXJ0aWVzIGFuZCBmdW5jdGlvbnM6CgogICAgYGBgamF2YXNjcmlwdAogICAgTXlPYmplY3QgPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICAgICAgbmFtZTogJ2FuIG9iamVjdCcKICAgIH0pOwoKICAgIG8gPSBNeU9iamVjdC5jcmVhdGUoKTsKICAgIG8uZ2V0KCduYW1lJyk7IC8vICdhbiBvYmplY3QnCgogICAgTXlPYmplY3QucmVvcGVuKHsKICAgICAgc2F5OiBmdW5jdGlvbihtc2cpewogICAgICAgIGNvbnNvbGUubG9nKG1zZyk7CiAgICAgIH0KICAgIH0pCgogICAgbzIgPSBNeU9iamVjdC5jcmVhdGUoKTsKICAgIG8yLnNheSgiaGVsbG8iKTsgLy8gbG9ncyAiaGVsbG8iCgogICAgby5zYXkoImdvb2RieWUiKTsgLy8gbG9ncyAiZ29vZGJ5ZSIKICAgIGBgYAoKICAgIFRvIGFkZCBmdW5jdGlvbnMgYW5kIHByb3BlcnRpZXMgdG8gdGhlIGNvbnN0cnVjdG9yIGl0c2VsZiwKICAgIHNlZSBgcmVvcGVuQ2xhc3NgCgogICAgQG1ldGhvZCByZW9wZW4KICAqLwogIHJlb3BlbjogZnVuY3Rpb24oKSB7CiAgICB0aGlzLndpbGxSZW9wZW4oKTsKICAgIHJlb3Blbi5hcHBseSh0aGlzLlByb3RvdHlwZU1peGluLCBhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICBBdWdtZW50cyBhIGNvbnN0cnVjdG9yJ3Mgb3duIHByb3BlcnRpZXMgYW5kIGZ1bmN0aW9uczoKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBNeU9iamVjdCA9IEVtYmVyLk9iamVjdC5leHRlbmQoewogICAgICBuYW1lOiAnYW4gb2JqZWN0JwogICAgfSk7CgogICAgTXlPYmplY3QucmVvcGVuQ2xhc3MoewogICAgICBjYW5CdWlsZDogZmFsc2UKICAgIH0pOwoKICAgIE15T2JqZWN0LmNhbkJ1aWxkOyAvLyBmYWxzZQogICAgbyA9IE15T2JqZWN0LmNyZWF0ZSgpOwogICAgYGBgCgogICAgSW4gb3RoZXIgd29yZHMsIHRoaXMgY3JlYXRlcyBzdGF0aWMgcHJvcGVydGllcyBhbmQgZnVuY3Rpb25zIGZvciB0aGUgY2xhc3MuIFRoZXNlIGFyZSBvbmx5IGF2YWlsYWJsZSBvbiB0aGUgY2xhc3MKICAgIGFuZCBub3Qgb24gYW55IGluc3RhbmNlIG9mIHRoYXQgY2xhc3MuCgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLlBlcnNvbiA9IEVtYmVyLk9iamVjdC5leHRlbmQoewogICAgICBuYW1lIDogIiIsCiAgICAgIHNheUhlbGxvIDogZnVuY3Rpb24oKXsKICAgICAgICBhbGVydCgiSGVsbG8uIE15IG5hbWUgaXMgIiArIHRoaXMuZ2V0KCduYW1lJykpOwogICAgICB9CiAgICB9KTsKCiAgICBBcHAuUGVyc29uLnJlb3BlbkNsYXNzKHsKICAgICAgc3BlY2llcyA6ICJIb21vIHNhcGllbnMiLAogICAgICBjcmVhdGVQZXJzb246IGZ1bmN0aW9uKG5ld1BlcnNvbnNOYW1lKXsKICAgICAgICByZXR1cm4gQXBwLlBlcnNvbi5jcmVhdGUoewogICAgICAgICAgbmFtZTpuZXdQZXJzb25zTmFtZQogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKCiAgICB2YXIgdG9tID0gQXBwLlBlcnNvbi5jcmVhdGUoewogICAgICBuYW1lIDogIlRvbSBEYWxlIgogICAgfSk7CiAgICB2YXIgeWVodWRhID0gQXBwLlBlcnNvbi5jcmVhdGVQZXJzb24oIlllaHVkYSBLYXR6Iik7CgogICAgdG9tLnNheUhlbGxvKCk7IC8vICJIZWxsby4gTXkgbmFtZSBpcyBUb20gRGFsZSIKICAgIHllaHVkYS5zYXlIZWxsbygpOyAvLyAiSGVsbG8uIE15IG5hbWUgaXMgWWVodWRhIEthdHoiCiAgICBhbGVydChBcHAuUGVyc29uLnNwZWNpZXMpOyAvLyAiSG9tbyBzYXBpZW5zIgogICAgYGBgCgogICAgTm90ZSB0aGF0IGBzcGVjaWVzYCBhbmQgYGNyZWF0ZVBlcnNvbmAgYXJlICpub3QqIHZhbGlkIG9uIHRoZSBgdG9tYCBhbmQgYHllaHVkYWAKICAgIHZhcmlhYmxlcy4gVGhleSBhcmUgb25seSB2YWxpZCBvbiBgQXBwLlBlcnNvbmAuCgogICAgVG8gYWRkIGZ1bmN0aW9ucyBhbmQgcHJvcGVydGllcyB0byBpbnN0YW5jZXMgb2YKICAgIGEgY29uc3RydWN0b3IgYnkgZXh0ZW5kaW5nIHRoZSBjb25zdHJ1Y3RvcidzIHByb3RvdHlwZQogICAgc2VlIGByZW9wZW5gCgogICAgQG1ldGhvZCByZW9wZW5DbGFzcwogICovCiAgcmVvcGVuQ2xhc3M6IGZ1bmN0aW9uKCkgewogICAgcmVvcGVuLmFwcGx5KHRoaXMuQ2xhc3NNaXhpbiwgYXJndW1lbnRzKTsKICAgIGFwcGx5TWl4aW4odGhpcywgYXJndW1lbnRzLCBmYWxzZSk7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICBkZXRlY3Q6IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCdmdW5jdGlvbicgIT09IHR5cGVvZiBvYmopIHsgcmV0dXJuIGZhbHNlOyB9CiAgICB3aGlsZShvYmopIHsKICAgICAgaWYgKG9iaj09PXRoaXMpIHsgcmV0dXJuIHRydWU7IH0KICAgICAgb2JqID0gb2JqLnN1cGVyY2xhc3M7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfSwKCiAgZGV0ZWN0SW5zdGFuY2U6IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIG9iaiBpbnN0YW5jZW9mIHRoaXM7CiAgfSwKCiAgLyoqCiAgICBJbiBzb21lIGNhc2VzLCB5b3UgbWF5IHdhbnQgdG8gYW5ub3RhdGUgY29tcHV0ZWQgcHJvcGVydGllcyB3aXRoIGFkZGl0aW9uYWwKICAgIG1ldGFkYXRhIGFib3V0IGhvdyB0aGV5IGZ1bmN0aW9uIG9yIHdoYXQgdmFsdWVzIHRoZXkgb3BlcmF0ZSBvbi4gRm9yCiAgICBleGFtcGxlLCBjb21wdXRlZCBwcm9wZXJ0eSBmdW5jdGlvbnMgbWF5IGNsb3NlIG92ZXIgdmFyaWFibGVzIHRoYXQgYXJlIHRoZW4KICAgIG5vIGxvbmdlciBhdmFpbGFibGUgZm9yIGludHJvc3BlY3Rpb24uCgogICAgWW91IGNhbiBwYXNzIGEgaGFzaCBvZiB0aGVzZSB2YWx1ZXMgdG8gYSBjb21wdXRlZCBwcm9wZXJ0eSBsaWtlIHRoaXM6CgogICAgYGBgamF2YXNjcmlwdAogICAgcGVyc29uOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHBlcnNvbklkID0gdGhpcy5nZXQoJ3BlcnNvbklkJyk7CiAgICAgIHJldHVybiBBcHAuUGVyc29uLmNyZWF0ZSh7IGlkOiBwZXJzb25JZCB9KTsKICAgIH0ucHJvcGVydHkoKS5tZXRhKHsgdHlwZTogQXBwLlBlcnNvbiB9KQogICAgYGBgCgogICAgT25jZSB5b3UndmUgZG9uZSB0aGlzLCB5b3UgY2FuIHJldHJpZXZlIHRoZSB2YWx1ZXMgc2F2ZWQgdG8gdGhlIGNvbXB1dGVkCiAgICBwcm9wZXJ0eSBmcm9tIHlvdXIgY2xhc3MgbGlrZSB0aGlzOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIE15Q2xhc3MubWV0YUZvclByb3BlcnR5KCdwZXJzb24nKTsKICAgIGBgYAoKICAgIFRoaXMgd2lsbCByZXR1cm4gdGhlIG9yaWdpbmFsIGhhc2ggdGhhdCB3YXMgcGFzc2VkIHRvIGBtZXRhKClgLgoKICAgIEBtZXRob2QgbWV0YUZvclByb3BlcnR5CiAgICBAcGFyYW0ga2V5IHtTdHJpbmd9IHByb3BlcnR5IG5hbWUKICAqLwogIG1ldGFGb3JQcm9wZXJ0eTogZnVuY3Rpb24oa2V5KSB7CiAgICB2YXIgZGVzYyA9IG1ldGEodGhpcy5wcm90bygpLCBmYWxzZSkuZGVzY3Nba2V5XTsKCiAgICBFbWJlci5hc3NlcnQoIm1ldGFGb3JQcm9wZXJ0eSgpIGNvdWxkIG5vdCBmaW5kIGEgY29tcHV0ZWQgcHJvcGVydHkgd2l0aCBrZXkgJyIra2V5KyInLiIsICEhZGVzYyAmJiBkZXNjIGluc3RhbmNlb2YgRW1iZXIuQ29tcHV0ZWRQcm9wZXJ0eSk7CiAgICByZXR1cm4gZGVzYy5fbWV0YSB8fCB7fTsKICB9LAoKICAvKioKICAgIEl0ZXJhdGUgb3ZlciBlYWNoIGNvbXB1dGVkIHByb3BlcnR5IGZvciB0aGUgY2xhc3MsIHBhc3NpbmcgaXRzIG5hbWUKICAgIGFuZCBhbnkgYXNzb2NpYXRlZCBtZXRhZGF0YSAoc2VlIGBtZXRhRm9yUHJvcGVydHlgKSB0byB0aGUgY2FsbGJhY2suCgogICAgQG1ldGhvZCBlYWNoQ29tcHV0ZWRQcm9wZXJ0eQogICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sKICAgIEBwYXJhbSB7T2JqZWN0fSBiaW5kaW5nCiAgKi8KICBlYWNoQ29tcHV0ZWRQcm9wZXJ0eTogZnVuY3Rpb24oY2FsbGJhY2ssIGJpbmRpbmcpIHsKICAgIHZhciBwcm90byA9IHRoaXMucHJvdG8oKSwKICAgICAgICBkZXNjcyA9IG1ldGEocHJvdG8pLmRlc2NzLAogICAgICAgIGVtcHR5ID0ge30sCiAgICAgICAgcHJvcGVydHk7CgogICAgZm9yICh2YXIgbmFtZSBpbiBkZXNjcykgewogICAgICBwcm9wZXJ0eSA9IGRlc2NzW25hbWVdOwoKICAgICAgaWYgKHByb3BlcnR5IGluc3RhbmNlb2YgRW1iZXIuQ29tcHV0ZWRQcm9wZXJ0eSkgewogICAgICAgIGNhbGxiYWNrLmNhbGwoYmluZGluZyB8fCB0aGlzLCBuYW1lLCBwcm9wZXJ0eS5fbWV0YSB8fCBlbXB0eSk7CiAgICAgIH0KICAgIH0KICB9Cgp9KTsKCkNsYXNzTWl4aW4ub3duZXJDb25zdHJ1Y3RvciA9IENvcmVPYmplY3Q7CgppZiAoRW1iZXIuY29uZmlnLm92ZXJyaWRlQ2xhc3NNaXhpbikgewogIEVtYmVyLmNvbmZpZy5vdmVycmlkZUNsYXNzTWl4aW4oQ2xhc3NNaXhpbik7Cn0KCkNvcmVPYmplY3QuQ2xhc3NNaXhpbiA9IENsYXNzTWl4aW47CkNsYXNzTWl4aW4uYXBwbHkoQ29yZU9iamVjdCk7CgpFbWJlci5Db3JlT2JqZWN0ID0gQ29yZU9iamVjdDsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1ydW50aW1lCiovCgovKioKICBgRW1iZXIuT2JqZWN0YCBpcyB0aGUgbWFpbiBiYXNlIGNsYXNzIGZvciBhbGwgRW1iZXIgb2JqZWN0cy4gSXQgaXMgYSBzdWJjbGFzcwogIG9mIGBFbWJlci5Db3JlT2JqZWN0YCB3aXRoIHRoZSBgRW1iZXIuT2JzZXJ2YWJsZWAgbWl4aW4gYXBwbGllZC4gRm9yIGRldGFpbHMsCiAgc2VlIHRoZSBkb2N1bWVudGF0aW9uIGZvciBlYWNoIG9mIHRoZXNlLgoKICBAY2xhc3MgT2JqZWN0CiAgQG5hbWVzcGFjZSBFbWJlcgogIEBleHRlbmRzIEVtYmVyLkNvcmVPYmplY3QKICBAdXNlcyBFbWJlci5PYnNlcnZhYmxlCiovCkVtYmVyLk9iamVjdCA9IEVtYmVyLkNvcmVPYmplY3QuZXh0ZW5kKEVtYmVyLk9ic2VydmFibGUpOwpFbWJlci5PYmplY3QudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsgcmV0dXJuICJFbWJlci5PYmplY3QiOyB9OwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLXJ1bnRpbWUKKi8KCnZhciBnZXQgPSBFbWJlci5nZXQsIGluZGV4T2YgPSBFbWJlci5BcnJheVBvbHlmaWxscy5pbmRleE9mOwoKLyoqCiAgQSBOYW1lc3BhY2UgaXMgYW4gb2JqZWN0IHVzdWFsbHkgdXNlZCB0byBjb250YWluIG90aGVyIG9iamVjdHMgb3IgbWV0aG9kcwogIHN1Y2ggYXMgYW4gYXBwbGljYXRpb24gb3IgZnJhbWV3b3JrLiBDcmVhdGUgYSBuYW1lc3BhY2UgYW55dGltZSB5b3Ugd2FudAogIHRvIGRlZmluZSBvbmUgb2YgdGhlc2UgbmV3IGNvbnRhaW5lcnMuCgogICMgRXhhbXBsZSBVc2FnZQoKICBgYGBqYXZhc2NyaXB0CiAgTXlGcmFtZXdvcmsgPSBFbWJlci5OYW1lc3BhY2UuY3JlYXRlKHsKICAgIFZFUlNJT046ICcxLjAuMCcKICB9KTsKICBgYGAKCiAgQGNsYXNzIE5hbWVzcGFjZQogIEBuYW1lc3BhY2UgRW1iZXIKICBAZXh0ZW5kcyBFbWJlci5PYmplY3QKKi8KdmFyIE5hbWVzcGFjZSA9IEVtYmVyLk5hbWVzcGFjZSA9IEVtYmVyLk9iamVjdC5leHRlbmQoewogIGlzTmFtZXNwYWNlOiB0cnVlLAoKICBpbml0OiBmdW5jdGlvbigpIHsKICAgIEVtYmVyLk5hbWVzcGFjZS5OQU1FU1BBQ0VTLnB1c2godGhpcyk7CiAgICBFbWJlci5OYW1lc3BhY2UuUFJPQ0VTU0VEID0gZmFsc2U7CiAgfSwKCiAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgdmFyIG5hbWUgPSBnZXQodGhpcywgJ25hbWUnKTsKICAgIGlmIChuYW1lKSB7IHJldHVybiBuYW1lOyB9CgogICAgZmluZE5hbWVzcGFjZXMoKTsKICAgIHJldHVybiB0aGlzW0VtYmVyLkdVSURfS0VZKydfbmFtZSddOwogIH0sCgogIG5hbWVDbGFzc2VzOiBmdW5jdGlvbigpIHsKICAgIHByb2Nlc3NOYW1lc3BhY2UoW3RoaXMudG9TdHJpbmcoKV0sIHRoaXMsIHt9KTsKICB9LAoKICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgIHZhciBuYW1lc3BhY2VzID0gRW1iZXIuTmFtZXNwYWNlLk5BTUVTUEFDRVM7CiAgICBFbWJlci5sb29rdXBbdGhpcy50b1N0cmluZygpXSA9IHVuZGVmaW5lZDsKICAgIG5hbWVzcGFjZXMuc3BsaWNlKGluZGV4T2YuY2FsbChuYW1lc3BhY2VzLCB0aGlzKSwgMSk7CiAgICB0aGlzLl9zdXBlcigpOwogIH0KfSk7CgpOYW1lc3BhY2UucmVvcGVuQ2xhc3MoewogIE5BTUVTUEFDRVM6IFtFbWJlcl0sCiAgTkFNRVNQQUNFU19CWV9JRDoge30sCiAgUFJPQ0VTU0VEOiBmYWxzZSwKICBwcm9jZXNzQWxsOiBwcm9jZXNzQWxsTmFtZXNwYWNlcywKICBieU5hbWU6IGZ1bmN0aW9uKG5hbWUpIHsKICAgIGlmICghRW1iZXIuQk9PVEVEKSB7CiAgICAgIHByb2Nlc3NBbGxOYW1lc3BhY2VzKCk7CiAgICB9CgogICAgcmV0dXJuIE5BTUVTUEFDRVNfQllfSURbbmFtZV07CiAgfQp9KTsKCnZhciBOQU1FU1BBQ0VTX0JZX0lEID0gTmFtZXNwYWNlLk5BTUVTUEFDRVNfQllfSUQ7Cgp2YXIgaGFzT3duUHJvcCA9ICh7fSkuaGFzT3duUHJvcGVydHksCiAgICBndWlkRm9yID0gRW1iZXIuZ3VpZEZvcjsKCmZ1bmN0aW9uIHByb2Nlc3NOYW1lc3BhY2UocGF0aHMsIHJvb3QsIHNlZW4pIHsKICB2YXIgaWR4ID0gcGF0aHMubGVuZ3RoOwoKICBOQU1FU1BBQ0VTX0JZX0lEW3BhdGhzLmpvaW4oJy4nKV0gPSByb290OwoKICAvLyBMb29wIG92ZXIgYWxsIG9mIHRoZSBrZXlzIGluIHRoZSBuYW1lc3BhY2UsIGxvb2tpbmcgZm9yIGNsYXNzZXMKICBmb3IodmFyIGtleSBpbiByb290KSB7CiAgICBpZiAoIWhhc093blByb3AuY2FsbChyb290LCBrZXkpKSB7IGNvbnRpbnVlOyB9CiAgICB2YXIgb2JqID0gcm9vdFtrZXldOwoKICAgIC8vIElmIHdlIGFyZSBwcm9jZXNzaW5nIHRoZSBgRW1iZXJgIG5hbWVzcGFjZSwgZm9yIGV4YW1wbGUsIHRoZQogICAgLy8gYHBhdGhzYCB3aWxsIHN0YXJ0IHdpdGggYFsiRW1iZXIiXWAuIEV2ZXJ5IGl0ZXJhdGlvbiB0aHJvdWdoCiAgICAvLyB0aGUgbG9vcCB3aWxsIHVwZGF0ZSB0aGUgKipzZWNvbmQqKiBlbGVtZW50IG9mIHRoaXMgbGlzdCB3aXRoCiAgICAvLyB0aGUga2V5LCBzbyBwcm9jZXNzaW5nIGBFbWJlci5WaWV3YCB3aWxsIG1ha2UgdGhlIEFycmF5CiAgICAvLyBgWydFbWJlcicsICdWaWV3J11gLgogICAgcGF0aHNbaWR4XSA9IGtleTsKCiAgICAvLyBJZiB3ZSBoYXZlIGZvdW5kIGFuIHVucHJvY2Vzc2VkIGNsYXNzCiAgICBpZiAob2JqICYmIG9iai50b1N0cmluZyA9PT0gY2xhc3NUb1N0cmluZykgewogICAgICAvLyBSZXBsYWNlIHRoZSBjbGFzcycgYHRvU3RyaW5nYCB3aXRoIHRoZSBkb3Qtc2VwYXJhdGVkIHBhdGgKICAgICAgLy8gYW5kIHNldCBpdHMgYE5BTUVfS0VZYAogICAgICBvYmoudG9TdHJpbmcgPSBtYWtlVG9TdHJpbmcocGF0aHMuam9pbignLicpKTsKICAgICAgb2JqW05BTUVfS0VZXSA9IHBhdGhzLmpvaW4oJy4nKTsKCiAgICAvLyBTdXBwb3J0IG5lc3RlZCBuYW1lc3BhY2VzCiAgICB9IGVsc2UgaWYgKG9iaiAmJiBvYmouaXNOYW1lc3BhY2UpIHsKICAgICAgLy8gU2tpcCBhbGlhc2VkIG5hbWVzcGFjZXMKICAgICAgaWYgKHNlZW5bZ3VpZEZvcihvYmopXSkgeyBjb250aW51ZTsgfQogICAgICBzZWVuW2d1aWRGb3Iob2JqKV0gPSB0cnVlOwoKICAgICAgLy8gUHJvY2VzcyB0aGUgY2hpbGQgbmFtZXNwYWNlCiAgICAgIHByb2Nlc3NOYW1lc3BhY2UocGF0aHMsIG9iaiwgc2Vlbik7CiAgICB9CiAgfQoKICBwYXRocy5sZW5ndGggPSBpZHg7IC8vIGN1dCBvdXQgbGFzdCBpdGVtCn0KCmZ1bmN0aW9uIGZpbmROYW1lc3BhY2VzKCkgewogIHZhciBOYW1lc3BhY2UgPSBFbWJlci5OYW1lc3BhY2UsIGxvb2t1cCA9IEVtYmVyLmxvb2t1cCwgb2JqLCBpc05hbWVzcGFjZTsKCiAgaWYgKE5hbWVzcGFjZS5QUk9DRVNTRUQpIHsgcmV0dXJuOyB9CgogIGZvciAodmFyIHByb3AgaW4gbG9va3VwKSB7CiAgICAvLyBUaGVzZSBkb24ndCByYWlzZSBleGNlcHRpb25zIGJ1dCBjYW4gY2F1c2Ugd2FybmluZ3MKICAgIGlmIChwcm9wID09PSAicGFyZW50IiB8fCBwcm9wID09PSAidG9wIiB8fCBwcm9wID09PSAiZnJhbWVFbGVtZW50IiB8fCBwcm9wID09PSAid2Via2l0U3RvcmFnZUluZm8iKSB7IGNvbnRpbnVlOyB9CgogICAgLy8gIGdldCh3aW5kb3cuZ2xvYmFsU3RvcmFnZSwgJ2lzTmFtZXNwYWNlJykgd291bGQgdHJ5IHRvIHJlYWQgdGhlIHN0b3JhZ2UgZm9yIGRvbWFpbiBpc05hbWVzcGFjZSBhbmQgY2F1c2UgZXhjZXB0aW9uIGluIEZpcmVmb3guCiAgICAvLyBnbG9iYWxTdG9yYWdlIGlzIGEgc3RvcmFnZSBvYnNvbGV0ZWQgYnkgdGhlIFdoYXRXRyBzdG9yYWdlIHNwZWNpZmljYXRpb24uIFNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9ET00vU3RvcmFnZSNnbG9iYWxTdG9yYWdlCiAgICBpZiAocHJvcCA9PT0gImdsb2JhbFN0b3JhZ2UiICYmIGxvb2t1cC5TdG9yYWdlTGlzdCAmJiBsb29rdXAuZ2xvYmFsU3RvcmFnZSBpbnN0YW5jZW9mIGxvb2t1cC5TdG9yYWdlTGlzdCkgeyBjb250aW51ZTsgfQogICAgLy8gVW5mb3J0dW5hdGVseSwgc29tZSB2ZXJzaW9ucyBvZiBJRSBkb24ndCBzdXBwb3J0IHdpbmRvdy5oYXNPd25Qcm9wZXJ0eQogICAgaWYgKGxvb2t1cC5oYXNPd25Qcm9wZXJ0eSAmJiAhbG9va3VwLmhhc093blByb3BlcnR5KHByb3ApKSB7IGNvbnRpbnVlOyB9CgogICAgLy8gQXQgdGltZXMgd2UgYXJlIG5vdCBhbGxvd2VkIHRvIGFjY2VzcyBjZXJ0YWluIHByb3BlcnRpZXMgZm9yIHNlY3VyaXR5IHJlYXNvbnMuCiAgICAvLyBUaGVyZSBhcmUgYWxzbyB0aW1lcyB3aGVyZSBldmVuIGlmIHdlIGNhbiBhY2Nlc3MgdGhlbSwgd2UgYXJlIG5vdCBhbGxvd2VkIHRvIGFjY2VzcyB0aGVpciBwcm9wZXJ0aWVzLgogICAgdHJ5IHsKICAgICAgb2JqID0gRW1iZXIubG9va3VwW3Byb3BdOwogICAgICBpc05hbWVzcGFjZSA9IG9iaiAmJiBvYmouaXNOYW1lc3BhY2U7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGNvbnRpbnVlOwogICAgfQoKICAgIGlmIChpc05hbWVzcGFjZSkgewogICAgICBFbWJlci5kZXByZWNhdGUoIk5hbWVzcGFjZXMgc2hvdWxkIG5vdCBiZWdpbiB3aXRoIGxvd2VyY2FzZS4iLCAvXltBLVpdLy50ZXN0KHByb3ApKTsKICAgICAgb2JqW05BTUVfS0VZXSA9IHByb3A7CiAgICB9CiAgfQp9Cgp2YXIgTkFNRV9LRVkgPSBFbWJlci5OQU1FX0tFWSA9IEVtYmVyLkdVSURfS0VZICsgJ19uYW1lJzsKCmZ1bmN0aW9uIHN1cGVyQ2xhc3NTdHJpbmcobWl4aW4pIHsKICB2YXIgc3VwZXJjbGFzcyA9IG1peGluLnN1cGVyY2xhc3M7CiAgaWYgKHN1cGVyY2xhc3MpIHsKICAgIGlmIChzdXBlcmNsYXNzW05BTUVfS0VZXSkgeyByZXR1cm4gc3VwZXJjbGFzc1tOQU1FX0tFWV07IH0KICAgIGVsc2UgeyByZXR1cm4gc3VwZXJDbGFzc1N0cmluZyhzdXBlcmNsYXNzKTsgfQogIH0gZWxzZSB7CiAgICByZXR1cm47CiAgfQp9CgpmdW5jdGlvbiBjbGFzc1RvU3RyaW5nKCkgewogIGlmICghRW1iZXIuQk9PVEVEICYmICF0aGlzW05BTUVfS0VZXSkgewogICAgcHJvY2Vzc0FsbE5hbWVzcGFjZXMoKTsKICB9CgogIHZhciByZXQ7CgogIGlmICh0aGlzW05BTUVfS0VZXSkgewogICAgcmV0ID0gdGhpc1tOQU1FX0tFWV07CiAgfSBlbHNlIGlmICh0aGlzLl90b1N0cmluZykgewogICAgcmV0ID0gdGhpcy5fdG9TdHJpbmc7IAogIH0gZWxzZSB7CiAgICB2YXIgc3RyID0gc3VwZXJDbGFzc1N0cmluZyh0aGlzKTsKICAgIGlmIChzdHIpIHsKICAgICAgcmV0ID0gIihzdWJjbGFzcyBvZiAiICsgc3RyICsgIikiOwogICAgfSBlbHNlIHsKICAgICAgcmV0ID0gIih1bmtub3duIG1peGluKSI7CiAgICB9CiAgICB0aGlzLnRvU3RyaW5nID0gbWFrZVRvU3RyaW5nKHJldCk7CiAgfQoKICByZXR1cm4gcmV0Owp9CgpmdW5jdGlvbiBwcm9jZXNzQWxsTmFtZXNwYWNlcygpIHsKICB2YXIgdW5wcm9jZXNzZWROYW1lc3BhY2VzID0gIU5hbWVzcGFjZS5QUk9DRVNTRUQsCiAgICAgIHVucHJvY2Vzc2VkTWl4aW5zID0gRW1iZXIuYW55VW5wcm9jZXNzZWRNaXhpbnM7CgogIGlmICh1bnByb2Nlc3NlZE5hbWVzcGFjZXMpIHsKICAgIGZpbmROYW1lc3BhY2VzKCk7CiAgICBOYW1lc3BhY2UuUFJPQ0VTU0VEID0gdHJ1ZTsKICB9CgogIGlmICh1bnByb2Nlc3NlZE5hbWVzcGFjZXMgfHwgdW5wcm9jZXNzZWRNaXhpbnMpIHsKICAgIHZhciBuYW1lc3BhY2VzID0gTmFtZXNwYWNlLk5BTUVTUEFDRVMsIG5hbWVzcGFjZTsKICAgIGZvciAodmFyIGk9MCwgbD1uYW1lc3BhY2VzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgbmFtZXNwYWNlID0gbmFtZXNwYWNlc1tpXTsKICAgICAgcHJvY2Vzc05hbWVzcGFjZShbbmFtZXNwYWNlLnRvU3RyaW5nKCldLCBuYW1lc3BhY2UsIHt9KTsKICAgIH0KCiAgICBFbWJlci5hbnlVbnByb2Nlc3NlZE1peGlucyA9IGZhbHNlOwogIH0KfQoKZnVuY3Rpb24gbWFrZVRvU3RyaW5nKHJldCkgewogIHJldHVybiBmdW5jdGlvbigpIHsgcmV0dXJuIHJldDsgfTsKfQoKRW1iZXIuTWl4aW4ucHJvdG90eXBlLnRvU3RyaW5nID0gY2xhc3NUb1N0cmluZzsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1ydW50aW1lCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LAogICAgc2V0ID0gRW1iZXIuc2V0LAogICAgZm10ID0gRW1iZXIuU3RyaW5nLmZtdCwKICAgIGFkZEJlZm9yZU9ic2VydmVyID0gRW1iZXIuYWRkQmVmb3JlT2JzZXJ2ZXIsCiAgICBhZGRPYnNlcnZlciA9IEVtYmVyLmFkZE9ic2VydmVyLAogICAgcmVtb3ZlQmVmb3JlT2JzZXJ2ZXIgPSBFbWJlci5yZW1vdmVCZWZvcmVPYnNlcnZlciwKICAgIHJlbW92ZU9ic2VydmVyID0gRW1iZXIucmVtb3ZlT2JzZXJ2ZXIsCiAgICBwcm9wZXJ0eVdpbGxDaGFuZ2UgPSBFbWJlci5wcm9wZXJ0eVdpbGxDaGFuZ2UsCiAgICBwcm9wZXJ0eURpZENoYW5nZSA9IEVtYmVyLnByb3BlcnR5RGlkQ2hhbmdlLAogICAgbWV0YSA9IEVtYmVyLm1ldGEsCiAgICBkZWZpbmVQcm9wZXJ0eSA9IEVtYmVyLmRlZmluZVByb3BlcnR5OwoKZnVuY3Rpb24gY29udGVudFByb3BlcnR5V2lsbENoYW5nZShjb250ZW50LCBjb250ZW50S2V5KSB7CiAgdmFyIGtleSA9IGNvbnRlbnRLZXkuc2xpY2UoOCk7IC8vIHJlbW92ZSAiY29udGVudC4iCiAgaWYgKGtleSBpbiB0aGlzKSB7IHJldHVybjsgfSAgLy8gaWYgc2hhZG93ZWQgaW4gcHJveHkKICBwcm9wZXJ0eVdpbGxDaGFuZ2UodGhpcywga2V5KTsKfQoKZnVuY3Rpb24gY29udGVudFByb3BlcnR5RGlkQ2hhbmdlKGNvbnRlbnQsIGNvbnRlbnRLZXkpIHsKICB2YXIga2V5ID0gY29udGVudEtleS5zbGljZSg4KTsgLy8gcmVtb3ZlICJjb250ZW50LiIKICBpZiAoa2V5IGluIHRoaXMpIHsgcmV0dXJuOyB9IC8vIGlmIHNoYWRvd2VkIGluIHByb3h5CiAgcHJvcGVydHlEaWRDaGFuZ2UodGhpcywga2V5KTsKfQoKLyoqCiAgYEVtYmVyLk9iamVjdFByb3h5YCBmb3J3YXJkcyBhbGwgcHJvcGVydGllcyBub3QgZGVmaW5lZCBieSB0aGUgcHJveHkgaXRzZWxmCiAgdG8gYSBwcm94aWVkIGBjb250ZW50YCBvYmplY3QuCgogIGBgYGphdmFzY3JpcHQKICBvYmplY3QgPSBFbWJlci5PYmplY3QuY3JlYXRlKHsKICAgIG5hbWU6ICdGb28nCiAgfSk7CgogIHByb3h5ID0gRW1iZXIuT2JqZWN0UHJveHkuY3JlYXRlKHsKICAgIGNvbnRlbnQ6IG9iamVjdAogIH0pOwoKICAvLyBBY2Nlc3MgYW5kIGNoYW5nZSBleGlzdGluZyBwcm9wZXJ0aWVzCiAgcHJveHkuZ2V0KCduYW1lJykgICAgICAgICAgLy8gJ0ZvbycKICBwcm94eS5zZXQoJ25hbWUnLCAnQmFyJyk7CiAgb2JqZWN0LmdldCgnbmFtZScpICAgICAgICAgLy8gJ0JhcicKCiAgLy8gQ3JlYXRlIG5ldyAnZGVzY3JpcHRpb24nIHByb3BlcnR5IG9uIGBvYmplY3RgCiAgcHJveHkuc2V0KCdkZXNjcmlwdGlvbicsICdGb28gaXMgYSB3aGl6Ym9vIGJheicpOwogIG9iamVjdC5nZXQoJ2Rlc2NyaXB0aW9uJykgIC8vICdGb28gaXMgYSB3aGl6Ym9vIGJheicKICBgYGAKCiAgV2hpbGUgYGNvbnRlbnRgIGlzIHVuc2V0LCBzZXR0aW5nIGEgcHJvcGVydHkgdG8gYmUgZGVsZWdhdGVkIHdpbGwgdGhyb3cgYW4KICBFcnJvci4KCiAgYGBgamF2YXNjcmlwdAogIHByb3h5ID0gRW1iZXIuT2JqZWN0UHJveHkuY3JlYXRlKHsKICAgIGNvbnRlbnQ6IG51bGwsCiAgICBmbGFnOiBudWxsCiAgfSk7CiAgcHJveHkuc2V0KCdmbGFnJywgdHJ1ZSk7CiAgcHJveHkuZ2V0KCdmbGFnJyk7ICAgICAgICAgLy8gdHJ1ZQogIHByb3h5LmdldCgnZm9vJyk7ICAgICAgICAgIC8vIHVuZGVmaW5lZAogIHByb3h5LnNldCgnZm9vJywgJ2RhdGEnKTsgIC8vIHRocm93cyBFcnJvcgogIGBgYAoKICBEZWxlZ2F0ZWQgcHJvcGVydGllcyBjYW4gYmUgYm91bmQgdG8gYW5kIHdpbGwgY2hhbmdlIHdoZW4gY29udGVudCBpcyB1cGRhdGVkLgoKICBDb21wdXRlZCBwcm9wZXJ0aWVzIG9uIHRoZSBwcm94eSBpdHNlbGYgY2FuIGRlcGVuZCBvbiBkZWxlZ2F0ZWQgcHJvcGVydGllcy4KCiAgYGBgamF2YXNjcmlwdAogIFByb3h5V2l0aENvbXB1dGVkUHJvcGVydHkgPSBFbWJlci5PYmplY3RQcm94eS5leHRlbmQoewogICAgZnVsbE5hbWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGZpcnN0TmFtZSA9IHRoaXMuZ2V0KCdmaXJzdE5hbWUnKSwKICAgICAgICAgIGxhc3ROYW1lID0gdGhpcy5nZXQoJ2xhc3ROYW1lJyk7CiAgICAgIGlmIChmaXJzdE5hbWUgJiYgbGFzdE5hbWUpIHsKICAgICAgICByZXR1cm4gZmlyc3ROYW1lICsgJyAnICsgbGFzdE5hbWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGZpcnN0TmFtZSB8fCBsYXN0TmFtZTsKICAgIH0ucHJvcGVydHkoJ2ZpcnN0TmFtZScsICdsYXN0TmFtZScpCiAgfSk7CgogIHByb3h5ID0gUHJveHlXaXRoQ29tcHV0ZWRQcm9wZXJ0eS5jcmVhdGUoKTsKCiAgcHJveHkuZ2V0KCdmdWxsTmFtZScpOyAgLy8gdW5kZWZpbmVkCiAgcHJveHkuc2V0KCdjb250ZW50JywgewogICAgZmlyc3ROYW1lOiAnVG9tJywgbGFzdE5hbWU6ICdEYWxlJwogIH0pOyAvLyB0cmlnZ2VycyBwcm9wZXJ0eSBjaGFuZ2UgZm9yIGZ1bGxOYW1lIG9uIHByb3h5CgogIHByb3h5LmdldCgnZnVsbE5hbWUnKTsgIC8vICdUb20gRGFsZScKICBgYGAKCiAgQGNsYXNzIE9iamVjdFByb3h5CiAgQG5hbWVzcGFjZSBFbWJlcgogIEBleHRlbmRzIEVtYmVyLk9iamVjdAoqLwpFbWJlci5PYmplY3RQcm94eSA9IEVtYmVyLk9iamVjdC5leHRlbmQoewogIC8qKgogICAgVGhlIG9iamVjdCB3aG9zZSBwcm9wZXJ0aWVzIHdpbGwgYmUgZm9yd2FyZGVkLgoKICAgIEBwcm9wZXJ0eSBjb250ZW50CiAgICBAdHlwZSBFbWJlci5PYmplY3QKICAgIEBkZWZhdWx0IG51bGwKICAqLwogIGNvbnRlbnQ6IG51bGwsCiAgX2NvbnRlbnREaWRDaGFuZ2U6IEVtYmVyLm9ic2VydmVyKCdjb250ZW50JywgZnVuY3Rpb24oKSB7CiAgICBFbWJlci5hc3NlcnQoIkNhbid0IHNldCBPYmplY3RQcm94eSdzIGNvbnRlbnQgdG8gaXRzZWxmIiwgdGhpcy5nZXQoJ2NvbnRlbnQnKSAhPT0gdGhpcyk7CiAgfSksCgogIGlzVHJ1dGh5OiBFbWJlci5jb21wdXRlZC5ib29sKCdjb250ZW50JyksCgogIF9kZWJ1Z0NvbnRhaW5lcktleTogbnVsbCwKCiAgd2lsbFdhdGNoUHJvcGVydHk6IGZ1bmN0aW9uIChrZXkpIHsKICAgIHZhciBjb250ZW50S2V5ID0gJ2NvbnRlbnQuJyArIGtleTsKICAgIGFkZEJlZm9yZU9ic2VydmVyKHRoaXMsIGNvbnRlbnRLZXksIG51bGwsIGNvbnRlbnRQcm9wZXJ0eVdpbGxDaGFuZ2UpOwogICAgYWRkT2JzZXJ2ZXIodGhpcywgY29udGVudEtleSwgbnVsbCwgY29udGVudFByb3BlcnR5RGlkQ2hhbmdlKTsKICB9LAoKICBkaWRVbndhdGNoUHJvcGVydHk6IGZ1bmN0aW9uIChrZXkpIHsKICAgIHZhciBjb250ZW50S2V5ID0gJ2NvbnRlbnQuJyArIGtleTsKICAgIHJlbW92ZUJlZm9yZU9ic2VydmVyKHRoaXMsIGNvbnRlbnRLZXksIG51bGwsIGNvbnRlbnRQcm9wZXJ0eVdpbGxDaGFuZ2UpOwogICAgcmVtb3ZlT2JzZXJ2ZXIodGhpcywgY29udGVudEtleSwgbnVsbCwgY29udGVudFByb3BlcnR5RGlkQ2hhbmdlKTsKICB9LAoKICB1bmtub3duUHJvcGVydHk6IGZ1bmN0aW9uIChrZXkpIHsKICAgIHZhciBjb250ZW50ID0gZ2V0KHRoaXMsICdjb250ZW50Jyk7CiAgICBpZiAoY29udGVudCkgewogICAgICByZXR1cm4gZ2V0KGNvbnRlbnQsIGtleSk7CiAgICB9CiAgfSwKCiAgc2V0VW5rbm93blByb3BlcnR5OiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgdmFyIG0gPSBtZXRhKHRoaXMpOwogICAgaWYgKG0ucHJvdG8gPT09IHRoaXMpIHsKICAgICAgLy8gaWYgbWFya2VkIGFzIHByb3RvdHlwZSB0aGVuIGp1c3QgZGVmaW5lUHJvcGVydHkKICAgICAgLy8gcmF0aGVyIHRoYW4gZGVsZWdhdGUKICAgICAgZGVmaW5lUHJvcGVydHkodGhpcywga2V5LCBudWxsLCB2YWx1ZSk7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KCiAgICB2YXIgY29udGVudCA9IGdldCh0aGlzLCAnY29udGVudCcpOwogICAgRW1iZXIuYXNzZXJ0KGZtdCgiQ2Fubm90IGRlbGVnYXRlIHNldCgnJUAnLCAlQCkgdG8gdGhlICdjb250ZW50JyBwcm9wZXJ0eSBvZiBvYmplY3QgcHJveHkgJUA6IGl0cyAnY29udGVudCcgaXMgdW5kZWZpbmVkLiIsIFtrZXksIHZhbHVlLCB0aGlzXSksIGNvbnRlbnQpOwogICAgcmV0dXJuIHNldChjb250ZW50LCBrZXksIHZhbHVlKTsKICB9Cgp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1ydW50aW1lCiovCgovLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCi8vIEhFTFBFUlMKLy8KCnZhciBnZXQgPSBFbWJlci5nZXQsIHNldCA9IEVtYmVyLnNldDsKdmFyIGFfc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CnZhciBhX2luZGV4T2YgPSBFbWJlci5FbnVtZXJhYmxlVXRpbHMuaW5kZXhPZjsKCnZhciBjb250ZXh0cyA9IFtdOwoKZnVuY3Rpb24gcG9wQ3R4KCkgewogIHJldHVybiBjb250ZXh0cy5sZW5ndGg9PT0wID8ge30gOiBjb250ZXh0cy5wb3AoKTsKfQoKZnVuY3Rpb24gcHVzaEN0eChjdHgpIHsKICBjb250ZXh0cy5wdXNoKGN0eCk7CiAgcmV0dXJuIG51bGw7Cn0KCmZ1bmN0aW9uIGl0ZXIoa2V5LCB2YWx1ZSkgewogIHZhciB2YWx1ZVByb3ZpZGVkID0gYXJndW1lbnRzLmxlbmd0aCA9PT0gMjsKCiAgZnVuY3Rpb24gaShpdGVtKSB7CiAgICB2YXIgY3VyID0gZ2V0KGl0ZW0sIGtleSk7CiAgICByZXR1cm4gdmFsdWVQcm92aWRlZCA/IHZhbHVlPT09Y3VyIDogISFjdXI7CiAgfQogIHJldHVybiBpIDsKfQoKLyoqCiAgVGhpcyBtaXhpbiBkZWZpbmVzIHRoZSBjb21tb24gaW50ZXJmYWNlIGltcGxlbWVudGVkIGJ5IGVudW1lcmFibGUgb2JqZWN0cwogIGluIEVtYmVyLiBNb3N0IG9mIHRoZXNlIG1ldGhvZHMgZm9sbG93IHRoZSBzdGFuZGFyZCBBcnJheSBpdGVyYXRpb24KICBBUEkgZGVmaW5lZCB1cCB0byBKYXZhU2NyaXB0IDEuOCAoZXhjbHVkaW5nIGxhbmd1YWdlLXNwZWNpZmljIGZlYXR1cmVzIHRoYXQKICBjYW5ub3QgYmUgZW11bGF0ZWQgaW4gb2xkZXIgdmVyc2lvbnMgb2YgSmF2YVNjcmlwdCkuCgogIFRoaXMgbWl4aW4gaXMgYXBwbGllZCBhdXRvbWF0aWNhbGx5IHRvIHRoZSBBcnJheSBjbGFzcyBvbiBwYWdlIGxvYWQsIHNvIHlvdQogIGNhbiB1c2UgYW55IG9mIHRoZXNlIG1ldGhvZHMgb24gc2ltcGxlIGFycmF5cy4gSWYgQXJyYXkgYWxyZWFkeSBpbXBsZW1lbnRzCiAgb25lIG9mIHRoZXNlIG1ldGhvZHMsIHRoZSBtaXhpbiB3aWxsIG5vdCBvdmVycmlkZSB0aGVtLgoKICAjIyBXcml0aW5nIFlvdXIgT3duIEVudW1lcmFibGUKCiAgVG8gbWFrZSB5b3VyIG93biBjdXN0b20gY2xhc3MgZW51bWVyYWJsZSwgeW91IG5lZWQgdHdvIGl0ZW1zOgoKICAxLiBZb3UgbXVzdCBoYXZlIGEgbGVuZ3RoIHByb3BlcnR5LiBUaGlzIHByb3BlcnR5IHNob3VsZCBjaGFuZ2Ugd2hlbmV2ZXIKICAgICB0aGUgbnVtYmVyIG9mIGl0ZW1zIGluIHlvdXIgZW51bWVyYWJsZSBvYmplY3QgY2hhbmdlcy4gSWYgeW91IHVzaW5nIHRoaXMKICAgICB3aXRoIGFuIGBFbWJlci5PYmplY3RgIHN1YmNsYXNzLCB5b3Ugc2hvdWxkIGJlIHN1cmUgdG8gY2hhbmdlIHRoZSBsZW5ndGgKICAgICBwcm9wZXJ0eSB1c2luZyBgc2V0KCkuYAoKICAyLiBZb3UgbXVzdCBpbXBsZW1lbnQgYG5leHRPYmplY3QoKS5gIFNlZSBkb2N1bWVudGF0aW9uLgoKICBPbmNlIHlvdSBoYXZlIHRoZXNlIHR3byBtZXRob2RzIGltcGxlbWVudCwgYXBwbHkgdGhlIGBFbWJlci5FbnVtZXJhYmxlYCBtaXhpbgogIHRvIHlvdXIgY2xhc3MgYW5kIHlvdSB3aWxsIGJlIGFibGUgdG8gZW51bWVyYXRlIHRoZSBjb250ZW50cyBvZiB5b3VyIG9iamVjdAogIGxpa2UgYW55IG90aGVyIGNvbGxlY3Rpb24uCgogICMjIFVzaW5nIEVtYmVyIEVudW1lcmF0aW9uIHdpdGggT3RoZXIgTGlicmFyaWVzCgogIE1hbnkgb3RoZXIgbGlicmFyaWVzIHByb3ZpZGUgc29tZSBraW5kIG9mIGl0ZXJhdG9yIG9yIGVudW1lcmF0aW9uIGxpa2UKICBmYWNpbGl0eS4gVGhpcyBpcyBvZnRlbiB3aGVyZSB0aGUgbW9zdCBjb21tb24gQVBJIGNvbmZsaWN0cyBvY2N1ci4KICBFbWJlcidzIEFQSSBpcyBkZXNpZ25lZCB0byBiZSBhcyBmcmllbmRseSBhcyBwb3NzaWJsZSB3aXRoIG90aGVyCiAgbGlicmFyaWVzIGJ5IGltcGxlbWVudGluZyBvbmx5IG1ldGhvZHMgdGhhdCBtb3N0bHkgY29ycmVzcG9uZCB0byB0aGUKICBKYXZhU2NyaXB0IDEuOCBBUEkuCgogIEBjbGFzcyBFbnVtZXJhYmxlCiAgQG5hbWVzcGFjZSBFbWJlcgogIEBzaW5jZSBFbWJlciAwLjkKKi8KRW1iZXIuRW51bWVyYWJsZSA9IEVtYmVyLk1peGluLmNyZWF0ZSh7CgogIC8qKgogICAgSW1wbGVtZW50IHRoaXMgbWV0aG9kIHRvIG1ha2UgeW91ciBjbGFzcyBlbnVtZXJhYmxlLgoKICAgIFRoaXMgbWV0aG9kIHdpbGwgYmUgY2FsbCByZXBlYXRlZGx5IGR1cmluZyBlbnVtZXJhdGlvbi4gVGhlIGluZGV4IHZhbHVlCiAgICB3aWxsIGFsd2F5cyBiZWdpbiB3aXRoIDAgYW5kIGluY3JlbWVudCBtb25vdG9uaWNhbGx5LiBZb3UgZG9uJ3QgaGF2ZSB0bwogICAgcmVseSBvbiB0aGUgaW5kZXggdmFsdWUgdG8gZGV0ZXJtaW5lIHdoYXQgb2JqZWN0IHRvIHJldHVybiwgYnV0IHlvdSBzaG91bGQKICAgIGFsd2F5cyBjaGVjayB0aGUgdmFsdWUgYW5kIHN0YXJ0IGZyb20gdGhlIGJlZ2lubmluZyB3aGVuIHlvdSBzZWUgdGhlCiAgICByZXF1ZXN0ZWQgaW5kZXggaXMgMC4KCiAgICBUaGUgYHByZXZpb3VzT2JqZWN0YCBpcyB0aGUgb2JqZWN0IHRoYXQgd2FzIHJldHVybmVkIGZyb20gdGhlIGxhc3QgY2FsbAogICAgdG8gYG5leHRPYmplY3RgIGZvciB0aGUgY3VycmVudCBpdGVyYXRpb24uIFRoaXMgaXMgYSB1c2VmdWwgd2F5IHRvCiAgICBtYW5hZ2UgaXRlcmF0aW9uIGlmIHlvdSBhcmUgdHJhY2luZyBhIGxpbmtlZCBsaXN0LCBmb3IgZXhhbXBsZS4KCiAgICBGaW5hbGx5IHRoZSBjb250ZXh0IHBhcmFtZXRlciB3aWxsIGFsd2F5cyBjb250YWluIGEgaGFzaCB5b3UgY2FuIHVzZSBhcwogICAgYSAic2NyYXRjaHBhZCIgdG8gbWFpbnRhaW4gYW55IG90aGVyIHN0YXRlIHlvdSBuZWVkIGluIG9yZGVyIHRvIGl0ZXJhdGUKICAgIHByb3Blcmx5LiBUaGUgY29udGV4dCBvYmplY3QgaXMgcmV1c2VkIGFuZCBpcyBub3QgcmVzZXQgYmV0d2VlbgogICAgaXRlcmF0aW9ucyBzbyBtYWtlIHN1cmUgeW91IHNldHVwIHRoZSBjb250ZXh0IHdpdGggYSBmcmVzaCBzdGF0ZSB3aGVuZXZlcgogICAgdGhlIGluZGV4IHBhcmFtZXRlciBpcyAwLgoKICAgIEdlbmVyYWxseSBpdGVyYXRvcnMgd2lsbCBjb250aW51ZSB0byBjYWxsIGBuZXh0T2JqZWN0YCB1bnRpbCB0aGUgaW5kZXgKICAgIHJlYWNoZXMgdGhlIHlvdXIgY3VycmVudCBsZW5ndGgtMS4gSWYgeW91IHJ1biBvdXQgb2YgZGF0YSBiZWZvcmUgdGhpcwogICAgdGltZSBmb3Igc29tZSByZWFzb24sIHlvdSBzaG91bGQgc2ltcGx5IHJldHVybiB1bmRlZmluZWQuCgogICAgVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgdGhpcyBtZXRob2Qgc2ltcGx5IGxvb2tzIHVwIHRoZSBpbmRleC4KICAgIFRoaXMgd29ya3MgZ3JlYXQgb24gYW55IEFycmF5LWxpa2Ugb2JqZWN0cy4KCiAgICBAbWV0aG9kIG5leHRPYmplY3QKICAgIEBwYXJhbSB7TnVtYmVyfSBpbmRleCB0aGUgY3VycmVudCBpbmRleCBvZiB0aGUgaXRlcmF0aW9uCiAgICBAcGFyYW0ge09iamVjdH0gcHJldmlvdXNPYmplY3QgdGhlIHZhbHVlIHJldHVybmVkIGJ5IHRoZSBsYXN0IGNhbGwgdG8KICAgICAgYG5leHRPYmplY3RgLgogICAgQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgYSBjb250ZXh0IG9iamVjdCB5b3UgY2FuIHVzZSB0byBtYWludGFpbiBzdGF0ZS4KICAgIEByZXR1cm4ge09iamVjdH0gdGhlIG5leHQgb2JqZWN0IGluIHRoZSBpdGVyYXRpb24gb3IgdW5kZWZpbmVkCiAgKi8KICBuZXh0T2JqZWN0OiBFbWJlci5yZXF1aXJlZChGdW5jdGlvbiksCgogIC8qKgogICAgSGVscGVyIG1ldGhvZCByZXR1cm5zIHRoZSBmaXJzdCBvYmplY3QgZnJvbSBhIGNvbGxlY3Rpb24uIFRoaXMgaXMgdXN1YWxseQogICAgdXNlZCBieSBiaW5kaW5ncyBhbmQgb3RoZXIgcGFydHMgb2YgdGhlIGZyYW1ld29yayB0byBleHRyYWN0IGEgc2luZ2xlCiAgICBvYmplY3QgaWYgdGhlIGVudW1lcmFibGUgY29udGFpbnMgb25seSBvbmUgaXRlbS4KCiAgICBJZiB5b3Ugb3ZlcnJpZGUgdGhpcyBtZXRob2QsIHlvdSBzaG91bGQgaW1wbGVtZW50IGl0IHNvIHRoYXQgaXQgd2lsbAogICAgYWx3YXlzIHJldHVybiB0aGUgc2FtZSB2YWx1ZSBlYWNoIHRpbWUgaXQgaXMgY2FsbGVkLiBJZiB5b3VyIGVudW1lcmFibGUKICAgIGNvbnRhaW5zIG9ubHkgb25lIG9iamVjdCwgdGhpcyBtZXRob2Qgc2hvdWxkIGFsd2F5cyByZXR1cm4gdGhhdCBvYmplY3QuCiAgICBJZiB5b3VyIGVudW1lcmFibGUgaXMgZW1wdHksIHRoaXMgbWV0aG9kIHNob3VsZCByZXR1cm4gYHVuZGVmaW5lZGAuCgogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIGFyciA9IFsiYSIsICJiIiwgImMiXTsKICAgIGFyci5nZXQoJ2ZpcnN0T2JqZWN0Jyk7ICAvLyAiYSIKCiAgICB2YXIgYXJyID0gW107CiAgICBhcnIuZ2V0KCdmaXJzdE9iamVjdCcpOyAgLy8gdW5kZWZpbmVkCiAgICBgYGAKCiAgICBAcHJvcGVydHkgZmlyc3RPYmplY3QKICAgIEByZXR1cm4ge09iamVjdH0gdGhlIG9iamVjdCBvciB1bmRlZmluZWQKICAqLwogIGZpcnN0T2JqZWN0OiBFbWJlci5jb21wdXRlZChmdW5jdGlvbigpIHsKICAgIGlmIChnZXQodGhpcywgJ2xlbmd0aCcpPT09MCkgcmV0dXJuIHVuZGVmaW5lZCA7CgogICAgLy8gaGFuZGxlIGdlbmVyaWMgZW51bWVyYWJsZXMKICAgIHZhciBjb250ZXh0ID0gcG9wQ3R4KCksIHJldDsKICAgIHJldCA9IHRoaXMubmV4dE9iamVjdCgwLCBudWxsLCBjb250ZXh0KTsKICAgIHB1c2hDdHgoY29udGV4dCk7CiAgICByZXR1cm4gcmV0IDsKICB9KS5wcm9wZXJ0eSgnW10nKSwKCiAgLyoqCiAgICBIZWxwZXIgbWV0aG9kIHJldHVybnMgdGhlIGxhc3Qgb2JqZWN0IGZyb20gYSBjb2xsZWN0aW9uLiBJZiB5b3VyIGVudW1lcmFibGUKICAgIGNvbnRhaW5zIG9ubHkgb25lIG9iamVjdCwgdGhpcyBtZXRob2Qgc2hvdWxkIGFsd2F5cyByZXR1cm4gdGhhdCBvYmplY3QuCiAgICBJZiB5b3VyIGVudW1lcmFibGUgaXMgZW1wdHksIHRoaXMgbWV0aG9kIHNob3VsZCByZXR1cm4gYHVuZGVmaW5lZGAuCgogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIGFyciA9IFsiYSIsICJiIiwgImMiXTsKICAgIGFyci5nZXQoJ2xhc3RPYmplY3QnKTsgIC8vICJjIgoKICAgIHZhciBhcnIgPSBbXTsKICAgIGFyci5nZXQoJ2xhc3RPYmplY3QnKTsgIC8vIHVuZGVmaW5lZAogICAgYGBgCgogICAgQHByb3BlcnR5IGxhc3RPYmplY3QKICAgIEByZXR1cm4ge09iamVjdH0gdGhlIGxhc3Qgb2JqZWN0IG9yIHVuZGVmaW5lZAogICovCiAgbGFzdE9iamVjdDogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oKSB7CiAgICB2YXIgbGVuID0gZ2V0KHRoaXMsICdsZW5ndGgnKTsKICAgIGlmIChsZW49PT0wKSByZXR1cm4gdW5kZWZpbmVkIDsKICAgIHZhciBjb250ZXh0ID0gcG9wQ3R4KCksIGlkeD0wLCBjdXIsIGxhc3QgPSBudWxsOwogICAgZG8gewogICAgICBsYXN0ID0gY3VyOwogICAgICBjdXIgPSB0aGlzLm5leHRPYmplY3QoaWR4KyssIGxhc3QsIGNvbnRleHQpOwogICAgfSB3aGlsZSAoY3VyICE9PSB1bmRlZmluZWQpOwogICAgcHVzaEN0eChjb250ZXh0KTsKICAgIHJldHVybiBsYXN0OwogIH0pLnByb3BlcnR5KCdbXScpLAoKICAvKioKICAgIFJldHVybnMgYHRydWVgIGlmIHRoZSBwYXNzZWQgb2JqZWN0IGNhbiBiZSBmb3VuZCBpbiB0aGUgcmVjZWl2ZXIuIFRoZQogICAgZGVmYXVsdCB2ZXJzaW9uIHdpbGwgaXRlcmF0ZSB0aHJvdWdoIHRoZSBlbnVtZXJhYmxlIHVudGlsIHRoZSBvYmplY3QKICAgIGlzIGZvdW5kLiBZb3UgbWF5IHdhbnQgdG8gb3ZlcnJpZGUgdGhpcyB3aXRoIGEgbW9yZSBlZmZpY2llbnQgdmVyc2lvbi4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgYXJyID0gWyJhIiwgImIiLCAiYyJdOwogICAgYXJyLmNvbnRhaW5zKCJhIik7IC8vIHRydWUKICAgIGFyci5jb250YWlucygieiIpOyAvLyBmYWxzZQogICAgYGBgCgogICAgQG1ldGhvZCBjb250YWlucwogICAgQHBhcmFtIHtPYmplY3R9IG9iaiBUaGUgb2JqZWN0IHRvIHNlYXJjaCBmb3IuCiAgICBAcmV0dXJuIHtCb29sZWFufSBgdHJ1ZWAgaWYgb2JqZWN0IGlzIGZvdW5kIGluIGVudW1lcmFibGUuCiAgKi8KICBjb250YWluczogZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gdGhpcy5maW5kKGZ1bmN0aW9uKGl0ZW0pIHsgcmV0dXJuIGl0ZW09PT1vYmo7IH0pICE9PSB1bmRlZmluZWQ7CiAgfSwKCiAgLyoqCiAgICBJdGVyYXRlcyB0aHJvdWdoIHRoZSBlbnVtZXJhYmxlLCBjYWxsaW5nIHRoZSBwYXNzZWQgZnVuY3Rpb24gb24gZWFjaAogICAgaXRlbS4gVGhpcyBtZXRob2QgY29ycmVzcG9uZHMgdG8gdGhlIGBmb3JFYWNoKClgIG1ldGhvZCBkZWZpbmVkIGluCiAgICBKYXZhU2NyaXB0IDEuNi4KCiAgICBUaGUgY2FsbGJhY2sgbWV0aG9kIHlvdSBwcm92aWRlIHNob3VsZCBoYXZlIHRoZSBmb2xsb3dpbmcgc2lnbmF0dXJlIChhbGwKICAgIHBhcmFtZXRlcnMgYXJlIG9wdGlvbmFsKToKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBmdW5jdGlvbihpdGVtLCBpbmRleCwgZW51bWVyYWJsZSk7CiAgICBgYGAKCiAgICAtIGBpdGVtYCBpcyB0aGUgY3VycmVudCBpdGVtIGluIHRoZSBpdGVyYXRpb24uCiAgICAtIGBpbmRleGAgaXMgdGhlIGN1cnJlbnQgaW5kZXggaW4gdGhlIGl0ZXJhdGlvbi4KICAgIC0gYGVudW1lcmFibGVgIGlzIHRoZSBlbnVtZXJhYmxlIG9iamVjdCBpdHNlbGYuCgogICAgTm90ZSB0aGF0IGluIGFkZGl0aW9uIHRvIGEgY2FsbGJhY2ssIHlvdSBjYW4gYWxzbyBwYXNzIGFuIG9wdGlvbmFsIHRhcmdldAogICAgb2JqZWN0IHRoYXQgd2lsbCBiZSBzZXQgYXMgYHRoaXNgIG9uIHRoZSBjb250ZXh0LiBUaGlzIGlzIGEgZ29vZCB3YXkKICAgIHRvIGdpdmUgeW91ciBpdGVyYXRvciBmdW5jdGlvbiBhY2Nlc3MgdG8gdGhlIGN1cnJlbnQgb2JqZWN0LgoKICAgIEBtZXRob2QgZm9yRWFjaAogICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIHRvIGV4ZWN1dGUKICAgIEBwYXJhbSB7T2JqZWN0fSBbdGFyZ2V0XSBUaGUgdGFyZ2V0IG9iamVjdCB0byB1c2UKICAgIEByZXR1cm4ge09iamVjdH0gcmVjZWl2ZXIKICAqLwogIGZvckVhY2g6IGZ1bmN0aW9uKGNhbGxiYWNrLCB0YXJnZXQpIHsKICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT09ICJmdW5jdGlvbiIpIHRocm93IG5ldyBUeXBlRXJyb3IoKSA7CiAgICB2YXIgbGVuID0gZ2V0KHRoaXMsICdsZW5ndGgnKSwgbGFzdCA9IG51bGwsIGNvbnRleHQgPSBwb3BDdHgoKTsKCiAgICBpZiAodGFyZ2V0ID09PSB1bmRlZmluZWQpIHRhcmdldCA9IG51bGw7CgogICAgZm9yKHZhciBpZHg9MDtpZHg8bGVuO2lkeCsrKSB7CiAgICAgIHZhciBuZXh0ID0gdGhpcy5uZXh0T2JqZWN0KGlkeCwgbGFzdCwgY29udGV4dCkgOwogICAgICBjYWxsYmFjay5jYWxsKHRhcmdldCwgbmV4dCwgaWR4LCB0aGlzKTsKICAgICAgbGFzdCA9IG5leHQgOwogICAgfQogICAgbGFzdCA9IG51bGwgOwogICAgY29udGV4dCA9IHB1c2hDdHgoY29udGV4dCk7CiAgICByZXR1cm4gdGhpcyA7CiAgfSwKCiAgLyoqCiAgICBBbGlhcyBmb3IgYG1hcEJ5YAoKICAgIEBtZXRob2QgZ2V0RWFjaAogICAgQHBhcmFtIHtTdHJpbmd9IGtleSBuYW1lIG9mIHRoZSBwcm9wZXJ0eQogICAgQHJldHVybiB7QXJyYXl9IFRoZSBtYXBwZWQgYXJyYXkuCiAgKi8KICBnZXRFYWNoOiBmdW5jdGlvbihrZXkpIHsKICAgIHJldHVybiB0aGlzLm1hcEJ5KGtleSk7CiAgfSwKCiAgLyoqCiAgICBTZXRzIHRoZSB2YWx1ZSBvbiB0aGUgbmFtZWQgcHJvcGVydHkgZm9yIGVhY2ggbWVtYmVyLiBUaGlzIGlzIG1vcmUKICAgIGVmZmljaWVudCB0aGFuIHVzaW5nIG90aGVyIG1ldGhvZHMgZGVmaW5lZCBvbiB0aGlzIGhlbHBlci4gSWYgdGhlIG9iamVjdAogICAgaW1wbGVtZW50cyBFbWJlci5PYnNlcnZhYmxlLCB0aGUgdmFsdWUgd2lsbCBiZSBjaGFuZ2VkIHRvIGBzZXQoKSxgIG90aGVyd2lzZQogICAgaXQgd2lsbCBiZSBzZXQgZGlyZWN0bHkuIGBudWxsYCBvYmplY3RzIGFyZSBza2lwcGVkLgoKICAgIEBtZXRob2Qgc2V0RWFjaAogICAgQHBhcmFtIHtTdHJpbmd9IGtleSBUaGUga2V5IHRvIHNldAogICAgQHBhcmFtIHtPYmplY3R9IHZhbHVlIFRoZSBvYmplY3QgdG8gc2V0CiAgICBAcmV0dXJuIHtPYmplY3R9IHJlY2VpdmVyCiAgKi8KICBzZXRFYWNoOiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICByZXR1cm4gdGhpcy5mb3JFYWNoKGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgc2V0KGl0ZW0sIGtleSwgdmFsdWUpOwogICAgfSk7CiAgfSwKCiAgLyoqCiAgICBNYXBzIGFsbCBvZiB0aGUgaXRlbXMgaW4gdGhlIGVudW1lcmF0aW9uIHRvIGFub3RoZXIgdmFsdWUsIHJldHVybmluZwogICAgYSBuZXcgYXJyYXkuIFRoaXMgbWV0aG9kIGNvcnJlc3BvbmRzIHRvIGBtYXAoKWAgZGVmaW5lZCBpbiBKYXZhU2NyaXB0IDEuNi4KCiAgICBUaGUgY2FsbGJhY2sgbWV0aG9kIHlvdSBwcm92aWRlIHNob3VsZCBoYXZlIHRoZSBmb2xsb3dpbmcgc2lnbmF0dXJlIChhbGwKICAgIHBhcmFtZXRlcnMgYXJlIG9wdGlvbmFsKToKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBmdW5jdGlvbihpdGVtLCBpbmRleCwgZW51bWVyYWJsZSk7CiAgICBgYGAKCiAgICAtIGBpdGVtYCBpcyB0aGUgY3VycmVudCBpdGVtIGluIHRoZSBpdGVyYXRpb24uCiAgICAtIGBpbmRleGAgaXMgdGhlIGN1cnJlbnQgaW5kZXggaW4gdGhlIGl0ZXJhdGlvbi4KICAgIC0gYGVudW1lcmFibGVgIGlzIHRoZSBlbnVtZXJhYmxlIG9iamVjdCBpdHNlbGYuCgogICAgSXQgc2hvdWxkIHJldHVybiB0aGUgbWFwcGVkIHZhbHVlLgoKICAgIE5vdGUgdGhhdCBpbiBhZGRpdGlvbiB0byBhIGNhbGxiYWNrLCB5b3UgY2FuIGFsc28gcGFzcyBhbiBvcHRpb25hbCB0YXJnZXQKICAgIG9iamVjdCB0aGF0IHdpbGwgYmUgc2V0IGFzIGB0aGlzYCBvbiB0aGUgY29udGV4dC4gVGhpcyBpcyBhIGdvb2Qgd2F5CiAgICB0byBnaXZlIHlvdXIgaXRlcmF0b3IgZnVuY3Rpb24gYWNjZXNzIHRvIHRoZSBjdXJyZW50IG9iamVjdC4KCiAgICBAbWV0aG9kIG1hcAogICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIHRvIGV4ZWN1dGUKICAgIEBwYXJhbSB7T2JqZWN0fSBbdGFyZ2V0XSBUaGUgdGFyZ2V0IG9iamVjdCB0byB1c2UKICAgIEByZXR1cm4ge0FycmF5fSBUaGUgbWFwcGVkIGFycmF5LgogICovCiAgbWFwOiBmdW5jdGlvbihjYWxsYmFjaywgdGFyZ2V0KSB7CiAgICB2YXIgcmV0ID0gRW1iZXIuQSgpOwogICAgdGhpcy5mb3JFYWNoKGZ1bmN0aW9uKHgsIGlkeCwgaSkgewogICAgICByZXRbaWR4XSA9IGNhbGxiYWNrLmNhbGwodGFyZ2V0LCB4LCBpZHgsaSk7CiAgICB9KTsKICAgIHJldHVybiByZXQgOwogIH0sCgogIC8qKgogICAgU2ltaWxhciB0byBtYXAsIHRoaXMgc3BlY2lhbGl6ZWQgZnVuY3Rpb24gcmV0dXJucyB0aGUgdmFsdWUgb2YgdGhlIG5hbWVkCiAgICBwcm9wZXJ0eSBvbiBhbGwgaXRlbXMgaW4gdGhlIGVudW1lcmF0aW9uLgoKICAgIEBtZXRob2QgbWFwQnkKICAgIEBwYXJhbSB7U3RyaW5nfSBrZXkgbmFtZSBvZiB0aGUgcHJvcGVydHkKICAgIEByZXR1cm4ge0FycmF5fSBUaGUgbWFwcGVkIGFycmF5LgogICovCiAgbWFwQnk6IGZ1bmN0aW9uKGtleSkgewogICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKG5leHQpIHsKICAgICAgcmV0dXJuIGdldChuZXh0LCBrZXkpOwogICAgfSk7CiAgfSwKCiAgLyoqCiAgICBTaW1pbGFyIHRvIG1hcCwgdGhpcyBzcGVjaWFsaXplZCBmdW5jdGlvbiByZXR1cm5zIHRoZSB2YWx1ZSBvZiB0aGUgbmFtZWQKICAgIHByb3BlcnR5IG9uIGFsbCBpdGVtcyBpbiB0aGUgZW51bWVyYXRpb24uCgogICAgQG1ldGhvZCBtYXBQcm9wZXJ0eQogICAgQHBhcmFtIHtTdHJpbmd9IGtleSBuYW1lIG9mIHRoZSBwcm9wZXJ0eQogICAgQHJldHVybiB7QXJyYXl9IFRoZSBtYXBwZWQgYXJyYXkuCiAgICBAZGVwcmVjYXRlZCBVc2UgYG1hcEJ5YCBpbnN0ZWFkCiAgKi8KCiAgbWFwUHJvcGVydHk6IEVtYmVyLmFsaWFzTWV0aG9kKCdtYXBCeScpLAoKICAvKioKICAgIFJldHVybnMgYW4gYXJyYXkgd2l0aCBhbGwgb2YgdGhlIGl0ZW1zIGluIHRoZSBlbnVtZXJhdGlvbiB0aGF0IHRoZSBwYXNzZWQKICAgIGZ1bmN0aW9uIHJldHVybnMgdHJ1ZSBmb3IuIFRoaXMgbWV0aG9kIGNvcnJlc3BvbmRzIHRvIGBmaWx0ZXIoKWAgZGVmaW5lZCBpbgogICAgSmF2YVNjcmlwdCAxLjYuCgogICAgVGhlIGNhbGxiYWNrIG1ldGhvZCB5b3UgcHJvdmlkZSBzaG91bGQgaGF2ZSB0aGUgZm9sbG93aW5nIHNpZ25hdHVyZSAoYWxsCiAgICBwYXJhbWV0ZXJzIGFyZSBvcHRpb25hbCk6CgogICAgYGBgamF2YXNjcmlwdAogICAgZnVuY3Rpb24oaXRlbSwgaW5kZXgsIGVudW1lcmFibGUpOwogICAgYGBgCgogICAgLSBgaXRlbWAgaXMgdGhlIGN1cnJlbnQgaXRlbSBpbiB0aGUgaXRlcmF0aW9uLgogICAgLSBgaW5kZXhgIGlzIHRoZSBjdXJyZW50IGluZGV4IGluIHRoZSBpdGVyYXRpb24uCiAgICAtIGBlbnVtZXJhYmxlYCBpcyB0aGUgZW51bWVyYWJsZSBvYmplY3QgaXRzZWxmLgoKICAgIEl0IHNob3VsZCByZXR1cm4gdGhlIGB0cnVlYCB0byBpbmNsdWRlIHRoZSBpdGVtIGluIHRoZSByZXN1bHRzLCBgZmFsc2VgCiAgICBvdGhlcndpc2UuCgogICAgTm90ZSB0aGF0IGluIGFkZGl0aW9uIHRvIGEgY2FsbGJhY2ssIHlvdSBjYW4gYWxzbyBwYXNzIGFuIG9wdGlvbmFsIHRhcmdldAogICAgb2JqZWN0IHRoYXQgd2lsbCBiZSBzZXQgYXMgYHRoaXNgIG9uIHRoZSBjb250ZXh0LiBUaGlzIGlzIGEgZ29vZCB3YXkKICAgIHRvIGdpdmUgeW91ciBpdGVyYXRvciBmdW5jdGlvbiBhY2Nlc3MgdG8gdGhlIGN1cnJlbnQgb2JqZWN0LgoKICAgIEBtZXRob2QgZmlsdGVyCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgdG8gZXhlY3V0ZQogICAgQHBhcmFtIHtPYmplY3R9IFt0YXJnZXRdIFRoZSB0YXJnZXQgb2JqZWN0IHRvIHVzZQogICAgQHJldHVybiB7QXJyYXl9IEEgZmlsdGVyZWQgYXJyYXkuCiAgKi8KICBmaWx0ZXI6IGZ1bmN0aW9uKGNhbGxiYWNrLCB0YXJnZXQpIHsKICAgIHZhciByZXQgPSBFbWJlci5BKCk7CiAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24oeCwgaWR4LCBpKSB7CiAgICAgIGlmIChjYWxsYmFjay5jYWxsKHRhcmdldCwgeCwgaWR4LCBpKSkgcmV0LnB1c2goeCk7CiAgICB9KTsKICAgIHJldHVybiByZXQgOwogIH0sCgogIC8qKgogICAgUmV0dXJucyBhbiBhcnJheSB3aXRoIGFsbCBvZiB0aGUgaXRlbXMgaW4gdGhlIGVudW1lcmF0aW9uIHdoZXJlIHRoZSBwYXNzZWQKICAgIGZ1bmN0aW9uIHJldHVybnMgZmFsc2UgZm9yLiBUaGlzIG1ldGhvZCBpcyB0aGUgaW52ZXJzZSBvZiBmaWx0ZXIoKS4KCiAgICBUaGUgY2FsbGJhY2sgbWV0aG9kIHlvdSBwcm92aWRlIHNob3VsZCBoYXZlIHRoZSBmb2xsb3dpbmcgc2lnbmF0dXJlIChhbGwKICAgIHBhcmFtZXRlcnMgYXJlIG9wdGlvbmFsKToKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBmdW5jdGlvbihpdGVtLCBpbmRleCwgZW51bWVyYWJsZSk7CiAgICBgYGAKCiAgICAtICppdGVtKiBpcyB0aGUgY3VycmVudCBpdGVtIGluIHRoZSBpdGVyYXRpb24uCiAgICAtICppbmRleCogaXMgdGhlIGN1cnJlbnQgaW5kZXggaW4gdGhlIGl0ZXJhdGlvbgogICAgLSAqZW51bWVyYWJsZSogaXMgdGhlIGVudW1lcmFibGUgb2JqZWN0IGl0c2VsZi4KCiAgICBJdCBzaG91bGQgcmV0dXJuIHRoZSBhIGZhbHNleSB2YWx1ZSB0byBpbmNsdWRlIHRoZSBpdGVtIGluIHRoZSByZXN1bHRzLgoKICAgIE5vdGUgdGhhdCBpbiBhZGRpdGlvbiB0byBhIGNhbGxiYWNrLCB5b3UgY2FuIGFsc28gcGFzcyBhbiBvcHRpb25hbCB0YXJnZXQKICAgIG9iamVjdCB0aGF0IHdpbGwgYmUgc2V0IGFzICJ0aGlzIiBvbiB0aGUgY29udGV4dC4gVGhpcyBpcyBhIGdvb2Qgd2F5CiAgICB0byBnaXZlIHlvdXIgaXRlcmF0b3IgZnVuY3Rpb24gYWNjZXNzIHRvIHRoZSBjdXJyZW50IG9iamVjdC4KCiAgICBAbWV0aG9kIHJlamVjdAogICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIHRvIGV4ZWN1dGUKICAgIEBwYXJhbSB7T2JqZWN0fSBbdGFyZ2V0XSBUaGUgdGFyZ2V0IG9iamVjdCB0byB1c2UKICAgIEByZXR1cm4ge0FycmF5fSBBIHJlamVjdGVkIGFycmF5LgogICAqLwogIHJlamVjdDogZnVuY3Rpb24oY2FsbGJhY2ssIHRhcmdldCkgewogICAgcmV0dXJuIHRoaXMuZmlsdGVyKGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gIShjYWxsYmFjay5hcHBseSh0YXJnZXQsIGFyZ3VtZW50cykpOwogICAgfSk7CiAgfSwKCiAgLyoqCiAgICBSZXR1cm5zIGFuIGFycmF5IHdpdGgganVzdCB0aGUgaXRlbXMgd2l0aCB0aGUgbWF0Y2hlZCBwcm9wZXJ0eS4gWW91CiAgICBjYW4gcGFzcyBhbiBvcHRpb25hbCBzZWNvbmQgYXJndW1lbnQgd2l0aCB0aGUgdGFyZ2V0IHZhbHVlLiBPdGhlcndpc2UKICAgIHRoaXMgd2lsbCBtYXRjaCBhbnkgcHJvcGVydHkgdGhhdCBldmFsdWF0ZXMgdG8gYHRydWVgLgoKICAgIEBtZXRob2QgZmlsdGVyQnkKICAgIEBwYXJhbSB7U3RyaW5nfSBrZXkgdGhlIHByb3BlcnR5IHRvIHRlc3QKICAgIEBwYXJhbSB7U3RyaW5nfSBbdmFsdWVdIG9wdGlvbmFsIHZhbHVlIHRvIHRlc3QgYWdhaW5zdC4KICAgIEByZXR1cm4ge0FycmF5fSBmaWx0ZXJlZCBhcnJheQogICovCiAgZmlsdGVyQnk6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgIHJldHVybiB0aGlzLmZpbHRlcihpdGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogIH0sCgogIC8qKgogICAgUmV0dXJucyBhbiBhcnJheSB3aXRoIGp1c3QgdGhlIGl0ZW1zIHdpdGggdGhlIG1hdGNoZWQgcHJvcGVydHkuIFlvdQogICAgY2FuIHBhc3MgYW4gb3B0aW9uYWwgc2Vjb25kIGFyZ3VtZW50IHdpdGggdGhlIHRhcmdldCB2YWx1ZS4gT3RoZXJ3aXNlCiAgICB0aGlzIHdpbGwgbWF0Y2ggYW55IHByb3BlcnR5IHRoYXQgZXZhbHVhdGVzIHRvIGB0cnVlYC4KCiAgICBAbWV0aG9kIGZpbHRlclByb3BlcnR5CiAgICBAcGFyYW0ge1N0cmluZ30ga2V5IHRoZSBwcm9wZXJ0eSB0byB0ZXN0CiAgICBAcGFyYW0ge1N0cmluZ30gW3ZhbHVlXSBvcHRpb25hbCB2YWx1ZSB0byB0ZXN0IGFnYWluc3QuCiAgICBAcmV0dXJuIHtBcnJheX0gZmlsdGVyZWQgYXJyYXkKICAgIEBkZXByZWNhdGVkIFVzZSBgZmlsdGVyQnlgIGluc3RlYWQKICAqLwogIGZpbHRlclByb3BlcnR5OiBFbWJlci5hbGlhc01ldGhvZCgnZmlsdGVyQnknKSwKCiAgLyoqCiAgICBSZXR1cm5zIGFuIGFycmF5IHdpdGggdGhlIGl0ZW1zIHRoYXQgZG8gbm90IGhhdmUgdHJ1dGh5IHZhbHVlcyBmb3IKICAgIGtleS4gIFlvdSBjYW4gcGFzcyBhbiBvcHRpb25hbCBzZWNvbmQgYXJndW1lbnQgd2l0aCB0aGUgdGFyZ2V0IHZhbHVlLiAgT3RoZXJ3aXNlCiAgICB0aGlzIHdpbGwgbWF0Y2ggYW55IHByb3BlcnR5IHRoYXQgZXZhbHVhdGVzIHRvIGZhbHNlLgoKICAgIEBtZXRob2QgcmVqZWN0QnkKICAgIEBwYXJhbSB7U3RyaW5nfSBrZXkgdGhlIHByb3BlcnR5IHRvIHRlc3QKICAgIEBwYXJhbSB7U3RyaW5nfSBbdmFsdWVdIG9wdGlvbmFsIHZhbHVlIHRvIHRlc3QgYWdhaW5zdC4KICAgIEByZXR1cm4ge0FycmF5fSByZWplY3RlZCBhcnJheQogICovCiAgcmVqZWN0Qnk6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgIHZhciBleGFjdFZhbHVlID0gZnVuY3Rpb24oaXRlbSkgeyByZXR1cm4gZ2V0KGl0ZW0sIGtleSkgPT09IHZhbHVlOyB9LAogICAgICAgIGhhc1ZhbHVlID0gZnVuY3Rpb24oaXRlbSkgeyByZXR1cm4gISFnZXQoaXRlbSwga2V5KTsgfSwKICAgICAgICB1c2UgPSAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMiA/IGV4YWN0VmFsdWUgOiBoYXNWYWx1ZSk7CgogICAgcmV0dXJuIHRoaXMucmVqZWN0KHVzZSk7CiAgfSwKCiAgLyoqCiAgICBSZXR1cm5zIGFuIGFycmF5IHdpdGggdGhlIGl0ZW1zIHRoYXQgZG8gbm90IGhhdmUgdHJ1dGh5IHZhbHVlcyBmb3IKICAgIGtleS4gIFlvdSBjYW4gcGFzcyBhbiBvcHRpb25hbCBzZWNvbmQgYXJndW1lbnQgd2l0aCB0aGUgdGFyZ2V0IHZhbHVlLiAgT3RoZXJ3aXNlCiAgICB0aGlzIHdpbGwgbWF0Y2ggYW55IHByb3BlcnR5IHRoYXQgZXZhbHVhdGVzIHRvIGZhbHNlLgoKICAgIEBtZXRob2QgcmVqZWN0UHJvcGVydHkKICAgIEBwYXJhbSB7U3RyaW5nfSBrZXkgdGhlIHByb3BlcnR5IHRvIHRlc3QKICAgIEBwYXJhbSB7U3RyaW5nfSBbdmFsdWVdIG9wdGlvbmFsIHZhbHVlIHRvIHRlc3QgYWdhaW5zdC4KICAgIEByZXR1cm4ge0FycmF5fSByZWplY3RlZCBhcnJheQogICAgQGRlcHJlY2F0ZWQgVXNlIGByZWplY3RCeWAgaW5zdGVhZAogICovCiAgcmVqZWN0UHJvcGVydHk6IEVtYmVyLmFsaWFzTWV0aG9kKCdyZWplY3RCeScpLAoKICAvKioKICAgIFJldHVybnMgdGhlIGZpcnN0IGl0ZW0gaW4gdGhlIGFycmF5IGZvciB3aGljaCB0aGUgY2FsbGJhY2sgcmV0dXJucyB0cnVlLgogICAgVGhpcyBtZXRob2Qgd29ya3Mgc2ltaWxhciB0byB0aGUgYGZpbHRlcigpYCBtZXRob2QgZGVmaW5lZCBpbiBKYXZhU2NyaXB0IDEuNgogICAgZXhjZXB0IHRoYXQgaXQgd2lsbCBzdG9wIHdvcmtpbmcgb24gdGhlIGFycmF5IG9uY2UgYSBtYXRjaCBpcyBmb3VuZC4KCiAgICBUaGUgY2FsbGJhY2sgbWV0aG9kIHlvdSBwcm92aWRlIHNob3VsZCBoYXZlIHRoZSBmb2xsb3dpbmcgc2lnbmF0dXJlIChhbGwKICAgIHBhcmFtZXRlcnMgYXJlIG9wdGlvbmFsKToKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBmdW5jdGlvbihpdGVtLCBpbmRleCwgZW51bWVyYWJsZSk7CiAgICBgYGAKCiAgICAtIGBpdGVtYCBpcyB0aGUgY3VycmVudCBpdGVtIGluIHRoZSBpdGVyYXRpb24uCiAgICAtIGBpbmRleGAgaXMgdGhlIGN1cnJlbnQgaW5kZXggaW4gdGhlIGl0ZXJhdGlvbi4KICAgIC0gYGVudW1lcmFibGVgIGlzIHRoZSBlbnVtZXJhYmxlIG9iamVjdCBpdHNlbGYuCgogICAgSXQgc2hvdWxkIHJldHVybiB0aGUgYHRydWVgIHRvIGluY2x1ZGUgdGhlIGl0ZW0gaW4gdGhlIHJlc3VsdHMsIGBmYWxzZWAKICAgIG90aGVyd2lzZS4KCiAgICBOb3RlIHRoYXQgaW4gYWRkaXRpb24gdG8gYSBjYWxsYmFjaywgeW91IGNhbiBhbHNvIHBhc3MgYW4gb3B0aW9uYWwgdGFyZ2V0CiAgICBvYmplY3QgdGhhdCB3aWxsIGJlIHNldCBhcyBgdGhpc2Agb24gdGhlIGNvbnRleHQuIFRoaXMgaXMgYSBnb29kIHdheQogICAgdG8gZ2l2ZSB5b3VyIGl0ZXJhdG9yIGZ1bmN0aW9uIGFjY2VzcyB0byB0aGUgY3VycmVudCBvYmplY3QuCgogICAgQG1ldGhvZCBmaW5kCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgdG8gZXhlY3V0ZQogICAgQHBhcmFtIHtPYmplY3R9IFt0YXJnZXRdIFRoZSB0YXJnZXQgb2JqZWN0IHRvIHVzZQogICAgQHJldHVybiB7T2JqZWN0fSBGb3VuZCBpdGVtIG9yIGB1bmRlZmluZWRgLgogICovCiAgZmluZDogZnVuY3Rpb24oY2FsbGJhY2ssIHRhcmdldCkgewogICAgdmFyIGxlbiA9IGdldCh0aGlzLCAnbGVuZ3RoJykgOwogICAgaWYgKHRhcmdldCA9PT0gdW5kZWZpbmVkKSB0YXJnZXQgPSBudWxsOwoKICAgIHZhciBsYXN0ID0gbnVsbCwgbmV4dCwgZm91bmQgPSBmYWxzZSwgcmV0IDsKICAgIHZhciBjb250ZXh0ID0gcG9wQ3R4KCk7CiAgICBmb3IodmFyIGlkeD0wO2lkeDxsZW4gJiYgIWZvdW5kO2lkeCsrKSB7CiAgICAgIG5leHQgPSB0aGlzLm5leHRPYmplY3QoaWR4LCBsYXN0LCBjb250ZXh0KSA7CiAgICAgIGlmIChmb3VuZCA9IGNhbGxiYWNrLmNhbGwodGFyZ2V0LCBuZXh0LCBpZHgsIHRoaXMpKSByZXQgPSBuZXh0IDsKICAgICAgbGFzdCA9IG5leHQgOwogICAgfQogICAgbmV4dCA9IGxhc3QgPSBudWxsIDsKICAgIGNvbnRleHQgPSBwdXNoQ3R4KGNvbnRleHQpOwogICAgcmV0dXJuIHJldCA7CiAgfSwKCiAgLyoqCiAgICBSZXR1cm5zIHRoZSBmaXJzdCBpdGVtIHdpdGggYSBwcm9wZXJ0eSBtYXRjaGluZyB0aGUgcGFzc2VkIHZhbHVlLiBZb3UKICAgIGNhbiBwYXNzIGFuIG9wdGlvbmFsIHNlY29uZCBhcmd1bWVudCB3aXRoIHRoZSB0YXJnZXQgdmFsdWUuIE90aGVyd2lzZQogICAgdGhpcyB3aWxsIG1hdGNoIGFueSBwcm9wZXJ0eSB0aGF0IGV2YWx1YXRlcyB0byBgdHJ1ZWAuCgogICAgVGhpcyBtZXRob2Qgd29ya3MgbXVjaCBsaWtlIHRoZSBtb3JlIGdlbmVyaWMgYGZpbmQoKWAgbWV0aG9kLgoKICAgIEBtZXRob2QgZmluZEJ5CiAgICBAcGFyYW0ge1N0cmluZ30ga2V5IHRoZSBwcm9wZXJ0eSB0byB0ZXN0CiAgICBAcGFyYW0ge1N0cmluZ30gW3ZhbHVlXSBvcHRpb25hbCB2YWx1ZSB0byB0ZXN0IGFnYWluc3QuCiAgICBAcmV0dXJuIHtPYmplY3R9IGZvdW5kIGl0ZW0gb3IgYHVuZGVmaW5lZGAKICAqLwogIGZpbmRCeTogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgcmV0dXJuIHRoaXMuZmluZChpdGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogIH0sCgogIC8qKgogICAgUmV0dXJucyB0aGUgZmlyc3QgaXRlbSB3aXRoIGEgcHJvcGVydHkgbWF0Y2hpbmcgdGhlIHBhc3NlZCB2YWx1ZS4gWW91CiAgICBjYW4gcGFzcyBhbiBvcHRpb25hbCBzZWNvbmQgYXJndW1lbnQgd2l0aCB0aGUgdGFyZ2V0IHZhbHVlLiBPdGhlcndpc2UKICAgIHRoaXMgd2lsbCBtYXRjaCBhbnkgcHJvcGVydHkgdGhhdCBldmFsdWF0ZXMgdG8gYHRydWVgLgoKICAgIFRoaXMgbWV0aG9kIHdvcmtzIG11Y2ggbGlrZSB0aGUgbW9yZSBnZW5lcmljIGBmaW5kKClgIG1ldGhvZC4KCiAgICBAbWV0aG9kIGZpbmRQcm9wZXJ0eQogICAgQHBhcmFtIHtTdHJpbmd9IGtleSB0aGUgcHJvcGVydHkgdG8gdGVzdAogICAgQHBhcmFtIHtTdHJpbmd9IFt2YWx1ZV0gb3B0aW9uYWwgdmFsdWUgdG8gdGVzdCBhZ2FpbnN0LgogICAgQHJldHVybiB7T2JqZWN0fSBmb3VuZCBpdGVtIG9yIGB1bmRlZmluZWRgCiAgICBAZGVwcmVjYXRlZCBVc2UgYGZpbmRCeWAgaW5zdGVhZAogICovCiAgZmluZFByb3BlcnR5OiBFbWJlci5hbGlhc01ldGhvZCgnZmluZEJ5JyksCgogIC8qKgogICAgUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHBhc3NlZCBmdW5jdGlvbiByZXR1cm5zIHRydWUgZm9yIGV2ZXJ5IGl0ZW0gaW4gdGhlCiAgICBlbnVtZXJhdGlvbi4gVGhpcyBjb3JyZXNwb25kcyB3aXRoIHRoZSBgZXZlcnkoKWAgbWV0aG9kIGluIEphdmFTY3JpcHQgMS42LgoKICAgIFRoZSBjYWxsYmFjayBtZXRob2QgeW91IHByb3ZpZGUgc2hvdWxkIGhhdmUgdGhlIGZvbGxvd2luZyBzaWduYXR1cmUgKGFsbAogICAgcGFyYW1ldGVycyBhcmUgb3B0aW9uYWwpOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIGZ1bmN0aW9uKGl0ZW0sIGluZGV4LCBlbnVtZXJhYmxlKTsKICAgIGBgYAoKICAgIC0gYGl0ZW1gIGlzIHRoZSBjdXJyZW50IGl0ZW0gaW4gdGhlIGl0ZXJhdGlvbi4KICAgIC0gYGluZGV4YCBpcyB0aGUgY3VycmVudCBpbmRleCBpbiB0aGUgaXRlcmF0aW9uLgogICAgLSBgZW51bWVyYWJsZWAgaXMgdGhlIGVudW1lcmFibGUgb2JqZWN0IGl0c2VsZi4KCiAgICBJdCBzaG91bGQgcmV0dXJuIHRoZSBgdHJ1ZWAgb3IgYGZhbHNlYC4KCiAgICBOb3RlIHRoYXQgaW4gYWRkaXRpb24gdG8gYSBjYWxsYmFjaywgeW91IGNhbiBhbHNvIHBhc3MgYW4gb3B0aW9uYWwgdGFyZ2V0CiAgICBvYmplY3QgdGhhdCB3aWxsIGJlIHNldCBhcyBgdGhpc2Agb24gdGhlIGNvbnRleHQuIFRoaXMgaXMgYSBnb29kIHdheQogICAgdG8gZ2l2ZSB5b3VyIGl0ZXJhdG9yIGZ1bmN0aW9uIGFjY2VzcyB0byB0aGUgY3VycmVudCBvYmplY3QuCgogICAgRXhhbXBsZSBVc2FnZToKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpZiAocGVvcGxlLmV2ZXJ5KGlzRW5naW5lZXIpKSB7IFBheWNoZWNrcy5hZGRCaWdCb251cygpOyB9CiAgICBgYGAKCiAgICBAbWV0aG9kIGV2ZXJ5CiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgdG8gZXhlY3V0ZQogICAgQHBhcmFtIHtPYmplY3R9IFt0YXJnZXRdIFRoZSB0YXJnZXQgb2JqZWN0IHRvIHVzZQogICAgQHJldHVybiB7Qm9vbGVhbn0KICAqLwogIGV2ZXJ5OiBmdW5jdGlvbihjYWxsYmFjaywgdGFyZ2V0KSB7CiAgICByZXR1cm4gIXRoaXMuZmluZChmdW5jdGlvbih4LCBpZHgsIGkpIHsKICAgICAgcmV0dXJuICFjYWxsYmFjay5jYWxsKHRhcmdldCwgeCwgaWR4LCBpKTsKICAgIH0pOwogIH0sCgogIC8qKgogICAgQG1ldGhvZCBldmVyeUJ5CiAgICBAcGFyYW0ge1N0cmluZ30ga2V5IHRoZSBwcm9wZXJ0eSB0byB0ZXN0CiAgICBAcGFyYW0ge1N0cmluZ30gW3ZhbHVlXSBvcHRpb25hbCB2YWx1ZSB0byB0ZXN0IGFnYWluc3QuCiAgICBAZGVwcmVjYXRlZCBVc2UgYGlzRXZlcnlgIGluc3RlYWQKICAgIEByZXR1cm4ge0Jvb2xlYW59CiAgKi8KICBldmVyeUJ5OiBFbWJlci5hbGlhc01ldGhvZCgnaXNFdmVyeScpLAoKICAvKioKICAgIEBtZXRob2QgZXZlcnlQcm9wZXJ0eQogICAgQHBhcmFtIHtTdHJpbmd9IGtleSB0aGUgcHJvcGVydHkgdG8gdGVzdAogICAgQHBhcmFtIHtTdHJpbmd9IFt2YWx1ZV0gb3B0aW9uYWwgdmFsdWUgdG8gdGVzdCBhZ2FpbnN0LgogICAgQGRlcHJlY2F0ZWQgVXNlIGBpc0V2ZXJ5YCBpbnN0ZWFkCiAgICBAcmV0dXJuIHtCb29sZWFufQogICovCiAgZXZlcnlQcm9wZXJ0eTogRW1iZXIuYWxpYXNNZXRob2QoJ2lzRXZlcnknKSwKCiAgLyoqCiAgICBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgcGFzc2VkIHByb3BlcnR5IHJlc29sdmVzIHRvIGB0cnVlYCBmb3IgYWxsIGl0ZW1zIGluCiAgICB0aGUgZW51bWVyYWJsZS4gVGhpcyBtZXRob2QgaXMgb2Z0ZW4gc2ltcGxlci9mYXN0ZXIgdGhhbiB1c2luZyBhIGNhbGxiYWNrLgoKICAgIEBtZXRob2QgaXNFdmVyeQogICAgQHBhcmFtIHtTdHJpbmd9IGtleSB0aGUgcHJvcGVydHkgdG8gdGVzdAogICAgQHBhcmFtIHtTdHJpbmd9IFt2YWx1ZV0gb3B0aW9uYWwgdmFsdWUgdG8gdGVzdCBhZ2FpbnN0LgogICAgQHJldHVybiB7Qm9vbGVhbn0KICAqLwogIGlzRXZlcnk6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgIHJldHVybiB0aGlzLmV2ZXJ5KGl0ZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgfSwKCiAgLyoqCiAgICBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgcGFzc2VkIGZ1bmN0aW9uIHJldHVybnMgdHJ1ZSBmb3IgYW55IGl0ZW0gaW4gdGhlCiAgICBlbnVtZXJhdGlvbi4gVGhpcyBjb3JyZXNwb25kcyB3aXRoIHRoZSBgc29tZSgpYCBtZXRob2QgaW4gSmF2YVNjcmlwdCAxLjYuCgogICAgVGhlIGNhbGxiYWNrIG1ldGhvZCB5b3UgcHJvdmlkZSBzaG91bGQgaGF2ZSB0aGUgZm9sbG93aW5nIHNpZ25hdHVyZSAoYWxsCiAgICBwYXJhbWV0ZXJzIGFyZSBvcHRpb25hbCk6CgogICAgYGBgamF2YXNjcmlwdAogICAgZnVuY3Rpb24oaXRlbSwgaW5kZXgsIGVudW1lcmFibGUpOwogICAgYGBgCgogICAgLSBgaXRlbWAgaXMgdGhlIGN1cnJlbnQgaXRlbSBpbiB0aGUgaXRlcmF0aW9uLgogICAgLSBgaW5kZXhgIGlzIHRoZSBjdXJyZW50IGluZGV4IGluIHRoZSBpdGVyYXRpb24uCiAgICAtIGBlbnVtZXJhYmxlYCBpcyB0aGUgZW51bWVyYWJsZSBvYmplY3QgaXRzZWxmLgoKICAgIEl0IHNob3VsZCByZXR1cm4gdGhlIGB0cnVlYCB0byBpbmNsdWRlIHRoZSBpdGVtIGluIHRoZSByZXN1bHRzLCBgZmFsc2VgCiAgICBvdGhlcndpc2UuCgogICAgTm90ZSB0aGF0IGluIGFkZGl0aW9uIHRvIGEgY2FsbGJhY2ssIHlvdSBjYW4gYWxzbyBwYXNzIGFuIG9wdGlvbmFsIHRhcmdldAogICAgb2JqZWN0IHRoYXQgd2lsbCBiZSBzZXQgYXMgYHRoaXNgIG9uIHRoZSBjb250ZXh0LiBUaGlzIGlzIGEgZ29vZCB3YXkKICAgIHRvIGdpdmUgeW91ciBpdGVyYXRvciBmdW5jdGlvbiBhY2Nlc3MgdG8gdGhlIGN1cnJlbnQgb2JqZWN0LgoKICAgIFVzYWdlIEV4YW1wbGU6CgogICAgYGBgamF2YXNjcmlwdAogICAgaWYgKHBlb3BsZS5hbnkoaXNNYW5hZ2VyKSkgeyBQYXljaGVja3MuYWRkQmlnZ2VyQm9udXMoKTsgfQogICAgYGBgCgogICAgQG1ldGhvZCBhbnkKICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayB0byBleGVjdXRlCiAgICBAcGFyYW0ge09iamVjdH0gW3RhcmdldF0gVGhlIHRhcmdldCBvYmplY3QgdG8gdXNlCiAgICBAcmV0dXJuIHtCb29sZWFufSBgdHJ1ZWAgaWYgdGhlIHBhc3NlZCBmdW5jdGlvbiByZXR1cm5zIGB0cnVlYCBmb3IgYW55IGl0ZW0KICAqLwogIGFueTogZnVuY3Rpb24oY2FsbGJhY2ssIHRhcmdldCkgewogICAgdmFyIGZvdW5kID0gdGhpcy5maW5kKGZ1bmN0aW9uKHgsIGlkeCwgaSkgewogICAgICByZXR1cm4gISFjYWxsYmFjay5jYWxsKHRhcmdldCwgeCwgaWR4LCBpKTsKICAgIH0pOwoKICAgIHJldHVybiB0eXBlb2YgZm91bmQgIT09ICd1bmRlZmluZWQnOwogIH0sCgogIC8qKgogICAgUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHBhc3NlZCBmdW5jdGlvbiByZXR1cm5zIHRydWUgZm9yIGFueSBpdGVtIGluIHRoZQogICAgZW51bWVyYXRpb24uIFRoaXMgY29ycmVzcG9uZHMgd2l0aCB0aGUgYHNvbWUoKWAgbWV0aG9kIGluIEphdmFTY3JpcHQgMS42LgoKICAgIFRoZSBjYWxsYmFjayBtZXRob2QgeW91IHByb3ZpZGUgc2hvdWxkIGhhdmUgdGhlIGZvbGxvd2luZyBzaWduYXR1cmUgKGFsbAogICAgcGFyYW1ldGVycyBhcmUgb3B0aW9uYWwpOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIGZ1bmN0aW9uKGl0ZW0sIGluZGV4LCBlbnVtZXJhYmxlKTsKICAgIGBgYAoKICAgIC0gYGl0ZW1gIGlzIHRoZSBjdXJyZW50IGl0ZW0gaW4gdGhlIGl0ZXJhdGlvbi4KICAgIC0gYGluZGV4YCBpcyB0aGUgY3VycmVudCBpbmRleCBpbiB0aGUgaXRlcmF0aW9uLgogICAgLSBgZW51bWVyYWJsZWAgaXMgdGhlIGVudW1lcmFibGUgb2JqZWN0IGl0c2VsZi4KCiAgICBJdCBzaG91bGQgcmV0dXJuIHRoZSBgdHJ1ZWAgdG8gaW5jbHVkZSB0aGUgaXRlbSBpbiB0aGUgcmVzdWx0cywgYGZhbHNlYAogICAgb3RoZXJ3aXNlLgoKICAgIE5vdGUgdGhhdCBpbiBhZGRpdGlvbiB0byBhIGNhbGxiYWNrLCB5b3UgY2FuIGFsc28gcGFzcyBhbiBvcHRpb25hbCB0YXJnZXQKICAgIG9iamVjdCB0aGF0IHdpbGwgYmUgc2V0IGFzIGB0aGlzYCBvbiB0aGUgY29udGV4dC4gVGhpcyBpcyBhIGdvb2Qgd2F5CiAgICB0byBnaXZlIHlvdXIgaXRlcmF0b3IgZnVuY3Rpb24gYWNjZXNzIHRvIHRoZSBjdXJyZW50IG9iamVjdC4KCiAgICBVc2FnZSBFeGFtcGxlOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIGlmIChwZW9wbGUuc29tZShpc01hbmFnZXIpKSB7IFBheWNoZWNrcy5hZGRCaWdnZXJCb251cygpOyB9CiAgICBgYGAKCiAgICBAbWV0aG9kIHNvbWUKICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayB0byBleGVjdXRlCiAgICBAcGFyYW0ge09iamVjdH0gW3RhcmdldF0gVGhlIHRhcmdldCBvYmplY3QgdG8gdXNlCiAgICBAcmV0dXJuIHtCb29sZWFufSBgdHJ1ZWAgaWYgdGhlIHBhc3NlZCBmdW5jdGlvbiByZXR1cm5zIGB0cnVlYCBmb3IgYW55IGl0ZW0KICAgIEBkZXByZWNhdGVkIFVzZSBgYW55YCBpbnN0ZWFkCiAgKi8KICBzb21lOiBFbWJlci5hbGlhc01ldGhvZCgnYW55JyksCgogIC8qKgogICAgUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHBhc3NlZCBwcm9wZXJ0eSByZXNvbHZlcyB0byBgdHJ1ZWAgZm9yIGFueSBpdGVtIGluCiAgICB0aGUgZW51bWVyYWJsZS4gVGhpcyBtZXRob2QgaXMgb2Z0ZW4gc2ltcGxlci9mYXN0ZXIgdGhhbiB1c2luZyBhIGNhbGxiYWNrLgoKICAgIEBtZXRob2QgaXNBbnkKICAgIEBwYXJhbSB7U3RyaW5nfSBrZXkgdGhlIHByb3BlcnR5IHRvIHRlc3QKICAgIEBwYXJhbSB7U3RyaW5nfSBbdmFsdWVdIG9wdGlvbmFsIHZhbHVlIHRvIHRlc3QgYWdhaW5zdC4KICAgIEByZXR1cm4ge0Jvb2xlYW59IGB0cnVlYCBpZiB0aGUgcGFzc2VkIGZ1bmN0aW9uIHJldHVybnMgYHRydWVgIGZvciBhbnkgaXRlbQogICovCiAgaXNBbnk6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgIHJldHVybiB0aGlzLmFueShpdGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogIH0sCgogIC8qKgogICAgQG1ldGhvZCBhbnlCeQogICAgQHBhcmFtIHtTdHJpbmd9IGtleSB0aGUgcHJvcGVydHkgdG8gdGVzdAogICAgQHBhcmFtIHtTdHJpbmd9IFt2YWx1ZV0gb3B0aW9uYWwgdmFsdWUgdG8gdGVzdCBhZ2FpbnN0LgogICAgQHJldHVybiB7Qm9vbGVhbn0gYHRydWVgIGlmIHRoZSBwYXNzZWQgZnVuY3Rpb24gcmV0dXJucyBgdHJ1ZWAgZm9yIGFueSBpdGVtCiAgICBAZGVwcmVjYXRlZCBVc2UgYGlzQW55YCBpbnN0ZWFkCiAgKi8KICBhbnlCeTogRW1iZXIuYWxpYXNNZXRob2QoJ2lzQW55JyksCgogIC8qKgogICAgQG1ldGhvZCBzb21lUHJvcGVydHkKICAgIEBwYXJhbSB7U3RyaW5nfSBrZXkgdGhlIHByb3BlcnR5IHRvIHRlc3QKICAgIEBwYXJhbSB7U3RyaW5nfSBbdmFsdWVdIG9wdGlvbmFsIHZhbHVlIHRvIHRlc3QgYWdhaW5zdC4KICAgIEByZXR1cm4ge0Jvb2xlYW59IGB0cnVlYCBpZiB0aGUgcGFzc2VkIGZ1bmN0aW9uIHJldHVybnMgYHRydWVgIGZvciBhbnkgaXRlbQogICAgQGRlcHJlY2F0ZWQgVXNlIGBpc0FueWAgaW5zdGVhZAogICovCiAgc29tZVByb3BlcnR5OiBFbWJlci5hbGlhc01ldGhvZCgnaXNBbnknKSwKCiAgLyoqCiAgICBUaGlzIHdpbGwgY29tYmluZSB0aGUgdmFsdWVzIG9mIHRoZSBlbnVtZXJhdG9yIGludG8gYSBzaW5nbGUgdmFsdWUuIEl0CiAgICBpcyBhIHVzZWZ1bCB3YXkgdG8gY29sbGVjdCBhIHN1bW1hcnkgdmFsdWUgZnJvbSBhbiBlbnVtZXJhdGlvbi4gVGhpcwogICAgY29ycmVzcG9uZHMgdG8gdGhlIGByZWR1Y2UoKWAgbWV0aG9kIGRlZmluZWQgaW4gSmF2YVNjcmlwdCAxLjguCgogICAgVGhlIGNhbGxiYWNrIG1ldGhvZCB5b3UgcHJvdmlkZSBzaG91bGQgaGF2ZSB0aGUgZm9sbG93aW5nIHNpZ25hdHVyZSAoYWxsCiAgICBwYXJhbWV0ZXJzIGFyZSBvcHRpb25hbCk6CgogICAgYGBgamF2YXNjcmlwdAogICAgZnVuY3Rpb24ocHJldmlvdXNWYWx1ZSwgaXRlbSwgaW5kZXgsIGVudW1lcmFibGUpOwogICAgYGBgCgogICAgLSBgcHJldmlvdXNWYWx1ZWAgaXMgdGhlIHZhbHVlIHJldHVybmVkIGJ5IHRoZSBsYXN0IGNhbGwgdG8gdGhlIGl0ZXJhdG9yLgogICAgLSBgaXRlbWAgaXMgdGhlIGN1cnJlbnQgaXRlbSBpbiB0aGUgaXRlcmF0aW9uLgogICAgLSBgaW5kZXhgIGlzIHRoZSBjdXJyZW50IGluZGV4IGluIHRoZSBpdGVyYXRpb24uCiAgICAtIGBlbnVtZXJhYmxlYCBpcyB0aGUgZW51bWVyYWJsZSBvYmplY3QgaXRzZWxmLgoKICAgIFJldHVybiB0aGUgbmV3IGN1bXVsYXRpdmUgdmFsdWUuCgogICAgSW4gYWRkaXRpb24gdG8gdGhlIGNhbGxiYWNrIHlvdSBjYW4gYWxzbyBwYXNzIGFuIGBpbml0aWFsVmFsdWVgLiBBbiBlcnJvcgogICAgd2lsbCBiZSByYWlzZWQgaWYgeW91IGRvIG5vdCBwYXNzIGFuIGluaXRpYWwgdmFsdWUgYW5kIHRoZSBlbnVtZXJhdG9yIGlzCiAgICBlbXB0eS4KCiAgICBOb3RlIHRoYXQgdW5saWtlIHRoZSBvdGhlciBtZXRob2RzLCB0aGlzIG1ldGhvZCBkb2VzIG5vdCBhbGxvdyB5b3UgdG8KICAgIHBhc3MgYSB0YXJnZXQgb2JqZWN0IHRvIHNldCBhcyB0aGlzIGZvciB0aGUgY2FsbGJhY2suIEl0J3MgcGFydCBvZiB0aGUKICAgIHNwZWMuIFNvcnJ5LgoKICAgIEBtZXRob2QgcmVkdWNlCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgdG8gZXhlY3V0ZQogICAgQHBhcmFtIHtPYmplY3R9IGluaXRpYWxWYWx1ZSBJbml0aWFsIHZhbHVlIGZvciB0aGUgcmVkdWNlCiAgICBAcGFyYW0ge1N0cmluZ30gcmVkdWNlclByb3BlcnR5IGludGVybmFsIHVzZSBvbmx5LgogICAgQHJldHVybiB7T2JqZWN0fSBUaGUgcmVkdWNlZCB2YWx1ZS4KICAqLwogIHJlZHVjZTogZnVuY3Rpb24oY2FsbGJhY2ssIGluaXRpYWxWYWx1ZSwgcmVkdWNlclByb3BlcnR5KSB7CiAgICBpZiAodHlwZW9mIGNhbGxiYWNrICE9PSAiZnVuY3Rpb24iKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoKTsgfQoKICAgIHZhciByZXQgPSBpbml0aWFsVmFsdWU7CgogICAgdGhpcy5mb3JFYWNoKGZ1bmN0aW9uKGl0ZW0sIGkpIHsKICAgICAgcmV0ID0gY2FsbGJhY2suY2FsbChudWxsLCByZXQsIGl0ZW0sIGksIHRoaXMsIHJlZHVjZXJQcm9wZXJ0eSk7CiAgICB9LCB0aGlzKTsKCiAgICByZXR1cm4gcmV0OwogIH0sCgogIC8qKgogICAgSW52b2tlcyB0aGUgbmFtZWQgbWV0aG9kIG9uIGV2ZXJ5IG9iamVjdCBpbiB0aGUgcmVjZWl2ZXIgdGhhdAogICAgaW1wbGVtZW50cyBpdC4gVGhpcyBtZXRob2QgY29ycmVzcG9uZHMgdG8gdGhlIGltcGxlbWVudGF0aW9uIGluCiAgICBQcm90b3R5cGUgMS42LgoKICAgIEBtZXRob2QgaW52b2tlCiAgICBAcGFyYW0ge1N0cmluZ30gbWV0aG9kTmFtZSB0aGUgbmFtZSBvZiB0aGUgbWV0aG9kCiAgICBAcGFyYW0ge09iamVjdC4uLn0gYXJncyBvcHRpb25hbCBhcmd1bWVudHMgdG8gcGFzcyBhcyB3ZWxsLgogICAgQHJldHVybiB7QXJyYXl9IHJldHVybiB2YWx1ZXMgZnJvbSBjYWxsaW5nIGludm9rZS4KICAqLwogIGludm9rZTogZnVuY3Rpb24obWV0aG9kTmFtZSkgewogICAgdmFyIGFyZ3MsIHJldCA9IEVtYmVyLkEoKTsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoPjEpIGFyZ3MgPSBhX3NsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCiAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24oeCwgaWR4KSB7CiAgICAgIHZhciBtZXRob2QgPSB4ICYmIHhbbWV0aG9kTmFtZV07CiAgICAgIGlmICgnZnVuY3Rpb24nID09PSB0eXBlb2YgbWV0aG9kKSB7CiAgICAgICAgcmV0W2lkeF0gPSBhcmdzID8gbWV0aG9kLmFwcGx5KHgsIGFyZ3MpIDogbWV0aG9kLmNhbGwoeCk7CiAgICAgIH0KICAgIH0sIHRoaXMpOwoKICAgIHJldHVybiByZXQ7CiAgfSwKCiAgLyoqCiAgICBTaW1wbHkgY29udmVydHMgdGhlIGVudW1lcmFibGUgaW50byBhIGdlbnVpbmUgYXJyYXkuIFRoZSBvcmRlciBpcyBub3QKICAgIGd1YXJhbnRlZWQuIENvcnJlc3BvbmRzIHRvIHRoZSBtZXRob2QgaW1wbGVtZW50ZWQgYnkgUHJvdG90eXBlLgoKICAgIEBtZXRob2QgdG9BcnJheQogICAgQHJldHVybiB7QXJyYXl9IHRoZSBlbnVtZXJhYmxlIGFzIGFuIGFycmF5LgogICovCiAgdG9BcnJheTogZnVuY3Rpb24oKSB7CiAgICB2YXIgcmV0ID0gRW1iZXIuQSgpOwogICAgdGhpcy5mb3JFYWNoKGZ1bmN0aW9uKG8sIGlkeCkgeyByZXRbaWR4XSA9IG87IH0pOwogICAgcmV0dXJuIHJldCA7CiAgfSwKCiAgLyoqCiAgICBSZXR1cm5zIGEgY29weSBvZiB0aGUgYXJyYXkgd2l0aCBhbGwgbnVsbCBhbmQgdW5kZWZpbmVkIGVsZW1lbnRzIHJlbW92ZWQuCgogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIGFyciA9IFsiYSIsIG51bGwsICJjIiwgdW5kZWZpbmVkXTsKICAgIGFyci5jb21wYWN0KCk7ICAvLyBbImEiLCAiYyJdCiAgICBgYGAKCiAgICBAbWV0aG9kIGNvbXBhY3QKICAgIEByZXR1cm4ge0FycmF5fSB0aGUgYXJyYXkgd2l0aG91dCBudWxsIGFuZCB1bmRlZmluZWQgZWxlbWVudHMuCiAgKi8KICBjb21wYWN0OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmZpbHRlcihmdW5jdGlvbih2YWx1ZSkgeyByZXR1cm4gdmFsdWUgIT0gbnVsbDsgfSk7CiAgfSwKCiAgLyoqCiAgICBSZXR1cm5zIGEgbmV3IGVudW1lcmFibGUgdGhhdCBleGNsdWRlcyB0aGUgcGFzc2VkIHZhbHVlLiBUaGUgZGVmYXVsdAogICAgaW1wbGVtZW50YXRpb24gcmV0dXJucyBhbiBhcnJheSByZWdhcmRsZXNzIG9mIHRoZSByZWNlaXZlciB0eXBlIHVubGVzcwogICAgdGhlIHJlY2VpdmVyIGRvZXMgbm90IGNvbnRhaW4gdGhlIHZhbHVlLgoKICAgIGBgYGphdmFzY3JpcHQKICAgIHZhciBhcnIgPSBbImEiLCAiYiIsICJhIiwgImMiXTsKICAgIGFyci53aXRob3V0KCJhIik7ICAvLyBbImIiLCAiYyJdCiAgICBgYGAKCiAgICBAbWV0aG9kIHdpdGhvdXQKICAgIEBwYXJhbSB7T2JqZWN0fSB2YWx1ZQogICAgQHJldHVybiB7RW1iZXIuRW51bWVyYWJsZX0KICAqLwogIHdpdGhvdXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICBpZiAoIXRoaXMuY29udGFpbnModmFsdWUpKSByZXR1cm4gdGhpczsgLy8gbm90aGluZyB0byBkbwogICAgdmFyIHJldCA9IEVtYmVyLkEoKTsKICAgIHRoaXMuZm9yRWFjaChmdW5jdGlvbihrKSB7CiAgICAgIGlmIChrICE9PSB2YWx1ZSkgcmV0W3JldC5sZW5ndGhdID0gazsKICAgIH0pIDsKICAgIHJldHVybiByZXQgOwogIH0sCgogIC8qKgogICAgUmV0dXJucyBhIG5ldyBlbnVtZXJhYmxlIHRoYXQgY29udGFpbnMgb25seSB1bmlxdWUgdmFsdWVzLiBUaGUgZGVmYXVsdAogICAgaW1wbGVtZW50YXRpb24gcmV0dXJucyBhbiBhcnJheSByZWdhcmRsZXNzIG9mIHRoZSByZWNlaXZlciB0eXBlLgoKICAgIGBgYGphdmFzY3JpcHQKICAgIHZhciBhcnIgPSBbImEiLCAiYSIsICJiIiwgImIiXTsKICAgIGFyci51bmlxKCk7ICAvLyBbImEiLCAiYiJdCiAgICBgYGAKCiAgICBAbWV0aG9kIHVuaXEKICAgIEByZXR1cm4ge0VtYmVyLkVudW1lcmFibGV9CiAgKi8KICB1bmlxOiBmdW5jdGlvbigpIHsKICAgIHZhciByZXQgPSBFbWJlci5BKCk7CiAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24oaykgewogICAgICBpZiAoYV9pbmRleE9mKHJldCwgayk8MCkgcmV0LnB1c2goayk7CiAgICB9KTsKICAgIHJldHVybiByZXQ7CiAgfSwKCiAgLyoqCiAgICBUaGlzIHByb3BlcnR5IHdpbGwgdHJpZ2dlciBhbnl0aW1lIHRoZSBlbnVtZXJhYmxlJ3MgY29udGVudCBjaGFuZ2VzLgogICAgWW91IGNhbiBvYnNlcnZlIHRoaXMgcHJvcGVydHkgdG8gYmUgbm90aWZpZWQgb2YgY2hhbmdlcyB0byB0aGUgZW51bWVyYWJsZXMKICAgIGNvbnRlbnQuCgogICAgRm9yIHBsYWluIGVudW1lcmFibGVzLCB0aGlzIHByb3BlcnR5IGlzIHJlYWQgb25seS4gYEVtYmVyLkFycmF5YCBvdmVycmlkZXMKICAgIHRoaXMgbWV0aG9kLgoKICAgIEBwcm9wZXJ0eSBbXQogICAgQHR5cGUgRW1iZXIuQXJyYXkKICAgIEByZXR1cm4gdGhpcwogICovCiAgJ1tdJzogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgcmV0dXJuIHRoaXM7CiAgfSksCgogIC8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KICAvLyBFTlVNRVJBQkxFIE9CU0VSVkVSUwogIC8vCgogIC8qKgogICAgUmVnaXN0ZXJzIGFuIGVudW1lcmFibGUgb2JzZXJ2ZXIuIE11c3QgaW1wbGVtZW50IGBFbWJlci5FbnVtZXJhYmxlT2JzZXJ2ZXJgCiAgICBtaXhpbi4KCiAgICBAbWV0aG9kIGFkZEVudW1lcmFibGVPYnNlcnZlcgogICAgQHBhcmFtIHtPYmplY3R9IHRhcmdldAogICAgQHBhcmFtIHtIYXNofSBbb3B0c10KICAgIEByZXR1cm4gdGhpcwogICovCiAgYWRkRW51bWVyYWJsZU9ic2VydmVyOiBmdW5jdGlvbih0YXJnZXQsIG9wdHMpIHsKICAgIHZhciB3aWxsQ2hhbmdlID0gKG9wdHMgJiYgb3B0cy53aWxsQ2hhbmdlKSB8fCAnZW51bWVyYWJsZVdpbGxDaGFuZ2UnLAogICAgICAgIGRpZENoYW5nZSAgPSAob3B0cyAmJiBvcHRzLmRpZENoYW5nZSkgfHwgJ2VudW1lcmFibGVEaWRDaGFuZ2UnOwoKICAgIHZhciBoYXNPYnNlcnZlcnMgPSBnZXQodGhpcywgJ2hhc0VudW1lcmFibGVPYnNlcnZlcnMnKTsKICAgIGlmICghaGFzT2JzZXJ2ZXJzKSBFbWJlci5wcm9wZXJ0eVdpbGxDaGFuZ2UodGhpcywgJ2hhc0VudW1lcmFibGVPYnNlcnZlcnMnKTsKICAgIEVtYmVyLmFkZExpc3RlbmVyKHRoaXMsICdAZW51bWVyYWJsZTpiZWZvcmUnLCB0YXJnZXQsIHdpbGxDaGFuZ2UpOwogICAgRW1iZXIuYWRkTGlzdGVuZXIodGhpcywgJ0BlbnVtZXJhYmxlOmNoYW5nZScsIHRhcmdldCwgZGlkQ2hhbmdlKTsKICAgIGlmICghaGFzT2JzZXJ2ZXJzKSBFbWJlci5wcm9wZXJ0eURpZENoYW5nZSh0aGlzLCAnaGFzRW51bWVyYWJsZU9ic2VydmVycycpOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICBSZW1vdmVzIGEgcmVnaXN0ZXJlZCBlbnVtZXJhYmxlIG9ic2VydmVyLgoKICAgIEBtZXRob2QgcmVtb3ZlRW51bWVyYWJsZU9ic2VydmVyCiAgICBAcGFyYW0ge09iamVjdH0gdGFyZ2V0CiAgICBAcGFyYW0ge0hhc2h9IFtvcHRzXQogICAgQHJldHVybiB0aGlzCiAgKi8KICByZW1vdmVFbnVtZXJhYmxlT2JzZXJ2ZXI6IGZ1bmN0aW9uKHRhcmdldCwgb3B0cykgewogICAgdmFyIHdpbGxDaGFuZ2UgPSAob3B0cyAmJiBvcHRzLndpbGxDaGFuZ2UpIHx8ICdlbnVtZXJhYmxlV2lsbENoYW5nZScsCiAgICAgICAgZGlkQ2hhbmdlICA9IChvcHRzICYmIG9wdHMuZGlkQ2hhbmdlKSB8fCAnZW51bWVyYWJsZURpZENoYW5nZSc7CgogICAgdmFyIGhhc09ic2VydmVycyA9IGdldCh0aGlzLCAnaGFzRW51bWVyYWJsZU9ic2VydmVycycpOwogICAgaWYgKGhhc09ic2VydmVycykgRW1iZXIucHJvcGVydHlXaWxsQ2hhbmdlKHRoaXMsICdoYXNFbnVtZXJhYmxlT2JzZXJ2ZXJzJyk7CiAgICBFbWJlci5yZW1vdmVMaXN0ZW5lcih0aGlzLCAnQGVudW1lcmFibGU6YmVmb3JlJywgdGFyZ2V0LCB3aWxsQ2hhbmdlKTsKICAgIEVtYmVyLnJlbW92ZUxpc3RlbmVyKHRoaXMsICdAZW51bWVyYWJsZTpjaGFuZ2UnLCB0YXJnZXQsIGRpZENoYW5nZSk7CiAgICBpZiAoaGFzT2JzZXJ2ZXJzKSBFbWJlci5wcm9wZXJ0eURpZENoYW5nZSh0aGlzLCAnaGFzRW51bWVyYWJsZU9ic2VydmVycycpOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICBCZWNvbWVzIHRydWUgd2hlbmV2ZXIgdGhlIGFycmF5IGN1cnJlbnRseSBoYXMgb2JzZXJ2ZXJzIHdhdGNoaW5nIGNoYW5nZXMKICAgIG9uIHRoZSBhcnJheS4KCiAgICBAcHJvcGVydHkgaGFzRW51bWVyYWJsZU9ic2VydmVycwogICAgQHR5cGUgQm9vbGVhbgogICovCiAgaGFzRW51bWVyYWJsZU9ic2VydmVyczogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gRW1iZXIuaGFzTGlzdGVuZXJzKHRoaXMsICdAZW51bWVyYWJsZTpjaGFuZ2UnKSB8fCBFbWJlci5oYXNMaXN0ZW5lcnModGhpcywgJ0BlbnVtZXJhYmxlOmJlZm9yZScpOwogIH0pLAoKCiAgLyoqCiAgICBJbnZva2UgdGhpcyBtZXRob2QganVzdCBiZWZvcmUgdGhlIGNvbnRlbnRzIG9mIHlvdXIgZW51bWVyYWJsZSB3aWxsCiAgICBjaGFuZ2UuIFlvdSBjYW4gZWl0aGVyIG9taXQgdGhlIHBhcmFtZXRlcnMgY29tcGxldGVseSBvciBwYXNzIHRoZSBvYmplY3RzCiAgICB0byBiZSByZW1vdmVkIG9yIGFkZGVkIGlmIGF2YWlsYWJsZSBvciBqdXN0IGEgY291bnQuCgogICAgQG1ldGhvZCBlbnVtZXJhYmxlQ29udGVudFdpbGxDaGFuZ2UKICAgIEBwYXJhbSB7RW1iZXIuRW51bWVyYWJsZXxOdW1iZXJ9IHJlbW92aW5nIEFuIGVudW1lcmFibGUgb2YgdGhlIG9iamVjdHMgdG8KICAgICAgYmUgcmVtb3ZlZCBvciB0aGUgbnVtYmVyIG9mIGl0ZW1zIHRvIGJlIHJlbW92ZWQuCiAgICBAcGFyYW0ge0VtYmVyLkVudW1lcmFibGV8TnVtYmVyfSBhZGRpbmcgQW4gZW51bWVyYWJsZSBvZiB0aGUgb2JqZWN0cyB0byBiZQogICAgICBhZGRlZCBvciB0aGUgbnVtYmVyIG9mIGl0ZW1zIHRvIGJlIGFkZGVkLgogICAgQGNoYWluYWJsZQogICovCiAgZW51bWVyYWJsZUNvbnRlbnRXaWxsQ2hhbmdlOiBmdW5jdGlvbihyZW1vdmluZywgYWRkaW5nKSB7CgogICAgdmFyIHJlbW92ZUNudCwgYWRkQ250LCBoYXNEZWx0YTsKCiAgICBpZiAoJ251bWJlcicgPT09IHR5cGVvZiByZW1vdmluZykgcmVtb3ZlQ250ID0gcmVtb3Zpbmc7CiAgICBlbHNlIGlmIChyZW1vdmluZykgcmVtb3ZlQ250ID0gZ2V0KHJlbW92aW5nLCAnbGVuZ3RoJyk7CiAgICBlbHNlIHJlbW92ZUNudCA9IHJlbW92aW5nID0gLTE7CgogICAgaWYgKCdudW1iZXInID09PSB0eXBlb2YgYWRkaW5nKSBhZGRDbnQgPSBhZGRpbmc7CiAgICBlbHNlIGlmIChhZGRpbmcpIGFkZENudCA9IGdldChhZGRpbmcsJ2xlbmd0aCcpOwogICAgZWxzZSBhZGRDbnQgPSBhZGRpbmcgPSAtMTsKCiAgICBoYXNEZWx0YSA9IGFkZENudDwwIHx8IHJlbW92ZUNudDwwIHx8IGFkZENudC1yZW1vdmVDbnQhPT0wOwoKICAgIGlmIChyZW1vdmluZyA9PT0gLTEpIHJlbW92aW5nID0gbnVsbDsKICAgIGlmIChhZGRpbmcgICA9PT0gLTEpIGFkZGluZyAgID0gbnVsbDsKCiAgICBFbWJlci5wcm9wZXJ0eVdpbGxDaGFuZ2UodGhpcywgJ1tdJyk7CiAgICBpZiAoaGFzRGVsdGEpIEVtYmVyLnByb3BlcnR5V2lsbENoYW5nZSh0aGlzLCAnbGVuZ3RoJyk7CiAgICBFbWJlci5zZW5kRXZlbnQodGhpcywgJ0BlbnVtZXJhYmxlOmJlZm9yZScsIFt0aGlzLCByZW1vdmluZywgYWRkaW5nXSk7CgogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICBJbnZva2UgdGhpcyBtZXRob2Qgd2hlbiB0aGUgY29udGVudHMgb2YgeW91ciBlbnVtZXJhYmxlIGhhcyBjaGFuZ2VkLgogICAgVGhpcyB3aWxsIG5vdGlmeSBhbnkgb2JzZXJ2ZXJzIHdhdGNoaW5nIGZvciBjb250ZW50IGNoYW5nZXMuIElmIHlvdXIgYXJlCiAgICBpbXBsZW1lbnRpbmcgYW4gb3JkZXJlZCBlbnVtZXJhYmxlIChzdWNoIGFzIGFuIGFycmF5KSwgYWxzbyBwYXNzIHRoZQogICAgc3RhcnQgYW5kIGVuZCB2YWx1ZXMgd2hlcmUgdGhlIGNvbnRlbnQgY2hhbmdlZCBzbyB0aGF0IGl0IGNhbiBiZSB1c2VkIHRvCiAgICBub3RpZnkgcmFuZ2Ugb2JzZXJ2ZXJzLgoKICAgIEBtZXRob2QgZW51bWVyYWJsZUNvbnRlbnREaWRDaGFuZ2UKICAgIEBwYXJhbSB7TnVtYmVyfSBbc3RhcnRdIG9wdGlvbmFsIHN0YXJ0IG9mZnNldCBmb3IgdGhlIGNvbnRlbnQgY2hhbmdlLgogICAgICBGb3IgdW5vcmRlcmVkIGVudW1lcmFibGVzLCB5b3Ugc2hvdWxkIGFsd2F5cyBwYXNzIC0xLgogICAgQHBhcmFtIHtFbWJlci5FbnVtZXJhYmxlfE51bWJlcn0gcmVtb3ZpbmcgQW4gZW51bWVyYWJsZSBvZiB0aGUgb2JqZWN0cyB0bwogICAgICBiZSByZW1vdmVkIG9yIHRoZSBudW1iZXIgb2YgaXRlbXMgdG8gYmUgcmVtb3ZlZC4KICAgIEBwYXJhbSB7RW1iZXIuRW51bWVyYWJsZXxOdW1iZXJ9IGFkZGluZyAgQW4gZW51bWVyYWJsZSBvZiB0aGUgb2JqZWN0cyB0bwogICAgICBiZSBhZGRlZCBvciB0aGUgbnVtYmVyIG9mIGl0ZW1zIHRvIGJlIGFkZGVkLgogICAgQGNoYWluYWJsZQogICovCiAgZW51bWVyYWJsZUNvbnRlbnREaWRDaGFuZ2U6IGZ1bmN0aW9uKHJlbW92aW5nLCBhZGRpbmcpIHsKICAgIHZhciByZW1vdmVDbnQsIGFkZENudCwgaGFzRGVsdGE7CgogICAgaWYgKCdudW1iZXInID09PSB0eXBlb2YgcmVtb3ZpbmcpIHJlbW92ZUNudCA9IHJlbW92aW5nOwogICAgZWxzZSBpZiAocmVtb3ZpbmcpIHJlbW92ZUNudCA9IGdldChyZW1vdmluZywgJ2xlbmd0aCcpOwogICAgZWxzZSByZW1vdmVDbnQgPSByZW1vdmluZyA9IC0xOwoKICAgIGlmICgnbnVtYmVyJyA9PT0gdHlwZW9mIGFkZGluZykgYWRkQ250ID0gYWRkaW5nOwogICAgZWxzZSBpZiAoYWRkaW5nKSBhZGRDbnQgPSBnZXQoYWRkaW5nLCAnbGVuZ3RoJyk7CiAgICBlbHNlIGFkZENudCA9IGFkZGluZyA9IC0xOwoKICAgIGhhc0RlbHRhID0gYWRkQ250PDAgfHwgcmVtb3ZlQ250PDAgfHwgYWRkQ250LXJlbW92ZUNudCE9PTA7CgogICAgaWYgKHJlbW92aW5nID09PSAtMSkgcmVtb3ZpbmcgPSBudWxsOwogICAgaWYgKGFkZGluZyAgID09PSAtMSkgYWRkaW5nICAgPSBudWxsOwoKICAgIEVtYmVyLnNlbmRFdmVudCh0aGlzLCAnQGVudW1lcmFibGU6Y2hhbmdlJywgW3RoaXMsIHJlbW92aW5nLCBhZGRpbmddKTsKICAgIGlmIChoYXNEZWx0YSkgRW1iZXIucHJvcGVydHlEaWRDaGFuZ2UodGhpcywgJ2xlbmd0aCcpOwogICAgRW1iZXIucHJvcGVydHlEaWRDaGFuZ2UodGhpcywgJ1tdJyk7CgogICAgcmV0dXJuIHRoaXMgOwogIH0sCgogIC8qKgogICAgQ29udmVydHMgdGhlIGVudW1lcmFibGUgaW50byBhbiBhcnJheSBhbmQgc29ydHMgYnkgdGhlIGtleXMKICAgIHNwZWNpZmllZCBpbiB0aGUgYXJndW1lbnQuCgogICAgWW91IG1heSBwcm92aWRlIG11bHRpcGxlIGFyZ3VtZW50cyB0byBzb3J0IGJ5IG11bHRpcGxlIHByb3BlcnRpZXMuCgogICAgQG1ldGhvZCBzb3J0QnkKICAgIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eSBuYW1lKHMpIHRvIHNvcnQgb24KICAgIEByZXR1cm4ge0FycmF5fSBUaGUgc29ydGVkIGFycmF5LgogICAgKi8KICBzb3J0Qnk6IGZ1bmN0aW9uKCkgewogICAgdmFyIHNvcnRLZXlzID0gYXJndW1lbnRzOwogICAgcmV0dXJuIHRoaXMudG9BcnJheSgpLnNvcnQoZnVuY3Rpb24oYSwgYil7CiAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBzb3J0S2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBrZXkgPSBzb3J0S2V5c1tpXSwKICAgICAgICBwcm9wQSA9IGdldChhLCBrZXkpLAogICAgICAgIHByb3BCID0gZ2V0KGIsIGtleSk7CiAgICAgICAgLy8gcmV0dXJuIDEgb3IgLTEgZWxzZSBjb250aW51ZSB0byB0aGUgbmV4dCBzb3J0S2V5CiAgICAgICAgdmFyIGNvbXBhcmVWYWx1ZSA9IEVtYmVyLmNvbXBhcmUocHJvcEEsIHByb3BCKTsKICAgICAgICBpZiAoY29tcGFyZVZhbHVlKSB7IHJldHVybiBjb21wYXJlVmFsdWU7IH0KICAgICAgfQogICAgICByZXR1cm4gMDsKICAgIH0pOwogIH0KfSk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItcnVudGltZQoqLwoKLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgovLyBIRUxQRVJTCi8vCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQsIGlzTm9uZSA9IEVtYmVyLmlzTm9uZSwgbWFwID0gRW1iZXIuRW51bWVyYWJsZVV0aWxzLm1hcCwgY2FjaGVGb3IgPSBFbWJlci5jYWNoZUZvcjsKCi8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KLy8gQVJSQVkKLy8KLyoqCiAgVGhpcyBtb2R1bGUgaW1wbGVtZW50cyBPYnNlcnZlci1mcmllbmRseSBBcnJheS1saWtlIGJlaGF2aW9yLiBUaGlzIG1peGluIGlzCiAgcGlja2VkIHVwIGJ5IHRoZSBBcnJheSBjbGFzcyBhcyB3ZWxsIGFzIG90aGVyIGNvbnRyb2xsZXJzLCBldGMuIHRoYXQgd2FudCB0bwogIGFwcGVhciB0byBiZSBhcnJheXMuCgogIFVubGlrZSBgRW1iZXIuRW51bWVyYWJsZSxgIHRoaXMgbWl4aW4gZGVmaW5lcyBtZXRob2RzIHNwZWNpZmljYWxseSBmb3IKICBjb2xsZWN0aW9ucyB0aGF0IHByb3ZpZGUgaW5kZXgtb3JkZXJlZCBhY2Nlc3MgdG8gdGhlaXIgY29udGVudHMuIFdoZW4geW91CiAgYXJlIGRlc2lnbmluZyBjb2RlIHRoYXQgbmVlZHMgdG8gYWNjZXB0IGFueSBraW5kIG9mIEFycmF5LWxpa2Ugb2JqZWN0LCB5b3UKICBzaG91bGQgdXNlIHRoZXNlIG1ldGhvZHMgaW5zdGVhZCBvZiBBcnJheSBwcmltaXRpdmVzIGJlY2F1c2UgdGhlc2Ugd2lsbAogIHByb3Blcmx5IG5vdGlmeSBvYnNlcnZlcnMgb2YgY2hhbmdlcyB0byB0aGUgYXJyYXkuCgogIEFsdGhvdWdoIHRoZXNlIG1ldGhvZHMgYXJlIGVmZmljaWVudCwgdGhleSBkbyBhZGQgYSBsYXllciBvZiBpbmRpcmVjdGlvbiB0bwogIHlvdXIgYXBwbGljYXRpb24gc28gaXQgaXMgYSBnb29kIGlkZWEgdG8gdXNlIHRoZW0gb25seSB3aGVuIHlvdSBuZWVkIHRoZQogIGZsZXhpYmlsaXR5IG9mIHVzaW5nIGJvdGggdHJ1ZSBKYXZhU2NyaXB0IGFycmF5cyBhbmQgInZpcnR1YWwiIGFycmF5cyBzdWNoCiAgYXMgY29udHJvbGxlcnMgYW5kIGNvbGxlY3Rpb25zLgoKICBZb3UgY2FuIHVzZSB0aGUgbWV0aG9kcyBkZWZpbmVkIGluIHRoaXMgbW9kdWxlIHRvIGFjY2VzcyBhbmQgbW9kaWZ5IGFycmF5CiAgY29udGVudHMgaW4gYSBLVk8tZnJpZW5kbHkgd2F5LiBZb3UgY2FuIGFsc28gYmUgbm90aWZpZWQgd2hlbmV2ZXIgdGhlCiAgbWVtYmVyc2hpcCBvZiBhbiBhcnJheSBjaGFuZ2VzIGJ5IGNoYW5naW5nIHRoZSBzeW50YXggb2YgdGhlIHByb3BlcnR5IHRvCiAgYC5vYnNlcnZlcygnKm15UHJvcGVydHkuW10nKWAuCgogIFRvIHN1cHBvcnQgYEVtYmVyLkFycmF5YCBpbiB5b3VyIG93biBjbGFzcywgeW91IG11c3Qgb3ZlcnJpZGUgdHdvCiAgcHJpbWl0aXZlcyB0byB1c2UgaXQ6IGByZXBsYWNlKClgIGFuZCBgb2JqZWN0QXQoKWAuCgogIE5vdGUgdGhhdCB0aGUgRW1iZXIuQXJyYXkgbWl4aW4gYWxzbyBpbmNvcnBvcmF0ZXMgdGhlIGBFbWJlci5FbnVtZXJhYmxlYAogIG1peGluLiBBbGwgYEVtYmVyLkFycmF5YC1saWtlIG9iamVjdHMgYXJlIGFsc28gZW51bWVyYWJsZS4KCiAgQGNsYXNzIEFycmF5CiAgQG5hbWVzcGFjZSBFbWJlcgogIEB1c2VzIEVtYmVyLkVudW1lcmFibGUKICBAc2luY2UgRW1iZXIgMC45LjAKKi8KRW1iZXIuQXJyYXkgPSBFbWJlci5NaXhpbi5jcmVhdGUoRW1iZXIuRW51bWVyYWJsZSwgewoKICAvKioKICAgIFlvdXIgYXJyYXkgbXVzdCBzdXBwb3J0IHRoZSBgbGVuZ3RoYCBwcm9wZXJ0eS4gWW91ciByZXBsYWNlIG1ldGhvZHMgc2hvdWxkCiAgICBzZXQgdGhpcyBwcm9wZXJ0eSB3aGVuZXZlciBpdCBjaGFuZ2VzLgoKICAgIEBwcm9wZXJ0eSB7TnVtYmVyfSBsZW5ndGgKICAqLwogIGxlbmd0aDogRW1iZXIucmVxdWlyZWQoKSwKCiAgLyoqCiAgICBSZXR1cm5zIHRoZSBvYmplY3QgYXQgdGhlIGdpdmVuIGBpbmRleGAuIElmIHRoZSBnaXZlbiBgaW5kZXhgIGlzIG5lZ2F0aXZlCiAgICBvciBpcyBncmVhdGVyIG9yIGVxdWFsIHRoYW4gdGhlIGFycmF5IGxlbmd0aCwgcmV0dXJucyBgdW5kZWZpbmVkYC4KCiAgICBUaGlzIGlzIG9uZSBvZiB0aGUgcHJpbWl0aXZlcyB5b3UgbXVzdCBpbXBsZW1lbnQgdG8gc3VwcG9ydCBgRW1iZXIuQXJyYXlgLgogICAgSWYgeW91ciBvYmplY3Qgc3VwcG9ydHMgcmV0cmlldmluZyB0aGUgdmFsdWUgb2YgYW4gYXJyYXkgaXRlbSB1c2luZyBgZ2V0KClgCiAgICAoaS5lLiBgbXlBcnJheS5nZXQoMClgKSwgdGhlbiB5b3UgZG8gbm90IG5lZWQgdG8gaW1wbGVtZW50IHRoaXMgbWV0aG9kCiAgICB5b3Vyc2VsZi4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgYXJyID0gWydhJywgJ2InLCAnYycsICdkJ107CiAgICBhcnIub2JqZWN0QXQoMCk7ICAgLy8gImEiCiAgICBhcnIub2JqZWN0QXQoMyk7ICAgLy8gImQiCiAgICBhcnIub2JqZWN0QXQoLTEpOyAgLy8gdW5kZWZpbmVkCiAgICBhcnIub2JqZWN0QXQoNCk7ICAgLy8gdW5kZWZpbmVkCiAgICBhcnIub2JqZWN0QXQoNSk7ICAgLy8gdW5kZWZpbmVkCiAgICBgYGAKCiAgICBAbWV0aG9kIG9iamVjdEF0CiAgICBAcGFyYW0ge051bWJlcn0gaWR4IFRoZSBpbmRleCBvZiB0aGUgaXRlbSB0byByZXR1cm4uCiAgICBAcmV0dXJuIHsqfSBpdGVtIGF0IGluZGV4IG9yIHVuZGVmaW5lZAogICovCiAgb2JqZWN0QXQ6IGZ1bmN0aW9uKGlkeCkgewogICAgaWYgKChpZHggPCAwKSB8fCAoaWR4Pj1nZXQodGhpcywgJ2xlbmd0aCcpKSkgcmV0dXJuIHVuZGVmaW5lZCA7CiAgICByZXR1cm4gZ2V0KHRoaXMsIGlkeCk7CiAgfSwKCiAgLyoqCiAgICBUaGlzIHJldHVybnMgdGhlIG9iamVjdHMgYXQgdGhlIHNwZWNpZmllZCBpbmRleGVzLCB1c2luZyBgb2JqZWN0QXRgLgoKICAgIGBgYGphdmFzY3JpcHQKICAgIHZhciBhcnIgPcKgWydhJywgJ2InLCAnYycsICdkJ107CiAgICBhcnIub2JqZWN0c0F0KFswLCAxLCAyXSk7ICAvLyBbImEiLCAiYiIsICJjIl0KICAgIGFyci5vYmplY3RzQXQoWzIsIDMsIDRdKTsgIC8vIFsiYyIsICJkIiwgdW5kZWZpbmVkXQogICAgYGBgCgogICAgQG1ldGhvZCBvYmplY3RzQXQKICAgIEBwYXJhbSB7QXJyYXl9IGluZGV4ZXMgQW4gYXJyYXkgb2YgaW5kZXhlcyBvZiBpdGVtcyB0byByZXR1cm4uCiAgICBAcmV0dXJuIHtBcnJheX0KICAgKi8KICBvYmplY3RzQXQ6IGZ1bmN0aW9uKGluZGV4ZXMpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHJldHVybiBtYXAoaW5kZXhlcywgZnVuY3Rpb24oaWR4KSB7IHJldHVybiBzZWxmLm9iamVjdEF0KGlkeCk7IH0pOwogIH0sCgogIC8vIG92ZXJyaWRlcyBFbWJlci5FbnVtZXJhYmxlIHZlcnNpb24KICBuZXh0T2JqZWN0OiBmdW5jdGlvbihpZHgpIHsKICAgIHJldHVybiB0aGlzLm9iamVjdEF0KGlkeCk7CiAgfSwKCiAgLyoqCiAgICBUaGlzIGlzIHRoZSBoYW5kbGVyIGZvciB0aGUgc3BlY2lhbCBhcnJheSBjb250ZW50IHByb3BlcnR5LiBJZiB5b3UgZ2V0CiAgICB0aGlzIHByb3BlcnR5LCBpdCB3aWxsIHJldHVybiB0aGlzLiBJZiB5b3Ugc2V0IHRoaXMgcHJvcGVydHkgaXQgYSBuZXcKICAgIGFycmF5LCBpdCB3aWxsIHJlcGxhY2UgdGhlIGN1cnJlbnQgY29udGVudC4KCiAgICBUaGlzIHByb3BlcnR5IG92ZXJyaWRlcyB0aGUgZGVmYXVsdCBwcm9wZXJ0eSBkZWZpbmVkIGluIGBFbWJlci5FbnVtZXJhYmxlYC4KCiAgICBAcHJvcGVydHkgW10KICAgIEByZXR1cm4gdGhpcwogICovCiAgJ1tdJzogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHRoaXMucmVwbGFjZSgwLCBnZXQodGhpcywgJ2xlbmd0aCcpLCB2YWx1ZSkgOwogICAgcmV0dXJuIHRoaXMgOwogIH0pLAoKICBmaXJzdE9iamVjdDogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5vYmplY3RBdCgwKTsKICB9KSwKCiAgbGFzdE9iamVjdDogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5vYmplY3RBdChnZXQodGhpcywgJ2xlbmd0aCcpLTEpOwogIH0pLAoKICAvLyBvcHRpbWl6ZWQgdmVyc2lvbiBmcm9tIEVudW1lcmFibGUKICBjb250YWluczogZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gdGhpcy5pbmRleE9mKG9iaikgPj0gMDsKICB9LAoKICAvLyBBZGQgYW55IGV4dHJhIG1ldGhvZHMgdG8gRW1iZXIuQXJyYXkgdGhhdCBhcmUgbmF0aXZlIHRvIHRoZSBidWlsdC1pbiBBcnJheS4KICAvKioKICAgIFJldHVybnMgYSBuZXcgYXJyYXkgdGhhdCBpcyBhIHNsaWNlIG9mIHRoZSByZWNlaXZlci4gVGhpcyBpbXBsZW1lbnRhdGlvbgogICAgdXNlcyB0aGUgb2JzZXJ2YWJsZSBhcnJheSBtZXRob2RzIHRvIHJldHJpZXZlIHRoZSBvYmplY3RzIGZvciB0aGUgbmV3CiAgICBzbGljZS4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgYXJyID0gWydyZWQnLCAnZ3JlZW4nLCAnYmx1ZSddOwogICAgYXJyLnNsaWNlKDApOyAgICAgICAvLyBbJ3JlZCcsICdncmVlbicsICdibHVlJ10KICAgIGFyci5zbGljZSgwLCAyKTsgICAgLy8gWydyZWQnLCAnZ3JlZW4nXQogICAgYXJyLnNsaWNlKDEsIDEwMCk7ICAvLyBbJ2dyZWVuJywgJ2JsdWUnXQogICAgYGBgCgogICAgQG1ldGhvZCBzbGljZQogICAgQHBhcmFtIHtJbnRlZ2VyfSBiZWdpbkluZGV4IChPcHRpb25hbCkgaW5kZXggdG8gYmVnaW4gc2xpY2luZyBmcm9tLgogICAgQHBhcmFtIHtJbnRlZ2VyfSBlbmRJbmRleCAoT3B0aW9uYWwpIGluZGV4IHRvIGVuZCB0aGUgc2xpY2UgYXQuCiAgICBAcmV0dXJuIHtBcnJheX0gTmV3IGFycmF5IHdpdGggc3BlY2lmaWVkIHNsaWNlCiAgKi8KICBzbGljZTogZnVuY3Rpb24oYmVnaW5JbmRleCwgZW5kSW5kZXgpIHsKICAgIHZhciByZXQgPSBFbWJlci5BKCk7CiAgICB2YXIgbGVuZ3RoID0gZ2V0KHRoaXMsICdsZW5ndGgnKSA7CiAgICBpZiAoaXNOb25lKGJlZ2luSW5kZXgpKSBiZWdpbkluZGV4ID0gMCA7CiAgICBpZiAoaXNOb25lKGVuZEluZGV4KSB8fCAoZW5kSW5kZXggPiBsZW5ndGgpKSBlbmRJbmRleCA9IGxlbmd0aCA7CgogICAgaWYgKGJlZ2luSW5kZXggPCAwKSBiZWdpbkluZGV4ID0gbGVuZ3RoICsgYmVnaW5JbmRleDsKICAgIGlmIChlbmRJbmRleCA8IDApIGVuZEluZGV4ID0gbGVuZ3RoICsgZW5kSW5kZXg7CgogICAgd2hpbGUoYmVnaW5JbmRleCA8IGVuZEluZGV4KSB7CiAgICAgIHJldFtyZXQubGVuZ3RoXSA9IHRoaXMub2JqZWN0QXQoYmVnaW5JbmRleCsrKSA7CiAgICB9CiAgICByZXR1cm4gcmV0IDsKICB9LAoKICAvKioKICAgIFJldHVybnMgdGhlIGluZGV4IG9mIHRoZSBnaXZlbiBvYmplY3QncyBmaXJzdCBvY2N1cnJlbmNlLgogICAgSWYgbm8gYHN0YXJ0QXRgIGFyZ3VtZW50IGlzIGdpdmVuLCB0aGUgc3RhcnRpbmcgbG9jYXRpb24gdG8KICAgIHNlYXJjaCBpcyAwLiBJZiBpdCdzIG5lZ2F0aXZlLCB3aWxsIGNvdW50IGJhY2t3YXJkIGZyb20KICAgIHRoZSBlbmQgb2YgdGhlIGFycmF5LiBSZXR1cm5zIC0xIGlmIG5vIG1hdGNoIGlzIGZvdW5kLgoKICAgIGBgYGphdmFzY3JpcHQKICAgIHZhciBhcnIgPSBbImEiLCAiYiIsICJjIiwgImQiLCAiYSJdOwogICAgYXJyLmluZGV4T2YoImEiKTsgICAgICAgLy8gIDAKICAgIGFyci5pbmRleE9mKCJ6Iik7ICAgICAgIC8vIC0xCiAgICBhcnIuaW5kZXhPZigiYSIsIDIpOyAgICAvLyAgNAogICAgYXJyLmluZGV4T2YoImEiLCAtMSk7ICAgLy8gIDQKICAgIGFyci5pbmRleE9mKCJiIiwgMyk7ICAgIC8vIC0xCiAgICBhcnIuaW5kZXhPZigiYSIsIDEwMCk7ICAvLyAtMQogICAgYGBgCgogICAgQG1ldGhvZCBpbmRleE9mCiAgICBAcGFyYW0ge09iamVjdH0gb2JqZWN0IHRoZSBpdGVtIHRvIHNlYXJjaCBmb3IKICAgIEBwYXJhbSB7TnVtYmVyfSBzdGFydEF0IG9wdGlvbmFsIHN0YXJ0aW5nIGxvY2F0aW9uIHRvIHNlYXJjaCwgZGVmYXVsdCAwCiAgICBAcmV0dXJuIHtOdW1iZXJ9IGluZGV4IG9yIC0xIGlmIG5vdCBmb3VuZAogICovCiAgaW5kZXhPZjogZnVuY3Rpb24ob2JqZWN0LCBzdGFydEF0KSB7CiAgICB2YXIgaWR4LCBsZW4gPSBnZXQodGhpcywgJ2xlbmd0aCcpOwoKICAgIGlmIChzdGFydEF0ID09PSB1bmRlZmluZWQpIHN0YXJ0QXQgPSAwOwogICAgaWYgKHN0YXJ0QXQgPCAwKSBzdGFydEF0ICs9IGxlbjsKCiAgICBmb3IoaWR4PXN0YXJ0QXQ7aWR4PGxlbjtpZHgrKykgewogICAgICBpZiAodGhpcy5vYmplY3RBdChpZHgpID09PSBvYmplY3QpIHJldHVybiBpZHggOwogICAgfQogICAgcmV0dXJuIC0xOwogIH0sCgogIC8qKgogICAgUmV0dXJucyB0aGUgaW5kZXggb2YgdGhlIGdpdmVuIG9iamVjdCdzIGxhc3Qgb2NjdXJyZW5jZS4KICAgIElmIG5vIGBzdGFydEF0YCBhcmd1bWVudCBpcyBnaXZlbiwgdGhlIHNlYXJjaCBzdGFydHMgZnJvbQogICAgdGhlIGxhc3QgcG9zaXRpb24uIElmIGl0J3MgbmVnYXRpdmUsIHdpbGwgY291bnQgYmFja3dhcmQKICAgIGZyb20gdGhlIGVuZCBvZiB0aGUgYXJyYXkuIFJldHVybnMgLTEgaWYgbm8gbWF0Y2ggaXMgZm91bmQuCgogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIGFyciA9IFsiYSIsICJiIiwgImMiLCAiZCIsICJhIl07CiAgICBhcnIubGFzdEluZGV4T2YoImEiKTsgICAgICAgLy8gIDQKICAgIGFyci5sYXN0SW5kZXhPZigieiIpOyAgICAgICAvLyAtMQogICAgYXJyLmxhc3RJbmRleE9mKCJhIiwgMik7ICAgIC8vICAwCiAgICBhcnIubGFzdEluZGV4T2YoImEiLCAtMSk7ICAgLy8gIDQKICAgIGFyci5sYXN0SW5kZXhPZigiYiIsIDMpOyAgICAvLyAgMQogICAgYXJyLmxhc3RJbmRleE9mKCJhIiwgMTAwKTsgIC8vICA0CiAgICBgYGAKCiAgICBAbWV0aG9kIGxhc3RJbmRleE9mCiAgICBAcGFyYW0ge09iamVjdH0gb2JqZWN0IHRoZSBpdGVtIHRvIHNlYXJjaCBmb3IKICAgIEBwYXJhbSB7TnVtYmVyfSBzdGFydEF0IG9wdGlvbmFsIHN0YXJ0aW5nIGxvY2F0aW9uIHRvIHNlYXJjaCwgZGVmYXVsdCAwCiAgICBAcmV0dXJuIHtOdW1iZXJ9IGluZGV4IG9yIC0xIGlmIG5vdCBmb3VuZAogICovCiAgbGFzdEluZGV4T2Y6IGZ1bmN0aW9uKG9iamVjdCwgc3RhcnRBdCkgewogICAgdmFyIGlkeCwgbGVuID0gZ2V0KHRoaXMsICdsZW5ndGgnKTsKCiAgICBpZiAoc3RhcnRBdCA9PT0gdW5kZWZpbmVkIHx8IHN0YXJ0QXQgPj0gbGVuKSBzdGFydEF0ID0gbGVuLTE7CiAgICBpZiAoc3RhcnRBdCA8IDApIHN0YXJ0QXQgKz0gbGVuOwoKICAgIGZvcihpZHg9c3RhcnRBdDtpZHg+PTA7aWR4LS0pIHsKICAgICAgaWYgKHRoaXMub2JqZWN0QXQoaWR4KSA9PT0gb2JqZWN0KSByZXR1cm4gaWR4IDsKICAgIH0KICAgIHJldHVybiAtMTsKICB9LAoKICAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCiAgLy8gQVJSQVkgT0JTRVJWRVJTCiAgLy8KCiAgLyoqCiAgICBBZGRzIGFuIGFycmF5IG9ic2VydmVyIHRvIHRoZSByZWNlaXZpbmcgYXJyYXkuIFRoZSBhcnJheSBvYnNlcnZlciBvYmplY3QKICAgIG5vcm1hbGx5IG11c3QgaW1wbGVtZW50IHR3byBtZXRob2RzOgoKICAgICogYGFycmF5V2lsbENoYW5nZShvYnNlcnZlZE9iaiwgc3RhcnQsIHJlbW92ZUNvdW50LCBhZGRDb3VudClgIC0gVGhpcyBtZXRob2Qgd2lsbCBiZQogICAgICBjYWxsZWQganVzdCBiZWZvcmUgdGhlIGFycmF5IGlzIG1vZGlmaWVkLgogICAgKiBgYXJyYXlEaWRDaGFuZ2Uob2JzZXJ2ZWRPYmosIHN0YXJ0LCByZW1vdmVDb3VudCwgYWRkQ291bnQpYCAtIFRoaXMgbWV0aG9kIHdpbGwgYmUKICAgICAgY2FsbGVkIGp1c3QgYWZ0ZXIgdGhlIGFycmF5IGlzIG1vZGlmaWVkLgoKICAgIEJvdGggY2FsbGJhY2tzIHdpbGwgYmUgcGFzc2VkIHRoZSBvYnNlcnZlZCBvYmplY3QsIHN0YXJ0aW5nIGluZGV4IG9mIHRoZQogICAgY2hhbmdlIGFzIHdlbGwgYSBhIGNvdW50IG9mIHRoZSBpdGVtcyB0byBiZSByZW1vdmVkIGFuZCBhZGRlZC4gWW91IGNhbiB1c2UKICAgIHRoZXNlIGNhbGxiYWNrcyB0byBvcHRpb25hbGx5IGluc3BlY3QgdGhlIGFycmF5IGR1cmluZyB0aGUgY2hhbmdlLCBjbGVhcgogICAgY2FjaGVzLCBvciBkbyBhbnkgb3RoZXIgYm9va2tlZXBpbmcgbmVjZXNzYXJ5LgoKICAgIEluIGFkZGl0aW9uIHRvIHBhc3NpbmcgYSB0YXJnZXQsIHlvdSBjYW4gYWxzbyBpbmNsdWRlIGFuIG9wdGlvbnMgaGFzaAogICAgd2hpY2ggeW91IGNhbiB1c2UgdG8gb3ZlcnJpZGUgdGhlIG1ldGhvZCBuYW1lcyB0aGF0IHdpbGwgYmUgaW52b2tlZCBvbiB0aGUKICAgIHRhcmdldC4KCiAgICBAbWV0aG9kIGFkZEFycmF5T2JzZXJ2ZXIKICAgIEBwYXJhbSB7T2JqZWN0fSB0YXJnZXQgVGhlIG9ic2VydmVyIG9iamVjdC4KICAgIEBwYXJhbSB7SGFzaH0gb3B0cyBPcHRpb25hbCBoYXNoIG9mIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBpbmNsdWRpbmcKICAgICAgYHdpbGxDaGFuZ2VgIGFuZCBgZGlkQ2hhbmdlYCBvcHRpb24uCiAgICBAcmV0dXJuIHtFbWJlci5BcnJheX0gcmVjZWl2ZXIKICAqLwogIGFkZEFycmF5T2JzZXJ2ZXI6IGZ1bmN0aW9uKHRhcmdldCwgb3B0cykgewogICAgdmFyIHdpbGxDaGFuZ2UgPSAob3B0cyAmJiBvcHRzLndpbGxDaGFuZ2UpIHx8ICdhcnJheVdpbGxDaGFuZ2UnLAogICAgICAgIGRpZENoYW5nZSAgPSAob3B0cyAmJiBvcHRzLmRpZENoYW5nZSkgfHwgJ2FycmF5RGlkQ2hhbmdlJzsKCiAgICB2YXIgaGFzT2JzZXJ2ZXJzID0gZ2V0KHRoaXMsICdoYXNBcnJheU9ic2VydmVycycpOwogICAgaWYgKCFoYXNPYnNlcnZlcnMpIEVtYmVyLnByb3BlcnR5V2lsbENoYW5nZSh0aGlzLCAnaGFzQXJyYXlPYnNlcnZlcnMnKTsKICAgIEVtYmVyLmFkZExpc3RlbmVyKHRoaXMsICdAYXJyYXk6YmVmb3JlJywgdGFyZ2V0LCB3aWxsQ2hhbmdlKTsKICAgIEVtYmVyLmFkZExpc3RlbmVyKHRoaXMsICdAYXJyYXk6Y2hhbmdlJywgdGFyZ2V0LCBkaWRDaGFuZ2UpOwogICAgaWYgKCFoYXNPYnNlcnZlcnMpIEVtYmVyLnByb3BlcnR5RGlkQ2hhbmdlKHRoaXMsICdoYXNBcnJheU9ic2VydmVycycpOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICBSZW1vdmVzIGFuIGFycmF5IG9ic2VydmVyIGZyb20gdGhlIG9iamVjdCBpZiB0aGUgb2JzZXJ2ZXIgaXMgY3VycmVudAogICAgcmVnaXN0ZXJlZC4gQ2FsbGluZyB0aGlzIG1ldGhvZCBtdWx0aXBsZSB0aW1lcyB3aXRoIHRoZSBzYW1lIG9iamVjdCB3aWxsCiAgICBoYXZlIG5vIGVmZmVjdC4KCiAgICBAbWV0aG9kIHJlbW92ZUFycmF5T2JzZXJ2ZXIKICAgIEBwYXJhbSB7T2JqZWN0fSB0YXJnZXQgVGhlIG9iamVjdCBvYnNlcnZpbmcgdGhlIGFycmF5LgogICAgQHBhcmFtIHtIYXNofSBvcHRzIE9wdGlvbmFsIGhhc2ggb2YgY29uZmlndXJhdGlvbiBvcHRpb25zIGluY2x1ZGluZwogICAgICBgd2lsbENoYW5nZWAgYW5kIGBkaWRDaGFuZ2VgIG9wdGlvbi4KICAgIEByZXR1cm4ge0VtYmVyLkFycmF5fSByZWNlaXZlcgogICovCiAgcmVtb3ZlQXJyYXlPYnNlcnZlcjogZnVuY3Rpb24odGFyZ2V0LCBvcHRzKSB7CiAgICB2YXIgd2lsbENoYW5nZSA9IChvcHRzICYmIG9wdHMud2lsbENoYW5nZSkgfHwgJ2FycmF5V2lsbENoYW5nZScsCiAgICAgICAgZGlkQ2hhbmdlICA9IChvcHRzICYmIG9wdHMuZGlkQ2hhbmdlKSB8fCAnYXJyYXlEaWRDaGFuZ2UnOwoKICAgIHZhciBoYXNPYnNlcnZlcnMgPSBnZXQodGhpcywgJ2hhc0FycmF5T2JzZXJ2ZXJzJyk7CiAgICBpZiAoaGFzT2JzZXJ2ZXJzKSBFbWJlci5wcm9wZXJ0eVdpbGxDaGFuZ2UodGhpcywgJ2hhc0FycmF5T2JzZXJ2ZXJzJyk7CiAgICBFbWJlci5yZW1vdmVMaXN0ZW5lcih0aGlzLCAnQGFycmF5OmJlZm9yZScsIHRhcmdldCwgd2lsbENoYW5nZSk7CiAgICBFbWJlci5yZW1vdmVMaXN0ZW5lcih0aGlzLCAnQGFycmF5OmNoYW5nZScsIHRhcmdldCwgZGlkQ2hhbmdlKTsKICAgIGlmIChoYXNPYnNlcnZlcnMpIEVtYmVyLnByb3BlcnR5RGlkQ2hhbmdlKHRoaXMsICdoYXNBcnJheU9ic2VydmVycycpOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICBCZWNvbWVzIHRydWUgd2hlbmV2ZXIgdGhlIGFycmF5IGN1cnJlbnRseSBoYXMgb2JzZXJ2ZXJzIHdhdGNoaW5nIGNoYW5nZXMKICAgIG9uIHRoZSBhcnJheS4KCiAgICBAcHJvcGVydHkgQm9vbGVhbgogICovCiAgaGFzQXJyYXlPYnNlcnZlcnM6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIEVtYmVyLmhhc0xpc3RlbmVycyh0aGlzLCAnQGFycmF5OmNoYW5nZScpIHx8IEVtYmVyLmhhc0xpc3RlbmVycyh0aGlzLCAnQGFycmF5OmJlZm9yZScpOwogIH0pLAoKICAvKioKICAgIElmIHlvdSBhcmUgaW1wbGVtZW50aW5nIGFuIG9iamVjdCB0aGF0IHN1cHBvcnRzIGBFbWJlci5BcnJheWAsIGNhbGwgdGhpcwogICAgbWV0aG9kIGp1c3QgYmVmb3JlIHRoZSBhcnJheSBjb250ZW50IGNoYW5nZXMgdG8gbm90aWZ5IGFueSBvYnNlcnZlcnMgYW5kCiAgICBpbnZhbGlkYXRlIGFueSByZWxhdGVkIHByb3BlcnRpZXMuIFBhc3MgdGhlIHN0YXJ0aW5nIGluZGV4IG9mIHRoZSBjaGFuZ2UKICAgIGFzIHdlbGwgYXMgYSBkZWx0YSBvZiB0aGUgYW1vdW50cyB0byBjaGFuZ2UuCgogICAgQG1ldGhvZCBhcnJheUNvbnRlbnRXaWxsQ2hhbmdlCiAgICBAcGFyYW0ge051bWJlcn0gc3RhcnRJZHggVGhlIHN0YXJ0aW5nIGluZGV4IGluIHRoZSBhcnJheSB0aGF0IHdpbGwgY2hhbmdlLgogICAgQHBhcmFtIHtOdW1iZXJ9IHJlbW92ZUFtdCBUaGUgbnVtYmVyIG9mIGl0ZW1zIHRoYXQgd2lsbCBiZSByZW1vdmVkLiBJZiB5b3UKICAgICAgcGFzcyBgbnVsbGAgYXNzdW1lcyAwCiAgICBAcGFyYW0ge051bWJlcn0gYWRkQW10IFRoZSBudW1iZXIgb2YgaXRlbXMgdGhhdCB3aWxsIGJlIGFkZGVkLiBJZiB5b3UKICAgICAgcGFzcyBgbnVsbGAgYXNzdW1lcyAwLgogICAgQHJldHVybiB7RW1iZXIuQXJyYXl9IHJlY2VpdmVyCiAgKi8KICBhcnJheUNvbnRlbnRXaWxsQ2hhbmdlOiBmdW5jdGlvbihzdGFydElkeCwgcmVtb3ZlQW10LCBhZGRBbXQpIHsKCiAgICAvLyBpZiBubyBhcmdzIGFyZSBwYXNzZWQgYXNzdW1lIGV2ZXJ5dGhpbmcgY2hhbmdlcwogICAgaWYgKHN0YXJ0SWR4PT09dW5kZWZpbmVkKSB7CiAgICAgIHN0YXJ0SWR4ID0gMDsKICAgICAgcmVtb3ZlQW10ID0gYWRkQW10ID0gLTE7CiAgICB9IGVsc2UgewogICAgICBpZiAocmVtb3ZlQW10ID09PSB1bmRlZmluZWQpIHJlbW92ZUFtdD0tMTsKICAgICAgaWYgKGFkZEFtdCAgICA9PT0gdW5kZWZpbmVkKSBhZGRBbXQ9LTE7CiAgICB9CgogICAgLy8gTWFrZSBzdXJlIHRoZSBAZWFjaCBwcm94eSBpcyBzZXQgdXAgaWYgYW55b25lIGlzIG9ic2VydmluZyBAZWFjaAogICAgaWYgKEVtYmVyLmlzV2F0Y2hpbmcodGhpcywgJ0BlYWNoJykpIHsgZ2V0KHRoaXMsICdAZWFjaCcpOyB9CgogICAgRW1iZXIuc2VuZEV2ZW50KHRoaXMsICdAYXJyYXk6YmVmb3JlJywgW3RoaXMsIHN0YXJ0SWR4LCByZW1vdmVBbXQsIGFkZEFtdF0pOwoKICAgIHZhciByZW1vdmluZywgbGltOwogICAgaWYgKHN0YXJ0SWR4Pj0wICYmIHJlbW92ZUFtdD49MCAmJiBnZXQodGhpcywgJ2hhc0VudW1lcmFibGVPYnNlcnZlcnMnKSkgewogICAgICByZW1vdmluZyA9IFtdOwogICAgICBsaW0gPSBzdGFydElkeCtyZW1vdmVBbXQ7CiAgICAgIGZvcih2YXIgaWR4PXN0YXJ0SWR4O2lkeDxsaW07aWR4KyspIHJlbW92aW5nLnB1c2godGhpcy5vYmplY3RBdChpZHgpKTsKICAgIH0gZWxzZSB7CiAgICAgIHJlbW92aW5nID0gcmVtb3ZlQW10OwogICAgfQoKICAgIHRoaXMuZW51bWVyYWJsZUNvbnRlbnRXaWxsQ2hhbmdlKHJlbW92aW5nLCBhZGRBbXQpOwoKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAgSWYgeW91IGFyZSBpbXBsZW1lbnRpbmcgYW4gb2JqZWN0IHRoYXQgc3VwcG9ydHMgYEVtYmVyLkFycmF5YCwgY2FsbCB0aGlzCiAgICBtZXRob2QganVzdCBhZnRlciB0aGUgYXJyYXkgY29udGVudCBjaGFuZ2VzIHRvIG5vdGlmeSBhbnkgb2JzZXJ2ZXJzIGFuZAogICAgaW52YWxpZGF0ZSBhbnkgcmVsYXRlZCBwcm9wZXJ0aWVzLiBQYXNzIHRoZSBzdGFydGluZyBpbmRleCBvZiB0aGUgY2hhbmdlCiAgICBhcyB3ZWxsIGFzIGEgZGVsdGEgb2YgdGhlIGFtb3VudHMgdG8gY2hhbmdlLgoKICAgIEBtZXRob2QgYXJyYXlDb250ZW50RGlkQ2hhbmdlCiAgICBAcGFyYW0ge051bWJlcn0gc3RhcnRJZHggVGhlIHN0YXJ0aW5nIGluZGV4IGluIHRoZSBhcnJheSB0aGF0IGRpZCBjaGFuZ2UuCiAgICBAcGFyYW0ge051bWJlcn0gcmVtb3ZlQW10IFRoZSBudW1iZXIgb2YgaXRlbXMgdGhhdCB3ZXJlIHJlbW92ZWQuIElmIHlvdQogICAgICBwYXNzIGBudWxsYCBhc3N1bWVzIDAKICAgIEBwYXJhbSB7TnVtYmVyfSBhZGRBbXQgVGhlIG51bWJlciBvZiBpdGVtcyB0aGF0IHdlcmUgYWRkZWQuIElmIHlvdQogICAgICBwYXNzIGBudWxsYCBhc3N1bWVzIDAuCiAgICBAcmV0dXJuIHtFbWJlci5BcnJheX0gcmVjZWl2ZXIKICAqLwogIGFycmF5Q29udGVudERpZENoYW5nZTogZnVuY3Rpb24oc3RhcnRJZHgsIHJlbW92ZUFtdCwgYWRkQW10KSB7CgogICAgLy8gaWYgbm8gYXJncyBhcmUgcGFzc2VkIGFzc3VtZSBldmVyeXRoaW5nIGNoYW5nZXMKICAgIGlmIChzdGFydElkeD09PXVuZGVmaW5lZCkgewogICAgICBzdGFydElkeCA9IDA7CiAgICAgIHJlbW92ZUFtdCA9IGFkZEFtdCA9IC0xOwogICAgfSBlbHNlIHsKICAgICAgaWYgKHJlbW92ZUFtdCA9PT0gdW5kZWZpbmVkKSByZW1vdmVBbXQ9LTE7CiAgICAgIGlmIChhZGRBbXQgICAgPT09IHVuZGVmaW5lZCkgYWRkQW10PS0xOwogICAgfQoKICAgIHZhciBhZGRpbmcsIGxpbTsKICAgIGlmIChzdGFydElkeD49MCAmJiBhZGRBbXQ+PTAgJiYgZ2V0KHRoaXMsICdoYXNFbnVtZXJhYmxlT2JzZXJ2ZXJzJykpIHsKICAgICAgYWRkaW5nID0gW107CiAgICAgIGxpbSA9IHN0YXJ0SWR4K2FkZEFtdDsKICAgICAgZm9yKHZhciBpZHg9c3RhcnRJZHg7aWR4PGxpbTtpZHgrKykgYWRkaW5nLnB1c2godGhpcy5vYmplY3RBdChpZHgpKTsKICAgIH0gZWxzZSB7CiAgICAgIGFkZGluZyA9IGFkZEFtdDsKICAgIH0KCiAgICB0aGlzLmVudW1lcmFibGVDb250ZW50RGlkQ2hhbmdlKHJlbW92ZUFtdCwgYWRkaW5nKTsKICAgIEVtYmVyLnNlbmRFdmVudCh0aGlzLCAnQGFycmF5OmNoYW5nZScsIFt0aGlzLCBzdGFydElkeCwgcmVtb3ZlQW10LCBhZGRBbXRdKTsKCiAgICB2YXIgbGVuZ3RoICAgICAgPSBnZXQodGhpcywgJ2xlbmd0aCcpLAogICAgICAgIGNhY2hlZEZpcnN0ID0gY2FjaGVGb3IodGhpcywgJ2ZpcnN0T2JqZWN0JyksCiAgICAgICAgY2FjaGVkTGFzdCAgPSBjYWNoZUZvcih0aGlzLCAnbGFzdE9iamVjdCcpOwogICAgaWYgKHRoaXMub2JqZWN0QXQoMCkgIT09IGNhY2hlZEZpcnN0KSB7CiAgICAgIEVtYmVyLnByb3BlcnR5V2lsbENoYW5nZSh0aGlzLCAnZmlyc3RPYmplY3QnKTsKICAgICAgRW1iZXIucHJvcGVydHlEaWRDaGFuZ2UodGhpcywgJ2ZpcnN0T2JqZWN0Jyk7CiAgICB9CiAgICBpZiAodGhpcy5vYmplY3RBdChsZW5ndGgtMSkgIT09IGNhY2hlZExhc3QpIHsKICAgICAgRW1iZXIucHJvcGVydHlXaWxsQ2hhbmdlKHRoaXMsICdsYXN0T2JqZWN0Jyk7CiAgICAgIEVtYmVyLnByb3BlcnR5RGlkQ2hhbmdlKHRoaXMsICdsYXN0T2JqZWN0Jyk7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgogIC8vIEVOVU1FUkFURUQgUFJPUEVSVElFUwogIC8vCgogIC8qKgogICAgUmV0dXJucyBhIHNwZWNpYWwgb2JqZWN0IHRoYXQgY2FuIGJlIHVzZWQgdG8gb2JzZXJ2ZSBpbmRpdmlkdWFsIHByb3BlcnRpZXMKICAgIG9uIHRoZSBhcnJheS4gSnVzdCBnZXQgYW4gZXF1aXZhbGVudCBwcm9wZXJ0eSBvbiB0aGlzIG9iamVjdCBhbmQgaXQgd2lsbAogICAgcmV0dXJuIGFuIGVudW1lcmFibGUgdGhhdCBtYXBzIGF1dG9tYXRpY2FsbHkgdG8gdGhlIG5hbWVkIGtleSBvbiB0aGUKICAgIG1lbWJlciBvYmplY3RzLgoKICAgIElmIHlvdSBtZXJlbHkgd2FudCB0byB3YXRjaCBmb3IgYW55IGl0ZW1zIGJlaW5nIGFkZGVkIG9yIHJlbW92ZWQgdG8gdGhlIGFycmF5LAogICAgdXNlIHRoZSBgW11gIHByb3BlcnR5IGluc3RlYWQgb2YgYEBlYWNoYC4KCiAgICBAcHJvcGVydHkgQGVhY2gKICAqLwogICdAZWFjaCc6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewogICAgaWYgKCF0aGlzLl9fZWFjaCkgdGhpcy5fX2VhY2ggPSBuZXcgRW1iZXIuRWFjaFByb3h5KHRoaXMpOwogICAgcmV0dXJuIHRoaXMuX19lYWNoOwogIH0pCgp9KSA7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7CnZhciBlX2dldCA9IEVtYmVyLmdldCwKICAgIHNldCA9IEVtYmVyLnNldCwKICAgIGd1aWRGb3IgPSBFbWJlci5ndWlkRm9yLAogICAgbWV0YUZvciA9IEVtYmVyLm1ldGEsCiAgICBwcm9wZXJ0eVdpbGxDaGFuZ2UgPSBFbWJlci5wcm9wZXJ0eVdpbGxDaGFuZ2UsCiAgICBwcm9wZXJ0eURpZENoYW5nZSA9IEVtYmVyLnByb3BlcnR5RGlkQ2hhbmdlLAogICAgYWRkQmVmb3JlT2JzZXJ2ZXIgPSBFbWJlci5hZGRCZWZvcmVPYnNlcnZlciwKICAgIHJlbW92ZUJlZm9yZU9ic2VydmVyID0gRW1iZXIucmVtb3ZlQmVmb3JlT2JzZXJ2ZXIsCiAgICBhZGRPYnNlcnZlciA9IEVtYmVyLmFkZE9ic2VydmVyLAogICAgcmVtb3ZlT2JzZXJ2ZXIgPSBFbWJlci5yZW1vdmVPYnNlcnZlciwKICAgIENvbXB1dGVkUHJvcGVydHkgPSBFbWJlci5Db21wdXRlZFByb3BlcnR5LAogICAgYV9zbGljZSA9IFtdLnNsaWNlLAogICAgb19jcmVhdGUgPSBFbWJlci5jcmVhdGUsCiAgICBmb3JFYWNoID0gRW1iZXIuRW51bWVyYWJsZVV0aWxzLmZvckVhY2gsCiAgICAvLyBIZXJlIHdlIGV4cGxpY2l0bHkgZG9uJ3QgYWxsb3cgYEBlYWNoLmZvb2A7IGl0IHdvdWxkIHJlcXVpcmUgc29tZSBzcGVjaWFsCiAgICAvLyB0ZXN0aW5nLCBidXQgdGhlcmUncyBubyBwYXJ0aWN1bGFyIHJlYXNvbiB3aHkgaXQgc2hvdWxkIGJlIGRpc2FsbG93ZWQuCiAgICBlYWNoUHJvcGVydHlQYXR0ZXJuID0gL14oLiopXC5AZWFjaFwuKC4qKS8sCiAgICBkb3VibGVFYWNoUHJvcGVydHlQYXR0ZXJuID0gLyguKlwuQGVhY2gpezIsfS8sCiAgICBhcnJheUJyYWNrZXRQYXR0ZXJuID0gL1wuXFtcXSQvOwoKCmZ1bmN0aW9uIGdldChvYmosIGtleSkgewogIGlmIChrZXkgPT09ICdAdGhpcycpIHsKICAgIHJldHVybiBvYmo7CiAgfQoKICByZXR1cm4gZV9nZXQob2JqLCBrZXkpOwp9CgovKgogIFRyYWNrcyBjaGFuZ2VzIHRvIGRlcGVuZGVudCBhcnJheXMsIGFzIHdlbGwgYXMgdG8gcHJvcGVydGllcyBvZiBpdGVtcyBpbgogIGRlcGVuZGVudCBhcnJheXMuCgogIEBjbGFzcyBEZXBlbmRlbnRBcnJheXNPYnNlcnZlcgoqLwpmdW5jdGlvbiBEZXBlbmRlbnRBcnJheXNPYnNlcnZlcihjYWxsYmFja3MsIGNwLCBpbnN0YW5jZU1ldGEsIGNvbnRleHQsIHByb3BlcnR5TmFtZSwgc3VnYXJNZXRhKSB7CiAgLy8gdXNlciBzcGVjaWZpZWQgY2FsbGJhY2tzIGZvciBgYWRkZWRJdGVtYCBhbmQgYHJlbW92ZWRJdGVtYAogIHRoaXMuY2FsbGJhY2tzID0gY2FsbGJhY2tzOwoKICAvLyB0aGUgY29tcHV0ZWQgcHJvcGVydHk6IHJlbWVtYmVyIHRoZXNlIGFyZSBzaGFyZWQgYWNyb3NzIGluc3RhbmNlcwogIHRoaXMuY3AgPSBjcDsKCiAgLy8gdGhlIFJlZHVjZUNvbXB1dGVkUHJvcGVydHlJbnN0YW5jZU1ldGEgdGhpcyBEZXBlbmRlbnRBcnJheXNPYnNlcnZlciBpcwogIC8vIGFzc29jaWF0ZWQgd2l0aAogIHRoaXMuaW5zdGFuY2VNZXRhID0gaW5zdGFuY2VNZXRhOwoKICAvLyBBIG1hcCBvZiBhcnJheSBndWlkcyB0byBkZXBlbmRlbnRLZXlzLCBmb3IgdGhlIGdpdmVuIGNvbnRleHQuICBXZSB0cmFjawogIC8vIHRoaXMgYmVjYXVzZSB3ZSB3YW50IHRvIHNldCB1cCB0aGUgY29tcHV0ZWQgcHJvcGVydHkgcG90ZW50aWFsbHkgYmVmb3JlIHRoZQogIC8vIGRlcGVuZGVudCBhcnJheSBldmVuIGV4aXN0cywgYnV0IHdoZW4gdGhlIGFycmF5IG9ic2VydmVyIGZpcmVzLCB3ZSBsYWNrCiAgLy8gZW5vdWdoIGNvbnRleHQgdG8ga25vdyB3aGF0IHRvIHVwZGF0ZTogd2UgY2FuIHJlY292ZXIgdGhhdCBjb250ZXh0IGJ5CiAgLy8gZ2V0dGluZyB0aGUgZGVwZW5kZW50S2V5LgogIHRoaXMuZGVwZW5kZW50S2V5c0J5R3VpZCA9IHt9OwoKICAvLyBhIG1hcCBvZiBkZXBlbmRlbnQgYXJyYXkgZ3VpZHMgLT4gRW1iZXIuVHJhY2tlZEFycmF5IGluc3RhbmNlcy4gIFdlIHVzZQogIC8vIHRoaXMgdG8gbGF6aWx5IHJlY29tcHV0ZSBpbmRleGVzIGZvciBpdGVtIHByb3BlcnR5IG9ic2VydmVycy4KICB0aGlzLnRyYWNrZWRBcnJheXNCeUd1aWQgPSB7fTsKCiAgLy8gV2Ugc3VzcGVuZCBvYnNlcnZlcnMgdG8gaWdub3JlIHJlcGxhY2VtZW50cyBmcm9tIGByZXNldGAgd2hlbiB0b3RhbGx5CiAgLy8gcmVjb21wdXRpbmcuICBVbmZvcnR1bmF0ZWx5IHdlIGNhbm5vdCBwcm9wZXJseSBzdXNwZW5kIHRoZSBvYnNlcnZlcnMKICAvLyBiZWNhdXNlIHdlIG9ubHkgaGF2ZSB0aGUga2V5OyBpbnN0ZWFkIHdlIG1ha2UgdGhlIG9ic2VydmVycyBuby1vcHMKICB0aGlzLnN1c3BlbmRlZCA9IGZhbHNlOwoKICAvLyBUaGlzIGlzIHVzZWQgdG8gY29hbGVzY2UgaXRlbSBjaGFuZ2VzIGZyb20gcHJvcGVydHkgb2JzZXJ2ZXJzLgogIHRoaXMuY2hhbmdlZEl0ZW1zID0ge307Cn0KCmZ1bmN0aW9uIEl0ZW1Qcm9wZXJ0eU9ic2VydmVyQ29udGV4dCAoZGVwZW5kZW50QXJyYXksIGluZGV4LCB0cmFja2VkQXJyYXkpIHsKICBFbWJlci5hc3NlcnQoIkludGVybmFsIGVycm9yOiB0cmFja2VkQXJyYXkgaXMgbnVsbCBvciB1bmRlZmluZWQiLCB0cmFja2VkQXJyYXkpOwoKICB0aGlzLmRlcGVuZGVudEFycmF5ID0gZGVwZW5kZW50QXJyYXk7CiAgdGhpcy5pbmRleCA9IGluZGV4OwogIHRoaXMuaXRlbSA9IGRlcGVuZGVudEFycmF5Lm9iamVjdEF0KGluZGV4KTsKICB0aGlzLnRyYWNrZWRBcnJheSA9IHRyYWNrZWRBcnJheTsKICB0aGlzLmJlZm9yZU9ic2VydmVyID0gbnVsbDsKICB0aGlzLm9ic2VydmVyID0gbnVsbDsKCiAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZTsKfQoKRGVwZW5kZW50QXJyYXlzT2JzZXJ2ZXIucHJvdG90eXBlID0gewogIHNldFZhbHVlOiBmdW5jdGlvbiAobmV3VmFsdWUpIHsKICAgIHRoaXMuaW5zdGFuY2VNZXRhLnNldFZhbHVlKG5ld1ZhbHVlLCB0cnVlKTsKICB9LAogIGdldFZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5pbnN0YW5jZU1ldGEuZ2V0VmFsdWUoKTsKICB9LAoKICBzZXR1cE9ic2VydmVyczogZnVuY3Rpb24gKGRlcGVuZGVudEFycmF5LCBkZXBlbmRlbnRLZXkpIHsKICAgIEVtYmVyLmFzc2VydCgiZGVwZW5kZW50IGFycmF5IG11c3QgYmUgYW4gYEVtYmVyLkFycmF5YCIsIEVtYmVyLkFycmF5LmRldGVjdChkZXBlbmRlbnRBcnJheSkpOwoKICAgIHRoaXMuZGVwZW5kZW50S2V5c0J5R3VpZFtndWlkRm9yKGRlcGVuZGVudEFycmF5KV0gPSBkZXBlbmRlbnRLZXk7CgogICAgZGVwZW5kZW50QXJyYXkuYWRkQXJyYXlPYnNlcnZlcih0aGlzLCB7CiAgICAgIHdpbGxDaGFuZ2U6ICdkZXBlbmRlbnRBcnJheVdpbGxDaGFuZ2UnLAogICAgICBkaWRDaGFuZ2U6ICdkZXBlbmRlbnRBcnJheURpZENoYW5nZScKICAgIH0pOwoKICAgIGlmICh0aGlzLmNwLl9pdGVtUHJvcGVydHlLZXlzW2RlcGVuZGVudEtleV0pIHsKICAgICAgdGhpcy5zZXR1cFByb3BlcnR5T2JzZXJ2ZXJzKGRlcGVuZGVudEtleSwgdGhpcy5jcC5faXRlbVByb3BlcnR5S2V5c1tkZXBlbmRlbnRLZXldKTsKICAgIH0KICB9LAoKICB0ZWFyZG93bk9ic2VydmVyczogZnVuY3Rpb24gKGRlcGVuZGVudEFycmF5LCBkZXBlbmRlbnRLZXkpIHsKICAgIHZhciBpdGVtUHJvcGVydHlLZXlzID0gdGhpcy5jcC5faXRlbVByb3BlcnR5S2V5c1tkZXBlbmRlbnRLZXldIHx8IFtdOwoKICAgIGRlbGV0ZSB0aGlzLmRlcGVuZGVudEtleXNCeUd1aWRbZ3VpZEZvcihkZXBlbmRlbnRBcnJheSldOwoKICAgIHRoaXMudGVhcmRvd25Qcm9wZXJ0eU9ic2VydmVycyhkZXBlbmRlbnRLZXksIGl0ZW1Qcm9wZXJ0eUtleXMpOwoKICAgIGRlcGVuZGVudEFycmF5LnJlbW92ZUFycmF5T2JzZXJ2ZXIodGhpcywgewogICAgICB3aWxsQ2hhbmdlOiAnZGVwZW5kZW50QXJyYXlXaWxsQ2hhbmdlJywKICAgICAgZGlkQ2hhbmdlOiAnZGVwZW5kZW50QXJyYXlEaWRDaGFuZ2UnCiAgICB9KTsKICB9LAoKICBzdXNwZW5kQXJyYXlPYnNlcnZlcnM6IGZ1bmN0aW9uIChjYWxsYmFjaywgYmluZGluZykgewogICAgdmFyIG9sZFN1c3BlbmRlZCA9IHRoaXMuc3VzcGVuZGVkOwogICAgdGhpcy5zdXNwZW5kZWQgPSB0cnVlOwogICAgY2FsbGJhY2suY2FsbChiaW5kaW5nKTsKICAgIHRoaXMuc3VzcGVuZGVkID0gb2xkU3VzcGVuZGVkOwogIH0sCgogIHNldHVwUHJvcGVydHlPYnNlcnZlcnM6IGZ1bmN0aW9uIChkZXBlbmRlbnRLZXksIGl0ZW1Qcm9wZXJ0eUtleXMpIHsKICAgIHZhciBkZXBlbmRlbnRBcnJheSA9IGdldCh0aGlzLmluc3RhbmNlTWV0YS5jb250ZXh0LCBkZXBlbmRlbnRLZXkpLAogICAgICAgIGxlbmd0aCA9IGdldChkZXBlbmRlbnRBcnJheSwgJ2xlbmd0aCcpLAogICAgICAgIG9ic2VydmVyQ29udGV4dHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKCiAgICB0aGlzLnJlc2V0VHJhbnNmb3JtYXRpb25zKGRlcGVuZGVudEtleSwgb2JzZXJ2ZXJDb250ZXh0cyk7CgogICAgZm9yRWFjaChkZXBlbmRlbnRBcnJheSwgZnVuY3Rpb24gKGl0ZW0sIGluZGV4KSB7CiAgICAgIHZhciBvYnNlcnZlckNvbnRleHQgPSB0aGlzLmNyZWF0ZVByb3BlcnR5T2JzZXJ2ZXJDb250ZXh0KGRlcGVuZGVudEFycmF5LCBpbmRleCwgdGhpcy50cmFja2VkQXJyYXlzQnlHdWlkW2RlcGVuZGVudEtleV0pOwogICAgICBvYnNlcnZlckNvbnRleHRzW2luZGV4XSA9IG9ic2VydmVyQ29udGV4dDsKCiAgICAgIGZvckVhY2goaXRlbVByb3BlcnR5S2V5cywgZnVuY3Rpb24gKHByb3BlcnR5S2V5KSB7CiAgICAgICAgYWRkQmVmb3JlT2JzZXJ2ZXIoaXRlbSwgcHJvcGVydHlLZXksIHRoaXMsIG9ic2VydmVyQ29udGV4dC5iZWZvcmVPYnNlcnZlcik7CiAgICAgICAgYWRkT2JzZXJ2ZXIoaXRlbSwgcHJvcGVydHlLZXksIHRoaXMsIG9ic2VydmVyQ29udGV4dC5vYnNlcnZlcik7CiAgICAgIH0sIHRoaXMpOwogICAgfSwgdGhpcyk7CiAgfSwKCiAgdGVhcmRvd25Qcm9wZXJ0eU9ic2VydmVyczogZnVuY3Rpb24gKGRlcGVuZGVudEtleSwgaXRlbVByb3BlcnR5S2V5cykgewogICAgdmFyIGRlcGVuZGVudEFycmF5T2JzZXJ2ZXIgPSB0aGlzLAogICAgICAgIHRyYWNrZWRBcnJheSA9IHRoaXMudHJhY2tlZEFycmF5c0J5R3VpZFtkZXBlbmRlbnRLZXldLAogICAgICAgIGJlZm9yZU9ic2VydmVyLAogICAgICAgIG9ic2VydmVyLAogICAgICAgIGl0ZW07CgogICAgaWYgKCF0cmFja2VkQXJyYXkpIHsgcmV0dXJuOyB9CgogICAgdHJhY2tlZEFycmF5LmFwcGx5KGZ1bmN0aW9uIChvYnNlcnZlckNvbnRleHRzLCBvZmZzZXQsIG9wZXJhdGlvbikgewogICAgICBpZiAob3BlcmF0aW9uID09PSBFbWJlci5UcmFja2VkQXJyYXkuREVMRVRFKSB7IHJldHVybjsgfQoKICAgICAgZm9yRWFjaChvYnNlcnZlckNvbnRleHRzLCBmdW5jdGlvbiAob2JzZXJ2ZXJDb250ZXh0KSB7CiAgICAgICAgb2JzZXJ2ZXJDb250ZXh0LmRlc3Ryb3llZCA9IHRydWU7CiAgICAgICAgYmVmb3JlT2JzZXJ2ZXIgPSBvYnNlcnZlckNvbnRleHQuYmVmb3JlT2JzZXJ2ZXI7CiAgICAgICAgb2JzZXJ2ZXIgPSBvYnNlcnZlckNvbnRleHQub2JzZXJ2ZXI7CiAgICAgICAgaXRlbSA9IG9ic2VydmVyQ29udGV4dC5pdGVtOwoKICAgICAgICBmb3JFYWNoKGl0ZW1Qcm9wZXJ0eUtleXMsIGZ1bmN0aW9uIChwcm9wZXJ0eUtleSkgewogICAgICAgICAgcmVtb3ZlQmVmb3JlT2JzZXJ2ZXIoaXRlbSwgcHJvcGVydHlLZXksIGRlcGVuZGVudEFycmF5T2JzZXJ2ZXIsIGJlZm9yZU9ic2VydmVyKTsKICAgICAgICAgIHJlbW92ZU9ic2VydmVyKGl0ZW0sIHByb3BlcnR5S2V5LCBkZXBlbmRlbnRBcnJheU9ic2VydmVyLCBvYnNlcnZlcik7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSk7CiAgfSwKCiAgY3JlYXRlUHJvcGVydHlPYnNlcnZlckNvbnRleHQ6IGZ1bmN0aW9uIChkZXBlbmRlbnRBcnJheSwgaW5kZXgsIHRyYWNrZWRBcnJheSkgewogICAgdmFyIG9ic2VydmVyQ29udGV4dCA9IG5ldyBJdGVtUHJvcGVydHlPYnNlcnZlckNvbnRleHQoZGVwZW5kZW50QXJyYXksIGluZGV4LCB0cmFja2VkQXJyYXkpOwoKICAgIHRoaXMuY3JlYXRlUHJvcGVydHlPYnNlcnZlcihvYnNlcnZlckNvbnRleHQpOwoKICAgIHJldHVybiBvYnNlcnZlckNvbnRleHQ7CiAgfSwKCiAgY3JlYXRlUHJvcGVydHlPYnNlcnZlcjogZnVuY3Rpb24gKG9ic2VydmVyQ29udGV4dCkgewogICAgdmFyIGRlcGVuZGVudEFycmF5T2JzZXJ2ZXIgPSB0aGlzOwoKICAgIG9ic2VydmVyQ29udGV4dC5iZWZvcmVPYnNlcnZlciA9IGZ1bmN0aW9uIChvYmosIGtleU5hbWUpIHsKICAgICAgcmV0dXJuIGRlcGVuZGVudEFycmF5T2JzZXJ2ZXIuaXRlbVByb3BlcnR5V2lsbENoYW5nZShvYmosIGtleU5hbWUsIG9ic2VydmVyQ29udGV4dC5kZXBlbmRlbnRBcnJheSwgb2JzZXJ2ZXJDb250ZXh0KTsKICAgIH07CiAgICBvYnNlcnZlckNvbnRleHQub2JzZXJ2ZXIgPSBmdW5jdGlvbiAob2JqLCBrZXlOYW1lKSB7CiAgICAgIHJldHVybiBkZXBlbmRlbnRBcnJheU9ic2VydmVyLml0ZW1Qcm9wZXJ0eURpZENoYW5nZShvYmosIGtleU5hbWUsIG9ic2VydmVyQ29udGV4dC5kZXBlbmRlbnRBcnJheSwgb2JzZXJ2ZXJDb250ZXh0KTsKICAgIH07CiAgfSwKCiAgcmVzZXRUcmFuc2Zvcm1hdGlvbnM6IGZ1bmN0aW9uIChkZXBlbmRlbnRLZXksIG9ic2VydmVyQ29udGV4dHMpIHsKICAgIHRoaXMudHJhY2tlZEFycmF5c0J5R3VpZFtkZXBlbmRlbnRLZXldID0gbmV3IEVtYmVyLlRyYWNrZWRBcnJheShvYnNlcnZlckNvbnRleHRzKTsKICB9LAoKICB0cmFja0FkZDogZnVuY3Rpb24gKGRlcGVuZGVudEtleSwgaW5kZXgsIG5ld0l0ZW1zKSB7CiAgICB2YXIgdHJhY2tlZEFycmF5ID0gdGhpcy50cmFja2VkQXJyYXlzQnlHdWlkW2RlcGVuZGVudEtleV07CiAgICBpZiAodHJhY2tlZEFycmF5KSB7CiAgICAgIHRyYWNrZWRBcnJheS5hZGRJdGVtcyhpbmRleCwgbmV3SXRlbXMpOwogICAgfQogIH0sCgogIHRyYWNrUmVtb3ZlOiBmdW5jdGlvbiAoZGVwZW5kZW50S2V5LCBpbmRleCwgcmVtb3ZlZENvdW50KSB7CiAgICB2YXIgdHJhY2tlZEFycmF5ID0gdGhpcy50cmFja2VkQXJyYXlzQnlHdWlkW2RlcGVuZGVudEtleV07CgogICAgaWYgKHRyYWNrZWRBcnJheSkgewogICAgICByZXR1cm4gdHJhY2tlZEFycmF5LnJlbW92ZUl0ZW1zKGluZGV4LCByZW1vdmVkQ291bnQpOwogICAgfQoKICAgIHJldHVybiBbXTsKICB9LAoKICB1cGRhdGVJbmRleGVzOiBmdW5jdGlvbiAodHJhY2tlZEFycmF5LCBhcnJheSkgewogICAgdmFyIGxlbmd0aCA9IGdldChhcnJheSwgJ2xlbmd0aCcpOwogICAgLy8gT1BUSU1JWkU6IHdlIGNvdWxkIHN0b3AgdXBkYXRpbmcgb25jZSB3ZSBoaXQgdGhlIG9iamVjdCB3aG9zZSBvYnNlcnZlcgogICAgLy8gZmlyZWQ7IGllIHBhcnRpYWxseSBhcHBseSB0aGUgdHJhbnNmb3JtYXRpb25zCiAgICB0cmFja2VkQXJyYXkuYXBwbHkoZnVuY3Rpb24gKG9ic2VydmVyQ29udGV4dHMsIG9mZnNldCwgb3BlcmF0aW9uKSB7CiAgICAgIC8vIHdlIGRvbid0IGV2ZW4gaGF2ZSBvYnNlcnZlciBjb250ZXh0cyBmb3IgcmVtb3ZlZCBpdGVtcywgZXZlbiBpZiB3ZSBkaWQsCiAgICAgIC8vIHRoZXkgbm8gbG9uZ2VyIGhhdmUgYW55IGluZGV4IGluIHRoZSBhcnJheQogICAgICBpZiAob3BlcmF0aW9uID09PSBFbWJlci5UcmFja2VkQXJyYXkuREVMRVRFKSB7IHJldHVybjsgfQogICAgICBpZiAob3BlcmF0aW9uID09PSBFbWJlci5UcmFja2VkQXJyYXkuUkVUQUlOICYmIG9ic2VydmVyQ29udGV4dHMubGVuZ3RoID09PSBsZW5ndGggJiYgb2Zmc2V0ID09PSAwKSB7CiAgICAgICAgLy8gSWYgd2UgdXBkYXRlIG1hbnkgaXRlbXMgd2UgZG9uJ3Qgd2FudCB0byB3YWxrIHRoZSBhcnJheSBlYWNoIHRpbWU6IHdlCiAgICAgICAgLy8gb25seSBuZWVkIHRvIHVwZGF0ZSB0aGUgaW5kZXhlcyBhdCBtb3N0IG9uY2UgcGVyIHJ1biBsb29wLgogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgZm9yRWFjaChvYnNlcnZlckNvbnRleHRzLCBmdW5jdGlvbiAoY29udGV4dCwgaW5kZXgpIHsKICAgICAgICBjb250ZXh0LmluZGV4ID0gaW5kZXggKyBvZmZzZXQ7CiAgICAgIH0pOwogICAgfSk7CiAgfSwKCiAgZGVwZW5kZW50QXJyYXlXaWxsQ2hhbmdlOiBmdW5jdGlvbiAoZGVwZW5kZW50QXJyYXksIGluZGV4LCByZW1vdmVkQ291bnQsIGFkZGVkQ291bnQpIHsKICAgIGlmICh0aGlzLnN1c3BlbmRlZCkgeyByZXR1cm47IH0KCiAgICB2YXIgcmVtb3ZlZEl0ZW0gPSB0aGlzLmNhbGxiYWNrcy5yZW1vdmVkSXRlbSwKICAgICAgICBjaGFuZ2VNZXRhLAogICAgICAgIGd1aWQgPSBndWlkRm9yKGRlcGVuZGVudEFycmF5KSwKICAgICAgICBkZXBlbmRlbnRLZXkgPSB0aGlzLmRlcGVuZGVudEtleXNCeUd1aWRbZ3VpZF0sCiAgICAgICAgaXRlbVByb3BlcnR5S2V5cyA9IHRoaXMuY3AuX2l0ZW1Qcm9wZXJ0eUtleXNbZGVwZW5kZW50S2V5XSB8fCBbXSwKICAgICAgICBsZW5ndGggPSBnZXQoZGVwZW5kZW50QXJyYXksICdsZW5ndGgnKSwKICAgICAgICBub3JtYWxpemVkSW5kZXggPSBub3JtYWxpemVJbmRleChpbmRleCwgbGVuZ3RoLCAwKSwKICAgICAgICBub3JtYWxpemVkUmVtb3ZlQ291bnQgPSBub3JtYWxpemVSZW1vdmVDb3VudChub3JtYWxpemVkSW5kZXgsIGxlbmd0aCwgcmVtb3ZlZENvdW50KSwKICAgICAgICBpdGVtLAogICAgICAgIGl0ZW1JbmRleCwKICAgICAgICBzbGljZUluZGV4LAogICAgICAgIG9ic2VydmVyQ29udGV4dHM7CgogICAgb2JzZXJ2ZXJDb250ZXh0cyA9IHRoaXMudHJhY2tSZW1vdmUoZGVwZW5kZW50S2V5LCBub3JtYWxpemVkSW5kZXgsIG5vcm1hbGl6ZWRSZW1vdmVDb3VudCk7CgogICAgZnVuY3Rpb24gcmVtb3ZlT2JzZXJ2ZXJzKHByb3BlcnR5S2V5KSB7CiAgICAgIG9ic2VydmVyQ29udGV4dHNbc2xpY2VJbmRleF0uZGVzdHJveWVkID0gdHJ1ZTsKICAgICAgcmVtb3ZlQmVmb3JlT2JzZXJ2ZXIoaXRlbSwgcHJvcGVydHlLZXksIHRoaXMsIG9ic2VydmVyQ29udGV4dHNbc2xpY2VJbmRleF0uYmVmb3JlT2JzZXJ2ZXIpOwogICAgICByZW1vdmVPYnNlcnZlcihpdGVtLCBwcm9wZXJ0eUtleSwgdGhpcywgb2JzZXJ2ZXJDb250ZXh0c1tzbGljZUluZGV4XS5vYnNlcnZlcik7CiAgICB9CgogICAgZm9yIChzbGljZUluZGV4ID0gbm9ybWFsaXplZFJlbW92ZUNvdW50IC0gMTsgc2xpY2VJbmRleCA+PSAwOyAtLXNsaWNlSW5kZXgpIHsKICAgICAgaXRlbUluZGV4ID0gbm9ybWFsaXplZEluZGV4ICsgc2xpY2VJbmRleDsKICAgICAgaWYgKGl0ZW1JbmRleCA+PSBsZW5ndGgpIHsgYnJlYWs7IH0KCiAgICAgIGl0ZW0gPSBkZXBlbmRlbnRBcnJheS5vYmplY3RBdChpdGVtSW5kZXgpOwoKICAgICAgZm9yRWFjaChpdGVtUHJvcGVydHlLZXlzLCByZW1vdmVPYnNlcnZlcnMsIHRoaXMpOwoKICAgICAgY2hhbmdlTWV0YSA9IGNyZWF0ZUNoYW5nZU1ldGEoZGVwZW5kZW50QXJyYXksIGl0ZW0sIGl0ZW1JbmRleCwgdGhpcy5pbnN0YW5jZU1ldGEucHJvcGVydHlOYW1lLCB0aGlzLmNwKTsKICAgICAgdGhpcy5zZXRWYWx1ZSggcmVtb3ZlZEl0ZW0uY2FsbCgKICAgICAgICB0aGlzLmluc3RhbmNlTWV0YS5jb250ZXh0LCB0aGlzLmdldFZhbHVlKCksIGl0ZW0sIGNoYW5nZU1ldGEsIHRoaXMuaW5zdGFuY2VNZXRhLnN1Z2FyTWV0YSkpOwogICAgfQogIH0sCgogIGRlcGVuZGVudEFycmF5RGlkQ2hhbmdlOiBmdW5jdGlvbiAoZGVwZW5kZW50QXJyYXksIGluZGV4LCByZW1vdmVkQ291bnQsIGFkZGVkQ291bnQpIHsKICAgIGlmICh0aGlzLnN1c3BlbmRlZCkgeyByZXR1cm47IH0KCiAgICB2YXIgYWRkZWRJdGVtID0gdGhpcy5jYWxsYmFja3MuYWRkZWRJdGVtLAogICAgICAgIGd1aWQgPSBndWlkRm9yKGRlcGVuZGVudEFycmF5KSwKICAgICAgICBkZXBlbmRlbnRLZXkgPSB0aGlzLmRlcGVuZGVudEtleXNCeUd1aWRbZ3VpZF0sCiAgICAgICAgb2JzZXJ2ZXJDb250ZXh0cyA9IG5ldyBBcnJheShhZGRlZENvdW50KSwKICAgICAgICBpdGVtUHJvcGVydHlLZXlzID0gdGhpcy5jcC5faXRlbVByb3BlcnR5S2V5c1tkZXBlbmRlbnRLZXldLAogICAgICAgIGxlbmd0aCA9IGdldChkZXBlbmRlbnRBcnJheSwgJ2xlbmd0aCcpLAogICAgICAgIG5vcm1hbGl6ZWRJbmRleCA9IG5vcm1hbGl6ZUluZGV4KGluZGV4LCBsZW5ndGgsIGFkZGVkQ291bnQpLAogICAgICAgIGNoYW5nZU1ldGEsCiAgICAgICAgb2JzZXJ2ZXJDb250ZXh0OwoKICAgIGZvckVhY2goZGVwZW5kZW50QXJyYXkuc2xpY2Uobm9ybWFsaXplZEluZGV4LCBub3JtYWxpemVkSW5kZXggKyBhZGRlZENvdW50KSwgZnVuY3Rpb24gKGl0ZW0sIHNsaWNlSW5kZXgpIHsKICAgICAgaWYgKGl0ZW1Qcm9wZXJ0eUtleXMpIHsKICAgICAgICBvYnNlcnZlckNvbnRleHQgPQogICAgICAgICAgb2JzZXJ2ZXJDb250ZXh0c1tzbGljZUluZGV4XSA9CiAgICAgICAgICB0aGlzLmNyZWF0ZVByb3BlcnR5T2JzZXJ2ZXJDb250ZXh0KGRlcGVuZGVudEFycmF5LCBub3JtYWxpemVkSW5kZXggKyBzbGljZUluZGV4LCB0aGlzLnRyYWNrZWRBcnJheXNCeUd1aWRbZGVwZW5kZW50S2V5XSk7CiAgICAgICAgZm9yRWFjaChpdGVtUHJvcGVydHlLZXlzLCBmdW5jdGlvbiAocHJvcGVydHlLZXkpIHsKICAgICAgICAgIGFkZEJlZm9yZU9ic2VydmVyKGl0ZW0sIHByb3BlcnR5S2V5LCB0aGlzLCBvYnNlcnZlckNvbnRleHQuYmVmb3JlT2JzZXJ2ZXIpOwogICAgICAgICAgYWRkT2JzZXJ2ZXIoaXRlbSwgcHJvcGVydHlLZXksIHRoaXMsIG9ic2VydmVyQ29udGV4dC5vYnNlcnZlcik7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgIH0KCiAgICAgIGNoYW5nZU1ldGEgPSBjcmVhdGVDaGFuZ2VNZXRhKGRlcGVuZGVudEFycmF5LCBpdGVtLCBub3JtYWxpemVkSW5kZXggKyBzbGljZUluZGV4LCB0aGlzLmluc3RhbmNlTWV0YS5wcm9wZXJ0eU5hbWUsIHRoaXMuY3ApOwogICAgICB0aGlzLnNldFZhbHVlKCBhZGRlZEl0ZW0uY2FsbCgKICAgICAgICB0aGlzLmluc3RhbmNlTWV0YS5jb250ZXh0LCB0aGlzLmdldFZhbHVlKCksIGl0ZW0sIGNoYW5nZU1ldGEsIHRoaXMuaW5zdGFuY2VNZXRhLnN1Z2FyTWV0YSkpOwogICAgfSwgdGhpcyk7CgogICAgdGhpcy50cmFja0FkZChkZXBlbmRlbnRLZXksIG5vcm1hbGl6ZWRJbmRleCwgb2JzZXJ2ZXJDb250ZXh0cyk7CiAgfSwKCiAgaXRlbVByb3BlcnR5V2lsbENoYW5nZTogZnVuY3Rpb24gKG9iaiwga2V5TmFtZSwgYXJyYXksIG9ic2VydmVyQ29udGV4dCkgewogICAgdmFyIGd1aWQgPSBndWlkRm9yKG9iaik7CgogICAgaWYgKCF0aGlzLmNoYW5nZWRJdGVtc1tndWlkXSkgewogICAgICB0aGlzLmNoYW5nZWRJdGVtc1tndWlkXSA9IHsKICAgICAgICBhcnJheTogICAgICAgICAgICBhcnJheSwKICAgICAgICBvYnNlcnZlckNvbnRleHQ6ICBvYnNlcnZlckNvbnRleHQsCiAgICAgICAgb2JqOiAgICAgICAgICAgICAgb2JqLAogICAgICAgIHByZXZpb3VzVmFsdWVzOiAgIHt9CiAgICAgIH07CiAgICB9CgogICAgdGhpcy5jaGFuZ2VkSXRlbXNbZ3VpZF0ucHJldmlvdXNWYWx1ZXNba2V5TmFtZV0gPSBnZXQob2JqLCBrZXlOYW1lKTsKICB9LAoKICBpdGVtUHJvcGVydHlEaWRDaGFuZ2U6IGZ1bmN0aW9uKG9iaiwga2V5TmFtZSwgYXJyYXksIG9ic2VydmVyQ29udGV4dCkgewogICAgdGhpcy5mbHVzaENoYW5nZXMoKTsKICB9LAoKICBmbHVzaENoYW5nZXM6IGZ1bmN0aW9uKCkgewogICAgdmFyIGNoYW5nZWRJdGVtcyA9IHRoaXMuY2hhbmdlZEl0ZW1zLCBrZXksIGMsIGNoYW5nZU1ldGE7CgogICAgZm9yIChrZXkgaW4gY2hhbmdlZEl0ZW1zKSB7CiAgICAgIGMgPSBjaGFuZ2VkSXRlbXNba2V5XTsKICAgICAgaWYgKGMub2JzZXJ2ZXJDb250ZXh0LmRlc3Ryb3llZCkgeyBjb250aW51ZTsgfQoKICAgICAgdGhpcy51cGRhdGVJbmRleGVzKGMub2JzZXJ2ZXJDb250ZXh0LnRyYWNrZWRBcnJheSwgYy5vYnNlcnZlckNvbnRleHQuZGVwZW5kZW50QXJyYXkpOwoKICAgICAgY2hhbmdlTWV0YSA9IGNyZWF0ZUNoYW5nZU1ldGEoYy5hcnJheSwgYy5vYmosIGMub2JzZXJ2ZXJDb250ZXh0LmluZGV4LCB0aGlzLmluc3RhbmNlTWV0YS5wcm9wZXJ0eU5hbWUsIHRoaXMuY3AsIGMucHJldmlvdXNWYWx1ZXMpOwogICAgICB0aGlzLnNldFZhbHVlKAogICAgICAgIHRoaXMuY2FsbGJhY2tzLnJlbW92ZWRJdGVtLmNhbGwodGhpcy5pbnN0YW5jZU1ldGEuY29udGV4dCwgdGhpcy5nZXRWYWx1ZSgpLCBjLm9iaiwgY2hhbmdlTWV0YSwgdGhpcy5pbnN0YW5jZU1ldGEuc3VnYXJNZXRhKSk7CiAgICAgIHRoaXMuc2V0VmFsdWUoCiAgICAgICAgdGhpcy5jYWxsYmFja3MuYWRkZWRJdGVtLmNhbGwodGhpcy5pbnN0YW5jZU1ldGEuY29udGV4dCwgdGhpcy5nZXRWYWx1ZSgpLCBjLm9iaiwgY2hhbmdlTWV0YSwgdGhpcy5pbnN0YW5jZU1ldGEuc3VnYXJNZXRhKSk7CiAgICB9CiAgICB0aGlzLmNoYW5nZWRJdGVtcyA9IHt9OwogIH0KfTsKCmZ1bmN0aW9uIG5vcm1hbGl6ZUluZGV4KGluZGV4LCBsZW5ndGgsIG5ld0l0ZW1zT2Zmc2V0KSB7CiAgaWYgKGluZGV4IDwgMCkgewogICAgcmV0dXJuIE1hdGgubWF4KDAsIGxlbmd0aCArIGluZGV4KTsKICB9IGVsc2UgaWYgKGluZGV4IDwgbGVuZ3RoKSB7CiAgICByZXR1cm4gaW5kZXg7CiAgfSBlbHNlIC8qIGluZGV4ID4gbGVuZ3RoICovIHsKICAgIHJldHVybiBNYXRoLm1pbihsZW5ndGggLSBuZXdJdGVtc09mZnNldCwgaW5kZXgpOwogIH0KfQoKZnVuY3Rpb24gbm9ybWFsaXplUmVtb3ZlQ291bnQoaW5kZXgsIGxlbmd0aCwgcmVtb3ZlZENvdW50KSB7CiAgcmV0dXJuIE1hdGgubWluKHJlbW92ZWRDb3VudCwgbGVuZ3RoIC0gaW5kZXgpOwp9CgpmdW5jdGlvbiBjcmVhdGVDaGFuZ2VNZXRhKGRlcGVuZGVudEFycmF5LCBpdGVtLCBpbmRleCwgcHJvcGVydHlOYW1lLCBwcm9wZXJ0eSwgcHJldmlvdXNWYWx1ZXMpIHsKICB2YXIgbWV0YSA9IHsKICAgIGFycmF5Q2hhbmdlZDogZGVwZW5kZW50QXJyYXksCiAgICBpbmRleDogaW5kZXgsCiAgICBpdGVtOiBpdGVtLAogICAgcHJvcGVydHlOYW1lOiBwcm9wZXJ0eU5hbWUsCiAgICBwcm9wZXJ0eTogcHJvcGVydHkKICB9OwoKICBpZiAocHJldmlvdXNWYWx1ZXMpIHsKICAgIC8vIHByZXZpb3VzIHZhbHVlcyBvbmx5IGF2YWlsYWJsZSBmb3IgaXRlbSBwcm9wZXJ0eSBjaGFuZ2VzCiAgICBtZXRhLnByZXZpb3VzVmFsdWVzID0gcHJldmlvdXNWYWx1ZXM7CiAgfQoKICByZXR1cm4gbWV0YTsKfQoKZnVuY3Rpb24gYWRkSXRlbXMgKGRlcGVuZGVudEFycmF5LCBjYWxsYmFja3MsIGNwLCBwcm9wZXJ0eU5hbWUsIG1ldGEpIHsKICBmb3JFYWNoKGRlcGVuZGVudEFycmF5LCBmdW5jdGlvbiAoaXRlbSwgaW5kZXgpIHsKICAgIG1ldGEuc2V0VmFsdWUoIGNhbGxiYWNrcy5hZGRlZEl0ZW0uY2FsbCgKICAgICAgdGhpcywgbWV0YS5nZXRWYWx1ZSgpLCBpdGVtLCBjcmVhdGVDaGFuZ2VNZXRhKGRlcGVuZGVudEFycmF5LCBpdGVtLCBpbmRleCwgcHJvcGVydHlOYW1lLCBjcCksIG1ldGEuc3VnYXJNZXRhKSk7CiAgfSwgdGhpcyk7Cn0KCmZ1bmN0aW9uIHJlc2V0KGNwLCBwcm9wZXJ0eU5hbWUpIHsKICB2YXIgY2FsbGJhY2tzID0gY3AuX2NhbGxiYWNrcygpLAogICAgICBtZXRhOwoKICBpZiAoY3AuX2hhc0luc3RhbmNlTWV0YSh0aGlzLCBwcm9wZXJ0eU5hbWUpKSB7CiAgICBtZXRhID0gY3AuX2luc3RhbmNlTWV0YSh0aGlzLCBwcm9wZXJ0eU5hbWUpOwogICAgbWV0YS5zZXRWYWx1ZShjcC5yZXNldFZhbHVlKG1ldGEuZ2V0VmFsdWUoKSkpOwogIH0gZWxzZSB7CiAgICBtZXRhID0gY3AuX2luc3RhbmNlTWV0YSh0aGlzLCBwcm9wZXJ0eU5hbWUpOwogIH0KCiAgaWYgKGNwLm9wdGlvbnMuaW5pdGlhbGl6ZSkgewogICAgY3Aub3B0aW9ucy5pbml0aWFsaXplLmNhbGwodGhpcywgbWV0YS5nZXRWYWx1ZSgpLCB7IHByb3BlcnR5OiBjcCwgcHJvcGVydHlOYW1lOiBwcm9wZXJ0eU5hbWUgfSwgbWV0YS5zdWdhck1ldGEpOwogIH0KfQoKZnVuY3Rpb24gcGFydGlhbGx5UmVjb21wdXRlRm9yKG9iaiwgZGVwZW5kZW50S2V5KSB7CiAgaWYgKGFycmF5QnJhY2tldFBhdHRlcm4udGVzdChkZXBlbmRlbnRLZXkpKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICB2YXIgdmFsdWUgPSBnZXQob2JqLCBkZXBlbmRlbnRLZXkpOwogIHJldHVybiBFbWJlci5BcnJheS5kZXRlY3QodmFsdWUpOwp9CgpmdW5jdGlvbiBSZWR1Y2VDb21wdXRlZFByb3BlcnR5SW5zdGFuY2VNZXRhKGNvbnRleHQsIHByb3BlcnR5TmFtZSwgaW5pdGlhbFZhbHVlKSB7CiAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICB0aGlzLnByb3BlcnR5TmFtZSA9IHByb3BlcnR5TmFtZTsKICB0aGlzLmNhY2hlID0gbWV0YUZvcihjb250ZXh0KS5jYWNoZTsKCiAgdGhpcy5kZXBlbmRlbnRBcnJheXMgPSB7fTsKICB0aGlzLnN1Z2FyTWV0YSA9IHt9OwoKICB0aGlzLmluaXRpYWxWYWx1ZSA9IGluaXRpYWxWYWx1ZTsKfQoKUmVkdWNlQ29tcHV0ZWRQcm9wZXJ0eUluc3RhbmNlTWV0YS5wcm90b3R5cGUgPSB7CiAgZ2V0VmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLnByb3BlcnR5TmFtZSBpbiB0aGlzLmNhY2hlKSB7CiAgICAgIHJldHVybiB0aGlzLmNhY2hlW3RoaXMucHJvcGVydHlOYW1lXTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLmluaXRpYWxWYWx1ZTsKICAgIH0KICB9LAoKICBzZXRWYWx1ZTogZnVuY3Rpb24obmV3VmFsdWUsIHRyaWdnZXJPYnNlcnZlcnMpIHsKICAgIC8vIFRoaXMgbGV0cyBzdWdhcnMgZm9yY2UgYSByZWNvbXB1dGF0aW9uLCBoYW5keSBmb3IgdmVyeSBzaW1wbGUKICAgIC8vIGltcGxlbWVudGF0aW9ucyBvZiBlZyBtYXguCiAgICBpZiAobmV3VmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICB2YXIgZmlyZU9ic2VydmVycyA9IHRyaWdnZXJPYnNlcnZlcnMgJiYgKG5ld1ZhbHVlICE9PSB0aGlzLmNhY2hlW3RoaXMucHJvcGVydHlOYW1lXSk7CgogICAgICBpZiAoZmlyZU9ic2VydmVycykgewogICAgICAgIHByb3BlcnR5V2lsbENoYW5nZSh0aGlzLmNvbnRleHQsIHRoaXMucHJvcGVydHlOYW1lKTsKICAgICAgfQoKICAgICAgdGhpcy5jYWNoZVt0aGlzLnByb3BlcnR5TmFtZV0gPSBuZXdWYWx1ZTsKCiAgICAgIGlmIChmaXJlT2JzZXJ2ZXJzKSB7CiAgICAgICAgcHJvcGVydHlEaWRDaGFuZ2UodGhpcy5jb250ZXh0LCB0aGlzLnByb3BlcnR5TmFtZSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGRlbGV0ZSB0aGlzLmNhY2hlW3RoaXMucHJvcGVydHlOYW1lXTsKICAgIH0KICB9Cn07CgovKioKICBBIGNvbXB1dGVkIHByb3BlcnR5IHdob3NlIGRlcGVuZGVudCBrZXlzIGFyZSBhcnJheXMgYW5kIHdoaWNoIGlzIHVwZGF0ZWQgd2l0aAogICJvbmUgYXQgYSB0aW1lIiBzZW1hbnRpY3MuCgogIEBjbGFzcyBSZWR1Y2VDb21wdXRlZFByb3BlcnR5CiAgQG5hbWVzcGFjZSBFbWJlcgogIEBleHRlbmRzIEVtYmVyLkNvbXB1dGVkUHJvcGVydHkKICBAY29uc3RydWN0b3IKKi8KZnVuY3Rpb24gUmVkdWNlQ29tcHV0ZWRQcm9wZXJ0eShvcHRpb25zKSB7CiAgdmFyIGNwID0gdGhpczsKCiAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICB0aGlzLl9pbnN0YW5jZU1ldGFzID0ge307CgogIHRoaXMuX2RlcGVuZGVudEtleXMgPSBudWxsOwogIC8vIEEgbWFwIG9mIGRlcGVuZGVudEtleSAtPiBbaXRlbVByb3BlcnR5LCAuLi5dIHRoYXQgdHJhY2tzIHdoYXQgcHJvcGVydGllcyBvZgogIC8vIGl0ZW1zIGluIHRoZSBhcnJheSB3ZSBtdXN0IHRyYWNrIHRvIHVwZGF0ZSB0aGlzIHByb3BlcnR5LgogIHRoaXMuX2l0ZW1Qcm9wZXJ0eUtleXMgPSB7fTsKICB0aGlzLl9wcmV2aW91c0l0ZW1Qcm9wZXJ0eUtleXMgPSB7fTsKCiAgdGhpcy5yZWFkT25seSgpOwogIHRoaXMuY2FjaGVhYmxlKCk7CgogIHRoaXMucmVjb21wdXRlT25jZSA9IGZ1bmN0aW9uKHByb3BlcnR5TmFtZSkgewogICAgLy8gV2hhdCB3ZSByZWFsbHkgd2FudCB0byBkbyBpcyBjb2FsZXNjZSBieSA8Y3AsIHByb3BlcnR5TmFtZT4uCiAgICAvLyBXZSBuZWVkIGEgZm9ybSBvZiBgc2NoZWR1bGVPbmNlYCB0aGF0IGFjY2VwdHMgYW4gYXJiaXRyYXJ5IHRva2VuIHRvCiAgICAvLyBjb2FsZXNjZSBieSwgaW4gYWRkaXRpb24gdG8gdGhlIHRhcmdldCBhbmQgbWV0aG9kLgogICAgRW1iZXIucnVuLm9uY2UodGhpcywgcmVjb21wdXRlLCBwcm9wZXJ0eU5hbWUpOwogIH07CiAgdmFyIHJlY29tcHV0ZSA9IGZ1bmN0aW9uKHByb3BlcnR5TmFtZSkgewogICAgdmFyIGRlcGVuZGVudEtleXMgPSBjcC5fZGVwZW5kZW50S2V5cywKICAgICAgICBtZXRhID0gY3AuX2luc3RhbmNlTWV0YSh0aGlzLCBwcm9wZXJ0eU5hbWUpLAogICAgICAgIGNhbGxiYWNrcyA9IGNwLl9jYWxsYmFja3MoKTsKCiAgICByZXNldC5jYWxsKHRoaXMsIGNwLCBwcm9wZXJ0eU5hbWUpOwoKICAgIG1ldGEuZGVwZW5kZW50QXJyYXlzT2JzZXJ2ZXIuc3VzcGVuZEFycmF5T2JzZXJ2ZXJzKGZ1bmN0aW9uICgpIHsKICAgICAgZm9yRWFjaChjcC5fZGVwZW5kZW50S2V5cywgZnVuY3Rpb24gKGRlcGVuZGVudEtleSkgewogICAgICAgIGlmICghcGFydGlhbGx5UmVjb21wdXRlRm9yKHRoaXMsIGRlcGVuZGVudEtleSkpIHsgcmV0dXJuOyB9CgogICAgICAgIHZhciBkZXBlbmRlbnRBcnJheSA9IGdldCh0aGlzLCBkZXBlbmRlbnRLZXkpLAogICAgICAgICAgICBwcmV2aW91c0RlcGVuZGVudEFycmF5ID0gbWV0YS5kZXBlbmRlbnRBcnJheXNbZGVwZW5kZW50S2V5XTsKCiAgICAgICAgaWYgKGRlcGVuZGVudEFycmF5ID09PSBwcmV2aW91c0RlcGVuZGVudEFycmF5KSB7CiAgICAgICAgICAvLyBUaGUgYXJyYXkgbWF5IGJlIHRoZSBzYW1lLCBidXQgb3VyIGl0ZW0gcHJvcGVydHkga2V5cyBtYXkgaGF2ZQogICAgICAgICAgLy8gY2hhbmdlZCwgc28gd2Ugc2V0IHRoZW0gdXAgYWdhaW4uICBXZSBjYW4ndCBlYXNpbHkgdGVsbCBpZiB0aGV5J3ZlCiAgICAgICAgICAvLyBjaGFuZ2VkOiB0aGUgYXJyYXkgbWF5IGJlIHRoZSBzYW1lIG9iamVjdCwgYnV0IHdpdGggZGlmZmVyZW50CiAgICAgICAgICAvLyBjb250ZW50cy4KICAgICAgICAgIGlmIChjcC5fcHJldmlvdXNJdGVtUHJvcGVydHlLZXlzW2RlcGVuZGVudEtleV0pIHsKICAgICAgICAgICAgZGVsZXRlIGNwLl9wcmV2aW91c0l0ZW1Qcm9wZXJ0eUtleXNbZGVwZW5kZW50S2V5XTsKICAgICAgICAgICAgbWV0YS5kZXBlbmRlbnRBcnJheXNPYnNlcnZlci5zZXR1cFByb3BlcnR5T2JzZXJ2ZXJzKGRlcGVuZGVudEtleSwgY3AuX2l0ZW1Qcm9wZXJ0eUtleXNbZGVwZW5kZW50S2V5XSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG1ldGEuZGVwZW5kZW50QXJyYXlzW2RlcGVuZGVudEtleV0gPSBkZXBlbmRlbnRBcnJheTsKCiAgICAgICAgICBpZiAocHJldmlvdXNEZXBlbmRlbnRBcnJheSkgewogICAgICAgICAgICBtZXRhLmRlcGVuZGVudEFycmF5c09ic2VydmVyLnRlYXJkb3duT2JzZXJ2ZXJzKHByZXZpb3VzRGVwZW5kZW50QXJyYXksIGRlcGVuZGVudEtleSk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGRlcGVuZGVudEFycmF5KSB7CiAgICAgICAgICAgIG1ldGEuZGVwZW5kZW50QXJyYXlzT2JzZXJ2ZXIuc2V0dXBPYnNlcnZlcnMoZGVwZW5kZW50QXJyYXksIGRlcGVuZGVudEtleSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCB0aGlzKTsKICAgIH0sIHRoaXMpOwoKICAgIGZvckVhY2goY3AuX2RlcGVuZGVudEtleXMsIGZ1bmN0aW9uKGRlcGVuZGVudEtleSkgewogICAgICBpZiAoIXBhcnRpYWxseVJlY29tcHV0ZUZvcih0aGlzLCBkZXBlbmRlbnRLZXkpKSB7IHJldHVybjsgfQoKICAgICAgdmFyIGRlcGVuZGVudEFycmF5ID0gZ2V0KHRoaXMsIGRlcGVuZGVudEtleSk7CiAgICAgIGlmIChkZXBlbmRlbnRBcnJheSkgewogICAgICAgIGFkZEl0ZW1zLmNhbGwodGhpcywgZGVwZW5kZW50QXJyYXksIGNhbGxiYWNrcywgY3AsIHByb3BlcnR5TmFtZSwgbWV0YSk7CiAgICAgIH0KICAgIH0sIHRoaXMpOwogIH07CgogIHRoaXMuZnVuYyA9IGZ1bmN0aW9uIChwcm9wZXJ0eU5hbWUpIHsKICAgIEVtYmVyLmFzc2VydCgiQ29tcHV0ZWQgcmVkdWNlIHZhbHVlcyByZXF1aXJlIGF0IGxlYXN0IG9uZSBkZXBlbmRlbnQga2V5IiwgY3AuX2RlcGVuZGVudEtleXMpOwoKICAgIHJlY29tcHV0ZS5jYWxsKHRoaXMsIHByb3BlcnR5TmFtZSk7CgogICAgcmV0dXJuIGNwLl9pbnN0YW5jZU1ldGEodGhpcywgcHJvcGVydHlOYW1lKS5nZXRWYWx1ZSgpOwogIH07Cn0KCkVtYmVyLlJlZHVjZUNvbXB1dGVkUHJvcGVydHkgPSBSZWR1Y2VDb21wdXRlZFByb3BlcnR5OwpSZWR1Y2VDb21wdXRlZFByb3BlcnR5LnByb3RvdHlwZSA9IG9fY3JlYXRlKENvbXB1dGVkUHJvcGVydHkucHJvdG90eXBlKTsKCmZ1bmN0aW9uIGRlZmF1bHRDYWxsYmFjayhjb21wdXRlZFZhbHVlKSB7CiAgcmV0dXJuIGNvbXB1dGVkVmFsdWU7Cn0KClJlZHVjZUNvbXB1dGVkUHJvcGVydHkucHJvdG90eXBlLl9jYWxsYmFja3MgPSBmdW5jdGlvbiAoKSB7CiAgaWYgKCF0aGlzLmNhbGxiYWNrcykgewogICAgdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CiAgICB0aGlzLmNhbGxiYWNrcyA9IHsKICAgICAgcmVtb3ZlZEl0ZW06IG9wdGlvbnMucmVtb3ZlZEl0ZW0gfHwgZGVmYXVsdENhbGxiYWNrLAogICAgICBhZGRlZEl0ZW06IG9wdGlvbnMuYWRkZWRJdGVtIHx8IGRlZmF1bHRDYWxsYmFjawogICAgfTsKICB9CiAgcmV0dXJuIHRoaXMuY2FsbGJhY2tzOwp9OwoKUmVkdWNlQ29tcHV0ZWRQcm9wZXJ0eS5wcm90b3R5cGUuX2hhc0luc3RhbmNlTWV0YSA9IGZ1bmN0aW9uIChjb250ZXh0LCBwcm9wZXJ0eU5hbWUpIHsKICB2YXIgZ3VpZCA9IGd1aWRGb3IoY29udGV4dCksCiAgICAgIGtleSA9IGd1aWQgKyAnOicgKyBwcm9wZXJ0eU5hbWU7CgogIHJldHVybiAhIXRoaXMuX2luc3RhbmNlTWV0YXNba2V5XTsKfTsKClJlZHVjZUNvbXB1dGVkUHJvcGVydHkucHJvdG90eXBlLl9pbnN0YW5jZU1ldGEgPSBmdW5jdGlvbiAoY29udGV4dCwgcHJvcGVydHlOYW1lKSB7CiAgdmFyIGd1aWQgPSBndWlkRm9yKGNvbnRleHQpLAogICAgICBrZXkgPSBndWlkICsgJzonICsgcHJvcGVydHlOYW1lLAogICAgICBtZXRhID0gdGhpcy5faW5zdGFuY2VNZXRhc1trZXldOwoKICBpZiAoIW1ldGEpIHsKICAgIG1ldGEgPSB0aGlzLl9pbnN0YW5jZU1ldGFzW2tleV0gPSBuZXcgUmVkdWNlQ29tcHV0ZWRQcm9wZXJ0eUluc3RhbmNlTWV0YShjb250ZXh0LCBwcm9wZXJ0eU5hbWUsIHRoaXMuaW5pdGlhbFZhbHVlKCkpOwogICAgbWV0YS5kZXBlbmRlbnRBcnJheXNPYnNlcnZlciA9IG5ldyBEZXBlbmRlbnRBcnJheXNPYnNlcnZlcih0aGlzLl9jYWxsYmFja3MoKSwgdGhpcywgbWV0YSwgY29udGV4dCwgcHJvcGVydHlOYW1lLCBtZXRhLnN1Z2FyTWV0YSk7CiAgfQoKICByZXR1cm4gbWV0YTsKfTsKClJlZHVjZUNvbXB1dGVkUHJvcGVydHkucHJvdG90eXBlLmluaXRpYWxWYWx1ZSA9IGZ1bmN0aW9uICgpIHsKICBpZiAodHlwZW9mIHRoaXMub3B0aW9ucy5pbml0aWFsVmFsdWUgPT09ICdmdW5jdGlvbicpIHsKICAgIHJldHVybiB0aGlzLm9wdGlvbnMuaW5pdGlhbFZhbHVlKCk7CiAgfQogIGVsc2UgewogICAgcmV0dXJuIHRoaXMub3B0aW9ucy5pbml0aWFsVmFsdWU7CiAgfQp9OwoKUmVkdWNlQ29tcHV0ZWRQcm9wZXJ0eS5wcm90b3R5cGUucmVzZXRWYWx1ZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogIHJldHVybiB0aGlzLmluaXRpYWxWYWx1ZSgpOwp9OwoKUmVkdWNlQ29tcHV0ZWRQcm9wZXJ0eS5wcm90b3R5cGUuaXRlbVByb3BlcnR5S2V5ID0gZnVuY3Rpb24gKGRlcGVuZGVudEFycmF5S2V5LCBpdGVtUHJvcGVydHlLZXkpIHsKICB0aGlzLl9pdGVtUHJvcGVydHlLZXlzW2RlcGVuZGVudEFycmF5S2V5XSA9IHRoaXMuX2l0ZW1Qcm9wZXJ0eUtleXNbZGVwZW5kZW50QXJyYXlLZXldIHx8IFtdOwogIHRoaXMuX2l0ZW1Qcm9wZXJ0eUtleXNbZGVwZW5kZW50QXJyYXlLZXldLnB1c2goaXRlbVByb3BlcnR5S2V5KTsKfTsKClJlZHVjZUNvbXB1dGVkUHJvcGVydHkucHJvdG90eXBlLmNsZWFySXRlbVByb3BlcnR5S2V5cyA9IGZ1bmN0aW9uIChkZXBlbmRlbnRBcnJheUtleSkgewogIGlmICh0aGlzLl9pdGVtUHJvcGVydHlLZXlzW2RlcGVuZGVudEFycmF5S2V5XSkgewogICAgdGhpcy5fcHJldmlvdXNJdGVtUHJvcGVydHlLZXlzW2RlcGVuZGVudEFycmF5S2V5XSA9IHRoaXMuX2l0ZW1Qcm9wZXJ0eUtleXNbZGVwZW5kZW50QXJyYXlLZXldOwogICAgdGhpcy5faXRlbVByb3BlcnR5S2V5c1tkZXBlbmRlbnRBcnJheUtleV0gPSBbXTsKICB9Cn07CgpSZWR1Y2VDb21wdXRlZFByb3BlcnR5LnByb3RvdHlwZS5wcm9wZXJ0eSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgY3AgPSB0aGlzLAogICAgICBhcmdzID0gYV9zbGljZS5jYWxsKGFyZ3VtZW50cyksCiAgICAgIHByb3BlcnR5QXJncyA9IG5ldyBFbWJlci5TZXQoKSwKICAgICAgbWF0Y2gsCiAgICAgIGRlcGVuZGVudEFycmF5S2V5LAogICAgICBpdGVtUHJvcGVydHlLZXk7CgogIGZvckVhY2goYV9zbGljZS5jYWxsKGFyZ3VtZW50cyksIGZ1bmN0aW9uIChkZXBlbmRlbnRLZXkpIHsKICAgIGlmIChkb3VibGVFYWNoUHJvcGVydHlQYXR0ZXJuLnRlc3QoZGVwZW5kZW50S2V5KSkgewogICAgICB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoIk5lc3RlZCBAZWFjaCBwcm9wZXJ0aWVzIG5vdCBzdXBwb3J0ZWQ6ICIgKyBkZXBlbmRlbnRLZXkpOwogICAgfSBlbHNlIGlmIChtYXRjaCA9IGVhY2hQcm9wZXJ0eVBhdHRlcm4uZXhlYyhkZXBlbmRlbnRLZXkpKSB7CiAgICAgIGRlcGVuZGVudEFycmF5S2V5ID0gbWF0Y2hbMV07CgogICAgICAKICAgICAgICBpdGVtUHJvcGVydHlLZXkgPSBtYXRjaFsyXTsKICAgICAgICBjcC5pdGVtUHJvcGVydHlLZXkoZGVwZW5kZW50QXJyYXlLZXksIGl0ZW1Qcm9wZXJ0eUtleSk7CiAgICAgIAogICAgICBwcm9wZXJ0eUFyZ3MuYWRkKGRlcGVuZGVudEFycmF5S2V5KTsKICAgIH0gZWxzZSB7CiAgICAgIHByb3BlcnR5QXJncy5hZGQoZGVwZW5kZW50S2V5KTsKICAgIH0KICB9KTsKCiAgcmV0dXJuIENvbXB1dGVkUHJvcGVydHkucHJvdG90eXBlLnByb3BlcnR5LmFwcGx5KHRoaXMsIHByb3BlcnR5QXJncy50b0FycmF5KCkpOwoKfTsKCi8qKgogIENyZWF0ZXMgYSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCBvcGVyYXRlcyBvbiBkZXBlbmRlbnQgYXJyYXlzIGFuZAogIGlzIHVwZGF0ZWQgd2l0aCAib25lIGF0IGEgdGltZSIgc2VtYW50aWNzLiBXaGVuIGl0ZW1zIGFyZSBhZGRlZCBvcgogIHJlbW92ZWQgZnJvbSB0aGUgZGVwZW5kZW50IGFycmF5KHMpIGEgcmVkdWNlIGNvbXB1dGVkIG9ubHkgb3BlcmF0ZXMKICBvbiB0aGUgY2hhbmdlIGluc3RlYWQgb2YgcmUtZXZhbHVhdGluZyB0aGUgZW50aXJlIGFycmF5LgoKICBJZiB0aGVyZSBhcmUgbW9yZSB0aGFuIG9uZSBhcmd1bWVudHMgdGhlIGZpcnN0IGFyZ3VtZW50cyBhcmUKICBjb25zaWRlcmVkIHRvIGJlIGRlcGVuZGVudCBwcm9wZXJ0eSBrZXlzLiBUaGUgbGFzdCBhcmd1bWVudCBpcwogIHJlcXVpcmVkIHRvIGJlIGFuIG9wdGlvbnMgb2JqZWN0LiBUaGUgb3B0aW9ucyBvYmplY3QgY2FuIGhhdmUgdGhlCiAgZm9sbG93aW5nIGZvdXIgcHJvcGVydGllczoKCiAgYGluaXRpYWxWYWx1ZWAgLSBBIHZhbHVlIG9yIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSB1c2VkIGFzIHRoZSBpbml0aWFsCiAgdmFsdWUgZm9yIHRoZSBjb21wdXRlZC4gSWYgdGhpcyBwcm9wZXJ0eSBpcyBhIGZ1bmN0aW9uIHRoZSByZXN1bHQgb2YgY2FsbGluZwogIHRoZSBmdW5jdGlvbiB3aWxsIGJlIHVzZWQgYXMgdGhlIGluaXRpYWwgdmFsdWUuIFRoaXMgcHJvcGVydHkgaXMgcmVxdWlyZWQuCgogIGBpbml0aWFsaXplYCAtIEFuIG9wdGlvbmFsIGluaXRpYWxpemUgZnVuY3Rpb24uIFR5cGljYWxseSB0aGlzIHdpbGwgYmUgdXNlZAogIHRvIHNldCB1cCBzdGF0ZSBvbiB0aGUgaW5zdGFuY2VNZXRhIG9iamVjdC4KCiAgYHJlbW92ZWRJdGVtYCAtIEEgZnVuY3Rpb24gdGhhdCBpcyBjYWxsZWQgZWFjaCB0aW1lIGFuIGVsZW1lbnQgaXMgcmVtb3ZlZAogIGZyb20gdGhlIGFycmF5LgoKICBgYWRkZWRJdGVtYCAtIEEgZnVuY3Rpb24gdGhhdCBpcyBjYWxsZWQgZWFjaCB0aW1lIGFuIGVsZW1lbnQgaXMgYWRkZWQgdG8KICB0aGUgYXJyYXkuCgoKICBUaGUgYGluaXRpYWxpemVgIGZ1bmN0aW9uIGhhcyB0aGUgZm9sbG93aW5nIHNpZ25hdHVyZToKCiAgYGBgamF2YXNjcmlwdAogICBmdW5jdGlvbiAoaW5pdGlhbFZhbHVlLCBjaGFuZ2VNZXRhLCBpbnN0YW5jZU1ldGEpCiAgYGBgCgogIGBpbml0aWFsVmFsdWVgIC0gVGhlIHZhbHVlIG9mIHRoZSBgaW5pdGlhbFZhbHVlYCBwcm9wZXJ0eSBmcm9tIHRoZQogIG9wdGlvbnMgb2JqZWN0LgoKICBgY2hhbmdlTWV0YWAgLSBBbiBvYmplY3Qgd2hpY2ggY29udGFpbnMgbWV0YSBpbmZvcm1hdGlvbiBhYm91dCB0aGUKICBjb21wdXRlZC4gSXQgY29udGFpbnMgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgoKICAgICAtIGBwcm9wZXJ0eWAgdGhlIGNvbXB1dGVkIHByb3BlcnR5CiAgICAgLSBgcHJvcGVydHlOYW1lYCB0aGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgb24gdGhlIG9iamVjdAoKICBgaW5zdGFuY2VNZXRhYCAtIEFuIG9iamVjdCB0aGF0IGNhbiBiZSB1c2VkIHRvIHN0b3JlIG1ldGEKICBpbmZvcm1hdGlvbiBuZWVkZWQgZm9yIGNhbGN1bGF0aW5nIHlvdXIgY29tcHV0ZWQuIEZvciBleGFtcGxlIGEKICB1bmlxdWUgY29tcHV0ZWQgbWlnaHQgdXNlIHRoaXMgdG8gc3RvcmUgdGhlIG51bWJlciBvZiB0aW1lcyBhIGdpdmVuCiAgZWxlbWVudCBpcyBmb3VuZCBpbiB0aGUgZGVwZW5kZW50IGFycmF5LgoKCiAgVGhlIGByZW1vdmVkSXRlbWAgYW5kIGBhZGRlZEl0ZW1gIGZ1bmN0aW9ucyBib3RoIGhhdmUgdGhlIGZvbGxvd2luZyBzaWduYXR1cmU6CgogIGBgYGphdmFzY3JpcHQKICBmdW5jdGlvbiAoYWNjdW11bGF0ZWRWYWx1ZSwgaXRlbSwgY2hhbmdlTWV0YSwgaW5zdGFuY2VNZXRhKQogIGBgYAoKICBgYWNjdW11bGF0ZWRWYWx1ZWAgLSBUaGUgdmFsdWUgcmV0dXJuZWQgZnJvbSB0aGUgbGFzdCB0aW1lCiAgYHJlbW92ZWRJdGVtYCBvciBgYWRkZWRJdGVtYCB3YXMgY2FsbGVkIG9yIGBpbml0aWFsVmFsdWVgLgoKICBgaXRlbWAgLSB0aGUgZWxlbWVudCBhZGRlZCBvciByZW1vdmVkIGZyb20gdGhlIGFycmF5CgogIGBjaGFuZ2VNZXRhYCAtIEFuIG9iamVjdCB3aGljaCBjb250YWlucyBtZXRhIGluZm9ybWF0aW9uIGFib3V0IHRoZQogIGNoYW5nZS4gSXQgY29udGFpbnMgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgoKICAgIC0gYHByb3BlcnR5YCB0aGUgY29tcHV0ZWQgcHJvcGVydHkKICAgIC0gYHByb3BlcnR5TmFtZWAgdGhlIG5hbWUgb2YgdGhlIHByb3BlcnR5IG9uIHRoZSBvYmplY3QKICAgIC0gYGluZGV4YCB0aGUgaW5kZXggb2YgdGhlIGFkZGVkIG9yIHJlbW92ZWQgaXRlbQogICAgLSBgaXRlbWAgdGhlIGFkZGVkIG9yIHJlbW92ZWQgaXRlbTogdGhpcyBpcyBleGFjdGx5IHRoZSBzYW1lIGFzCiAgICAgIHRoZSBzZWNvbmQgYXJnCiAgICAtIGBhcnJheUNoYW5nZWRgIHRoZSBhcnJheSB0aGF0IHRyaWdnZXJlZCB0aGUgY2hhbmdlLiBDYW4gYmUKICAgICAgdXNlZnVsIHdoZW4gZGVwZW5kaW5nIG9uIG11bHRpcGxlIGFycmF5cy4KCiAgRm9yIHByb3BlcnR5IGNoYW5nZXMgdHJpZ2dlcmVkIG9uIGFuIGl0ZW0gcHJvcGVydHkgY2hhbmdlICh3aGVuCiAgZGVwS2V5IGlzIHNvbWV0aGluZyBsaWtlIGBzb21lQXJyYXkuQGVhY2guc29tZVByb3BlcnR5YCksCiAgYGNoYW5nZU1ldGFgIHdpbGwgYWxzbyBjb250YWluIHRoZSBmb2xsb3dpbmcgcHJvcGVydHk6CgogICAgLSBgcHJldmlvdXNWYWx1ZXNgIGFuIG9iamVjdCB3aG9zZSBrZXlzIGFyZSB0aGUgcHJvcGVydGllcyB0aGF0IGNoYW5nZWQgb24KICAgIHRoZSBpdGVtLCBhbmQgd2hvc2UgdmFsdWVzIGFyZSB0aGUgaXRlbSdzIHByZXZpb3VzIHZhbHVlcy4KCiAgYHByZXZpb3VzVmFsdWVzYCBpcyBpbXBvcnRhbnQgRW1iZXIgY29hbGVzY2VzIGl0ZW0gcHJvcGVydHkgY2hhbmdlcyB2aWEKICBFbWJlci5ydW4ub25jZS4gVGhpcyBtZWFucyB0aGF0IGJ5IHRoZSB0aW1lIHJlbW92ZWRJdGVtIGdldHMgY2FsbGVkLCBpdGVtIGhhcwogIHRoZSBuZXcgdmFsdWVzLCBidXQgeW91IG1heSBuZWVkIHRoZSBwcmV2aW91cyB2YWx1ZSAoZWcgZm9yIHNvcnRpbmcgJgogIGZpbHRlcmluZykuCgogIGBpbnN0YW5jZU1ldGFgIC0gQW4gb2JqZWN0IHRoYXQgY2FuIGJlIHVzZWQgdG8gc3RvcmUgbWV0YQogIGluZm9ybWF0aW9uIG5lZWRlZCBmb3IgY2FsY3VsYXRpbmcgeW91ciBjb21wdXRlZC4gRm9yIGV4YW1wbGUgYQogIHVuaXF1ZSBjb21wdXRlZCBtaWdodCB1c2UgdGhpcyB0byBzdG9yZSB0aGUgbnVtYmVyIG9mIHRpbWVzIGEgZ2l2ZW4KICBlbGVtZW50IGlzIGZvdW5kIGluIHRoZSBkZXBlbmRlbnQgYXJyYXkuCgogIFRoZSBgcmVtb3ZlZEl0ZW1gIGFuZCBgYWRkZWRJdGVtYCBmdW5jdGlvbnMgc2hvdWxkIHJldHVybiB0aGUgYWNjdW11bGF0ZWQKICB2YWx1ZS4gSXQgaXMgYWNjZXB0YWJsZSB0byBub3QgcmV0dXJuIGFueXRoaW5nIChpZSByZXR1cm4gdW5kZWZpbmVkKQogIHRvIGludmFsaWRhdGUgdGhlIGNvbXB1dGF0aW9uLiBUaGlzIGlzIGdlbmVyYWxseSBub3QgYSBnb29kIGlkZWEgZm9yCiAgYXJyYXlDb21wdXRlZCBidXQgaXQncyB1c2VkIGluIGVnIG1heCBhbmQgbWluLgoKICBOb3RlIHRoYXQgb2JzZXJ2ZXJzIHdpbGwgYmUgZmlyZWQgaWYgZWl0aGVyIG9mIHRoZXNlIGZ1bmN0aW9ucyByZXR1cm4gYSB2YWx1ZQogIHRoYXQgZGlmZmVycyBmcm9tIHRoZSBhY2N1bXVsYXRlZCB2YWx1ZS4gIFdoZW4gcmV0dXJuaW5nIGFuIG9iamVjdCB0aGF0CiAgbXV0YXRlcyBpbiByZXNwb25zZSB0byBhcnJheSBjaGFuZ2VzLCBmb3IgZXhhbXBsZSBhbiBhcnJheSB0aGF0IG1hcHMKICBldmVyeXRoaW5nIGZyb20gc29tZSBvdGhlciBhcnJheSAoc2VlIGBFbWJlci5jb21wdXRlZC5tYXBgKSwgaXQgaXMgdXN1YWxseQogIGltcG9ydGFudCB0aGF0IHRoZSAqc2FtZSogYXJyYXkgYmUgcmV0dXJuZWQgdG8gYXZvaWQgYWNjaWRlbnRhbGx5IHRyaWdnZXJpbmcgb2JzZXJ2ZXJzLgoKICBFeGFtcGxlCgogIGBgYGphdmFzY3JpcHQKICBFbWJlci5jb21wdXRlZC5tYXggPSBmdW5jdGlvbiAoZGVwZW5kZW50S2V5KSB7CiAgICByZXR1cm4gRW1iZXIucmVkdWNlQ29tcHV0ZWQuY2FsbChudWxsLCBkZXBlbmRlbnRLZXksIHsKICAgICAgaW5pdGlhbFZhbHVlOiAtSW5maW5pdHksCgogICAgICBhZGRlZEl0ZW06IGZ1bmN0aW9uIChhY2N1bXVsYXRlZFZhbHVlLCBpdGVtLCBjaGFuZ2VNZXRhLCBpbnN0YW5jZU1ldGEpIHsKICAgICAgICByZXR1cm4gTWF0aC5tYXgoYWNjdW11bGF0ZWRWYWx1ZSwgaXRlbSk7CiAgICAgIH0sCgogICAgICByZW1vdmVkSXRlbTogZnVuY3Rpb24gKGFjY3VtdWxhdGVkVmFsdWUsIGl0ZW0sIGNoYW5nZU1ldGEsIGluc3RhbmNlTWV0YSkgewogICAgICAgIGlmIChpdGVtIDwgYWNjdW11bGF0ZWRWYWx1ZSkgewogICAgICAgICAgcmV0dXJuIGFjY3VtdWxhdGVkVmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9OwogIGBgYAoKICBEZXBlbmRlbnQga2V5cyBtYXkgcmVmZXIgdG8gYEB0aGlzYCB0byBvYnNlcnZlIGNoYW5nZXMgdG8gdGhlIG9iamVjdCBpdHNlbGYsCiAgd2hpY2ggbXVzdCBiZSBhcnJheS1saWtlLCByYXRoZXIgdGhhbiBhIHByb3BlcnR5IG9mIHRoZSBvYmplY3QuICBUaGlzIGlzCiAgbW9zdGx5IHVzZWZ1bCBmb3IgYXJyYXkgcHJveGllcywgdG8gZW5zdXJlIG9iamVjdHMgYXJlIHJldHJpZXZlZCB2aWEKICBgb2JqZWN0QXRDb250ZW50YC4gIFRoaXMgaXMgaG93IHlvdSBjb3VsZCBzb3J0IGl0ZW1zIGJ5IHByb3BlcnRpZXMgZGVmaW5lZCBvbiBhbiBpdGVtIGNvbnRyb2xsZXIuCgogIEV4YW1wbGUKCiAgYGBgamF2YXNjcmlwdAogIEFwcC5QZW9wbGVDb250cm9sbGVyID0gRW1iZXIuQXJyYXlDb250cm9sbGVyLmV4dGVuZCh7CiAgICBpdGVtQ29udHJvbGxlcjogJ3BlcnNvbicsCgogICAgc29ydGVkUGVvcGxlOiBFbWJlci5jb21wdXRlZC5zb3J0KCdAdGhpcy5AZWFjaC5yZXZlcnNlZE5hbWUnLCBmdW5jdGlvbihwZXJzb25BLCBwZXJzb25CKSB7CiAgICAgIC8vIGByZXZlcnNlZE5hbWVgIGlzbid0IGRlZmluZWQgb24gUGVyc29uLCBidXQgd2UgaGF2ZSBhY2Nlc3MgdG8gaXQgdmlhCiAgICAgIC8vIHRoZSBpdGVtIGNvbnRyb2xsZXIgQXBwLlBlcnNvbkNvbnRyb2xsZXIuICBJZiB3ZSdkIHVzZWQKICAgICAgLy8gYGNvbnRlbnQuQGVhY2gucmV2ZXJzZWROYW1lYCBhYm92ZSwgd2Ugd291bGQgYmUgZ2V0dGluZyB0aGUgb2JqZWN0cwogICAgICAvLyBkaXJlY3RseSBhbmQgbm90IGhhdmUgYWNjZXNzIHRvIGByZXZlcnNlZE5hbWVgLgogICAgICAvLwogICAgICB2YXIgcmV2ZXJzZWROYW1lQSA9IGdldChwZXJzb25BLCAncmV2ZXJzZWROYW1lJyksCiAgICAgICAgICByZXZlcnNlZE5hbWVCID0gZ2V0KHBlcnNvbkIsICdyZXZlcnNlZE5hbWUnKTsKCiAgICAgIHJldHVybiBFbWJlci5jb21wYXJlKHJldmVyc2VkTmFtZUEsIHJldmVyc2VkTmFtZUIpOwogICAgfSkKICB9KTsKCiAgQXBwLlBlcnNvbkNvbnRyb2xsZXIgPSBFbWJlci5PYmplY3RDb250cm9sbGVyLmV4dGVuZCh7CiAgICByZXZlcnNlZE5hbWU6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHJldmVyc2UoZ2V0KHRoaXMsICduYW1lJykpOwogICAgfS5wcm9wZXJ0eSgnbmFtZScpCiAgfSkKICBgYGAKCiAgRGVwZW5kZW50IGtleXMgd2hvc2UgdmFsdWVzIGFyZSBub3QgYXJyYXlzIGFyZSB0cmVhdGVkIGFzIHJlZ3VsYXIKICBkZXBlbmRlbmNpZXM6IHdoZW4gdGhleSBjaGFuZ2UsIHRoZSBjb21wdXRlZCBwcm9wZXJ0eSBpcyBjb21wbGV0ZWx5CiAgcmVjYWxjdWxhdGVkLiAgSXQgaXMgc29tZXRpbWVzIHVzZWZ1bCB0byBoYXZlIGRlcGVuZGVudCBhcnJheXMgd2l0aCBzaW1pbGFyCiAgc2VtYW50aWNzLiAgRGVwZW5kZW50IGtleXMgd2hpY2ggZW5kIGluIGAuW11gIGRvIG5vdCB1c2UgIm9uZSBhdCBhIHRpbWUiCiAgc2VtYW50aWNzLiAgV2hlbiBhbiBpdGVtIGlzIGFkZGVkIG9yIHJlbW92ZWQgZnJvbSBzdWNoIGEgZGVwZW5kZW5jeSwgdGhlCiAgY29tcHV0ZWQgcHJvcGVydHkgaXMgY29tcGxldGVseSByZWNvbXB1dGVkLgoKICBFeGFtcGxlCgogIGBgYGphdmFzY3JpcHQKICBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICAgIC8vIFdoZW4gYHN0cmluZ2AgaXMgY2hhbmdlZCwgYGNvbXB1dGVkYCBpcyBjb21wbGV0ZWx5IHJlY29tcHV0ZWQuCiAgICBzdHJpbmc6ICdhIHN0cmluZycsCgogICAgLy8gV2hlbiBhbiBpdGVtIGlzIGFkZGVkIHRvIGBhcnJheWAsIGBhZGRlZEl0ZW1gIGlzIGNhbGxlZC4KICAgIGFycmF5OiBbXSwKCiAgICAvLyBXaGVuIGFuIGl0ZW0gaXMgYWRkZWQgdG8gYGFub3RoZXJBcnJheWAsIGBjb21wdXRlZGAgaXMgY29tcGxldGVseQogICAgLy8gcmVjb21wdXRlZC4KICAgIGFub3RoZXJBcnJheTogW10sCgogICAgY29tcHV0ZWQ6IEVtYmVyLnJlZHVjZUNvbXB1dGVkKCdzdHJpbmcnLCAnYXJyYXknLCAnYW5vdGhlckFycmF5LltdJywgewogICAgICBhZGRlZEl0ZW06IGFkZGVkSXRlbUNhbGxiYWNrLAogICAgICByZW1vdmVkSXRlbTogcmVtb3ZlZEl0ZW1DYWxsYmFjawogICAgfSkKICB9KTsKICBgYGAKCiAgQG1ldGhvZCByZWR1Y2VDb21wdXRlZAogIEBmb3IgRW1iZXIKICBAcGFyYW0ge1N0cmluZ30gW2RlcGVuZGVudEtleXMqXQogIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgQHJldHVybiB7RW1iZXIuQ29tcHV0ZWRQcm9wZXJ0eX0KKi8KRW1iZXIucmVkdWNlQ29tcHV0ZWQgPSBmdW5jdGlvbiAob3B0aW9ucykgewogIHZhciBhcmdzOwoKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDEpIHsKICAgIGFyZ3MgPSBhX3NsaWNlLmNhbGwoYXJndW1lbnRzLCAwLCAtMSk7CiAgICBvcHRpb25zID0gYV9zbGljZS5jYWxsKGFyZ3VtZW50cywgLTEpWzBdOwogIH0KCiAgaWYgKHR5cGVvZiBvcHRpb25zICE9PSAib2JqZWN0IikgewogICAgdGhyb3cgbmV3IEVtYmVyLkVycm9yKCJSZWR1Y2UgQ29tcHV0ZWQgUHJvcGVydHkgZGVjbGFyZWQgd2l0aG91dCBhbiBvcHRpb25zIGhhc2giKTsKICB9CgogIGlmICghKCdpbml0aWFsVmFsdWUnIGluIG9wdGlvbnMpKSB7CiAgICB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoIlJlZHVjZSBDb21wdXRlZCBQcm9wZXJ0eSBkZWNsYXJlZCB3aXRob3V0IGFuIGluaXRpYWwgdmFsdWUiKTsKICB9CgogIHZhciBjcCA9IG5ldyBSZWR1Y2VDb21wdXRlZFByb3BlcnR5KG9wdGlvbnMpOwoKICBpZiAoYXJncykgewogICAgY3AucHJvcGVydHkuYXBwbHkoY3AsIGFyZ3MpOwogIH0KCiAgcmV0dXJuIGNwOwp9OwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewp2YXIgUmVkdWNlQ29tcHV0ZWRQcm9wZXJ0eSA9IEVtYmVyLlJlZHVjZUNvbXB1dGVkUHJvcGVydHksCiAgICBhX3NsaWNlID0gW10uc2xpY2UsCiAgICBvX2NyZWF0ZSA9IEVtYmVyLmNyZWF0ZSwKICAgIGZvckVhY2ggPSBFbWJlci5FbnVtZXJhYmxlVXRpbHMuZm9yRWFjaDsKCmZ1bmN0aW9uIEFycmF5Q29tcHV0ZWRQcm9wZXJ0eSgpIHsKICB2YXIgY3AgPSB0aGlzOwoKICBSZWR1Y2VDb21wdXRlZFByb3BlcnR5LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogIHRoaXMuZnVuYyA9IChmdW5jdGlvbihyZWR1Y2VGdW5jKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKHByb3BlcnR5TmFtZSkgewogICAgICBpZiAoIWNwLl9oYXNJbnN0YW5jZU1ldGEodGhpcywgcHJvcGVydHlOYW1lKSkgewogICAgICAgIC8vIFdoZW4gd2UgcmVjb21wdXRlIGFuIGFycmF5IGNvbXB1dGVkIHByb3BlcnR5LCB3ZSBuZWVkIGFscmVhZHkKICAgICAgICAvLyByZXRyaWV2ZWQgYXJyYXlzIHRvIGJlIHVwZGF0ZWQ7IHdlIGNhbid0IHNpbXBseSBlbXB0eSB0aGUgY2FjaGUgYW5kCiAgICAgICAgLy8gaG9wZSB0aGUgYXJyYXkgaXMgcmUtcmV0cmlldmVkLgogICAgICAgIGZvckVhY2goY3AuX2RlcGVuZGVudEtleXMsIGZ1bmN0aW9uKGRlcGVuZGVudEtleSkgewogICAgICAgICAgRW1iZXIuYWRkT2JzZXJ2ZXIodGhpcywgZGVwZW5kZW50S2V5LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgY3AucmVjb21wdXRlT25jZS5jYWxsKHRoaXMsIHByb3BlcnR5TmFtZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9LCB0aGlzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHJlZHVjZUZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH07CiAgfSkodGhpcy5mdW5jKTsKCiAgcmV0dXJuIHRoaXM7Cn0KRW1iZXIuQXJyYXlDb21wdXRlZFByb3BlcnR5ID0gQXJyYXlDb21wdXRlZFByb3BlcnR5OwpBcnJheUNvbXB1dGVkUHJvcGVydHkucHJvdG90eXBlID0gb19jcmVhdGUoUmVkdWNlQ29tcHV0ZWRQcm9wZXJ0eS5wcm90b3R5cGUpOwpBcnJheUNvbXB1dGVkUHJvcGVydHkucHJvdG90eXBlLmluaXRpYWxWYWx1ZSA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gRW1iZXIuQSgpOwp9OwpBcnJheUNvbXB1dGVkUHJvcGVydHkucHJvdG90eXBlLnJlc2V0VmFsdWUgPSBmdW5jdGlvbiAoYXJyYXkpIHsKICBhcnJheS5jbGVhcigpOwogIHJldHVybiBhcnJheTsKfTsKCi8vIFRoaXMgaXMgYSBzdG9wZ2FwIHRvIGtlZXAgdGhlIHJlZmVyZW5jZSBjb3VudHMgY29ycmVjdCB3aXRoIGxhenkgQ1BzLgpBcnJheUNvbXB1dGVkUHJvcGVydHkucHJvdG90eXBlLmRpZENoYW5nZSA9IGZ1bmN0aW9uIChvYmosIGtleU5hbWUpIHsKICByZXR1cm47Cn07CgovKioKICBDcmVhdGVzIGEgY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggb3BlcmF0ZXMgb24gZGVwZW5kZW50IGFycmF5cyBhbmQKICBpcyB1cGRhdGVkIHdpdGggIm9uZSBhdCBhIHRpbWUiIHNlbWFudGljcy4gV2hlbiBpdGVtcyBhcmUgYWRkZWQgb3IKICByZW1vdmVkIGZyb20gdGhlIGRlcGVuZGVudCBhcnJheShzKSBhbiBhcnJheSBjb21wdXRlZCBvbmx5IG9wZXJhdGVzCiAgb24gdGhlIGNoYW5nZSBpbnN0ZWFkIG9mIHJlLWV2YWx1YXRpbmcgdGhlIGVudGlyZSBhcnJheS4gVGhpcyBzaG91bGQKICByZXR1cm4gYW4gYXJyYXksIGlmIHlvdSdkIGxpa2UgdG8gdXNlICJvbmUgYXQgYSB0aW1lIiBzZW1hbnRpY3MgYW5kCiAgY29tcHV0ZSBzb21lIHZhbHVlIG90aGVyIHRoZW4gYW4gYXJyYXkgbG9vayBhdAogIGBFbWJlci5yZWR1Y2VDb21wdXRlZGAuCgogIElmIHRoZXJlIGFyZSBtb3JlIHRoYW4gb25lIGFyZ3VtZW50cyB0aGUgZmlyc3QgYXJndW1lbnRzIGFyZQogIGNvbnNpZGVyZWQgdG8gYmUgZGVwZW5kZW50IHByb3BlcnR5IGtleXMuIFRoZSBsYXN0IGFyZ3VtZW50IGlzCiAgcmVxdWlyZWQgdG8gYmUgYW4gb3B0aW9ucyBvYmplY3QuIFRoZSBvcHRpb25zIG9iamVjdCBjYW4gaGF2ZSB0aGUKICBmb2xsb3dpbmcgdGhyZWUgcHJvcGVydGllcy4KCiAgYGluaXRpYWxpemVgIC0gQW4gb3B0aW9uYWwgaW5pdGlhbGl6ZSBmdW5jdGlvbi4gVHlwaWNhbGx5IHRoaXMgd2lsbCBiZSB1c2VkCiAgdG8gc2V0IHVwIHN0YXRlIG9uIHRoZSBpbnN0YW5jZU1ldGEgb2JqZWN0LgoKICBgcmVtb3ZlZEl0ZW1gIC0gQSBmdW5jdGlvbiB0aGF0IGlzIGNhbGxlZCBlYWNoIHRpbWUgYW4gZWxlbWVudCBpcwogIHJlbW92ZWQgZnJvbSB0aGUgYXJyYXkuCgogIGBhZGRlZEl0ZW1gIC0gQSBmdW5jdGlvbiB0aGF0IGlzIGNhbGxlZCBlYWNoIHRpbWUgYW4gZWxlbWVudCBpcwogIGFkZGVkIHRvIHRoZSBhcnJheS4KCgogIFRoZSBgaW5pdGlhbGl6ZWAgZnVuY3Rpb24gaGFzIHRoZSBmb2xsb3dpbmcgc2lnbmF0dXJlOgoKICBgYGBqYXZhc2NyaXB0CiAgIGZ1bmN0aW9uIChhcnJheSwgY2hhbmdlTWV0YSwgaW5zdGFuY2VNZXRhKQogIGBgYAoKICBgYXJyYXlgIC0gVGhlIGluaXRpYWwgdmFsdWUgb2YgdGhlIGFycmF5Q29tcHV0ZWQsIGFuIGVtcHR5IGFycmF5LgoKICBgY2hhbmdlTWV0YWAgLSBBbiBvYmplY3Qgd2hpY2ggY29udGFpbnMgbWV0YSBpbmZvcm1hdGlvbiBhYm91dCB0aGUKICBjb21wdXRlZC4gSXQgY29udGFpbnMgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgoKICAgICAtIGBwcm9wZXJ0eWAgdGhlIGNvbXB1dGVkIHByb3BlcnR5CiAgICAgLSBgcHJvcGVydHlOYW1lYCB0aGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgb24gdGhlIG9iamVjdAoKICBgaW5zdGFuY2VNZXRhYCAtIEFuIG9iamVjdCB0aGF0IGNhbiBiZSB1c2VkIHRvIHN0b3JlIG1ldGEKICBpbmZvcm1hdGlvbiBuZWVkZWQgZm9yIGNhbGN1bGF0aW5nIHlvdXIgY29tcHV0ZWQuIEZvciBleGFtcGxlIGEKICB1bmlxdWUgY29tcHV0ZWQgbWlnaHQgdXNlIHRoaXMgdG8gc3RvcmUgdGhlIG51bWJlciBvZiB0aW1lcyBhIGdpdmVuCiAgZWxlbWVudCBpcyBmb3VuZCBpbiB0aGUgZGVwZW5kZW50IGFycmF5LgoKCiAgVGhlIGByZW1vdmVkSXRlbWAgYW5kIGBhZGRlZEl0ZW1gIGZ1bmN0aW9ucyBib3RoIGhhdmUgdGhlIGZvbGxvd2luZyBzaWduYXR1cmU6CgogIGBgYGphdmFzY3JpcHQKICBmdW5jdGlvbiAoYWNjdW11bGF0ZWRWYWx1ZSwgaXRlbSwgY2hhbmdlTWV0YSwgaW5zdGFuY2VNZXRhKQogIGBgYAoKICBgYWNjdW11bGF0ZWRWYWx1ZWAgLSBUaGUgdmFsdWUgcmV0dXJuZWQgZnJvbSB0aGUgbGFzdCB0aW1lCiAgYHJlbW92ZWRJdGVtYCBvciBgYWRkZWRJdGVtYCB3YXMgY2FsbGVkIG9yIGFuIGVtcHR5IGFycmF5LgoKICBgaXRlbWAgLSB0aGUgZWxlbWVudCBhZGRlZCBvciByZW1vdmVkIGZyb20gdGhlIGFycmF5CgogIGBjaGFuZ2VNZXRhYCAtIEFuIG9iamVjdCB3aGljaCBjb250YWlucyBtZXRhIGluZm9ybWF0aW9uIGFib3V0IHRoZQogIGNoYW5nZS4gSXQgY29udGFpbnMgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgoKICAgIC0gYHByb3BlcnR5YCB0aGUgY29tcHV0ZWQgcHJvcGVydHkKICAgIC0gYHByb3BlcnR5TmFtZWAgdGhlIG5hbWUgb2YgdGhlIHByb3BlcnR5IG9uIHRoZSBvYmplY3QKICAgIC0gYGluZGV4YCB0aGUgaW5kZXggb2YgdGhlIGFkZGVkIG9yIHJlbW92ZWQgaXRlbQogICAgLSBgaXRlbWAgdGhlIGFkZGVkIG9yIHJlbW92ZWQgaXRlbTogdGhpcyBpcyBleGFjdGx5IHRoZSBzYW1lIGFzCiAgICAgIHRoZSBzZWNvbmQgYXJnCiAgICAtIGBhcnJheUNoYW5nZWRgIHRoZSBhcnJheSB0aGF0IHRyaWdnZXJlZCB0aGUgY2hhbmdlLiBDYW4gYmUKICAgICAgdXNlZnVsIHdoZW4gZGVwZW5kaW5nIG9uIG11bHRpcGxlIGFycmF5cy4KCiAgRm9yIHByb3BlcnR5IGNoYW5nZXMgdHJpZ2dlcmVkIG9uIGFuIGl0ZW0gcHJvcGVydHkgY2hhbmdlICh3aGVuCiAgZGVwS2V5IGlzIHNvbWV0aGluZyBsaWtlIGBzb21lQXJyYXkuQGVhY2guc29tZVByb3BlcnR5YCksCiAgYGNoYW5nZU1ldGFgIHdpbGwgYWxzbyBjb250YWluIHRoZSBmb2xsb3dpbmcgcHJvcGVydHk6CgogICAgLSBgcHJldmlvdXNWYWx1ZXNgIGFuIG9iamVjdCB3aG9zZSBrZXlzIGFyZSB0aGUgcHJvcGVydGllcyB0aGF0IGNoYW5nZWQgb24KICAgIHRoZSBpdGVtLCBhbmQgd2hvc2UgdmFsdWVzIGFyZSB0aGUgaXRlbSdzIHByZXZpb3VzIHZhbHVlcy4KCiAgYHByZXZpb3VzVmFsdWVzYCBpcyBpbXBvcnRhbnQgRW1iZXIgY29hbGVzY2VzIGl0ZW0gcHJvcGVydHkgY2hhbmdlcyB2aWEKICBFbWJlci5ydW4ub25jZS4gVGhpcyBtZWFucyB0aGF0IGJ5IHRoZSB0aW1lIHJlbW92ZWRJdGVtIGdldHMgY2FsbGVkLCBpdGVtIGhhcwogIHRoZSBuZXcgdmFsdWVzLCBidXQgeW91IG1heSBuZWVkIHRoZSBwcmV2aW91cyB2YWx1ZSAoZWcgZm9yIHNvcnRpbmcgJgogIGZpbHRlcmluZykuCgogIGBpbnN0YW5jZU1ldGFgIC0gQW4gb2JqZWN0IHRoYXQgY2FuIGJlIHVzZWQgdG8gc3RvcmUgbWV0YQogIGluZm9ybWF0aW9uIG5lZWRlZCBmb3IgY2FsY3VsYXRpbmcgeW91ciBjb21wdXRlZC4gRm9yIGV4YW1wbGUgYQogIHVuaXF1ZSBjb21wdXRlZCBtaWdodCB1c2UgdGhpcyB0byBzdG9yZSB0aGUgbnVtYmVyIG9mIHRpbWVzIGEgZ2l2ZW4KICBlbGVtZW50IGlzIGZvdW5kIGluIHRoZSBkZXBlbmRlbnQgYXJyYXkuCgogIFRoZSBgcmVtb3ZlZEl0ZW1gIGFuZCBgYWRkZWRJdGVtYCBmdW5jdGlvbnMgc2hvdWxkIHJldHVybiB0aGUgYWNjdW11bGF0ZWQKICB2YWx1ZS4gSXQgaXMgYWNjZXB0YWJsZSB0byBub3QgcmV0dXJuIGFueXRoaW5nIChpZSByZXR1cm4gdW5kZWZpbmVkKQogIHRvIGludmFsaWRhdGUgdGhlIGNvbXB1dGF0aW9uLiBUaGlzIGlzIGdlbmVyYWxseSBub3QgYSBnb29kIGlkZWEgZm9yCiAgYXJyYXlDb21wdXRlZCBidXQgaXQncyB1c2VkIGluIGVnIG1heCBhbmQgbWluLgoKICBFeGFtcGxlCgogIGBgYGphdmFzY3JpcHQKICBFbWJlci5jb21wdXRlZC5tYXAgPSBmdW5jdGlvbihkZXBlbmRlbnRLZXksIGNhbGxiYWNrKSB7CiAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAgYWRkZWRJdGVtOiBmdW5jdGlvbihhcnJheSwgaXRlbSwgY2hhbmdlTWV0YSwgaW5zdGFuY2VNZXRhKSB7CiAgICAgICAgdmFyIG1hcHBlZCA9IGNhbGxiYWNrKGl0ZW0pOwogICAgICAgIGFycmF5Lmluc2VydEF0KGNoYW5nZU1ldGEuaW5kZXgsIG1hcHBlZCk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9LAogICAgICByZW1vdmVkSXRlbTogZnVuY3Rpb24oYXJyYXksIGl0ZW0sIGNoYW5nZU1ldGEsIGluc3RhbmNlTWV0YSkgewogICAgICAgIGFycmF5LnJlbW92ZUF0KGNoYW5nZU1ldGEuaW5kZXgsIDEpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gRW1iZXIuYXJyYXlDb21wdXRlZChkZXBlbmRlbnRLZXksIG9wdGlvbnMpOwogIH07CiAgYGBgCgogIEBtZXRob2QgYXJyYXlDb21wdXRlZAogIEBmb3IgRW1iZXIKICBAcGFyYW0ge1N0cmluZ30gW2RlcGVuZGVudEtleXMqXQogIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgQHJldHVybiB7RW1iZXIuQ29tcHV0ZWRQcm9wZXJ0eX0KKi8KRW1iZXIuYXJyYXlDb21wdXRlZCA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgdmFyIGFyZ3M7CgogIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewogICAgYXJncyA9IGFfc2xpY2UuY2FsbChhcmd1bWVudHMsIDAsIC0xKTsKICAgIG9wdGlvbnMgPSBhX3NsaWNlLmNhbGwoYXJndW1lbnRzLCAtMSlbMF07CiAgfQoKICBpZiAodHlwZW9mIG9wdGlvbnMgIT09ICJvYmplY3QiKSB7CiAgICB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoIkFycmF5IENvbXB1dGVkIFByb3BlcnR5IGRlY2xhcmVkIHdpdGhvdXQgYW4gb3B0aW9ucyBoYXNoIik7CiAgfQoKICB2YXIgY3AgPSBuZXcgQXJyYXlDb21wdXRlZFByb3BlcnR5KG9wdGlvbnMpOwoKICBpZiAoYXJncykgewogICAgY3AucHJvcGVydHkuYXBwbHkoY3AsIGFyZ3MpOwogIH0KCiAgcmV0dXJuIGNwOwp9OwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLXJ1bnRpbWUKKi8KCnZhciBnZXQgPSBFbWJlci5nZXQsCiAgICBzZXQgPSBFbWJlci5zZXQsCiAgICBndWlkRm9yID0gRW1iZXIuZ3VpZEZvciwKICAgIG1lcmdlID0gRW1iZXIubWVyZ2UsCiAgICBhX3NsaWNlID0gW10uc2xpY2UsCiAgICBmb3JFYWNoID0gRW1iZXIuRW51bWVyYWJsZVV0aWxzLmZvckVhY2gsCiAgICBtYXAgPSBFbWJlci5FbnVtZXJhYmxlVXRpbHMubWFwLAogICAgU2VhcmNoUHJveHk7CgovKioKICBBIGNvbXB1dGVkIHByb3BlcnR5IHRoYXQgY2FsY3VsYXRlcyB0aGUgbWF4aW11bSB2YWx1ZSBpbiB0aGUKICBkZXBlbmRlbnQgYXJyYXkuIFRoaXMgd2lsbCByZXR1cm4gYC1JbmZpbml0eWAgd2hlbiB0aGUgZGVwZW5kZW50CiAgYXJyYXkgaXMgZW1wdHkuCgogIGBgYGphdmFzY3JpcHQKICBBcHAuUGVyc29uID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CiAgICBjaGlsZEFnZXM6IEVtYmVyLmNvbXB1dGVkLm1hcEJ5KCdjaGlsZHJlbicsICdhZ2UnKSwKICAgIG1heENoaWxkQWdlOiBFbWJlci5jb21wdXRlZC5tYXgoJ2NoaWxkQWdlcycpCiAgfSk7CgogIHZhciBsb3JkQnlyb24gPSBBcHAuUGVyc29uLmNyZWF0ZSh7Y2hpbGRyZW46IFtdfSk7CiAgbG9yZEJ5cm9uLmdldCgnbWF4Q2hpbGRBZ2UnKTsgLy8gLUluZmluaXR5CiAgbG9yZEJ5cm9uLmdldCgnY2hpbGRyZW4nKS5wdXNoT2JqZWN0KHsKICAgIG5hbWU6ICdBdWd1c3RhIEFkYSBCeXJvbicsIGFnZTogNwogIH0pOwogIGxvcmRCeXJvbi5nZXQoJ21heENoaWxkQWdlJyk7IC8vIDcKICBsb3JkQnlyb24uZ2V0KCdjaGlsZHJlbicpLnB1c2hPYmplY3RzKFt7CiAgICBuYW1lOiAnQWxsZWdyYSBCeXJvbicsCiAgICBhZ2U6IDUKICB9LCB7CiAgICBuYW1lOiAnRWxpemFiZXRoIE1lZG9yYSBMZWlnaCcsCiAgICBhZ2U6IDgKICB9XSk7CiAgbG9yZEJ5cm9uLmdldCgnbWF4Q2hpbGRBZ2UnKTsgLy8gOAogIGBgYAoKICBAbWV0aG9kIGNvbXB1dGVkLm1heAogIEBmb3IgRW1iZXIKICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5CiAgQHJldHVybiB7RW1iZXIuQ29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZXMgdGhlIGxhcmdlc3QgdmFsdWUgaW4gdGhlIGRlcGVuZGVudEtleSdzIGFycmF5CiovCkVtYmVyLmNvbXB1dGVkLm1heCA9IGZ1bmN0aW9uIChkZXBlbmRlbnRLZXkpIHsKICByZXR1cm4gRW1iZXIucmVkdWNlQ29tcHV0ZWQuY2FsbChudWxsLCBkZXBlbmRlbnRLZXksIHsKICAgIGluaXRpYWxWYWx1ZTogLUluZmluaXR5LAoKICAgIGFkZGVkSXRlbTogZnVuY3Rpb24gKGFjY3VtdWxhdGVkVmFsdWUsIGl0ZW0sIGNoYW5nZU1ldGEsIGluc3RhbmNlTWV0YSkgewogICAgICByZXR1cm4gTWF0aC5tYXgoYWNjdW11bGF0ZWRWYWx1ZSwgaXRlbSk7CiAgICB9LAoKICAgIHJlbW92ZWRJdGVtOiBmdW5jdGlvbiAoYWNjdW11bGF0ZWRWYWx1ZSwgaXRlbSwgY2hhbmdlTWV0YSwgaW5zdGFuY2VNZXRhKSB7CiAgICAgIGlmIChpdGVtIDwgYWNjdW11bGF0ZWRWYWx1ZSkgewogICAgICAgIHJldHVybiBhY2N1bXVsYXRlZFZhbHVlOwogICAgICB9CiAgICB9CiAgfSk7Cn07CgovKioKICBBIGNvbXB1dGVkIHByb3BlcnR5IHRoYXQgY2FsY3VsYXRlcyB0aGUgbWluaW11bSB2YWx1ZSBpbiB0aGUKICBkZXBlbmRlbnQgYXJyYXkuIFRoaXMgd2lsbCByZXR1cm4gYEluZmluaXR5YCB3aGVuIHRoZSBkZXBlbmRlbnQKICBhcnJheSBpcyBlbXB0eS4KCiAgYGBgamF2YXNjcmlwdAogIEFwcC5QZXJzb24gPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICAgIGNoaWxkQWdlczogRW1iZXIuY29tcHV0ZWQubWFwQnkoJ2NoaWxkcmVuJywgJ2FnZScpLAogICAgbWluQ2hpbGRBZ2U6IEVtYmVyLmNvbXB1dGVkLm1pbignY2hpbGRBZ2VzJykKICB9KTsKCiAgdmFyIGxvcmRCeXJvbiA9IEFwcC5QZXJzb24uY3JlYXRlKHtjaGlsZHJlbjogW119KTsKICBsb3JkQnlyb24uZ2V0KCdtaW5DaGlsZEFnZScpOyAvLyBJbmZpbml0eQogIGxvcmRCeXJvbi5nZXQoJ2NoaWxkcmVuJykucHVzaE9iamVjdCh7CiAgICBuYW1lOiAnQXVndXN0YSBBZGEgQnlyb24nLCBhZ2U6IDcKICB9KTsKICBsb3JkQnlyb24uZ2V0KCdtaW5DaGlsZEFnZScpOyAvLyA3CiAgbG9yZEJ5cm9uLmdldCgnY2hpbGRyZW4nKS5wdXNoT2JqZWN0cyhbewogICAgbmFtZTogJ0FsbGVncmEgQnlyb24nLAogICAgYWdlOiA1CiAgfSwgewogICAgbmFtZTogJ0VsaXphYmV0aCBNZWRvcmEgTGVpZ2gnLAogICAgYWdlOiA4CiAgfV0pOwogIGxvcmRCeXJvbi5nZXQoJ21pbkNoaWxkQWdlJyk7IC8vIDUKICBgYGAKCiAgQG1ldGhvZCBjb21wdXRlZC5taW4KICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogIEByZXR1cm4ge0VtYmVyLkNvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVzIHRoZSBzbWFsbGVzdCB2YWx1ZSBpbiB0aGUgZGVwZW5kZW50S2V5J3MgYXJyYXkKKi8KRW1iZXIuY29tcHV0ZWQubWluID0gZnVuY3Rpb24gKGRlcGVuZGVudEtleSkgewogIHJldHVybiBFbWJlci5yZWR1Y2VDb21wdXRlZC5jYWxsKG51bGwsIGRlcGVuZGVudEtleSwgewogICAgaW5pdGlhbFZhbHVlOiBJbmZpbml0eSwKCiAgICBhZGRlZEl0ZW06IGZ1bmN0aW9uIChhY2N1bXVsYXRlZFZhbHVlLCBpdGVtLCBjaGFuZ2VNZXRhLCBpbnN0YW5jZU1ldGEpIHsKICAgICAgcmV0dXJuIE1hdGgubWluKGFjY3VtdWxhdGVkVmFsdWUsIGl0ZW0pOwogICAgfSwKCiAgICByZW1vdmVkSXRlbTogZnVuY3Rpb24gKGFjY3VtdWxhdGVkVmFsdWUsIGl0ZW0sIGNoYW5nZU1ldGEsIGluc3RhbmNlTWV0YSkgewogICAgICBpZiAoaXRlbSA+IGFjY3VtdWxhdGVkVmFsdWUpIHsKICAgICAgICByZXR1cm4gYWNjdW11bGF0ZWRWYWx1ZTsKICAgICAgfQogICAgfQogIH0pOwp9OwoKLyoqCiAgUmV0dXJucyBhbiBhcnJheSBtYXBwZWQgdmlhIHRoZSBjYWxsYmFjawoKICBUaGUgY2FsbGJhY2sgbWV0aG9kIHlvdSBwcm92aWRlIHNob3VsZCBoYXZlIHRoZSBmb2xsb3dpbmcgc2lnbmF0dXJlLgogIGBpdGVtYCBpcyB0aGUgY3VycmVudCBpdGVtIGluIHRoZSBpdGVyYXRpb24uCgogIGBgYGphdmFzY3JpcHQKICBmdW5jdGlvbihpdGVtKTsKICBgYGAKCiAgRXhhbXBsZQoKICBgYGBqYXZhc2NyaXB0CiAgQXBwLkhhbXN0ZXIgPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICAgIGV4Y2l0aW5nQ2hvcmVzOiBFbWJlci5jb21wdXRlZC5tYXAoJ2Nob3JlcycsIGZ1bmN0aW9uKGNob3JlKSB7CiAgICAgIHJldHVybiBjaG9yZS50b1VwcGVyQ2FzZSgpICsgJyEnOwogICAgfSkKICB9KTsKCiAgdmFyIGhhbXN0ZXIgPSBBcHAuSGFtc3Rlci5jcmVhdGUoewogICAgY2hvcmVzOiBbJ2NsZWFuJywgJ3dyaXRlIG1vcmUgdW5pdCB0ZXN0cyddCiAgfSk7CiAgaGFtc3Rlci5nZXQoJ2V4Y2l0aW5nQ2hvcmVzJyk7IC8vIFsnQ0xFQU4hJywgJ1dSSVRFIE1PUkUgVU5JVCBURVNUUyEnXQogIGBgYAoKICBAbWV0aG9kIGNvbXB1dGVkLm1hcAogIEBmb3IgRW1iZXIKICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5CiAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sKICBAcmV0dXJuIHtFbWJlci5Db21wdXRlZFByb3BlcnR5fSBhbiBhcnJheSBtYXBwZWQgdmlhIHRoZSBjYWxsYmFjawoqLwpFbWJlci5jb21wdXRlZC5tYXAgPSBmdW5jdGlvbihkZXBlbmRlbnRLZXksIGNhbGxiYWNrKSB7CiAgdmFyIG9wdGlvbnMgPSB7CiAgICBhZGRlZEl0ZW06IGZ1bmN0aW9uKGFycmF5LCBpdGVtLCBjaGFuZ2VNZXRhLCBpbnN0YW5jZU1ldGEpIHsKICAgICAgdmFyIG1hcHBlZCA9IGNhbGxiYWNrLmNhbGwodGhpcywgaXRlbSk7CiAgICAgIGFycmF5Lmluc2VydEF0KGNoYW5nZU1ldGEuaW5kZXgsIG1hcHBlZCk7CiAgICAgIHJldHVybiBhcnJheTsKICAgIH0sCiAgICByZW1vdmVkSXRlbTogZnVuY3Rpb24oYXJyYXksIGl0ZW0sIGNoYW5nZU1ldGEsIGluc3RhbmNlTWV0YSkgewogICAgICBhcnJheS5yZW1vdmVBdChjaGFuZ2VNZXRhLmluZGV4LCAxKTsKICAgICAgcmV0dXJuIGFycmF5OwogICAgfQogIH07CgogIHJldHVybiBFbWJlci5hcnJheUNvbXB1dGVkKGRlcGVuZGVudEtleSwgb3B0aW9ucyk7Cn07CgovKioKICBSZXR1cm5zIGFuIGFycmF5IG1hcHBlZCB0byB0aGUgc3BlY2lmaWVkIGtleS4KCiAgYGBgamF2YXNjcmlwdAogIEFwcC5QZXJzb24gPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICAgIGNoaWxkQWdlczogRW1iZXIuY29tcHV0ZWQubWFwQnkoJ2NoaWxkcmVuJywgJ2FnZScpCiAgfSk7CgogIHZhciBsb3JkQnlyb24gPSBBcHAuUGVyc29uLmNyZWF0ZSh7Y2hpbGRyZW46IFtdfSk7CiAgbG9yZEJ5cm9uLmdldCgnY2hpbGRBZ2VzJyk7IC8vIFtdCiAgbG9yZEJ5cm9uLmdldCgnY2hpbGRyZW4nKS5wdXNoT2JqZWN0KHtuYW1lOiAnQXVndXN0YSBBZGEgQnlyb24nLCBhZ2U6IDd9KTsKICBsb3JkQnlyb24uZ2V0KCdjaGlsZEFnZXMnKTsgLy8gWzddCiAgbG9yZEJ5cm9uLmdldCgnY2hpbGRyZW4nKS5wdXNoT2JqZWN0cyhbewogICAgbmFtZTogJ0FsbGVncmEgQnlyb24nLAogICAgYWdlOiA1CiAgfSwgewogICAgbmFtZTogJ0VsaXphYmV0aCBNZWRvcmEgTGVpZ2gnLAogICAgYWdlOiA4CiAgfV0pOwogIGxvcmRCeXJvbi5nZXQoJ2NoaWxkQWdlcycpOyAvLyBbNywgNSwgOF0KICBgYGAKCiAgQG1ldGhvZCBjb21wdXRlZC5tYXBCeQogIEBmb3IgRW1iZXIKICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5CiAgQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5S2V5CiAgQHJldHVybiB7RW1iZXIuQ29tcHV0ZWRQcm9wZXJ0eX0gYW4gYXJyYXkgbWFwcGVkIHRvIHRoZSBzcGVjaWZpZWQga2V5CiovCkVtYmVyLmNvbXB1dGVkLm1hcEJ5ID0gZnVuY3Rpb24oZGVwZW5kZW50S2V5LCBwcm9wZXJ0eUtleSkgewogIHZhciBjYWxsYmFjayA9IGZ1bmN0aW9uKGl0ZW0pIHsgcmV0dXJuIGdldChpdGVtLCBwcm9wZXJ0eUtleSk7IH07CiAgcmV0dXJuIEVtYmVyLmNvbXB1dGVkLm1hcChkZXBlbmRlbnRLZXkgKyAnLkBlYWNoLicgKyBwcm9wZXJ0eUtleSwgY2FsbGJhY2spOwp9OwoKLyoqCiAgQG1ldGhvZCBjb21wdXRlZC5tYXBQcm9wZXJ0eQogIEBmb3IgRW1iZXIKICBAZGVwcmVjYXRlZCBVc2UgYEVtYmVyLmNvbXB1dGVkLm1hcEJ5YCBpbnN0ZWFkCiAgQHBhcmFtIGRlcGVuZGVudEtleQogIEBwYXJhbSBwcm9wZXJ0eUtleQoqLwpFbWJlci5jb21wdXRlZC5tYXBQcm9wZXJ0eSA9IEVtYmVyLmNvbXB1dGVkLm1hcEJ5OwoKLyoqCiAgRmlsdGVycyB0aGUgYXJyYXkgYnkgdGhlIGNhbGxiYWNrLgoKICBUaGUgY2FsbGJhY2sgbWV0aG9kIHlvdSBwcm92aWRlIHNob3VsZCBoYXZlIHRoZSBmb2xsb3dpbmcgc2lnbmF0dXJlLgogIGBpdGVtYCBpcyB0aGUgY3VycmVudCBpdGVtIGluIHRoZSBpdGVyYXRpb24uCgogIGBgYGphdmFzY3JpcHQKICBmdW5jdGlvbihpdGVtKTsKICBgYGAKCiAgYGBgamF2YXNjcmlwdAogIEFwcC5IYW1zdGVyID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CiAgICByZW1haW5pbmdDaG9yZXM6IEVtYmVyLmNvbXB1dGVkLmZpbHRlcignY2hvcmVzJywgZnVuY3Rpb24oY2hvcmUpIHsKICAgICAgcmV0dXJuICFjaG9yZS5kb25lOwogICAgfSkKICB9KTsKCiAgdmFyIGhhbXN0ZXIgPSBBcHAuSGFtc3Rlci5jcmVhdGUoe2Nob3JlczogWwogICAge25hbWU6ICdjb29rJywgZG9uZTogdHJ1ZX0sCiAgICB7bmFtZTogJ2NsZWFuJywgZG9uZTogdHJ1ZX0sCiAgICB7bmFtZTogJ3dyaXRlIG1vcmUgdW5pdCB0ZXN0cycsIGRvbmU6IGZhbHNlfQogIF19KTsKICBoYW1zdGVyLmdldCgncmVtYWluaW5nQ2hvcmVzJyk7IC8vIFt7bmFtZTogJ3dyaXRlIG1vcmUgdW5pdCB0ZXN0cycsIGRvbmU6IGZhbHNlfV0KICBgYGAKCiAgQG1ldGhvZCBjb21wdXRlZC5maWx0ZXIKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrCiAgQHJldHVybiB7RW1iZXIuQ29tcHV0ZWRQcm9wZXJ0eX0gdGhlIGZpbHRlcmVkIGFycmF5CiovCkVtYmVyLmNvbXB1dGVkLmZpbHRlciA9IGZ1bmN0aW9uKGRlcGVuZGVudEtleSwgY2FsbGJhY2spIHsKICB2YXIgb3B0aW9ucyA9IHsKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uIChhcnJheSwgY2hhbmdlTWV0YSwgaW5zdGFuY2VNZXRhKSB7CiAgICAgIGluc3RhbmNlTWV0YS5maWx0ZXJlZEFycmF5SW5kZXhlcyA9IG5ldyBFbWJlci5TdWJBcnJheSgpOwogICAgfSwKCiAgICBhZGRlZEl0ZW06IGZ1bmN0aW9uKGFycmF5LCBpdGVtLCBjaGFuZ2VNZXRhLCBpbnN0YW5jZU1ldGEpIHsKICAgICAgdmFyIG1hdGNoID0gISFjYWxsYmFjay5jYWxsKHRoaXMsIGl0ZW0pLAogICAgICAgICAgZmlsdGVySW5kZXggPSBpbnN0YW5jZU1ldGEuZmlsdGVyZWRBcnJheUluZGV4ZXMuYWRkSXRlbShjaGFuZ2VNZXRhLmluZGV4LCBtYXRjaCk7CgogICAgICBpZiAobWF0Y2gpIHsKICAgICAgICBhcnJheS5pbnNlcnRBdChmaWx0ZXJJbmRleCwgaXRlbSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBhcnJheTsKICAgIH0sCgogICAgcmVtb3ZlZEl0ZW06IGZ1bmN0aW9uKGFycmF5LCBpdGVtLCBjaGFuZ2VNZXRhLCBpbnN0YW5jZU1ldGEpIHsKICAgICAgdmFyIGZpbHRlckluZGV4ID0gaW5zdGFuY2VNZXRhLmZpbHRlcmVkQXJyYXlJbmRleGVzLnJlbW92ZUl0ZW0oY2hhbmdlTWV0YS5pbmRleCk7CgogICAgICBpZiAoZmlsdGVySW5kZXggPiAtMSkgewogICAgICAgIGFycmF5LnJlbW92ZUF0KGZpbHRlckluZGV4KTsKICAgICAgfQoKICAgICAgcmV0dXJuIGFycmF5OwogICAgfQogIH07CgogIHJldHVybiBFbWJlci5hcnJheUNvbXB1dGVkKGRlcGVuZGVudEtleSwgb3B0aW9ucyk7Cn07CgovKioKICBGaWx0ZXJzIHRoZSBhcnJheSBieSB0aGUgcHJvcGVydHkgYW5kIHZhbHVlCgogIGBgYGphdmFzY3JpcHQKICBBcHAuSGFtc3RlciA9IEVtYmVyLk9iamVjdC5leHRlbmQoewogICAgcmVtYWluaW5nQ2hvcmVzOiBFbWJlci5jb21wdXRlZC5maWx0ZXJCeSgnY2hvcmVzJywgJ2RvbmUnLCBmYWxzZSkKICB9KTsKCiAgdmFyIGhhbXN0ZXIgPSBBcHAuSGFtc3Rlci5jcmVhdGUoe2Nob3JlczogWwogICAge25hbWU6ICdjb29rJywgZG9uZTogdHJ1ZX0sCiAgICB7bmFtZTogJ2NsZWFuJywgZG9uZTogdHJ1ZX0sCiAgICB7bmFtZTogJ3dyaXRlIG1vcmUgdW5pdCB0ZXN0cycsIGRvbmU6IGZhbHNlfQogIF19KTsKICBoYW1zdGVyLmdldCgncmVtYWluaW5nQ2hvcmVzJyk7IC8vIFt7bmFtZTogJ3dyaXRlIG1vcmUgdW5pdCB0ZXN0cycsIGRvbmU6IGZhbHNlfV0KICBgYGAKCiAgQG1ldGhvZCBjb21wdXRlZC5maWx0ZXJCeQogIEBmb3IgRW1iZXIKICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5CiAgQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5S2V5CiAgQHBhcmFtIHtTdHJpbmd9IHZhbHVlCiAgQHJldHVybiB7RW1iZXIuQ29tcHV0ZWRQcm9wZXJ0eX0gdGhlIGZpbHRlcmVkIGFycmF5CiovCkVtYmVyLmNvbXB1dGVkLmZpbHRlckJ5ID0gZnVuY3Rpb24oZGVwZW5kZW50S2V5LCBwcm9wZXJ0eUtleSwgdmFsdWUpIHsKICB2YXIgY2FsbGJhY2s7CgogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CiAgICBjYWxsYmFjayA9IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgcmV0dXJuIGdldChpdGVtLCBwcm9wZXJ0eUtleSk7CiAgICB9OwogIH0gZWxzZSB7CiAgICBjYWxsYmFjayA9IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgcmV0dXJuIGdldChpdGVtLCBwcm9wZXJ0eUtleSkgPT09IHZhbHVlOwogICAgfTsKICB9CgogIHJldHVybiBFbWJlci5jb21wdXRlZC5maWx0ZXIoZGVwZW5kZW50S2V5ICsgJy5AZWFjaC4nICsgcHJvcGVydHlLZXksIGNhbGxiYWNrKTsKfTsKCi8qKgogIEBtZXRob2QgY29tcHV0ZWQuZmlsdGVyUHJvcGVydHkKICBAZm9yIEVtYmVyCiAgQHBhcmFtIGRlcGVuZGVudEtleQogIEBwYXJhbSBwcm9wZXJ0eUtleQogIEBwYXJhbSB2YWx1ZQogIEBkZXByZWNhdGVkIFVzZSBgRW1iZXIuY29tcHV0ZWQuZmlsdGVyQnlgIGluc3RlYWQKKi8KRW1iZXIuY29tcHV0ZWQuZmlsdGVyUHJvcGVydHkgPSBFbWJlci5jb21wdXRlZC5maWx0ZXJCeTsKCi8qKgogIEEgY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggcmV0dXJucyBhIG5ldyBhcnJheSB3aXRoIGFsbCB0aGUgdW5pcXVlCiAgZWxlbWVudHMgZnJvbSBvbmUgb3IgbW9yZSBkZXBlbmRlbnQgYXJyYXlzLgoKICBFeGFtcGxlCgogIGBgYGphdmFzY3JpcHQKICBBcHAuSGFtc3RlciA9IEVtYmVyLk9iamVjdC5leHRlbmQoewogICAgdW5pcXVlRnJ1aXRzOiBFbWJlci5jb21wdXRlZC51bmlxKCdmcnVpdHMnKQogIH0pOwoKICB2YXIgaGFtc3RlciA9IEFwcC5IYW1zdGVyLmNyZWF0ZSh7ZnJ1aXRzOiBbCiAgICAnYmFuYW5hJywKICAgICdncmFwZScsCiAgICAna2FsZScsCiAgICAnYmFuYW5hJwogIF19KTsKICBoYW1zdGVyLmdldCgndW5pcXVlRnJ1aXRzJyk7IC8vIFsnYmFuYW5hJywgJ2dyYXBlJywgJ2thbGUnXQogIGBgYAoKICBAbWV0aG9kIGNvbXB1dGVkLnVuaXEKICBAZm9yIEVtYmVyCiAgQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5S2V5KgogIEByZXR1cm4ge0VtYmVyLkNvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVzIGEgbmV3IGFycmF5IHdpdGggYWxsIHRoZQogIHVuaXF1ZSBlbGVtZW50cyBmcm9tIHRoZSBkZXBlbmRlbnQgYXJyYXkKKi8KRW1iZXIuY29tcHV0ZWQudW5pcSA9IGZ1bmN0aW9uKCkgewogIHZhciBhcmdzID0gYV9zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgYXJncy5wdXNoKHsKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKGFycmF5LCBjaGFuZ2VNZXRhLCBpbnN0YW5jZU1ldGEpIHsKICAgICAgaW5zdGFuY2VNZXRhLml0ZW1Db3VudHMgPSB7fTsKICAgIH0sCgogICAgYWRkZWRJdGVtOiBmdW5jdGlvbihhcnJheSwgaXRlbSwgY2hhbmdlTWV0YSwgaW5zdGFuY2VNZXRhKSB7CiAgICAgIHZhciBndWlkID0gZ3VpZEZvcihpdGVtKTsKCiAgICAgIGlmICghaW5zdGFuY2VNZXRhLml0ZW1Db3VudHNbZ3VpZF0pIHsKICAgICAgICBpbnN0YW5jZU1ldGEuaXRlbUNvdW50c1tndWlkXSA9IDE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKytpbnN0YW5jZU1ldGEuaXRlbUNvdW50c1tndWlkXTsKICAgICAgfQogICAgICBhcnJheS5hZGRPYmplY3QoaXRlbSk7CiAgICAgIHJldHVybiBhcnJheTsKICAgIH0sCiAgICByZW1vdmVkSXRlbTogZnVuY3Rpb24oYXJyYXksIGl0ZW0sIF8sIGluc3RhbmNlTWV0YSkgewogICAgICB2YXIgZ3VpZCA9IGd1aWRGb3IoaXRlbSksCiAgICAgICAgICBpdGVtQ291bnRzID0gaW5zdGFuY2VNZXRhLml0ZW1Db3VudHM7CgogICAgICBpZiAoLS1pdGVtQ291bnRzW2d1aWRdID09PSAwKSB7CiAgICAgICAgYXJyYXkucmVtb3ZlT2JqZWN0KGl0ZW0pOwogICAgICB9CiAgICAgIHJldHVybiBhcnJheTsKICAgIH0KICB9KTsKICByZXR1cm4gRW1iZXIuYXJyYXlDb21wdXRlZC5hcHBseShudWxsLCBhcmdzKTsKfTsKCi8qKgogIEFsaWFzIGZvciBbRW1iZXIuY29tcHV0ZWQudW5pcV0oL2FwaS8jbWV0aG9kX2NvbXB1dGVkX3VuaXEpLgoKICBAbWV0aG9kIGNvbXB1dGVkLnVuaW9uCiAgQGZvciBFbWJlcgogIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eUtleSoKICBAcmV0dXJuIHtFbWJlci5Db21wdXRlZFByb3BlcnR5fSBjb21wdXRlcyBhIG5ldyBhcnJheSB3aXRoIGFsbCB0aGUKICB1bmlxdWUgZWxlbWVudHMgZnJvbSB0aGUgZGVwZW5kZW50IGFycmF5CiovCkVtYmVyLmNvbXB1dGVkLnVuaW9uID0gRW1iZXIuY29tcHV0ZWQudW5pcTsKCi8qKgogIEEgY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggcmV0dXJucyBhIG5ldyBhcnJheSB3aXRoIGFsbCB0aGUgZHVwbGljYXRlZAogIGVsZW1lbnRzIGZyb20gdHdvIG9yIG1vcmUgZGVwZW5kZW55IGFycmF5cy4KCiAgRXhhbXBsZQoKICBgYGBqYXZhc2NyaXB0CiAgdmFyIG9iaiA9IEVtYmVyLk9iamVjdC5jcmVhdGVXaXRoTWl4aW5zKHsKICAgIGFkYUZyaWVuZHM6IFsnQ2hhcmxlcyBCYWJiYWdlJywgJ0pvaG4gSG9iaG91c2UnLCAnV2lsbGlhbSBLaW5nJywgJ01hcnkgU29tZXJ2aWxsZSddLAogICAgY2hhcmxlc0ZyaWVuZHM6IFsnV2lsbGlhbSBLaW5nJywgJ01hcnkgU29tZXJ2aWxsZScsICdBZGEgTG92ZWxhY2UnLCAnR2VvcmdlIFBlYWNvY2snXSwKICAgIGZyaWVuZHNJbkNvbW1vbjogRW1iZXIuY29tcHV0ZWQuaW50ZXJzZWN0KCdhZGFGcmllbmRzJywgJ2NoYXJsZXNGcmllbmRzJykKICB9KTsKCiAgb2JqLmdldCgnZnJpZW5kc0luQ29tbW9uJyk7IC8vIFsnV2lsbGlhbSBLaW5nJywgJ01hcnkgU29tZXJ2aWxsZSddCiAgYGBgCgogIEBtZXRob2QgY29tcHV0ZWQuaW50ZXJzZWN0CiAgQGZvciBFbWJlcgogIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eUtleSoKICBAcmV0dXJuIHtFbWJlci5Db21wdXRlZFByb3BlcnR5fSBjb21wdXRlcyBhIG5ldyBhcnJheSB3aXRoIGFsbCB0aGUKICBkdXBsaWNhdGVkIGVsZW1lbnRzIGZyb20gdGhlIGRlcGVuZGVudCBhcnJheXMKKi8KRW1iZXIuY29tcHV0ZWQuaW50ZXJzZWN0ID0gZnVuY3Rpb24gKCkgewogIHZhciBnZXREZXBlbmRlbnRLZXlHdWlkcyA9IGZ1bmN0aW9uIChjaGFuZ2VNZXRhKSB7CiAgICByZXR1cm4gbWFwKGNoYW5nZU1ldGEucHJvcGVydHkuX2RlcGVuZGVudEtleXMsIGZ1bmN0aW9uIChkZXBlbmRlbnRLZXkpIHsKICAgICAgcmV0dXJuIGd1aWRGb3IoZGVwZW5kZW50S2V5KTsKICAgIH0pOwogIH07CgogIHZhciBhcmdzID0gYV9zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgYXJncy5wdXNoKHsKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uIChhcnJheSwgY2hhbmdlTWV0YSwgaW5zdGFuY2VNZXRhKSB7CiAgICAgIGluc3RhbmNlTWV0YS5pdGVtQ291bnRzID0ge307CiAgICB9LAoKICAgIGFkZGVkSXRlbTogZnVuY3Rpb24oYXJyYXksIGl0ZW0sIGNoYW5nZU1ldGEsIGluc3RhbmNlTWV0YSkgewogICAgICB2YXIgaXRlbUd1aWQgPSBndWlkRm9yKGl0ZW0pLAogICAgICAgICAgZGVwZW5kZW50R3VpZHMgPSBnZXREZXBlbmRlbnRLZXlHdWlkcyhjaGFuZ2VNZXRhKSwKICAgICAgICAgIGRlcGVuZGVudEd1aWQgPSBndWlkRm9yKGNoYW5nZU1ldGEuYXJyYXlDaGFuZ2VkKSwKICAgICAgICAgIG51bWJlck9mRGVwZW5kZW50QXJyYXlzID0gY2hhbmdlTWV0YS5wcm9wZXJ0eS5fZGVwZW5kZW50S2V5cy5sZW5ndGgsCiAgICAgICAgICBpdGVtQ291bnRzID0gaW5zdGFuY2VNZXRhLml0ZW1Db3VudHM7CgogICAgICBpZiAoIWl0ZW1Db3VudHNbaXRlbUd1aWRdKSB7IGl0ZW1Db3VudHNbaXRlbUd1aWRdID0ge307IH0KICAgICAgaWYgKGl0ZW1Db3VudHNbaXRlbUd1aWRdW2RlcGVuZGVudEd1aWRdID09PSB1bmRlZmluZWQpIHsgaXRlbUNvdW50c1tpdGVtR3VpZF1bZGVwZW5kZW50R3VpZF0gPSAwOyB9CgogICAgICBpZiAoKytpdGVtQ291bnRzW2l0ZW1HdWlkXVtkZXBlbmRlbnRHdWlkXSA9PT0gMSAmJgogICAgICAgICAgbnVtYmVyT2ZEZXBlbmRlbnRBcnJheXMgPT09IEVtYmVyLmtleXMoaXRlbUNvdW50c1tpdGVtR3VpZF0pLmxlbmd0aCkgewoKICAgICAgICBhcnJheS5hZGRPYmplY3QoaXRlbSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGFycmF5OwogICAgfSwKICAgIHJlbW92ZWRJdGVtOiBmdW5jdGlvbihhcnJheSwgaXRlbSwgY2hhbmdlTWV0YSwgaW5zdGFuY2VNZXRhKSB7CiAgICAgIHZhciBpdGVtR3VpZCA9IGd1aWRGb3IoaXRlbSksCiAgICAgICAgICBkZXBlbmRlbnRHdWlkcyA9IGdldERlcGVuZGVudEtleUd1aWRzKGNoYW5nZU1ldGEpLAogICAgICAgICAgZGVwZW5kZW50R3VpZCA9IGd1aWRGb3IoY2hhbmdlTWV0YS5hcnJheUNoYW5nZWQpLAogICAgICAgICAgbnVtYmVyT2ZEZXBlbmRlbnRBcnJheXMgPSBjaGFuZ2VNZXRhLnByb3BlcnR5Ll9kZXBlbmRlbnRLZXlzLmxlbmd0aCwKICAgICAgICAgIG51bWJlck9mQXJyYXlzSXRlbUFwcGVhcnNJbiwKICAgICAgICAgIGl0ZW1Db3VudHMgPSBpbnN0YW5jZU1ldGEuaXRlbUNvdW50czsKCiAgICAgIGlmIChpdGVtQ291bnRzW2l0ZW1HdWlkXVtkZXBlbmRlbnRHdWlkXSA9PT0gdW5kZWZpbmVkKSB7IGl0ZW1Db3VudHNbaXRlbUd1aWRdW2RlcGVuZGVudEd1aWRdID0gMDsgfQogICAgICBpZiAoLS1pdGVtQ291bnRzW2l0ZW1HdWlkXVtkZXBlbmRlbnRHdWlkXSA9PT0gMCkgewogICAgICAgIGRlbGV0ZSBpdGVtQ291bnRzW2l0ZW1HdWlkXVtkZXBlbmRlbnRHdWlkXTsKICAgICAgICBudW1iZXJPZkFycmF5c0l0ZW1BcHBlYXJzSW4gPSBFbWJlci5rZXlzKGl0ZW1Db3VudHNbaXRlbUd1aWRdKS5sZW5ndGg7CgogICAgICAgIGlmIChudW1iZXJPZkFycmF5c0l0ZW1BcHBlYXJzSW4gPT09IDApIHsKICAgICAgICAgIGRlbGV0ZSBpdGVtQ291bnRzW2l0ZW1HdWlkXTsKICAgICAgICB9CiAgICAgICAgYXJyYXkucmVtb3ZlT2JqZWN0KGl0ZW0pOwogICAgICB9CiAgICAgIHJldHVybiBhcnJheTsKICAgIH0KICB9KTsKICByZXR1cm4gRW1iZXIuYXJyYXlDb21wdXRlZC5hcHBseShudWxsLCBhcmdzKTsKfTsKCi8qKgogIEEgY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggcmV0dXJucyBhIG5ldyBhcnJheSB3aXRoIGFsbCB0aGUKICBwcm9wZXJ0aWVzIGZyb20gdGhlIGZpcnN0IGRlcGVuZGVudCBhcnJheSB0aGF0IGFyZSBub3QgaW4gdGhlIHNlY29uZAogIGRlcGVuZGVudCBhcnJheS4KCiAgRXhhbXBsZQoKICBgYGBqYXZhc2NyaXB0CiAgQXBwLkhhbXN0ZXIgPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICAgIGxpa2VzOiBbJ2JhbmFuYScsICdncmFwZScsICdrYWxlJ10sCiAgICB3YW50czogRW1iZXIuY29tcHV0ZWQuc2V0RGlmZignbGlrZXMnLCAnZnJ1aXRzJykKICB9KTsKCiAgdmFyIGhhbXN0ZXIgPSBBcHAuSGFtc3Rlci5jcmVhdGUoe2ZydWl0czogWwogICAgJ2dyYXBlJywKICAgICdrYWxlJywKICBdfSk7CiAgaGFtc3Rlci5nZXQoJ3dhbnRzJyk7IC8vIFsnYmFuYW5hJ10KICBgYGAKCiAgQG1ldGhvZCBjb21wdXRlZC5zZXREaWZmCiAgQGZvciBFbWJlcgogIEBwYXJhbSB7U3RyaW5nfSBzZXRBUHJvcGVydHkKICBAcGFyYW0ge1N0cmluZ30gc2V0QlByb3BlcnR5CiAgQHJldHVybiB7RW1iZXIuQ29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZXMgYSBuZXcgYXJyYXkgd2l0aCBhbGwgdGhlCiAgaXRlbXMgZnJvbSB0aGUgZmlyc3QgZGVwZW5kZW50IGFycmF5IHRoYXQgYXJlIG5vdCBpbiB0aGUgc2Vjb25kCiAgZGVwZW5kZW50IGFycmF5CiovCkVtYmVyLmNvbXB1dGVkLnNldERpZmYgPSBmdW5jdGlvbiAoc2V0QVByb3BlcnR5LCBzZXRCUHJvcGVydHkpIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCAhPT0gMikgewogICAgdGhyb3cgbmV3IEVtYmVyLkVycm9yKCJzZXREaWZmIHJlcXVpcmVzIGV4YWN0bHkgdHdvIGRlcGVuZGVudCBhcnJheXMuIik7CiAgfQogIHJldHVybiBFbWJlci5hcnJheUNvbXB1dGVkLmNhbGwobnVsbCwgc2V0QVByb3BlcnR5LCBzZXRCUHJvcGVydHksIHsKICAgIGFkZGVkSXRlbTogZnVuY3Rpb24gKGFycmF5LCBpdGVtLCBjaGFuZ2VNZXRhLCBpbnN0YW5jZU1ldGEpIHsKICAgICAgdmFyIHNldEEgPSBnZXQodGhpcywgc2V0QVByb3BlcnR5KSwKICAgICAgICAgIHNldEIgPSBnZXQodGhpcywgc2V0QlByb3BlcnR5KTsKCiAgICAgIGlmIChjaGFuZ2VNZXRhLmFycmF5Q2hhbmdlZCA9PT0gc2V0QSkgewogICAgICAgIGlmICghc2V0Qi5jb250YWlucyhpdGVtKSkgewogICAgICAgICAgYXJyYXkuYWRkT2JqZWN0KGl0ZW0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBhcnJheS5yZW1vdmVPYmplY3QoaXRlbSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGFycmF5OwogICAgfSwKCiAgICByZW1vdmVkSXRlbTogZnVuY3Rpb24gKGFycmF5LCBpdGVtLCBjaGFuZ2VNZXRhLCBpbnN0YW5jZU1ldGEpIHsKICAgICAgdmFyIHNldEEgPSBnZXQodGhpcywgc2V0QVByb3BlcnR5KSwKICAgICAgICAgIHNldEIgPSBnZXQodGhpcywgc2V0QlByb3BlcnR5KTsKCiAgICAgIGlmIChjaGFuZ2VNZXRhLmFycmF5Q2hhbmdlZCA9PT0gc2V0QikgewogICAgICAgIGlmIChzZXRBLmNvbnRhaW5zKGl0ZW0pKSB7CiAgICAgICAgICBhcnJheS5hZGRPYmplY3QoaXRlbSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGFycmF5LnJlbW92ZU9iamVjdChpdGVtKTsKICAgICAgfQogICAgICByZXR1cm4gYXJyYXk7CiAgICB9CiAgfSk7Cn07CgpmdW5jdGlvbiBiaW5hcnlTZWFyY2goYXJyYXksIGl0ZW0sIGxvdywgaGlnaCkgewogIHZhciBtaWQsIG1pZEl0ZW0sIHJlcywgZ3VpZE1pZCwgZ3VpZEl0ZW07CgogIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgNCkgeyBoaWdoID0gZ2V0KGFycmF5LCAnbGVuZ3RoJyk7IH0KICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IDMpIHsgbG93ID0gMDsgfQoKICBpZiAobG93ID09PSBoaWdoKSB7CiAgICByZXR1cm4gbG93OwogIH0KCiAgbWlkID0gbG93ICsgTWF0aC5mbG9vcigoaGlnaCAtIGxvdykgLyAyKTsKICBtaWRJdGVtID0gYXJyYXkub2JqZWN0QXQobWlkKTsKCiAgZ3VpZE1pZCA9IF9ndWlkRm9yKG1pZEl0ZW0pOwogIGd1aWRJdGVtID0gX2d1aWRGb3IoaXRlbSk7CgogIGlmIChndWlkTWlkID09PSBndWlkSXRlbSkgewogICAgcmV0dXJuIG1pZDsKICB9CgogIHJlcyA9IHRoaXMub3JkZXIobWlkSXRlbSwgaXRlbSk7CiAgaWYgKHJlcyA9PT0gMCkgewogICAgcmVzID0gZ3VpZE1pZCA8IGd1aWRJdGVtID8gLTEgOiAxOwogIH0KCgogIGlmIChyZXMgPCAwKSB7CiAgICByZXR1cm4gdGhpcy5iaW5hcnlTZWFyY2goYXJyYXksIGl0ZW0sIG1pZCsxLCBoaWdoKTsKICB9IGVsc2UgaWYgKHJlcyA+IDApIHsKICAgIHJldHVybiB0aGlzLmJpbmFyeVNlYXJjaChhcnJheSwgaXRlbSwgbG93LCBtaWQpOwogIH0KCiAgcmV0dXJuIG1pZDsKCiAgZnVuY3Rpb24gX2d1aWRGb3IoaXRlbSkgewogICAgaWYgKFNlYXJjaFByb3h5LmRldGVjdEluc3RhbmNlKGl0ZW0pKSB7CiAgICAgIHJldHVybiBndWlkRm9yKGdldChpdGVtLCAnY29udGVudCcpKTsKICAgIH0KICAgIHJldHVybiBndWlkRm9yKGl0ZW0pOwogIH0KfQoKClNlYXJjaFByb3h5ID0gRW1iZXIuT2JqZWN0UHJveHkuZXh0ZW5kKCk7CgovKioKICBBIGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIHJldHVybnMgYSBuZXcgYXJyYXkgd2l0aCBhbGwgdGhlCiAgcHJvcGVydGllcyBmcm9tIHRoZSBmaXJzdCBkZXBlbmRlbnQgYXJyYXkgc29ydGVkIGJhc2VkIG9uIGEgcHJvcGVydHkKICBvciBzb3J0IGZ1bmN0aW9uLgoKICBUaGUgY2FsbGJhY2sgbWV0aG9kIHlvdSBwcm92aWRlIHNob3VsZCBoYXZlIHRoZSBmb2xsb3dpbmcgc2lnbmF0dXJlOgoKICBgYGBqYXZhc2NyaXB0CiAgZnVuY3Rpb24oaXRlbUEsIGl0ZW1CKTsKICBgYGAKCiAgLSBgaXRlbUFgIHRoZSBmaXJzdCBpdGVtIHRvIGNvbXBhcmUuCiAgLSBgaXRlbUJgIHRoZSBzZWNvbmQgaXRlbSB0byBjb21wYXJlLgoKICBUaGlzIGZ1bmN0aW9uIHNob3VsZCByZXR1cm4gYC0xYCB3aGVuIGBpdGVtQWAgc2hvdWxkIGNvbWUgYmVmb3JlCiAgYGl0ZW1CYC4gSXQgc2hvdWxkIHJldHVybiBgMWAgd2hlbiBgaXRlbUFgIHNob3VsZCBjb21lIGFmdGVyCiAgYGl0ZW1CYC4gSWYgdGhlIGBpdGVtQWAgYW5kIGBpdGVtQmAgYXJlIGVxdWFsIHRoaXMgZnVuY3Rpb24gc2hvdWxkIHJldHVybiBgMGAuCgogIEV4YW1wbGUKCiAgYGBgamF2YXNjcmlwdAogIHZhciBUb0RvTGlzdCA9IEVtYmVyLk9iamVjdC5leHRlbmQoewogICAgdG9kb3NTb3J0aW5nOiBbJ25hbWUnXSwKICAgIHNvcnRlZFRvZG9zOiBFbWJlci5jb21wdXRlZC5zb3J0KCd0b2RvcycsICd0b2Rvc1NvcnRpbmcnKSwKICAgIHByaW9yaXR5VG9kb3M6IEVtYmVyLmNvbXB1dGVkLnNvcnQoJ3RvZG9zJywgZnVuY3Rpb24oYSwgYil7CiAgICAgIGlmIChhLnByaW9yaXR5ID4gYi5wcmlvcml0eSkgewogICAgICAgIHJldHVybiAxOwogICAgICB9IGVsc2UgaWYgKGEucHJpb3JpdHkgPCBiLnByaW9yaXR5KSB7CiAgICAgICAgcmV0dXJuIC0xOwogICAgICB9CiAgICAgIHJldHVybiAwOwogICAgfSksCiAgfSk7CiAgdmFyIHRvZG9MaXN0ID0gVG9Eb0xpc3QuY3JlYXRlKHt0b2RvczogWwogICAge25hbWU6ICdVbml0IFRlc3QnLCBwcmlvcml0eTogMn0sCiAgICB7bmFtZTogJ0RvY3VtZW50YXRpb24nLCBwcmlvcml0eTogM30sCiAgICB7bmFtZTogJ1JlbGVhc2UnLCBwcmlvcml0eTogMX0KICBdfSk7CgogIHRvZG9MaXN0LmdldCgnc29ydGVkVG9kb3MnKTsgLy8gW3tuYW1lOidEb2N1bWVudGF0aW9uJywgcHJpb3JpdHk6M30sIHtuYW1lOidSZWxlYXNlJywgcHJpb3JpdHk6MX0sIHtuYW1lOidVbml0IFRlc3QnLCBwcmlvcml0eToyfV0KICB0b2RvTGlzdC5nZXQoJ3ByaW9yaXR5VG9kb3MnKTsgLy8gW3tuYW1lOidSZWxlYXNlJywgcHJpb3JpdHk6MX0sIHtuYW1lOidVbml0IFRlc3QnLCBwcmlvcml0eToyfSwge25hbWU6J0RvY3VtZW50YXRpb24nLCBwcmlvcml0eTozfV0KICBgYGAKCiAgQG1ldGhvZCBjb21wdXRlZC5zb3J0CiAgQGZvciBFbWJlcgogIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkKICBAcGFyYW0ge1N0cmluZyBvciBGdW5jdGlvbn0gc29ydERlZmluaXRpb24gYSBkZXBlbmRlbnQga2V5IHRvIGFuCiAgYXJyYXkgb2Ygc29ydCBwcm9wZXJ0aWVzIG9yIGEgZnVuY3Rpb24gdG8gdXNlIHdoZW4gc29ydGluZwogIEByZXR1cm4ge0VtYmVyLkNvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVzIGEgbmV3IHNvcnRlZCBhcnJheSBiYXNlZAogIG9uIHRoZSBzb3J0IHByb3BlcnR5IGFycmF5IG9yIGNhbGxiYWNrIGZ1bmN0aW9uCiovCkVtYmVyLmNvbXB1dGVkLnNvcnQgPSBmdW5jdGlvbiAoaXRlbXNLZXksIHNvcnREZWZpbml0aW9uKSB7CiAgRW1iZXIuYXNzZXJ0KCJFbWJlci5jb21wdXRlZC5zb3J0IHJlcXVpcmVzIHR3byBhcmd1bWVudHM6IGFuIGFycmF5IGtleSB0byBzb3J0IGFuZCBlaXRoZXIgYSBzb3J0IHByb3BlcnRpZXMga2V5IG9yIHNvcnQgZnVuY3Rpb24iLCBhcmd1bWVudHMubGVuZ3RoID09PSAyKTsKCiAgdmFyIGluaXRGbiwgc29ydFByb3BlcnRpZXNLZXk7CgogIGlmICh0eXBlb2Ygc29ydERlZmluaXRpb24gPT09ICdmdW5jdGlvbicpIHsKICAgIGluaXRGbiA9IGZ1bmN0aW9uIChhcnJheSwgY2hhbmdlTWV0YSwgaW5zdGFuY2VNZXRhKSB7CiAgICAgIGluc3RhbmNlTWV0YS5vcmRlciA9IHNvcnREZWZpbml0aW9uOwogICAgICBpbnN0YW5jZU1ldGEuYmluYXJ5U2VhcmNoID0gYmluYXJ5U2VhcmNoOwogICAgfTsKICB9IGVsc2UgewogICAgc29ydFByb3BlcnRpZXNLZXkgPSBzb3J0RGVmaW5pdGlvbjsKICAgIGluaXRGbiA9IGZ1bmN0aW9uIChhcnJheSwgY2hhbmdlTWV0YSwgaW5zdGFuY2VNZXRhKSB7CiAgICAgIGZ1bmN0aW9uIHNldHVwU29ydFByb3BlcnRpZXMoKSB7CiAgICAgICAgdmFyIHNvcnRQcm9wZXJ0eURlZmluaXRpb25zID0gZ2V0KHRoaXMsIHNvcnRQcm9wZXJ0aWVzS2V5KSwKICAgICAgICAgICAgc29ydFByb3BlcnR5LAogICAgICAgICAgICBzb3J0UHJvcGVydGllcyA9IGluc3RhbmNlTWV0YS5zb3J0UHJvcGVydGllcyA9IFtdLAogICAgICAgICAgICBzb3J0UHJvcGVydHlBc2NlbmRpbmcgPSBpbnN0YW5jZU1ldGEuc29ydFByb3BlcnR5QXNjZW5kaW5nID0ge30sCiAgICAgICAgICAgIGlkeCwKICAgICAgICAgICAgYXNjOwoKICAgICAgICBFbWJlci5hc3NlcnQoIkNhbm5vdCBzb3J0OiAnIiArIHNvcnRQcm9wZXJ0aWVzS2V5ICsgIicgaXMgbm90IGFuIGFycmF5LiIsIEVtYmVyLmlzQXJyYXkoc29ydFByb3BlcnR5RGVmaW5pdGlvbnMpKTsKCiAgICAgICAgY2hhbmdlTWV0YS5wcm9wZXJ0eS5jbGVhckl0ZW1Qcm9wZXJ0eUtleXMoaXRlbXNLZXkpOwoKICAgICAgICBmb3JFYWNoKHNvcnRQcm9wZXJ0eURlZmluaXRpb25zLCBmdW5jdGlvbiAoc29ydFByb3BlcnR5RGVmaW5pdGlvbikgewogICAgICAgICAgaWYgKChpZHggPSBzb3J0UHJvcGVydHlEZWZpbml0aW9uLmluZGV4T2YoJzonKSkgIT09IC0xKSB7CiAgICAgICAgICAgIHNvcnRQcm9wZXJ0eSA9IHNvcnRQcm9wZXJ0eURlZmluaXRpb24uc3Vic3RyaW5nKDAsIGlkeCk7CiAgICAgICAgICAgIGFzYyA9IHNvcnRQcm9wZXJ0eURlZmluaXRpb24uc3Vic3RyaW5nKGlkeCsxKS50b0xvd2VyQ2FzZSgpICE9PSAnZGVzYyc7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzb3J0UHJvcGVydHkgPSBzb3J0UHJvcGVydHlEZWZpbml0aW9uOwogICAgICAgICAgICBhc2MgPSB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIHNvcnRQcm9wZXJ0aWVzLnB1c2goc29ydFByb3BlcnR5KTsKICAgICAgICAgIHNvcnRQcm9wZXJ0eUFzY2VuZGluZ1tzb3J0UHJvcGVydHldID0gYXNjOwogICAgICAgICAgY2hhbmdlTWV0YS5wcm9wZXJ0eS5pdGVtUHJvcGVydHlLZXkoaXRlbXNLZXksIHNvcnRQcm9wZXJ0eSk7CiAgICAgICAgfSk7CgogICAgICAgIHNvcnRQcm9wZXJ0eURlZmluaXRpb25zLmFkZE9ic2VydmVyKCdAZWFjaCcsIHRoaXMsIHVwZGF0ZVNvcnRQcm9wZXJ0aWVzT25jZSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHVwZGF0ZVNvcnRQcm9wZXJ0aWVzT25jZSgpIHsKICAgICAgICBFbWJlci5ydW4ub25jZSh0aGlzLCB1cGRhdGVTb3J0UHJvcGVydGllcywgY2hhbmdlTWV0YS5wcm9wZXJ0eU5hbWUpOwogICAgICB9CgogICAgICBmdW5jdGlvbiB1cGRhdGVTb3J0UHJvcGVydGllcyhwcm9wZXJ0eU5hbWUpIHsKICAgICAgICBzZXR1cFNvcnRQcm9wZXJ0aWVzLmNhbGwodGhpcyk7CiAgICAgICAgY2hhbmdlTWV0YS5wcm9wZXJ0eS5yZWNvbXB1dGVPbmNlLmNhbGwodGhpcywgcHJvcGVydHlOYW1lKTsKICAgICAgfQoKICAgICAgRW1iZXIuYWRkT2JzZXJ2ZXIodGhpcywgc29ydFByb3BlcnRpZXNLZXksIHVwZGF0ZVNvcnRQcm9wZXJ0aWVzT25jZSk7CgogICAgICBzZXR1cFNvcnRQcm9wZXJ0aWVzLmNhbGwodGhpcyk7CgoKICAgICAgaW5zdGFuY2VNZXRhLm9yZGVyID0gZnVuY3Rpb24gKGl0ZW1BLCBpdGVtQikgewogICAgICAgIHZhciBzb3J0UHJvcGVydHksIHJlc3VsdCwgYXNjOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5zb3J0UHJvcGVydGllcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgc29ydFByb3BlcnR5ID0gdGhpcy5zb3J0UHJvcGVydGllc1tpXTsKICAgICAgICAgIHJlc3VsdCA9IEVtYmVyLmNvbXBhcmUoZ2V0KGl0ZW1BLCBzb3J0UHJvcGVydHkpLCBnZXQoaXRlbUIsIHNvcnRQcm9wZXJ0eSkpOwoKICAgICAgICAgIGlmIChyZXN1bHQgIT09IDApIHsKICAgICAgICAgICAgYXNjID0gdGhpcy5zb3J0UHJvcGVydHlBc2NlbmRpbmdbc29ydFByb3BlcnR5XTsKICAgICAgICAgICAgcmV0dXJuIGFzYyA/IHJlc3VsdCA6ICgtMSAqIHJlc3VsdCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gMDsKICAgICAgfTsKCiAgICAgIGluc3RhbmNlTWV0YS5iaW5hcnlTZWFyY2ggPSBiaW5hcnlTZWFyY2g7CiAgICB9OwogIH0KCiAgcmV0dXJuIEVtYmVyLmFycmF5Q29tcHV0ZWQuY2FsbChudWxsLCBpdGVtc0tleSwgewogICAgaW5pdGlhbGl6ZTogaW5pdEZuLAoKICAgIGFkZGVkSXRlbTogZnVuY3Rpb24gKGFycmF5LCBpdGVtLCBjaGFuZ2VNZXRhLCBpbnN0YW5jZU1ldGEpIHsKICAgICAgdmFyIGluZGV4ID0gaW5zdGFuY2VNZXRhLmJpbmFyeVNlYXJjaChhcnJheSwgaXRlbSk7CiAgICAgIGFycmF5Lmluc2VydEF0KGluZGV4LCBpdGVtKTsKICAgICAgcmV0dXJuIGFycmF5OwogICAgfSwKCiAgICByZW1vdmVkSXRlbTogZnVuY3Rpb24gKGFycmF5LCBpdGVtLCBjaGFuZ2VNZXRhLCBpbnN0YW5jZU1ldGEpIHsKICAgICAgdmFyIHByb3h5UHJvcGVydGllcywgaW5kZXgsIHNlYXJjaEl0ZW07CgogICAgICBpZiAoY2hhbmdlTWV0YS5wcmV2aW91c1ZhbHVlcykgewogICAgICAgIHByb3h5UHJvcGVydGllcyA9IG1lcmdlKHsgY29udGVudDogaXRlbSB9LCBjaGFuZ2VNZXRhLnByZXZpb3VzVmFsdWVzKTsKCiAgICAgICAgc2VhcmNoSXRlbSA9IFNlYXJjaFByb3h5LmNyZWF0ZShwcm94eVByb3BlcnRpZXMpOwogICAgICB9IGVsc2UgewogICAgICAgIHNlYXJjaEl0ZW0gPSBpdGVtOwogICAgICB9CgogICAgICBpbmRleCA9IGluc3RhbmNlTWV0YS5iaW5hcnlTZWFyY2goYXJyYXksIHNlYXJjaEl0ZW0pOwogICAgICBhcnJheS5yZW1vdmVBdChpbmRleCk7CiAgICAgIHJldHVybiBhcnJheTsKICAgIH0KICB9KTsKfTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKRW1iZXIuUlNWUCA9IHJlcXVpcmVNb2R1bGUoJ3JzdnAnKTsKCkVtYmVyLlJTVlAub25lcnJvckRlZmF1bHQgPSBmdW5jdGlvbihlcnJvcikgewogIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7CiAgICBpZiAoRW1iZXIudGVzdGluZykgewogICAgICBpZiAoRW1iZXIuVGVzdCAmJiBFbWJlci5UZXN0LmFkYXB0ZXIpIHsKICAgICAgICBFbWJlci5UZXN0LmFkYXB0ZXIuZXhjZXB0aW9uKGVycm9yKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgRW1iZXIuTG9nZ2VyLmVycm9yKGVycm9yLnN0YWNrKTsKICAgICAgRW1iZXIuYXNzZXJ0KGVycm9yLCBmYWxzZSk7CiAgICB9CiAgfQp9OwoKRW1iZXIuUlNWUC5vbignZXJyb3InLCBFbWJlci5SU1ZQLm9uZXJyb3JEZWZhdWx0KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1ydW50aW1lCiovCgp2YXIgYV9zbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKCgppZiAoRW1iZXIuRVhURU5EX1BST1RPVFlQRVMgPT09IHRydWUgfHwgRW1iZXIuRVhURU5EX1BST1RPVFlQRVMuRnVuY3Rpb24pIHsKCiAgLyoqCiAgICBUaGUgYHByb3BlcnR5YCBleHRlbnNpb24gb2YgSmF2YXNjcmlwdCdzIEZ1bmN0aW9uIHByb3RvdHlwZSBpcyBhdmFpbGFibGUKICAgIHdoZW4gYEVtYmVyLkVYVEVORF9QUk9UT1RZUEVTYCBvciBgRW1iZXIuRVhURU5EX1BST1RPVFlQRVMuRnVuY3Rpb25gIGlzCiAgICBgdHJ1ZWAsIHdoaWNoIGlzIHRoZSBkZWZhdWx0LgoKICAgIENvbXB1dGVkIHByb3BlcnRpZXMgYWxsb3cgeW91IHRvIHRyZWF0IGEgZnVuY3Rpb24gbGlrZSBhIHByb3BlcnR5OgoKICAgIGBgYGphdmFzY3JpcHQKICAgIE15QXBwLlByZXNpZGVudCA9IEVtYmVyLk9iamVjdC5leHRlbmQoewogICAgICBmaXJzdE5hbWU6ICcnLAogICAgICBsYXN0TmFtZTogICcnLAoKICAgICAgZnVsbE5hbWU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldCgnZmlyc3ROYW1lJykgKyAnICcgKyB0aGlzLmdldCgnbGFzdE5hbWUnKTsKCiAgICAgICAgLy8gQ2FsbCB0aGlzIGZsYWcgdG8gbWFyayB0aGUgZnVuY3Rpb24gYXMgYSBwcm9wZXJ0eQogICAgICB9LnByb3BlcnR5KCkKICAgIH0pOwoKICAgIHZhciBwcmVzaWRlbnQgPSBNeUFwcC5QcmVzaWRlbnQuY3JlYXRlKHsKICAgICAgZmlyc3ROYW1lOiAiQmFyYWNrIiwKICAgICAgbGFzdE5hbWU6ICJPYmFtYSIKICAgIH0pOwoKICAgIHByZXNpZGVudC5nZXQoJ2Z1bGxOYW1lJyk7ICAgIC8vICJCYXJhY2sgT2JhbWEiCiAgICBgYGAKCiAgICBUcmVhdGluZyBhIGZ1bmN0aW9uIGxpa2UgYSBwcm9wZXJ0eSBpcyB1c2VmdWwgYmVjYXVzZSB0aGV5IGNhbiB3b3JrIHdpdGgKICAgIGJpbmRpbmdzLCBqdXN0IGxpa2UgYW55IG90aGVyIHByb3BlcnR5LgoKICAgIE1hbnkgY29tcHV0ZWQgcHJvcGVydGllcyBoYXZlIGRlcGVuZGVuY2llcyBvbiBvdGhlciBwcm9wZXJ0aWVzLiBGb3IKICAgIGV4YW1wbGUsIGluIHRoZSBhYm92ZSBleGFtcGxlLCB0aGUgYGZ1bGxOYW1lYCBwcm9wZXJ0eSBkZXBlbmRzIG9uCiAgICBgZmlyc3ROYW1lYCBhbmQgYGxhc3ROYW1lYCB0byBkZXRlcm1pbmUgaXRzIHZhbHVlLiBZb3UgY2FuIHRlbGwgRW1iZXIKICAgIGFib3V0IHRoZXNlIGRlcGVuZGVuY2llcyBsaWtlIHRoaXM6CgogICAgYGBgamF2YXNjcmlwdAogICAgTXlBcHAuUHJlc2lkZW50ID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CiAgICAgIGZpcnN0TmFtZTogJycsCiAgICAgIGxhc3ROYW1lOiAgJycsCgogICAgICBmdWxsTmFtZTogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KCdmaXJzdE5hbWUnKSArICcgJyArIHRoaXMuZ2V0KCdsYXN0TmFtZScpOwoKICAgICAgICAvLyBUZWxsIEVtYmVyLmpzIHRoYXQgdGhpcyBjb21wdXRlZCBwcm9wZXJ0eSBkZXBlbmRzIG9uIGZpcnN0TmFtZQogICAgICAgIC8vIGFuZCBsYXN0TmFtZQogICAgICB9LnByb3BlcnR5KCdmaXJzdE5hbWUnLCAnbGFzdE5hbWUnKQogICAgfSk7CiAgICBgYGAKCiAgICBNYWtlIHN1cmUgeW91IGxpc3QgdGhlc2UgZGVwZW5kZW5jaWVzIHNvIEVtYmVyIGtub3dzIHdoZW4gdG8gdXBkYXRlCiAgICBiaW5kaW5ncyB0aGF0IGNvbm5lY3QgdG8gYSBjb21wdXRlZCBwcm9wZXJ0eS4gQ2hhbmdpbmcgYSBkZXBlbmRlbmN5CiAgICB3aWxsIG5vdCBpbW1lZGlhdGVseSB0cmlnZ2VyIGFuIHVwZGF0ZSBvZiB0aGUgY29tcHV0ZWQgcHJvcGVydHksIGJ1dAogICAgd2lsbCBpbnN0ZWFkIGNsZWFyIHRoZSBjYWNoZSBzbyB0aGF0IGl0IGlzIHVwZGF0ZWQgd2hlbiB0aGUgbmV4dCBgZ2V0YAogICAgaXMgY2FsbGVkIG9uIHRoZSBwcm9wZXJ0eS4KCiAgICBTZWUgW0VtYmVyLkNvbXB1dGVkUHJvcGVydHldKC9hcGkvY2xhc3Nlcy9FbWJlci5Db21wdXRlZFByb3BlcnR5Lmh0bWwpLCBbRW1iZXIuY29tcHV0ZWRdKC9hcGkvI21ldGhvZF9jb21wdXRlZCkuCgogICAgQG1ldGhvZCBwcm9wZXJ0eQogICAgQGZvciBGdW5jdGlvbgogICovCiAgRnVuY3Rpb24ucHJvdG90eXBlLnByb3BlcnR5ID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgcmV0ID0gRW1iZXIuY29tcHV0ZWQodGhpcyk7CiAgICAvLyBDb21wdXRlZFByb3BlcnR5LnByb3RvdHlwZS5wcm9wZXJ0eSBleHBhbmRzIHByb3BlcnRpZXM7IG5vIG5lZWQgZm9yIHVzIHRvCiAgICAvLyBkbyBzbyBoZXJlLgogICAgcmV0dXJuIHJldC5wcm9wZXJ0eS5hcHBseShyZXQsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLyoqCiAgICBUaGUgYG9ic2VydmVzYCBleHRlbnNpb24gb2YgSmF2YXNjcmlwdCdzIEZ1bmN0aW9uIHByb3RvdHlwZSBpcyBhdmFpbGFibGUKICAgIHdoZW4gYEVtYmVyLkVYVEVORF9QUk9UT1RZUEVTYCBvciBgRW1iZXIuRVhURU5EX1BST1RPVFlQRVMuRnVuY3Rpb25gIGlzCiAgICB0cnVlLCB3aGljaCBpcyB0aGUgZGVmYXVsdC4KCiAgICBZb3UgY2FuIG9ic2VydmUgcHJvcGVydHkgY2hhbmdlcyBzaW1wbHkgYnkgYWRkaW5nIHRoZSBgb2JzZXJ2ZXNgCiAgICBjYWxsIHRvIHRoZSBlbmQgb2YgeW91ciBtZXRob2QgZGVjbGFyYXRpb25zIGluIGNsYXNzZXMgdGhhdCB5b3Ugd3JpdGUuCiAgICBGb3IgZXhhbXBsZToKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICAgICAgdmFsdWVPYnNlcnZlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gRXhlY3V0ZXMgd2hlbmV2ZXIgdGhlICJ2YWx1ZSIgcHJvcGVydHkgY2hhbmdlcwogICAgICB9Lm9ic2VydmVzKCd2YWx1ZScpCiAgICB9KTsKICAgIGBgYAoKICAgIEluIHRoZSBmdXR1cmUgdGhpcyBtZXRob2QgbWF5IGJlY29tZSBhc3luY2hyb25vdXMuIElmIHlvdSB3YW50IHRvIGVuc3VyZQogICAgc3luY2hyb25vdXMgYmVoYXZpb3IsIHVzZSBgb2JzZXJ2ZXNJbW1lZGlhdGVseWAuCgogICAgU2VlIGBFbWJlci5vYnNlcnZlcmAuCgogICAgQG1ldGhvZCBvYnNlcnZlcwogICAgQGZvciBGdW5jdGlvbgogICovCiAgRnVuY3Rpb24ucHJvdG90eXBlLm9ic2VydmVzID0gZnVuY3Rpb24oKSB7CiAgICAKICAgICAgdGhpcy5fX2VtYmVyX29ic2VydmVzX18gPSBhX3NsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgIAoKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8qKgogICAgVGhlIGBvYnNlcnZlc0ltbWVkaWF0ZWx5YCBleHRlbnNpb24gb2YgSmF2YXNjcmlwdCdzIEZ1bmN0aW9uIHByb3RvdHlwZSBpcwogICAgYXZhaWxhYmxlIHdoZW4gYEVtYmVyLkVYVEVORF9QUk9UT1RZUEVTYCBvcgogICAgYEVtYmVyLkVYVEVORF9QUk9UT1RZUEVTLkZ1bmN0aW9uYCBpcyB0cnVlLCB3aGljaCBpcyB0aGUgZGVmYXVsdC4KCiAgICBZb3UgY2FuIG9ic2VydmUgcHJvcGVydHkgY2hhbmdlcyBzaW1wbHkgYnkgYWRkaW5nIHRoZSBgb2JzZXJ2ZXNJbW1lZGlhdGVseWAKICAgIGNhbGwgdG8gdGhlIGVuZCBvZiB5b3VyIG1ldGhvZCBkZWNsYXJhdGlvbnMgaW4gY2xhc3NlcyB0aGF0IHlvdSB3cml0ZS4KICAgIEZvciBleGFtcGxlOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIEVtYmVyLk9iamVjdC5leHRlbmQoewogICAgICB2YWx1ZU9ic2VydmVyOiBmdW5jdGlvbigpIHsKICAgICAgICAvLyBFeGVjdXRlcyBpbW1lZGlhdGVseSBhZnRlciB0aGUgInZhbHVlIiBwcm9wZXJ0eSBjaGFuZ2VzCiAgICAgIH0ub2JzZXJ2ZXNJbW1lZGlhdGVseSgndmFsdWUnKQogICAgfSk7CiAgICBgYGAKCiAgICBJbiB0aGUgZnV0dXJlLCBgb2JzZXJ2ZXNgIG1heSBiZWNvbWUgYXN5bmNocm9ub3VzLiBJbiB0aGlzIGV2ZW50LAogICAgYG9ic2VydmVzSW1tZWRpYXRlbHlgIHdpbGwgbWFpbnRhaW4gdGhlIHN5bmNocm9ub3VzIGJlaGF2aW9yLgoKICAgIFNlZSBgRW1iZXIuaW1tZWRpYXRlT2JzZXJ2ZXJgLgoKICAgIEBtZXRob2Qgb2JzZXJ2ZXNJbW1lZGlhdGVseQogICAgQGZvciBGdW5jdGlvbgogICovCiAgRnVuY3Rpb24ucHJvdG90eXBlLm9ic2VydmVzSW1tZWRpYXRlbHkgPSBmdW5jdGlvbigpIHsKICAgIGZvciAodmFyIGk9MCwgbD1hcmd1bWVudHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICB2YXIgYXJnID0gYXJndW1lbnRzW2ldOwogICAgICBFbWJlci5hc3NlcnQoIkltbWVkaWF0ZSBvYnNlcnZlcnMgbXVzdCBvYnNlcnZlIGludGVybmFsIHByb3BlcnRpZXMgb25seSwgbm90IHByb3BlcnRpZXMgb24gb3RoZXIgb2JqZWN0cy4iLCBhcmcuaW5kZXhPZignLicpID09PSAtMSk7CiAgICB9CgogICAgLy8gb2JzZXJ2ZXMgaGFuZGxlcyBwcm9wZXJ0eSBleHBhbnNpb24KICAgIHJldHVybiB0aGlzLm9ic2VydmVzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLyoqCiAgICBUaGUgYG9ic2VydmVzQmVmb3JlYCBleHRlbnNpb24gb2YgSmF2YXNjcmlwdCdzIEZ1bmN0aW9uIHByb3RvdHlwZSBpcwogICAgYXZhaWxhYmxlIHdoZW4gYEVtYmVyLkVYVEVORF9QUk9UT1RZUEVTYCBvcgogICAgYEVtYmVyLkVYVEVORF9QUk9UT1RZUEVTLkZ1bmN0aW9uYCBpcyB0cnVlLCB3aGljaCBpcyB0aGUgZGVmYXVsdC4KCiAgICBZb3UgY2FuIGdldCBub3RpZmllZCB3aGVuIGEgcHJvcGVydHkgY2hhbmdlIGlzIGFib3V0IHRvIGhhcHBlbiBieQogICAgYnkgYWRkaW5nIHRoZSBgb2JzZXJ2ZXNCZWZvcmVgIGNhbGwgdG8gdGhlIGVuZCBvZiB5b3VyIG1ldGhvZAogICAgZGVjbGFyYXRpb25zIGluIGNsYXNzZXMgdGhhdCB5b3Ugd3JpdGUuIEZvciBleGFtcGxlOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIEVtYmVyLk9iamVjdC5leHRlbmQoewogICAgICB2YWx1ZU9ic2VydmVyOiBmdW5jdGlvbigpIHsKICAgICAgICAvLyBFeGVjdXRlcyB3aGVuZXZlciB0aGUgInZhbHVlIiBwcm9wZXJ0eSBpcyBhYm91dCB0byBjaGFuZ2UKICAgICAgfS5vYnNlcnZlc0JlZm9yZSgndmFsdWUnKQogICAgfSk7CiAgICBgYGAKCiAgICBTZWUgYEVtYmVyLmJlZm9yZU9ic2VydmVyYC4KCiAgICBAbWV0aG9kIG9ic2VydmVzQmVmb3JlCiAgICBAZm9yIEZ1bmN0aW9uCiAgKi8KICBGdW5jdGlvbi5wcm90b3R5cGUub2JzZXJ2ZXNCZWZvcmUgPSBmdW5jdGlvbigpIHsKICAgIAogICAgICB0aGlzLl9fZW1iZXJfb2JzZXJ2ZXNCZWZvcmVfXyA9IGFfc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgCgogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLyoqCiAgICBUaGUgYG9uYCBleHRlbnNpb24gb2YgSmF2YXNjcmlwdCdzIEZ1bmN0aW9uIHByb3RvdHlwZSBpcyBhdmFpbGFibGUKICAgIHdoZW4gYEVtYmVyLkVYVEVORF9QUk9UT1RZUEVTYCBvciBgRW1iZXIuRVhURU5EX1BST1RPVFlQRVMuRnVuY3Rpb25gIGlzCiAgICB0cnVlLCB3aGljaCBpcyB0aGUgZGVmYXVsdC4KCiAgICBZb3UgY2FuIGxpc3RlbiBmb3IgZXZlbnRzIHNpbXBseSBieSBhZGRpbmcgdGhlIGBvbmAgY2FsbCB0byB0aGUgZW5kIG9mCiAgICB5b3VyIG1ldGhvZCBkZWNsYXJhdGlvbnMgaW4gY2xhc3NlcyBvciBtaXhpbnMgdGhhdCB5b3Ugd3JpdGUuIEZvciBleGFtcGxlOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIEVtYmVyLk1peGluLmNyZWF0ZSh7CiAgICAgIGRvU29tZXRoaW5nV2l0aEVsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIEV4ZWN1dGVzIHdoZW5ldmVyIHRoZSAiZGlkSW5zZXJ0RWxlbWVudCIgZXZlbnQgZmlyZXMKICAgICAgfS5vbignZGlkSW5zZXJ0RWxlbWVudCcpCiAgICB9KTsKICAgIGBgYAoKICAgIFNlZSBgRW1iZXIub25gLgoKICAgIEBtZXRob2Qgb24KICAgIEBmb3IgRnVuY3Rpb24KICAqLwogIEZ1bmN0aW9uLnByb3RvdHlwZS5vbiA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGV2ZW50cyA9IGFfc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgdGhpcy5fX2VtYmVyX2xpc3RlbnNfXyA9IGV2ZW50czsKICAgIHJldHVybiB0aGlzOwogIH07Cn0KCgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItcnVudGltZQoqLwoKCi8qKgogIEltcGxlbWVudHMgc29tZSBzdGFuZGFyZCBtZXRob2RzIGZvciBjb21wYXJpbmcgb2JqZWN0cy4gQWRkIHRoaXMgbWl4aW4gdG8KICBhbnkgY2xhc3MgeW91IGNyZWF0ZSB0aGF0IGNhbiBjb21wYXJlIGl0cyBpbnN0YW5jZXMuCgogIFlvdSBzaG91bGQgaW1wbGVtZW50IHRoZSBgY29tcGFyZSgpYCBtZXRob2QuCgogIEBjbGFzcyBDb21wYXJhYmxlCiAgQG5hbWVzcGFjZSBFbWJlcgogIEBzaW5jZSBFbWJlciAwLjkKKi8KRW1iZXIuQ29tcGFyYWJsZSA9IEVtYmVyLk1peGluLmNyZWF0ZSh7CgogIC8qKgogICAgT3ZlcnJpZGUgdG8gcmV0dXJuIHRoZSByZXN1bHQgb2YgdGhlIGNvbXBhcmlzb24gb2YgdGhlIHR3byBwYXJhbWV0ZXJzLiBUaGUKICAgIGNvbXBhcmUgbWV0aG9kIHNob3VsZCByZXR1cm46CgogICAgLSBgLTFgIGlmIGBhIDwgYmAKICAgIC0gYDBgIGlmIGBhID09IGJgCiAgICAtIGAxYCBpZiBgYSA+IGJgCgogICAgRGVmYXVsdCBpbXBsZW1lbnRhdGlvbiByYWlzZXMgYW4gZXhjZXB0aW9uLgoKICAgIEBtZXRob2QgY29tcGFyZQogICAgQHBhcmFtIGEge09iamVjdH0gdGhlIGZpcnN0IG9iamVjdCB0byBjb21wYXJlCiAgICBAcGFyYW0gYiB7T2JqZWN0fSB0aGUgc2Vjb25kIG9iamVjdCB0byBjb21wYXJlCiAgICBAcmV0dXJuIHtJbnRlZ2VyfSB0aGUgcmVzdWx0IG9mIHRoZSBjb21wYXJpc29uCiAgKi8KICBjb21wYXJlOiBFbWJlci5yZXF1aXJlZChGdW5jdGlvbikKCn0pOwoKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1ydW50aW1lCiovCgoKCnZhciBnZXQgPSBFbWJlci5nZXQsIHNldCA9IEVtYmVyLnNldDsKCi8qKgogIEltcGxlbWVudHMgc29tZSBzdGFuZGFyZCBtZXRob2RzIGZvciBjb3B5aW5nIGFuIG9iamVjdC4gQWRkIHRoaXMgbWl4aW4gdG8KICBhbnkgb2JqZWN0IHlvdSBjcmVhdGUgdGhhdCBjYW4gY3JlYXRlIGEgY29weSBvZiBpdHNlbGYuIFRoaXMgbWl4aW4gaXMKICBhZGRlZCBhdXRvbWF0aWNhbGx5IHRvIHRoZSBidWlsdC1pbiBhcnJheS4KCiAgWW91IHNob3VsZCBnZW5lcmFsbHkgaW1wbGVtZW50IHRoZSBgY29weSgpYCBtZXRob2QgdG8gcmV0dXJuIGEgY29weSBvZiB0aGUKICByZWNlaXZlci4KCiAgTm90ZSB0aGF0IGBmcm96ZW5Db3B5KClgIHdpbGwgb25seSB3b3JrIGlmIHlvdSBhbHNvIGltcGxlbWVudAogIGBFbWJlci5GcmVlemFibGVgLgoKICBAY2xhc3MgQ29weWFibGUKICBAbmFtZXNwYWNlIEVtYmVyCiAgQHNpbmNlIEVtYmVyIDAuOQoqLwpFbWJlci5Db3B5YWJsZSA9IEVtYmVyLk1peGluLmNyZWF0ZSh7CgogIC8qKgogICAgT3ZlcnJpZGUgdG8gcmV0dXJuIGEgY29weSBvZiB0aGUgcmVjZWl2ZXIuIERlZmF1bHQgaW1wbGVtZW50YXRpb24gcmFpc2VzCiAgICBhbiBleGNlcHRpb24uCgogICAgQG1ldGhvZCBjb3B5CiAgICBAcGFyYW0ge0Jvb2xlYW59IGRlZXAgaWYgYHRydWVgLCBhIGRlZXAgY29weSBvZiB0aGUgb2JqZWN0IHNob3VsZCBiZSBtYWRlCiAgICBAcmV0dXJuIHtPYmplY3R9IGNvcHkgb2YgcmVjZWl2ZXIKICAqLwogIGNvcHk6IEVtYmVyLnJlcXVpcmVkKEZ1bmN0aW9uKSwKCiAgLyoqCiAgICBJZiB0aGUgb2JqZWN0IGltcGxlbWVudHMgYEVtYmVyLkZyZWV6YWJsZWAsIHRoZW4gdGhpcyB3aWxsIHJldHVybiBhIG5ldwogICAgY29weSBpZiB0aGUgb2JqZWN0IGlzIG5vdCBmcm96ZW4gYW5kIHRoZSByZWNlaXZlciBpZiB0aGUgb2JqZWN0IGlzIGZyb3plbi4KCiAgICBSYWlzZXMgYW4gZXhjZXB0aW9uIGlmIHlvdSB0cnkgdG8gY2FsbCB0aGlzIG1ldGhvZCBvbiBhIG9iamVjdCB0aGF0IGRvZXMKICAgIG5vdCBzdXBwb3J0IGZyZWV6aW5nLgoKICAgIFlvdSBzaG91bGQgdXNlIHRoaXMgbWV0aG9kIHdoZW5ldmVyIHlvdSB3YW50IGEgY29weSBvZiBhIGZyZWV6YWJsZSBvYmplY3QKICAgIHNpbmNlIGEgZnJlZXphYmxlIG9iamVjdCBjYW4gc2ltcGx5IHJldHVybiBpdHNlbGYgd2l0aG91dCBhY3R1YWxseQogICAgY29uc3VtaW5nIG1vcmUgbWVtb3J5LgoKICAgIEBtZXRob2QgZnJvemVuQ29weQogICAgQHJldHVybiB7T2JqZWN0fSBjb3B5IG9mIHJlY2VpdmVyIG9yIHJlY2VpdmVyCiAgKi8KICBmcm96ZW5Db3B5OiBmdW5jdGlvbigpIHsKICAgIGlmIChFbWJlci5GcmVlemFibGUgJiYgRW1iZXIuRnJlZXphYmxlLmRldGVjdCh0aGlzKSkgewogICAgICByZXR1cm4gZ2V0KHRoaXMsICdpc0Zyb3plbicpID8gdGhpcyA6IHRoaXMuY29weSgpLmZyZWV6ZSgpOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVtYmVyLkVycm9yKEVtYmVyLlN0cmluZy5mbXQoIiVAIGRvZXMgbm90IHN1cHBvcnQgZnJlZXppbmciLCBbdGhpc10pKTsKICAgIH0KICB9Cn0pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLXJ1bnRpbWUKKi8KCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQ7CgovKioKICBUaGUgYEVtYmVyLkZyZWV6YWJsZWAgbWl4aW4gaW1wbGVtZW50cyBzb21lIGJhc2ljIG1ldGhvZHMgZm9yIG1hcmtpbmcgYW4KICBvYmplY3QgYXMgZnJvemVuLiBPbmNlIGFuIG9iamVjdCBpcyBmcm96ZW4gaXQgc2hvdWxkIGJlIHJlYWQgb25seS4gTm8gY2hhbmdlcwogIG1heSBiZSBtYWRlIHRoZSBpbnRlcm5hbCBzdGF0ZSBvZiB0aGUgb2JqZWN0LgoKICAjIyBFbmZvcmNlbWVudAoKICBUbyBmdWxseSBzdXBwb3J0IGZyZWV6aW5nIGluIHlvdXIgc3ViY2xhc3MsIHlvdSBtdXN0IGluY2x1ZGUgdGhpcyBtaXhpbiBhbmQKICBvdmVycmlkZSBhbnkgbWV0aG9kIHRoYXQgbWlnaHQgYWx0ZXIgYW55IHByb3BlcnR5IG9uIHRoZSBvYmplY3QgdG8gaW5zdGVhZAogIHJhaXNlIGFuIGV4Y2VwdGlvbi4gWW91IGNhbiBjaGVjayB0aGUgc3RhdGUgb2YgYW4gb2JqZWN0IGJ5IGNoZWNraW5nIHRoZQogIGBpc0Zyb3plbmAgcHJvcGVydHkuCgogIEFsdGhvdWdoIGZ1dHVyZSB2ZXJzaW9ucyBvZiBKYXZhU2NyaXB0IG1heSBzdXBwb3J0IGxhbmd1YWdlLWxldmVsIGZyZWV6aW5nCiAgb2JqZWN0IG9iamVjdHMsIHRoYXQgaXMgbm90IHRoZSBjYXNlIHRvZGF5LiBFdmVuIGlmIGFuIG9iamVjdCBpcyBmcmVlemFibGUsCiAgaXQgaXMgc3RpbGwgdGVjaG5pY2FsbHkgcG9zc2libGUgdG8gbW9kaWZ5IHRoZSBvYmplY3QsIGV2ZW4gdGhvdWdoIGl0IGNvdWxkCiAgYnJlYWsgb3RoZXIgcGFydHMgb2YgeW91ciBhcHBsaWNhdGlvbiB0aGF0IGRvIG5vdCBleHBlY3QgYSBmcm96ZW4gb2JqZWN0IHRvCiAgY2hhbmdlLiBJdCBpcywgdGhlcmVmb3JlLCB2ZXJ5IGltcG9ydGFudCB0aGF0IHlvdSBhbHdheXMgcmVzcGVjdCB0aGUKICBgaXNGcm96ZW5gIHByb3BlcnR5IG9uIGFsbCBmcmVlemFibGUgb2JqZWN0cy4KCiAgIyMgRXhhbXBsZSBVc2FnZQoKICBUaGUgZXhhbXBsZSBiZWxvdyBzaG93cyBhIHNpbXBsZSBvYmplY3QgdGhhdCBpbXBsZW1lbnQgdGhlIGBFbWJlci5GcmVlemFibGVgCiAgcHJvdG9jb2wuCgogIGBgYGphdmFzY3JpcHQKICBDb250YWN0ID0gRW1iZXIuT2JqZWN0LmV4dGVuZChFbWJlci5GcmVlemFibGUsIHsKICAgIGZpcnN0TmFtZTogbnVsbCwKICAgIGxhc3ROYW1lOiBudWxsLAoKICAgIC8vIHN3YXBzIHRoZSBuYW1lcwogICAgc3dhcE5hbWVzOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuZ2V0KCdpc0Zyb3plbicpKSB0aHJvdyBFbWJlci5GUk9aRU5fRVJST1I7CiAgICAgIHZhciB0bXAgPSB0aGlzLmdldCgnZmlyc3ROYW1lJyk7CiAgICAgIHRoaXMuc2V0KCdmaXJzdE5hbWUnLCB0aGlzLmdldCgnbGFzdE5hbWUnKSk7CiAgICAgIHRoaXMuc2V0KCdsYXN0TmFtZScsIHRtcCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICB9KTsKCiAgYyA9IENvbnRhY3QuY3JlYXRlKHsgZmlyc3ROYW1lOiAiSm9obiIsIGxhc3ROYW1lOiAiRG9lIiB9KTsKICBjLnN3YXBOYW1lcygpOyAgLy8gcmV0dXJucyBjCiAgYy5mcmVlemUoKTsKICBjLnN3YXBOYW1lcygpOyAgLy8gRVhDRVBUSU9OCiAgYGBgCgogICMjIENvcHlpbmcKCiAgVXN1YWxseSB0aGUgYEVtYmVyLkZyZWV6YWJsZWAgcHJvdG9jb2wgaXMgaW1wbGVtZW50ZWQgaW4gY29vcGVyYXRpb24gd2l0aCB0aGUKICBgRW1iZXIuQ29weWFibGVgIHByb3RvY29sLCB3aGljaCBkZWZpbmVzIGEgYGZyb3plbkNvcHkoKWAgbWV0aG9kIHRoYXQgd2lsbAogIHJldHVybiBhIGZyb3plbiBvYmplY3QsIGlmIHRoZSBvYmplY3QgaW1wbGVtZW50cyB0aGlzIG1ldGhvZCBhcyB3ZWxsLgoKICBAY2xhc3MgRnJlZXphYmxlCiAgQG5hbWVzcGFjZSBFbWJlcgogIEBzaW5jZSBFbWJlciAwLjkKKi8KRW1iZXIuRnJlZXphYmxlID0gRW1iZXIuTWl4aW4uY3JlYXRlKHsKCiAgLyoqCiAgICBTZXQgdG8gYHRydWVgIHdoZW4gdGhlIG9iamVjdCBpcyBmcm96ZW4uIFVzZSB0aGlzIHByb3BlcnR5IHRvIGRldGVjdAogICAgd2hldGhlciB5b3VyIG9iamVjdCBpcyBmcm96ZW4gb3Igbm90LgoKICAgIEBwcm9wZXJ0eSBpc0Zyb3plbgogICAgQHR5cGUgQm9vbGVhbgogICovCiAgaXNGcm96ZW46IGZhbHNlLAoKICAvKioKICAgIEZyZWV6ZXMgdGhlIG9iamVjdC4gT25jZSB0aGlzIG1ldGhvZCBoYXMgYmVlbiBjYWxsZWQgdGhlIG9iamVjdCBzaG91bGQKICAgIG5vIGxvbmdlciBhbGxvdyBhbnkgcHJvcGVydGllcyB0byBiZSBlZGl0ZWQuCgogICAgQG1ldGhvZCBmcmVlemUKICAgIEByZXR1cm4ge09iamVjdH0gcmVjZWl2ZXIKICAqLwogIGZyZWV6ZTogZnVuY3Rpb24oKSB7CiAgICBpZiAoZ2V0KHRoaXMsICdpc0Zyb3plbicpKSByZXR1cm4gdGhpczsKICAgIHNldCh0aGlzLCAnaXNGcm96ZW4nLCB0cnVlKTsKICAgIHJldHVybiB0aGlzOwogIH0KCn0pOwoKRW1iZXIuRlJPWkVOX0VSUk9SID0gIkZyb3plbiBvYmplY3QgY2Fubm90IGJlIG1vZGlmaWVkLiI7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItcnVudGltZQoqLwoKdmFyIGZvckVhY2ggPSBFbWJlci5FbnVtZXJhYmxlVXRpbHMuZm9yRWFjaDsKCi8qKgogIFRoaXMgbWl4aW4gZGVmaW5lcyB0aGUgQVBJIGZvciBtb2RpZnlpbmcgZ2VuZXJpYyBlbnVtZXJhYmxlcy4gVGhlc2UgbWV0aG9kcwogIGNhbiBiZSBhcHBsaWVkIHRvIGFuIG9iamVjdCByZWdhcmRsZXNzIG9mIHdoZXRoZXIgaXQgaXMgb3JkZXJlZCBvcgogIHVub3JkZXJlZC4KCiAgTm90ZSB0aGF0IGFuIEVudW1lcmFibGUgY2FuIGNoYW5nZSBldmVuIGlmIGl0IGRvZXMgbm90IGltcGxlbWVudCB0aGlzIG1peGluLgogIEZvciBleGFtcGxlLCBhIE1hcHBlZEVudW1lcmFibGUgY2Fubm90IGJlIGRpcmVjdGx5IG1vZGlmaWVkIGJ1dCBpZiBpdHMKICB1bmRlcmx5aW5nIGVudW1lcmFibGUgY2hhbmdlcywgaXQgd2lsbCBjaGFuZ2UgYWxzby4KCiAgIyMgQWRkaW5nIE9iamVjdHMKCiAgVG8gYWRkIGFuIG9iamVjdCB0byBhbiBlbnVtZXJhYmxlLCB1c2UgdGhlIGBhZGRPYmplY3QoKWAgbWV0aG9kLiBUaGlzCiAgbWV0aG9kIHdpbGwgb25seSBhZGQgdGhlIG9iamVjdCB0byB0aGUgZW51bWVyYWJsZSBpZiB0aGUgb2JqZWN0IGlzIG5vdAogIGFscmVhZHkgcHJlc2VudCBhbmQgaXMgb2YgYSB0eXBlIHN1cHBvcnRlZCBieSB0aGUgZW51bWVyYWJsZS4KCiAgYGBgamF2YXNjcmlwdAogIHNldC5hZGRPYmplY3QoY29udGFjdCk7CiAgYGBgCgogICMjIFJlbW92aW5nIE9iamVjdHMKCiAgVG8gcmVtb3ZlIGFuIG9iamVjdCBmcm9tIGFuIGVudW1lcmFibGUsIHVzZSB0aGUgYHJlbW92ZU9iamVjdCgpYCBtZXRob2QuIFRoaXMKICB3aWxsIG9ubHkgcmVtb3ZlIHRoZSBvYmplY3QgaWYgaXQgaXMgcHJlc2VudCBpbiB0aGUgZW51bWVyYWJsZSwgb3RoZXJ3aXNlCiAgdGhpcyBtZXRob2QgaGFzIG5vIGVmZmVjdC4KCiAgYGBgamF2YXNjcmlwdAogIHNldC5yZW1vdmVPYmplY3QoY29udGFjdCk7CiAgYGBgCgogICMjIEltcGxlbWVudGluZyBJbiBZb3VyIE93biBDb2RlCgogIElmIHlvdSBhcmUgaW1wbGVtZW50aW5nIGFuIG9iamVjdCBhbmQgd2FudCB0byBzdXBwb3J0IHRoaXMgQVBJLCBqdXN0IGluY2x1ZGUKICB0aGlzIG1peGluIGluIHlvdXIgY2xhc3MgYW5kIGltcGxlbWVudCB0aGUgcmVxdWlyZWQgbWV0aG9kcy4gSW4geW91ciB1bml0CiAgdGVzdHMsIGJlIHN1cmUgdG8gYXBwbHkgdGhlIEVtYmVyLk11dGFibGVFbnVtZXJhYmxlVGVzdHMgdG8geW91ciBvYmplY3QuCgogIEBjbGFzcyBNdXRhYmxlRW51bWVyYWJsZQogIEBuYW1lc3BhY2UgRW1iZXIKICBAdXNlcyBFbWJlci5FbnVtZXJhYmxlCiovCkVtYmVyLk11dGFibGVFbnVtZXJhYmxlID0gRW1iZXIuTWl4aW4uY3JlYXRlKEVtYmVyLkVudW1lcmFibGUsIHsKCiAgLyoqCiAgICBfX1JlcXVpcmVkLl9fIFlvdSBtdXN0IGltcGxlbWVudCB0aGlzIG1ldGhvZCB0byBhcHBseSB0aGlzIG1peGluLgoKICAgIEF0dGVtcHRzIHRvIGFkZCB0aGUgcGFzc2VkIG9iamVjdCB0byB0aGUgcmVjZWl2ZXIgaWYgdGhlIG9iamVjdCBpcyBub3QKICAgIGFscmVhZHkgcHJlc2VudCBpbiB0aGUgY29sbGVjdGlvbi4gSWYgdGhlIG9iamVjdCBpcyBwcmVzZW50LCB0aGlzIG1ldGhvZAogICAgaGFzIG5vIGVmZmVjdC4KCiAgICBJZiB0aGUgcGFzc2VkIG9iamVjdCBpcyBvZiBhIHR5cGUgbm90IHN1cHBvcnRlZCBieSB0aGUgcmVjZWl2ZXIsCiAgICB0aGVuIHRoaXMgbWV0aG9kIHNob3VsZCByYWlzZSBhbiBleGNlcHRpb24uCgogICAgQG1ldGhvZCBhZGRPYmplY3QKICAgIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBhZGQgdG8gdGhlIGVudW1lcmFibGUuCiAgICBAcmV0dXJuIHtPYmplY3R9IHRoZSBwYXNzZWQgb2JqZWN0CiAgKi8KICBhZGRPYmplY3Q6IEVtYmVyLnJlcXVpcmVkKEZ1bmN0aW9uKSwKCiAgLyoqCiAgICBBZGRzIGVhY2ggb2JqZWN0IGluIHRoZSBwYXNzZWQgZW51bWVyYWJsZSB0byB0aGUgcmVjZWl2ZXIuCgogICAgQG1ldGhvZCBhZGRPYmplY3RzCiAgICBAcGFyYW0ge0VtYmVyLkVudW1lcmFibGV9IG9iamVjdHMgdGhlIG9iamVjdHMgdG8gYWRkLgogICAgQHJldHVybiB7T2JqZWN0fSByZWNlaXZlcgogICovCiAgYWRkT2JqZWN0czogZnVuY3Rpb24ob2JqZWN0cykgewogICAgRW1iZXIuYmVnaW5Qcm9wZXJ0eUNoYW5nZXModGhpcyk7CiAgICBmb3JFYWNoKG9iamVjdHMsIGZ1bmN0aW9uKG9iaikgeyB0aGlzLmFkZE9iamVjdChvYmopOyB9LCB0aGlzKTsKICAgIEVtYmVyLmVuZFByb3BlcnR5Q2hhbmdlcyh0aGlzKTsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAgX19SZXF1aXJlZC5fXyBZb3UgbXVzdCBpbXBsZW1lbnQgdGhpcyBtZXRob2QgdG8gYXBwbHkgdGhpcyBtaXhpbi4KCiAgICBBdHRlbXB0cyB0byByZW1vdmUgdGhlIHBhc3NlZCBvYmplY3QgZnJvbSB0aGUgcmVjZWl2ZXIgY29sbGVjdGlvbiBpZiB0aGUKICAgIG9iamVjdCBpcyBwcmVzZW50IGluIHRoZSBjb2xsZWN0aW9uLiBJZiB0aGUgb2JqZWN0IGlzIG5vdCBwcmVzZW50LAogICAgdGhpcyBtZXRob2QgaGFzIG5vIGVmZmVjdC4KCiAgICBJZiB0aGUgcGFzc2VkIG9iamVjdCBpcyBvZiBhIHR5cGUgbm90IHN1cHBvcnRlZCBieSB0aGUgcmVjZWl2ZXIsCiAgICB0aGVuIHRoaXMgbWV0aG9kIHNob3VsZCByYWlzZSBhbiBleGNlcHRpb24uCgogICAgQG1ldGhvZCByZW1vdmVPYmplY3QKICAgIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byByZW1vdmUgZnJvbSB0aGUgZW51bWVyYWJsZS4KICAgIEByZXR1cm4ge09iamVjdH0gdGhlIHBhc3NlZCBvYmplY3QKICAqLwogIHJlbW92ZU9iamVjdDogRW1iZXIucmVxdWlyZWQoRnVuY3Rpb24pLAoKCiAgLyoqCiAgICBSZW1vdmVzIGVhY2ggb2JqZWN0IGluIHRoZSBwYXNzZWQgZW51bWVyYWJsZSBmcm9tIHRoZSByZWNlaXZlci4KCiAgICBAbWV0aG9kIHJlbW92ZU9iamVjdHMKICAgIEBwYXJhbSB7RW1iZXIuRW51bWVyYWJsZX0gb2JqZWN0cyB0aGUgb2JqZWN0cyB0byByZW1vdmUKICAgIEByZXR1cm4ge09iamVjdH0gcmVjZWl2ZXIKICAqLwogIHJlbW92ZU9iamVjdHM6IGZ1bmN0aW9uKG9iamVjdHMpIHsKICAgIEVtYmVyLmJlZ2luUHJvcGVydHlDaGFuZ2VzKHRoaXMpOwogICAgZm9yRWFjaChvYmplY3RzLCBmdW5jdGlvbihvYmopIHsgdGhpcy5yZW1vdmVPYmplY3Qob2JqKTsgfSwgdGhpcyk7CiAgICBFbWJlci5lbmRQcm9wZXJ0eUNoYW5nZXModGhpcyk7CiAgICByZXR1cm4gdGhpczsKICB9Cgp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1ydW50aW1lCiovCi8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KLy8gQ09OU1RBTlRTCi8vCgp2YXIgT1VUX09GX1JBTkdFX0VYQ0VQVElPTiA9ICJJbmRleCBvdXQgb2YgcmFuZ2UiIDsKdmFyIEVNUFRZID0gW107CgovLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCi8vIEhFTFBFUlMKLy8KCnZhciBnZXQgPSBFbWJlci5nZXQsIHNldCA9IEVtYmVyLnNldDsKCi8qKgogIFRoaXMgbWl4aW4gZGVmaW5lcyB0aGUgQVBJIGZvciBtb2RpZnlpbmcgYXJyYXktbGlrZSBvYmplY3RzLiBUaGVzZSBtZXRob2RzCiAgY2FuIGJlIGFwcGxpZWQgb25seSB0byBhIGNvbGxlY3Rpb24gdGhhdCBrZWVwcyBpdHMgaXRlbXMgaW4gYW4gb3JkZXJlZCBzZXQuCgogIE5vdGUgdGhhdCBhbiBBcnJheSBjYW4gY2hhbmdlIGV2ZW4gaWYgaXQgZG9lcyBub3QgaW1wbGVtZW50IHRoaXMgbWl4aW4uCiAgRm9yIGV4YW1wbGUsIG9uZSBtaWdodCBpbXBsZW1lbnQgYSBTcGFyc2VBcnJheSB0aGF0IGNhbm5vdCBiZSBkaXJlY3RseQogIG1vZGlmaWVkLCBidXQgaWYgaXRzIHVuZGVybHlpbmcgZW51bWVyYWJsZSBjaGFuZ2VzLCBpdCB3aWxsIGNoYW5nZSBhbHNvLgoKICBAY2xhc3MgTXV0YWJsZUFycmF5CiAgQG5hbWVzcGFjZSBFbWJlcgogIEB1c2VzIEVtYmVyLkFycmF5CiAgQHVzZXMgRW1iZXIuTXV0YWJsZUVudW1lcmFibGUKKi8KRW1iZXIuTXV0YWJsZUFycmF5ID0gRW1iZXIuTWl4aW4uY3JlYXRlKEVtYmVyLkFycmF5LCBFbWJlci5NdXRhYmxlRW51bWVyYWJsZSwgewoKICAvKioKICAgIF9fUmVxdWlyZWQuX18gWW91IG11c3QgaW1wbGVtZW50IHRoaXMgbWV0aG9kIHRvIGFwcGx5IHRoaXMgbWl4aW4uCgogICAgVGhpcyBpcyBvbmUgb2YgdGhlIHByaW1pdGl2ZXMgeW91IG11c3QgaW1wbGVtZW50IHRvIHN1cHBvcnQgYEVtYmVyLkFycmF5YC4KICAgIFlvdSBzaG91bGQgcmVwbGFjZSBhbXQgb2JqZWN0cyBzdGFydGVkIGF0IGlkeCB3aXRoIHRoZSBvYmplY3RzIGluIHRoZQogICAgcGFzc2VkIGFycmF5LiBZb3Ugc2hvdWxkIGFsc28gY2FsbCBgdGhpcy5lbnVtZXJhYmxlQ29udGVudERpZENoYW5nZSgpYAoKICAgIEBtZXRob2QgcmVwbGFjZQogICAgQHBhcmFtIHtOdW1iZXJ9IGlkeCBTdGFydGluZyBpbmRleCBpbiB0aGUgYXJyYXkgdG8gcmVwbGFjZS4gSWYKICAgICAgaWR4ID49IGxlbmd0aCwgdGhlbiBhcHBlbmQgdG8gdGhlIGVuZCBvZiB0aGUgYXJyYXkuCiAgICBAcGFyYW0ge051bWJlcn0gYW10IE51bWJlciBvZiBlbGVtZW50cyB0aGF0IHNob3VsZCBiZSByZW1vdmVkIGZyb20KICAgICAgdGhlIGFycmF5LCBzdGFydGluZyBhdCAqaWR4Ki4KICAgIEBwYXJhbSB7QXJyYXl9IG9iamVjdHMgQW4gYXJyYXkgb2YgemVybyBvciBtb3JlIG9iamVjdHMgdGhhdCBzaG91bGQgYmUKICAgICAgaW5zZXJ0ZWQgaW50byB0aGUgYXJyYXkgYXQgKmlkeCoKICAqLwogIHJlcGxhY2U6IEVtYmVyLnJlcXVpcmVkKCksCgogIC8qKgogICAgUmVtb3ZlIGFsbCBlbGVtZW50cyBmcm9tIHNlbGYuIFRoaXMgaXMgdXNlZnVsIGlmIHlvdQogICAgd2FudCB0byByZXVzZSBhbiBleGlzdGluZyBhcnJheSB3aXRob3V0IGhhdmluZyB0byByZWNyZWF0ZSBpdC4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgY29sb3JzID0gWyJyZWQiLCAiZ3JlZW4iLCAiYmx1ZSJdOwogICAgY29sb3IubGVuZ3RoKCk7ICAgLy8gIDMKICAgIGNvbG9ycy5jbGVhcigpOyAgIC8vICBbXQogICAgY29sb3JzLmxlbmd0aCgpOyAgLy8gIDAKICAgIGBgYAoKICAgIEBtZXRob2QgY2xlYXIKICAgIEByZXR1cm4ge0VtYmVyLkFycmF5fSBBbiBlbXB0eSBBcnJheS4KICAqLwogIGNsZWFyOiBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbGVuID0gZ2V0KHRoaXMsICdsZW5ndGgnKTsKICAgIGlmIChsZW4gPT09IDApIHJldHVybiB0aGlzOwogICAgdGhpcy5yZXBsYWNlKDAsIGxlbiwgRU1QVFkpOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICBUaGlzIHdpbGwgdXNlIHRoZSBwcmltaXRpdmUgYHJlcGxhY2UoKWAgbWV0aG9kIHRvIGluc2VydCBhbiBvYmplY3QgYXQgdGhlCiAgICBzcGVjaWZpZWQgaW5kZXguCgogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIGNvbG9ycyA9IFsicmVkIiwgImdyZWVuIiwgImJsdWUiXTsKICAgIGNvbG9ycy5pbnNlcnRBdCgyLCAieWVsbG93Iik7ICAvLyBbInJlZCIsICJncmVlbiIsICJ5ZWxsb3ciLCAiYmx1ZSJdCiAgICBjb2xvcnMuaW5zZXJ0QXQoNSwgIm9yYW5nZSIpOyAgLy8gRXJyb3I6IEluZGV4IG91dCBvZiByYW5nZQogICAgYGBgCgogICAgQG1ldGhvZCBpbnNlcnRBdAogICAgQHBhcmFtIHtOdW1iZXJ9IGlkeCBpbmRleCBvZiBpbnNlcnQgdGhlIG9iamVjdCBhdC4KICAgIEBwYXJhbSB7T2JqZWN0fSBvYmplY3Qgb2JqZWN0IHRvIGluc2VydAogICAgQHJldHVybiB0aGlzCiAgKi8KICBpbnNlcnRBdDogZnVuY3Rpb24oaWR4LCBvYmplY3QpIHsKICAgIGlmIChpZHggPiBnZXQodGhpcywgJ2xlbmd0aCcpKSB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoT1VUX09GX1JBTkdFX0VYQ0VQVElPTikgOwogICAgdGhpcy5yZXBsYWNlKGlkeCwgMCwgW29iamVjdF0pIDsKICAgIHJldHVybiB0aGlzIDsKICB9LAoKICAvKioKICAgIFJlbW92ZSBhbiBvYmplY3QgYXQgdGhlIHNwZWNpZmllZCBpbmRleCB1c2luZyB0aGUgYHJlcGxhY2UoKWAgcHJpbWl0aXZlCiAgICBtZXRob2QuIFlvdSBjYW4gcGFzcyBlaXRoZXIgYSBzaW5nbGUgaW5kZXgsIG9yIGEgc3RhcnQgYW5kIGEgbGVuZ3RoLgoKICAgIElmIHlvdSBwYXNzIGEgc3RhcnQgYW5kIGxlbmd0aCB0aGF0IGlzIGJleW9uZCB0aGUKICAgIGxlbmd0aCB0aGlzIG1ldGhvZCB3aWxsIHRocm93IGFuIGBPVVRfT0ZfUkFOR0VfRVhDRVBUSU9OYC4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgY29sb3JzID0gWyJyZWQiLCAiZ3JlZW4iLCAiYmx1ZSIsICJ5ZWxsb3ciLCAib3JhbmdlIl07CiAgICBjb2xvcnMucmVtb3ZlQXQoMCk7ICAgICAvLyBbImdyZWVuIiwgImJsdWUiLCAieWVsbG93IiwgIm9yYW5nZSJdCiAgICBjb2xvcnMucmVtb3ZlQXQoMiwgMik7ICAvLyBbImdyZWVuIiwgImJsdWUiXQogICAgY29sb3JzLnJlbW92ZUF0KDQsIDIpOyAgLy8gRXJyb3I6IEluZGV4IG91dCBvZiByYW5nZQogICAgYGBgCgogICAgQG1ldGhvZCByZW1vdmVBdAogICAgQHBhcmFtIHtOdW1iZXJ9IHN0YXJ0IGluZGV4LCBzdGFydCBvZiByYW5nZQogICAgQHBhcmFtIHtOdW1iZXJ9IGxlbiBsZW5ndGggb2YgcGFzc2luZyByYW5nZQogICAgQHJldHVybiB7T2JqZWN0fSByZWNlaXZlcgogICovCiAgcmVtb3ZlQXQ6IGZ1bmN0aW9uKHN0YXJ0LCBsZW4pIHsKICAgIGlmICgnbnVtYmVyJyA9PT0gdHlwZW9mIHN0YXJ0KSB7CgogICAgICBpZiAoKHN0YXJ0IDwgMCkgfHwgKHN0YXJ0ID49IGdldCh0aGlzLCAnbGVuZ3RoJykpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVtYmVyLkVycm9yKE9VVF9PRl9SQU5HRV9FWENFUFRJT04pOwogICAgICB9CgogICAgICAvLyBmYXN0IGNhc2UKICAgICAgaWYgKGxlbiA9PT0gdW5kZWZpbmVkKSBsZW4gPSAxOwogICAgICB0aGlzLnJlcGxhY2Uoc3RhcnQsIGxlbiwgRU1QVFkpOwogICAgfQoKICAgIHJldHVybiB0aGlzIDsKICB9LAoKICAvKioKICAgIFB1c2ggdGhlIG9iamVjdCBvbnRvIHRoZSBlbmQgb2YgdGhlIGFycmF5LiBXb3JrcyBqdXN0IGxpa2UgYHB1c2goKWAgYnV0IGl0CiAgICBpcyBLVk8tY29tcGxpYW50LgoKICAgIGBgYGphdmFzY3JpcHQKICAgIHZhciBjb2xvcnMgPSBbInJlZCIsICJncmVlbiJdOwogICAgY29sb3JzLnB1c2hPYmplY3QoImJsYWNrIik7ICAgICAvLyBbInJlZCIsICJncmVlbiIsICJibGFjayJdCiAgICBjb2xvcnMucHVzaE9iamVjdChbInllbGxvdyJdKTsgIC8vIFsicmVkIiwgImdyZWVuIiwgWyJ5ZWxsb3ciXV0KICAgIGBgYAoKICAgIEBtZXRob2QgcHVzaE9iamVjdAogICAgQHBhcmFtIHsqfSBvYmogb2JqZWN0IHRvIHB1c2gKICAgIEByZXR1cm4gVGhlIHNhbWUgb2JqIHBhc3NlZCBhcyBwYXJhbQogICovCiAgcHVzaE9iamVjdDogZnVuY3Rpb24ob2JqKSB7CiAgICB0aGlzLmluc2VydEF0KGdldCh0aGlzLCAnbGVuZ3RoJyksIG9iaikgOwogICAgcmV0dXJuIG9iajsKICB9LAoKICAvKioKICAgIEFkZCB0aGUgb2JqZWN0cyBpbiB0aGUgcGFzc2VkIG51bWVyYWJsZSB0byB0aGUgZW5kIG9mIHRoZSBhcnJheS4gRGVmZXJzCiAgICBub3RpZnlpbmcgb2JzZXJ2ZXJzIG9mIHRoZSBjaGFuZ2UgdW50aWwgYWxsIG9iamVjdHMgYXJlIGFkZGVkLgoKICAgIGBgYGphdmFzY3JpcHQKICAgIHZhciBjb2xvcnMgPSBbInJlZCJdOwogICAgY29sb3JzLnB1c2hPYmplY3RzKFsieWVsbG93IiwgIm9yYW5nZSJdKTsgIC8vIFsicmVkIiwgInllbGxvdyIsICJvcmFuZ2UiXQogICAgYGBgCgogICAgQG1ldGhvZCBwdXNoT2JqZWN0cwogICAgQHBhcmFtIHtFbWJlci5FbnVtZXJhYmxlfSBvYmplY3RzIHRoZSBvYmplY3RzIHRvIGFkZAogICAgQHJldHVybiB7RW1iZXIuQXJyYXl9IHJlY2VpdmVyCiAgKi8KICBwdXNoT2JqZWN0czogZnVuY3Rpb24ob2JqZWN0cykgewogICAgaWYgKCEoRW1iZXIuRW51bWVyYWJsZS5kZXRlY3Qob2JqZWN0cykgfHwgRW1iZXIuaXNBcnJheShvYmplY3RzKSkpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiTXVzdCBwYXNzIEVtYmVyLkVudW1lcmFibGUgdG8gRW1iZXIuTXV0YWJsZUFycmF5I3B1c2hPYmplY3RzIik7CiAgICB9CiAgICB0aGlzLnJlcGxhY2UoZ2V0KHRoaXMsICdsZW5ndGgnKSwgMCwgb2JqZWN0cyk7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvKioKICAgIFBvcCBvYmplY3QgZnJvbSBhcnJheSBvciBuaWwgaWYgbm9uZSBhcmUgbGVmdC4gV29ya3MganVzdCBsaWtlIGBwb3AoKWAgYnV0CiAgICBpdCBpcyBLVk8tY29tcGxpYW50LgoKICAgIGBgYGphdmFzY3JpcHQKICAgIHZhciBjb2xvcnMgPSBbInJlZCIsICJncmVlbiIsICJibHVlIl07CiAgICBjb2xvcnMucG9wT2JqZWN0KCk7ICAgLy8gImJsdWUiCiAgICBjb25zb2xlLmxvZyhjb2xvcnMpOyAgLy8gWyJyZWQiLCAiZ3JlZW4iXQogICAgYGBgCgogICAgQG1ldGhvZCBwb3BPYmplY3QKICAgIEByZXR1cm4gb2JqZWN0CiAgKi8KICBwb3BPYmplY3Q6IGZ1bmN0aW9uKCkgewogICAgdmFyIGxlbiA9IGdldCh0aGlzLCAnbGVuZ3RoJykgOwogICAgaWYgKGxlbiA9PT0gMCkgcmV0dXJuIG51bGwgOwoKICAgIHZhciByZXQgPSB0aGlzLm9iamVjdEF0KGxlbi0xKSA7CiAgICB0aGlzLnJlbW92ZUF0KGxlbi0xLCAxKSA7CiAgICByZXR1cm4gcmV0IDsKICB9LAoKICAvKioKICAgIFNoaWZ0IGFuIG9iamVjdCBmcm9tIHN0YXJ0IG9mIGFycmF5IG9yIG5pbCBpZiBub25lIGFyZSBsZWZ0LiBXb3JrcyBqdXN0CiAgICBsaWtlIGBzaGlmdCgpYCBidXQgaXQgaXMgS1ZPLWNvbXBsaWFudC4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgY29sb3JzID0gWyJyZWQiLCAiZ3JlZW4iLCAiYmx1ZSJdOwogICAgY29sb3JzLnNoaWZ0T2JqZWN0KCk7ICAvLyAicmVkIgogICAgY29uc29sZS5sb2coY29sb3JzKTsgICAvLyBbImdyZWVuIiwgImJsdWUiXQogICAgYGBgCgogICAgQG1ldGhvZCBzaGlmdE9iamVjdAogICAgQHJldHVybiBvYmplY3QKICAqLwogIHNoaWZ0T2JqZWN0OiBmdW5jdGlvbigpIHsKICAgIGlmIChnZXQodGhpcywgJ2xlbmd0aCcpID09PSAwKSByZXR1cm4gbnVsbCA7CiAgICB2YXIgcmV0ID0gdGhpcy5vYmplY3RBdCgwKSA7CiAgICB0aGlzLnJlbW92ZUF0KDApIDsKICAgIHJldHVybiByZXQgOwogIH0sCgogIC8qKgogICAgVW5zaGlmdCBhbiBvYmplY3QgdG8gc3RhcnQgb2YgYXJyYXkuIFdvcmtzIGp1c3QgbGlrZSBgdW5zaGlmdCgpYCBidXQgaXQgaXMKICAgIEtWTy1jb21wbGlhbnQuCgogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIGNvbG9ycyA9IFsicmVkIl07CiAgICBjb2xvcnMudW5zaGlmdE9iamVjdCgieWVsbG93Iik7ICAgIC8vIFsieWVsbG93IiwgInJlZCJdCiAgICBjb2xvcnMudW5zaGlmdE9iamVjdChbImJsYWNrIl0pOyAgIC8vIFtbImJsYWNrIl0sICJ5ZWxsb3ciLCAicmVkIl0KICAgIGBgYAoKICAgIEBtZXRob2QgdW5zaGlmdE9iamVjdAogICAgQHBhcmFtIHsqfSBvYmogb2JqZWN0IHRvIHVuc2hpZnQKICAgIEByZXR1cm4gVGhlIHNhbWUgb2JqIHBhc3NlZCBhcyBwYXJhbQogICovCiAgdW5zaGlmdE9iamVjdDogZnVuY3Rpb24ob2JqKSB7CiAgICB0aGlzLmluc2VydEF0KDAsIG9iaikgOwogICAgcmV0dXJuIG9iaiA7CiAgfSwKCiAgLyoqCiAgICBBZGRzIHRoZSBuYW1lZCBvYmplY3RzIHRvIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGFycmF5LiBEZWZlcnMgbm90aWZ5aW5nCiAgICBvYnNlcnZlcnMgdW50aWwgYWxsIG9iamVjdHMgaGF2ZSBiZWVuIGFkZGVkLgoKICAgIGBgYGphdmFzY3JpcHQKICAgIHZhciBjb2xvcnMgPSBbInJlZCJdOwogICAgY29sb3JzLnVuc2hpZnRPYmplY3RzKFsiYmxhY2siLCAid2hpdGUiXSk7ICAgLy8gWyJibGFjayIsICJ3aGl0ZSIsICJyZWQiXQogICAgY29sb3JzLnVuc2hpZnRPYmplY3RzKCJ5ZWxsb3ciKTsgLy8gVHlwZSBFcnJvcjogJ3VuZGVmaW5lZCcgaXMgbm90IGEgZnVuY3Rpb24KICAgIGBgYAoKICAgIEBtZXRob2QgdW5zaGlmdE9iamVjdHMKICAgIEBwYXJhbSB7RW1iZXIuRW51bWVyYWJsZX0gb2JqZWN0cyB0aGUgb2JqZWN0cyB0byBhZGQKICAgIEByZXR1cm4ge0VtYmVyLkFycmF5fSByZWNlaXZlcgogICovCiAgdW5zaGlmdE9iamVjdHM6IGZ1bmN0aW9uKG9iamVjdHMpIHsKICAgIHRoaXMucmVwbGFjZSgwLCAwLCBvYmplY3RzKTsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAgUmV2ZXJzZSBvYmplY3RzIGluIHRoZSBhcnJheS4gV29ya3MganVzdCBsaWtlIGByZXZlcnNlKClgIGJ1dCBpdCBpcwogICAgS1ZPLWNvbXBsaWFudC4KCiAgICBAbWV0aG9kIHJldmVyc2VPYmplY3RzCiAgICBAcmV0dXJuIHtFbWJlci5BcnJheX0gcmVjZWl2ZXIKICAgKi8KICByZXZlcnNlT2JqZWN0czogZnVuY3Rpb24oKSB7CiAgICB2YXIgbGVuID0gZ2V0KHRoaXMsICdsZW5ndGgnKTsKICAgIGlmIChsZW4gPT09IDApIHJldHVybiB0aGlzOwogICAgdmFyIG9iamVjdHMgPSB0aGlzLnRvQXJyYXkoKS5yZXZlcnNlKCk7CiAgICB0aGlzLnJlcGxhY2UoMCwgbGVuLCBvYmplY3RzKTsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAgUmVwbGFjZSBhbGwgdGhlIHRoZSByZWNlaXZlcidzIGNvbnRlbnQgd2l0aCBjb250ZW50IG9mIHRoZSBhcmd1bWVudC4KICAgIElmIGFyZ3VtZW50IGlzIGFuIGVtcHR5IGFycmF5IHJlY2VpdmVyIHdpbGwgYmUgY2xlYXJlZC4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgY29sb3JzID0gWyJyZWQiLCAiZ3JlZW4iLCAiYmx1ZSJdOwogICAgY29sb3JzLnNldE9iamVjdHMoWyJibGFjayIsICJ3aGl0ZSJdKTsgIC8vIFsiYmxhY2siLCAid2hpdGUiXQogICAgY29sb3JzLnNldE9iamVjdHMoW10pOyAgICAgICAgICAgICAgICAgIC8vIFtdCiAgICBgYGAKCiAgICBAbWV0aG9kIHNldE9iamVjdHMKICAgIEBwYXJhbSB7RW1iZXIuQXJyYXl9IG9iamVjdHMgYXJyYXkgd2hvc2UgY29udGVudCB3aWxsIGJlIHVzZWQgZm9yIHJlcGxhY2luZwogICAgICAgIHRoZSBjb250ZW50IG9mIHRoZSByZWNlaXZlcgogICAgQHJldHVybiB7RW1iZXIuQXJyYXl9IHJlY2VpdmVyIHdpdGggdGhlIG5ldyBjb250ZW50CiAgICovCiAgc2V0T2JqZWN0czogZnVuY3Rpb24ob2JqZWN0cykgewogICAgaWYgKG9iamVjdHMubGVuZ3RoID09PSAwKSByZXR1cm4gdGhpcy5jbGVhcigpOwoKICAgIHZhciBsZW4gPSBnZXQodGhpcywgJ2xlbmd0aCcpOwogICAgdGhpcy5yZXBsYWNlKDAsIGxlbiwgb2JqZWN0cyk7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCiAgLy8gSU1QTEVNRU5UIEVtYmVyLk11dGFibGVFbnVtZXJhYmxlCiAgLy8KCiAgcmVtb3ZlT2JqZWN0OiBmdW5jdGlvbihvYmopIHsKICAgIHZhciBsb2MgPSBnZXQodGhpcywgJ2xlbmd0aCcpIHx8IDA7CiAgICB3aGlsZSgtLWxvYyA+PSAwKSB7CiAgICAgIHZhciBjdXJPYmplY3QgPSB0aGlzLm9iamVjdEF0KGxvYykgOwogICAgICBpZiAoY3VyT2JqZWN0ID09PSBvYmopIHRoaXMucmVtb3ZlQXQobG9jKSA7CiAgICB9CiAgICByZXR1cm4gdGhpcyA7CiAgfSwKCiAgYWRkT2JqZWN0OiBmdW5jdGlvbihvYmopIHsKICAgIGlmICghdGhpcy5jb250YWlucyhvYmopKSB0aGlzLnB1c2hPYmplY3Qob2JqKTsKICAgIHJldHVybiB0aGlzIDsKICB9Cgp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1ydW50aW1lCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQ7CgovKioKYEVtYmVyLlRhcmdldEFjdGlvblN1cHBvcnRgIGlzIGEgbWl4aW4gdGhhdCBjYW4gYmUgaW5jbHVkZWQgaW4gYSBjbGFzcwp0byBhZGQgYSBgdHJpZ2dlckFjdGlvbmAgbWV0aG9kIHdpdGggc2VtYW50aWNzIHNpbWlsYXIgdG8gdGhlIEhhbmRsZWJhcnMKYHt7YWN0aW9ufX1gIGhlbHBlci4gSW4gbm9ybWFsIEVtYmVyIHVzYWdlLCB0aGUgYHt7YWN0aW9ufX1gIGhlbHBlciBpcwp1c3VhbGx5IHRoZSBiZXN0IGNob2ljZS4gVGhpcyBtaXhpbiBpcyBtb3N0IG9mdGVuIHVzZWZ1bCB3aGVuIHlvdSBhcmUKZG9pbmcgbW9yZSBjb21wbGV4IGV2ZW50IGhhbmRsaW5nIGluIFZpZXcgb2JqZWN0cy4KClNlZSBhbHNvIGBFbWJlci5WaWV3VGFyZ2V0QWN0aW9uU3VwcG9ydGAsIHdoaWNoIGhhcwp2aWV3LWF3YXJlIGRlZmF1bHRzIGZvciB0YXJnZXQgYW5kIGFjdGlvbkNvbnRleHQuCgpAY2xhc3MgVGFyZ2V0QWN0aW9uU3VwcG9ydApAbmFtZXNwYWNlIEVtYmVyCkBleHRlbmRzIEVtYmVyLk1peGluCiovCkVtYmVyLlRhcmdldEFjdGlvblN1cHBvcnQgPSBFbWJlci5NaXhpbi5jcmVhdGUoewogIHRhcmdldDogbnVsbCwKICBhY3Rpb246IG51bGwsCiAgYWN0aW9uQ29udGV4dDogbnVsbCwKCiAgdGFyZ2V0T2JqZWN0OiBFbWJlci5jb21wdXRlZChmdW5jdGlvbigpIHsKICAgIHZhciB0YXJnZXQgPSBnZXQodGhpcywgJ3RhcmdldCcpOwoKICAgIGlmIChFbWJlci50eXBlT2YodGFyZ2V0KSA9PT0gInN0cmluZyIpIHsKICAgICAgdmFyIHZhbHVlID0gZ2V0KHRoaXMsIHRhcmdldCk7CiAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7IHZhbHVlID0gZ2V0KEVtYmVyLmxvb2t1cCwgdGFyZ2V0KTsgfQogICAgICByZXR1cm4gdmFsdWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogIH0pLnByb3BlcnR5KCd0YXJnZXQnKSwKCiAgYWN0aW9uQ29udGV4dE9iamVjdDogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oKSB7CiAgICB2YXIgYWN0aW9uQ29udGV4dCA9IGdldCh0aGlzLCAnYWN0aW9uQ29udGV4dCcpOwoKICAgIGlmIChFbWJlci50eXBlT2YoYWN0aW9uQ29udGV4dCkgPT09ICJzdHJpbmciKSB7CiAgICAgIHZhciB2YWx1ZSA9IGdldCh0aGlzLCBhY3Rpb25Db250ZXh0KTsKICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsgdmFsdWUgPSBnZXQoRW1iZXIubG9va3VwLCBhY3Rpb25Db250ZXh0KTsgfQogICAgICByZXR1cm4gdmFsdWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gYWN0aW9uQ29udGV4dDsKICAgIH0KICB9KS5wcm9wZXJ0eSgnYWN0aW9uQ29udGV4dCcpLAoKICAvKioKICBTZW5kIGFuICJhY3Rpb24iIHdpdGggYW4gImFjdGlvbkNvbnRleHQiIHRvIGEgInRhcmdldCIuIFRoZSBhY3Rpb24sIGFjdGlvbkNvbnRleHQKICBhbmQgdGFyZ2V0IHdpbGwgYmUgcmV0cmlldmVkIGZyb20gcHJvcGVydGllcyBvZiB0aGUgb2JqZWN0LiBGb3IgZXhhbXBsZToKCiAgYGBgamF2YXNjcmlwdAogIEFwcC5TYXZlQnV0dG9uVmlldyA9IEVtYmVyLlZpZXcuZXh0ZW5kKEVtYmVyLlRhcmdldEFjdGlvblN1cHBvcnQsIHsKICAgIHRhcmdldDogRW1iZXIuY29tcHV0ZWQuYWxpYXMoJ2NvbnRyb2xsZXInKSwKICAgIGFjdGlvbjogJ3NhdmUnLAogICAgYWN0aW9uQ29udGV4dDogRW1iZXIuY29tcHV0ZWQuYWxpYXMoJ2NvbnRleHQnKSwKICAgIGNsaWNrOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy50cmlnZ2VyQWN0aW9uKCk7IC8vIFNlbmRzIHRoZSBgc2F2ZWAgYWN0aW9uLCBhbG9uZyB3aXRoIHRoZSBjdXJyZW50IGNvbnRleHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRvIHRoZSBjdXJyZW50IGNvbnRyb2xsZXIKICAgIH0KICB9KTsKICBgYGAKCiAgVGhlIGB0YXJnZXRgLCBgYWN0aW9uYCwgYW5kIGBhY3Rpb25Db250ZXh0YCBjYW4gYmUgcHJvdmlkZWQgYXMgcHJvcGVydGllcyBvZgogIGFuIG9wdGlvbmFsIG9iamVjdCBhcmd1bWVudCB0byBgdHJpZ2dlckFjdGlvbmAgYXMgd2VsbC4KCiAgYGBgamF2YXNjcmlwdAogIEFwcC5TYXZlQnV0dG9uVmlldyA9IEVtYmVyLlZpZXcuZXh0ZW5kKEVtYmVyLlRhcmdldEFjdGlvblN1cHBvcnQsIHsKICAgIGNsaWNrOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy50cmlnZ2VyQWN0aW9uKHsKICAgICAgICBhY3Rpb246ICdzYXZlJywKICAgICAgICB0YXJnZXQ6IHRoaXMuZ2V0KCdjb250cm9sbGVyJyksCiAgICAgICAgYWN0aW9uQ29udGV4dDogdGhpcy5nZXQoJ2NvbnRleHQnKSwKICAgICAgfSk7IC8vIFNlbmRzIHRoZSBgc2F2ZWAgYWN0aW9uLCBhbG9uZyB3aXRoIHRoZSBjdXJyZW50IGNvbnRleHQKICAgICAgICAgIC8vIHRvIHRoZSBjdXJyZW50IGNvbnRyb2xsZXIKICAgIH0KICB9KTsKICBgYGAKCiAgVGhlIGBhY3Rpb25Db250ZXh0YCBkZWZhdWx0cyB0byB0aGUgb2JqZWN0IHlvdSBtaXhpbmcgYFRhcmdldEFjdGlvblN1cHBvcnRgIGludG8uCiAgQnV0IGB0YXJnZXRgIGFuZCBgYWN0aW9uYCBtdXN0IGJlIHNwZWNpZmllZCBlaXRoZXIgYXMgcHJvcGVydGllcyBvciB3aXRoIHRoZSBhcmd1bWVudAogIHRvIGB0cmlnZ2VyQWN0aW9uYCwgb3IgYSBjb21iaW5hdGlvbjoKCiAgYGBgamF2YXNjcmlwdAogIEFwcC5TYXZlQnV0dG9uVmlldyA9IEVtYmVyLlZpZXcuZXh0ZW5kKEVtYmVyLlRhcmdldEFjdGlvblN1cHBvcnQsIHsKICAgIHRhcmdldDogRW1iZXIuY29tcHV0ZWQuYWxpYXMoJ2NvbnRyb2xsZXInKSwKICAgIGNsaWNrOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy50cmlnZ2VyQWN0aW9uKHsKICAgICAgICBhY3Rpb246ICdzYXZlJwogICAgICB9KTsgLy8gU2VuZHMgdGhlIGBzYXZlYCBhY3Rpb24sIGFsb25nIHdpdGggYSByZWZlcmVuY2UgdG8gYHRoaXNgLAogICAgICAgICAgLy8gdG8gdGhlIGN1cnJlbnQgY29udHJvbGxlcgogICAgfQogIH0pOwogIGBgYAoKICBAbWV0aG9kIHRyaWdnZXJBY3Rpb24KICBAcGFyYW0gb3B0cyB7SGFzaH0gKG9wdGlvbmFsLCB3aXRoIHRoZSBvcHRpb25hbCBrZXlzIGFjdGlvbiwgdGFyZ2V0IGFuZC9vciBhY3Rpb25Db250ZXh0KQogIEByZXR1cm4ge0Jvb2xlYW59IHRydWUgaWYgdGhlIGFjdGlvbiB3YXMgc2VudCBzdWNjZXNzZnVsbHkgYW5kIGRpZCBub3QgcmV0dXJuIGZhbHNlCiAgKi8KICB0cmlnZ2VyQWN0aW9uOiBmdW5jdGlvbihvcHRzKSB7CiAgICBvcHRzID0gb3B0cyB8fCB7fTsKICAgIHZhciBhY3Rpb24gPSBvcHRzLmFjdGlvbiB8fCBnZXQodGhpcywgJ2FjdGlvbicpLAogICAgICAgIHRhcmdldCA9IG9wdHMudGFyZ2V0IHx8IGdldCh0aGlzLCAndGFyZ2V0T2JqZWN0JyksCiAgICAgICAgYWN0aW9uQ29udGV4dCA9IG9wdHMuYWN0aW9uQ29udGV4dDsKCiAgICBmdW5jdGlvbiBhcmdzKG9wdGlvbnMsIGFjdGlvbk5hbWUpIHsKICAgICAgdmFyIHJldCA9IFtdOwogICAgICBpZiAoYWN0aW9uTmFtZSkgeyByZXQucHVzaChhY3Rpb25OYW1lKTsgfQoKICAgICAgcmV0dXJuIHJldC5jb25jYXQob3B0aW9ucyk7CiAgICB9CgogICAgaWYgKHR5cGVvZiBhY3Rpb25Db250ZXh0ID09PSAndW5kZWZpbmVkJykgewogICAgICBhY3Rpb25Db250ZXh0ID0gZ2V0KHRoaXMsICdhY3Rpb25Db250ZXh0T2JqZWN0JykgfHwgdGhpczsKICAgIH0KCiAgICBpZiAodGFyZ2V0ICYmIGFjdGlvbikgewogICAgICB2YXIgcmV0OwoKICAgICAgaWYgKHRhcmdldC5zZW5kKSB7CiAgICAgICAgcmV0ID0gdGFyZ2V0LnNlbmQuYXBwbHkodGFyZ2V0LCBhcmdzKGFjdGlvbkNvbnRleHQsIGFjdGlvbikpOwogICAgICB9IGVsc2UgewogICAgICAgIEVtYmVyLmFzc2VydCgiVGhlIGFjdGlvbiAnIiArIGFjdGlvbiArICInIGRpZCBub3QgZXhpc3Qgb24gIiArIHRhcmdldCwgdHlwZW9mIHRhcmdldFthY3Rpb25dID09PSAnZnVuY3Rpb24nKTsKICAgICAgICByZXQgPSB0YXJnZXRbYWN0aW9uXS5hcHBseSh0YXJnZXQsIGFyZ3MoYWN0aW9uQ29udGV4dCkpOwogICAgICB9CgogICAgICBpZiAocmV0ICE9PSBmYWxzZSkgcmV0ID0gdHJ1ZTsKCiAgICAgIHJldHVybiByZXQ7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1ydW50aW1lCiovCgovKioKICBUaGlzIG1peGluIGFsbG93cyBmb3IgRW1iZXIgb2JqZWN0cyB0byBzdWJzY3JpYmUgdG8gYW5kIGVtaXQgZXZlbnRzLgoKICBgYGBqYXZhc2NyaXB0CiAgQXBwLlBlcnNvbiA9IEVtYmVyLk9iamVjdC5leHRlbmQoRW1iZXIuRXZlbnRlZCwgewogICAgZ3JlZXQ6IGZ1bmN0aW9uKCkgewogICAgICAvLyAuLi4KICAgICAgdGhpcy50cmlnZ2VyKCdncmVldCcpOwogICAgfQogIH0pOwoKICB2YXIgcGVyc29uID0gQXBwLlBlcnNvbi5jcmVhdGUoKTsKCiAgcGVyc29uLm9uKCdncmVldCcsIGZ1bmN0aW9uKCkgewogICAgY29uc29sZS5sb2coJ091ciBwZXJzb24gaGFzIGdyZWV0ZWQnKTsKICB9KTsKCiAgcGVyc29uLmdyZWV0KCk7CgogIC8vIG91dHB1dHM6ICdPdXIgcGVyc29uIGhhcyBncmVldGVkJwogIGBgYAoKICBZb3UgY2FuIGFsc28gY2hhaW4gbXVsdGlwbGUgZXZlbnQgc3Vic2NyaXB0aW9uczoKCiAgYGBgamF2YXNjcmlwdAogIHBlcnNvbi5vbignZ3JlZXQnLCBmdW5jdGlvbigpIHsKICAgIGNvbnNvbGUubG9nKCdPdXIgcGVyc29uIGhhcyBncmVldGVkJyk7CiAgfSkub25lKCdncmVldCcsIGZ1bmN0aW9uKCkgewogICAgY29uc29sZS5sb2coJ09mZmVyIG9uZS10aW1lIHNwZWNpYWwnKTsKICB9KS5vZmYoJ2V2ZW50JywgdGhpcywgZm9yZ2V0VGhpcyk7CiAgYGBgCgogIEBjbGFzcyBFdmVudGVkCiAgQG5hbWVzcGFjZSBFbWJlcgogKi8KRW1iZXIuRXZlbnRlZCA9IEVtYmVyLk1peGluLmNyZWF0ZSh7CgogIC8qKgogICBTdWJzY3JpYmVzIHRvIGEgbmFtZWQgZXZlbnQgd2l0aCBnaXZlbiBmdW5jdGlvbi4KCiAgIGBgYGphdmFzY3JpcHQKICAgcGVyc29uLm9uKCdkaWRMb2FkJywgZnVuY3Rpb24oKSB7CiAgICAgLy8gZmlyZWQgb25jZSB0aGUgcGVyc29uIGhhcyBsb2FkZWQKICAgfSk7CiAgIGBgYAoKICAgQW4gb3B0aW9uYWwgdGFyZ2V0IGNhbiBiZSBwYXNzZWQgaW4gYXMgdGhlIDJuZCBhcmd1bWVudCB0aGF0IHdpbGwKICAgYmUgc2V0IGFzIHRoZSAidGhpcyIgZm9yIHRoZSBjYWxsYmFjay4gVGhpcyBpcyBhIGdvb2Qgd2F5IHRvIGdpdmUgeW91cgogICBmdW5jdGlvbiBhY2Nlc3MgdG8gdGhlIG9iamVjdCB0cmlnZ2VyaW5nIHRoZSBldmVudC4gV2hlbiB0aGUgdGFyZ2V0CiAgIHBhcmFtZXRlciBpcyB1c2VkIHRoZSBjYWxsYmFjayBiZWNvbWVzIHRoZSB0aGlyZCBhcmd1bWVudC4KCiAgIEBtZXRob2Qgb24KICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGV2ZW50CiAgIEBwYXJhbSB7T2JqZWN0fSBbdGFyZ2V0XSBUaGUgInRoaXMiIGJpbmRpbmcgZm9yIHRoZSBjYWxsYmFjawogICBAcGFyYW0ge0Z1bmN0aW9ufSBtZXRob2QgVGhlIGNhbGxiYWNrIHRvIGV4ZWN1dGUKICAgQHJldHVybiB0aGlzCiAgKi8KICBvbjogZnVuY3Rpb24obmFtZSwgdGFyZ2V0LCBtZXRob2QpIHsKICAgIEVtYmVyLmFkZExpc3RlbmVyKHRoaXMsIG5hbWUsIHRhcmdldCwgbWV0aG9kKTsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAgU3Vic2NyaWJlcyBhIGZ1bmN0aW9uIHRvIGEgbmFtZWQgZXZlbnQgYW5kIHRoZW4gY2FuY2VscyB0aGUgc3Vic2NyaXB0aW9uCiAgICBhZnRlciB0aGUgZmlyc3QgdGltZSB0aGUgZXZlbnQgaXMgdHJpZ2dlcmVkLiBJdCBpcyBnb29kIHRvIHVzZSBgYG9uZWBgIHdoZW4KICAgIHlvdSBvbmx5IGNhcmUgYWJvdXQgdGhlIGZpcnN0IHRpbWUgYW4gZXZlbnQgaGFzIHRha2VuIHBsYWNlLgoKICAgIFRoaXMgZnVuY3Rpb24gdGFrZXMgYW4gb3B0aW9uYWwgMm5kIGFyZ3VtZW50IHRoYXQgd2lsbCBiZWNvbWUgdGhlICJ0aGlzIgogICAgdmFsdWUgZm9yIHRoZSBjYWxsYmFjay4gSWYgdGhpcyBhcmd1bWVudCBpcyBwYXNzZWQgdGhlbiB0aGUgM3JkIGFyZ3VtZW50CiAgICBiZWNvbWVzIHRoZSBmdW5jdGlvbi4KCiAgICBAbWV0aG9kIG9uZQogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGV2ZW50CiAgICBAcGFyYW0ge09iamVjdH0gW3RhcmdldF0gVGhlICJ0aGlzIiBiaW5kaW5nIGZvciB0aGUgY2FsbGJhY2sKICAgIEBwYXJhbSB7RnVuY3Rpb259IG1ldGhvZCBUaGUgY2FsbGJhY2sgdG8gZXhlY3V0ZQogICAgQHJldHVybiB0aGlzCiAgKi8KICBvbmU6IGZ1bmN0aW9uKG5hbWUsIHRhcmdldCwgbWV0aG9kKSB7CiAgICBpZiAoIW1ldGhvZCkgewogICAgICBtZXRob2QgPSB0YXJnZXQ7CiAgICAgIHRhcmdldCA9IG51bGw7CiAgICB9CgogICAgRW1iZXIuYWRkTGlzdGVuZXIodGhpcywgbmFtZSwgdGFyZ2V0LCBtZXRob2QsIHRydWUpOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICBUcmlnZ2VycyBhIG5hbWVkIGV2ZW50IGZvciB0aGUgb2JqZWN0LiBBbnkgYWRkaXRpb25hbCBhcmd1bWVudHMKICAgIHdpbGwgYmUgcGFzc2VkIGFzIHBhcmFtZXRlcnMgdG8gdGhlIGZ1bmN0aW9ucyB0aGF0IGFyZSBzdWJzY3JpYmVkIHRvIHRoZQogICAgZXZlbnQuCgogICAgYGBgamF2YXNjcmlwdAogICAgcGVyc29uLm9uKCdkaWRFYXQnLCBmdW5jdGlvbihmb29kKSB7CiAgICAgIGNvbnNvbGUubG9nKCdwZXJzb24gYXRlIHNvbWUgJyArIGZvb2QpOwogICAgfSk7CgogICAgcGVyc29uLnRyaWdnZXIoJ2RpZEVhdCcsICdicm9jY29saScpOwoKICAgIC8vIG91dHB1dHM6IHBlcnNvbiBhdGUgc29tZSBicm9jY29saQogICAgYGBgCiAgICBAbWV0aG9kIHRyaWdnZXIKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBldmVudAogICAgQHBhcmFtIHtPYmplY3QuLi59IGFyZ3MgT3B0aW9uYWwgYXJndW1lbnRzIHRvIHBhc3Mgb24KICAqLwogIHRyaWdnZXI6IGZ1bmN0aW9uKG5hbWUpIHsKICAgIHZhciBhcmdzID0gW10sIGksIGw7CiAgICBmb3IgKGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICBhcmdzLnB1c2goYXJndW1lbnRzW2ldKTsKICAgIH0KICAgIEVtYmVyLnNlbmRFdmVudCh0aGlzLCBuYW1lLCBhcmdzKTsKICB9LAoKICAvKioKICAgIENhbmNlbHMgc3Vic2NyaXB0aW9uIGZvciBnaXZlbiBuYW1lLCB0YXJnZXQsIGFuZCBtZXRob2QuCgogICAgQG1ldGhvZCBvZmYKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBldmVudAogICAgQHBhcmFtIHtPYmplY3R9IHRhcmdldCBUaGUgdGFyZ2V0IG9mIHRoZSBzdWJzY3JpcHRpb24KICAgIEBwYXJhbSB7RnVuY3Rpb259IG1ldGhvZCBUaGUgZnVuY3Rpb24gb2YgdGhlIHN1YnNjcmlwdGlvbgogICAgQHJldHVybiB0aGlzCiAgKi8KICBvZmY6IGZ1bmN0aW9uKG5hbWUsIHRhcmdldCwgbWV0aG9kKSB7CiAgICBFbWJlci5yZW1vdmVMaXN0ZW5lcih0aGlzLCBuYW1lLCB0YXJnZXQsIG1ldGhvZCk7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvKioKICAgIENoZWNrcyB0byBzZWUgaWYgb2JqZWN0IGhhcyBhbnkgc3Vic2NyaXB0aW9ucyBmb3IgbmFtZWQgZXZlbnQuCgogICAgQG1ldGhvZCBoYXMKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBldmVudAogICAgQHJldHVybiB7Qm9vbGVhbn0gZG9lcyB0aGUgb2JqZWN0IGhhdmUgYSBzdWJzY3JpcHRpb24gZm9yIGV2ZW50CiAgICovCiAgaGFzOiBmdW5jdGlvbihuYW1lKSB7CiAgICByZXR1cm4gRW1iZXIuaGFzTGlzdGVuZXJzKHRoaXMsIG5hbWUpOwogIH0KfSk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7CnZhciBSU1ZQID0gcmVxdWlyZU1vZHVsZSgicnN2cCIpOwoKUlNWUC5jb25maWd1cmUoJ2FzeW5jJywgZnVuY3Rpb24oY2FsbGJhY2ssIHByb21pc2UpIHsKICBFbWJlci5ydW4uc2NoZWR1bGUoJ2FjdGlvbnMnLCBwcm9taXNlLCBjYWxsYmFjaywgcHJvbWlzZSk7Cn0pOwoKUlNWUC5Qcm9taXNlLnByb3RvdHlwZS5mYWlsID0gZnVuY3Rpb24oY2FsbGJhY2ssIGxhYmVsKXsKICBFbWJlci5kZXByZWNhdGUoJ1JTVlAuUHJvbWlzZS5mYWlsIGhhcyBiZWVuIHJlbmFtZWQgYXMgUlNWUC5Qcm9taXNlLmNhdGNoJyk7CiAgcmV0dXJuIHRoaXNbJ2NhdGNoJ10oY2FsbGJhY2ssIGxhYmVsKTsKfTsKCi8qKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItcnVudGltZQoqLwoKdmFyIGdldCA9IEVtYmVyLmdldDsKCi8qKgogIEBjbGFzcyBEZWZlcnJlZAogIEBuYW1lc3BhY2UgRW1iZXIKICovCkVtYmVyLkRlZmVycmVkTWl4aW4gPSBFbWJlci5NaXhpbi5jcmVhdGUoewogIC8qKgogICAgQWRkIGhhbmRsZXJzIHRvIGJlIGNhbGxlZCB3aGVuIHRoZSBEZWZlcnJlZCBvYmplY3QgaXMgcmVzb2x2ZWQgb3IgcmVqZWN0ZWQuCgogICAgQG1ldGhvZCB0aGVuCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSByZXNvbHZlIGEgY2FsbGJhY2sgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHdoZW4gZG9uZQogICAgQHBhcmFtIHtGdW5jdGlvbn0gcmVqZWN0ICBhIGNhbGxiYWNrIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCB3aGVuIGZhaWxlZAogICovCiAgdGhlbjogZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0LCBsYWJlbCkgewogICAgdmFyIGRlZmVycmVkLCBwcm9taXNlLCBlbnRpdHk7CgogICAgZW50aXR5ID0gdGhpczsKICAgIGRlZmVycmVkID0gZ2V0KHRoaXMsICdfZGVmZXJyZWQnKTsKICAgIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlOwoKICAgIGZ1bmN0aW9uIGZ1bGZpbGxtZW50SGFuZGxlcihmdWxmaWxsbWVudCkgewogICAgICBpZiAoZnVsZmlsbG1lbnQgPT09IHByb21pc2UpIHsKICAgICAgICByZXR1cm4gcmVzb2x2ZShlbnRpdHkpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiByZXNvbHZlKGZ1bGZpbGxtZW50KTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBwcm9taXNlLnRoZW4ocmVzb2x2ZSAmJiBmdWxmaWxsbWVudEhhbmRsZXIsIHJlamVjdCwgbGFiZWwpOwogIH0sCgogIC8qKgogICAgUmVzb2x2ZSBhIERlZmVycmVkIG9iamVjdCBhbmQgY2FsbCBhbnkgYGRvbmVDYWxsYmFja3NgIHdpdGggdGhlIGdpdmVuIGFyZ3MuCgogICAgQG1ldGhvZCByZXNvbHZlCiAgKi8KICByZXNvbHZlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgdmFyIGRlZmVycmVkLCBwcm9taXNlOwoKICAgIGRlZmVycmVkID0gZ2V0KHRoaXMsICdfZGVmZXJyZWQnKTsKICAgIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlOwoKICAgIGlmICh2YWx1ZSA9PT0gdGhpcykgewogICAgICBkZWZlcnJlZC5yZXNvbHZlKHByb21pc2UpOwogICAgfSBlbHNlIHsKICAgICAgZGVmZXJyZWQucmVzb2x2ZSh2YWx1ZSk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICBSZWplY3QgYSBEZWZlcnJlZCBvYmplY3QgYW5kIGNhbGwgYW55IGBmYWlsQ2FsbGJhY2tzYCB3aXRoIHRoZSBnaXZlbiBhcmdzLgoKICAgIEBtZXRob2QgcmVqZWN0CiAgKi8KICByZWplY3Q6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICBnZXQodGhpcywgJ19kZWZlcnJlZCcpLnJlamVjdCh2YWx1ZSk7CiAgfSwKCiAgX2RlZmVycmVkOiBFbWJlci5jb21wdXRlZChmdW5jdGlvbigpIHsKICAgIHJldHVybiBSU1ZQLmRlZmVyKCdFbWJlcjogRGVmZXJyZWRNaXhpbiAtICcgKyB0aGlzKTsKICB9KQp9KTsKCgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItcnVudGltZQoqLwoKdmFyIGdldCA9IEVtYmVyLmdldCwgdHlwZU9mID0gRW1iZXIudHlwZU9mOwoKLyoqCiAgVGhlIGBFbWJlci5BY3Rpb25IYW5kbGVyYCBtaXhpbiBpbXBsZW1lbnRzIHN1cHBvcnQgZm9yIG1vdmluZyBhbiBgYWN0aW9uc2AKICBwcm9wZXJ0eSB0byBhbiBgX2FjdGlvbnNgIHByb3BlcnR5IGF0IGV4dGVuZCB0aW1lLCBhbmQgYWRkaW5nIGBfYWN0aW9uc2AKICB0byB0aGUgb2JqZWN0J3MgbWVyZ2VkUHJvcGVydGllcyBsaXN0LgoKICBgRW1iZXIuQWN0aW9uSGFuZGxlcmAgaXMgdXNlZCBpbnRlcm5hbGx5IGJ5IEVtYmVyIGluICBgRW1iZXIuVmlld2AsCiAgYEVtYmVyLkNvbnRyb2xsZXJgLCBhbmQgYEVtYmVyLlJvdXRlYC4KCiAgQGNsYXNzIEFjdGlvbkhhbmRsZXIKICBAbmFtZXNwYWNlIEVtYmVyCiovCkVtYmVyLkFjdGlvbkhhbmRsZXIgPSBFbWJlci5NaXhpbi5jcmVhdGUoewogIG1lcmdlZFByb3BlcnRpZXM6IFsnX2FjdGlvbnMnXSwKCiAgLyoqCiAgICBUaGUgY29sbGVjdGlvbiBvZiBmdW5jdGlvbnMsIGtleWVkIGJ5IG5hbWUsIGF2YWlsYWJsZSBvbiB0aGlzCiAgICBgQWN0aW9uSGFuZGxlcmAgYXMgYWN0aW9uIHRhcmdldHMuCgogICAgVGhlc2UgZnVuY3Rpb25zIHdpbGwgYmUgaW52b2tlZCB3aGVuIGEgbWF0Y2hpbmcgYHt7YWN0aW9ufX1gIGlzIHRyaWdnZXJlZAogICAgZnJvbSB3aXRoaW4gYSB0ZW1wbGF0ZSBhbmQgdGhlIGFwcGxpY2F0aW9uJ3MgY3VycmVudCByb3V0ZSBpcyB0aGlzIHJvdXRlLgoKICAgIEFjdGlvbnMgY2FuIGFsc28gYmUgaW52b2tlZCBmcm9tIG90aGVyIHBhcnRzIG9mIHlvdXIgYXBwbGljYXRpb24KICAgIHZpYSBgQWN0aW9uSGFuZGxlciNzZW5kYC4KCiAgICBUaGUgYGFjdGlvbnNgIGhhc2ggd2lsbCBpbmhlcml0IGFjdGlvbiBoYW5kbGVycyBmcm9tCiAgICB0aGUgYGFjdGlvbnNgIGhhc2ggZGVmaW5lZCBvbiBleHRlbmRlZCBwYXJlbnQgY2xhc3NlcwogICAgb3IgbWl4aW5zIHJhdGhlciB0aGFuIGp1c3QgcmVwbGFjZSB0aGUgZW50aXJlIGhhc2gsIGUuZy46CgogICAgYGBganMKICAgIEFwcC5DYW5EaXNwbGF5QmFubmVyID0gRW1iZXIuTWl4aW4uY3JlYXRlKHsKICAgICAgYWN0aW9uczogewogICAgICAgIGRpc3BsYXlCYW5uZXI6IGZ1bmN0aW9uKG1zZykgewogICAgICAgICAgLy8gLi4uCiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCiAgICBBcHAuV2VsY29tZVJvdXRlID0gRW1iZXIuUm91dGUuZXh0ZW5kKEFwcC5DYW5EaXNwbGF5QmFubmVyLCB7CiAgICAgIGFjdGlvbnM6IHsKICAgICAgICBwbGF5TXVzaWM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgLy8gLi4uCiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCiAgICAvLyBgV2VsY29tZVJvdXRlYCwgd2hlbiBhY3RpdmUsIHdpbGwgYmUgYWJsZSB0byByZXNwb25kCiAgICAvLyB0byBib3RoIGFjdGlvbnMsIHNpbmNlIHRoZSBhY3Rpb25zIGhhc2ggaXMgbWVyZ2VkIHJhdGhlcgogICAgLy8gdGhlbiByZXBsYWNlZCB3aGVuIGV4dGVuZGluZyBtaXhpbnMgLyBwYXJlbnQgY2xhc3Nlcy4KICAgIHRoaXMuc2VuZCgnZGlzcGxheUJhbm5lcicpOwogICAgdGhpcy5zZW5kKCdwbGF5TXVzaWMnKTsKICAgIGBgYAoKICAgIFdpdGhpbiBhIENvbnRyb2xsZXIsIFJvdXRlLCBWaWV3IG9yIENvbXBvbmVudCdzIGFjdGlvbiBoYW5kbGVyLAogICAgdGhlIHZhbHVlIG9mIHRoZSBgdGhpc2AgY29udGV4dCBpcyB0aGUgQ29udHJvbGxlciwgUm91dGUsIFZpZXcgb3IKICAgIENvbXBvbmVudCBvYmplY3Q6CgogICAgYGBganMKICAgIEFwcC5Tb25nUm91dGUgPSBFbWJlci5Sb3V0ZS5leHRlbmQoewogICAgICBhY3Rpb25zOiB7CiAgICAgICAgbXlBY3Rpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgdGhpcy5jb250cm9sbGVyRm9yKCJzb25nIik7CiAgICAgICAgICB0aGlzLnRyYW5zaXRpb25Ubygib3RoZXIucm91dGUiKTsKICAgICAgICAgIC4uLgogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBgYGAKCiAgICBJdCBpcyBhbHNvIHBvc3NpYmxlIHRvIGNhbGwgYHRoaXMuX3N1cGVyKClgIGZyb20gd2l0aGluIGFuCiAgICBhY3Rpb24gaGFuZGxlciBpZiBpdCBvdmVycmlkZXMgYSBoYW5kbGVyIGRlZmluZWQgb24gYSBwYXJlbnQKICAgIGNsYXNzIG9yIG1peGluOgoKICAgIFRha2UgZm9yIGV4YW1wbGUgdGhlIGZvbGxvd2luZyByb3V0ZXM6CgogICAgYGBganMKICAgIEFwcC5EZWJ1Z1JvdXRlID0gRW1iZXIuTWl4aW4uY3JlYXRlKHsKICAgICAgYWN0aW9uczogewogICAgICAgIGRlYnVnUm91dGVJbmZvcm1hdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICBjb25zb2xlLmRlYnVnKCJ0cm9sb2xvIik7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCiAgICBBcHAuQW5ub3lpbmdEZWJ1Z1JvdXRlID0gRW1iZXIuUm91dGUuZXh0ZW5kKEFwcC5EZWJ1Z1JvdXRlLCB7CiAgICAgIGFjdGlvbnM6IHsKICAgICAgICBkZWJ1Z1JvdXRlSW5mb3JtYXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgLy8gYWxzbyBjYWxsIHRoZSBkZWJ1Z1JvdXRlSW5mb3JtYXRpb24gb2YgbWl4ZWQgaW4gQXBwLkRlYnVnUm91dGUKICAgICAgICAgIHRoaXMuX3N1cGVyKCk7CgogICAgICAgICAgLy8gc2hvdyBhZGRpdGlvbmFsIGFubm95YW5jZQogICAgICAgICAgd2luZG93LmFsZXJ0KC4uLik7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgICMjIEJ1YmJsaW5nCgogICAgQnkgZGVmYXVsdCwgYW4gYWN0aW9uIHdpbGwgc3RvcCBidWJibGluZyBvbmNlIGEgaGFuZGxlciBkZWZpbmVkCiAgICBvbiB0aGUgYGFjdGlvbnNgIGhhc2ggaGFuZGxlcyBpdC4gVG8gY29udGludWUgYnViYmxpbmcgdGhlIGFjdGlvbiwKICAgIHlvdSBtdXN0IHJldHVybiBgdHJ1ZWAgZnJvbSB0aGUgaGFuZGxlcjoKCiAgICBgYGBqcwogICAgQXBwLlJvdXRlci5tYXAoZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucmVzb3VyY2UoImFsYnVtIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yb3V0ZSgic29uZyIpOwogICAgICB9KTsKICAgIH0pOwoKICAgIEFwcC5BbGJ1bVJvdXRlID0gRW1iZXIuUm91dGUuZXh0ZW5kKHsKICAgICAgYWN0aW9uczogewogICAgICAgIHN0YXJ0UGxheWluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCiAgICBBcHAuQWxidW1Tb25nUm91dGUgPSBFbWJlci5Sb3V0ZS5leHRlbmQoewogICAgICBhY3Rpb25zOiB7CiAgICAgICAgc3RhcnRQbGF5aW5nOiBmdW5jdGlvbigpIHsKICAgICAgICAgIC8vIC4uLgoKICAgICAgICAgIGlmIChhY3Rpb25TaG91bGRBbHNvQmVUcmlnZ2VyZWRPblBhcmVudFJvdXRlKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBgYGAKCiAgICBAcHJvcGVydHkgYWN0aW9ucwogICAgQHR5cGUgSGFzaAogICAgQGRlZmF1bHQgbnVsbAogICovCgogIC8qKgogICAgTW92ZXMgYGFjdGlvbnNgIHRvIGBfYWN0aW9uc2AgYXQgZXh0ZW5kIHRpbWUuIE5vdGUgdGhhdCB0aGlzIGN1cnJlbnRseQogICAgbW9kaWZpZXMgdGhlIG1peGluIHRoZW1zZWx2ZXMsIHdoaWNoIGlzIHRlY2huaWNhbGx5IGR1YmlvdXMgYnV0CiAgICBpcyBwcmFjdGljYWxseSBvZiBsaXR0bGUgY29uc2VxdWVuY2UuIFRoaXMgbWF5IGNoYW5nZSBpbiB0aGUgZnV0dXJlLgoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIHdpbGxNZXJnZU1peGluCiAgKi8KICB3aWxsTWVyZ2VNaXhpbjogZnVuY3Rpb24ocHJvcHMpIHsKICAgIHZhciBoYXNoTmFtZTsKCiAgICBpZiAoIXByb3BzLl9hY3Rpb25zKSB7CiAgICAgIGlmICh0eXBlT2YocHJvcHMuYWN0aW9ucykgPT09ICdvYmplY3QnKSB7CiAgICAgICAgaGFzaE5hbWUgPSAnYWN0aW9ucyc7CiAgICAgIH0gZWxzZSBpZiAodHlwZU9mKHByb3BzLmV2ZW50cykgPT09ICdvYmplY3QnKSB7CiAgICAgICAgRW1iZXIuZGVwcmVjYXRlKCdBY3Rpb24gaGFuZGxlcnMgY29udGFpbmVkIGluIGFuIGBldmVudHNgIG9iamVjdCBhcmUgZGVwcmVjYXRlZCBpbiBmYXZvciBvZiBwdXR0aW5nIHRoZW0gaW4gYW4gYGFjdGlvbnNgIG9iamVjdCcsIGZhbHNlKTsKICAgICAgICBoYXNoTmFtZSA9ICdldmVudHMnOwogICAgICB9CgogICAgICBpZiAoaGFzaE5hbWUpIHsKICAgICAgICBwcm9wcy5fYWN0aW9ucyA9IEVtYmVyLm1lcmdlKHByb3BzLl9hY3Rpb25zIHx8IHt9LCBwcm9wc1toYXNoTmFtZV0pOwogICAgICB9CgogICAgICBkZWxldGUgcHJvcHNbaGFzaE5hbWVdOwogICAgfQogIH0sCgogIHNlbmQ6IGZ1bmN0aW9uKGFjdGlvbk5hbWUpIHsKICAgIHZhciBhcmdzID0gW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLCB0YXJnZXQ7CgogICAgaWYgKHRoaXMuX2FjdGlvbnMgJiYgdGhpcy5fYWN0aW9uc1thY3Rpb25OYW1lXSkgewogICAgICBpZiAodGhpcy5fYWN0aW9uc1thY3Rpb25OYW1lXS5hcHBseSh0aGlzLCBhcmdzKSA9PT0gdHJ1ZSkgewogICAgICAgIC8vIGhhbmRsZXIgcmV0dXJuZWQgdHJ1ZSwgc28gdGhpcyBhY3Rpb24gd2lsbCBidWJibGUKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0gZWxzZSBpZiAodGhpcy5kZXByZWNhdGVkU2VuZCAmJiB0aGlzLmRlcHJlY2F0ZWRTZW5kSGFuZGxlcyAmJiB0aGlzLmRlcHJlY2F0ZWRTZW5kSGFuZGxlcyhhY3Rpb25OYW1lKSkgewogICAgICBpZiAodGhpcy5kZXByZWNhdGVkU2VuZC5hcHBseSh0aGlzLCBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cykpID09PSB0cnVlKSB7CiAgICAgICAgLy8gaGFuZGxlciByZXR1cm4gdHJ1ZSwgc28gdGhpcyBhY3Rpb24gd2lsbCBidWJibGUKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KCiAgICBpZiAodGFyZ2V0ID0gZ2V0KHRoaXMsICd0YXJnZXQnKSkgewogICAgICBFbWJlci5hc3NlcnQoIlRoZSBgdGFyZ2V0YCBmb3IgIiArIHRoaXMgKyAiICgiICsgdGFyZ2V0ICsgIikgZG9lcyBub3QgaGF2ZSBhIGBzZW5kYCBtZXRob2QiLCB0eXBlb2YgdGFyZ2V0LnNlbmQgPT09ICdmdW5jdGlvbicpOwogICAgICB0YXJnZXQuc2VuZC5hcHBseSh0YXJnZXQsIGFyZ3VtZW50cyk7CiAgICB9CiAgfQoKfSk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7CnZhciBzZXQgPSBFbWJlci5zZXQsIGdldCA9IEVtYmVyLmdldCwKICAgIHJlc29sdmUgPSBFbWJlci5SU1ZQLnJlc29sdmUsCiAgICByZXRocm93ID0gRW1iZXIuUlNWUC5yZXRocm93LAogICAgbm90ID0gRW1iZXIuY29tcHV0ZWQubm90LAogICAgb3IgPSBFbWJlci5jb21wdXRlZC5vcjsKCi8qKgogIEBtb2R1bGUgZW1iZXIKICBAc3VibW9kdWxlIGVtYmVyLXJ1bnRpbWUKICovCgpmdW5jdGlvbiBvYnNlcnZlUHJvbWlzZShwcm94eSwgcHJvbWlzZSkgewogIHByb21pc2UudGhlbihmdW5jdGlvbih2YWx1ZSkgewogICAgc2V0KHByb3h5LCAnaXNGdWxmaWxsZWQnLCB0cnVlKTsKICAgIHNldChwcm94eSwgJ2NvbnRlbnQnLCB2YWx1ZSk7CiAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICBzZXQocHJveHksICdpc1JlamVjdGVkJywgdHJ1ZSk7CiAgICBzZXQocHJveHksICdyZWFzb24nLCByZWFzb24pOwogICAgLy8gZG9uJ3QgcmUtdGhyb3csIGFzIHdlIGFyZSBtZXJlbHkgb2JzZXJ2aW5nCiAgfSwgIkVtYmVyOiBQcm9taXNlUHJveHkiKTsKfQoKLyoqCiAgQSBsb3cgbGV2ZWwgbWl4aW4gbWFraW5nIE9iamVjdFByb3h5LCBPYmplY3RDb250cm9sbGVyIG9yIEFycmF5Q29udHJvbGxlcidzIHByb21pc2UgYXdhcmUuCgogIGBgYGphdmFzY3JpcHQKICB2YXIgT2JqZWN0UHJvbWlzZUNvbnRyb2xsZXIgPSBFbWJlci5PYmplY3RDb250cm9sbGVyLmV4dGVuZChFbWJlci5Qcm9taXNlUHJveHlNaXhpbik7CgogIHZhciBjb250cm9sbGVyID0gT2JqZWN0UHJvbWlzZUNvbnRyb2xsZXIuY3JlYXRlKHsKICAgIHByb21pc2U6ICQuZ2V0SlNPTignL3NvbWUvcmVtb3RlL2RhdGEuanNvbicpCiAgfSk7CgogIGNvbnRyb2xsZXIudGhlbihmdW5jdGlvbihqc29uKXsKICAgICAvLyB0aGUganNvbgogIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAgIC8vIHRoZSByZWFzb24gd2h5IHlvdSBoYXZlIG5vIGpzb24KICB9KTsKICBgYGAKCiAgdGhlIGNvbnRyb2xsZXIgaGFzIGJpbmRhYmxlIGF0dHJpYnV0ZXMgd2hpY2gKICB0cmFjayB0aGUgcHJvbWlzZXMgbGlmZSBjeWNsZQoKICBgYGBqYXZhc2NyaXB0CiAgY29udHJvbGxlci5nZXQoJ2lzUGVuZGluZycpICAgLy89PiB0cnVlCiAgY29udHJvbGxlci5nZXQoJ2lzU2V0dGxlZCcpICAvLz0+IGZhbHNlCiAgY29udHJvbGxlci5nZXQoJ2lzUmVqZWN0ZWQnKSAgLy89PiBmYWxzZQogIGNvbnRyb2xsZXIuZ2V0KCdpc0Z1bGZpbGxlZCcpIC8vPT4gZmFsc2UKICBgYGAKCiAgV2hlbiB0aGUgdGhlICQuZ2V0SlNPTiBjb21wbGV0ZXMsIGFuZCB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQKICB3aXRoIGpzb24sIHRoZSBsaWZlIGN5Y2xlIGF0dHJpYnV0ZXMgd2lsbCB1cGRhdGUgYWNjb3JkaW5nbHkuCgogIGBgYGphdmFzY3JpcHQKICBjb250cm9sbGVyLmdldCgnaXNQZW5kaW5nJykgICAvLz0+IGZhbHNlCiAgY29udHJvbGxlci5nZXQoJ2lzU2V0dGxlZCcpICAgLy89PiB0cnVlCiAgY29udHJvbGxlci5nZXQoJ2lzUmVqZWN0ZWQnKSAgLy89PiBmYWxzZQogIGNvbnRyb2xsZXIuZ2V0KCdpc0Z1bGZpbGxlZCcpIC8vPT4gdHJ1ZQogIGBgYAoKICBBcyB0aGUgY29udHJvbGxlciBpcyBhbiBPYmplY3RDb250cm9sbGVyLCBhbmQgdGhlIGpzb24gbm93IGl0cyBjb250ZW50LAogIGFsbCB0aGUganNvbiBwcm9wZXJ0aWVzIHdpbGwgYmUgYXZhaWxhYmxlIGRpcmVjdGx5IGZyb20gdGhlIGNvbnRyb2xsZXIuCgogIGBgYGphdmFzY3JpcHQKICAvLyBBc3N1bWluZyB0aGUgZm9sbG93aW5nIGpzb246CiAgewogICAgZmlyc3ROYW1lOiAnU3RlZmFuJywKICAgIGxhc3ROYW1lOiAnUGVubmVyJwogIH0KCiAgLy8gYm90aCBwcm9wZXJ0aWVzIHdpbGwgYWNjZXNzaWJsZSBvbiB0aGUgY29udHJvbGxlcgogIGNvbnRyb2xsZXIuZ2V0KCdmaXJzdE5hbWUnKSAvLz0+ICdTdGVmYW4nCiAgY29udHJvbGxlci5nZXQoJ2xhc3ROYW1lJykgIC8vPT4gJ1Blbm5lcicKICBgYGAKCiAgSWYgdGhlIGNvbnRyb2xsZXIgaXMgYmFja2luZyBhIHRlbXBsYXRlLCB0aGUgYXR0cmlidXRlcyBhcmUKICBiaW5kYWJsZSBmcm9tIHdpdGhpbiB0aGF0IHRlbXBsYXRlCgogIGBgYGhhbmRsZWJhcnMKICB7eyNpZiBpc1BlbmRpbmd9fQogICAgbG9hZGluZy4uLgogIHt7ZWxzZX19CiAgICBmaXJzdE5hbWU6IHt7Zmlyc3ROYW1lfX0KICAgIGxhc3ROYW1lOiB7e2xhc3ROYW1lfX0KICB7ey9pZn19CiAgYGBgCiAgQGNsYXNzIEVtYmVyLlByb21pc2VQcm94eU1peGluCiovCkVtYmVyLlByb21pc2VQcm94eU1peGluID0gRW1iZXIuTWl4aW4uY3JlYXRlKHsKICAvKioKICAgIElmIHRoZSBwcm94aWVkIHByb21pc2UgaXMgcmVqZWN0ZWQgdGhpcyB3aWxsIGNvbnRhaW4gdGhlIHJlYXNvbgogICAgcHJvdmlkZWQuCgogICAgQHByb3BlcnR5IHJlYXNvbgogICAgQGRlZmF1bHQgbnVsbAogICovCiAgcmVhc29uOiAgICBudWxsLAoKICAvKioKICAgIE9uY2UgdGhlIHByb3hpZWQgcHJvbWlzZSBoYXMgc2V0dGxlZCB0aGlzIHdpbGwgYmVjb21lIGBmYWxzZWAuCgogICAgQHByb3BlcnR5IGlzUGVuZGluZwogICAgQGRlZmF1bHQgdHJ1ZQogICovCiAgaXNQZW5kaW5nOiAgbm90KCdpc1NldHRsZWQnKS5yZWFkT25seSgpLAoKICAvKioKICAgIE9uY2UgdGhlIHByb3hpZWQgcHJvbWlzZSBoYXMgc2V0dGxlZCB0aGlzIHdpbGwgYmVjb21lIGB0cnVlYC4KCiAgICBAcHJvcGVydHkgaXNTZXR0bGVkCiAgICBAZGVmYXVsdCBmYWxzZQogICovCiAgaXNTZXR0bGVkOiAgb3IoJ2lzUmVqZWN0ZWQnLCAnaXNGdWxmaWxsZWQnKS5yZWFkT25seSgpLAoKICAvKioKICAgIFdpbGwgYmVjb21lIGB0cnVlYCBpZiB0aGUgcHJveGllZCBwcm9taXNlIGlzIHJlamVjdGVkLgoKICAgIEBwcm9wZXJ0eSBpc1JlamVjdGVkCiAgICBAZGVmYXVsdCBmYWxzZQogICovCiAgaXNSZWplY3RlZDogIGZhbHNlLAoKICAvKioKICAgIFdpbGwgYmVjb21lIGB0cnVlYCBpZiB0aGUgcHJveGllZCBwcm9taXNlIGlzIGZ1bGZpbGxlZC4KCiAgICBAcHJvcGVydHkgaXNGdWxsZmlsbGVkCiAgICBAZGVmYXVsdCBmYWxzZQogICovCiAgaXNGdWxmaWxsZWQ6IGZhbHNlLAoKICAvKioKICAgIFRoZSBwcm9taXNlIHdob3NlIGZ1bGZpbGxtZW50IHZhbHVlIGlzIGJlaW5nIHByb3hpZWQgYnkgdGhpcyBvYmplY3QuCgogICAgVGhpcyBwcm9wZXJ0eSBtdXN0IGJlIHNwZWNpZmllZCB1cG9uIGNyZWF0aW9uLCBhbmQgc2hvdWxkIG5vdCBiZQogICAgY2hhbmdlZCBvbmNlIGNyZWF0ZWQuCgogICAgRXhhbXBsZToKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBFbWJlci5PYmplY3RDb250cm9sbGVyLmV4dGVuZChFbWJlci5Qcm9taXNlUHJveHlNaXhpbikuY3JlYXRlKHsKICAgICAgcHJvbWlzZTogPHRoZW5hYmxlPgogICAgfSk7CiAgICBgYGAKCiAgICBAcHJvcGVydHkgcHJvbWlzZQogICovCiAgcHJvbWlzZTogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oa2V5LCBwcm9taXNlKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikgewogICAgICBwcm9taXNlID0gcmVzb2x2ZShwcm9taXNlKTsKICAgICAgb2JzZXJ2ZVByb21pc2UodGhpcywgcHJvbWlzZSk7CiAgICAgIHJldHVybiBwcm9taXNlLnRoZW4oKTsgLy8gZm9yayB0aGUgcHJvbWlzZS4KICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFbWJlci5FcnJvcigiUHJvbWlzZVByb3h5J3MgcHJvbWlzZSBtdXN0IGJlIHNldCIpOwogICAgfQogIH0pLAoKICAvKioKICAgIEFuIGFsaWFzIHRvIHRoZSBwcm94aWVkIHByb21pc2UncyBgdGhlbmAuCgogICAgU2VlIFJTVlAuUHJvbWlzZS50aGVuLgoKICAgIEBtZXRob2QgdGhlbgogICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sKICAgIEByZXR1cm4ge1JTVlAuUHJvbWlzZX0KICAqLwogIHRoZW46IHByb21pc2VBbGlhcygndGhlbicpLAoKICAvKioKICAgIEFuIGFsaWFzIHRvIHRoZSBwcm94aWVkIHByb21pc2UncyBgY2F0Y2hgLgoKICAgIFNlZSBSU1ZQLlByb21pc2UuY2F0Y2guCgogICAgQG1ldGhvZCBjYXRjaAogICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sKICAgIEByZXR1cm4ge1JTVlAuUHJvbWlzZX0KICAqLwogICdjYXRjaCc6IHByb21pc2VBbGlhcygnY2F0Y2gnKSwKCiAgLyoqCiAgICBBbiBhbGlhcyB0byB0aGUgcHJveGllZCBwcm9taXNlJ3MgYGZpbmFsbHlgLgoKICAgIFNlZSBSU1ZQLlByb21pc2UuZmluYWxseS4KCiAgICBAbWV0aG9kIGZpbmFsbHkKICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrCiAgICBAcmV0dXJuIHtSU1ZQLlByb21pc2V9CiAgKi8KICAnZmluYWxseSc6IHByb21pc2VBbGlhcygnZmluYWxseScpCgp9KTsKCmZ1bmN0aW9uIHByb21pc2VBbGlhcyhuYW1lKSB7CiAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgIHZhciBwcm9taXNlID0gZ2V0KHRoaXMsICdwcm9taXNlJyk7CiAgICByZXR1cm4gcHJvbWlzZVtuYW1lXS5hcHBseShwcm9taXNlLCBhcmd1bWVudHMpOwogIH07Cn0KCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKdmFyIGdldCA9IEVtYmVyLmdldCwKICAgIGZvckVhY2ggPSBFbWJlci5FbnVtZXJhYmxlVXRpbHMuZm9yRWFjaCwKICAgIFJFVEFJTiA9ICdyJywKICAgIElOU0VSVCA9ICdpJywKICAgIERFTEVURSA9ICdkJzsKCi8qKgogIEFuIGBFbWJlci5UcmFja2VkQXJyYXlgIHRyYWNrcyBhcnJheSBvcGVyYXRpb25zLiAgSXQncyB1c2VmdWwgd2hlbiB5b3Ugd2FudCB0bwogIGxhemlseSBjb21wdXRlIHRoZSBpbmRleGVzIG9mIGl0ZW1zIGluIGFuIGFycmF5IGFmdGVyIHRoZXkndmUgYmVlbiBzaGlmdGVkIGJ5CiAgc3Vic2VxdWVudCBvcGVyYXRpb25zLgoKICBAY2xhc3MgVHJhY2tlZEFycmF5CiAgQG5hbWVzcGFjZSBFbWJlcgogIEBwYXJhbSB7YXJyYXl9IFtpdGVtcz1bXV0gVGhlIGFycmF5IHRvIGJlIHRyYWNrZWQuICBUaGlzIGlzIHVzZWQganVzdCB0byBnZXQKICB0aGUgaW5pdGlhbCBpdGVtcyBmb3IgdGhlIHN0YXJ0aW5nIHN0YXRlIG9mIHJldGFpbjpuLgoqLwpFbWJlci5UcmFja2VkQXJyYXkgPSBmdW5jdGlvbiAoaXRlbXMpIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IDEpIHsgaXRlbXMgPSBbXTsgfQoKICB2YXIgbGVuZ3RoID0gZ2V0KGl0ZW1zLCAnbGVuZ3RoJyk7CgogIGlmIChsZW5ndGgpIHsKICAgIHRoaXMuX29wZXJhdGlvbnMgPSBbbmV3IEFycmF5T3BlcmF0aW9uKFJFVEFJTiwgbGVuZ3RoLCBpdGVtcyldOwogIH0gZWxzZSB7CiAgICB0aGlzLl9vcGVyYXRpb25zID0gW107CiAgfQp9OwoKRW1iZXIuVHJhY2tlZEFycmF5LlJFVEFJTiA9IFJFVEFJTjsKRW1iZXIuVHJhY2tlZEFycmF5LklOU0VSVCA9IElOU0VSVDsKRW1iZXIuVHJhY2tlZEFycmF5LkRFTEVURSA9IERFTEVURTsKCkVtYmVyLlRyYWNrZWRBcnJheS5wcm90b3R5cGUgPSB7CgogIC8qKgogICAgVHJhY2sgdGhhdCBgbmV3SXRlbXNgIHdlcmUgYWRkZWQgdG8gdGhlIHRyYWNrZWQgYXJyYXkgYXQgYGluZGV4YC4KCiAgICBAbWV0aG9kIGFkZEl0ZW1zCiAgICBAcGFyYW0gaW5kZXgKICAgIEBwYXJhbSBuZXdJdGVtcwogICovCiAgYWRkSXRlbXM6IGZ1bmN0aW9uIChpbmRleCwgbmV3SXRlbXMpIHsKICAgIHZhciBjb3VudCA9IGdldChuZXdJdGVtcywgJ2xlbmd0aCcpOwogICAgaWYgKGNvdW50IDwgMSkgeyByZXR1cm47IH0KCiAgICB2YXIgbWF0Y2ggPSB0aGlzLl9maW5kQXJyYXlPcGVyYXRpb24oaW5kZXgpLAogICAgICAgIGFycmF5T3BlcmF0aW9uID0gbWF0Y2gub3BlcmF0aW9uLAogICAgICAgIGFycmF5T3BlcmF0aW9uSW5kZXggPSBtYXRjaC5pbmRleCwKICAgICAgICBhcnJheU9wZXJhdGlvblJhbmdlU3RhcnQgPSBtYXRjaC5yYW5nZVN0YXJ0LAogICAgICAgIGNvbXBvc2VJbmRleCwKICAgICAgICBzcGxpdEluZGV4LAogICAgICAgIHNwbGl0SXRlbXMsCiAgICAgICAgc3BsaXRBcnJheU9wZXJhdGlvbiwKICAgICAgICBuZXdBcnJheU9wZXJhdGlvbjsKCiAgICBuZXdBcnJheU9wZXJhdGlvbiA9IG5ldyBBcnJheU9wZXJhdGlvbihJTlNFUlQsIGNvdW50LCBuZXdJdGVtcyk7CgogICAgaWYgKGFycmF5T3BlcmF0aW9uKSB7CiAgICAgIGlmICghbWF0Y2guc3BsaXQpIHsKICAgICAgICAvLyBpbnNlcnQgbGVmdCBvZiBhcnJheU9wZXJhdGlvbgogICAgICAgIHRoaXMuX29wZXJhdGlvbnMuc3BsaWNlKGFycmF5T3BlcmF0aW9uSW5kZXgsIDAsIG5ld0FycmF5T3BlcmF0aW9uKTsKICAgICAgICBjb21wb3NlSW5kZXggPSBhcnJheU9wZXJhdGlvbkluZGV4OwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX3NwbGl0KGFycmF5T3BlcmF0aW9uSW5kZXgsIGluZGV4IC0gYXJyYXlPcGVyYXRpb25SYW5nZVN0YXJ0LCBuZXdBcnJheU9wZXJhdGlvbik7CiAgICAgICAgY29tcG9zZUluZGV4ID0gYXJyYXlPcGVyYXRpb25JbmRleCArIDE7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIC8vIGluc2VydCBhdCBlbmQKICAgICAgdGhpcy5fb3BlcmF0aW9ucy5wdXNoKG5ld0FycmF5T3BlcmF0aW9uKTsKICAgICAgY29tcG9zZUluZGV4ID0gYXJyYXlPcGVyYXRpb25JbmRleDsKICAgIH0KCiAgICB0aGlzLl9jb21wb3NlSW5zZXJ0KGNvbXBvc2VJbmRleCk7CiAgfSwKCiAgLyoqCiAgICBUcmFjayB0aGF0IGBjb3VudGAgaXRlbXMgd2VyZSByZW1vdmVkIGF0IGBpbmRleGAuCgogICAgQG1ldGhvZCByZW1vdmVJdGVtcwogICAgQHBhcmFtIGluZGV4CiAgICBAcGFyYW0gY291bnQKICAqLwogIHJlbW92ZUl0ZW1zOiBmdW5jdGlvbiAoaW5kZXgsIGNvdW50KSB7CiAgICBpZiAoY291bnQgPCAxKSB7IHJldHVybjsgfQoKICAgIHZhciBtYXRjaCA9IHRoaXMuX2ZpbmRBcnJheU9wZXJhdGlvbihpbmRleCksCiAgICAgICAgYXJyYXlPcGVyYXRpb24gPSBtYXRjaC5vcGVyYXRpb24sCiAgICAgICAgYXJyYXlPcGVyYXRpb25JbmRleCA9IG1hdGNoLmluZGV4LAogICAgICAgIGFycmF5T3BlcmF0aW9uUmFuZ2VTdGFydCA9IG1hdGNoLnJhbmdlU3RhcnQsCiAgICAgICAgbmV3QXJyYXlPcGVyYXRpb24sCiAgICAgICAgY29tcG9zZUluZGV4OwoKICAgIG5ld0FycmF5T3BlcmF0aW9uID0gbmV3IEFycmF5T3BlcmF0aW9uKERFTEVURSwgY291bnQpOwogICAgaWYgKCFtYXRjaC5zcGxpdCkgewogICAgICAvLyBpbnNlcnQgbGVmdCBvZiBhcnJheU9wZXJhdGlvbgogICAgICB0aGlzLl9vcGVyYXRpb25zLnNwbGljZShhcnJheU9wZXJhdGlvbkluZGV4LCAwLCBuZXdBcnJheU9wZXJhdGlvbik7CiAgICAgIGNvbXBvc2VJbmRleCA9IGFycmF5T3BlcmF0aW9uSW5kZXg7CiAgICB9IGVsc2UgewogICAgICB0aGlzLl9zcGxpdChhcnJheU9wZXJhdGlvbkluZGV4LCBpbmRleCAtIGFycmF5T3BlcmF0aW9uUmFuZ2VTdGFydCwgbmV3QXJyYXlPcGVyYXRpb24pOwogICAgICBjb21wb3NlSW5kZXggPSBhcnJheU9wZXJhdGlvbkluZGV4ICsgMTsKICAgIH0KCiAgICByZXR1cm4gdGhpcy5fY29tcG9zZURlbGV0ZShjb21wb3NlSW5kZXgpOwogIH0sCgogIC8qKgogICAgQXBwbHkgYWxsIG9wZXJhdGlvbnMsIHJlZHVjaW5nIHRoZW0gdG8gcmV0YWluOm4sIGZvciBgbmAsIHRoZSBudW1iZXIgb2YKICAgIGl0ZW1zIGluIHRoZSBhcnJheS4KCiAgICBgY2FsbGJhY2tgIHdpbGwgYmUgY2FsbGVkIGZvciBlYWNoIG9wZXJhdGlvbiBhbmQgd2lsbCBiZSBwYXNzZWQgdGhlIGZvbGxvd2luZyBhcmd1bWVudHM6CgogICAgKiB7YXJyYXl9IGl0ZW1zIFRoZSBpdGVtcyBmb3IgdGhlIGdpdmVuIG9wZXJhdGlvbgogICAgKiB7bnVtYmVyfSBvZmZzZXQgVGhlIGNvbXB1dGVkIG9mZnNldCBvZiB0aGUgaXRlbXMsIGllIHRoZSBpbmRleCBpbiB0aGUKICAgIGFycmF5IG9mIHRoZSBmaXJzdCBpdGVtIGZvciB0aGlzIG9wZXJhdGlvbi4KICAgICoge3N0cmluZ30gb3BlcmF0aW9uIFRoZSB0eXBlIG9mIHRoZSBvcGVyYXRpb24uICBPbmUgb2YKICAgIGBFbWJlci5UcmFja2VkQXJyYXkue1JFVEFJTiwgREVMRVRFLCBJTlNFUlR9YAoKICAgIEBtZXRob2QgYXBwbHkKICAgIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrCiAgKi8KICBhcHBseTogZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICB2YXIgaXRlbXMgPSBbXSwKICAgICAgICBvZmZzZXQgPSAwOwoKICAgIGZvckVhY2godGhpcy5fb3BlcmF0aW9ucywgZnVuY3Rpb24gKGFycmF5T3BlcmF0aW9uKSB7CiAgICAgIGNhbGxiYWNrKGFycmF5T3BlcmF0aW9uLml0ZW1zLCBvZmZzZXQsIGFycmF5T3BlcmF0aW9uLnR5cGUpOwoKICAgICAgaWYgKGFycmF5T3BlcmF0aW9uLnR5cGUgIT09IERFTEVURSkgewogICAgICAgIG9mZnNldCArPSBhcnJheU9wZXJhdGlvbi5jb3VudDsKICAgICAgICBpdGVtcyA9IGl0ZW1zLmNvbmNhdChhcnJheU9wZXJhdGlvbi5pdGVtcyk7CiAgICAgIH0KICAgIH0pOwoKICAgIHRoaXMuX29wZXJhdGlvbnMgPSBbbmV3IEFycmF5T3BlcmF0aW9uKFJFVEFJTiwgaXRlbXMubGVuZ3RoLCBpdGVtcyldOwogIH0sCgogIC8qKgogICAgUmV0dXJuIGFuIGBBcnJheU9wZXJhdGlvbk1hdGNoYCBmb3IgdGhlIG9wZXJhdGlvbiB0aGF0IGNvbnRhaW5zIHRoZSBpdGVtIGF0IGBpbmRleGAuCgogICAgQG1ldGhvZCBfZmluZEFycmF5T3BlcmF0aW9uCgogICAgQHBhcmFtIHtudW1iZXJ9IGluZGV4IHRoZSBpbmRleCBvZiB0aGUgaXRlbSB3aG9zZSBvcGVyYXRpb24gaW5mb3JtYXRpb24KICAgIHNob3VsZCBiZSByZXR1cm5lZC4KICAgIEBwcml2YXRlCiAgKi8KICBfZmluZEFycmF5T3BlcmF0aW9uOiBmdW5jdGlvbiAoaW5kZXgpIHsKICAgIHZhciBhcnJheU9wZXJhdGlvbkluZGV4LAogICAgICAgIGxlbiwKICAgICAgICBzcGxpdCA9IGZhbHNlLAogICAgICAgIGFycmF5T3BlcmF0aW9uLAogICAgICAgIGFycmF5T3BlcmF0aW9uUmFuZ2VTdGFydCwKICAgICAgICBhcnJheU9wZXJhdGlvblJhbmdlRW5kOwoKICAgIC8vIE9QVElNSVpFOiB3ZSBjb3VsZCBzZWFyY2ggdGhlc2UgZmFzdGVyIGlmIHdlIGtlcHQgYSBiYWxhbmNlZCB0cmVlLgogICAgLy8gZmluZCBsZWZ0bW9zdCBhcnJheU9wZXJhdGlvbiB0byB0aGUgcmlnaHQgb2YgYGluZGV4YAogICAgZm9yIChhcnJheU9wZXJhdGlvbkluZGV4ID0gYXJyYXlPcGVyYXRpb25SYW5nZVN0YXJ0ID0gMCwgbGVuID0gdGhpcy5fb3BlcmF0aW9ucy5sZW5ndGg7IGFycmF5T3BlcmF0aW9uSW5kZXggPCBsZW47ICsrYXJyYXlPcGVyYXRpb25JbmRleCkgewogICAgICBhcnJheU9wZXJhdGlvbiA9IHRoaXMuX29wZXJhdGlvbnNbYXJyYXlPcGVyYXRpb25JbmRleF07CgogICAgICBpZiAoYXJyYXlPcGVyYXRpb24udHlwZSA9PT0gREVMRVRFKSB7IGNvbnRpbnVlOyB9CgogICAgICBhcnJheU9wZXJhdGlvblJhbmdlRW5kID0gYXJyYXlPcGVyYXRpb25SYW5nZVN0YXJ0ICsgYXJyYXlPcGVyYXRpb24uY291bnQgLSAxOwoKICAgICAgaWYgKGluZGV4ID09PSBhcnJheU9wZXJhdGlvblJhbmdlU3RhcnQpIHsKICAgICAgICBicmVhazsKICAgICAgfSBlbHNlIGlmIChpbmRleCA+IGFycmF5T3BlcmF0aW9uUmFuZ2VTdGFydCAmJiBpbmRleCA8PSBhcnJheU9wZXJhdGlvblJhbmdlRW5kKSB7CiAgICAgICAgc3BsaXQgPSB0cnVlOwogICAgICAgIGJyZWFrOwogICAgICB9IGVsc2UgewogICAgICAgIGFycmF5T3BlcmF0aW9uUmFuZ2VTdGFydCA9IGFycmF5T3BlcmF0aW9uUmFuZ2VFbmQgKyAxOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG5ldyBBcnJheU9wZXJhdGlvbk1hdGNoKGFycmF5T3BlcmF0aW9uLCBhcnJheU9wZXJhdGlvbkluZGV4LCBzcGxpdCwgYXJyYXlPcGVyYXRpb25SYW5nZVN0YXJ0KTsKICB9LAoKICBfc3BsaXQ6IGZ1bmN0aW9uIChhcnJheU9wZXJhdGlvbkluZGV4LCBzcGxpdEluZGV4LCBuZXdBcnJheU9wZXJhdGlvbikgewogICAgdmFyIGFycmF5T3BlcmF0aW9uID0gdGhpcy5fb3BlcmF0aW9uc1thcnJheU9wZXJhdGlvbkluZGV4XSwKICAgICAgICBzcGxpdEl0ZW1zID0gYXJyYXlPcGVyYXRpb24uaXRlbXMuc2xpY2Uoc3BsaXRJbmRleCksCiAgICAgICAgc3BsaXRBcnJheU9wZXJhdGlvbiA9IG5ldyBBcnJheU9wZXJhdGlvbihhcnJheU9wZXJhdGlvbi50eXBlLCBzcGxpdEl0ZW1zLmxlbmd0aCwgc3BsaXRJdGVtcyk7CgogICAgLy8gdHJ1bmNhdGUgTEhTCiAgICBhcnJheU9wZXJhdGlvbi5jb3VudCA9IHNwbGl0SW5kZXg7CiAgICBhcnJheU9wZXJhdGlvbi5pdGVtcyA9IGFycmF5T3BlcmF0aW9uLml0ZW1zLnNsaWNlKDAsIHNwbGl0SW5kZXgpOwoKICAgIHRoaXMuX29wZXJhdGlvbnMuc3BsaWNlKGFycmF5T3BlcmF0aW9uSW5kZXggKyAxLCAwLCBuZXdBcnJheU9wZXJhdGlvbiwgc3BsaXRBcnJheU9wZXJhdGlvbik7CiAgfSwKCiAgLy8gc2VlIFN1YkFycmF5IGZvciBhIGJldHRlciBpbXBsZW1lbnRhdGlvbi4KICBfY29tcG9zZUluc2VydDogZnVuY3Rpb24gKGluZGV4KSB7CiAgICB2YXIgbmV3QXJyYXlPcGVyYXRpb24gPSB0aGlzLl9vcGVyYXRpb25zW2luZGV4XSwKICAgICAgICBsZWZ0QXJyYXlPcGVyYXRpb24gPSB0aGlzLl9vcGVyYXRpb25zW2luZGV4LTFdLCAvLyBtYXkgYmUgdW5kZWZpbmVkCiAgICAgICAgcmlnaHRBcnJheU9wZXJhdGlvbiA9IHRoaXMuX29wZXJhdGlvbnNbaW5kZXgrMV0sIC8vIG1heSBiZSB1bmRlZmluZWQKICAgICAgICBsZWZ0T3AgPSBsZWZ0QXJyYXlPcGVyYXRpb24gJiYgbGVmdEFycmF5T3BlcmF0aW9uLnR5cGUsCiAgICAgICAgcmlnaHRPcCA9IHJpZ2h0QXJyYXlPcGVyYXRpb24gJiYgcmlnaHRBcnJheU9wZXJhdGlvbi50eXBlOwoKICAgIGlmIChsZWZ0T3AgPT09IElOU0VSVCkgewogICAgICAgIC8vIG1lcmdlIGxlZnQKICAgICAgICBsZWZ0QXJyYXlPcGVyYXRpb24uY291bnQgKz0gbmV3QXJyYXlPcGVyYXRpb24uY291bnQ7CiAgICAgICAgbGVmdEFycmF5T3BlcmF0aW9uLml0ZW1zID0gbGVmdEFycmF5T3BlcmF0aW9uLml0ZW1zLmNvbmNhdChuZXdBcnJheU9wZXJhdGlvbi5pdGVtcyk7CgogICAgICBpZiAocmlnaHRPcCA9PT0gSU5TRVJUKSB7CiAgICAgICAgLy8gYWxzbyBtZXJnZSByaWdodCAod2UgaGF2ZSBzcGxpdCBhbiBpbnNlcnQgd2l0aCBhbiBpbnNlcnQpCiAgICAgICAgbGVmdEFycmF5T3BlcmF0aW9uLmNvdW50ICs9IHJpZ2h0QXJyYXlPcGVyYXRpb24uY291bnQ7CiAgICAgICAgbGVmdEFycmF5T3BlcmF0aW9uLml0ZW1zID0gbGVmdEFycmF5T3BlcmF0aW9uLml0ZW1zLmNvbmNhdChyaWdodEFycmF5T3BlcmF0aW9uLml0ZW1zKTsKICAgICAgICB0aGlzLl9vcGVyYXRpb25zLnNwbGljZShpbmRleCwgMik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gb25seSBtZXJnZSBsZWZ0CiAgICAgICAgdGhpcy5fb3BlcmF0aW9ucy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKHJpZ2h0T3AgPT09IElOU0VSVCkgewogICAgICAvLyBtZXJnZSByaWdodAogICAgICBuZXdBcnJheU9wZXJhdGlvbi5jb3VudCArPSByaWdodEFycmF5T3BlcmF0aW9uLmNvdW50OwogICAgICBuZXdBcnJheU9wZXJhdGlvbi5pdGVtcyA9IG5ld0FycmF5T3BlcmF0aW9uLml0ZW1zLmNvbmNhdChyaWdodEFycmF5T3BlcmF0aW9uLml0ZW1zKTsKICAgICAgdGhpcy5fb3BlcmF0aW9ucy5zcGxpY2UoaW5kZXggKyAxLCAxKTsKICAgIH0KICB9LAoKICBfY29tcG9zZURlbGV0ZTogZnVuY3Rpb24gKGluZGV4KSB7CiAgICB2YXIgYXJyYXlPcGVyYXRpb24gPSB0aGlzLl9vcGVyYXRpb25zW2luZGV4XSwKICAgICAgICBkZWxldGVzVG9HbyA9IGFycmF5T3BlcmF0aW9uLmNvdW50LAogICAgICAgIGxlZnRBcnJheU9wZXJhdGlvbiA9IHRoaXMuX29wZXJhdGlvbnNbaW5kZXgtMV0sIC8vIG1heSBiZSB1bmRlZmluZWQKICAgICAgICBsZWZ0T3AgPSBsZWZ0QXJyYXlPcGVyYXRpb24gJiYgbGVmdEFycmF5T3BlcmF0aW9uLnR5cGUsCiAgICAgICAgbmV4dEFycmF5T3BlcmF0aW9uLAogICAgICAgIG5leHRPcCwKICAgICAgICBuZXh0Q291bnQsCiAgICAgICAgcmVtb3ZlTmV3QW5kTmV4dE9wID0gZmFsc2UsCiAgICAgICAgcmVtb3ZlZEl0ZW1zID0gW107CgogICAgaWYgKGxlZnRPcCA9PT0gREVMRVRFKSB7CiAgICAgIGFycmF5T3BlcmF0aW9uID0gbGVmdEFycmF5T3BlcmF0aW9uOwogICAgICBpbmRleCAtPSAxOwogICAgfQoKICAgIGZvciAodmFyIGkgPSBpbmRleCArIDE7IGRlbGV0ZXNUb0dvID4gMDsgKytpKSB7CiAgICAgIG5leHRBcnJheU9wZXJhdGlvbiA9IHRoaXMuX29wZXJhdGlvbnNbaV07CiAgICAgIG5leHRPcCA9IG5leHRBcnJheU9wZXJhdGlvbi50eXBlOwogICAgICBuZXh0Q291bnQgPSBuZXh0QXJyYXlPcGVyYXRpb24uY291bnQ7CgogICAgICBpZiAobmV4dE9wID09PSBERUxFVEUpIHsKICAgICAgICBhcnJheU9wZXJhdGlvbi5jb3VudCArPSBuZXh0Q291bnQ7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIGlmIChuZXh0Q291bnQgPiBkZWxldGVzVG9HbykgewogICAgICAgIC8vIGQ6MiB7cixpfTo1ICB3ZSByZWR1Y2UgdGhlIHJldGFpbiBvciBpbnNlcnQsIGJ1dCBpdCBzdGF5cwogICAgICAgIHJlbW92ZWRJdGVtcyA9IHJlbW92ZWRJdGVtcy5jb25jYXQobmV4dEFycmF5T3BlcmF0aW9uLml0ZW1zLnNwbGljZSgwLCBkZWxldGVzVG9HbykpOwogICAgICAgIG5leHRBcnJheU9wZXJhdGlvbi5jb3VudCAtPSBkZWxldGVzVG9HbzsKCiAgICAgICAgLy8gSW4gdGhlIGNhc2Ugd2hlcmUgd2UgdHJ1bmNhdGUgdGhlIGxhc3QgYXJyYXlPcGVyYXRpb24sIHdlIGRvbid0IG5lZWQgdG8KICAgICAgICAvLyByZW1vdmUgaXQ7IGFsc28gdGhlIGRlbGV0ZXNUb0dvIHJlZHVjdGlvbiBpcyBub3QgdGhlIGVudGlyZXR5IG9mCiAgICAgICAgLy8gbmV4dENvdW50CiAgICAgICAgaSAtPSAxOwogICAgICAgIG5leHRDb3VudCA9IGRlbGV0ZXNUb0dvOwoKICAgICAgICBkZWxldGVzVG9HbyA9IDA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKG5leHRDb3VudCA9PT0gZGVsZXRlc1RvR28pIHsKICAgICAgICAgIC8vIEhhbmRsZSBlZGdlIGNhc2Ugb2YgZDoyIGk6MiBpbiB3aGljaCBjYXNlIGJvdGggb3BlcmF0aW9ucyBnbyBhd2F5CiAgICAgICAgICAvLyBkdXJpbmcgY29tcG9zaXRpb24uCiAgICAgICAgICByZW1vdmVOZXdBbmROZXh0T3AgPSB0cnVlOwogICAgICAgIH0KICAgICAgICByZW1vdmVkSXRlbXMgPSByZW1vdmVkSXRlbXMuY29uY2F0KG5leHRBcnJheU9wZXJhdGlvbi5pdGVtcyk7CiAgICAgICAgZGVsZXRlc1RvR28gLT0gbmV4dENvdW50OwogICAgICB9CgogICAgICBpZiAobmV4dE9wID09PSBJTlNFUlQpIHsKICAgICAgICAvLyBkOjIgaTozIHdpbGwgcmVzdWx0IGluIGRlbGV0ZSBnb2luZyBhd2F5CiAgICAgICAgYXJyYXlPcGVyYXRpb24uY291bnQgLT0gbmV4dENvdW50OwogICAgICB9CiAgICB9CgogICAgaWYgKGFycmF5T3BlcmF0aW9uLmNvdW50ID4gMCkgewogICAgICAvLyBjb21wb3NlIG91ciBuZXcgZGVsZXRlIHdpdGggcG9zc2libHkgc2V2ZXJhbCBvcGVyYXRpb25zIHRvIHRoZSByaWdodCBvZgogICAgICAvLyBkaXNwYXJhdGUgdHlwZXMKICAgICAgdGhpcy5fb3BlcmF0aW9ucy5zcGxpY2UoaW5kZXgrMSwgaS0xLWluZGV4KTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIFRoZSBkZWxldGUgb3BlcmF0aW9uIGNhbiBnbyBhd2F5OyBpdCBoYXMgbWVyZWx5IHJlZHVjZWQgc29tZSBvdGhlcgogICAgICAvLyBvcGVyYXRpb24sIGFzIGluIGQ6MyBpOjQ7IGl0IG1heSBhbHNvIGhhdmUgZWxpbWluYXRlZCB0aGF0IG9wZXJhdGlvbiwKICAgICAgLy8gYXMgaW4gZDozIGk6My4KICAgICAgdGhpcy5fb3BlcmF0aW9ucy5zcGxpY2UoaW5kZXgsIHJlbW92ZU5ld0FuZE5leHRPcCA/IDIgOiAxKTsKICAgIH0KCiAgICByZXR1cm4gcmVtb3ZlZEl0ZW1zOwogIH0sCgogIHRvU3RyaW5nOiBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc3RyID0gIiI7CiAgICBmb3JFYWNoKHRoaXMuX29wZXJhdGlvbnMsIGZ1bmN0aW9uIChvcGVyYXRpb24pIHsKICAgICAgc3RyICs9ICIgIiArIG9wZXJhdGlvbi50eXBlICsgIjoiICsgb3BlcmF0aW9uLmNvdW50OwogICAgfSk7CiAgICByZXR1cm4gc3RyLnN1YnN0cmluZygxKTsKICB9Cn07CgovKioKICBJbnRlcm5hbCBkYXRhIHN0cnVjdHVyZSB0byByZXByZXNlbnQgYW4gYXJyYXkgb3BlcmF0aW9uLgoKICBAbWV0aG9kIEFycmF5T3BlcmF0aW9uCiAgQHByaXZhdGUKICBAcGFyYW0ge3N0cmluZ30gdHlwZSBUaGUgdHlwZSBvZiB0aGUgb3BlcmF0aW9uLiAgT25lIG9mCiAgYEVtYmVyLlRyYWNrZWRBcnJheS57UkVUQUlOLCBJTlNFUlQsIERFTEVURX1gCiAgQHBhcmFtIHtudW1iZXJ9IGNvdW50IFRoZSBudW1iZXIgb2YgaXRlbXMgaW4gdGhpcyBvcGVyYXRpb24uCiAgQHBhcmFtIHthcnJheX0gaXRlbXMgVGhlIGl0ZW1zIG9mIHRoZSBvcGVyYXRpb24sIGlmIGluY2x1ZGVkLiAgUkVUQUlOIGFuZAogIElOU0VSVCBpbmNsdWRlIHRoZWlyIGl0ZW1zLCBERUxFVEUgZG9lcyBub3QuCiovCmZ1bmN0aW9uIEFycmF5T3BlcmF0aW9uIChvcGVyYXRpb24sIGNvdW50LCBpdGVtcykgewogIHRoaXMudHlwZSA9IG9wZXJhdGlvbjsgLy8gUkVUQUlOIHwgSU5TRVJUIHwgREVMRVRFCiAgdGhpcy5jb3VudCA9IGNvdW50OwogIHRoaXMuaXRlbXMgPSBpdGVtczsKfQoKLyoqCiAgSW50ZXJuYWwgZGF0YSBzdHJ1Y3R1cmUgdXNlZCB0byBpbmNsdWRlIGluZm9ybWF0aW9uIHdoZW4gbG9va2luZyB1cCBvcGVyYXRpb25zCiAgYnkgaXRlbSBpbmRleC4KCiAgQG1ldGhvZCBBcnJheU9wZXJhdGlvbk1hdGNoCiAgQHByaXZhdGUKICBAcGFyYW0ge0FycmF5T3BlcmF0aW9ufSBvcGVyYXRpb24KICBAcGFyYW0ge251bWJlcn0gaW5kZXggVGhlIGluZGV4IG9mIGBvcGVyYXRpb25gIGluIHRoZSBhcnJheSBvZiBvcGVyYXRpb25zLgogIEBwYXJhbSB7Ym9vbGVhbn0gc3BsaXQgV2hldGhlciBvciBub3QgdGhlIGl0ZW0gaW5kZXggc2VhcmNoZWQgZm9yIHdvdWxkCiAgcmVxdWlyZSBhIHNwbGl0IGZvciBhIG5ldyBvcGVyYXRpb24gdHlwZS4KICBAcGFyYW0ge251bWJlcn0gcmFuZ2VTdGFydCBUaGUgaW5kZXggb2YgdGhlIGZpcnN0IGl0ZW0gaW4gdGhlIG9wZXJhdGlvbiwKICB3aXRoIHJlc3BlY3QgdG8gdGhlIHRyYWNrZWQgYXJyYXkuICBUaGUgaW5kZXggb2YgdGhlIGxhc3QgaXRlbSBjYW4gYmUgY29tcHV0ZWQKICBmcm9tIGByYW5nZVN0YXJ0YCBhbmQgYG9wZXJhdGlvbi5jb3VudGAuCiovCmZ1bmN0aW9uIEFycmF5T3BlcmF0aW9uTWF0Y2gob3BlcmF0aW9uLCBpbmRleCwgc3BsaXQsIHJhbmdlU3RhcnQpIHsKICB0aGlzLm9wZXJhdGlvbiA9IG9wZXJhdGlvbjsKICB0aGlzLmluZGV4ID0gaW5kZXg7CiAgdGhpcy5zcGxpdCA9IHNwbGl0OwogIHRoaXMucmFuZ2VTdGFydCA9IHJhbmdlU3RhcnQ7Cn0KCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKdmFyIGdldCA9IEVtYmVyLmdldCwKICAgIGZvckVhY2ggPSBFbWJlci5FbnVtZXJhYmxlVXRpbHMuZm9yRWFjaCwKICAgIFJFVEFJTiA9ICdyJywKICAgIEZJTFRFUiA9ICdmJzsKCmZ1bmN0aW9uIE9wZXJhdGlvbiAodHlwZSwgY291bnQpIHsKICB0aGlzLnR5cGUgPSB0eXBlOwogIHRoaXMuY291bnQgPSBjb3VudDsKfQoKLyoqCiAgQW4gYEVtYmVyLlN1YkFycmF5YCB0cmFja3MgYW4gYXJyYXkgaW4gYSB3YXkgc2ltaWxhciB0bywgYnV0IG1vcmUgc3BlY2lhbGl6ZWQKICB0aGFuLCBgRW1iZXIuVHJhY2tlZEFycmF5YC4gIEl0IGlzIHVzZWZ1bCBmb3Iga2VlcGluZyB0cmFjayBvZiB0aGUgaW5kZXhlcyBvZgogIGl0ZW1zIHdpdGhpbiBhIGZpbHRlcmVkIGFycmF5LgoKICBAY2xhc3MgU3ViQXJyYXkKICBAbmFtZXNwYWNlIEVtYmVyCiovCkVtYmVyLlN1YkFycmF5ID0gZnVuY3Rpb24gKGxlbmd0aCkgewogIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMSkgeyBsZW5ndGggPSAwOyB9CgogIGlmIChsZW5ndGggPiAwKSB7CiAgICB0aGlzLl9vcGVyYXRpb25zID0gW25ldyBPcGVyYXRpb24oUkVUQUlOLCBsZW5ndGgpXTsKICB9IGVsc2UgewogICAgdGhpcy5fb3BlcmF0aW9ucyA9IFtdOwogIH0KfTsKCkVtYmVyLlN1YkFycmF5LnByb3RvdHlwZSA9IHsKICAvKioKICAgIFRyYWNrIHRoYXQgYW4gaXRlbSB3YXMgYWRkZWQgdG8gdGhlIHRyYWNrZWQgYXJyYXkuCgogICAgQG1ldGhvZCBhZGRJdGVtCgogICAgQHBhcmFtIHtudW1iZXJ9IGluZGV4IFRoZSBpbmRleCBvZiB0aGUgaXRlbSBpbiB0aGUgdHJhY2tlZCBhcnJheS4KICAgIEBwYXJhbSB7Ym9vbGVhbn0gbWF0Y2ggYHRydWVgIGlmZiB0aGUgaXRlbSBpcyBpbmNsdWRlZCBpbiB0aGUgc3ViYXJyYXkuCgogICAgQHJldHVybiB7bnVtYmVyfSBUaGUgaW5kZXggb2YgdGhlIGl0ZW0gaW4gdGhlIHN1YmFycmF5LgogICovCiAgYWRkSXRlbTogZnVuY3Rpb24oaW5kZXgsIG1hdGNoKSB7CiAgICB2YXIgcmV0dXJuVmFsdWUgPSAtMSwKICAgICAgICBpdGVtVHlwZSA9IG1hdGNoID8gUkVUQUlOIDogRklMVEVSLAogICAgICAgIHNlbGYgPSB0aGlzOwoKICAgIHRoaXMuX2ZpbmRPcGVyYXRpb24oaW5kZXgsIGZ1bmN0aW9uKG9wZXJhdGlvbiwgb3BlcmF0aW9uSW5kZXgsIHJhbmdlU3RhcnQsIHJhbmdlRW5kLCBzZWVuSW5TdWJBcnJheSkgewogICAgICB2YXIgbmV3T3BlcmF0aW9uLCBzcGxpdE9wZXJhdGlvbjsKCiAgICAgIGlmIChpdGVtVHlwZSA9PT0gb3BlcmF0aW9uLnR5cGUpIHsKICAgICAgICArK29wZXJhdGlvbi5jb3VudDsKICAgICAgfSBlbHNlIGlmIChpbmRleCA9PT0gcmFuZ2VTdGFydCkgewogICAgICAgIC8vIGluc2VydCB0byB0aGUgbGVmdCBvZiBgb3BlcmF0aW9uYAogICAgICAgIHNlbGYuX29wZXJhdGlvbnMuc3BsaWNlKG9wZXJhdGlvbkluZGV4LCAwLCBuZXcgT3BlcmF0aW9uKGl0ZW1UeXBlLCAxKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbmV3T3BlcmF0aW9uID0gbmV3IE9wZXJhdGlvbihpdGVtVHlwZSwgMSk7CiAgICAgICAgc3BsaXRPcGVyYXRpb24gPSBuZXcgT3BlcmF0aW9uKG9wZXJhdGlvbi50eXBlLCByYW5nZUVuZCAtIGluZGV4ICsgMSk7CiAgICAgICAgb3BlcmF0aW9uLmNvdW50ID0gaW5kZXggLSByYW5nZVN0YXJ0OwoKICAgICAgICBzZWxmLl9vcGVyYXRpb25zLnNwbGljZShvcGVyYXRpb25JbmRleCArIDEsIDAsIG5ld09wZXJhdGlvbiwgc3BsaXRPcGVyYXRpb24pOwogICAgICB9CgogICAgICBpZiAobWF0Y2gpIHsKICAgICAgICBpZiAob3BlcmF0aW9uLnR5cGUgPT09IFJFVEFJTikgewogICAgICAgICAgcmV0dXJuVmFsdWUgPSBzZWVuSW5TdWJBcnJheSArIChpbmRleCAtIHJhbmdlU3RhcnQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm5WYWx1ZSA9IHNlZW5JblN1YkFycmF5OwogICAgICAgIH0KICAgICAgfQoKICAgICAgc2VsZi5fY29tcG9zZUF0KG9wZXJhdGlvbkluZGV4KTsKICAgIH0sIGZ1bmN0aW9uKHNlZW5JblN1YkFycmF5KSB7CiAgICAgIHNlbGYuX29wZXJhdGlvbnMucHVzaChuZXcgT3BlcmF0aW9uKGl0ZW1UeXBlLCAxKSk7CgogICAgICBpZiAobWF0Y2gpIHsKICAgICAgICByZXR1cm5WYWx1ZSA9IHNlZW5JblN1YkFycmF5OwogICAgICB9CgogICAgICBzZWxmLl9jb21wb3NlQXQoc2VsZi5fb3BlcmF0aW9ucy5sZW5ndGgtMSk7CiAgICB9KTsKCiAgICByZXR1cm4gcmV0dXJuVmFsdWU7CiAgfSwKCiAgLyoqCiAgICBUcmFjayB0aGF0IGFuIGl0ZW0gd2FzIHJlbW92ZWQgZnJvbSB0aGUgdHJhY2tlZCBhcnJheS4KCiAgICBAbWV0aG9kIHJlbW92ZUl0ZW0KCiAgICBAcGFyYW0ge251bWJlcn0gaW5kZXggVGhlIGluZGV4IG9mIHRoZSBpdGVtIGluIHRoZSB0cmFja2VkIGFycmF5LgoKICAgIEByZXR1cm4ge251bWJlcn0gVGhlIGluZGV4IG9mIHRoZSBpdGVtIGluIHRoZSBzdWJhcnJheSwgb3IgYC0xYCBpZiB0aGUgaXRlbQogICAgd2FzIG5vdCBpbiB0aGUgc3ViYXJyYXkuCiAgKi8KICByZW1vdmVJdGVtOiBmdW5jdGlvbihpbmRleCkgewogICAgdmFyIHJldHVyblZhbHVlID0gLTEsCiAgICAgICAgc2VsZiA9IHRoaXM7CgogICAgdGhpcy5fZmluZE9wZXJhdGlvbihpbmRleCwgZnVuY3Rpb24gKG9wZXJhdGlvbiwgb3BlcmF0aW9uSW5kZXgsIHJhbmdlU3RhcnQsIHJhbmdlRW5kLCBzZWVuSW5TdWJBcnJheSkgewogICAgICBpZiAob3BlcmF0aW9uLnR5cGUgPT09IFJFVEFJTikgewogICAgICAgIHJldHVyblZhbHVlID0gc2VlbkluU3ViQXJyYXkgKyAoaW5kZXggLSByYW5nZVN0YXJ0KTsKICAgICAgfQoKICAgICAgaWYgKG9wZXJhdGlvbi5jb3VudCA+IDEpIHsKICAgICAgICAtLW9wZXJhdGlvbi5jb3VudDsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZWxmLl9vcGVyYXRpb25zLnNwbGljZShvcGVyYXRpb25JbmRleCwgMSk7CiAgICAgICAgc2VsZi5fY29tcG9zZUF0KG9wZXJhdGlvbkluZGV4KTsKICAgICAgfQogICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgIHRocm93IG5ldyBFbWJlci5FcnJvcigiQ2FuJ3QgcmVtb3ZlIGFuIGl0ZW0gdGhhdCBoYXMgbmV2ZXIgYmVlbiBhZGRlZC4iKTsKICAgIH0pOwoKICAgIHJldHVybiByZXR1cm5WYWx1ZTsKICB9LAoKCiAgX2ZpbmRPcGVyYXRpb246IGZ1bmN0aW9uIChpbmRleCwgZm91bmRDYWxsYmFjaywgbm90Rm91bmRDYWxsYmFjaykgewogICAgdmFyIG9wZXJhdGlvbkluZGV4LAogICAgICAgIGxlbiwKICAgICAgICBvcGVyYXRpb24sCiAgICAgICAgcmFuZ2VTdGFydCwKICAgICAgICByYW5nZUVuZCwKICAgICAgICBzZWVuSW5TdWJBcnJheSA9IDA7CgogICAgLy8gT1BUSU1JWkU6IGNoYW5nZSB0byBiYWxhbmNlZCB0cmVlCiAgICAvLyBmaW5kIGxlZnRtb3N0IG9wZXJhdGlvbiB0byB0aGUgcmlnaHQgb2YgYGluZGV4YAogICAgZm9yIChvcGVyYXRpb25JbmRleCA9IHJhbmdlU3RhcnQgPSAwLCBsZW4gPSB0aGlzLl9vcGVyYXRpb25zLmxlbmd0aDsgb3BlcmF0aW9uSW5kZXggPCBsZW47IHJhbmdlU3RhcnQgPSByYW5nZUVuZCArIDEsICsrb3BlcmF0aW9uSW5kZXgpIHsKICAgICAgb3BlcmF0aW9uID0gdGhpcy5fb3BlcmF0aW9uc1tvcGVyYXRpb25JbmRleF07CiAgICAgIHJhbmdlRW5kID0gcmFuZ2VTdGFydCArIG9wZXJhdGlvbi5jb3VudCAtIDE7CgogICAgICBpZiAoaW5kZXggPj0gcmFuZ2VTdGFydCAmJiBpbmRleCA8PSByYW5nZUVuZCkgewogICAgICAgIGZvdW5kQ2FsbGJhY2sob3BlcmF0aW9uLCBvcGVyYXRpb25JbmRleCwgcmFuZ2VTdGFydCwgcmFuZ2VFbmQsIHNlZW5JblN1YkFycmF5KTsKICAgICAgICByZXR1cm47CiAgICAgIH0gZWxzZSBpZiAob3BlcmF0aW9uLnR5cGUgPT09IFJFVEFJTikgewogICAgICAgIHNlZW5JblN1YkFycmF5ICs9IG9wZXJhdGlvbi5jb3VudDsKICAgICAgfQogICAgfQoKICAgIG5vdEZvdW5kQ2FsbGJhY2soc2VlbkluU3ViQXJyYXkpOwogIH0sCgogIF9jb21wb3NlQXQ6IGZ1bmN0aW9uKGluZGV4KSB7CiAgICB2YXIgb3AgPSB0aGlzLl9vcGVyYXRpb25zW2luZGV4XSwKICAgICAgICBvdGhlck9wOwoKICAgIGlmICghb3ApIHsKICAgICAgLy8gQ29tcG9zaW5nIG91dCBvZiBib3VuZHMgaXMgYSBuby1vcCwgYXMgd2hlbiByZW1vdmluZyB0aGUgbGFzdCBvcGVyYXRpb24KICAgICAgLy8gaW4gdGhlIGxpc3QuCiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoaW5kZXggPiAwKSB7CiAgICAgIG90aGVyT3AgPSB0aGlzLl9vcGVyYXRpb25zW2luZGV4LTFdOwogICAgICBpZiAob3RoZXJPcC50eXBlID09PSBvcC50eXBlKSB7CiAgICAgICAgb3AuY291bnQgKz0gb3RoZXJPcC5jb3VudDsKICAgICAgICB0aGlzLl9vcGVyYXRpb25zLnNwbGljZShpbmRleC0xLCAxKTsKICAgICAgICAtLWluZGV4OwogICAgICB9CiAgICB9CgogICAgaWYgKGluZGV4IDwgdGhpcy5fb3BlcmF0aW9ucy5sZW5ndGgtMSkgewogICAgICBvdGhlck9wID0gdGhpcy5fb3BlcmF0aW9uc1tpbmRleCsxXTsKICAgICAgaWYgKG90aGVyT3AudHlwZSA9PT0gb3AudHlwZSkgewogICAgICAgIG9wLmNvdW50ICs9IG90aGVyT3AuY291bnQ7CiAgICAgICAgdGhpcy5fb3BlcmF0aW9ucy5zcGxpY2UoaW5kZXgrMSwgMSk7CiAgICAgIH0KICAgIH0KICB9LAoKICB0b1N0cmluZzogZnVuY3Rpb24gKCkgewogICAgdmFyIHN0ciA9ICIiOwogICAgZm9yRWFjaCh0aGlzLl9vcGVyYXRpb25zLCBmdW5jdGlvbiAob3BlcmF0aW9uKSB7CiAgICAgIHN0ciArPSAiICIgKyBvcGVyYXRpb24udHlwZSArICI6IiArIG9wZXJhdGlvbi5jb3VudDsKICAgIH0pOwogICAgcmV0dXJuIHN0ci5zdWJzdHJpbmcoMSk7CiAgfQp9OwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewpFbWJlci5Db250YWluZXIgPSByZXF1aXJlTW9kdWxlKCdjb250YWluZXInKTsKRW1iZXIuQ29udGFpbmVyLnNldCA9IEVtYmVyLnNldDsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKRW1iZXIuQXBwbGljYXRpb24gPSBFbWJlci5OYW1lc3BhY2UuZXh0ZW5kKCk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItcnVudGltZQoqLwoKdmFyIE9VVF9PRl9SQU5HRV9FWENFUFRJT04gPSAiSW5kZXggb3V0IG9mIHJhbmdlIjsKdmFyIEVNUFRZID0gW107Cgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQ7CgovKioKICBBbiBBcnJheVByb3h5IHdyYXBzIGFueSBvdGhlciBvYmplY3QgdGhhdCBpbXBsZW1lbnRzIGBFbWJlci5BcnJheWAgYW5kL29yCiAgYEVtYmVyLk11dGFibGVBcnJheSxgIGZvcndhcmRpbmcgYWxsIHJlcXVlc3RzLiBUaGlzIG1ha2VzIGl0IHZlcnkgdXNlZnVsIGZvcgogIGEgbnVtYmVyIG9mIGJpbmRpbmcgdXNlIGNhc2VzIG9yIG90aGVyIGNhc2VzIHdoZXJlIGJlaW5nIGFibGUgdG8gc3dhcAogIG91dCB0aGUgdW5kZXJseWluZyBhcnJheSBpcyB1c2VmdWwuCgogIEEgc2ltcGxlIGV4YW1wbGUgb2YgdXNhZ2U6CgogIGBgYGphdmFzY3JpcHQKICB2YXIgcGV0cyA9IFsnZG9nJywgJ2NhdCcsICdmaXNoJ107CiAgdmFyIGFwID0gRW1iZXIuQXJyYXlQcm94eS5jcmVhdGUoeyBjb250ZW50OiBFbWJlci5BKHBldHMpIH0pOwoKICBhcC5nZXQoJ2ZpcnN0T2JqZWN0Jyk7ICAgICAgICAgICAgICAgICAgICAgICAgLy8gJ2RvZycKICBhcC5zZXQoJ2NvbnRlbnQnLCBbJ2Ftb2ViYScsICdwYXJhbWVjaXVtJ10pOwogIGFwLmdldCgnZmlyc3RPYmplY3QnKTsgICAgICAgICAgICAgICAgICAgICAgICAvLyAnYW1vZWJhJwogIGBgYAoKICBUaGlzIGNsYXNzIGNhbiBhbHNvIGJlIHVzZWZ1bCBhcyBhIGxheWVyIHRvIHRyYW5zZm9ybSB0aGUgY29udGVudHMgb2YKICBhbiBhcnJheSwgYXMgdGhleSBhcmUgYWNjZXNzZWQuIFRoaXMgY2FuIGJlIGRvbmUgYnkgb3ZlcnJpZGluZwogIGBvYmplY3RBdENvbnRlbnRgOgoKICBgYGBqYXZhc2NyaXB0CiAgdmFyIHBldHMgPSBbJ2RvZycsICdjYXQnLCAnZmlzaCddOwogIHZhciBhcCA9IEVtYmVyLkFycmF5UHJveHkuY3JlYXRlKHsKICAgICAgY29udGVudDogRW1iZXIuQShwZXRzKSwKICAgICAgb2JqZWN0QXRDb250ZW50OiBmdW5jdGlvbihpZHgpIHsKICAgICAgICAgIHJldHVybiB0aGlzLmdldCgnY29udGVudCcpLm9iamVjdEF0KGlkeCkudG9VcHBlckNhc2UoKTsKICAgICAgfQogIH0pOwoKICBhcC5nZXQoJ2ZpcnN0T2JqZWN0Jyk7IC8vIC4gJ0RPRycKICBgYGAKCiAgQGNsYXNzIEFycmF5UHJveHkKICBAbmFtZXNwYWNlIEVtYmVyCiAgQGV4dGVuZHMgRW1iZXIuT2JqZWN0CiAgQHVzZXMgRW1iZXIuTXV0YWJsZUFycmF5CiovCkVtYmVyLkFycmF5UHJveHkgPSBFbWJlci5PYmplY3QuZXh0ZW5kKEVtYmVyLk11dGFibGVBcnJheSwgewoKICAvKioKICAgIFRoZSBjb250ZW50IGFycmF5LiBNdXN0IGJlIGFuIG9iamVjdCB0aGF0IGltcGxlbWVudHMgYEVtYmVyLkFycmF5YCBhbmQvb3IKICAgIGBFbWJlci5NdXRhYmxlQXJyYXkuYAoKICAgIEBwcm9wZXJ0eSBjb250ZW50CiAgICBAdHlwZSBFbWJlci5BcnJheQogICovCiAgY29udGVudDogbnVsbCwKCiAgLyoqCiAgIFRoZSBhcnJheSB0aGF0IHRoZSBwcm94eSBwcmV0ZW5kcyB0byBiZS4gSW4gdGhlIGRlZmF1bHQgYEFycmF5UHJveHlgCiAgIGltcGxlbWVudGF0aW9uLCB0aGlzIGFuZCBgY29udGVudGAgYXJlIHRoZSBzYW1lLiBTdWJjbGFzc2VzIG9mIGBBcnJheVByb3h5YAogICBjYW4gb3ZlcnJpZGUgdGhpcyBwcm9wZXJ0eSB0byBwcm92aWRlIHRoaW5ncyBsaWtlIHNvcnRpbmcgYW5kIGZpbHRlcmluZy4KCiAgIEBwcm9wZXJ0eSBhcnJhbmdlZENvbnRlbnQKICAqLwogIGFycmFuZ2VkQ29udGVudDogRW1iZXIuY29tcHV0ZWQuYWxpYXMoJ2NvbnRlbnQnKSwKCiAgLyoqCiAgICBTaG91bGQgYWN0dWFsbHkgcmV0cmlldmUgdGhlIG9iamVjdCBhdCB0aGUgc3BlY2lmaWVkIGluZGV4IGZyb20gdGhlCiAgICBjb250ZW50LiBZb3UgY2FuIG92ZXJyaWRlIHRoaXMgbWV0aG9kIGluIHN1YmNsYXNzZXMgdG8gdHJhbnNmb3JtIHRoZQogICAgY29udGVudCBpdGVtIHRvIHNvbWV0aGluZyBuZXcuCgogICAgVGhpcyBtZXRob2Qgd2lsbCBvbmx5IGJlIGNhbGxlZCBpZiBjb250ZW50IGlzIG5vbi1gbnVsbGAuCgogICAgQG1ldGhvZCBvYmplY3RBdENvbnRlbnQKICAgIEBwYXJhbSB7TnVtYmVyfSBpZHggVGhlIGluZGV4IHRvIHJldHJpZXZlLgogICAgQHJldHVybiB7T2JqZWN0fSB0aGUgdmFsdWUgb3IgdW5kZWZpbmVkIGlmIG5vbmUgZm91bmQKICAqLwogIG9iamVjdEF0Q29udGVudDogZnVuY3Rpb24oaWR4KSB7CiAgICByZXR1cm4gZ2V0KHRoaXMsICdhcnJhbmdlZENvbnRlbnQnKS5vYmplY3RBdChpZHgpOwogIH0sCgogIC8qKgogICAgU2hvdWxkIGFjdHVhbGx5IHJlcGxhY2UgdGhlIHNwZWNpZmllZCBvYmplY3RzIG9uIHRoZSBjb250ZW50IGFycmF5LgogICAgWW91IGNhbiBvdmVycmlkZSB0aGlzIG1ldGhvZCBpbiBzdWJjbGFzc2VzIHRvIHRyYW5zZm9ybSB0aGUgY29udGVudCBpdGVtCiAgICBpbnRvIHNvbWV0aGluZyBuZXcuCgogICAgVGhpcyBtZXRob2Qgd2lsbCBvbmx5IGJlIGNhbGxlZCBpZiBjb250ZW50IGlzIG5vbi1gbnVsbGAuCgogICAgQG1ldGhvZCByZXBsYWNlQ29udGVudAogICAgQHBhcmFtIHtOdW1iZXJ9IGlkeCBUaGUgc3RhcnRpbmcgaW5kZXgKICAgIEBwYXJhbSB7TnVtYmVyfSBhbXQgVGhlIG51bWJlciBvZiBpdGVtcyB0byByZW1vdmUgZnJvbSB0aGUgY29udGVudC4KICAgIEBwYXJhbSB7QXJyYXl9IG9iamVjdHMgT3B0aW9uYWwgYXJyYXkgb2Ygb2JqZWN0cyB0byBpbnNlcnQgb3IgbnVsbCBpZiBubwogICAgICBvYmplY3RzLgogICAgQHJldHVybiB7dm9pZH0KICAqLwogIHJlcGxhY2VDb250ZW50OiBmdW5jdGlvbihpZHgsIGFtdCwgb2JqZWN0cykgewogICAgZ2V0KHRoaXMsICdjb250ZW50JykucmVwbGFjZShpZHgsIGFtdCwgb2JqZWN0cyk7CiAgfSwKCiAgLyoqCiAgICBJbnZva2VkIHdoZW4gdGhlIGNvbnRlbnQgcHJvcGVydHkgaXMgYWJvdXQgdG8gY2hhbmdlLiBOb3RpZmllcyBvYnNlcnZlcnMgdGhhdCB0aGUKICAgIGVudGlyZSBhcnJheSBjb250ZW50IHdpbGwgY2hhbmdlLgoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIF9jb250ZW50V2lsbENoYW5nZQogICovCiAgX2NvbnRlbnRXaWxsQ2hhbmdlOiBFbWJlci5iZWZvcmVPYnNlcnZlcignY29udGVudCcsIGZ1bmN0aW9uKCkgewogICAgdGhpcy5fdGVhcmRvd25Db250ZW50KCk7CiAgfSksCgogIF90ZWFyZG93bkNvbnRlbnQ6IGZ1bmN0aW9uKCkgewogICAgdmFyIGNvbnRlbnQgPSBnZXQodGhpcywgJ2NvbnRlbnQnKTsKCiAgICBpZiAoY29udGVudCkgewogICAgICBjb250ZW50LnJlbW92ZUFycmF5T2JzZXJ2ZXIodGhpcywgewogICAgICAgIHdpbGxDaGFuZ2U6ICdjb250ZW50QXJyYXlXaWxsQ2hhbmdlJywKICAgICAgICBkaWRDaGFuZ2U6ICdjb250ZW50QXJyYXlEaWRDaGFuZ2UnCiAgICAgIH0pOwogICAgfQogIH0sCgogIGNvbnRlbnRBcnJheVdpbGxDaGFuZ2U6IEVtYmVyLkssCiAgY29udGVudEFycmF5RGlkQ2hhbmdlOiBFbWJlci5LLAoKICAvKioKICAgIEludm9rZWQgd2hlbiB0aGUgY29udGVudCBwcm9wZXJ0eSBjaGFuZ2VzLiBOb3RpZmllcyBvYnNlcnZlcnMgdGhhdCB0aGUKICAgIGVudGlyZSBhcnJheSBjb250ZW50IGhhcyBjaGFuZ2VkLgoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIF9jb250ZW50RGlkQ2hhbmdlCiAgKi8KICBfY29udGVudERpZENoYW5nZTogRW1iZXIub2JzZXJ2ZXIoJ2NvbnRlbnQnLCBmdW5jdGlvbigpIHsKICAgIHZhciBjb250ZW50ID0gZ2V0KHRoaXMsICdjb250ZW50Jyk7CgogICAgRW1iZXIuYXNzZXJ0KCJDYW4ndCBzZXQgQXJyYXlQcm94eSdzIGNvbnRlbnQgdG8gaXRzZWxmIiwgY29udGVudCAhPT0gdGhpcyk7CgogICAgdGhpcy5fc2V0dXBDb250ZW50KCk7CiAgfSksCgogIF9zZXR1cENvbnRlbnQ6IGZ1bmN0aW9uKCkgewogICAgdmFyIGNvbnRlbnQgPSBnZXQodGhpcywgJ2NvbnRlbnQnKTsKCiAgICBpZiAoY29udGVudCkgewogICAgICBjb250ZW50LmFkZEFycmF5T2JzZXJ2ZXIodGhpcywgewogICAgICAgIHdpbGxDaGFuZ2U6ICdjb250ZW50QXJyYXlXaWxsQ2hhbmdlJywKICAgICAgICBkaWRDaGFuZ2U6ICdjb250ZW50QXJyYXlEaWRDaGFuZ2UnCiAgICAgIH0pOwogICAgfQogIH0sCgogIF9hcnJhbmdlZENvbnRlbnRXaWxsQ2hhbmdlOiBFbWJlci5iZWZvcmVPYnNlcnZlcignYXJyYW5nZWRDb250ZW50JywgZnVuY3Rpb24oKSB7CiAgICB2YXIgYXJyYW5nZWRDb250ZW50ID0gZ2V0KHRoaXMsICdhcnJhbmdlZENvbnRlbnQnKSwKICAgICAgICBsZW4gPSBhcnJhbmdlZENvbnRlbnQgPyBnZXQoYXJyYW5nZWRDb250ZW50LCAnbGVuZ3RoJykgOiAwOwoKICAgIHRoaXMuYXJyYW5nZWRDb250ZW50QXJyYXlXaWxsQ2hhbmdlKHRoaXMsIDAsIGxlbiwgdW5kZWZpbmVkKTsKICAgIHRoaXMuYXJyYW5nZWRDb250ZW50V2lsbENoYW5nZSh0aGlzKTsKCiAgICB0aGlzLl90ZWFyZG93bkFycmFuZ2VkQ29udGVudChhcnJhbmdlZENvbnRlbnQpOwogIH0pLAoKICBfYXJyYW5nZWRDb250ZW50RGlkQ2hhbmdlOiBFbWJlci5vYnNlcnZlcignYXJyYW5nZWRDb250ZW50JywgZnVuY3Rpb24oKSB7CiAgICB2YXIgYXJyYW5nZWRDb250ZW50ID0gZ2V0KHRoaXMsICdhcnJhbmdlZENvbnRlbnQnKSwKICAgICAgICBsZW4gPSBhcnJhbmdlZENvbnRlbnQgPyBnZXQoYXJyYW5nZWRDb250ZW50LCAnbGVuZ3RoJykgOiAwOwoKICAgIEVtYmVyLmFzc2VydCgiQ2FuJ3Qgc2V0IEFycmF5UHJveHkncyBjb250ZW50IHRvIGl0c2VsZiIsIGFycmFuZ2VkQ29udGVudCAhPT0gdGhpcyk7CgogICAgdGhpcy5fc2V0dXBBcnJhbmdlZENvbnRlbnQoKTsKCiAgICB0aGlzLmFycmFuZ2VkQ29udGVudERpZENoYW5nZSh0aGlzKTsKICAgIHRoaXMuYXJyYW5nZWRDb250ZW50QXJyYXlEaWRDaGFuZ2UodGhpcywgMCwgdW5kZWZpbmVkLCBsZW4pOwogIH0pLAoKICBfc2V0dXBBcnJhbmdlZENvbnRlbnQ6IGZ1bmN0aW9uKCkgewogICAgdmFyIGFycmFuZ2VkQ29udGVudCA9IGdldCh0aGlzLCAnYXJyYW5nZWRDb250ZW50Jyk7CgogICAgaWYgKGFycmFuZ2VkQ29udGVudCkgewogICAgICBhcnJhbmdlZENvbnRlbnQuYWRkQXJyYXlPYnNlcnZlcih0aGlzLCB7CiAgICAgICAgd2lsbENoYW5nZTogJ2FycmFuZ2VkQ29udGVudEFycmF5V2lsbENoYW5nZScsCiAgICAgICAgZGlkQ2hhbmdlOiAnYXJyYW5nZWRDb250ZW50QXJyYXlEaWRDaGFuZ2UnCiAgICAgIH0pOwogICAgfQogIH0sCgogIF90ZWFyZG93bkFycmFuZ2VkQ29udGVudDogZnVuY3Rpb24oKSB7CiAgICB2YXIgYXJyYW5nZWRDb250ZW50ID0gZ2V0KHRoaXMsICdhcnJhbmdlZENvbnRlbnQnKTsKCiAgICBpZiAoYXJyYW5nZWRDb250ZW50KSB7CiAgICAgIGFycmFuZ2VkQ29udGVudC5yZW1vdmVBcnJheU9ic2VydmVyKHRoaXMsIHsKICAgICAgICB3aWxsQ2hhbmdlOiAnYXJyYW5nZWRDb250ZW50QXJyYXlXaWxsQ2hhbmdlJywKICAgICAgICBkaWRDaGFuZ2U6ICdhcnJhbmdlZENvbnRlbnRBcnJheURpZENoYW5nZScKICAgICAgfSk7CiAgICB9CiAgfSwKCiAgYXJyYW5nZWRDb250ZW50V2lsbENoYW5nZTogRW1iZXIuSywKICBhcnJhbmdlZENvbnRlbnREaWRDaGFuZ2U6IEVtYmVyLkssCgogIG9iamVjdEF0OiBmdW5jdGlvbihpZHgpIHsKICAgIHJldHVybiBnZXQodGhpcywgJ2NvbnRlbnQnKSAmJiB0aGlzLm9iamVjdEF0Q29udGVudChpZHgpOwogIH0sCgogIGxlbmd0aDogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oKSB7CiAgICB2YXIgYXJyYW5nZWRDb250ZW50ID0gZ2V0KHRoaXMsICdhcnJhbmdlZENvbnRlbnQnKTsKICAgIHJldHVybiBhcnJhbmdlZENvbnRlbnQgPyBnZXQoYXJyYW5nZWRDb250ZW50LCAnbGVuZ3RoJykgOiAwOwogICAgLy8gTm8gZGVwZW5kZW5jaWVzIHNpbmNlIEVudW1lcmFibGUgbm90aWZpZXMgbGVuZ3RoIG9mIGNoYW5nZQogIH0pLAoKICBfcmVwbGFjZTogZnVuY3Rpb24oaWR4LCBhbXQsIG9iamVjdHMpIHsKICAgIHZhciBjb250ZW50ID0gZ2V0KHRoaXMsICdjb250ZW50Jyk7CiAgICBFbWJlci5hc3NlcnQoJ1RoZSBjb250ZW50IHByb3BlcnR5IG9mICcrIHRoaXMuY29uc3RydWN0b3IgKyAnIHNob3VsZCBiZSBzZXQgYmVmb3JlIG1vZGlmeWluZyBpdCcsIGNvbnRlbnQpOwogICAgaWYgKGNvbnRlbnQpIHRoaXMucmVwbGFjZUNvbnRlbnQoaWR4LCBhbXQsIG9iamVjdHMpOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgcmVwbGFjZTogZnVuY3Rpb24oKSB7CiAgICBpZiAoZ2V0KHRoaXMsICdhcnJhbmdlZENvbnRlbnQnKSA9PT0gZ2V0KHRoaXMsICdjb250ZW50JykpIHsKICAgICAgdGhpcy5fcmVwbGFjZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVtYmVyLkVycm9yKCJVc2luZyByZXBsYWNlIG9uIGFuIGFycmFuZ2VkIEFycmF5UHJveHkgaXMgbm90IGFsbG93ZWQuIik7CiAgICB9CiAgfSwKCiAgX2luc2VydEF0OiBmdW5jdGlvbihpZHgsIG9iamVjdCkgewogICAgaWYgKGlkeCA+IGdldCh0aGlzLCAnY29udGVudC5sZW5ndGgnKSkgdGhyb3cgbmV3IEVtYmVyLkVycm9yKE9VVF9PRl9SQU5HRV9FWENFUFRJT04pOwogICAgdGhpcy5fcmVwbGFjZShpZHgsIDAsIFtvYmplY3RdKTsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIGluc2VydEF0OiBmdW5jdGlvbihpZHgsIG9iamVjdCkgewogICAgaWYgKGdldCh0aGlzLCAnYXJyYW5nZWRDb250ZW50JykgPT09IGdldCh0aGlzLCAnY29udGVudCcpKSB7CiAgICAgIHJldHVybiB0aGlzLl9pbnNlcnRBdChpZHgsIG9iamVjdCk7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoIlVzaW5nIGluc2VydEF0IG9uIGFuIGFycmFuZ2VkIEFycmF5UHJveHkgaXMgbm90IGFsbG93ZWQuIik7CiAgICB9CiAgfSwKCiAgcmVtb3ZlQXQ6IGZ1bmN0aW9uKHN0YXJ0LCBsZW4pIHsKICAgIGlmICgnbnVtYmVyJyA9PT0gdHlwZW9mIHN0YXJ0KSB7CiAgICAgIHZhciBjb250ZW50ID0gZ2V0KHRoaXMsICdjb250ZW50JyksCiAgICAgICAgICBhcnJhbmdlZENvbnRlbnQgPSBnZXQodGhpcywgJ2FycmFuZ2VkQ29udGVudCcpLAogICAgICAgICAgaW5kaWNlcyA9IFtdLCBpOwoKICAgICAgaWYgKChzdGFydCA8IDApIHx8IChzdGFydCA+PSBnZXQodGhpcywgJ2xlbmd0aCcpKSkgewogICAgICAgIHRocm93IG5ldyBFbWJlci5FcnJvcihPVVRfT0ZfUkFOR0VfRVhDRVBUSU9OKTsKICAgICAgfQoKICAgICAgaWYgKGxlbiA9PT0gdW5kZWZpbmVkKSBsZW4gPSAxOwoKICAgICAgLy8gR2V0IGEgbGlzdCBvZiBpbmRpY2VzIGluIG9yaWdpbmFsIGNvbnRlbnQgdG8gcmVtb3ZlCiAgICAgIGZvciAoaT1zdGFydDsgaTxzdGFydCtsZW47IGkrKykgewogICAgICAgIC8vIFVzZSBhcnJhbmdlZENvbnRlbnQgaGVyZSBzbyB3ZSBhdm9pZCBjb25mdXNpb24gd2l0aCBvYmplY3RzIHRyYW5zZm9ybWVkIGJ5IG9iamVjdEF0Q29udGVudAogICAgICAgIGluZGljZXMucHVzaChjb250ZW50LmluZGV4T2YoYXJyYW5nZWRDb250ZW50Lm9iamVjdEF0KGkpKSk7CiAgICAgIH0KCiAgICAgIC8vIFJlcGxhY2UgaW4gcmV2ZXJzZSBvcmRlciBzaW5jZSBpbmRpY2VzIHdpbGwgY2hhbmdlCiAgICAgIGluZGljZXMuc29ydChmdW5jdGlvbihhLGIpIHsgcmV0dXJuIGIgLSBhOyB9KTsKCiAgICAgIEVtYmVyLmJlZ2luUHJvcGVydHlDaGFuZ2VzKCk7CiAgICAgIGZvciAoaT0wOyBpPGluZGljZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB0aGlzLl9yZXBsYWNlKGluZGljZXNbaV0sIDEsIEVNUFRZKTsKICAgICAgfQogICAgICBFbWJlci5lbmRQcm9wZXJ0eUNoYW5nZXMoKTsKICAgIH0KCiAgICByZXR1cm4gdGhpcyA7CiAgfSwKCiAgcHVzaE9iamVjdDogZnVuY3Rpb24ob2JqKSB7CiAgICB0aGlzLl9pbnNlcnRBdChnZXQodGhpcywgJ2NvbnRlbnQubGVuZ3RoJyksIG9iaikgOwogICAgcmV0dXJuIG9iaiA7CiAgfSwKCiAgcHVzaE9iamVjdHM6IGZ1bmN0aW9uKG9iamVjdHMpIHsKICAgIGlmICghKEVtYmVyLkVudW1lcmFibGUuZGV0ZWN0KG9iamVjdHMpIHx8IEVtYmVyLmlzQXJyYXkob2JqZWN0cykpKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIk11c3QgcGFzcyBFbWJlci5FbnVtZXJhYmxlIHRvIEVtYmVyLk11dGFibGVBcnJheSNwdXNoT2JqZWN0cyIpOwogICAgfQogICAgdGhpcy5fcmVwbGFjZShnZXQodGhpcywgJ2xlbmd0aCcpLCAwLCBvYmplY3RzKTsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIHNldE9iamVjdHM6IGZ1bmN0aW9uKG9iamVjdHMpIHsKICAgIGlmIChvYmplY3RzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHRoaXMuY2xlYXIoKTsKCiAgICB2YXIgbGVuID0gZ2V0KHRoaXMsICdsZW5ndGgnKTsKICAgIHRoaXMuX3JlcGxhY2UoMCwgbGVuLCBvYmplY3RzKTsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIHVuc2hpZnRPYmplY3Q6IGZ1bmN0aW9uKG9iaikgewogICAgdGhpcy5faW5zZXJ0QXQoMCwgb2JqKSA7CiAgICByZXR1cm4gb2JqIDsKICB9LAoKICB1bnNoaWZ0T2JqZWN0czogZnVuY3Rpb24ob2JqZWN0cykgewogICAgdGhpcy5fcmVwbGFjZSgwLCAwLCBvYmplY3RzKTsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIHNsaWNlOiBmdW5jdGlvbigpIHsKICAgIHZhciBhcnIgPSB0aGlzLnRvQXJyYXkoKTsKICAgIHJldHVybiBhcnIuc2xpY2UuYXBwbHkoYXJyLCBhcmd1bWVudHMpOwogIH0sCgogIGFycmFuZ2VkQ29udGVudEFycmF5V2lsbENoYW5nZTogZnVuY3Rpb24oaXRlbSwgaWR4LCByZW1vdmVkQ250LCBhZGRlZENudCkgewogICAgdGhpcy5hcnJheUNvbnRlbnRXaWxsQ2hhbmdlKGlkeCwgcmVtb3ZlZENudCwgYWRkZWRDbnQpOwogIH0sCgogIGFycmFuZ2VkQ29udGVudEFycmF5RGlkQ2hhbmdlOiBmdW5jdGlvbihpdGVtLCBpZHgsIHJlbW92ZWRDbnQsIGFkZGVkQ250KSB7CiAgICB0aGlzLmFycmF5Q29udGVudERpZENoYW5nZShpZHgsIHJlbW92ZWRDbnQsIGFkZGVkQ250KTsKICB9LAoKICBpbml0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3N1cGVyKCk7CiAgICB0aGlzLl9zZXR1cENvbnRlbnQoKTsKICAgIHRoaXMuX3NldHVwQXJyYW5nZWRDb250ZW50KCk7CiAgfSwKCiAgd2lsbERlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fdGVhcmRvd25BcnJhbmdlZENvbnRlbnQoKTsKICAgIHRoaXMuX3RlYXJkb3duQ29udGVudCgpOwogIH0KfSk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItcnVudGltZQoqLwoKCnZhciBzZXQgPSBFbWJlci5zZXQsIGdldCA9IEVtYmVyLmdldCwgZ3VpZEZvciA9IEVtYmVyLmd1aWRGb3I7CnZhciBmb3JFYWNoID0gRW1iZXIuRW51bWVyYWJsZVV0aWxzLmZvckVhY2gsCiAgICBpbmRleE9mID0gRW1iZXIuQXJyYXlQb2x5ZmlsbHMuaW5kZXhPZjsKCnZhciBFYWNoQXJyYXkgPSBFbWJlci5PYmplY3QuZXh0ZW5kKEVtYmVyLkFycmF5LCB7CgogIGluaXQ6IGZ1bmN0aW9uKGNvbnRlbnQsIGtleU5hbWUsIG93bmVyKSB7CiAgICB0aGlzLl9zdXBlcigpOwogICAgdGhpcy5fa2V5TmFtZSA9IGtleU5hbWU7CiAgICB0aGlzLl9vd25lciAgID0gb3duZXI7CiAgICB0aGlzLl9jb250ZW50ID0gY29udGVudDsKICB9LAoKICBvYmplY3RBdDogZnVuY3Rpb24oaWR4KSB7CiAgICB2YXIgaXRlbSA9IHRoaXMuX2NvbnRlbnQub2JqZWN0QXQoaWR4KTsKICAgIHJldHVybiBpdGVtICYmIGdldChpdGVtLCB0aGlzLl9rZXlOYW1lKTsKICB9LAoKICBsZW5ndGg6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewogICAgdmFyIGNvbnRlbnQgPSB0aGlzLl9jb250ZW50OwogICAgcmV0dXJuIGNvbnRlbnQgPyBnZXQoY29udGVudCwgJ2xlbmd0aCcpIDogMDsKICB9KQoKfSk7Cgp2YXIgSVNfT0JTRVJWRVIgPSAvXi4rOihiZWZvcmV8Y2hhbmdlKSQvOwoKZnVuY3Rpb24gYWRkT2JzZXJ2ZXJGb3JDb250ZW50S2V5KGNvbnRlbnQsIGtleU5hbWUsIHByb3h5LCBpZHgsIGxvYykgewogIHZhciBvYmplY3RzID0gcHJveHkuX29iamVjdHMsIGd1aWQ7CiAgaWYgKCFvYmplY3RzKSBvYmplY3RzID0gcHJveHkuX29iamVjdHMgPSB7fTsKCiAgd2hpbGUoLS1sb2M+PWlkeCkgewogICAgdmFyIGl0ZW0gPSBjb250ZW50Lm9iamVjdEF0KGxvYyk7CiAgICBpZiAoaXRlbSkgewogICAgICBFbWJlci5hc3NlcnQoJ1doZW4gdXNpbmcgQGVhY2ggdG8gb2JzZXJ2ZSB0aGUgYXJyYXkgJyArIGNvbnRlbnQgKyAnLCB0aGUgYXJyYXkgbXVzdCByZXR1cm4gYW4gb2JqZWN0JywgRW1iZXIudHlwZU9mKGl0ZW0pID09PSAnaW5zdGFuY2UnIHx8IEVtYmVyLnR5cGVPZihpdGVtKSA9PT0gJ29iamVjdCcpOwogICAgICBFbWJlci5hZGRCZWZvcmVPYnNlcnZlcihpdGVtLCBrZXlOYW1lLCBwcm94eSwgJ2NvbnRlbnRLZXlXaWxsQ2hhbmdlJyk7CiAgICAgIEVtYmVyLmFkZE9ic2VydmVyKGl0ZW0sIGtleU5hbWUsIHByb3h5LCAnY29udGVudEtleURpZENoYW5nZScpOwoKICAgICAgLy8ga2VlcCB0cmFjayBvZiB0aGUgaW5kZXggZWFjaCBpdGVtIHdhcyBmb3VuZCBhdCBzbyB3ZSBjYW4gbWFwCiAgICAgIC8vIGl0IGJhY2sgd2hlbiB0aGUgb2JqIGNoYW5nZXMuCiAgICAgIGd1aWQgPSBndWlkRm9yKGl0ZW0pOwogICAgICBpZiAoIW9iamVjdHNbZ3VpZF0pIG9iamVjdHNbZ3VpZF0gPSBbXTsKICAgICAgb2JqZWN0c1tndWlkXS5wdXNoKGxvYyk7CiAgICB9CiAgfQp9CgpmdW5jdGlvbiByZW1vdmVPYnNlcnZlckZvckNvbnRlbnRLZXkoY29udGVudCwga2V5TmFtZSwgcHJveHksIGlkeCwgbG9jKSB7CiAgdmFyIG9iamVjdHMgPSBwcm94eS5fb2JqZWN0czsKICBpZiAoIW9iamVjdHMpIG9iamVjdHMgPSBwcm94eS5fb2JqZWN0cyA9IHt9OwogIHZhciBpbmRpY2llcywgZ3VpZDsKCiAgd2hpbGUoLS1sb2M+PWlkeCkgewogICAgdmFyIGl0ZW0gPSBjb250ZW50Lm9iamVjdEF0KGxvYyk7CiAgICBpZiAoaXRlbSkgewogICAgICBFbWJlci5yZW1vdmVCZWZvcmVPYnNlcnZlcihpdGVtLCBrZXlOYW1lLCBwcm94eSwgJ2NvbnRlbnRLZXlXaWxsQ2hhbmdlJyk7CiAgICAgIEVtYmVyLnJlbW92ZU9ic2VydmVyKGl0ZW0sIGtleU5hbWUsIHByb3h5LCAnY29udGVudEtleURpZENoYW5nZScpOwoKICAgICAgZ3VpZCA9IGd1aWRGb3IoaXRlbSk7CiAgICAgIGluZGljaWVzID0gb2JqZWN0c1tndWlkXTsKICAgICAgaW5kaWNpZXNbaW5kZXhPZi5jYWxsKGluZGljaWVzLCBsb2MpXSA9IG51bGw7CiAgICB9CiAgfQp9CgovKioKICBUaGlzIGlzIHRoZSBvYmplY3QgaW5zdGFuY2UgcmV0dXJuZWQgd2hlbiB5b3UgZ2V0IHRoZSBgQGVhY2hgIHByb3BlcnR5IG9uIGFuCiAgYXJyYXkuIEl0IHVzZXMgdGhlIHVua25vd25Qcm9wZXJ0eSBoYW5kbGVyIHRvIGF1dG9tYXRpY2FsbHkgY3JlYXRlCiAgRWFjaEFycmF5IGluc3RhbmNlcyBmb3IgcHJvcGVydHkgbmFtZXMuCgogIEBwcml2YXRlCiAgQGNsYXNzIEVhY2hQcm94eQogIEBuYW1lc3BhY2UgRW1iZXIKICBAZXh0ZW5kcyBFbWJlci5PYmplY3QKKi8KRW1iZXIuRWFjaFByb3h5ID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CgogIGluaXQ6IGZ1bmN0aW9uKGNvbnRlbnQpIHsKICAgIHRoaXMuX3N1cGVyKCk7CiAgICB0aGlzLl9jb250ZW50ID0gY29udGVudDsKICAgIGNvbnRlbnQuYWRkQXJyYXlPYnNlcnZlcih0aGlzKTsKCiAgICAvLyBpbiBjYXNlIHNvbWVvbmUgaXMgYWxyZWFkeSBvYnNlcnZpbmcgc29tZSBrZXlzIG1ha2Ugc3VyZSB0aGV5IGFyZQogICAgLy8gYWRkZWQKICAgIGZvckVhY2goRW1iZXIud2F0Y2hlZEV2ZW50cyh0aGlzKSwgZnVuY3Rpb24oZXZlbnROYW1lKSB7CiAgICAgIHRoaXMuZGlkQWRkTGlzdGVuZXIoZXZlbnROYW1lKTsKICAgIH0sIHRoaXMpOwogIH0sCgogIC8qKgogICAgWW91IGNhbiBkaXJlY3RseSBhY2Nlc3MgbWFwcGVkIHByb3BlcnRpZXMgYnkgc2ltcGx5IHJlcXVlc3RpbmcgdGhlbS4KICAgIFRoZSBgdW5rbm93blByb3BlcnR5YCBoYW5kbGVyIHdpbGwgZ2VuZXJhdGUgYW4gRWFjaEFycmF5IG9mIGVhY2ggaXRlbS4KCiAgICBAbWV0aG9kIHVua25vd25Qcm9wZXJ0eQogICAgQHBhcmFtIGtleU5hbWUge1N0cmluZ30KICAgIEBwYXJhbSB2YWx1ZSB7Kn0KICAqLwogIHVua25vd25Qcm9wZXJ0eTogZnVuY3Rpb24oa2V5TmFtZSwgdmFsdWUpIHsKICAgIHZhciByZXQ7CiAgICByZXQgPSBuZXcgRWFjaEFycmF5KHRoaXMuX2NvbnRlbnQsIGtleU5hbWUsIHRoaXMpOwogICAgRW1iZXIuZGVmaW5lUHJvcGVydHkodGhpcywga2V5TmFtZSwgbnVsbCwgcmV0KTsKICAgIHRoaXMuYmVnaW5PYnNlcnZpbmdDb250ZW50S2V5KGtleU5hbWUpOwogICAgcmV0dXJuIHJldDsKICB9LAoKICAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCiAgLy8gQVJSQVkgQ0hBTkdFUwogIC8vIEludm9rZXMgd2hlbmV2ZXIgdGhlIGNvbnRlbnQgYXJyYXkgaXRzZWxmIGNoYW5nZXMuCgogIGFycmF5V2lsbENoYW5nZTogZnVuY3Rpb24oY29udGVudCwgaWR4LCByZW1vdmVkQ250LCBhZGRlZENudCkgewogICAgdmFyIGtleXMgPSB0aGlzLl9rZXlzLCBrZXksIGxpbTsKCiAgICBsaW0gPSByZW1vdmVkQ250PjAgPyBpZHgrcmVtb3ZlZENudCA6IC0xOwogICAgRW1iZXIuYmVnaW5Qcm9wZXJ0eUNoYW5nZXModGhpcyk7CgogICAgZm9yKGtleSBpbiBrZXlzKSB7CiAgICAgIGlmICgha2V5cy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7IGNvbnRpbnVlOyB9CgogICAgICBpZiAobGltPjApIHsgcmVtb3ZlT2JzZXJ2ZXJGb3JDb250ZW50S2V5KGNvbnRlbnQsIGtleSwgdGhpcywgaWR4LCBsaW0pOyB9CgogICAgICBFbWJlci5wcm9wZXJ0eVdpbGxDaGFuZ2UodGhpcywga2V5KTsKICAgIH0KCiAgICBFbWJlci5wcm9wZXJ0eVdpbGxDaGFuZ2UodGhpcy5fY29udGVudCwgJ0BlYWNoJyk7CiAgICBFbWJlci5lbmRQcm9wZXJ0eUNoYW5nZXModGhpcyk7CiAgfSwKCiAgYXJyYXlEaWRDaGFuZ2U6IGZ1bmN0aW9uKGNvbnRlbnQsIGlkeCwgcmVtb3ZlZENudCwgYWRkZWRDbnQpIHsKICAgIHZhciBrZXlzID0gdGhpcy5fa2V5cywgbGltOwoKICAgIGxpbSA9IGFkZGVkQ250PjAgPyBpZHgrYWRkZWRDbnQgOiAtMTsKICAgIEVtYmVyLmNoYW5nZVByb3BlcnRpZXMoZnVuY3Rpb24oKSB7CiAgICAgIGZvcih2YXIga2V5IGluIGtleXMpIHsKICAgICAgICBpZiAoIWtleXMuaGFzT3duUHJvcGVydHkoa2V5KSkgeyBjb250aW51ZTsgfQoKICAgICAgICBpZiAobGltPjApIHsgYWRkT2JzZXJ2ZXJGb3JDb250ZW50S2V5KGNvbnRlbnQsIGtleSwgdGhpcywgaWR4LCBsaW0pOyB9CgogICAgICAgIEVtYmVyLnByb3BlcnR5RGlkQ2hhbmdlKHRoaXMsIGtleSk7CiAgICAgIH0KCiAgICAgIEVtYmVyLnByb3BlcnR5RGlkQ2hhbmdlKHRoaXMuX2NvbnRlbnQsICdAZWFjaCcpOwogICAgfSwgdGhpcyk7CiAgfSwKCiAgLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgogIC8vIExJU1RFTiBGT1IgTkVXIE9CU0VSVkVSUyBBTkQgT1RIRVIgRVZFTlQgTElTVEVORVJTCiAgLy8gU3RhcnQgbW9uaXRvcmluZyBrZXlzIGJhc2VkIG9uIHdobyBpcyBsaXN0ZW5pbmcuLi4KCiAgZGlkQWRkTGlzdGVuZXI6IGZ1bmN0aW9uKGV2ZW50TmFtZSkgewogICAgaWYgKElTX09CU0VSVkVSLnRlc3QoZXZlbnROYW1lKSkgewogICAgICB0aGlzLmJlZ2luT2JzZXJ2aW5nQ29udGVudEtleShldmVudE5hbWUuc2xpY2UoMCwgLTcpKTsKICAgIH0KICB9LAoKICBkaWRSZW1vdmVMaXN0ZW5lcjogZnVuY3Rpb24oZXZlbnROYW1lKSB7CiAgICBpZiAoSVNfT0JTRVJWRVIudGVzdChldmVudE5hbWUpKSB7CiAgICAgIHRoaXMuc3RvcE9ic2VydmluZ0NvbnRlbnRLZXkoZXZlbnROYW1lLnNsaWNlKDAsIC03KSk7CiAgICB9CiAgfSwKCiAgLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgogIC8vIENPTlRFTlQgS0VZIE9CU0VSVklORwogIC8vIEFjdHVhbCB3YXRjaCBrZXlzIG9uIHRoZSBzb3VyY2UgY29udGVudC4KCiAgYmVnaW5PYnNlcnZpbmdDb250ZW50S2V5OiBmdW5jdGlvbihrZXlOYW1lKSB7CiAgICB2YXIga2V5cyA9IHRoaXMuX2tleXM7CiAgICBpZiAoIWtleXMpIGtleXMgPSB0aGlzLl9rZXlzID0ge307CiAgICBpZiAoIWtleXNba2V5TmFtZV0pIHsKICAgICAga2V5c1trZXlOYW1lXSA9IDE7CiAgICAgIHZhciBjb250ZW50ID0gdGhpcy5fY29udGVudCwKICAgICAgICAgIGxlbiA9IGdldChjb250ZW50LCAnbGVuZ3RoJyk7CiAgICAgIGFkZE9ic2VydmVyRm9yQ29udGVudEtleShjb250ZW50LCBrZXlOYW1lLCB0aGlzLCAwLCBsZW4pOwogICAgfSBlbHNlIHsKICAgICAga2V5c1trZXlOYW1lXSsrOwogICAgfQogIH0sCgogIHN0b3BPYnNlcnZpbmdDb250ZW50S2V5OiBmdW5jdGlvbihrZXlOYW1lKSB7CiAgICB2YXIga2V5cyA9IHRoaXMuX2tleXM7CiAgICBpZiAoa2V5cyAmJiAoa2V5c1trZXlOYW1lXT4wKSAmJiAoLS1rZXlzW2tleU5hbWVdPD0wKSkgewogICAgICB2YXIgY29udGVudCA9IHRoaXMuX2NvbnRlbnQsCiAgICAgICAgICBsZW4gICAgID0gZ2V0KGNvbnRlbnQsICdsZW5ndGgnKTsKICAgICAgcmVtb3ZlT2JzZXJ2ZXJGb3JDb250ZW50S2V5KGNvbnRlbnQsIGtleU5hbWUsIHRoaXMsIDAsIGxlbik7CiAgICB9CiAgfSwKCiAgY29udGVudEtleVdpbGxDaGFuZ2U6IGZ1bmN0aW9uKG9iaiwga2V5TmFtZSkgewogICAgRW1iZXIucHJvcGVydHlXaWxsQ2hhbmdlKHRoaXMsIGtleU5hbWUpOwogIH0sCgogIGNvbnRlbnRLZXlEaWRDaGFuZ2U6IGZ1bmN0aW9uKG9iaiwga2V5TmFtZSkgewogICAgRW1iZXIucHJvcGVydHlEaWRDaGFuZ2UodGhpcywga2V5TmFtZSk7CiAgfQoKfSk7CgoKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1ydW50aW1lCiovCgoKdmFyIGdldCA9IEVtYmVyLmdldCwgc2V0ID0gRW1iZXIuc2V0LCByZXBsYWNlID0gRW1iZXIuRW51bWVyYWJsZVV0aWxzLl9yZXBsYWNlOwoKLy8gQWRkIEVtYmVyLkFycmF5IHRvIEFycmF5LnByb3RvdHlwZS4gUmVtb3ZlIG1ldGhvZHMgd2l0aCBuYXRpdmUKLy8gaW1wbGVtZW50YXRpb25zIGFuZCBzdXBwbHkgc29tZSBtb3JlIG9wdGltaXplZCB2ZXJzaW9ucyBvZiBnZW5lcmljIG1ldGhvZHMKLy8gYmVjYXVzZSB0aGV5IGFyZSBzbyBjb21tb24uCnZhciBOYXRpdmVBcnJheSA9IEVtYmVyLk1peGluLmNyZWF0ZShFbWJlci5NdXRhYmxlQXJyYXksIEVtYmVyLk9ic2VydmFibGUsIEVtYmVyLkNvcHlhYmxlLCB7CgogIC8vIGJlY2F1c2UgbGVuZ3RoIGlzIGEgYnVpbHQtaW4gcHJvcGVydHkgd2UgbmVlZCB0byBrbm93IHRvIGp1c3QgZ2V0IHRoZQogIC8vIG9yaWdpbmFsIHByb3BlcnR5LgogIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICBpZiAoa2V5PT09J2xlbmd0aCcpIHJldHVybiB0aGlzLmxlbmd0aDsKICAgIGVsc2UgaWYgKCdudW1iZXInID09PSB0eXBlb2Yga2V5KSByZXR1cm4gdGhpc1trZXldOwogICAgZWxzZSByZXR1cm4gdGhpcy5fc3VwZXIoa2V5KTsKICB9LAoKICBvYmplY3RBdDogZnVuY3Rpb24oaWR4KSB7CiAgICByZXR1cm4gdGhpc1tpZHhdOwogIH0sCgogIC8vIHByaW1pdGl2ZSBmb3IgYXJyYXkgc3VwcG9ydC4KICByZXBsYWNlOiBmdW5jdGlvbihpZHgsIGFtdCwgb2JqZWN0cykgewoKICAgIGlmICh0aGlzLmlzRnJvemVuKSB0aHJvdyBFbWJlci5GUk9aRU5fRVJST1I7CgogICAgLy8gaWYgd2UgcmVwbGFjZWQgZXhhY3RseSB0aGUgc2FtZSBudW1iZXIgb2YgaXRlbXMsIHRoZW4gcGFzcyBvbmx5IHRoZQogICAgLy8gcmVwbGFjZWQgcmFuZ2UuIE90aGVyd2lzZSwgcGFzcyB0aGUgZnVsbCByZW1haW5pbmcgYXJyYXkgbGVuZ3RoCiAgICAvLyBzaW5jZSBldmVyeXRoaW5nIGhhcyBzaGlmdGVkCiAgICB2YXIgbGVuID0gb2JqZWN0cyA/IGdldChvYmplY3RzLCAnbGVuZ3RoJykgOiAwOwogICAgdGhpcy5hcnJheUNvbnRlbnRXaWxsQ2hhbmdlKGlkeCwgYW10LCBsZW4pOwoKICAgIGlmIChsZW4gPT09IDApIHsKICAgICAgdGhpcy5zcGxpY2UoaWR4LCBhbXQpOwogICAgfSBlbHNlIHsKICAgICAgcmVwbGFjZSh0aGlzLCBpZHgsIGFtdCwgb2JqZWN0cyk7CiAgICB9CgogICAgdGhpcy5hcnJheUNvbnRlbnREaWRDaGFuZ2UoaWR4LCBhbXQsIGxlbik7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvLyBJZiB5b3UgYXNrIGZvciBhbiB1bmtub3duIHByb3BlcnR5LCB0aGVuIHRyeSB0byBjb2xsZWN0IHRoZSB2YWx1ZQogIC8vIGZyb20gbWVtYmVyIGl0ZW1zLgogIHVua25vd25Qcm9wZXJ0eTogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgdmFyIHJldDsvLyA9IHRoaXMucmVkdWNlZFByb3BlcnR5KGtleSwgdmFsdWUpIDsKICAgIGlmICgodmFsdWUgIT09IHVuZGVmaW5lZCkgJiYgcmV0ID09PSB1bmRlZmluZWQpIHsKICAgICAgcmV0ID0gdGhpc1trZXldID0gdmFsdWU7CiAgICB9CiAgICByZXR1cm4gcmV0IDsKICB9LAoKICAvLyBJZiBicm93c2VyIGRpZCBub3QgaW1wbGVtZW50IGluZGV4T2YgbmF0aXZlbHksIHRoZW4gb3ZlcnJpZGUgd2l0aAogIC8vIHNwZWNpYWxpemVkIHZlcnNpb24KICBpbmRleE9mOiBmdW5jdGlvbihvYmplY3QsIHN0YXJ0QXQpIHsKICAgIHZhciBpZHgsIGxlbiA9IHRoaXMubGVuZ3RoOwoKICAgIGlmIChzdGFydEF0ID09PSB1bmRlZmluZWQpIHN0YXJ0QXQgPSAwOwogICAgZWxzZSBzdGFydEF0ID0gKHN0YXJ0QXQgPCAwKSA/IE1hdGguY2VpbChzdGFydEF0KSA6IE1hdGguZmxvb3Ioc3RhcnRBdCk7CiAgICBpZiAoc3RhcnRBdCA8IDApIHN0YXJ0QXQgKz0gbGVuOwoKICAgIGZvcihpZHg9c3RhcnRBdDtpZHg8bGVuO2lkeCsrKSB7CiAgICAgIGlmICh0aGlzW2lkeF0gPT09IG9iamVjdCkgcmV0dXJuIGlkeCA7CiAgICB9CiAgICByZXR1cm4gLTE7CiAgfSwKCiAgbGFzdEluZGV4T2Y6IGZ1bmN0aW9uKG9iamVjdCwgc3RhcnRBdCkgewogICAgdmFyIGlkeCwgbGVuID0gdGhpcy5sZW5ndGg7CgogICAgaWYgKHN0YXJ0QXQgPT09IHVuZGVmaW5lZCkgc3RhcnRBdCA9IGxlbi0xOwogICAgZWxzZSBzdGFydEF0ID0gKHN0YXJ0QXQgPCAwKSA/IE1hdGguY2VpbChzdGFydEF0KSA6IE1hdGguZmxvb3Ioc3RhcnRBdCk7CiAgICBpZiAoc3RhcnRBdCA8IDApIHN0YXJ0QXQgKz0gbGVuOwoKICAgIGZvcihpZHg9c3RhcnRBdDtpZHg+PTA7aWR4LS0pIHsKICAgICAgaWYgKHRoaXNbaWR4XSA9PT0gb2JqZWN0KSByZXR1cm4gaWR4IDsKICAgIH0KICAgIHJldHVybiAtMTsKICB9LAoKICBjb3B5OiBmdW5jdGlvbihkZWVwKSB7CiAgICBpZiAoZGVlcCkgewogICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24oaXRlbSkgeyByZXR1cm4gRW1iZXIuY29weShpdGVtLCB0cnVlKTsgfSk7CiAgICB9CgogICAgcmV0dXJuIHRoaXMuc2xpY2UoKTsKICB9Cn0pOwoKLy8gUmVtb3ZlIGFueSBtZXRob2RzIGltcGxlbWVudGVkIG5hdGl2ZWx5IHNvIHdlIGRvbid0IG92ZXJyaWRlIHRoZW0KdmFyIGlnbm9yZSA9IFsnbGVuZ3RoJ107CkVtYmVyLkVudW1lcmFibGVVdGlscy5mb3JFYWNoKE5hdGl2ZUFycmF5LmtleXMoKSwgZnVuY3Rpb24obWV0aG9kTmFtZSkgewogIGlmIChBcnJheS5wcm90b3R5cGVbbWV0aG9kTmFtZV0pIGlnbm9yZS5wdXNoKG1ldGhvZE5hbWUpOwp9KTsKCmlmIChpZ25vcmUubGVuZ3RoPjApIHsKICBOYXRpdmVBcnJheSA9IE5hdGl2ZUFycmF5LndpdGhvdXQuYXBwbHkoTmF0aXZlQXJyYXksIGlnbm9yZSk7Cn0KCi8qKgogIFRoZSBOYXRpdmVBcnJheSBtaXhpbiBjb250YWlucyB0aGUgcHJvcGVydGllcyBuZWVkZWQgdG8gdG8gbWFrZSB0aGUgbmF0aXZlCiAgQXJyYXkgc3VwcG9ydCBFbWJlci5NdXRhYmxlQXJyYXkgYW5kIGFsbCBvZiBpdHMgZGVwZW5kZW50IEFQSXMuIFVubGVzcyB5b3UKICBoYXZlIGBFbWJlci5FWFRFTkRfUFJPVE9UWVBFU2Agb3IgYEVtYmVyLkVYVEVORF9QUk9UT1RZUEVTLkFycmF5YCBzZXQgdG8KICBmYWxzZSwgdGhpcyB3aWxsIGJlIGFwcGxpZWQgYXV0b21hdGljYWxseS4gT3RoZXJ3aXNlIHlvdSBjYW4gYXBwbHkgdGhlIG1peGluCiAgYXQgYW55dGltZSBieSBjYWxsaW5nIGBFbWJlci5OYXRpdmVBcnJheS5hY3RpdmF0ZWAuCgogIEBjbGFzcyBOYXRpdmVBcnJheQogIEBuYW1lc3BhY2UgRW1iZXIKICBAdXNlcyBFbWJlci5NdXRhYmxlQXJyYXkKICBAdXNlcyBFbWJlci5PYnNlcnZhYmxlCiAgQHVzZXMgRW1iZXIuQ29weWFibGUKKi8KRW1iZXIuTmF0aXZlQXJyYXkgPSBOYXRpdmVBcnJheTsKCi8qKgogIENyZWF0ZXMgYW4gYEVtYmVyLk5hdGl2ZUFycmF5YCBmcm9tIGFuIEFycmF5IGxpa2Ugb2JqZWN0LgogIERvZXMgbm90IG1vZGlmeSB0aGUgb3JpZ2luYWwgb2JqZWN0LiBFbWJlci5BIGlzIG5vdCBuZWVkZWQgaWYKICBgRW1iZXIuRVhURU5EX1BST1RPVFlQRVNgIGlzIGB0cnVlYCAodGhlIGRlZmF1bHQgdmFsdWUpLiBIb3dldmVyLAogIGl0IGlzIHJlY29tbWVuZGVkIHRoYXQgeW91IHVzZSBFbWJlci5BIHdoZW4gY3JlYXRpbmcgYWRkb25zIGZvcgogIGVtYmVyIG9yIHdoZW4geW91IGNhbiBub3QgZ3VhcmFudGVlIHRoYXQgYEVtYmVyLkVYVEVORF9QUk9UT1RZUEVTYAogIHdpbGwgYmUgYHRydWVgLgoKICBFeGFtcGxlCgogIGBgYGpzCiAgdmFyIFBhZ2luYXRpb24gPSBFbWJlci5Db2xsZWN0aW9uVmlldy5leHRlbmQoewogICAgdGFnTmFtZTogJ3VsJywKICAgIGNsYXNzTmFtZXM6IFsncGFnaW5hdGlvbiddLAogICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuX3N1cGVyKCk7CiAgICAgIGlmICghdGhpcy5nZXQoJ2NvbnRlbnQnKSkgewogICAgICAgIHRoaXMuc2V0KCdjb250ZW50JywgRW1iZXIuQShbXSkpOwogICAgICB9CiAgICB9CiAgfSk7CiAgYGBgCgogIEBtZXRob2QgQQogIEBmb3IgRW1iZXIKICBAcmV0dXJuIHtFbWJlci5OYXRpdmVBcnJheX0KKi8KRW1iZXIuQSA9IGZ1bmN0aW9uKGFycikgewogIGlmIChhcnIgPT09IHVuZGVmaW5lZCkgeyBhcnIgPSBbXTsgfQogIHJldHVybiBFbWJlci5BcnJheS5kZXRlY3QoYXJyKSA/IGFyciA6IEVtYmVyLk5hdGl2ZUFycmF5LmFwcGx5KGFycik7Cn07CgovKioKICBBY3RpdmF0ZXMgdGhlIG1peGluIG9uIHRoZSBBcnJheS5wcm90b3R5cGUgaWYgbm90IGFscmVhZHkgYXBwbGllZC4gQ2FsbGluZwogIHRoaXMgbWV0aG9kIG1vcmUgdGhhbiBvbmNlIGlzIHNhZmUuIFRoaXMgd2lsbCBiZSBjYWxsZWQgd2hlbiBlbWJlciBpcyBsb2FkZWQKICB1bmxlc3MgeW91IGhhdmUgYEVtYmVyLkVYVEVORF9QUk9UT1RZUEVTYCBvciBgRW1iZXIuRVhURU5EX1BST1RPVFlQRVMuQXJyYXlgCiAgc2V0IHRvIGBmYWxzZWAuCgogIEV4YW1wbGUKCiAgYGBganMKICBpZiAoRW1iZXIuRVhURU5EX1BST1RPVFlQRVMgPT09IHRydWUgfHwgRW1iZXIuRVhURU5EX1BST1RPVFlQRVMuQXJyYXkpIHsKICAgIEVtYmVyLk5hdGl2ZUFycmF5LmFjdGl2YXRlKCk7CiAgfQogIGBgYAoKICBAbWV0aG9kIGFjdGl2YXRlCiAgQGZvciBFbWJlci5OYXRpdmVBcnJheQogIEBzdGF0aWMKICBAcmV0dXJuIHt2b2lkfQoqLwpFbWJlci5OYXRpdmVBcnJheS5hY3RpdmF0ZSA9IGZ1bmN0aW9uKCkgewogIE5hdGl2ZUFycmF5LmFwcGx5KEFycmF5LnByb3RvdHlwZSk7CgogIEVtYmVyLkEgPSBmdW5jdGlvbihhcnIpIHsgcmV0dXJuIGFyciB8fCBbXTsgfTsKfTsKCmlmIChFbWJlci5FWFRFTkRfUFJPVE9UWVBFUyA9PT0gdHJ1ZSB8fCBFbWJlci5FWFRFTkRfUFJPVE9UWVBFUy5BcnJheSkgewogIEVtYmVyLk5hdGl2ZUFycmF5LmFjdGl2YXRlKCk7Cn0KCgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItcnVudGltZQoqLwoKdmFyIGdldCA9IEVtYmVyLmdldCwgc2V0ID0gRW1iZXIuc2V0LCBndWlkRm9yID0gRW1iZXIuZ3VpZEZvciwgaXNOb25lID0gRW1iZXIuaXNOb25lLCBmbXQgPSBFbWJlci5TdHJpbmcuZm10OwoKLyoqCiAgQW4gdW5vcmRlcmVkIGNvbGxlY3Rpb24gb2Ygb2JqZWN0cy4KCiAgQSBTZXQgd29ya3MgYSBiaXQgbGlrZSBhbiBhcnJheSBleGNlcHQgdGhhdCBpdHMgaXRlbXMgYXJlIG5vdCBvcmRlcmVkLiBZb3UKICBjYW4gY3JlYXRlIGEgc2V0IHRvIGVmZmljaWVudGx5IHRlc3QgZm9yIG1lbWJlcnNoaXAgZm9yIGFuIG9iamVjdC4gWW91IGNhbgogIGFsc28gaXRlcmF0ZSB0aHJvdWdoIGEgc2V0IGp1c3QgbGlrZSBhbiBhcnJheSwgZXZlbiBhY2Nlc3Npbmcgb2JqZWN0cyBieQogIGluZGV4LCBob3dldmVyIHRoZXJlIGlzIG5vIGd1YXJhbnRlZSBhcyB0byB0aGVpciBvcmRlci4KCiAgQWxsIFNldHMgYXJlIG9ic2VydmFibGUgdmlhIHRoZSBFbnVtZXJhYmxlIE9ic2VydmVyIEFQSSAtIHdoaWNoIHdvcmtzCiAgb24gYW55IGVudW1lcmFibGUgb2JqZWN0IGluY2x1ZGluZyBib3RoIFNldHMgYW5kIEFycmF5cy4KCiAgIyMgQ3JlYXRpbmcgYSBTZXQKCiAgWW91IGNhbiBjcmVhdGUgYSBzZXQgbGlrZSB5b3Ugd291bGQgbW9zdCBvYmplY3RzIHVzaW5nCiAgYG5ldyBFbWJlci5TZXQoKWAuIE1vc3QgbmV3IHNldHMgeW91IGNyZWF0ZSB3aWxsIGJlIGVtcHR5LCBidXQgeW91IGNhbgogIGFsc28gaW5pdGlhbGl6ZSB0aGUgc2V0IHdpdGggc29tZSBjb250ZW50IGJ5IHBhc3NpbmcgYW4gYXJyYXkgb3Igb3RoZXIKICBlbnVtZXJhYmxlIG9mIG9iamVjdHMgdG8gdGhlIGNvbnN0cnVjdG9yLgoKICBGaW5hbGx5LCB5b3UgY2FuIHBhc3MgaW4gYW4gZXhpc3Rpbmcgc2V0IGFuZCB0aGUgc2V0IHdpbGwgYmUgY29waWVkLiBZb3UKICBjYW4gYWxzbyBjcmVhdGUgYSBjb3B5IG9mIGEgc2V0IGJ5IGNhbGxpbmcgYEVtYmVyLlNldCNjb3B5KClgLgoKICBgYGBqYXZhc2NyaXB0CiAgLy8gY3JlYXRlcyBhIG5ldyBlbXB0eSBzZXQKICB2YXIgZm91bmROYW1lcyA9IG5ldyBFbWJlci5TZXQoKTsKCiAgLy8gY3JlYXRlcyBhIHNldCB3aXRoIGZvdXIgbmFtZXMgaW4gaXQuCiAgdmFyIG5hbWVzID0gbmV3IEVtYmVyLlNldChbIkNoYXJsZXMiLCAiVG9tIiwgIkp1YW4iLCAiQWxleCJdKTsgLy8gOlAKCiAgLy8gY3JlYXRlcyBhIGNvcHkgb2YgdGhlIG5hbWVzIHNldC4KICB2YXIgbmFtZXNDb3B5ID0gbmV3IEVtYmVyLlNldChuYW1lcyk7CgogIC8vIHNhbWUgYXMgYWJvdmUuCiAgdmFyIGFub3RoZXJOYW1lc0NvcHkgPSBuYW1lcy5jb3B5KCk7CiAgYGBgCgogICMjIEFkZGluZy9SZW1vdmluZyBPYmplY3RzCgogIFlvdSBnZW5lcmFsbHkgYWRkIG9yIHJlbW92ZSBvYmplY3RzIGZyb20gYSBzZXQgdXNpbmcgYGFkZCgpYCBvcgogIGByZW1vdmUoKWAuIFlvdSBjYW4gYWRkIGFueSB0eXBlIG9mIG9iamVjdCBpbmNsdWRpbmcgcHJpbWl0aXZlcyBzdWNoIGFzCiAgbnVtYmVycywgc3RyaW5ncywgYW5kIGJvb2xlYW5zLgoKICBVbmxpa2UgYXJyYXlzLCBvYmplY3RzIGNhbiBvbmx5IGV4aXN0IG9uZSB0aW1lIGluIGEgc2V0LiBJZiB5b3UgY2FsbCBgYWRkKClgCiAgb24gYSBzZXQgd2l0aCB0aGUgc2FtZSBvYmplY3QgbXVsdGlwbGUgdGltZXMsIHRoZSBvYmplY3Qgd2lsbCBvbmx5IGJlIGFkZGVkCiAgb25jZS4gTGlrZXdpc2UsIGNhbGxpbmcgYHJlbW92ZSgpYCB3aXRoIHRoZSBzYW1lIG9iamVjdCBtdWx0aXBsZSB0aW1lcyB3aWxsCiAgcmVtb3ZlIHRoZSBvYmplY3QgdGhlIGZpcnN0IHRpbWUgYW5kIGhhdmUgbm8gZWZmZWN0IG9uIGZ1dHVyZSBjYWxscyB1bnRpbAogIHlvdSBhZGQgdGhlIG9iamVjdCB0byB0aGUgc2V0IGFnYWluLgoKICBOT1RFOiBZb3UgY2Fubm90IGFkZC9yZW1vdmUgYG51bGxgIG9yIGB1bmRlZmluZWRgIHRvIGEgc2V0LiBBbnkgYXR0ZW1wdCB0byBkbwogIHNvIHdpbGwgYmUgaWdub3JlZC4KCiAgSW4gYWRkaXRpb24gdG8gYWRkL3JlbW92ZSB5b3UgY2FuIGFsc28gY2FsbCBgcHVzaCgpYC9gcG9wKClgLiBQdXNoIGJlaGF2ZXMKICBqdXN0IGxpa2UgYGFkZCgpYCBidXQgYHBvcCgpYCwgdW5saWtlIGByZW1vdmUoKWAgd2lsbCBwaWNrIGFuIGFyYml0cmFyeQogIG9iamVjdCwgcmVtb3ZlIGl0IGFuZCByZXR1cm4gaXQuIFRoaXMgaXMgYSBnb29kIHdheSB0byB1c2UgYSBzZXQgYXMgYSBqb2IKICBxdWV1ZSB3aGVuIHlvdSBkb24ndCBjYXJlIHdoaWNoIG9yZGVyIHRoZSBqb2JzIGFyZSBleGVjdXRlZCBpbi4KCiAgIyMgVGVzdGluZyBmb3IgYW4gT2JqZWN0CgogIFRvIHRlc3QgZm9yIGFuIG9iamVjdCdzIHByZXNlbmNlIGluIGEgc2V0IHlvdSBzaW1wbHkgY2FsbAogIGBFbWJlci5TZXQjY29udGFpbnMoKWAuCgogICMjIE9ic2VydmluZyBjaGFuZ2VzCgogIFdoZW4gdXNpbmcgYEVtYmVyLlNldGAsIHlvdSBjYW4gb2JzZXJ2ZSB0aGUgYCJbXSJgIHByb3BlcnR5IHRvIGJlCiAgYWxlcnRlZCB3aGVuZXZlciB0aGUgY29udGVudCBjaGFuZ2VzLiBZb3UgY2FuIGFsc28gYWRkIGFuIGVudW1lcmFibGUKICBvYnNlcnZlciB0byB0aGUgc2V0IHRvIGJlIG5vdGlmaWVkIG9mIHNwZWNpZmljIG9iamVjdHMgdGhhdCBhcmUgYWRkZWQgYW5kCiAgcmVtb3ZlZCBmcm9tIHRoZSBzZXQuIFNlZSBbRW1iZXIuRW51bWVyYWJsZV0oL2FwaS9jbGFzc2VzL0VtYmVyLkVudW1lcmFibGUuaHRtbCkKICBmb3IgbW9yZSBpbmZvcm1hdGlvbiBvbiBlbnVtZXJhYmxlcy4KCiAgVGhpcyBpcyBvZnRlbiB1bmhlbHBmdWwuIElmIHlvdSBhcmUgZmlsdGVyaW5nIHNldHMgb2Ygb2JqZWN0cywgZm9yIGluc3RhbmNlLAogIGl0IGlzIHZlcnkgaW5lZmZpY2llbnQgdG8gcmUtZmlsdGVyIGFsbCBvZiB0aGUgaXRlbXMgZWFjaCB0aW1lIHRoZSBzZXQKICBjaGFuZ2VzLiBJdCB3b3VsZCBiZSBiZXR0ZXIgaWYgeW91IGNvdWxkIGp1c3QgYWRqdXN0IHRoZSBmaWx0ZXJlZCBzZXQgYmFzZWQKICBvbiB3aGF0IHdhcyBjaGFuZ2VkIG9uIHRoZSBvcmlnaW5hbCBzZXQuIFRoZSBzYW1lIGlzc3VlIGFwcGxpZXMgdG8gbWVyZ2luZwogIHNldHMsIGFzIHdlbGwuCgogICMjIE90aGVyIE1ldGhvZHMKCiAgYEVtYmVyLlNldGAgcHJpbWFyeSBpbXBsZW1lbnRzIG90aGVyIG1peGluIEFQSXMuIEZvciBhIGNvbXBsZXRlIHJlZmVyZW5jZQogIG9uIHRoZSBtZXRob2RzIHlvdSB3aWxsIHVzZSB3aXRoIGBFbWJlci5TZXRgLCBwbGVhc2UgY29uc3VsdCB0aGVzZSBtaXhpbnMuCiAgVGhlIG1vc3QgdXNlZnVsIG9uZXMgd2lsbCBiZSBgRW1iZXIuRW51bWVyYWJsZWAgYW5kCiAgYEVtYmVyLk11dGFibGVFbnVtZXJhYmxlYCB3aGljaCBpbXBsZW1lbnQgbW9zdCBvZiB0aGUgY29tbW9uIGl0ZXJhdG9yCiAgbWV0aG9kcyB5b3UgYXJlIHVzZWQgdG8gb24gQXJyYXkuCgogIE5vdGUgdGhhdCB5b3UgY2FuIGFsc28gdXNlIHRoZSBgRW1iZXIuQ29weWFibGVgIGFuZCBgRW1iZXIuRnJlZXphYmxlYAogIEFQSXMgb24gYEVtYmVyLlNldGAgYXMgd2VsbC4gT25jZSBhIHNldCBpcyBmcm96ZW4gaXQgY2FuIG5vIGxvbmdlciBiZQogIG1vZGlmaWVkLiBUaGUgYmVuZWZpdCBvZiB0aGlzIGlzIHRoYXQgd2hlbiB5b3UgY2FsbCBgZnJvemVuQ29weSgpYCBvbiBpdCwKICBFbWJlciB3aWxsIGF2b2lkIG1ha2luZyBjb3BpZXMgb2YgdGhlIHNldC4gVGhpcyBhbGxvd3MgeW91IHRvIHdyaXRlCiAgY29kZSB0aGF0IGNhbiBrbm93IHdpdGggY2VydGFpbnR5IHdoZW4gdGhlIHVuZGVybHlpbmcgc2V0IGRhdGEgd2lsbCBvcgogIHdpbGwgbm90IGJlIG1vZGlmaWVkLgoKICBAY2xhc3MgU2V0CiAgQG5hbWVzcGFjZSBFbWJlcgogIEBleHRlbmRzIEVtYmVyLkNvcmVPYmplY3QKICBAdXNlcyBFbWJlci5NdXRhYmxlRW51bWVyYWJsZQogIEB1c2VzIEVtYmVyLkNvcHlhYmxlCiAgQHVzZXMgRW1iZXIuRnJlZXphYmxlCiAgQHNpbmNlIEVtYmVyIDAuOQoqLwpFbWJlci5TZXQgPSBFbWJlci5Db3JlT2JqZWN0LmV4dGVuZChFbWJlci5NdXRhYmxlRW51bWVyYWJsZSwgRW1iZXIuQ29weWFibGUsIEVtYmVyLkZyZWV6YWJsZSwKICB7CgogIC8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KICAvLyBJTVBMRU1FTlQgRU5VTUVSQUJMRSBBUElTCiAgLy8KCiAgLyoqCiAgICBUaGlzIHByb3BlcnR5IHdpbGwgY2hhbmdlIGFzIHRoZSBudW1iZXIgb2Ygb2JqZWN0cyBpbiB0aGUgc2V0IGNoYW5nZXMuCgogICAgQHByb3BlcnR5IGxlbmd0aAogICAgQHR5cGUgbnVtYmVyCiAgICBAZGVmYXVsdCAwCiAgKi8KICBsZW5ndGg6IDAsCgogIC8qKgogICAgQ2xlYXJzIHRoZSBzZXQuIFRoaXMgaXMgdXNlZnVsIGlmIHlvdSB3YW50IHRvIHJldXNlIGFuIGV4aXN0aW5nIHNldAogICAgd2l0aG91dCBoYXZpbmcgdG8gcmVjcmVhdGUgaXQuCgogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIGNvbG9ycyA9IG5ldyBFbWJlci5TZXQoWyJyZWQiLCAiZ3JlZW4iLCAiYmx1ZSJdKTsKICAgIGNvbG9ycy5sZW5ndGg7ICAvLyAzCiAgICBjb2xvcnMuY2xlYXIoKTsKICAgIGNvbG9ycy5sZW5ndGg7ICAvLyAwCiAgICBgYGAKCiAgICBAbWV0aG9kIGNsZWFyCiAgICBAcmV0dXJuIHtFbWJlci5TZXR9IEFuIGVtcHR5IFNldAogICovCiAgY2xlYXI6IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuaXNGcm96ZW4pIHsgdGhyb3cgbmV3IEVtYmVyLkVycm9yKEVtYmVyLkZST1pFTl9FUlJPUik7IH0KCiAgICB2YXIgbGVuID0gZ2V0KHRoaXMsICdsZW5ndGgnKTsKICAgIGlmIChsZW4gPT09IDApIHsgcmV0dXJuIHRoaXM7IH0KCiAgICB2YXIgZ3VpZDsKCiAgICB0aGlzLmVudW1lcmFibGVDb250ZW50V2lsbENoYW5nZShsZW4sIDApOwogICAgRW1iZXIucHJvcGVydHlXaWxsQ2hhbmdlKHRoaXMsICdmaXJzdE9iamVjdCcpOwogICAgRW1iZXIucHJvcGVydHlXaWxsQ2hhbmdlKHRoaXMsICdsYXN0T2JqZWN0Jyk7CgogICAgZm9yICh2YXIgaT0wOyBpIDwgbGVuOyBpKyspIHsKICAgICAgZ3VpZCA9IGd1aWRGb3IodGhpc1tpXSk7CiAgICAgIGRlbGV0ZSB0aGlzW2d1aWRdOwogICAgICBkZWxldGUgdGhpc1tpXTsKICAgIH0KCiAgICBzZXQodGhpcywgJ2xlbmd0aCcsIDApOwoKICAgIEVtYmVyLnByb3BlcnR5RGlkQ2hhbmdlKHRoaXMsICdmaXJzdE9iamVjdCcpOwogICAgRW1iZXIucHJvcGVydHlEaWRDaGFuZ2UodGhpcywgJ2xhc3RPYmplY3QnKTsKICAgIHRoaXMuZW51bWVyYWJsZUNvbnRlbnREaWRDaGFuZ2UobGVuLCAwKTsKCiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvKioKICAgIFJldHVybnMgdHJ1ZSBpZiB0aGUgcGFzc2VkIG9iamVjdCBpcyBhbHNvIGFuIGVudW1lcmFibGUgdGhhdCBjb250YWlucyB0aGUKICAgIHNhbWUgb2JqZWN0cyBhcyB0aGUgcmVjZWl2ZXIuCgogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIGNvbG9ycyA9IFsicmVkIiwgImdyZWVuIiwgImJsdWUiXSwKICAgICAgICBzYW1lX2NvbG9ycyA9IG5ldyBFbWJlci5TZXQoY29sb3JzKTsKCiAgICBzYW1lX2NvbG9ycy5pc0VxdWFsKGNvbG9ycyk7ICAgICAgICAgICAgICAgLy8gdHJ1ZQogICAgc2FtZV9jb2xvcnMuaXNFcXVhbChbInB1cnBsZSIsICJicm93biJdKTsgIC8vIGZhbHNlCiAgICBgYGAKCiAgICBAbWV0aG9kIGlzRXF1YWwKICAgIEBwYXJhbSB7RW1iZXIuU2V0fSBvYmogdGhlIG90aGVyIG9iamVjdC4KICAgIEByZXR1cm4ge0Jvb2xlYW59CiAgKi8KICBpc0VxdWFsOiBmdW5jdGlvbihvYmopIHsKICAgIC8vIGZhaWwgZmFzdAogICAgaWYgKCFFbWJlci5FbnVtZXJhYmxlLmRldGVjdChvYmopKSByZXR1cm4gZmFsc2U7CgogICAgdmFyIGxvYyA9IGdldCh0aGlzLCAnbGVuZ3RoJyk7CiAgICBpZiAoZ2V0KG9iaiwgJ2xlbmd0aCcpICE9PSBsb2MpIHJldHVybiBmYWxzZTsKCiAgICB3aGlsZSgtLWxvYyA+PSAwKSB7CiAgICAgIGlmICghb2JqLmNvbnRhaW5zKHRoaXNbbG9jXSkpIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9LAoKICAvKioKICAgIEFkZHMgYW4gb2JqZWN0IHRvIHRoZSBzZXQuIE9ubHkgbm9uLWBudWxsYCBvYmplY3RzIGNhbiBiZSBhZGRlZCB0byBhIHNldAogICAgYW5kIHRob3NlIGNhbiBvbmx5IGJlIGFkZGVkIG9uY2UuIElmIHRoZSBvYmplY3QgaXMgYWxyZWFkeSBpbiB0aGUgc2V0IG9yCiAgICB0aGUgcGFzc2VkIHZhbHVlIGlzIG51bGwgdGhpcyBtZXRob2Qgd2lsbCBoYXZlIG5vIGVmZmVjdC4KCiAgICBUaGlzIGlzIGFuIGFsaWFzIGZvciBgRW1iZXIuTXV0YWJsZUVudW1lcmFibGUuYWRkT2JqZWN0KClgLgoKICAgIGBgYGphdmFzY3JpcHQKICAgIHZhciBjb2xvcnMgPSBuZXcgRW1iZXIuU2V0KCk7CiAgICBjb2xvcnMuYWRkKCJibHVlIik7ICAgICAvLyBbImJsdWUiXQogICAgY29sb3JzLmFkZCgiYmx1ZSIpOyAgICAgLy8gWyJibHVlIl0KICAgIGNvbG9ycy5hZGQoInJlZCIpOyAgICAgIC8vIFsiYmx1ZSIsICJyZWQiXQogICAgY29sb3JzLmFkZChudWxsKTsgICAgICAgLy8gWyJibHVlIiwgInJlZCJdCiAgICBjb2xvcnMuYWRkKHVuZGVmaW5lZCk7ICAvLyBbImJsdWUiLCAicmVkIl0KICAgIGBgYAoKICAgIEBtZXRob2QgYWRkCiAgICBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgdG8gYWRkLgogICAgQHJldHVybiB7RW1iZXIuU2V0fSBUaGUgc2V0IGl0c2VsZi4KICAqLwogIGFkZDogRW1iZXIuYWxpYXNNZXRob2QoJ2FkZE9iamVjdCcpLAoKICAvKioKICAgIFJlbW92ZXMgdGhlIG9iamVjdCBmcm9tIHRoZSBzZXQgaWYgaXQgaXMgZm91bmQuIElmIHlvdSBwYXNzIGEgYG51bGxgIHZhbHVlCiAgICBvciBhbiBvYmplY3QgdGhhdCBpcyBhbHJlYWR5IG5vdCBpbiB0aGUgc2V0LCB0aGlzIG1ldGhvZCB3aWxsIGhhdmUgbm8KICAgIGVmZmVjdC4gVGhpcyBpcyBhbiBhbGlhcyBmb3IgYEVtYmVyLk11dGFibGVFbnVtZXJhYmxlLnJlbW92ZU9iamVjdCgpYC4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgY29sb3JzID0gbmV3IEVtYmVyLlNldChbInJlZCIsICJncmVlbiIsICJibHVlIl0pOwogICAgY29sb3JzLnJlbW92ZSgicmVkIik7ICAgICAvLyBbImJsdWUiLCAiZ3JlZW4iXQogICAgY29sb3JzLnJlbW92ZSgicHVycGxlIik7ICAvLyBbImJsdWUiLCAiZ3JlZW4iXQogICAgY29sb3JzLnJlbW92ZShudWxsKTsgICAgICAvLyBbImJsdWUiLCAiZ3JlZW4iXQogICAgYGBgCgogICAgQG1ldGhvZCByZW1vdmUKICAgIEBwYXJhbSB7T2JqZWN0fSBvYmogVGhlIG9iamVjdCB0byByZW1vdmUKICAgIEByZXR1cm4ge0VtYmVyLlNldH0gVGhlIHNldCBpdHNlbGYuCiAgKi8KICByZW1vdmU6IEVtYmVyLmFsaWFzTWV0aG9kKCdyZW1vdmVPYmplY3QnKSwKCiAgLyoqCiAgICBSZW1vdmVzIHRoZSBsYXN0IGVsZW1lbnQgZnJvbSB0aGUgc2V0IGFuZCByZXR1cm5zIGl0LCBvciBgbnVsbGAgaWYgaXQncyBlbXB0eS4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgY29sb3JzID0gbmV3IEVtYmVyLlNldChbImdyZWVuIiwgImJsdWUiXSk7CiAgICBjb2xvcnMucG9wKCk7ICAvLyAiYmx1ZSIKICAgIGNvbG9ycy5wb3AoKTsgIC8vICJncmVlbiIKICAgIGNvbG9ycy5wb3AoKTsgIC8vIG51bGwKICAgIGBgYAoKICAgIEBtZXRob2QgcG9wCiAgICBAcmV0dXJuIHtPYmplY3R9IFRoZSByZW1vdmVkIG9iamVjdCBmcm9tIHRoZSBzZXQgb3IgbnVsbC4KICAqLwogIHBvcDogZnVuY3Rpb24oKSB7CiAgICBpZiAoZ2V0KHRoaXMsICdpc0Zyb3plbicpKSB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoRW1iZXIuRlJPWkVOX0VSUk9SKTsKICAgIHZhciBvYmogPSB0aGlzLmxlbmd0aCA+IDAgPyB0aGlzW3RoaXMubGVuZ3RoLTFdIDogbnVsbDsKICAgIHRoaXMucmVtb3ZlKG9iaik7CiAgICByZXR1cm4gb2JqOwogIH0sCgogIC8qKgogICAgSW5zZXJ0cyB0aGUgZ2l2ZW4gb2JqZWN0IG9uIHRvIHRoZSBlbmQgb2YgdGhlIHNldC4gSXQgcmV0dXJucwogICAgdGhlIHNldCBpdHNlbGYuCgogICAgVGhpcyBpcyBhbiBhbGlhcyBmb3IgYEVtYmVyLk11dGFibGVFbnVtZXJhYmxlLmFkZE9iamVjdCgpYC4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgY29sb3JzID0gbmV3IEVtYmVyLlNldCgpOwogICAgY29sb3JzLnB1c2goInJlZCIpOyAgIC8vIFsicmVkIl0KICAgIGNvbG9ycy5wdXNoKCJncmVlbiIpOyAvLyBbInJlZCIsICJncmVlbiJdCiAgICBjb2xvcnMucHVzaCgiYmx1ZSIpOyAgLy8gWyJyZWQiLCAiZ3JlZW4iLCAiYmx1ZSJdCiAgICBgYGAKCiAgICBAbWV0aG9kIHB1c2gKICAgIEByZXR1cm4ge0VtYmVyLlNldH0gVGhlIHNldCBpdHNlbGYuCiAgKi8KICBwdXNoOiBFbWJlci5hbGlhc01ldGhvZCgnYWRkT2JqZWN0JyksCgogIC8qKgogICAgUmVtb3ZlcyB0aGUgbGFzdCBlbGVtZW50IGZyb20gdGhlIHNldCBhbmQgcmV0dXJucyBpdCwgb3IgYG51bGxgIGlmIGl0J3MgZW1wdHkuCgogICAgVGhpcyBpcyBhbiBhbGlhcyBmb3IgYEVtYmVyLlNldC5wb3AoKWAuCgogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIGNvbG9ycyA9IG5ldyBFbWJlci5TZXQoWyJncmVlbiIsICJibHVlIl0pOwogICAgY29sb3JzLnNoaWZ0KCk7ICAvLyAiYmx1ZSIKICAgIGNvbG9ycy5zaGlmdCgpOyAgLy8gImdyZWVuIgogICAgY29sb3JzLnNoaWZ0KCk7ICAvLyBudWxsCiAgICBgYGAKCiAgICBAbWV0aG9kIHNoaWZ0CiAgICBAcmV0dXJuIHtPYmplY3R9IFRoZSByZW1vdmVkIG9iamVjdCBmcm9tIHRoZSBzZXQgb3IgbnVsbC4KICAqLwogIHNoaWZ0OiBFbWJlci5hbGlhc01ldGhvZCgncG9wJyksCgogIC8qKgogICAgSW5zZXJ0cyB0aGUgZ2l2ZW4gb2JqZWN0IG9uIHRvIHRoZSBlbmQgb2YgdGhlIHNldC4gSXQgcmV0dXJucwogICAgdGhlIHNldCBpdHNlbGYuCgogICAgVGhpcyBpcyBhbiBhbGlhcyBvZiBgRW1iZXIuU2V0LnB1c2goKWAKCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgY29sb3JzID0gbmV3IEVtYmVyLlNldCgpOwogICAgY29sb3JzLnVuc2hpZnQoInJlZCIpOyAgICAvLyBbInJlZCJdCiAgICBjb2xvcnMudW5zaGlmdCgiZ3JlZW4iKTsgIC8vIFsicmVkIiwgImdyZWVuIl0KICAgIGNvbG9ycy51bnNoaWZ0KCJibHVlIik7ICAgLy8gWyJyZWQiLCAiZ3JlZW4iLCAiYmx1ZSJdCiAgICBgYGAKCiAgICBAbWV0aG9kIHVuc2hpZnQKICAgIEByZXR1cm4ge0VtYmVyLlNldH0gVGhlIHNldCBpdHNlbGYuCiAgKi8KICB1bnNoaWZ0OiBFbWJlci5hbGlhc01ldGhvZCgncHVzaCcpLAoKICAvKioKICAgIEFkZHMgZWFjaCBvYmplY3QgaW4gdGhlIHBhc3NlZCBlbnVtZXJhYmxlIHRvIHRoZSBzZXQuCgogICAgVGhpcyBpcyBhbiBhbGlhcyBvZiBgRW1iZXIuTXV0YWJsZUVudW1lcmFibGUuYWRkT2JqZWN0cygpYAoKICAgIGBgYGphdmFzY3JpcHQKICAgIHZhciBjb2xvcnMgPSBuZXcgRW1iZXIuU2V0KCk7CiAgICBjb2xvcnMuYWRkRWFjaChbInJlZCIsICJncmVlbiIsICJibHVlIl0pOyAgLy8gWyJyZWQiLCAiZ3JlZW4iLCAiYmx1ZSJdCiAgICBgYGAKCiAgICBAbWV0aG9kIGFkZEVhY2gKICAgIEBwYXJhbSB7RW1iZXIuRW51bWVyYWJsZX0gb2JqZWN0cyB0aGUgb2JqZWN0cyB0byBhZGQuCiAgICBAcmV0dXJuIHtFbWJlci5TZXR9IFRoZSBzZXQgaXRzZWxmLgogICovCiAgYWRkRWFjaDogRW1iZXIuYWxpYXNNZXRob2QoJ2FkZE9iamVjdHMnKSwKCiAgLyoqCiAgICBSZW1vdmVzIGVhY2ggb2JqZWN0IGluIHRoZSBwYXNzZWQgZW51bWVyYWJsZSB0byB0aGUgc2V0LgoKICAgIFRoaXMgaXMgYW4gYWxpYXMgb2YgYEVtYmVyLk11dGFibGVFbnVtZXJhYmxlLnJlbW92ZU9iamVjdHMoKWAKCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgY29sb3JzID0gbmV3IEVtYmVyLlNldChbInJlZCIsICJncmVlbiIsICJibHVlIl0pOwogICAgY29sb3JzLnJlbW92ZUVhY2goWyJyZWQiLCAiYmx1ZSJdKTsgIC8vICBbImdyZWVuIl0KICAgIGBgYAoKICAgIEBtZXRob2QgcmVtb3ZlRWFjaAogICAgQHBhcmFtIHtFbWJlci5FbnVtZXJhYmxlfSBvYmplY3RzIHRoZSBvYmplY3RzIHRvIHJlbW92ZS4KICAgIEByZXR1cm4ge0VtYmVyLlNldH0gVGhlIHNldCBpdHNlbGYuCiAgKi8KICByZW1vdmVFYWNoOiBFbWJlci5hbGlhc01ldGhvZCgncmVtb3ZlT2JqZWN0cycpLAoKICAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCiAgLy8gUFJJVkFURSBFTlVNRVJBQkxFIFNVUFBPUlQKICAvLwoKICBpbml0OiBmdW5jdGlvbihpdGVtcykgewogICAgdGhpcy5fc3VwZXIoKTsKICAgIGlmIChpdGVtcykgdGhpcy5hZGRPYmplY3RzKGl0ZW1zKTsKICB9LAoKICAvLyBpbXBsZW1lbnQgRW1iZXIuRW51bWVyYWJsZQogIG5leHRPYmplY3Q6IGZ1bmN0aW9uKGlkeCkgewogICAgcmV0dXJuIHRoaXNbaWR4XTsKICB9LAoKICAvLyBtb3JlIG9wdGltaXplZCB2ZXJzaW9uCiAgZmlyc3RPYmplY3Q6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMubGVuZ3RoID4gMCA/IHRoaXNbMF0gOiB1bmRlZmluZWQ7CiAgfSksCgogIC8vIG1vcmUgb3B0aW1pemVkIHZlcnNpb24KICBsYXN0T2JqZWN0OiBFbWJlci5jb21wdXRlZChmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmxlbmd0aCA+IDAgPyB0aGlzW3RoaXMubGVuZ3RoLTFdIDogdW5kZWZpbmVkOwogIH0pLAoKICAvLyBpbXBsZW1lbnRzIEVtYmVyLk11dGFibGVFbnVtZXJhYmxlCiAgYWRkT2JqZWN0OiBmdW5jdGlvbihvYmopIHsKICAgIGlmIChnZXQodGhpcywgJ2lzRnJvemVuJykpIHRocm93IG5ldyBFbWJlci5FcnJvcihFbWJlci5GUk9aRU5fRVJST1IpOwogICAgaWYgKGlzTm9uZShvYmopKSByZXR1cm4gdGhpczsgLy8gbm90aGluZyB0byBkbwoKICAgIHZhciBndWlkID0gZ3VpZEZvcihvYmopLAogICAgICAgIGlkeCAgPSB0aGlzW2d1aWRdLAogICAgICAgIGxlbiAgPSBnZXQodGhpcywgJ2xlbmd0aCcpLAogICAgICAgIGFkZGVkIDsKCiAgICBpZiAoaWR4Pj0wICYmIGlkeDxsZW4gJiYgKHRoaXNbaWR4XSA9PT0gb2JqKSkgcmV0dXJuIHRoaXM7IC8vIGFkZGVkCgogICAgYWRkZWQgPSBbb2JqXTsKCiAgICB0aGlzLmVudW1lcmFibGVDb250ZW50V2lsbENoYW5nZShudWxsLCBhZGRlZCk7CiAgICBFbWJlci5wcm9wZXJ0eVdpbGxDaGFuZ2UodGhpcywgJ2xhc3RPYmplY3QnKTsKCiAgICBsZW4gPSBnZXQodGhpcywgJ2xlbmd0aCcpOwogICAgdGhpc1tndWlkXSA9IGxlbjsKICAgIHRoaXNbbGVuXSA9IG9iajsKICAgIHNldCh0aGlzLCAnbGVuZ3RoJywgbGVuKzEpOwoKICAgIEVtYmVyLnByb3BlcnR5RGlkQ2hhbmdlKHRoaXMsICdsYXN0T2JqZWN0Jyk7CiAgICB0aGlzLmVudW1lcmFibGVDb250ZW50RGlkQ2hhbmdlKG51bGwsIGFkZGVkKTsKCiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvLyBpbXBsZW1lbnRzIEVtYmVyLk11dGFibGVFbnVtZXJhYmxlCiAgcmVtb3ZlT2JqZWN0OiBmdW5jdGlvbihvYmopIHsKICAgIGlmIChnZXQodGhpcywgJ2lzRnJvemVuJykpIHRocm93IG5ldyBFbWJlci5FcnJvcihFbWJlci5GUk9aRU5fRVJST1IpOwogICAgaWYgKGlzTm9uZShvYmopKSByZXR1cm4gdGhpczsgLy8gbm90aGluZyB0byBkbwoKICAgIHZhciBndWlkID0gZ3VpZEZvcihvYmopLAogICAgICAgIGlkeCAgPSB0aGlzW2d1aWRdLAogICAgICAgIGxlbiA9IGdldCh0aGlzLCAnbGVuZ3RoJyksCiAgICAgICAgaXNGaXJzdCA9IGlkeCA9PT0gMCwKICAgICAgICBpc0xhc3QgPSBpZHggPT09IGxlbi0xLAogICAgICAgIGxhc3QsIHJlbW92ZWQ7CgoKICAgIGlmIChpZHg+PTAgJiYgaWR4PGxlbiAmJiAodGhpc1tpZHhdID09PSBvYmopKSB7CiAgICAgIHJlbW92ZWQgPSBbb2JqXTsKCiAgICAgIHRoaXMuZW51bWVyYWJsZUNvbnRlbnRXaWxsQ2hhbmdlKHJlbW92ZWQsIG51bGwpOwogICAgICBpZiAoaXNGaXJzdCkgeyBFbWJlci5wcm9wZXJ0eVdpbGxDaGFuZ2UodGhpcywgJ2ZpcnN0T2JqZWN0Jyk7IH0KICAgICAgaWYgKGlzTGFzdCkgIHsgRW1iZXIucHJvcGVydHlXaWxsQ2hhbmdlKHRoaXMsICdsYXN0T2JqZWN0Jyk7IH0KCiAgICAgIC8vIHN3YXAgaXRlbXMgLSBiYXNpY2FsbHkgbW92ZSB0aGUgaXRlbSB0byB0aGUgZW5kIHNvIGl0IGNhbiBiZSByZW1vdmVkCiAgICAgIGlmIChpZHggPCBsZW4tMSkgewogICAgICAgIGxhc3QgPSB0aGlzW2xlbi0xXTsKICAgICAgICB0aGlzW2lkeF0gPSBsYXN0OwogICAgICAgIHRoaXNbZ3VpZEZvcihsYXN0KV0gPSBpZHg7CiAgICAgIH0KCiAgICAgIGRlbGV0ZSB0aGlzW2d1aWRdOwogICAgICBkZWxldGUgdGhpc1tsZW4tMV07CiAgICAgIHNldCh0aGlzLCAnbGVuZ3RoJywgbGVuLTEpOwoKICAgICAgaWYgKGlzRmlyc3QpIHsgRW1iZXIucHJvcGVydHlEaWRDaGFuZ2UodGhpcywgJ2ZpcnN0T2JqZWN0Jyk7IH0KICAgICAgaWYgKGlzTGFzdCkgIHsgRW1iZXIucHJvcGVydHlEaWRDaGFuZ2UodGhpcywgJ2xhc3RPYmplY3QnKTsgfQogICAgICB0aGlzLmVudW1lcmFibGVDb250ZW50RGlkQ2hhbmdlKHJlbW92ZWQsIG51bGwpOwogICAgfQoKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8vIG9wdGltaXplZCB2ZXJzaW9uCiAgY29udGFpbnM6IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIHRoaXNbZ3VpZEZvcihvYmopXT49MDsKICB9LAoKICBjb3B5OiBmdW5jdGlvbigpIHsKICAgIHZhciBDID0gdGhpcy5jb25zdHJ1Y3RvciwgcmV0ID0gbmV3IEMoKSwgbG9jID0gZ2V0KHRoaXMsICdsZW5ndGgnKTsKICAgIHNldChyZXQsICdsZW5ndGgnLCBsb2MpOwogICAgd2hpbGUoLS1sb2M+PTApIHsKICAgICAgcmV0W2xvY10gPSB0aGlzW2xvY107CiAgICAgIHJldFtndWlkRm9yKHRoaXNbbG9jXSldID0gbG9jOwogICAgfQogICAgcmV0dXJuIHJldDsKICB9LAoKICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGgsIGlkeCwgYXJyYXkgPSBbXTsKICAgIGZvcihpZHggPSAwOyBpZHggPCBsZW47IGlkeCsrKSB7CiAgICAgIGFycmF5W2lkeF0gPSB0aGlzW2lkeF07CiAgICB9CiAgICByZXR1cm4gZm10KCJFbWJlci5TZXQ8JUA+IiwgW2FycmF5LmpvaW4oJywnKV0pOwogIH0KCn0pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewp2YXIgRGVmZXJyZWRNaXhpbiA9IEVtYmVyLkRlZmVycmVkTWl4aW4sIC8vIG1peGlucy9kZWZlcnJlZAogICAgZ2V0ID0gRW1iZXIuZ2V0OwoKdmFyIERlZmVycmVkID0gRW1iZXIuT2JqZWN0LmV4dGVuZChEZWZlcnJlZE1peGluKTsKCkRlZmVycmVkLnJlb3BlbkNsYXNzKHsKICBwcm9taXNlOiBmdW5jdGlvbihjYWxsYmFjaywgYmluZGluZykgewogICAgdmFyIGRlZmVycmVkID0gRGVmZXJyZWQuY3JlYXRlKCk7CiAgICBjYWxsYmFjay5jYWxsKGJpbmRpbmcsIGRlZmVycmVkKTsKICAgIHJldHVybiBkZWZlcnJlZDsKICB9Cn0pOwoKRW1iZXIuRGVmZXJyZWQgPSBEZWZlcnJlZDsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKdmFyIGZvckVhY2ggPSBFbWJlci5BcnJheVBvbHlmaWxscy5mb3JFYWNoOwoKLyoqCiAgQG1vZHVsZSBlbWJlcgogIEBzdWJtb2R1bGUgZW1iZXItcnVudGltZQoqLwoKdmFyIGxvYWRIb29rcyA9IEVtYmVyLkVOVi5FTUJFUl9MT0FEX0hPT0tTIHx8IHt9Owp2YXIgbG9hZGVkID0ge307CgovKioKICBEZXRlY3RzIHdoZW4gYSBzcGVjaWZpYyBwYWNrYWdlIG9mIEVtYmVyIChlLmcuICdFbWJlci5IYW5kbGViYXJzJykKICBoYXMgZnVsbHkgbG9hZGVkIGFuZCBpcyBhdmFpbGFibGUgZm9yIGV4dGVuc2lvbi4KCiAgVGhlIHByb3ZpZGVkIGBjYWxsYmFja2Agd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGUgYG5hbWVgIHBhc3NlZAogIHJlc29sdmVkIGZyb20gYSBzdHJpbmcgaW50byB0aGUgb2JqZWN0OgoKICBgYGAgamF2YXNjcmlwdAogIEVtYmVyLm9uTG9hZCgnRW1iZXIuSGFuZGxlYmFycycgZnVuY3Rpb24oaGJhcnMpewogICAgaGJhcnMucmVnaXN0ZXJIZWxwZXIoLi4uKTsKICB9KTsKICBgYGAKCiAgQG1ldGhvZCBvbkxvYWQKICBAZm9yIEVtYmVyCiAgQHBhcmFtIG5hbWUge1N0cmluZ30gbmFtZSBvZiBob29rCiAgQHBhcmFtIGNhbGxiYWNrIHtGdW5jdGlvbn0gY2FsbGJhY2sgdG8gYmUgY2FsbGVkCiovCkVtYmVyLm9uTG9hZCA9IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrKSB7CiAgdmFyIG9iamVjdDsKCiAgbG9hZEhvb2tzW25hbWVdID0gbG9hZEhvb2tzW25hbWVdIHx8IEVtYmVyLkEoKTsKICBsb2FkSG9va3NbbmFtZV0ucHVzaE9iamVjdChjYWxsYmFjayk7CgogIGlmIChvYmplY3QgPSBsb2FkZWRbbmFtZV0pIHsKICAgIGNhbGxiYWNrKG9iamVjdCk7CiAgfQp9OwoKLyoqCiAgQ2FsbGVkIHdoZW4gYW4gRW1iZXIuanMgcGFja2FnZSAoZS5nIEVtYmVyLkhhbmRsZWJhcnMpIGhhcyBmaW5pc2hlZAogIGxvYWRpbmcuIFRyaWdnZXJzIGFueSBjYWxsYmFja3MgcmVnaXN0ZXJlZCBmb3IgdGhpcyBldmVudC4KCiAgQG1ldGhvZCBydW5Mb2FkSG9va3MKICBAZm9yIEVtYmVyCiAgQHBhcmFtIG5hbWUge1N0cmluZ30gbmFtZSBvZiBob29rCiAgQHBhcmFtIG9iamVjdCB7T2JqZWN0fSBvYmplY3QgdG8gcGFzcyB0byBjYWxsYmFja3MKKi8KRW1iZXIucnVuTG9hZEhvb2tzID0gZnVuY3Rpb24obmFtZSwgb2JqZWN0KSB7CiAgbG9hZGVkW25hbWVdID0gb2JqZWN0OwoKICBpZiAobG9hZEhvb2tzW25hbWVdKSB7CiAgICBmb3JFYWNoLmNhbGwobG9hZEhvb2tzW25hbWVdLCBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICBjYWxsYmFjayhvYmplY3QpOwogICAgfSk7CiAgfQp9OwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewp2YXIgZ2V0ID0gRW1iZXIuZ2V0OwoKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1ydW50aW1lCiovCgovKioKICBgRW1iZXIuQ29udHJvbGxlck1peGluYCBwcm92aWRlcyBhIHN0YW5kYXJkIGludGVyZmFjZSBmb3IgYWxsIGNsYXNzZXMgdGhhdAogIGNvbXBvc2UgRW1iZXIncyBjb250cm9sbGVyIGxheWVyOiBgRW1iZXIuQ29udHJvbGxlcmAsCiAgYEVtYmVyLkFycmF5Q29udHJvbGxlcmAsIGFuZCBgRW1iZXIuT2JqZWN0Q29udHJvbGxlcmAuCgogIEBjbGFzcyBDb250cm9sbGVyTWl4aW4KICBAbmFtZXNwYWNlIEVtYmVyCiAgQHVzZXMgRW1iZXIuQWN0aW9uSGFuZGxlcgoqLwpFbWJlci5Db250cm9sbGVyTWl4aW4gPSBFbWJlci5NaXhpbi5jcmVhdGUoRW1iZXIuQWN0aW9uSGFuZGxlciwgewogIC8qIGR1Y2t0eXBlIGFzIGEgY29udHJvbGxlciAqLwogIGlzQ29udHJvbGxlcjogdHJ1ZSwKCiAgLyoqCiAgICBUaGUgb2JqZWN0IHRvIHdoaWNoIGFjdGlvbnMgZnJvbSB0aGUgdmlldyBzaG91bGQgYmUgc2VudC4KCiAgICBGb3IgZXhhbXBsZSwgd2hlbiBhIEhhbmRsZWJhcnMgdGVtcGxhdGUgdXNlcyB0aGUgYHt7YWN0aW9ufX1gIGhlbHBlciwKICAgIGl0IHdpbGwgYXR0ZW1wdCB0byBzZW5kIHRoZSBhY3Rpb24gdG8gdGhlIHZpZXcncyBjb250cm9sbGVyJ3MgYHRhcmdldGAuCgogICAgQnkgZGVmYXVsdCwgYSBjb250cm9sbGVyJ3MgYHRhcmdldGAgaXMgc2V0IHRvIHRoZSByb3V0ZXIgYWZ0ZXIgaXQgaXMKICAgIGluc3RhbnRpYXRlZCBieSBgRW1iZXIuQXBwbGljYXRpb24jaW5pdGlhbGl6ZWAuCgogICAgQHByb3BlcnR5IHRhcmdldAogICAgQGRlZmF1bHQgbnVsbAogICovCiAgdGFyZ2V0OiBudWxsLAoKICBjb250YWluZXI6IG51bGwsCgogIHBhcmVudENvbnRyb2xsZXI6IG51bGwsCgogIHN0b3JlOiBudWxsLAoKICBtb2RlbDogRW1iZXIuY29tcHV0ZWQuYWxpYXMoJ2NvbnRlbnQnKSwKCiAgZGVwcmVjYXRlZFNlbmRIYW5kbGVzOiBmdW5jdGlvbihhY3Rpb25OYW1lKSB7CiAgICByZXR1cm4gISF0aGlzW2FjdGlvbk5hbWVdOwogIH0sCgogIGRlcHJlY2F0ZWRTZW5kOiBmdW5jdGlvbihhY3Rpb25OYW1lKSB7CiAgICB2YXIgYXJncyA9IFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIEVtYmVyLmFzc2VydCgnJyArIHRoaXMgKyAiIGhhcyB0aGUgYWN0aW9uICIgKyBhY3Rpb25OYW1lICsgIiBidXQgaXQgaXMgbm90IGEgZnVuY3Rpb24iLCB0eXBlb2YgdGhpc1thY3Rpb25OYW1lXSA9PT0gJ2Z1bmN0aW9uJyk7CiAgICBFbWJlci5kZXByZWNhdGUoJ0FjdGlvbiBoYW5kbGVycyBpbXBsZW1lbnRlZCBkaXJlY3RseSBvbiBjb250cm9sbGVycyBhcmUgZGVwcmVjYXRlZCBpbiBmYXZvciBvZiBhY3Rpb24gaGFuZGxlcnMgb24gYW4gYGFjdGlvbnNgIG9iamVjdCAoJyArIGFjdGlvbk5hbWUgKyAnIG9uICcgKyB0aGlzICsgJyknLCBmYWxzZSk7CiAgICB0aGlzW2FjdGlvbk5hbWVdLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgcmV0dXJuOwogIH0KfSk7CgovKioKICBAY2xhc3MgQ29udHJvbGxlcgogIEBuYW1lc3BhY2UgRW1iZXIKICBAZXh0ZW5kcyBFbWJlci5PYmplY3QKICBAdXNlcyBFbWJlci5Db250cm9sbGVyTWl4aW4KKi8KRW1iZXIuQ29udHJvbGxlciA9IEVtYmVyLk9iamVjdC5leHRlbmQoRW1iZXIuQ29udHJvbGxlck1peGluKTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1ydW50aW1lCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQsIGZvckVhY2ggPSBFbWJlci5FbnVtZXJhYmxlVXRpbHMuZm9yRWFjaDsKCi8qKgogIGBFbWJlci5Tb3J0YWJsZU1peGluYCBwcm92aWRlcyBhIHN0YW5kYXJkIGludGVyZmFjZSBmb3IgYXJyYXkgcHJveGllcwogIHRvIHNwZWNpZnkgYSBzb3J0IG9yZGVyIGFuZCBtYWludGFpbiB0aGlzIHNvcnRpbmcgd2hlbiBvYmplY3RzIGFyZSBhZGRlZCwKICByZW1vdmVkLCBvciB1cGRhdGVkIHdpdGhvdXQgY2hhbmdpbmcgdGhlIGltcGxpY2l0IG9yZGVyIG9mIHRoZWlyIHVuZGVybHlpbmcKICBjb250ZW50IGFycmF5OgoKICBgYGBqYXZhc2NyaXB0CiAgc29uZ3MgPSBbCiAgICB7dHJhY2tOdW1iZXI6IDQsIHRpdGxlOiAnT2ItTGEtRGksIE9iLUxhLURhJ30sCiAgICB7dHJhY2tOdW1iZXI6IDIsIHRpdGxlOiAnQmFjayBpbiB0aGUgVS5TLlMuUi4nfSwKICAgIHt0cmFja051bWJlcjogMywgdGl0bGU6ICdHbGFzcyBPbmlvbid9LAogIF07CgogIHNvbmdzQ29udHJvbGxlciA9IEVtYmVyLkFycmF5Q29udHJvbGxlci5jcmVhdGUoewogICAgY29udGVudDogc29uZ3MsCiAgICBzb3J0UHJvcGVydGllczogWyd0cmFja051bWJlciddLAogICAgc29ydEFzY2VuZGluZzogdHJ1ZQogIH0pOwoKICBzb25nc0NvbnRyb2xsZXIuZ2V0KCdmaXJzdE9iamVjdCcpOyAgLy8ge3RyYWNrTnVtYmVyOiAyLCB0aXRsZTogJ0JhY2sgaW4gdGhlIFUuUy5TLlIuJ30KCiAgc29uZ3NDb250cm9sbGVyLmFkZE9iamVjdCh7dHJhY2tOdW1iZXI6IDEsIHRpdGxlOiAnRGVhciBQcnVkZW5jZSd9KTsKICBzb25nc0NvbnRyb2xsZXIuZ2V0KCdmaXJzdE9iamVjdCcpOyAgLy8ge3RyYWNrTnVtYmVyOiAxLCB0aXRsZTogJ0RlYXIgUHJ1ZGVuY2UnfQogIGBgYAoKICBJZiB5b3UgYWRkIG9yIHJlbW92ZSB0aGUgcHJvcGVydGllcyB0byBzb3J0IGJ5IG9yIGNoYW5nZSB0aGUgc29ydCBkaXJlY3Rpb24gdGhlIGNvbnRlbnQKICBzb3J0IG9yZGVyIHdpbGwgYmUgYXV0b21hdGljYWxseSB1cGRhdGVkLgoKICBgYGBqYXZhc2NyaXB0CiAgc29uZ3NDb250cm9sbGVyLnNldCgnc29ydFByb3BlcnRpZXMnLCBbJ3RpdGxlJ10pOwogIHNvbmdzQ29udHJvbGxlci5nZXQoJ2ZpcnN0T2JqZWN0Jyk7IC8vIHt0cmFja051bWJlcjogMiwgdGl0bGU6ICdCYWNrIGluIHRoZSBVLlMuUy5SLid9CgogIHNvbmdzQ29udHJvbGxlci50b2dnbGVQcm9wZXJ0eSgnc29ydEFzY2VuZGluZycpOwogIHNvbmdzQ29udHJvbGxlci5nZXQoJ2ZpcnN0T2JqZWN0Jyk7IC8vIHt0cmFja051bWJlcjogNCwgdGl0bGU6ICdPYi1MYS1EaSwgT2ItTGEtRGEnfQogIGBgYAoKICBTb3J0YWJsZU1peGluIHdvcmtzIGJ5IHNvcnRpbmcgdGhlIGFycmFuZ2VkQ29udGVudCBhcnJheSwgd2hpY2ggaXMgdGhlIGFycmF5IHRoYXQKICBhcnJheVByb3h5IGRpc3BsYXlzLiBEdWUgdG8gdGhlIGZhY3QgdGhhdCB0aGUgdW5kZXJseWluZyAnY29udGVudCcgYXJyYXkgaXMgbm90IGNoYW5nZWQsIHRoYXQKICBhcnJheSB3aWxsIG5vdCBkaXNwbGF5IHRoZSBzb3J0ZWQgbGlzdDoKCiAgIGBgYGphdmFzY3JpcHQKICBzb25nc0NvbnRyb2xsZXIuZ2V0KCdjb250ZW50JykuZ2V0KCdmaXJzdE9iamVjdCcpOyAvLyBSZXR1cm5zIHRoZSB1bnNvcnRlZCBvcmlnaW5hbCBjb250ZW50CiAgc29uZ3NDb250cm9sbGVyLmdldCgnZmlyc3RPYmplY3QnKTsgLy8gUmV0dXJucyB0aGUgc29ydGVkIGNvbnRlbnQuCiAgYGBgIAogIAogIEFsdGhvdWdoIHRoZSBzb3J0ZWQgY29udGVudCBjYW4gYWxzbyBiZSBhY2Nlc3NlZCB0aHJvdWdoIHRoZSBhcnJhbmdlZENvbnRlbnQgcHJvcGVydHksCiAgaXQgaXMgcHJlZmVyYWJsZSB0byB1c2UgdGhlIHByb3hpZWQgY2xhc3MgYW5kIG5vdCB0aGUgYXJyYW5nZWRDb250ZW50IGFycmF5IGRpcmVjdGx5LgoKICBAY2xhc3MgU29ydGFibGVNaXhpbgogIEBuYW1lc3BhY2UgRW1iZXIKICBAdXNlcyBFbWJlci5NdXRhYmxlRW51bWVyYWJsZQoqLwpFbWJlci5Tb3J0YWJsZU1peGluID0gRW1iZXIuTWl4aW4uY3JlYXRlKEVtYmVyLk11dGFibGVFbnVtZXJhYmxlLCB7CgogIC8qKgogICAgU3BlY2lmaWVzIHdoaWNoIHByb3BlcnRpZXMgZGljdGF0ZSB0aGUgYXJyYW5nZWRDb250ZW50J3Mgc29ydCBvcmRlci4KCiAgICBXaGVuIHNwZWNpZnlpbmcgbXVsdGlwbGUgcHJvcGVydGllcyB0aGUgc29ydGluZyB3aWxsIHVzZSBwcm9wZXJ0aWVzCiAgICBmcm9tIHRoZSBgc29ydFByb3BlcnRpZXNgIGFycmF5IHByaW9yaXRpemVkIGZyb20gZmlyc3QgdG8gbGFzdC4KCiAgICBAcHJvcGVydHkge0FycmF5fSBzb3J0UHJvcGVydGllcwogICovCiAgc29ydFByb3BlcnRpZXM6IG51bGwsCgogIC8qKgogICAgU3BlY2lmaWVzIHRoZSBhcnJhbmdlZENvbnRlbnQncyBzb3J0IGRpcmVjdGlvbgoKICAgIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gc29ydEFzY2VuZGluZwogICovCiAgc29ydEFzY2VuZGluZzogdHJ1ZSwKCiAgLyoqCiAgICBUaGUgZnVuY3Rpb24gdXNlZCB0byBjb21wYXJlIHR3byB2YWx1ZXMuIFlvdSBjYW4gb3ZlcnJpZGUgdGhpcyBpZiB5b3UKICAgIHdhbnQgdG8gZG8gY3VzdG9tIGNvbXBhcmlzb25zLiBGdW5jdGlvbnMgbXVzdCBiZSBvZiB0aGUgdHlwZSBleHBlY3RlZCBieQogICAgQXJyYXkjc29ydCwgaS5lLgogICAgICByZXR1cm4gMCBpZiB0aGUgdHdvIHBhcmFtZXRlcnMgYXJlIGVxdWFsLAogICAgICByZXR1cm4gYSBuZWdhdGl2ZSB2YWx1ZSBpZiB0aGUgZmlyc3QgcGFyYW1ldGVyIGlzIHNtYWxsZXIgdGhhbiB0aGUgc2Vjb25kIG9yCiAgICAgIHJldHVybiBhIHBvc2l0aXZlIHZhbHVlIG90aGVyd2lzZToKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBmdW5jdGlvbih4LHkpIHsgLy8gVGhlc2UgYXJlIGFzc3VtZWQgdG8gYmUgaW50ZWdlcnMKICAgICAgaWYgKHggPT09IHkpCiAgICAgICAgcmV0dXJuIDA7CiAgICAgIHJldHVybiB4IDwgeSA/IC0xIDogMTsKICAgIH0KICAgIGBgYAoKICAgIEBwcm9wZXJ0eSBzb3J0RnVuY3Rpb24KICAgIEB0eXBlIHtGdW5jdGlvbn0KICAgIEBkZWZhdWx0IEVtYmVyLmNvbXBhcmUKICAqLwogIHNvcnRGdW5jdGlvbjogRW1iZXIuY29tcGFyZSwKCiAgb3JkZXJCeTogZnVuY3Rpb24oaXRlbTEsIGl0ZW0yKSB7CiAgICB2YXIgcmVzdWx0ID0gMCwKICAgICAgICBzb3J0UHJvcGVydGllcyA9IGdldCh0aGlzLCAnc29ydFByb3BlcnRpZXMnKSwKICAgICAgICBzb3J0QXNjZW5kaW5nID0gZ2V0KHRoaXMsICdzb3J0QXNjZW5kaW5nJyksCiAgICAgICAgc29ydEZ1bmN0aW9uID0gZ2V0KHRoaXMsICdzb3J0RnVuY3Rpb24nKTsKCiAgICBFbWJlci5hc3NlcnQoInlvdSBuZWVkIHRvIGRlZmluZSBgc29ydFByb3BlcnRpZXNgIiwgISFzb3J0UHJvcGVydGllcyk7CgogICAgZm9yRWFjaChzb3J0UHJvcGVydGllcywgZnVuY3Rpb24ocHJvcGVydHlOYW1lKSB7CiAgICAgIGlmIChyZXN1bHQgPT09IDApIHsKICAgICAgICByZXN1bHQgPSBzb3J0RnVuY3Rpb24oZ2V0KGl0ZW0xLCBwcm9wZXJ0eU5hbWUpLCBnZXQoaXRlbTIsIHByb3BlcnR5TmFtZSkpOwogICAgICAgIGlmICgocmVzdWx0ICE9PSAwKSAmJiAhc29ydEFzY2VuZGluZykgewogICAgICAgICAgcmVzdWx0ID0gKC0xKSAqIHJlc3VsdDsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybiByZXN1bHQ7CiAgfSwKCiAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICB2YXIgY29udGVudCA9IGdldCh0aGlzLCAnY29udGVudCcpLAogICAgICAgIHNvcnRQcm9wZXJ0aWVzID0gZ2V0KHRoaXMsICdzb3J0UHJvcGVydGllcycpOwoKICAgIGlmIChjb250ZW50ICYmIHNvcnRQcm9wZXJ0aWVzKSB7CiAgICAgIGZvckVhY2goY29udGVudCwgZnVuY3Rpb24oaXRlbSkgewogICAgICAgIGZvckVhY2goc29ydFByb3BlcnRpZXMsIGZ1bmN0aW9uKHNvcnRQcm9wZXJ0eSkgewogICAgICAgICAgRW1iZXIucmVtb3ZlT2JzZXJ2ZXIoaXRlbSwgc29ydFByb3BlcnR5LCB0aGlzLCAnY29udGVudEl0ZW1Tb3J0UHJvcGVydHlEaWRDaGFuZ2UnKTsKICAgICAgICB9LCB0aGlzKTsKICAgICAgfSwgdGhpcyk7CiAgICB9CgogICAgcmV0dXJuIHRoaXMuX3N1cGVyKCk7CiAgfSwKCiAgaXNTb3J0ZWQ6IEVtYmVyLmNvbXB1dGVkLmJvb2woJ3NvcnRQcm9wZXJ0aWVzJyksCgogIC8qKgogICAgT3ZlcnJpZGVzIHRoZSBkZWZhdWx0IGFycmFuZ2VkQ29udGVudCBmcm9tIGFycmF5UHJveHkgaW4gb3JkZXIgdG8gc29ydCBieSBzb3J0RnVuY3Rpb24uCiAgICBBbHNvIHNldHMgdXAgb2JzZXJ2ZXJzIGZvciBlYWNoIHNvcnRQcm9wZXJ0eSBvbiBlYWNoIGl0ZW0gaW4gdGhlIGNvbnRlbnQgQXJyYXkuCiAgICAKICAgIEBwcm9wZXJ0eSBhcnJhbmdlZENvbnRlbnQKICAqLwoKICBhcnJhbmdlZENvbnRlbnQ6IEVtYmVyLmNvbXB1dGVkKCdjb250ZW50JywgJ3NvcnRQcm9wZXJ0aWVzLkBlYWNoJywgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgdmFyIGNvbnRlbnQgPSBnZXQodGhpcywgJ2NvbnRlbnQnKSwKICAgICAgICBpc1NvcnRlZCA9IGdldCh0aGlzLCAnaXNTb3J0ZWQnKSwKICAgICAgICBzb3J0UHJvcGVydGllcyA9IGdldCh0aGlzLCAnc29ydFByb3BlcnRpZXMnKSwKICAgICAgICBzZWxmID0gdGhpczsKCiAgICBpZiAoY29udGVudCAmJiBpc1NvcnRlZCkgewogICAgICBjb250ZW50ID0gY29udGVudC5zbGljZSgpOwogICAgICBjb250ZW50LnNvcnQoZnVuY3Rpb24oaXRlbTEsIGl0ZW0yKSB7CiAgICAgICAgcmV0dXJuIHNlbGYub3JkZXJCeShpdGVtMSwgaXRlbTIpOwogICAgICB9KTsKICAgICAgZm9yRWFjaChjb250ZW50LCBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgZm9yRWFjaChzb3J0UHJvcGVydGllcywgZnVuY3Rpb24oc29ydFByb3BlcnR5KSB7CiAgICAgICAgICBFbWJlci5hZGRPYnNlcnZlcihpdGVtLCBzb3J0UHJvcGVydHksIHRoaXMsICdjb250ZW50SXRlbVNvcnRQcm9wZXJ0eURpZENoYW5nZScpOwogICAgICAgIH0sIHRoaXMpOwogICAgICB9LCB0aGlzKTsKICAgICAgcmV0dXJuIEVtYmVyLkEoY29udGVudCk7CiAgICB9CgogICAgcmV0dXJuIGNvbnRlbnQ7CiAgfSksCgogIF9jb250ZW50V2lsbENoYW5nZTogRW1iZXIuYmVmb3JlT2JzZXJ2ZXIoJ2NvbnRlbnQnLCBmdW5jdGlvbigpIHsKICAgIHZhciBjb250ZW50ID0gZ2V0KHRoaXMsICdjb250ZW50JyksCiAgICAgICAgc29ydFByb3BlcnRpZXMgPSBnZXQodGhpcywgJ3NvcnRQcm9wZXJ0aWVzJyk7CgogICAgaWYgKGNvbnRlbnQgJiYgc29ydFByb3BlcnRpZXMpIHsKICAgICAgZm9yRWFjaChjb250ZW50LCBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgZm9yRWFjaChzb3J0UHJvcGVydGllcywgZnVuY3Rpb24oc29ydFByb3BlcnR5KSB7CiAgICAgICAgICBFbWJlci5yZW1vdmVPYnNlcnZlcihpdGVtLCBzb3J0UHJvcGVydHksIHRoaXMsICdjb250ZW50SXRlbVNvcnRQcm9wZXJ0eURpZENoYW5nZScpOwogICAgICAgIH0sIHRoaXMpOwogICAgICB9LCB0aGlzKTsKICAgIH0KCiAgICB0aGlzLl9zdXBlcigpOwogIH0pLAoKICBzb3J0QXNjZW5kaW5nV2lsbENoYW5nZTogRW1iZXIuYmVmb3JlT2JzZXJ2ZXIoJ3NvcnRBc2NlbmRpbmcnLCBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xhc3RTb3J0QXNjZW5kaW5nID0gZ2V0KHRoaXMsICdzb3J0QXNjZW5kaW5nJyk7CiAgfSksCgogIHNvcnRBc2NlbmRpbmdEaWRDaGFuZ2U6IEVtYmVyLm9ic2VydmVyKCdzb3J0QXNjZW5kaW5nJywgZnVuY3Rpb24oKSB7CiAgICBpZiAoZ2V0KHRoaXMsICdzb3J0QXNjZW5kaW5nJykgIT09IHRoaXMuX2xhc3RTb3J0QXNjZW5kaW5nKSB7CiAgICAgIHZhciBhcnJhbmdlZENvbnRlbnQgPSBnZXQodGhpcywgJ2FycmFuZ2VkQ29udGVudCcpOwogICAgICBhcnJhbmdlZENvbnRlbnQucmV2ZXJzZU9iamVjdHMoKTsKICAgIH0KICB9KSwKCiAgY29udGVudEFycmF5V2lsbENoYW5nZTogZnVuY3Rpb24oYXJyYXksIGlkeCwgcmVtb3ZlZENvdW50LCBhZGRlZENvdW50KSB7CiAgICB2YXIgaXNTb3J0ZWQgPSBnZXQodGhpcywgJ2lzU29ydGVkJyk7CgogICAgaWYgKGlzU29ydGVkKSB7CiAgICAgIHZhciBhcnJhbmdlZENvbnRlbnQgPSBnZXQodGhpcywgJ2FycmFuZ2VkQ29udGVudCcpOwogICAgICB2YXIgcmVtb3ZlZE9iamVjdHMgPSBhcnJheS5zbGljZShpZHgsIGlkeCtyZW1vdmVkQ291bnQpOwogICAgICB2YXIgc29ydFByb3BlcnRpZXMgPSBnZXQodGhpcywgJ3NvcnRQcm9wZXJ0aWVzJyk7CgogICAgICBmb3JFYWNoKHJlbW92ZWRPYmplY3RzLCBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgYXJyYW5nZWRDb250ZW50LnJlbW92ZU9iamVjdChpdGVtKTsKCiAgICAgICAgZm9yRWFjaChzb3J0UHJvcGVydGllcywgZnVuY3Rpb24oc29ydFByb3BlcnR5KSB7CiAgICAgICAgICBFbWJlci5yZW1vdmVPYnNlcnZlcihpdGVtLCBzb3J0UHJvcGVydHksIHRoaXMsICdjb250ZW50SXRlbVNvcnRQcm9wZXJ0eURpZENoYW5nZScpOwogICAgICAgIH0sIHRoaXMpOwogICAgICB9LCB0aGlzKTsKICAgIH0KCiAgICByZXR1cm4gdGhpcy5fc3VwZXIoYXJyYXksIGlkeCwgcmVtb3ZlZENvdW50LCBhZGRlZENvdW50KTsKICB9LAoKICBjb250ZW50QXJyYXlEaWRDaGFuZ2U6IGZ1bmN0aW9uKGFycmF5LCBpZHgsIHJlbW92ZWRDb3VudCwgYWRkZWRDb3VudCkgewogICAgdmFyIGlzU29ydGVkID0gZ2V0KHRoaXMsICdpc1NvcnRlZCcpLAogICAgICAgIHNvcnRQcm9wZXJ0aWVzID0gZ2V0KHRoaXMsICdzb3J0UHJvcGVydGllcycpOwoKICAgIGlmIChpc1NvcnRlZCkgewogICAgICB2YXIgYWRkZWRPYmplY3RzID0gYXJyYXkuc2xpY2UoaWR4LCBpZHgrYWRkZWRDb3VudCk7CgogICAgICBmb3JFYWNoKGFkZGVkT2JqZWN0cywgZnVuY3Rpb24oaXRlbSkgewogICAgICAgIHRoaXMuaW5zZXJ0SXRlbVNvcnRlZChpdGVtKTsKCiAgICAgICAgZm9yRWFjaChzb3J0UHJvcGVydGllcywgZnVuY3Rpb24oc29ydFByb3BlcnR5KSB7CiAgICAgICAgICBFbWJlci5hZGRPYnNlcnZlcihpdGVtLCBzb3J0UHJvcGVydHksIHRoaXMsICdjb250ZW50SXRlbVNvcnRQcm9wZXJ0eURpZENoYW5nZScpOwogICAgICAgIH0sIHRoaXMpOwogICAgICB9LCB0aGlzKTsKICAgIH0KCiAgICByZXR1cm4gdGhpcy5fc3VwZXIoYXJyYXksIGlkeCwgcmVtb3ZlZENvdW50LCBhZGRlZENvdW50KTsKICB9LAoKICBpbnNlcnRJdGVtU29ydGVkOiBmdW5jdGlvbihpdGVtKSB7CiAgICB2YXIgYXJyYW5nZWRDb250ZW50ID0gZ2V0KHRoaXMsICdhcnJhbmdlZENvbnRlbnQnKTsKICAgIHZhciBsZW5ndGggPSBnZXQoYXJyYW5nZWRDb250ZW50LCAnbGVuZ3RoJyk7CgogICAgdmFyIGlkeCA9IHRoaXMuX2JpbmFyeVNlYXJjaChpdGVtLCAwLCBsZW5ndGgpOwogICAgYXJyYW5nZWRDb250ZW50Lmluc2VydEF0KGlkeCwgaXRlbSk7CiAgfSwKCiAgY29udGVudEl0ZW1Tb3J0UHJvcGVydHlEaWRDaGFuZ2U6IGZ1bmN0aW9uKGl0ZW0pIHsKICAgIHZhciBhcnJhbmdlZENvbnRlbnQgPSBnZXQodGhpcywgJ2FycmFuZ2VkQ29udGVudCcpLAogICAgICAgIG9sZEluZGV4ID0gYXJyYW5nZWRDb250ZW50LmluZGV4T2YoaXRlbSksCiAgICAgICAgbGVmdEl0ZW0gPSBhcnJhbmdlZENvbnRlbnQub2JqZWN0QXQob2xkSW5kZXggLSAxKSwKICAgICAgICByaWdodEl0ZW0gPSBhcnJhbmdlZENvbnRlbnQub2JqZWN0QXQob2xkSW5kZXggKyAxKSwKICAgICAgICBsZWZ0UmVzdWx0ID0gbGVmdEl0ZW0gJiYgdGhpcy5vcmRlckJ5KGl0ZW0sIGxlZnRJdGVtKSwKICAgICAgICByaWdodFJlc3VsdCA9IHJpZ2h0SXRlbSAmJiB0aGlzLm9yZGVyQnkoaXRlbSwgcmlnaHRJdGVtKTsKCiAgICBpZiAobGVmdFJlc3VsdCA8IDAgfHwgcmlnaHRSZXN1bHQgPiAwKSB7CiAgICAgIGFycmFuZ2VkQ29udGVudC5yZW1vdmVPYmplY3QoaXRlbSk7CiAgICAgIHRoaXMuaW5zZXJ0SXRlbVNvcnRlZChpdGVtKTsKICAgIH0KICB9LAoKICBfYmluYXJ5U2VhcmNoOiBmdW5jdGlvbihpdGVtLCBsb3csIGhpZ2gpIHsKICAgIHZhciBtaWQsIG1pZEl0ZW0sIHJlcywgYXJyYW5nZWRDb250ZW50OwoKICAgIGlmIChsb3cgPT09IGhpZ2gpIHsKICAgICAgcmV0dXJuIGxvdzsKICAgIH0KCiAgICBhcnJhbmdlZENvbnRlbnQgPSBnZXQodGhpcywgJ2FycmFuZ2VkQ29udGVudCcpOwoKICAgIG1pZCA9IGxvdyArIE1hdGguZmxvb3IoKGhpZ2ggLSBsb3cpIC8gMik7CiAgICBtaWRJdGVtID0gYXJyYW5nZWRDb250ZW50Lm9iamVjdEF0KG1pZCk7CgogICAgcmVzID0gdGhpcy5vcmRlckJ5KG1pZEl0ZW0sIGl0ZW0pOwoKICAgIGlmIChyZXMgPCAwKSB7CiAgICAgIHJldHVybiB0aGlzLl9iaW5hcnlTZWFyY2goaXRlbSwgbWlkKzEsIGhpZ2gpOwogICAgfSBlbHNlIGlmIChyZXMgPiAwKSB7CiAgICAgIHJldHVybiB0aGlzLl9iaW5hcnlTZWFyY2goaXRlbSwgbG93LCBtaWQpOwogICAgfQoKICAgIHJldHVybiBtaWQ7CiAgfQp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1ydW50aW1lCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQsIGZvckVhY2ggPSBFbWJlci5FbnVtZXJhYmxlVXRpbHMuZm9yRWFjaCwKICAgIHJlcGxhY2UgPSBFbWJlci5FbnVtZXJhYmxlVXRpbHMucmVwbGFjZTsKCi8qKgogIGBFbWJlci5BcnJheUNvbnRyb2xsZXJgIHByb3ZpZGVzIGEgd2F5IGZvciB5b3UgdG8gcHVibGlzaCBhIGNvbGxlY3Rpb24gb2YKICBvYmplY3RzIHNvIHRoYXQgeW91IGNhbiBlYXNpbHkgYmluZCB0byB0aGUgY29sbGVjdGlvbiBmcm9tIGEgSGFuZGxlYmFycwogIGAjZWFjaGAgaGVscGVyLCBhbiBgRW1iZXIuQ29sbGVjdGlvblZpZXdgLCBvciBvdGhlciBjb250cm9sbGVycy4KCiAgVGhlIGFkdmFudGFnZSBvZiB1c2luZyBhbiBgQXJyYXlDb250cm9sbGVyYCBpcyB0aGF0IHlvdSBvbmx5IGhhdmUgdG8gc2V0IHVwCiAgeW91ciB2aWV3IGJpbmRpbmdzIG9uY2U7IHRvIGNoYW5nZSB3aGF0J3MgZGlzcGxheWVkLCBzaW1wbHkgc3dhcCBvdXQgdGhlCiAgYGNvbnRlbnRgIHByb3BlcnR5IG9uIHRoZSBjb250cm9sbGVyLgoKICBGb3IgZXhhbXBsZSwgaW1hZ2luZSB5b3Ugd2FudGVkIHRvIGRpc3BsYXkgYSBsaXN0IG9mIGl0ZW1zIGZldGNoZWQgdmlhIGFuIFhIUgogIHJlcXVlc3QuIENyZWF0ZSBhbiBgRW1iZXIuQXJyYXlDb250cm9sbGVyYCBhbmQgc2V0IGl0cyBgY29udGVudGAgcHJvcGVydHk6CgogIGBgYGphdmFzY3JpcHQKICBNeUFwcC5saXN0Q29udHJvbGxlciA9IEVtYmVyLkFycmF5Q29udHJvbGxlci5jcmVhdGUoKTsKCiAgJC5nZXQoJ3Blb3BsZS5qc29uJywgZnVuY3Rpb24oZGF0YSkgewogICAgTXlBcHAubGlzdENvbnRyb2xsZXIuc2V0KCdjb250ZW50JywgZGF0YSk7CiAgfSk7CiAgYGBgCgogIFRoZW4sIGNyZWF0ZSBhIHZpZXcgdGhhdCBiaW5kcyB0byB5b3VyIG5ldyBjb250cm9sbGVyOgoKICBgYGBoYW5kbGViYXJzCiAge3sjZWFjaCBNeUFwcC5saXN0Q29udHJvbGxlcn19CiAgICB7e2ZpcnN0TmFtZX19IHt7bGFzdE5hbWV9fQogIHt7L2VhY2h9fQogIGBgYAoKICBBbHRob3VnaCB5b3UgYXJlIGJpbmRpbmcgdG8gdGhlIGNvbnRyb2xsZXIsIHRoZSBiZWhhdmlvciBvZiB0aGlzIGNvbnRyb2xsZXIKICBpcyB0byBwYXNzIHRocm91Z2ggYW55IG1ldGhvZHMgb3IgcHJvcGVydGllcyB0byB0aGUgdW5kZXJseWluZyBhcnJheS4gVGhpcwogIGNhcGFiaWxpdHkgY29tZXMgZnJvbSBgRW1iZXIuQXJyYXlQcm94eWAsIHdoaWNoIHRoaXMgY2xhc3MgaW5oZXJpdHMgZnJvbS4KCiAgU29tZXRpbWVzIHlvdSB3YW50IHRvIGRpc3BsYXkgY29tcHV0ZWQgcHJvcGVydGllcyB3aXRoaW4gdGhlIGJvZHkgb2YgYW4KICBgI2VhY2hgIGhlbHBlciB0aGF0IGRlcGVuZCBvbiB0aGUgdW5kZXJseWluZyBpdGVtcyBpbiBgY29udGVudGAsIGJ1dCBhcmUgbm90CiAgcHJlc2VudCBvbiB0aG9zZSBpdGVtcy4gICBUbyBkbyB0aGlzLCBzZXQgYGl0ZW1Db250cm9sbGVyYCB0byB0aGUgbmFtZSBvZiBhCiAgY29udHJvbGxlciAocHJvYmFibHkgYW4gYE9iamVjdENvbnRyb2xsZXJgKSB0aGF0IHdpbGwgd3JhcCBlYWNoIGluZGl2aWR1YWwgaXRlbS4KCiAgRm9yIGV4YW1wbGU6CgogIGBgYGhhbmRsZWJhcnMKICAgIHt7I2VhY2ggcG9zdCBpbiBjb250cm9sbGVyfX0KICAgICAgPGxpPnt7dGl0bGV9fSAoe3t0aXRsZUxlbmd0aH19IGNoYXJhY3RlcnMpPC9saT4KICAgIHt7L2VhY2h9fQogIGBgYAoKICBgYGBqYXZhc2NyaXB0CiAgQXBwLlBvc3RzQ29udHJvbGxlciA9IEVtYmVyLkFycmF5Q29udHJvbGxlci5leHRlbmQoewogICAgaXRlbUNvbnRyb2xsZXI6ICdwb3N0JwogIH0pOwoKICBBcHAuUG9zdENvbnRyb2xsZXIgPSBFbWJlci5PYmplY3RDb250cm9sbGVyLmV4dGVuZCh7CiAgICAvLyB0aGUgYHRpdGxlYCBwcm9wZXJ0eSB3aWxsIGJlIHByb3hpZWQgdG8gdGhlIHVuZGVybHlpbmcgcG9zdC4KCiAgICB0aXRsZUxlbmd0aDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmdldCgndGl0bGUnKS5sZW5ndGg7CiAgICB9LnByb3BlcnR5KCd0aXRsZScpCiAgfSk7CiAgYGBgCgogIEluIHNvbWUgY2FzZXMgaXQgaXMgaGVscGZ1bCB0byByZXR1cm4gYSBkaWZmZXJlbnQgYGl0ZW1Db250cm9sbGVyYCBkZXBlbmRpbmcKICBvbiB0aGUgcGFydGljdWxhciBpdGVtLiAgU3ViY2xhc3NlcyBjYW4gZG8gdGhpcyBieSBvdmVycmlkaW5nCiAgYGxvb2t1cEl0ZW1Db250cm9sbGVyYC4KCiAgRm9yIGV4YW1wbGU6CgogIGBgYGphdmFzY3JpcHQKICBBcHAuTXlBcnJheUNvbnRyb2xsZXIgPSBFbWJlci5BcnJheUNvbnRyb2xsZXIuZXh0ZW5kKHsKICAgIGxvb2t1cEl0ZW1Db250cm9sbGVyOiBmdW5jdGlvbiggb2JqZWN0ICkgewogICAgICBpZiAob2JqZWN0LmdldCgnaXNTcGVjaWFsJykpIHsKICAgICAgICByZXR1cm4gInNwZWNpYWwiOyAvLyB1c2UgQXBwLlNwZWNpYWxDb250cm9sbGVyCiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuICJyZWd1bGFyIjsgLy8gdXNlIEFwcC5SZWd1bGFyQ29udHJvbGxlcgogICAgICB9CiAgICB9CiAgfSk7CiAgYGBgCgogIFRoZSBpdGVtQ29udHJvbGxlciBpbnN0YW5jZXMgd2lsbCBoYXZlIGEgYHBhcmVudENvbnRyb2xsZXJgIHByb3BlcnR5IHNldCB0bwogIGVpdGhlciB0aGUgdGhlIGBwYXJlbnRDb250cm9sbGVyYCBwcm9wZXJ0eSBvZiB0aGUgYEFycmF5Q29udHJvbGxlcmAKICBvciB0byB0aGUgYEFycmF5Q29udHJvbGxlcmAgaW5zdGFuY2UgaXRzZWxmLgoKICBAY2xhc3MgQXJyYXlDb250cm9sbGVyCiAgQG5hbWVzcGFjZSBFbWJlcgogIEBleHRlbmRzIEVtYmVyLkFycmF5UHJveHkKICBAdXNlcyBFbWJlci5Tb3J0YWJsZU1peGluCiAgQHVzZXMgRW1iZXIuQ29udHJvbGxlck1peGluCiovCgpFbWJlci5BcnJheUNvbnRyb2xsZXIgPSBFbWJlci5BcnJheVByb3h5LmV4dGVuZChFbWJlci5Db250cm9sbGVyTWl4aW4sCiAgRW1iZXIuU29ydGFibGVNaXhpbiwgewoKICAvKioKICAgIFRoZSBjb250cm9sbGVyIHVzZWQgdG8gd3JhcCBpdGVtcywgaWYgYW55LgoKICAgIEBwcm9wZXJ0eSBpdGVtQ29udHJvbGxlcgogICAgQHR5cGUgU3RyaW5nCiAgICBAZGVmYXVsdCBudWxsCiAgKi8KICBpdGVtQ29udHJvbGxlcjogbnVsbCwKCiAgLyoqCiAgICBSZXR1cm4gdGhlIG5hbWUgb2YgdGhlIGNvbnRyb2xsZXIgdG8gd3JhcCBpdGVtcywgb3IgYG51bGxgIGlmIGl0ZW1zIHNob3VsZAogICAgYmUgcmV0dXJuZWQgZGlyZWN0bHkuICBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBzaW1wbHkgcmV0dXJucyB0aGUKICAgIGBpdGVtQ29udHJvbGxlcmAgcHJvcGVydHksIGJ1dCBzdWJjbGFzc2VzIGNhbiBvdmVycmlkZSB0aGlzIG1ldGhvZCB0byByZXR1cm4KICAgIGRpZmZlcmVudCBjb250cm9sbGVycyBmb3IgZGlmZmVyZW50IG9iamVjdHMuCgogICAgRm9yIGV4YW1wbGU6CgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLk15QXJyYXlDb250cm9sbGVyID0gRW1iZXIuQXJyYXlDb250cm9sbGVyLmV4dGVuZCh7CiAgICAgIGxvb2t1cEl0ZW1Db250cm9sbGVyOiBmdW5jdGlvbiggb2JqZWN0ICkgewogICAgICAgIGlmIChvYmplY3QuZ2V0KCdpc1NwZWNpYWwnKSkgewogICAgICAgICAgcmV0dXJuICJzcGVjaWFsIjsgLy8gdXNlIEFwcC5TcGVjaWFsQ29udHJvbGxlcgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gInJlZ3VsYXIiOyAvLyB1c2UgQXBwLlJlZ3VsYXJDb250cm9sbGVyCiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgIEBtZXRob2QgbG9va3VwSXRlbUNvbnRyb2xsZXIKICAgIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QKICAgIEByZXR1cm4ge1N0cmluZ30KICAqLwogIGxvb2t1cEl0ZW1Db250cm9sbGVyOiBmdW5jdGlvbihvYmplY3QpIHsKICAgIHJldHVybiBnZXQodGhpcywgJ2l0ZW1Db250cm9sbGVyJyk7CiAgfSwKCiAgb2JqZWN0QXRDb250ZW50OiBmdW5jdGlvbihpZHgpIHsKICAgIHZhciBsZW5ndGggPSBnZXQodGhpcywgJ2xlbmd0aCcpLAogICAgICAgIGFycmFuZ2VkQ29udGVudCA9IGdldCh0aGlzLCdhcnJhbmdlZENvbnRlbnQnKSwKICAgICAgICBvYmplY3QgPSBhcnJhbmdlZENvbnRlbnQgJiYgYXJyYW5nZWRDb250ZW50Lm9iamVjdEF0KGlkeCk7CgogICAgaWYgKGlkeCA+PSAwICYmIGlkeCA8IGxlbmd0aCkgewogICAgICB2YXIgY29udHJvbGxlckNsYXNzID0gdGhpcy5sb29rdXBJdGVtQ29udHJvbGxlcihvYmplY3QpOwogICAgICBpZiAoY29udHJvbGxlckNsYXNzKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY29udHJvbGxlckF0KGlkeCwgb2JqZWN0LCBjb250cm9sbGVyQ2xhc3MpOwogICAgICB9CiAgICB9CgogICAgLy8gV2hlbiBgY29udHJvbGxlckNsYXNzYCBpcyBmYWxzeSwgd2UgaGF2ZSBub3Qgb3B0ZWQgaW4gdG8gdXNpbmcgaXRlbQogICAgLy8gY29udHJvbGxlcnMsIHNvIHJldHVybiB0aGUgb2JqZWN0IGRpcmVjdGx5LgoKICAgIC8vIFdoZW4gdGhlIGluZGV4IGlzIG91dCBvZiByYW5nZSwgd2Ugd2FudCB0byByZXR1cm4gdGhlICJvdXQgb2YgcmFuZ2UiCiAgICAvLyB2YWx1ZSwgd2hhdGV2ZXIgdGhhdCBtaWdodCBiZS4gIFJhdGhlciB0aGFuIG1ha2UgYXNzdW1wdGlvbnMKICAgIC8vIChlLmcuIGd1ZXNzaW5nIGBudWxsYCBvciBgdW5kZWZpbmVkYCkgd2UgZGVmZXIgdGhpcyB0byBgYXJyYW5nZWRDb250ZW50YC4KICAgIHJldHVybiBvYmplY3Q7CiAgfSwKCiAgYXJyYW5nZWRDb250ZW50RGlkQ2hhbmdlOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3N1cGVyKCk7CiAgICB0aGlzLl9yZXNldFN1YkNvbnRyb2xsZXJzKCk7CiAgfSwKCiAgYXJyYXlDb250ZW50RGlkQ2hhbmdlOiBmdW5jdGlvbihpZHgsIHJlbW92ZWRDbnQsIGFkZGVkQ250KSB7CiAgICB2YXIgc3ViQ29udHJvbGxlcnMgPSBnZXQodGhpcywgJ19zdWJDb250cm9sbGVycycpLAogICAgICAgIHN1YkNvbnRyb2xsZXJzVG9SZW1vdmUgPSBzdWJDb250cm9sbGVycy5zbGljZShpZHgsIGlkeCtyZW1vdmVkQ250KTsKCiAgICBmb3JFYWNoKHN1YkNvbnRyb2xsZXJzVG9SZW1vdmUsIGZ1bmN0aW9uKHN1YkNvbnRyb2xsZXIpIHsKICAgICAgaWYgKHN1YkNvbnRyb2xsZXIpIHsgc3ViQ29udHJvbGxlci5kZXN0cm95KCk7IH0KICAgIH0pOwoKICAgIHJlcGxhY2Uoc3ViQ29udHJvbGxlcnMsIGlkeCwgcmVtb3ZlZENudCwgbmV3IEFycmF5KGFkZGVkQ250KSk7CgogICAgLy8gVGhlIHNoYWRvdyBhcnJheSBvZiBzdWJjb250cm9sbGVycyBtdXN0IGJlIHVwZGF0ZWQgYmVmb3JlIHdlIHRyaWdnZXIKICAgIC8vIG9ic2VydmVycywgb3RoZXJ3aXNlIG9ic2VydmVycyB3aWxsIGdldCB0aGUgd3Jvbmcgc3ViY29udGFpbmVyIHdoZW4KICAgIC8vIGNhbGxpbmcgYG9iamVjdEF0YAogICAgdGhpcy5fc3VwZXIoaWR4LCByZW1vdmVkQ250LCBhZGRlZENudCk7CiAgfSwKCiAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9zdXBlcigpOwoKICAgIHRoaXMuc2V0KCdfc3ViQ29udHJvbGxlcnMnLCBFbWJlci5BKCkpOwogIH0sCgogIGNvbnRlbnQ6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBFbWJlci5BKCk7CiAgfSksCgogIGNvbnRyb2xsZXJBdDogZnVuY3Rpb24oaWR4LCBvYmplY3QsIGNvbnRyb2xsZXJDbGFzcykgewogICAgdmFyIGNvbnRhaW5lciA9IGdldCh0aGlzLCAnY29udGFpbmVyJyksCiAgICAgICAgc3ViQ29udHJvbGxlcnMgPSBnZXQodGhpcywgJ19zdWJDb250cm9sbGVycycpLAogICAgICAgIHN1YkNvbnRyb2xsZXIgPSBzdWJDb250cm9sbGVyc1tpZHhdLAogICAgICAgIGZhY3RvcnksIGZ1bGxOYW1lOwoKICAgIGlmIChzdWJDb250cm9sbGVyKSB7IHJldHVybiBzdWJDb250cm9sbGVyOyB9CgogICAgZnVsbE5hbWUgPSAiY29udHJvbGxlcjoiICsgY29udHJvbGxlckNsYXNzOwoKICAgIGlmICghY29udGFpbmVyLmhhcyhmdWxsTmFtZSkpIHsKICAgICAgdGhyb3cgbmV3IEVtYmVyLkVycm9yKCdDb3VsZCBub3QgcmVzb2x2ZSBpdGVtQ29udHJvbGxlcjogIicgKyBjb250cm9sbGVyQ2xhc3MgKyAnIicpOwogICAgfQoKICAgIHN1YkNvbnRyb2xsZXIgPSBjb250YWluZXIubG9va3VwRmFjdG9yeShmdWxsTmFtZSkuY3JlYXRlKHsKICAgICAgdGFyZ2V0OiB0aGlzLAogICAgICBwYXJlbnRDb250cm9sbGVyOiBnZXQodGhpcywgJ3BhcmVudENvbnRyb2xsZXInKSB8fCB0aGlzLAogICAgICBjb250ZW50OiBvYmplY3QKICAgIH0pOwoKICAgIHN1YkNvbnRyb2xsZXJzW2lkeF0gPSBzdWJDb250cm9sbGVyOwoKICAgIHJldHVybiBzdWJDb250cm9sbGVyOwogIH0sCgogIF9zdWJDb250cm9sbGVyczogbnVsbCwKCiAgX3Jlc2V0U3ViQ29udHJvbGxlcnM6IGZ1bmN0aW9uKCkgewogICAgdmFyIHN1YkNvbnRyb2xsZXJzID0gZ2V0KHRoaXMsICdfc3ViQ29udHJvbGxlcnMnKTsKICAgIGlmIChzdWJDb250cm9sbGVycykgewogICAgICBmb3JFYWNoKHN1YkNvbnRyb2xsZXJzLCBmdW5jdGlvbihzdWJDb250cm9sbGVyKSB7CiAgICAgICAgaWYgKHN1YkNvbnRyb2xsZXIpIHsgc3ViQ29udHJvbGxlci5kZXN0cm95KCk7IH0KICAgICAgfSk7CiAgICB9CgogICAgdGhpcy5zZXQoJ19zdWJDb250cm9sbGVycycsIEVtYmVyLkEoKSk7CiAgfQp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1ydW50aW1lCiovCgovKioKICBgRW1iZXIuT2JqZWN0Q29udHJvbGxlcmAgaXMgcGFydCBvZiBFbWJlcidzIENvbnRyb2xsZXIgbGF5ZXIuIEl0IGlzIGludGVuZGVkCiAgdG8gd3JhcCBhIHNpbmdsZSBvYmplY3QsIHByb3h5aW5nIHVuaGFuZGxlZCBhdHRlbXB0cyB0byBgZ2V0YCBhbmQgYHNldGAgdG8gdGhlIHVuZGVybHlpbmcKICBjb250ZW50IG9iamVjdCwgYW5kIHRvIGZvcndhcmQgdW5oYW5kbGVkIGFjdGlvbiBhdHRlbXB0cyB0byBpdHMgYHRhcmdldGAuCgogIGBFbWJlci5PYmplY3RDb250cm9sbGVyYCBkZXJpdmVzIHRoaXMgZnVuY3Rpb25hbGl0eSBmcm9tIGl0cyBzdXBlcmNsYXNzCiAgYEVtYmVyLk9iamVjdFByb3h5YCBhbmQgdGhlIGBFbWJlci5Db250cm9sbGVyTWl4aW5gIG1peGluLgoKICBAY2xhc3MgT2JqZWN0Q29udHJvbGxlcgogIEBuYW1lc3BhY2UgRW1iZXIKICBAZXh0ZW5kcyBFbWJlci5PYmplY3RQcm94eQogIEB1c2VzIEVtYmVyLkNvbnRyb2xsZXJNaXhpbgoqKi8KRW1iZXIuT2JqZWN0Q29udHJvbGxlciA9IEVtYmVyLk9iamVjdFByb3h5LmV4dGVuZChFbWJlci5Db250cm9sbGVyTWl4aW4pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKRW1iZXIgUnVudGltZQoKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLXJ1bnRpbWUKQHJlcXVpcmVzIGVtYmVyLW1ldGFsCiovCgp9KSgpOwoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLXZpZXdzCiovCgp2YXIgalF1ZXJ5ID0gdGhpcy5qUXVlcnkgfHwgKEVtYmVyLmltcG9ydHMgJiYgRW1iZXIuaW1wb3J0cy5qUXVlcnkpOwppZiAoIWpRdWVyeSAmJiB0eXBlb2YgcmVxdWlyZSA9PT0gJ2Z1bmN0aW9uJykgewogIGpRdWVyeSA9IHJlcXVpcmUoJ2pxdWVyeScpOwp9CgpFbWJlci5hc3NlcnQoIkVtYmVyIFZpZXdzIHJlcXVpcmUgalF1ZXJ5IDEuNywgMS44LCAxLjksIDEuMTAsIG9yIDIuMCIsIGpRdWVyeSAmJiAoalF1ZXJ5KCkuanF1ZXJ5Lm1hdGNoKC9eKCgxXC4oN3w4fDl8MTApKXwyLjApKFwuXGQrKT8ocHJlfHJjXGQ/KT8vKSB8fCBFbWJlci5FTlYuRk9SQ0VfSlFVRVJZKSk7CgovKioKICBBbGlhcyBmb3IgalF1ZXJ5CgogIEBtZXRob2QgJAogIEBmb3IgRW1iZXIKKi8KRW1iZXIuJCA9IGpRdWVyeTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci12aWV3cwoqLwppZiAoRW1iZXIuJCkgewogIC8vIGh0dHA6Ly93d3cud2hhdHdnLm9yZy9zcGVjcy93ZWItYXBwcy9jdXJyZW50LXdvcmsvbXVsdGlwYWdlL2RuZC5odG1sI2RuZGV2ZW50cwogIHZhciBkcmFnRXZlbnRzID0gRW1iZXIuU3RyaW5nLncoJ2RyYWdzdGFydCBkcmFnIGRyYWdlbnRlciBkcmFnbGVhdmUgZHJhZ292ZXIgZHJvcCBkcmFnZW5kJyk7CgogIC8vIENvcGllcyB0aGUgYGRhdGFUcmFuc2ZlcmAgcHJvcGVydHkgZnJvbSBhIGJyb3dzZXIgZXZlbnQgb2JqZWN0IG9udG8gdGhlCiAgLy8galF1ZXJ5IGV2ZW50IG9iamVjdCBmb3IgdGhlIHNwZWNpZmllZCBldmVudHMKICBFbWJlci5FbnVtZXJhYmxlVXRpbHMuZm9yRWFjaChkcmFnRXZlbnRzLCBmdW5jdGlvbihldmVudE5hbWUpIHsKICAgIEVtYmVyLiQuZXZlbnQuZml4SG9va3NbZXZlbnROYW1lXSA9IHsgcHJvcHM6IFsnZGF0YVRyYW5zZmVyJ10gfTsKICB9KTsKfQoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLXZpZXdzCiovCgovKiBCRUdJTiBNRVRBTU9SUEggSEVMUEVSUyAqLwoKLy8gSW50ZXJuZXQgRXhwbG9yZXIgcHJpb3IgdG8gOSBkb2VzIG5vdCBhbGxvdyBzZXR0aW5nIGlubmVySFRNTCBpZiB0aGUgZmlyc3QgZWxlbWVudAovLyBpcyBhICJ6ZXJvLXNjb3BlIiBlbGVtZW50LiBUaGlzIHByb2JsZW0gY2FuIGJlIHdvcmtlZCBhcm91bmQgYnkgbWFraW5nCi8vIHRoZSBmaXJzdCBub2RlIGFuIGludmlzaWJsZSB0ZXh0IG5vZGUuIFdlLCBsaWtlIE1vZGVybml6ciwgdXNlICZzaHk7Cgp2YXIgbmVlZHNTaHkgPSB0aGlzLmRvY3VtZW50ICYmIChmdW5jdGlvbigpIHsKICB2YXIgdGVzdEVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgdGVzdEVsLmlubmVySFRNTCA9ICI8ZGl2PjwvZGl2PiI7CiAgdGVzdEVsLmZpcnN0Q2hpbGQuaW5uZXJIVE1MID0gIjxzY3JpcHQ+PC9zY3JpcHQ+IjsKICByZXR1cm4gdGVzdEVsLmZpcnN0Q2hpbGQuaW5uZXJIVE1MID09PSAnJzsKfSkoKTsKCi8vIElFIDggKGFuZCBsaWtlbHkgZWFybGllcikgbGlrZXMgdG8gbW92ZSB3aGl0ZXNwYWNlIHByZWNlZWRpbmcKLy8gYSBzY3JpcHQgdGFnIHRvIGFwcGVhciBhZnRlciBpdC4gVGhpcyBtZWFucyB0aGF0IHdlIGNhbgovLyBhY2NpZGVudGFsbHkgcmVtb3ZlIHdoaXRlc3BhY2Ugd2hlbiB1cGRhdGluZyBhIG1vcnBoLgp2YXIgbW92ZXNXaGl0ZXNwYWNlID0gdGhpcy5kb2N1bWVudCAmJiAoZnVuY3Rpb24oKSB7CiAgdmFyIHRlc3RFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogIHRlc3RFbC5pbm5lckhUTUwgPSAiVGVzdDogPHNjcmlwdCB0eXBlPSd0ZXh0L3gtcGxhY2Vob2xkZXInPjwvc2NyaXB0PlZhbHVlIjsKICByZXR1cm4gdGVzdEVsLmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAnVGVzdDonICYmCiAgICAgICAgICB0ZXN0RWwuY2hpbGROb2Rlc1syXS5ub2RlVmFsdWUgPT09ICcgVmFsdWUnOwp9KSgpOwoKLy8gVXNlIHRoaXMgdG8gZmluZCBjaGlsZHJlbiBieSBJRCBpbnN0ZWFkIG9mIHVzaW5nIGpRdWVyeQp2YXIgZmluZENoaWxkQnlJZCA9IGZ1bmN0aW9uKGVsZW1lbnQsIGlkKSB7CiAgaWYgKGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdpZCcpID09PSBpZCkgeyByZXR1cm4gZWxlbWVudDsgfQoKICB2YXIgbGVuID0gZWxlbWVudC5jaGlsZE5vZGVzLmxlbmd0aCwgaWR4LCBub2RlLCBmb3VuZDsKICBmb3IgKGlkeD0wOyBpZHg8bGVuOyBpZHgrKykgewogICAgbm9kZSA9IGVsZW1lbnQuY2hpbGROb2Rlc1tpZHhdOwogICAgZm91bmQgPSBub2RlLm5vZGVUeXBlID09PSAxICYmIGZpbmRDaGlsZEJ5SWQobm9kZSwgaWQpOwogICAgaWYgKGZvdW5kKSB7IHJldHVybiBmb3VuZDsgfQogIH0KfTsKCnZhciBzZXRJbm5lckhUTUxXaXRob3V0Rml4ID0gZnVuY3Rpb24oZWxlbWVudCwgaHRtbCkgewogIGlmIChuZWVkc1NoeSkgewogICAgaHRtbCA9ICcmc2h5OycgKyBodG1sOwogIH0KCiAgdmFyIG1hdGNoZXMgPSBbXTsKICBpZiAobW92ZXNXaGl0ZXNwYWNlKSB7CiAgICAvLyBSaWdodCBub3cgd2Ugb25seSBjaGVjayBmb3Igc2NyaXB0IHRhZ3Mgd2l0aCBpZHMgd2l0aCB0aGUKICAgIC8vIGdvYWwgb2YgdGFyZ2V0aW5nIG1vcnBocy4KICAgIGh0bWwgPSBodG1sLnJlcGxhY2UoLyhccyspKDxzY3JpcHQgaWQ9JyhbXiddKyknKS9nLCBmdW5jdGlvbihtYXRjaCwgc3BhY2VzLCB0YWcsIGlkKSB7CiAgICAgIG1hdGNoZXMucHVzaChbaWQsIHNwYWNlc10pOwogICAgICByZXR1cm4gdGFnOwogICAgfSk7CiAgfQoKICBlbGVtZW50LmlubmVySFRNTCA9IGh0bWw7CgogIC8vIElmIHdlIGhhdmUgdG8gZG8gYW55IHdoaXRlc3BhY2UgYWRqdXN0bWVudHMgZG8gdGhlbSBub3cKICBpZiAobWF0Y2hlcy5sZW5ndGggPiAwKSB7CiAgICB2YXIgbGVuID0gbWF0Y2hlcy5sZW5ndGgsIGlkeDsKICAgIGZvciAoaWR4PTA7IGlkeDxsZW47IGlkeCsrKSB7CiAgICAgIHZhciBzY3JpcHQgPSBmaW5kQ2hpbGRCeUlkKGVsZW1lbnQsIG1hdGNoZXNbaWR4XVswXSksCiAgICAgICAgICBub2RlID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUobWF0Y2hlc1tpZHhdWzFdKTsKICAgICAgc2NyaXB0LnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKG5vZGUsIHNjcmlwdCk7CiAgICB9CiAgfQoKICBpZiAobmVlZHNTaHkpIHsKICAgIHZhciBzaHlFbGVtZW50ID0gZWxlbWVudC5maXJzdENoaWxkOwogICAgd2hpbGUgKHNoeUVsZW1lbnQubm9kZVR5cGUgPT09IDEgJiYgIXNoeUVsZW1lbnQubm9kZU5hbWUpIHsKICAgICAgc2h5RWxlbWVudCA9IHNoeUVsZW1lbnQuZmlyc3RDaGlsZDsKICAgIH0KICAgIGlmIChzaHlFbGVtZW50Lm5vZGVUeXBlID09PSAzICYmIHNoeUVsZW1lbnQubm9kZVZhbHVlLmNoYXJBdCgwKSA9PT0gIlx1MDBBRCIpIHsKICAgICAgc2h5RWxlbWVudC5ub2RlVmFsdWUgPSBzaHlFbGVtZW50Lm5vZGVWYWx1ZS5zbGljZSgxKTsKICAgIH0KICB9Cn07CgovKiBFTkQgTUVUQU1PUlBIIEhFTFBFUlMgKi8KCgp2YXIgaW5uZXJIVE1MVGFncyA9IHt9Owp2YXIgY2FuU2V0SW5uZXJIVE1MID0gZnVuY3Rpb24odGFnTmFtZSkgewogIGlmIChpbm5lckhUTUxUYWdzW3RhZ05hbWVdICE9PSB1bmRlZmluZWQpIHsKICAgIHJldHVybiBpbm5lckhUTUxUYWdzW3RhZ05hbWVdOwogIH0KCiAgdmFyIGNhblNldCA9IHRydWU7CgogIC8vIElFIDggYW5kIGVhcmxpZXIgZG9uJ3QgYWxsb3cgdXMgdG8gZG8gaW5uZXJIVE1MIG9uIHNlbGVjdAogIGlmICh0YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdzZWxlY3QnKSB7CiAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzZWxlY3QnKTsKICAgIHNldElubmVySFRNTFdpdGhvdXRGaXgoZWwsICc8b3B0aW9uIHZhbHVlPSJ0ZXN0Ij5UZXN0PC9vcHRpb24+Jyk7CiAgICBjYW5TZXQgPSBlbC5vcHRpb25zLmxlbmd0aCA9PT0gMTsKICB9CgogIGlubmVySFRNTFRhZ3NbdGFnTmFtZV0gPSBjYW5TZXQ7CgogIHJldHVybiBjYW5TZXQ7Cn07Cgp2YXIgc2V0SW5uZXJIVE1MID0gZnVuY3Rpb24oZWxlbWVudCwgaHRtbCkgewogIHZhciB0YWdOYW1lID0gZWxlbWVudC50YWdOYW1lOwoKICBpZiAoY2FuU2V0SW5uZXJIVE1MKHRhZ05hbWUpKSB7CiAgICBzZXRJbm5lckhUTUxXaXRob3V0Rml4KGVsZW1lbnQsIGh0bWwpOwogIH0gZWxzZSB7CiAgICAvLyBGaXJlZm94IHZlcnNpb25zIDwgMTEgZG8gbm90IGhhdmUgc3VwcG9ydCBmb3IgZWxlbWVudC5vdXRlckhUTUwuCiAgICB2YXIgb3V0ZXJIVE1MID0gZWxlbWVudC5vdXRlckhUTUwgfHwgbmV3IFhNTFNlcmlhbGl6ZXIoKS5zZXJpYWxpemVUb1N0cmluZyhlbGVtZW50KTsKICAgIEVtYmVyLmFzc2VydCgiQ2FuJ3Qgc2V0IGlubmVySFRNTCBvbiAiK2VsZW1lbnQudGFnTmFtZSsiIGluIHRoaXMgYnJvd3NlciIsIG91dGVySFRNTCk7CgogICAgdmFyIHN0YXJ0VGFnID0gb3V0ZXJIVE1MLm1hdGNoKG5ldyBSZWdFeHAoIjwiK3RhZ05hbWUrIihbXj5dKik+IiwgJ2knKSlbMF0sCiAgICAgICAgZW5kVGFnID0gJzwvJyt0YWdOYW1lKyc+JzsKCiAgICB2YXIgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgc2V0SW5uZXJIVE1MV2l0aG91dEZpeCh3cmFwcGVyLCBzdGFydFRhZyArIGh0bWwgKyBlbmRUYWcpOwogICAgZWxlbWVudCA9IHdyYXBwZXIuZmlyc3RDaGlsZDsKICAgIHdoaWxlIChlbGVtZW50LnRhZ05hbWUgIT09IHRhZ05hbWUpIHsKICAgICAgZWxlbWVudCA9IGVsZW1lbnQubmV4dFNpYmxpbmc7CiAgICB9CiAgfQoKICByZXR1cm4gZWxlbWVudDsKfTsKCmZ1bmN0aW9uIGlzU2ltcGxlQ2xpY2soZXZlbnQpIHsKICB2YXIgbW9kaWZpZXIgPSBldmVudC5zaGlmdEtleSB8fCBldmVudC5tZXRhS2V5IHx8IGV2ZW50LmFsdEtleSB8fCBldmVudC5jdHJsS2V5LAogICAgICBzZWNvbmRhcnlDbGljayA9IGV2ZW50LndoaWNoID4gMTsgLy8gSUU5IG1heSByZXR1cm4gdW5kZWZpbmVkCgogIHJldHVybiAhbW9kaWZpZXIgJiYgIXNlY29uZGFyeUNsaWNrOwp9CgpFbWJlci5WaWV3VXRpbHMgPSB7CiAgc2V0SW5uZXJIVE1MOiBzZXRJbm5lckhUTUwsCiAgaXNTaW1wbGVDbGljazogaXNTaW1wbGVDbGljawp9OwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLXZpZXdzCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQ7Cgp2YXIgQ2xhc3NTZXQgPSBmdW5jdGlvbigpIHsKICB0aGlzLnNlZW4gPSB7fTsKICB0aGlzLmxpc3QgPSBbXTsKfTsKCkNsYXNzU2V0LnByb3RvdHlwZSA9IHsKICBhZGQ6IGZ1bmN0aW9uKHN0cmluZykgewogICAgaWYgKHN0cmluZyBpbiB0aGlzLnNlZW4pIHsgcmV0dXJuOyB9CiAgICB0aGlzLnNlZW5bc3RyaW5nXSA9IHRydWU7CgogICAgdGhpcy5saXN0LnB1c2goc3RyaW5nKTsKICB9LAoKICB0b0RPTTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5saXN0LmpvaW4oIiAiKTsKICB9Cn07Cgp2YXIgQkFEX1RBR19OQU1FX1RFU1RfUkVHRVhQID0gL1teYS16QS1aMC05XC1dLzsKdmFyIEJBRF9UQUdfTkFNRV9SRVBMQUNFX1JFR0VYUCA9IC9bXmEtekEtWjAtOVwtXS9nOwoKZnVuY3Rpb24gc3RyaXBUYWdOYW1lKHRhZ05hbWUpIHsKICBpZiAoIXRhZ05hbWUpIHsKICAgIHJldHVybiB0YWdOYW1lOwogIH0KCiAgaWYgKCFCQURfVEFHX05BTUVfVEVTVF9SRUdFWFAudGVzdCh0YWdOYW1lKSkgewogICAgcmV0dXJuIHRhZ05hbWU7CiAgfQoKICByZXR1cm4gdGFnTmFtZS5yZXBsYWNlKEJBRF9UQUdfTkFNRV9SRVBMQUNFX1JFR0VYUCwgJycpOwp9Cgp2YXIgQkFEX0NIQVJTX1JFR0VYUCA9IC8mKD8hXHcrOyl8Wzw+IidgXS9nOwp2YXIgUE9TU0lCTEVfQ0hBUlNfUkVHRVhQID0gL1smPD4iJ2BdLzsKCmZ1bmN0aW9uIGVzY2FwZUF0dHJpYnV0ZSh2YWx1ZSkgewogIC8vIFN0b2xlbiBzaGFtZWxlc3NseSBmcm9tIEhhbmRsZWJhcnMKCiAgdmFyIGVzY2FwZSA9IHsKICAgICI8IjogIiZsdDsiLAogICAgIj4iOiAiJmd0OyIsCiAgICAnIic6ICImcXVvdDsiLAogICAgIiciOiAiJiN4Mjc7IiwKICAgICJgIjogIiYjeDYwOyIKICB9OwoKICB2YXIgZXNjYXBlQ2hhciA9IGZ1bmN0aW9uKGNocikgewogICAgcmV0dXJuIGVzY2FwZVtjaHJdIHx8ICImYW1wOyI7CiAgfTsKCiAgdmFyIHN0cmluZyA9IHZhbHVlLnRvU3RyaW5nKCk7CgogIGlmKCFQT1NTSUJMRV9DSEFSU19SRUdFWFAudGVzdChzdHJpbmcpKSB7IHJldHVybiBzdHJpbmc7IH0KICByZXR1cm4gc3RyaW5nLnJlcGxhY2UoQkFEX0NIQVJTX1JFR0VYUCwgZXNjYXBlQ2hhcik7Cn0KCi8vIElFIDYvNyBoYXZlIGJ1Z3MgYXJvbmQgc2V0dGluZyBuYW1lcyBvbiBpbnB1dHMgZHVyaW5nIGNyZWF0aW9uLgovLyBGcm9tIGh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9pZS9tczUzNjM4OSh2PXZzLjg1KS5hc3B4OgovLyAiVG8gaW5jbHVkZSB0aGUgTkFNRSBhdHRyaWJ1dGUgYXQgcnVuIHRpbWUgb24gb2JqZWN0cyBjcmVhdGVkIHdpdGggdGhlIGNyZWF0ZUVsZW1lbnQgbWV0aG9kLCB1c2UgdGhlIGVUYWcuIgp2YXIgY2FuU2V0TmFtZU9uSW5wdXRzID0gKGZ1bmN0aW9uKCkgewogIHZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwKICAgICAgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpOwoKICBlbC5zZXRBdHRyaWJ1dGUoJ25hbWUnLCAnZm9vJyk7CiAgZGl2LmFwcGVuZENoaWxkKGVsKTsKCiAgcmV0dXJuICEhZGl2LmlubmVySFRNTC5tYXRjaCgnZm9vJyk7Cn0pKCk7CgovKioKICBgRW1iZXIuUmVuZGVyQnVmZmVyYCBnYXRoZXJzIGluZm9ybWF0aW9uIHJlZ2FyZGluZyB0aGUgYSB2aWV3IGFuZCBnZW5lcmF0ZXMgdGhlCiAgZmluYWwgcmVwcmVzZW50YXRpb24uIGBFbWJlci5SZW5kZXJCdWZmZXJgIHdpbGwgZ2VuZXJhdGUgSFRNTCB3aGljaCBjYW4gYmUgcHVzaGVkCiAgdG8gdGhlIERPTS4KCiAgIGBgYGphdmFzY3JpcHQKICAgdmFyIGJ1ZmZlciA9IEVtYmVyLlJlbmRlckJ1ZmZlcignZGl2Jyk7CiAgYGBgCgogIEBjbGFzcyBSZW5kZXJCdWZmZXIKICBAbmFtZXNwYWNlIEVtYmVyCiAgQGNvbnN0cnVjdG9yCiAgQHBhcmFtIHtTdHJpbmd9IHRhZ05hbWUgdGFnIG5hbWUgKHN1Y2ggYXMgJ2Rpdicgb3IgJ3AnKSB1c2VkIGZvciB0aGUgYnVmZmVyCiovCkVtYmVyLlJlbmRlckJ1ZmZlciA9IGZ1bmN0aW9uKHRhZ05hbWUpIHsKICByZXR1cm4gbmV3IEVtYmVyLl9SZW5kZXJCdWZmZXIodGFnTmFtZSk7Cn07CgpFbWJlci5fUmVuZGVyQnVmZmVyID0gZnVuY3Rpb24odGFnTmFtZSkgewogIHRoaXMudGFnTmFtZXMgPSBbdGFnTmFtZSB8fCBudWxsXTsKICB0aGlzLmJ1ZmZlciA9ICIiOwp9OwoKRW1iZXIuX1JlbmRlckJ1ZmZlci5wcm90b3R5cGUgPSB7CgogIC8vIFRoZSByb290IHZpZXcncyBlbGVtZW50CiAgX2VsZW1lbnQ6IG51bGwsCgogIF9oYXNFbGVtZW50OiB0cnVlLAoKICAvKioKICAgIEFuIGludGVybmFsIHNldCB1c2VkIHRvIGRlLWR1cGUgY2xhc3MgbmFtZXMgd2hlbiBgYWRkQ2xhc3MoKWAgaXMKICAgIHVzZWQuIEFmdGVyIGVhY2ggY2FsbCB0byBgYWRkQ2xhc3MoKWAsIHRoZSBgY2xhc3Nlc2AgcHJvcGVydHkKICAgIHdpbGwgYmUgdXBkYXRlZC4KCiAgICBAcHJpdmF0ZQogICAgQHByb3BlcnR5IGVsZW1lbnRDbGFzc2VzCiAgICBAdHlwZSBBcnJheQogICAgQGRlZmF1bHQgW10KICAqLwogIGVsZW1lbnRDbGFzc2VzOiBudWxsLAoKICAvKioKICAgIEFycmF5IG9mIGNsYXNzIG5hbWVzIHdoaWNoIHdpbGwgYmUgYXBwbGllZCBpbiB0aGUgY2xhc3MgYXR0cmlidXRlLgoKICAgIFlvdSBjYW4gdXNlIGBzZXRDbGFzc2VzKClgIHRvIHNldCB0aGlzIHByb3BlcnR5IGRpcmVjdGx5LiBJZiB5b3UKICAgIHVzZSBgYWRkQ2xhc3MoKWAsIGl0IHdpbGwgYmUgbWFpbnRhaW5lZCBmb3IgeW91LgoKICAgIEBwcm9wZXJ0eSBjbGFzc2VzCiAgICBAdHlwZSBBcnJheQogICAgQGRlZmF1bHQgW10KICAqLwogIGNsYXNzZXM6IG51bGwsCgogIC8qKgogICAgVGhlIGlkIGluIG9mIHRoZSBlbGVtZW50LCB0byBiZSBhcHBsaWVkIGluIHRoZSBpZCBhdHRyaWJ1dGUuCgogICAgWW91IHNob3VsZCBub3Qgc2V0IHRoaXMgcHJvcGVydHkgeW91cnNlbGYsIHJhdGhlciwgeW91IHNob3VsZCB1c2UKICAgIHRoZSBgaWQoKWAgbWV0aG9kIG9mIGBFbWJlci5SZW5kZXJCdWZmZXJgLgoKICAgIEBwcm9wZXJ0eSBlbGVtZW50SWQKICAgIEB0eXBlIFN0cmluZwogICAgQGRlZmF1bHQgbnVsbAogICovCiAgZWxlbWVudElkOiBudWxsLAoKICAvKioKICAgIEEgaGFzaCBrZXllZCBvbiB0aGUgbmFtZSBvZiB0aGUgYXR0cmlidXRlIGFuZCB3aG9zZSB2YWx1ZSB3aWxsIGJlCiAgICBhcHBsaWVkIHRvIHRoYXQgYXR0cmlidXRlLiBGb3IgZXhhbXBsZSwgaWYgeW91IHdhbnRlZCB0byBhcHBseSBhCiAgICBgZGF0YS12aWV3PSJGb28uYmFyImAgcHJvcGVydHkgdG8gYW4gZWxlbWVudCwgeW91IHdvdWxkIHNldCB0aGUKICAgIGVsZW1lbnRBdHRyaWJ1dGVzIGhhc2ggdG8gYHsnZGF0YS12aWV3JzonRm9vLmJhcid9YC4KCiAgICBZb3Ugc2hvdWxkIG5vdCBtYWludGFpbiB0aGlzIGhhc2ggeW91cnNlbGYsIHJhdGhlciwgeW91IHNob3VsZCB1c2UKICAgIHRoZSBgYXR0cigpYCBtZXRob2Qgb2YgYEVtYmVyLlJlbmRlckJ1ZmZlcmAuCgogICAgQHByb3BlcnR5IGVsZW1lbnRBdHRyaWJ1dGVzCiAgICBAdHlwZSBIYXNoCiAgICBAZGVmYXVsdCB7fQogICovCiAgZWxlbWVudEF0dHJpYnV0ZXM6IG51bGwsCgogIC8qKgogICAgQSBoYXNoIGtleWVkIG9uIHRoZSBuYW1lIG9mIHRoZSBwcm9wZXJ0aWVzIGFuZCB3aG9zZSB2YWx1ZSB3aWxsIGJlCiAgICBhcHBsaWVkIHRvIHRoYXQgcHJvcGVydHkuIEZvciBleGFtcGxlLCBpZiB5b3Ugd2FudGVkIHRvIGFwcGx5IGEKICAgIGBjaGVja2VkPXRydWVgIHByb3BlcnR5IHRvIGFuIGVsZW1lbnQsIHlvdSB3b3VsZCBzZXQgdGhlCiAgICBlbGVtZW50UHJvcGVydGllcyBoYXNoIHRvIGB7J2NoZWNrZWQnOnRydWV9YC4KCiAgICBZb3Ugc2hvdWxkIG5vdCBtYWludGFpbiB0aGlzIGhhc2ggeW91cnNlbGYsIHJhdGhlciwgeW91IHNob3VsZCB1c2UKICAgIHRoZSBgcHJvcCgpYCBtZXRob2Qgb2YgYEVtYmVyLlJlbmRlckJ1ZmZlcmAuCgogICAgQHByb3BlcnR5IGVsZW1lbnRQcm9wZXJ0aWVzCiAgICBAdHlwZSBIYXNoCiAgICBAZGVmYXVsdCB7fQogICovCiAgZWxlbWVudFByb3BlcnRpZXM6IG51bGwsCgogIC8qKgogICAgVGhlIHRhZ25hbWUgb2YgdGhlIGVsZW1lbnQgYW4gaW5zdGFuY2Ugb2YgYEVtYmVyLlJlbmRlckJ1ZmZlcmAgcmVwcmVzZW50cy4KCiAgICBVc3VhbGx5LCB0aGlzIGdldHMgc2V0IGFzIHRoZSBmaXJzdCBwYXJhbWV0ZXIgdG8gYEVtYmVyLlJlbmRlckJ1ZmZlcmAuIEZvcgogICAgZXhhbXBsZSwgaWYgeW91IHdhbnRlZCB0byBjcmVhdGUgYSBgcGAgdGFnLCB0aGVuIHlvdSB3b3VsZCBjYWxsCgogICAgYGBgamF2YXNjcmlwdAogICAgRW1iZXIuUmVuZGVyQnVmZmVyKCdwJykKICAgIGBgYAoKICAgIEBwcm9wZXJ0eSBlbGVtZW50VGFnCiAgICBAdHlwZSBTdHJpbmcKICAgIEBkZWZhdWx0IG51bGwKICAqLwogIGVsZW1lbnRUYWc6IG51bGwsCgogIC8qKgogICAgQSBoYXNoIGtleWVkIG9uIHRoZSBuYW1lIG9mIHRoZSBzdHlsZSBhdHRyaWJ1dGUgYW5kIHdob3NlIHZhbHVlIHdpbGwKICAgIGJlIGFwcGxpZWQgdG8gdGhhdCBhdHRyaWJ1dGUuIEZvciBleGFtcGxlLCBpZiB5b3Ugd2FudGVkIHRvIGFwcGx5IGEKICAgIGBiYWNrZ3JvdW5kLWNvbG9yOmJsYWNrO2Agc3R5bGUgdG8gYW4gZWxlbWVudCwgeW91IHdvdWxkIHNldCB0aGUKICAgIGVsZW1lbnRTdHlsZSBoYXNoIHRvIGB7J2JhY2tncm91bmQtY29sb3InOidibGFjayd9YC4KCiAgICBZb3Ugc2hvdWxkIG5vdCBtYWludGFpbiB0aGlzIGhhc2ggeW91cnNlbGYsIHJhdGhlciwgeW91IHNob3VsZCB1c2UKICAgIHRoZSBgc3R5bGUoKWAgbWV0aG9kIG9mIGBFbWJlci5SZW5kZXJCdWZmZXJgLgoKICAgIEBwcm9wZXJ0eSBlbGVtZW50U3R5bGUKICAgIEB0eXBlIEhhc2gKICAgIEBkZWZhdWx0IHt9CiAgKi8KICBlbGVtZW50U3R5bGU6IG51bGwsCgogIC8qKgogICAgTmVzdGVkIGBSZW5kZXJCdWZmZXJzYCB3aWxsIHNldCB0aGlzIHRvIHRoZWlyIHBhcmVudCBgUmVuZGVyQnVmZmVyYAogICAgaW5zdGFuY2UuCgogICAgQHByb3BlcnR5IHBhcmVudEJ1ZmZlcgogICAgQHR5cGUgRW1iZXIuX1JlbmRlckJ1ZmZlcgogICovCiAgcGFyZW50QnVmZmVyOiBudWxsLAoKICAvKioKICAgIEFkZHMgYSBzdHJpbmcgb2YgSFRNTCB0byB0aGUgYFJlbmRlckJ1ZmZlcmAuCgogICAgQG1ldGhvZCBwdXNoCiAgICBAcGFyYW0ge1N0cmluZ30gc3RyaW5nIEhUTUwgdG8gcHVzaCBpbnRvIHRoZSBidWZmZXIKICAgIEBjaGFpbmFibGUKICAqLwogIHB1c2g6IGZ1bmN0aW9uKHN0cmluZykgewogICAgdGhpcy5idWZmZXIgKz0gc3RyaW5nOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICBBZGRzIGEgY2xhc3MgdG8gdGhlIGJ1ZmZlciwgd2hpY2ggd2lsbCBiZSByZW5kZXJlZCB0byB0aGUgY2xhc3MgYXR0cmlidXRlLgoKICAgIEBtZXRob2QgYWRkQ2xhc3MKICAgIEBwYXJhbSB7U3RyaW5nfSBjbGFzc05hbWUgQ2xhc3MgbmFtZSB0byBhZGQgdG8gdGhlIGJ1ZmZlcgogICAgQGNoYWluYWJsZQogICovCiAgYWRkQ2xhc3M6IGZ1bmN0aW9uKGNsYXNzTmFtZSkgewogICAgLy8gbGF6aWx5IGNyZWF0ZSBlbGVtZW50Q2xhc3NlcwogICAgdGhpcy5lbGVtZW50Q2xhc3NlcyA9ICh0aGlzLmVsZW1lbnRDbGFzc2VzIHx8IG5ldyBDbGFzc1NldCgpKTsKICAgIHRoaXMuZWxlbWVudENsYXNzZXMuYWRkKGNsYXNzTmFtZSk7CiAgICB0aGlzLmNsYXNzZXMgPSB0aGlzLmVsZW1lbnRDbGFzc2VzLmxpc3Q7CgogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgc2V0Q2xhc3NlczogZnVuY3Rpb24oY2xhc3NOYW1lcykgewogICAgdGhpcy5jbGFzc2VzID0gY2xhc3NOYW1lczsKICB9LAoKICAvKioKICAgIFNldHMgdGhlIGVsZW1lbnRJRCB0byBiZSB1c2VkIGZvciB0aGUgZWxlbWVudC4KCiAgICBAbWV0aG9kIGlkCiAgICBAcGFyYW0ge1N0cmluZ30gaWQKICAgIEBjaGFpbmFibGUKICAqLwogIGlkOiBmdW5jdGlvbihpZCkgewogICAgdGhpcy5lbGVtZW50SWQgPSBpZDsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8vIGR1Y2sgdHlwZSBhdHRyaWJ1dGUgZnVuY3Rpb25hbGl0eSBsaWtlIGpRdWVyeSBzbyBhIHJlbmRlciBidWZmZXIKICAvLyBjYW4gYmUgdXNlZCBsaWtlIGEgalF1ZXJ5IG9iamVjdCBpbiBhdHRyaWJ1dGUgYmluZGluZyBzY2VuYXJpb3MuCgogIC8qKgogICAgQWRkcyBhbiBhdHRyaWJ1dGUgd2hpY2ggd2lsbCBiZSByZW5kZXJlZCB0byB0aGUgZWxlbWVudC4KCiAgICBAbWV0aG9kIGF0dHIKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBhdHRyaWJ1dGUKICAgIEBwYXJhbSB7U3RyaW5nfSB2YWx1ZSBUaGUgdmFsdWUgdG8gYWRkIHRvIHRoZSBhdHRyaWJ1dGUKICAgIEBjaGFpbmFibGUKICAgIEByZXR1cm4ge0VtYmVyLlJlbmRlckJ1ZmZlcnxTdHJpbmd9IHRoaXMgb3IgdGhlIGN1cnJlbnQgYXR0cmlidXRlIHZhbHVlCiAgKi8KICBhdHRyOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgdmFyIGF0dHJpYnV0ZXMgPSB0aGlzLmVsZW1lbnRBdHRyaWJ1dGVzID0gKHRoaXMuZWxlbWVudEF0dHJpYnV0ZXMgfHwge30pOwoKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICAgIHJldHVybiBhdHRyaWJ1dGVzW25hbWVdOwogICAgfSBlbHNlIHsKICAgICAgYXR0cmlidXRlc1tuYW1lXSA9IHZhbHVlOwogICAgfQoKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAgUmVtb3ZlIGFuIGF0dHJpYnV0ZSBmcm9tIHRoZSBsaXN0IG9mIGF0dHJpYnV0ZXMgdG8gcmVuZGVyLgoKICAgIEBtZXRob2QgcmVtb3ZlQXR0cgogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGF0dHJpYnV0ZQogICAgQGNoYWluYWJsZQogICovCiAgcmVtb3ZlQXR0cjogZnVuY3Rpb24obmFtZSkgewogICAgdmFyIGF0dHJpYnV0ZXMgPSB0aGlzLmVsZW1lbnRBdHRyaWJ1dGVzOwogICAgaWYgKGF0dHJpYnV0ZXMpIHsgZGVsZXRlIGF0dHJpYnV0ZXNbbmFtZV07IH0KCiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvKioKICAgIEFkZHMgYW4gcHJvcGVydHkgd2hpY2ggd2lsbCBiZSByZW5kZXJlZCB0byB0aGUgZWxlbWVudC4KCiAgICBAbWV0aG9kIHByb3AKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBwcm9wZXJ0eQogICAgQHBhcmFtIHtTdHJpbmd9IHZhbHVlIFRoZSB2YWx1ZSB0byBhZGQgdG8gdGhlIHByb3BlcnR5CiAgICBAY2hhaW5hYmxlCiAgICBAcmV0dXJuIHtFbWJlci5SZW5kZXJCdWZmZXJ8U3RyaW5nfSB0aGlzIG9yIHRoZSBjdXJyZW50IHByb3BlcnR5IHZhbHVlCiAgKi8KICBwcm9wOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgdmFyIHByb3BlcnRpZXMgPSB0aGlzLmVsZW1lbnRQcm9wZXJ0aWVzID0gKHRoaXMuZWxlbWVudFByb3BlcnRpZXMgfHwge30pOwoKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICAgIHJldHVybiBwcm9wZXJ0aWVzW25hbWVdOwogICAgfSBlbHNlIHsKICAgICAgcHJvcGVydGllc1tuYW1lXSA9IHZhbHVlOwogICAgfQoKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAgUmVtb3ZlIGFuIHByb3BlcnR5IGZyb20gdGhlIGxpc3Qgb2YgcHJvcGVydGllcyB0byByZW5kZXIuCgogICAgQG1ldGhvZCByZW1vdmVQcm9wCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgcHJvcGVydHkKICAgIEBjaGFpbmFibGUKICAqLwogIHJlbW92ZVByb3A6IGZ1bmN0aW9uKG5hbWUpIHsKICAgIHZhciBwcm9wZXJ0aWVzID0gdGhpcy5lbGVtZW50UHJvcGVydGllczsKICAgIGlmIChwcm9wZXJ0aWVzKSB7IGRlbGV0ZSBwcm9wZXJ0aWVzW25hbWVdOyB9CgogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICBBZGRzIGEgc3R5bGUgdG8gdGhlIHN0eWxlIGF0dHJpYnV0ZSB3aGljaCB3aWxsIGJlIHJlbmRlcmVkIHRvIHRoZSBlbGVtZW50LgoKICAgIEBtZXRob2Qgc3R5bGUKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIHN0eWxlCiAgICBAcGFyYW0ge1N0cmluZ30gdmFsdWUKICAgIEBjaGFpbmFibGUKICAqLwogIHN0eWxlOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgdGhpcy5lbGVtZW50U3R5bGUgPSAodGhpcy5lbGVtZW50U3R5bGUgfHwge30pOwoKICAgIHRoaXMuZWxlbWVudFN0eWxlW25hbWVdID0gdmFsdWU7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICBiZWdpbjogZnVuY3Rpb24odGFnTmFtZSkgewogICAgdGhpcy50YWdOYW1lcy5wdXNoKHRhZ05hbWUgfHwgbnVsbCk7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICBwdXNoT3BlbmluZ1RhZzogZnVuY3Rpb24oKSB7CiAgICB2YXIgdGFnTmFtZSA9IHRoaXMuY3VycmVudFRhZ05hbWUoKTsKICAgIGlmICghdGFnTmFtZSkgeyByZXR1cm47IH0KCiAgICBpZiAodGhpcy5faGFzRWxlbWVudCAmJiAhdGhpcy5fZWxlbWVudCAmJiB0aGlzLmJ1ZmZlci5sZW5ndGggPT09IDApIHsKICAgICAgdGhpcy5fZWxlbWVudCA9IHRoaXMuZ2VuZXJhdGVFbGVtZW50KCk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgYnVmZmVyID0gdGhpcy5idWZmZXIsCiAgICAgICAgaWQgPSB0aGlzLmVsZW1lbnRJZCwKICAgICAgICBjbGFzc2VzID0gdGhpcy5jbGFzc2VzLAogICAgICAgIGF0dHJzID0gdGhpcy5lbGVtZW50QXR0cmlidXRlcywKICAgICAgICBwcm9wcyA9IHRoaXMuZWxlbWVudFByb3BlcnRpZXMsCiAgICAgICAgc3R5bGUgPSB0aGlzLmVsZW1lbnRTdHlsZSwKICAgICAgICBhdHRyLCBwcm9wOwoKICAgIGJ1ZmZlciArPSAnPCcgKyBzdHJpcFRhZ05hbWUodGFnTmFtZSk7CgogICAgaWYgKGlkKSB7CiAgICAgIGJ1ZmZlciArPSAnIGlkPSInICsgZXNjYXBlQXR0cmlidXRlKGlkKSArICciJzsKICAgICAgdGhpcy5lbGVtZW50SWQgPSBudWxsOwogICAgfQogICAgaWYgKGNsYXNzZXMpIHsKICAgICAgYnVmZmVyICs9ICcgY2xhc3M9IicgKyBlc2NhcGVBdHRyaWJ1dGUoY2xhc3Nlcy5qb2luKCcgJykpICsgJyInOwogICAgICB0aGlzLmNsYXNzZXMgPSBudWxsOwogICAgfQoKICAgIGlmIChzdHlsZSkgewogICAgICBidWZmZXIgKz0gJyBzdHlsZT0iJzsKCiAgICAgIGZvciAocHJvcCBpbiBzdHlsZSkgewogICAgICAgIGlmIChzdHlsZS5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgewogICAgICAgICAgYnVmZmVyICs9IHByb3AgKyAnOicgKyBlc2NhcGVBdHRyaWJ1dGUoc3R5bGVbcHJvcF0pICsgJzsnOwogICAgICAgIH0KICAgICAgfQoKICAgICAgYnVmZmVyICs9ICciJzsKCiAgICAgIHRoaXMuZWxlbWVudFN0eWxlID0gbnVsbDsKICAgIH0KCiAgICBpZiAoYXR0cnMpIHsKICAgICAgZm9yIChhdHRyIGluIGF0dHJzKSB7CiAgICAgICAgaWYgKGF0dHJzLmhhc093blByb3BlcnR5KGF0dHIpKSB7CiAgICAgICAgICBidWZmZXIgKz0gJyAnICsgYXR0ciArICc9IicgKyBlc2NhcGVBdHRyaWJ1dGUoYXR0cnNbYXR0cl0pICsgJyInOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy5lbGVtZW50QXR0cmlidXRlcyA9IG51bGw7CiAgICB9CgogICAgaWYgKHByb3BzKSB7CiAgICAgIGZvciAocHJvcCBpbiBwcm9wcykgewogICAgICAgIGlmIChwcm9wcy5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgewogICAgICAgICAgdmFyIHZhbHVlID0gcHJvcHNbcHJvcF07CiAgICAgICAgICBpZiAodmFsdWUgfHwgdHlwZW9mKHZhbHVlKSA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgaWYgKHZhbHVlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgYnVmZmVyICs9ICcgJyArIHByb3AgKyAnPSInICsgcHJvcCArICciJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBidWZmZXIgKz0gJyAnICsgcHJvcCArICc9IicgKyBlc2NhcGVBdHRyaWJ1dGUocHJvcHNbcHJvcF0pICsgJyInOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLmVsZW1lbnRQcm9wZXJ0aWVzID0gbnVsbDsKICAgIH0KCiAgICBidWZmZXIgKz0gJz4nOwogICAgdGhpcy5idWZmZXIgPSBidWZmZXI7CiAgfSwKCiAgcHVzaENsb3NpbmdUYWc6IGZ1bmN0aW9uKCkgewogICAgdmFyIHRhZ05hbWUgPSB0aGlzLnRhZ05hbWVzLnBvcCgpOwogICAgaWYgKHRhZ05hbWUpIHsgdGhpcy5idWZmZXIgKz0gJzwvJyArIHN0cmlwVGFnTmFtZSh0YWdOYW1lKSArICc+JzsgfQogIH0sCgogIGN1cnJlbnRUYWdOYW1lOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLnRhZ05hbWVzW3RoaXMudGFnTmFtZXMubGVuZ3RoLTFdOwogIH0sCgogIGdlbmVyYXRlRWxlbWVudDogZnVuY3Rpb24oKSB7CiAgICB2YXIgdGFnTmFtZSA9IHRoaXMudGFnTmFtZXMucG9wKCksIC8vIHBvcCBzaW5jZSB3ZSBkb24ndCBuZWVkIHRvIGNsb3NlCiAgICAgICAgaWQgPSB0aGlzLmVsZW1lbnRJZCwKICAgICAgICBjbGFzc2VzID0gdGhpcy5jbGFzc2VzLAogICAgICAgIGF0dHJzID0gdGhpcy5lbGVtZW50QXR0cmlidXRlcywKICAgICAgICBwcm9wcyA9IHRoaXMuZWxlbWVudFByb3BlcnRpZXMsCiAgICAgICAgc3R5bGUgPSB0aGlzLmVsZW1lbnRTdHlsZSwKICAgICAgICBzdHlsZUJ1ZmZlciA9ICcnLCBhdHRyLCBwcm9wLCB0YWdTdHJpbmc7CgogICAgaWYgKGF0dHJzICYmIGF0dHJzLm5hbWUgJiYgIWNhblNldE5hbWVPbklucHV0cykgewogICAgICAvLyBJRSBhbGxvd3MgcGFzc2luZyBhIHRhZyB0byBjcmVhdGVFbGVtZW50LiBTZWUgbm90ZSBvbiBgY2FuU2V0TmFtZU9uSW5wdXRzYCBhYm92ZSBhcyB3ZWxsLgogICAgICB0YWdTdHJpbmcgPSAnPCcrc3RyaXBUYWdOYW1lKHRhZ05hbWUpKycgbmFtZT0iJytlc2NhcGVBdHRyaWJ1dGUoYXR0cnMubmFtZSkrJyI+JzsKICAgIH0gZWxzZSB7CiAgICAgIHRhZ1N0cmluZyA9IHRhZ05hbWU7CiAgICB9CgogICAgdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZ1N0cmluZyksCiAgICAgICAgJGVsZW1lbnQgPSBFbWJlci4kKGVsZW1lbnQpOwoKICAgIGlmIChpZCkgewogICAgICAkZWxlbWVudC5hdHRyKCdpZCcsIGlkKTsKICAgICAgdGhpcy5lbGVtZW50SWQgPSBudWxsOwogICAgfQogICAgaWYgKGNsYXNzZXMpIHsKICAgICAgJGVsZW1lbnQuYXR0cignY2xhc3MnLCBjbGFzc2VzLmpvaW4oJyAnKSk7CiAgICAgIHRoaXMuY2xhc3NlcyA9IG51bGw7CiAgICB9CgogICAgaWYgKHN0eWxlKSB7CiAgICAgIGZvciAocHJvcCBpbiBzdHlsZSkgewogICAgICAgIGlmIChzdHlsZS5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgewogICAgICAgICAgc3R5bGVCdWZmZXIgKz0gKHByb3AgKyAnOicgKyBzdHlsZVtwcm9wXSArICc7Jyk7CiAgICAgICAgfQogICAgICB9CgogICAgICAkZWxlbWVudC5hdHRyKCdzdHlsZScsIHN0eWxlQnVmZmVyKTsKCiAgICAgIHRoaXMuZWxlbWVudFN0eWxlID0gbnVsbDsKICAgIH0KCiAgICBpZiAoYXR0cnMpIHsKICAgICAgZm9yIChhdHRyIGluIGF0dHJzKSB7CiAgICAgICAgaWYgKGF0dHJzLmhhc093blByb3BlcnR5KGF0dHIpKSB7CiAgICAgICAgICAkZWxlbWVudC5hdHRyKGF0dHIsIGF0dHJzW2F0dHJdKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuZWxlbWVudEF0dHJpYnV0ZXMgPSBudWxsOwogICAgfQoKICAgIGlmIChwcm9wcykgewogICAgICBmb3IgKHByb3AgaW4gcHJvcHMpIHsKICAgICAgICBpZiAocHJvcHMuaGFzT3duUHJvcGVydHkocHJvcCkpIHsKICAgICAgICAgICRlbGVtZW50LnByb3AocHJvcCwgcHJvcHNbcHJvcF0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy5lbGVtZW50UHJvcGVydGllcyA9IG51bGw7CiAgICB9CgogICAgcmV0dXJuIGVsZW1lbnQ7CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIGVsZW1lbnQKICAgIEByZXR1cm4ge0RPTUVsZW1lbnR9IFRoZSBlbGVtZW50IGNvcnJlc3BvbmRpbmcgdG8gdGhlIGdlbmVyYXRlZCBIVE1MCiAgICAgIG9mIHRoaXMgYnVmZmVyCiAgKi8KICBlbGVtZW50OiBmdW5jdGlvbigpIHsKICAgIHZhciBodG1sID0gdGhpcy5pbm5lclN0cmluZygpOwoKICAgIGlmIChodG1sKSB7CiAgICAgIHRoaXMuX2VsZW1lbnQgPSBFbWJlci5WaWV3VXRpbHMuc2V0SW5uZXJIVE1MKHRoaXMuX2VsZW1lbnQsIGh0bWwpOwogICAgfQoKICAgIHJldHVybiB0aGlzLl9lbGVtZW50OwogIH0sCgogIC8qKgogICAgR2VuZXJhdGVzIHRoZSBIVE1MIGNvbnRlbnQgZm9yIHRoaXMgYnVmZmVyLgoKICAgIEBtZXRob2Qgc3RyaW5nCiAgICBAcmV0dXJuIHtTdHJpbmd9IFRoZSBnZW5lcmF0ZWQgSFRNTAogICovCiAgc3RyaW5nOiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLl9oYXNFbGVtZW50ICYmIHRoaXMuX2VsZW1lbnQpIHsKICAgICAgLy8gRmlyZWZveCB2ZXJzaW9ucyA8IDExIGRvIG5vdCBoYXZlIHN1cHBvcnQgZm9yIGVsZW1lbnQub3V0ZXJIVE1MLgogICAgICB2YXIgdGhpc0VsZW1lbnQgPSB0aGlzLmVsZW1lbnQoKSwgb3V0ZXJIVE1MID0gdGhpc0VsZW1lbnQub3V0ZXJIVE1MOwogICAgICBpZiAodHlwZW9mIG91dGVySFRNTCA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICByZXR1cm4gRW1iZXIuJCgnPGRpdi8+JykuYXBwZW5kKHRoaXNFbGVtZW50KS5odG1sKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIG91dGVySFRNTDsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLmlubmVyU3RyaW5nKCk7CiAgICB9CiAgfSwKCiAgaW5uZXJTdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuYnVmZmVyOwogIH0KfTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci12aWV3cwoqLwoKdmFyIGdldCA9IEVtYmVyLmdldCwgc2V0ID0gRW1iZXIuc2V0LCBmbXQgPSBFbWJlci5TdHJpbmcuZm10OwoKLyoqCiAgYEVtYmVyLkV2ZW50RGlzcGF0Y2hlcmAgaGFuZGxlcyBkZWxlZ2F0aW5nIGJyb3dzZXIgZXZlbnRzIHRvIHRoZWlyCiAgY29ycmVzcG9uZGluZyBgRW1iZXIuVmlld3MuYCBGb3IgZXhhbXBsZSwgd2hlbiB5b3UgY2xpY2sgb24gYSB2aWV3LAogIGBFbWJlci5FdmVudERpc3BhdGNoZXJgIGVuc3VyZXMgdGhhdCB0aGF0IHZpZXcncyBgbW91c2VEb3duYCBtZXRob2QgZ2V0cwogIGNhbGxlZC4KCiAgQGNsYXNzIEV2ZW50RGlzcGF0Y2hlcgogIEBuYW1lc3BhY2UgRW1iZXIKICBAcHJpdmF0ZQogIEBleHRlbmRzIEVtYmVyLk9iamVjdAoqLwpFbWJlci5FdmVudERpc3BhdGNoZXIgPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKCiAgLyoqCiAgICBUaGUgc2V0IG9mIGV2ZW50cyBuYW1lcyAoYW5kIGFzc29jaWF0ZWQgaGFuZGxlciBmdW5jdGlvbiBuYW1lcykgdG8gYmUgc2V0dXAKICAgIGFuZCBkaXNwYXRjaGVkIGJ5IHRoZSBgRXZlbnREaXNwYXRjaGVyYC4gQ3VzdG9tIGV2ZW50cyBjYW4gYWRkZWQgdG8gdGhpcyBsaXN0IGF0IHNldHVwCiAgICB0aW1lLCBnZW5lcmFsbHkgdmlhIHRoZSBgRW1iZXIuQXBwbGljYXRpb24uY3VzdG9tRXZlbnRzYCBoYXNoLiBPbmx5IG92ZXJyaWRlIHRoaXMKICAgIGRlZmF1bHQgc2V0IHRvIHByZXZlbnQgdGhlIEV2ZW50RGlzcGF0Y2hlciBmcm9tIGxpc3RlbmluZyBvbiBzb21lIGV2ZW50cyBhbGwgdG9nZXRoZXIuCgogICAgVGhpcyBzZXQgd2lsbCBiZSBtb2RpZmllZCBieSBgc2V0dXBgIHRvIGFsc28gaW5jbHVkZSBhbnkgZXZlbnRzIGFkZGVkIGF0IHRoYXQgdGltZS4KCiAgICBAcHJvcGVydHkgZXZlbnRzCiAgICBAdHlwZSBPYmplY3QKICAqLwogIGV2ZW50czogewogICAgdG91Y2hzdGFydCAgOiAndG91Y2hTdGFydCcsCiAgICB0b3VjaG1vdmUgICA6ICd0b3VjaE1vdmUnLAogICAgdG91Y2hlbmQgICAgOiAndG91Y2hFbmQnLAogICAgdG91Y2hjYW5jZWwgOiAndG91Y2hDYW5jZWwnLAogICAga2V5ZG93biAgICAgOiAna2V5RG93bicsCiAgICBrZXl1cCAgICAgICA6ICdrZXlVcCcsCiAgICBrZXlwcmVzcyAgICA6ICdrZXlQcmVzcycsCiAgICBtb3VzZWRvd24gICA6ICdtb3VzZURvd24nLAogICAgbW91c2V1cCAgICAgOiAnbW91c2VVcCcsCiAgICBjb250ZXh0bWVudSA6ICdjb250ZXh0TWVudScsCiAgICBjbGljayAgICAgICA6ICdjbGljaycsCiAgICBkYmxjbGljayAgICA6ICdkb3VibGVDbGljaycsCiAgICBtb3VzZW1vdmUgICA6ICdtb3VzZU1vdmUnLAogICAgZm9jdXNpbiAgICAgOiAnZm9jdXNJbicsCiAgICBmb2N1c291dCAgICA6ICdmb2N1c091dCcsCiAgICBtb3VzZWVudGVyICA6ICdtb3VzZUVudGVyJywKICAgIG1vdXNlbGVhdmUgIDogJ21vdXNlTGVhdmUnLAogICAgc3VibWl0ICAgICAgOiAnc3VibWl0JywKICAgIGlucHV0ICAgICAgIDogJ2lucHV0JywKICAgIGNoYW5nZSAgICAgIDogJ2NoYW5nZScsCiAgICBkcmFnc3RhcnQgICA6ICdkcmFnU3RhcnQnLAogICAgZHJhZyAgICAgICAgOiAnZHJhZycsCiAgICBkcmFnZW50ZXIgICA6ICdkcmFnRW50ZXInLAogICAgZHJhZ2xlYXZlICAgOiAnZHJhZ0xlYXZlJywKICAgIGRyYWdvdmVyICAgIDogJ2RyYWdPdmVyJywKICAgIGRyb3AgICAgICAgIDogJ2Ryb3AnLAogICAgZHJhZ2VuZCAgICAgOiAnZHJhZ0VuZCcKICB9LAoKICAvKioKICAgIFRoZSByb290IERPTSBlbGVtZW50IHRvIHdoaWNoIGV2ZW50IGxpc3RlbmVycyBzaG91bGQgYmUgYXR0YWNoZWQuIEV2ZW50CiAgICBsaXN0ZW5lcnMgd2lsbCBiZSBhdHRhY2hlZCB0byB0aGUgZG9jdW1lbnQgdW5sZXNzIHRoaXMgaXMgb3ZlcnJpZGRlbi4KCiAgICBDYW4gYmUgc3BlY2lmaWVkIGFzIGEgRE9NRWxlbWVudCBvciBhIHNlbGVjdG9yIHN0cmluZy4KCiAgICBUaGUgZGVmYXVsdCBib2R5IGlzIGEgc3RyaW5nIHNpbmNlIHRoaXMgbWF5IGJlIGV2YWx1YXRlZCBiZWZvcmUgZG9jdW1lbnQuYm9keQogICAgZXhpc3RzIGluIHRoZSBET00uCgogICAgQHByaXZhdGUKICAgIEBwcm9wZXJ0eSByb290RWxlbWVudAogICAgQHR5cGUgRE9NRWxlbWVudAogICAgQGRlZmF1bHQgJ2JvZHknCiAgKi8KICByb290RWxlbWVudDogJ2JvZHknLAoKICAvKioKICAgIFNldHMgdXAgZXZlbnQgbGlzdGVuZXJzIGZvciBzdGFuZGFyZCBicm93c2VyIGV2ZW50cy4KCiAgICBUaGlzIHdpbGwgYmUgY2FsbGVkIGFmdGVyIHRoZSBicm93c2VyIHNlbmRzIGEgYERPTUNvbnRlbnRSZWFkeWAgZXZlbnQuIEJ5CiAgICBkZWZhdWx0LCBpdCB3aWxsIHNldCB1cCBhbGwgb2YgdGhlIGxpc3RlbmVycyBvbiB0aGUgZG9jdW1lbnQgYm9keS4gSWYgeW91CiAgICB3b3VsZCBsaWtlIHRvIHJlZ2lzdGVyIHRoZSBsaXN0ZW5lcnMgb24gYSBkaWZmZXJlbnQgZWxlbWVudCwgc2V0IHRoZSBldmVudAogICAgZGlzcGF0Y2hlcidzIGByb290YCBwcm9wZXJ0eS4KCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBzZXR1cAogICAgQHBhcmFtIGFkZGVkRXZlbnRzIHtIYXNofQogICovCiAgc2V0dXA6IGZ1bmN0aW9uKGFkZGVkRXZlbnRzLCByb290RWxlbWVudCkgewogICAgdmFyIGV2ZW50LCBldmVudHMgPSBnZXQodGhpcywgJ2V2ZW50cycpOwoKICAgIEVtYmVyLiQuZXh0ZW5kKGV2ZW50cywgYWRkZWRFdmVudHMgfHwge30pOwoKCiAgICBpZiAoIUVtYmVyLmlzTm9uZShyb290RWxlbWVudCkpIHsKICAgICAgc2V0KHRoaXMsICdyb290RWxlbWVudCcsIHJvb3RFbGVtZW50KTsKICAgIH0KCiAgICByb290RWxlbWVudCA9IEVtYmVyLiQoZ2V0KHRoaXMsICdyb290RWxlbWVudCcpKTsKCiAgICBFbWJlci5hc3NlcnQoZm10KCdZb3UgY2Fubm90IHVzZSB0aGUgc2FtZSByb290IGVsZW1lbnQgKCVAKSBtdWx0aXBsZSB0aW1lcyBpbiBhbiBFbWJlci5BcHBsaWNhdGlvbicsIFtyb290RWxlbWVudC5zZWxlY3RvciB8fCByb290RWxlbWVudFswXS50YWdOYW1lXSksICFyb290RWxlbWVudC5pcygnLmVtYmVyLWFwcGxpY2F0aW9uJykpOwogICAgRW1iZXIuYXNzZXJ0KCdZb3UgY2Fubm90IG1ha2UgYSBuZXcgRW1iZXIuQXBwbGljYXRpb24gdXNpbmcgYSByb290IGVsZW1lbnQgdGhhdCBpcyBhIGRlc2NlbmRlbnQgb2YgYW4gZXhpc3RpbmcgRW1iZXIuQXBwbGljYXRpb24nLCAhcm9vdEVsZW1lbnQuY2xvc2VzdCgnLmVtYmVyLWFwcGxpY2F0aW9uJykubGVuZ3RoKTsKICAgIEVtYmVyLmFzc2VydCgnWW91IGNhbm5vdCBtYWtlIGEgbmV3IEVtYmVyLkFwcGxpY2F0aW9uIHVzaW5nIGEgcm9vdCBlbGVtZW50IHRoYXQgaXMgYW4gYW5jZXN0b3Igb2YgYW4gZXhpc3RpbmcgRW1iZXIuQXBwbGljYXRpb24nLCAhcm9vdEVsZW1lbnQuZmluZCgnLmVtYmVyLWFwcGxpY2F0aW9uJykubGVuZ3RoKTsKCiAgICByb290RWxlbWVudC5hZGRDbGFzcygnZW1iZXItYXBwbGljYXRpb24nKTsKCiAgICBFbWJlci5hc3NlcnQoJ1VuYWJsZSB0byBhZGQgImVtYmVyLWFwcGxpY2F0aW9uIiBjbGFzcyB0byByb290RWxlbWVudC4gTWFrZSBzdXJlIHlvdSBzZXQgcm9vdEVsZW1lbnQgdG8gdGhlIGJvZHkgb3IgYW4gZWxlbWVudCBpbiB0aGUgYm9keS4nLCByb290RWxlbWVudC5pcygnLmVtYmVyLWFwcGxpY2F0aW9uJykpOwoKICAgIGZvciAoZXZlbnQgaW4gZXZlbnRzKSB7CiAgICAgIGlmIChldmVudHMuaGFzT3duUHJvcGVydHkoZXZlbnQpKSB7CiAgICAgICAgdGhpcy5zZXR1cEhhbmRsZXIocm9vdEVsZW1lbnQsIGV2ZW50LCBldmVudHNbZXZlbnRdKTsKICAgICAgfQogICAgfQogIH0sCgogIC8qKgogICAgUmVnaXN0ZXJzIGFuIGV2ZW50IGxpc3RlbmVyIG9uIHRoZSBkb2N1bWVudC4gSWYgdGhlIGdpdmVuIGV2ZW50IGlzCiAgICB0cmlnZ2VyZWQsIHRoZSBwcm92aWRlZCBldmVudCBoYW5kbGVyIHdpbGwgYmUgdHJpZ2dlcmVkIG9uIHRoZSB0YXJnZXQgdmlldy4KCiAgICBJZiB0aGUgdGFyZ2V0IHZpZXcgZG9lcyBub3QgaW1wbGVtZW50IHRoZSBldmVudCBoYW5kbGVyLCBvciBpZiB0aGUgaGFuZGxlcgogICAgcmV0dXJucyBgZmFsc2VgLCB0aGUgcGFyZW50IHZpZXcgd2lsbCBiZSBjYWxsZWQuIFRoZSBldmVudCB3aWxsIGNvbnRpbnVlIHRvCiAgICBidWJibGUgdG8gZWFjaCBzdWNjZXNzaXZlIHBhcmVudCB2aWV3IHVudGlsIGl0IHJlYWNoZXMgdGhlIHRvcC4KCiAgICBGb3IgZXhhbXBsZSwgdG8gaGF2ZSB0aGUgYG1vdXNlRG93bmAgbWV0aG9kIGNhbGxlZCBvbiB0aGUgdGFyZ2V0IHZpZXcgd2hlbgogICAgYSBgbW91c2Vkb3duYCBldmVudCBpcyByZWNlaXZlZCBmcm9tIHRoZSBicm93c2VyLCBkbyB0aGUgZm9sbG93aW5nOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIHNldHVwSGFuZGxlcignbW91c2Vkb3duJywgJ21vdXNlRG93bicpOwogICAgYGBgCgogICAgQHByaXZhdGUKICAgIEBtZXRob2Qgc2V0dXBIYW5kbGVyCiAgICBAcGFyYW0ge0VsZW1lbnR9IHJvb3RFbGVtZW50CiAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnQgdGhlIGJyb3dzZXItb3JpZ2luYXRlZCBldmVudCB0byBsaXN0ZW4gdG8KICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudE5hbWUgdGhlIG5hbWUgb2YgdGhlIG1ldGhvZCB0byBjYWxsIG9uIHRoZSB2aWV3CiAgKi8KICBzZXR1cEhhbmRsZXI6IGZ1bmN0aW9uKHJvb3RFbGVtZW50LCBldmVudCwgZXZlbnROYW1lKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgcm9vdEVsZW1lbnQub24oZXZlbnQgKyAnLmVtYmVyJywgJy5lbWJlci12aWV3JywgZnVuY3Rpb24oZXZ0LCB0cmlnZ2VyaW5nTWFuYWdlcikgewogICAgICByZXR1cm4gRW1iZXIuaGFuZGxlRXJyb3JzKGZ1bmN0aW9uIGhhbmRsZVZpZXdFdmVudCgpIHsKICAgICAgICB2YXIgdmlldyA9IEVtYmVyLlZpZXcudmlld3NbdGhpcy5pZF0sCiAgICAgICAgICAgIHJlc3VsdCA9IHRydWUsIG1hbmFnZXIgPSBudWxsOwoKICAgICAgICBtYW5hZ2VyID0gc2VsZi5fZmluZE5lYXJlc3RFdmVudE1hbmFnZXIodmlldyxldmVudE5hbWUpOwoKICAgICAgICBpZiAobWFuYWdlciAmJiBtYW5hZ2VyICE9PSB0cmlnZ2VyaW5nTWFuYWdlcikgewogICAgICAgICAgcmVzdWx0ID0gc2VsZi5fZGlzcGF0Y2hFdmVudChtYW5hZ2VyLCBldnQsIGV2ZW50TmFtZSwgdmlldyk7CiAgICAgICAgfSBlbHNlIGlmICh2aWV3KSB7CiAgICAgICAgICByZXN1bHQgPSBzZWxmLl9idWJibGVFdmVudCh2aWV3LGV2dCxldmVudE5hbWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9LCB0aGlzKTsKICAgIH0pOwoKICAgIHJvb3RFbGVtZW50Lm9uKGV2ZW50ICsgJy5lbWJlcicsICdbZGF0YS1lbWJlci1hY3Rpb25dJywgZnVuY3Rpb24oZXZ0KSB7CiAgICAgIHJldHVybiBFbWJlci5oYW5kbGVFcnJvcnMoZnVuY3Rpb24gaGFuZGxlQWN0aW9uRXZlbnQoKSB7CiAgICAgICAgdmFyIGFjdGlvbklkID0gRW1iZXIuJChldnQuY3VycmVudFRhcmdldCkuYXR0cignZGF0YS1lbWJlci1hY3Rpb24nKSwKICAgICAgICAgICAgYWN0aW9uICAgPSBFbWJlci5IYW5kbGViYXJzLkFjdGlvbkhlbHBlci5yZWdpc3RlcmVkQWN0aW9uc1thY3Rpb25JZF07CgogICAgICAgIC8vIFdlIGhhdmUgdG8gY2hlY2sgZm9yIGFjdGlvbiBoZXJlIHNpbmNlIGluIHNvbWUgY2FzZXMsIGpRdWVyeSB3aWxsIHRyaWdnZXIKICAgICAgICAvLyBhbiBldmVudCBvbiBgcmVtb3ZlQ2hpbGRgIChpLmUuIGZvY3Vzb3V0KSBhZnRlciB3ZSd2ZSBhbHJlYWR5IHRvcm4gZG93biB0aGUKICAgICAgICAvLyBhY3Rpb24gaGFuZGxlcnMgZm9yIHRoZSB2aWV3LgogICAgICAgIGlmIChhY3Rpb24gJiYgYWN0aW9uLmV2ZW50TmFtZSA9PT0gZXZlbnROYW1lKSB7CiAgICAgICAgICByZXR1cm4gYWN0aW9uLmhhbmRsZXIoZXZ0KTsKICAgICAgICB9CiAgICAgIH0sIHRoaXMpOwogICAgfSk7CiAgfSwKCiAgX2ZpbmROZWFyZXN0RXZlbnRNYW5hZ2VyOiBmdW5jdGlvbih2aWV3LCBldmVudE5hbWUpIHsKICAgIHZhciBtYW5hZ2VyID0gbnVsbDsKCiAgICB3aGlsZSAodmlldykgewogICAgICBtYW5hZ2VyID0gZ2V0KHZpZXcsICdldmVudE1hbmFnZXInKTsKICAgICAgaWYgKG1hbmFnZXIgJiYgbWFuYWdlcltldmVudE5hbWVdKSB7IGJyZWFrOyB9CgogICAgICB2aWV3ID0gZ2V0KHZpZXcsICdwYXJlbnRWaWV3Jyk7CiAgICB9CgogICAgcmV0dXJuIG1hbmFnZXI7CiAgfSwKCiAgX2Rpc3BhdGNoRXZlbnQ6IGZ1bmN0aW9uKG9iamVjdCwgZXZ0LCBldmVudE5hbWUsIHZpZXcpIHsKICAgIHZhciByZXN1bHQgPSB0cnVlOwoKICAgIHZhciBoYW5kbGVyID0gb2JqZWN0W2V2ZW50TmFtZV07CiAgICBpZiAoRW1iZXIudHlwZU9mKGhhbmRsZXIpID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHJlc3VsdCA9IEVtYmVyLnJ1bihmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gaGFuZGxlci5jYWxsKG9iamVjdCwgZXZ0LCB2aWV3KTsKICAgICAgfSk7CiAgICAgIC8vIERvIG5vdCBwcmV2ZW50RGVmYXVsdCBpbiBldmVudE1hbmFnZXJzLgogICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgcmVzdWx0ID0gdGhpcy5fYnViYmxlRXZlbnQodmlldywgZXZ0LCBldmVudE5hbWUpOwogICAgfQoKICAgIHJldHVybiByZXN1bHQ7CiAgfSwKCiAgX2J1YmJsZUV2ZW50OiBmdW5jdGlvbih2aWV3LCBldnQsIGV2ZW50TmFtZSkgewogICAgcmV0dXJuIEVtYmVyLnJ1bihmdW5jdGlvbiBidWJibGVFdmVudCgpIHsKICAgICAgcmV0dXJuIHZpZXcuaGFuZGxlRXZlbnQoZXZlbnROYW1lLCBldnQpOwogICAgfSk7CiAgfSwKCiAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICB2YXIgcm9vdEVsZW1lbnQgPSBnZXQodGhpcywgJ3Jvb3RFbGVtZW50Jyk7CiAgICBFbWJlci4kKHJvb3RFbGVtZW50KS5vZmYoJy5lbWJlcicsICcqKicpLnJlbW92ZUNsYXNzKCdlbWJlci1hcHBsaWNhdGlvbicpOwogICAgcmV0dXJuIHRoaXMuX3N1cGVyKCk7CiAgfQp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci12aWV3cwoqLwoKLy8gQWRkIGEgbmV3IG5hbWVkIHF1ZXVlIGZvciByZW5kZXJpbmcgdmlld3MgdGhhdCBoYXBwZW5zCi8vIGFmdGVyIGJpbmRpbmdzIGhhdmUgc3luY2VkLCBhbmQgYSBxdWV1ZSBmb3Igc2NoZWR1bGluZyBhY3Rpb25zCi8vIHRoYXQgdGhhdCBzaG91bGQgb2NjdXIgYWZ0ZXIgdmlldyByZW5kZXJpbmcuCnZhciBxdWV1ZXMgPSBFbWJlci5ydW4ucXVldWVzLAogICAgaW5kZXhPZiA9IEVtYmVyLkFycmF5UG9seWZpbGxzLmluZGV4T2Y7CnF1ZXVlcy5zcGxpY2UoaW5kZXhPZi5jYWxsKHF1ZXVlcywgJ2FjdGlvbnMnKSsxLCAwLCAncmVuZGVyJywgJ2FmdGVyUmVuZGVyJyk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItdmlld3MKKi8KCnZhciBnZXQgPSBFbWJlci5nZXQsIHNldCA9IEVtYmVyLnNldDsKCi8vIE9yaWdpbmFsIGNsYXNzIGRlY2xhcmF0aW9uIGFuZCBkb2N1bWVudGF0aW9uIGluIHJ1bnRpbWUvbGliL2NvbnRyb2xsZXJzL2NvbnRyb2xsZXIuanMKLy8gTk9URTogSXQgbWF5IGJlIHBvc3NpYmxlIHdpdGggWVVJRG9jIHRvIGNvbWJpbmUgZG9jcyBpbiB0d28gbG9jYXRpb25zCgovKioKQWRkaXRpb25hbCBtZXRob2RzIGZvciB0aGUgQ29udHJvbGxlck1peGluCgpAY2xhc3MgQ29udHJvbGxlck1peGluCkBuYW1lc3BhY2UgRW1iZXIKKi8KRW1iZXIuQ29udHJvbGxlck1peGluLnJlb3Blbih7CiAgdGFyZ2V0OiBudWxsLAogIG5hbWVzcGFjZTogbnVsbCwKICB2aWV3OiBudWxsLAogIGNvbnRhaW5lcjogbnVsbCwKICBfY2hpbGRDb250YWluZXJzOiBudWxsLAoKICBpbml0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3N1cGVyKCk7CiAgICBzZXQodGhpcywgJ19jaGlsZENvbnRhaW5lcnMnLCB7fSk7CiAgfSwKCiAgX21vZGVsRGlkQ2hhbmdlOiBFbWJlci5vYnNlcnZlcignbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgIHZhciBjb250YWluZXJzID0gZ2V0KHRoaXMsICdfY2hpbGRDb250YWluZXJzJyk7CgogICAgZm9yICh2YXIgcHJvcCBpbiBjb250YWluZXJzKSB7CiAgICAgIGlmICghY29udGFpbmVycy5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgeyBjb250aW51ZTsgfQogICAgICBjb250YWluZXJzW3Byb3BdLmRlc3Ryb3koKTsKICAgIH0KCiAgICBzZXQodGhpcywgJ19jaGlsZENvbnRhaW5lcnMnLCB7fSk7CiAgfSkKfSk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7CnZhciBzdGF0ZXMgPSB7fTsKCi8qKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItdmlld3MKKi8KCnZhciBnZXQgPSBFbWJlci5nZXQsIHNldCA9IEVtYmVyLnNldDsKdmFyIGd1aWRGb3IgPSBFbWJlci5ndWlkRm9yOwp2YXIgYV9mb3JFYWNoID0gRW1iZXIuRW51bWVyYWJsZVV0aWxzLmZvckVhY2g7CnZhciBhX2FkZE9iamVjdCA9IEVtYmVyLkVudW1lcmFibGVVdGlscy5hZGRPYmplY3Q7CnZhciBtZXRhID0gRW1iZXIubWV0YTsKCnZhciBjaGlsZFZpZXdzUHJvcGVydHkgPSBFbWJlci5jb21wdXRlZChmdW5jdGlvbigpIHsKICB2YXIgY2hpbGRWaWV3cyA9IHRoaXMuX2NoaWxkVmlld3MsIHJldCA9IEVtYmVyLkEoKSwgdmlldyA9IHRoaXM7CgogIGFfZm9yRWFjaChjaGlsZFZpZXdzLCBmdW5jdGlvbih2aWV3KSB7CiAgICB2YXIgY3VycmVudENoaWxkVmlld3M7CiAgICBpZiAodmlldy5pc1ZpcnR1YWwpIHsKICAgICAgaWYgKGN1cnJlbnRDaGlsZFZpZXdzID0gZ2V0KHZpZXcsICdjaGlsZFZpZXdzJykpIHsKICAgICAgICByZXQucHVzaE9iamVjdHMoY3VycmVudENoaWxkVmlld3MpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXQucHVzaCh2aWV3KTsKICAgIH0KICB9KTsKCiAgcmV0LnJlcGxhY2UgPSBmdW5jdGlvbiAoaWR4LCByZW1vdmVkQ291bnQsIGFkZGVkVmlld3MpIHsKICAgIGlmICh2aWV3IGluc3RhbmNlb2YgRW1iZXIuQ29udGFpbmVyVmlldykgewogICAgICBFbWJlci5kZXByZWNhdGUoIk1hbmlwdWxhdGluZyBhbiBFbWJlci5Db250YWluZXJWaWV3IHRocm91Z2ggaXRzIGNoaWxkVmlld3MgcHJvcGVydHkgaXMgZGVwcmVjYXRlZC4gUGxlYXNlIHVzZSB0aGUgQ29udGFpbmVyVmlldyBpbnN0YW5jZSBpdHNlbGYgYXMgYW4gRW1iZXIuTXV0YWJsZUFycmF5LiIpOwogICAgICByZXR1cm4gdmlldy5yZXBsYWNlKGlkeCwgcmVtb3ZlZENvdW50LCBhZGRlZFZpZXdzKTsKICAgIH0KICAgIHRocm93IG5ldyBFbWJlci5FcnJvcigiY2hpbGRWaWV3cyBpcyBpbW11dGFibGUiKTsKICB9OwoKICByZXR1cm4gcmV0Owp9KTsKCkVtYmVyLndhcm4oIlRoZSBWSUVXX1BSRVNFUlZFU19DT05URVhUIGZsYWcgaGFzIGJlZW4gcmVtb3ZlZCBhbmQgdGhlIGZ1bmN0aW9uYWxpdHkgY2FuIG5vIGxvbmdlciBiZSBkaXNhYmxlZC4iLCBFbWJlci5FTlYuVklFV19QUkVTRVJWRVNfQ09OVEVYVCAhPT0gZmFsc2UpOwoKLyoqCiAgR2xvYmFsIGhhc2ggb2Ygc2hhcmVkIHRlbXBsYXRlcy4gVGhpcyB3aWxsIGF1dG9tYXRpY2FsbHkgYmUgcG9wdWxhdGVkCiAgYnkgdGhlIGJ1aWxkIHRvb2xzIHNvIHRoYXQgeW91IGNhbiBzdG9yZSB5b3VyIEhhbmRsZWJhcnMgdGVtcGxhdGVzIGluCiAgc2VwYXJhdGUgZmlsZXMgdGhhdCBnZXQgbG9hZGVkIGludG8gSmF2YVNjcmlwdCBhdCBidWlsZHRpbWUuCgogIEBwcm9wZXJ0eSBURU1QTEFURVMKICBAZm9yIEVtYmVyCiAgQHR5cGUgSGFzaAoqLwpFbWJlci5URU1QTEFURVMgPSB7fTsKCi8qKgogIGBFbWJlci5Db3JlVmlld2AgaXMgYW4gYWJzdHJhY3QgY2xhc3MgdGhhdCBleGlzdHMgdG8gZ2l2ZSB2aWV3LWxpa2UgYmVoYXZpb3IKICB0byBib3RoIEVtYmVyJ3MgbWFpbiB2aWV3IGNsYXNzIGBFbWJlci5WaWV3YCBhbmQgb3RoZXIgY2xhc3NlcyBsaWtlCiAgYEVtYmVyLl9TaW1wbGVNZXRhbW9ycGhWaWV3YCB0aGF0IGRvbid0IG5lZWQgdGhlIGZ1bGx5IGZ1bmN0aW9uYWx0aXkgb2YKICBgRW1iZXIuVmlld2AuCgogIFVubGVzcyB5b3UgaGF2ZSBzcGVjaWZpYyBuZWVkcyBmb3IgYENvcmVWaWV3YCwgeW91IHdpbGwgdXNlIGBFbWJlci5WaWV3YAogIGluIHlvdXIgYXBwbGljYXRpb25zLgoKICBAY2xhc3MgQ29yZVZpZXcKICBAbmFtZXNwYWNlIEVtYmVyCiAgQGV4dGVuZHMgRW1iZXIuT2JqZWN0CiAgQHVzZXMgRW1iZXIuRXZlbnRlZAogIEB1c2VzIEVtYmVyLkFjdGlvbkhhbmRsZXIKKi8KCkVtYmVyLkNvcmVWaWV3ID0gRW1iZXIuT2JqZWN0LmV4dGVuZChFbWJlci5FdmVudGVkLCBFbWJlci5BY3Rpb25IYW5kbGVyLCB7CiAgaXNWaWV3OiB0cnVlLAoKICBzdGF0ZXM6IHN0YXRlcywKCiAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9zdXBlcigpOwogICAgdGhpcy50cmFuc2l0aW9uVG8oJ3ByZVJlbmRlcicpOwogIH0sCgogIC8qKgogICAgSWYgdGhlIHZpZXcgaXMgY3VycmVudGx5IGluc2VydGVkIGludG8gdGhlIERPTSBvZiBhIHBhcmVudCB2aWV3LCB0aGlzCiAgICBwcm9wZXJ0eSB3aWxsIHBvaW50IHRvIHRoZSBwYXJlbnQgb2YgdGhlIHZpZXcuCgogICAgQHByb3BlcnR5IHBhcmVudFZpZXcKICAgIEB0eXBlIEVtYmVyLlZpZXcKICAgIEBkZWZhdWx0IG51bGwKICAqLwogIHBhcmVudFZpZXc6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewogICAgdmFyIHBhcmVudCA9IHRoaXMuX3BhcmVudFZpZXc7CgogICAgaWYgKHBhcmVudCAmJiBwYXJlbnQuaXNWaXJ0dWFsKSB7CiAgICAgIHJldHVybiBnZXQocGFyZW50LCAncGFyZW50VmlldycpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHBhcmVudDsKICAgIH0KICB9KS5wcm9wZXJ0eSgnX3BhcmVudFZpZXcnKSwKCiAgc3RhdGU6IG51bGwsCgogIF9wYXJlbnRWaWV3OiBudWxsLAoKICAvLyByZXR1cm4gdGhlIGN1cnJlbnQgdmlldywgbm90IGluY2x1ZGluZyB2aXJ0dWFsIHZpZXdzCiAgY29uY3JldGVWaWV3OiBFbWJlci5jb21wdXRlZChmdW5jdGlvbigpIHsKICAgIGlmICghdGhpcy5pc1ZpcnR1YWwpIHsgcmV0dXJuIHRoaXM7IH0KICAgIGVsc2UgeyByZXR1cm4gZ2V0KHRoaXMsICdwYXJlbnRWaWV3Jyk7IH0KICB9KS5wcm9wZXJ0eSgncGFyZW50VmlldycpLAoKICBpbnN0cnVtZW50TmFtZTogJ2NvcmVfdmlldycsCgogIGluc3RydW1lbnREZXRhaWxzOiBmdW5jdGlvbihoYXNoKSB7CiAgICBoYXNoLm9iamVjdCA9IHRoaXMudG9TdHJpbmcoKTsKICB9LAoKICAvKioKICAgIEludm9rZWQgYnkgdGhlIHZpZXcgc3lzdGVtIHdoZW4gdGhpcyB2aWV3IG5lZWRzIHRvIHByb2R1Y2UgYW4gSFRNTAogICAgcmVwcmVzZW50YXRpb24uIFRoaXMgbWV0aG9kIHdpbGwgY3JlYXRlIGEgbmV3IHJlbmRlciBidWZmZXIsIGlmIG5lZWRlZCwKICAgIHRoZW4gYXBwbHkgYW55IGRlZmF1bHQgYXR0cmlidXRlcywgc3VjaCBhcyBjbGFzcyBuYW1lcyBhbmQgdmlzaWJpbGl0eS4KICAgIEZpbmFsbHksIHRoZSBgcmVuZGVyKClgIG1ldGhvZCBpcyBpbnZva2VkLCB3aGljaCBpcyByZXNwb25zaWJsZSBmb3IKICAgIGRvaW5nIHRoZSBidWxrIG9mIHRoZSByZW5kZXJpbmcuCgogICAgWW91IHNob3VsZCBub3QgbmVlZCB0byBvdmVycmlkZSB0aGlzIG1ldGhvZDsgaW5zdGVhZCwgaW1wbGVtZW50IHRoZQogICAgYHRlbXBsYXRlYCBwcm9wZXJ0eSwgb3IgaWYgeW91IG5lZWQgbW9yZSBjb250cm9sLCBvdmVycmlkZSB0aGUgYHJlbmRlcmAKICAgIG1ldGhvZC4KCiAgICBAbWV0aG9kIHJlbmRlclRvQnVmZmVyCiAgICBAcGFyYW0ge0VtYmVyLlJlbmRlckJ1ZmZlcn0gYnVmZmVyIHRoZSByZW5kZXIgYnVmZmVyLiBJZiBubyBidWZmZXIgaXMKICAgICAgcGFzc2VkLCBhIGRlZmF1bHQgYnVmZmVyLCB1c2luZyB0aGUgY3VycmVudCB2aWV3J3MgYHRhZ05hbWVgLCB3aWxsCiAgICAgIGJlIHVzZWQuCiAgICBAcHJpdmF0ZQogICovCiAgcmVuZGVyVG9CdWZmZXI6IGZ1bmN0aW9uKHBhcmVudEJ1ZmZlciwgYnVmZmVyT3BlcmF0aW9uKSB7CiAgICB2YXIgbmFtZSA9ICdyZW5kZXIuJyArIHRoaXMuaW5zdHJ1bWVudE5hbWUsCiAgICAgICAgZGV0YWlscyA9IHt9OwoKICAgIHRoaXMuaW5zdHJ1bWVudERldGFpbHMoZGV0YWlscyk7CgogICAgcmV0dXJuIEVtYmVyLmluc3RydW1lbnQobmFtZSwgZGV0YWlscywgZnVuY3Rpb24gaW5zdHJ1bWVudFJlbmRlclRvQnVmZmVyKCkgewogICAgICByZXR1cm4gdGhpcy5fcmVuZGVyVG9CdWZmZXIocGFyZW50QnVmZmVyLCBidWZmZXJPcGVyYXRpb24pOwogICAgfSwgdGhpcyk7CiAgfSwKCiAgX3JlbmRlclRvQnVmZmVyOiBmdW5jdGlvbihwYXJlbnRCdWZmZXIsIGJ1ZmZlck9wZXJhdGlvbikgewogICAgLy8gSWYgdGhpcyBpcyB0aGUgdG9wLW1vc3Qgdmlldywgc3RhcnQgYSBuZXcgYnVmZmVyLiBPdGhlcndpc2UsCiAgICAvLyBjcmVhdGUgYSBuZXcgYnVmZmVyIHJlbGF0aXZlIHRvIHRoZSBvcmlnaW5hbCB1c2luZyB0aGUKICAgIC8vIHByb3ZpZGVkIGJ1ZmZlciBvcGVyYXRpb24gKGZvciBleGFtcGxlLCBgaW5zZXJ0QWZ0ZXJgIHdpbGwKICAgIC8vIGluc2VydCBhIG5ldyBidWZmZXIgYWZ0ZXIgdGhlICJwYXJlbnQgYnVmZmVyIikuCiAgICB2YXIgdGFnTmFtZSA9IHRoaXMudGFnTmFtZTsKCiAgICBpZiAodGFnTmFtZSA9PT0gbnVsbCB8fCB0YWdOYW1lID09PSB1bmRlZmluZWQpIHsKICAgICAgdGFnTmFtZSA9ICdkaXYnOwogICAgfQoKICAgIHZhciBidWZmZXIgPSB0aGlzLmJ1ZmZlciA9IHBhcmVudEJ1ZmZlciAmJiBwYXJlbnRCdWZmZXIuYmVnaW4odGFnTmFtZSkgfHwgRW1iZXIuUmVuZGVyQnVmZmVyKHRhZ05hbWUpOwogICAgdGhpcy50cmFuc2l0aW9uVG8oJ2luQnVmZmVyJywgZmFsc2UpOwoKICAgIHRoaXMuYmVmb3JlUmVuZGVyKGJ1ZmZlcik7CiAgICB0aGlzLnJlbmRlcihidWZmZXIpOwogICAgdGhpcy5hZnRlclJlbmRlcihidWZmZXIpOwoKICAgIHJldHVybiBidWZmZXI7CiAgfSwKCiAgLyoqCiAgICBPdmVycmlkZSB0aGUgZGVmYXVsdCBldmVudCBmaXJpbmcgZnJvbSBgRW1iZXIuRXZlbnRlZGAgdG8KICAgIGFsc28gY2FsbCBtZXRob2RzIHdpdGggdGhlIGdpdmVuIG5hbWUuCgogICAgQG1ldGhvZCB0cmlnZ2VyCiAgICBAcGFyYW0gbmFtZSB7U3RyaW5nfQogICAgQHByaXZhdGUKICAqLwogIHRyaWdnZXI6IGZ1bmN0aW9uKG5hbWUpIHsKICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB2YXIgbWV0aG9kID0gdGhpc1tuYW1lXTsKICAgIGlmIChtZXRob2QpIHsKICAgICAgdmFyIGFyZ3MgPSBbXSwgaSwgbDsKICAgICAgZm9yIChpID0gMSwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBhcmdzLnB1c2goYXJndW1lbnRzW2ldKTsKICAgICAgfQogICAgICByZXR1cm4gbWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfQogIH0sCgogIGRlcHJlY2F0ZWRTZW5kSGFuZGxlczogZnVuY3Rpb24oYWN0aW9uTmFtZSkgewogICAgcmV0dXJuICEhdGhpc1thY3Rpb25OYW1lXTsKICB9LAoKICBkZXByZWNhdGVkU2VuZDogZnVuY3Rpb24oYWN0aW9uTmFtZSkgewogICAgdmFyIGFyZ3MgPSBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICBFbWJlci5hc3NlcnQoJycgKyB0aGlzICsgIiBoYXMgdGhlIGFjdGlvbiAiICsgYWN0aW9uTmFtZSArICIgYnV0IGl0IGlzIG5vdCBhIGZ1bmN0aW9uIiwgdHlwZW9mIHRoaXNbYWN0aW9uTmFtZV0gPT09ICdmdW5jdGlvbicpOwogICAgRW1iZXIuZGVwcmVjYXRlKCdBY3Rpb24gaGFuZGxlcnMgaW1wbGVtZW50ZWQgZGlyZWN0bHkgb24gdmlld3MgYXJlIGRlcHJlY2F0ZWQgaW4gZmF2b3Igb2YgYWN0aW9uIGhhbmRsZXJzIG9uIGFuIGBhY3Rpb25zYCBvYmplY3QgKCcgKyBhY3Rpb25OYW1lICsgJyBvbiAnICsgdGhpcyArICcpJywgZmFsc2UpOwogICAgdGhpc1thY3Rpb25OYW1lXS5hcHBseSh0aGlzLCBhcmdzKTsKICAgIHJldHVybjsKICB9LAoKICBoYXM6IGZ1bmN0aW9uKG5hbWUpIHsKICAgIHJldHVybiBFbWJlci50eXBlT2YodGhpc1tuYW1lXSkgPT09ICdmdW5jdGlvbicgfHwgdGhpcy5fc3VwZXIobmFtZSk7CiAgfSwKCiAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICB2YXIgcGFyZW50ID0gdGhpcy5fcGFyZW50VmlldzsKCiAgICBpZiAoIXRoaXMuX3N1cGVyKCkpIHsgcmV0dXJuOyB9CgogICAgLy8gZGVzdHJveSB0aGUgZWxlbWVudCAtLSB0aGlzIHdpbGwgYXZvaWQgZWFjaCBjaGlsZCB2aWV3IGRlc3Ryb3lpbmcKICAgIC8vIHRoZSBlbGVtZW50IG92ZXIgYW5kIG92ZXIgYWdhaW4uLi4KICAgIGlmICghdGhpcy5yZW1vdmVkRnJvbURPTSkgeyB0aGlzLmRlc3Ryb3lFbGVtZW50KCk7IH0KCiAgICAvLyByZW1vdmUgZnJvbSBwYXJlbnQgaWYgZm91bmQuIERvbid0IGNhbGwgcmVtb3ZlRnJvbVBhcmVudCwKICAgIC8vIGFzIHJlbW92ZUZyb21QYXJlbnQgd2lsbCB0cnkgdG8gcmVtb3ZlIHRoZSBlbGVtZW50IGZyb20KICAgIC8vIHRoZSBET00gYWdhaW4uCiAgICBpZiAocGFyZW50KSB7IHBhcmVudC5yZW1vdmVDaGlsZCh0aGlzKTsgfQoKICAgIHRoaXMudHJhbnNpdGlvblRvKCdkZXN0cm95aW5nJywgZmFsc2UpOwoKICAgIHJldHVybiB0aGlzOwogIH0sCgogIGNsZWFyUmVuZGVyZWRDaGlsZHJlbjogRW1iZXIuSywKICB0cmlnZ2VyUmVjdXJzaXZlbHk6IEVtYmVyLkssCiAgaW52b2tlUmVjdXJzaXZlbHk6IEVtYmVyLkssCiAgdHJhbnNpdGlvblRvOiBFbWJlci5LLAogIGRlc3Ryb3lFbGVtZW50OiBFbWJlci5LCn0pOwoKdmFyIFZpZXdDb2xsZWN0aW9uID0gRW1iZXIuX1ZpZXdDb2xsZWN0aW9uID0gZnVuY3Rpb24oaW5pdGlhbFZpZXdzKSB7CiAgdmFyIHZpZXdzID0gdGhpcy52aWV3cyA9IGluaXRpYWxWaWV3cyB8fCBbXTsKICB0aGlzLmxlbmd0aCA9IHZpZXdzLmxlbmd0aDsKfTsKClZpZXdDb2xsZWN0aW9uLnByb3RvdHlwZSA9IHsKICBsZW5ndGg6IDAsCgogIHRyaWdnZXI6IGZ1bmN0aW9uKGV2ZW50TmFtZSkgewogICAgdmFyIHZpZXdzID0gdGhpcy52aWV3cywgdmlldzsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gdmlld3MubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIHZpZXcgPSB2aWV3c1tpXTsKICAgICAgaWYgKHZpZXcudHJpZ2dlcikgeyB2aWV3LnRyaWdnZXIoZXZlbnROYW1lKTsgfQogICAgfQogIH0sCgogIHRyaWdnZXJSZWN1cnNpdmVseTogZnVuY3Rpb24oZXZlbnROYW1lKSB7CiAgICB2YXIgdmlld3MgPSB0aGlzLnZpZXdzOwogICAgZm9yICh2YXIgaSA9IDAsIGwgPSB2aWV3cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgdmlld3NbaV0udHJpZ2dlclJlY3Vyc2l2ZWx5KGV2ZW50TmFtZSk7CiAgICB9CiAgfSwKCiAgaW52b2tlUmVjdXJzaXZlbHk6IGZ1bmN0aW9uKGZuKSB7CiAgICB2YXIgdmlld3MgPSB0aGlzLnZpZXdzLCB2aWV3OwoKICAgIGZvciAodmFyIGkgPSAwLCBsID0gdmlld3MubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIHZpZXcgPSB2aWV3c1tpXTsKICAgICAgZm4odmlldyk7CiAgICB9CiAgfSwKCiAgdHJhbnNpdGlvblRvOiBmdW5jdGlvbihzdGF0ZSwgY2hpbGRyZW4pIHsKICAgIHZhciB2aWV3cyA9IHRoaXMudmlld3M7CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IHZpZXdzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICB2aWV3c1tpXS50cmFuc2l0aW9uVG8oc3RhdGUsIGNoaWxkcmVuKTsKICAgIH0KICB9LAoKICBwdXNoOiBmdW5jdGlvbigpIHsKICAgIHRoaXMubGVuZ3RoICs9IGFyZ3VtZW50cy5sZW5ndGg7CiAgICB2YXIgdmlld3MgPSB0aGlzLnZpZXdzOwogICAgcmV0dXJuIHZpZXdzLnB1c2guYXBwbHkodmlld3MsIGFyZ3VtZW50cyk7CiAgfSwKCiAgb2JqZWN0QXQ6IGZ1bmN0aW9uKGlkeCkgewogICAgcmV0dXJuIHRoaXMudmlld3NbaWR4XTsKICB9LAoKICBmb3JFYWNoOiBmdW5jdGlvbihjYWxsYmFjaykgewogICAgdmFyIHZpZXdzID0gdGhpcy52aWV3czsKICAgIHJldHVybiBhX2ZvckVhY2godmlld3MsIGNhbGxiYWNrKTsKICB9LAoKICBjbGVhcjogZnVuY3Rpb24oKSB7CiAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICB0aGlzLnZpZXdzLmxlbmd0aCA9IDA7CiAgfQp9OwoKdmFyIEVNUFRZX0FSUkFZID0gW107CgovKioKICBgRW1iZXIuVmlld2AgaXMgdGhlIGNsYXNzIGluIEVtYmVyIHJlc3BvbnNpYmxlIGZvciBlbmNhcHN1bGF0aW5nIHRlbXBsYXRlcyBvZgogIEhUTUwgY29udGVudCwgY29tYmluaW5nIHRlbXBsYXRlcyB3aXRoIGRhdGEgdG8gcmVuZGVyIGFzIHNlY3Rpb25zIG9mIGEgcGFnZSdzCiAgRE9NLCBhbmQgcmVnaXN0ZXJpbmcgYW5kIHJlc3BvbmRpbmcgdG8gdXNlci1pbml0aWF0ZWQgZXZlbnRzLgoKICAjIyBIVE1MIFRhZwoKICBUaGUgZGVmYXVsdCBIVE1MIHRhZyBuYW1lIHVzZWQgZm9yIGEgdmlldydzIERPTSByZXByZXNlbnRhdGlvbiBpcyBgZGl2YC4gVGhpcwogIGNhbiBiZSBjdXN0b21pemVkIGJ5IHNldHRpbmcgdGhlIGB0YWdOYW1lYCBwcm9wZXJ0eS4gVGhlIGZvbGxvd2luZyB2aWV3CiAgY2xhc3M6CgogIGBgYGphdmFzY3JpcHQKICBQYXJhZ3JhcGhWaWV3ID0gRW1iZXIuVmlldy5leHRlbmQoewogICAgdGFnTmFtZTogJ2VtJwogIH0pOwogIGBgYAoKICBXb3VsZCByZXN1bHQgaW4gaW5zdGFuY2VzIHdpdGggdGhlIGZvbGxvd2luZyBIVE1MOgoKICBgYGBodG1sCiAgPGVtIGlkPSJlbWJlcjEiIGNsYXNzPSJlbWJlci12aWV3Ij48L2VtPgogIGBgYAoKICAjIyBIVE1MIGBjbGFzc2AgQXR0cmlidXRlCgogIFRoZSBIVE1MIGBjbGFzc2AgYXR0cmlidXRlIG9mIGEgdmlldydzIHRhZyBjYW4gYmUgc2V0IGJ5IHByb3ZpZGluZyBhCiAgYGNsYXNzTmFtZXNgIHByb3BlcnR5IHRoYXQgaXMgc2V0IHRvIGFuIGFycmF5IG9mIHN0cmluZ3M6CgogIGBgYGphdmFzY3JpcHQKICBNeVZpZXcgPSBFbWJlci5WaWV3LmV4dGVuZCh7CiAgICBjbGFzc05hbWVzOiBbJ215LWNsYXNzJywgJ215LW90aGVyLWNsYXNzJ10KICB9KTsKICBgYGAKCiAgV2lsbCByZXN1bHQgaW4gdmlldyBpbnN0YW5jZXMgd2l0aCBhbiBIVE1MIHJlcHJlc2VudGF0aW9uIG9mOgoKICBgYGBodG1sCiAgPGRpdiBpZD0iZW1iZXIxIiBjbGFzcz0iZW1iZXItdmlldyBteS1jbGFzcyBteS1vdGhlci1jbGFzcyI+PC9kaXY+CiAgYGBgCgogIGBjbGFzc2AgYXR0cmlidXRlIHZhbHVlcyBjYW4gYWxzbyBiZSBzZXQgYnkgcHJvdmlkaW5nIGEgYGNsYXNzTmFtZUJpbmRpbmdzYAogIHByb3BlcnR5IHNldCB0byBhbiBhcnJheSBvZiBwcm9wZXJ0aWVzIG5hbWVzIGZvciB0aGUgdmlldy4gVGhlIHJldHVybiB2YWx1ZQogIG9mIHRoZXNlIHByb3BlcnRpZXMgd2lsbCBiZSBhZGRlZCBhcyBwYXJ0IG9mIHRoZSB2YWx1ZSBmb3IgdGhlIHZpZXcncyBgY2xhc3NgCiAgYXR0cmlidXRlLiBUaGVzZSBwcm9wZXJ0aWVzIGNhbiBiZSBjb21wdXRlZCBwcm9wZXJ0aWVzOgoKICBgYGBqYXZhc2NyaXB0CiAgTXlWaWV3ID0gRW1iZXIuVmlldy5leHRlbmQoewogICAgY2xhc3NOYW1lQmluZGluZ3M6IFsncHJvcGVydHlBJywgJ3Byb3BlcnR5QiddLAogICAgcHJvcGVydHlBOiAnZnJvbS1hJywKICAgIHByb3BlcnR5QjogZnVuY3Rpb24oKSB7CiAgICAgIGlmIChzb21lTG9naWMpIHsgcmV0dXJuICdmcm9tLWInOyB9CiAgICB9LnByb3BlcnR5KCkKICB9KTsKICBgYGAKCiAgV2lsbCByZXN1bHQgaW4gdmlldyBpbnN0YW5jZXMgd2l0aCBhbiBIVE1MIHJlcHJlc2VudGF0aW9uIG9mOgoKICBgYGBodG1sCiAgPGRpdiBpZD0iZW1iZXIxIiBjbGFzcz0iZW1iZXItdmlldyBmcm9tLWEgZnJvbS1iIj48L2Rpdj4KICBgYGAKCiAgSWYgdGhlIHZhbHVlIG9mIGEgY2xhc3MgbmFtZSBiaW5kaW5nIHJldHVybnMgYSBib29sZWFuIHRoZSBwcm9wZXJ0eSBuYW1lCiAgaXRzZWxmIHdpbGwgYmUgdXNlZCBhcyB0aGUgY2xhc3MgbmFtZSBpZiB0aGUgcHJvcGVydHkgaXMgdHJ1ZS4gVGhlIGNsYXNzIG5hbWUKICB3aWxsIG5vdCBiZSBhZGRlZCBpZiB0aGUgdmFsdWUgaXMgYGZhbHNlYCBvciBgdW5kZWZpbmVkYC4KCiAgYGBgamF2YXNjcmlwdAogIE15VmlldyA9IEVtYmVyLlZpZXcuZXh0ZW5kKHsKICAgIGNsYXNzTmFtZUJpbmRpbmdzOiBbJ2hvdmVyZWQnXSwKICAgIGhvdmVyZWQ6IHRydWUKICB9KTsKICBgYGAKCiAgV2lsbCByZXN1bHQgaW4gdmlldyBpbnN0YW5jZXMgd2l0aCBhbiBIVE1MIHJlcHJlc2VudGF0aW9uIG9mOgoKICBgYGBodG1sCiAgPGRpdiBpZD0iZW1iZXIxIiBjbGFzcz0iZW1iZXItdmlldyBob3ZlcmVkIj48L2Rpdj4KICBgYGAKCiAgV2hlbiB1c2luZyBib29sZWFuIGNsYXNzIG5hbWUgYmluZGluZ3MgeW91IGNhbiBzdXBwbHkgYSBzdHJpbmcgdmFsdWUgb3RoZXIKICB0aGFuIHRoZSBwcm9wZXJ0eSBuYW1lIGZvciB1c2UgYXMgdGhlIGBjbGFzc2AgSFRNTCBhdHRyaWJ1dGUgYnkgYXBwZW5kaW5nIHRoZQogIHByZWZlcnJlZCB2YWx1ZSBhZnRlciBhICI6IiBjaGFyYWN0ZXIgd2hlbiBkZWZpbmluZyB0aGUgYmluZGluZzoKCiAgYGBgamF2YXNjcmlwdAogIE15VmlldyA9IEVtYmVyLlZpZXcuZXh0ZW5kKHsKICAgIGNsYXNzTmFtZUJpbmRpbmdzOiBbJ2F3ZXNvbWU6c28tdmVyeS1jb29sJ10sCiAgICBhd2Vzb21lOiB0cnVlCiAgfSk7CiAgYGBgCgogIFdpbGwgcmVzdWx0IGluIHZpZXcgaW5zdGFuY2VzIHdpdGggYW4gSFRNTCByZXByZXNlbnRhdGlvbiBvZjoKCiAgYGBgaHRtbAogIDxkaXYgaWQ9ImVtYmVyMSIgY2xhc3M9ImVtYmVyLXZpZXcgc28tdmVyeS1jb29sIj48L2Rpdj4KICBgYGAKCiAgQm9vbGVhbiB2YWx1ZSBjbGFzcyBuYW1lIGJpbmRpbmdzIHdob3NlIHByb3BlcnR5IG5hbWVzIGFyZSBpbiBhCiAgY2FtZWxDYXNlLXN0eWxlIGZvcm1hdCB3aWxsIGJlIGNvbnZlcnRlZCB0byBhIGRhc2hlcml6ZWQgZm9ybWF0OgoKICBgYGBqYXZhc2NyaXB0CiAgTXlWaWV3ID0gRW1iZXIuVmlldy5leHRlbmQoewogICAgY2xhc3NOYW1lQmluZGluZ3M6IFsnaXNVcmdlbnQnXSwKICAgIGlzVXJnZW50OiB0cnVlCiAgfSk7CiAgYGBgCgogIFdpbGwgcmVzdWx0IGluIHZpZXcgaW5zdGFuY2VzIHdpdGggYW4gSFRNTCByZXByZXNlbnRhdGlvbiBvZjoKCiAgYGBgaHRtbAogIDxkaXYgaWQ9ImVtYmVyMSIgY2xhc3M9ImVtYmVyLXZpZXcgaXMtdXJnZW50Ij48L2Rpdj4KICBgYGAKCiAgQ2xhc3MgbmFtZSBiaW5kaW5ncyBjYW4gYWxzbyByZWZlciB0byBvYmplY3QgdmFsdWVzIHRoYXQgYXJlIGZvdW5kIGJ5CiAgdHJhdmVyc2luZyBhIHBhdGggcmVsYXRpdmUgdG8gdGhlIHZpZXcgaXRzZWxmOgoKICBgYGBqYXZhc2NyaXB0CiAgTXlWaWV3ID0gRW1iZXIuVmlldy5leHRlbmQoewogICAgY2xhc3NOYW1lQmluZGluZ3M6IFsnbWVzc2FnZXMuZW1wdHknXQogICAgbWVzc2FnZXM6IEVtYmVyLk9iamVjdC5jcmVhdGUoewogICAgICBlbXB0eTogdHJ1ZQogICAgfSkKICB9KTsKICBgYGAKCiAgV2lsbCByZXN1bHQgaW4gdmlldyBpbnN0YW5jZXMgd2l0aCBhbiBIVE1MIHJlcHJlc2VudGF0aW9uIG9mOgoKICBgYGBodG1sCiAgPGRpdiBpZD0iZW1iZXIxIiBjbGFzcz0iZW1iZXItdmlldyBlbXB0eSI+PC9kaXY+CiAgYGBgCgogIElmIHlvdSB3YW50IHRvIGFkZCBhIGNsYXNzIG5hbWUgZm9yIGEgcHJvcGVydHkgd2hpY2ggZXZhbHVhdGVzIHRvIHRydWUgYW5kCiAgYW5kIGEgZGlmZmVyZW50IGNsYXNzIG5hbWUgaWYgaXQgZXZhbHVhdGVzIHRvIGZhbHNlLCB5b3UgY2FuIHBhc3MgYSBiaW5kaW5nCiAgbGlrZSB0aGlzOgoKICBgYGBqYXZhc2NyaXB0CiAgLy8gQXBwbGllcyAnZW5hYmxlZCcgY2xhc3Mgd2hlbiBpc0VuYWJsZWQgaXMgdHJ1ZSBhbmQgJ2Rpc2FibGVkJyB3aGVuIGlzRW5hYmxlZCBpcyBmYWxzZQogIEVtYmVyLlZpZXcuZXh0ZW5kKHsKICAgIGNsYXNzTmFtZUJpbmRpbmdzOiBbJ2lzRW5hYmxlZDplbmFibGVkOmRpc2FibGVkJ10KICAgIGlzRW5hYmxlZDogdHJ1ZQogIH0pOwogIGBgYAoKICBXaWxsIHJlc3VsdCBpbiB2aWV3IGluc3RhbmNlcyB3aXRoIGFuIEhUTUwgcmVwcmVzZW50YXRpb24gb2Y6CgogIGBgYGh0bWwKICA8ZGl2IGlkPSJlbWJlcjEiIGNsYXNzPSJlbWJlci12aWV3IGVuYWJsZWQiPjwvZGl2PgogIGBgYAoKICBXaGVuIGlzRW5hYmxlZCBpcyBgZmFsc2VgLCB0aGUgcmVzdWx0aW5nIEhUTUwgcmVwcmVuc2VudGF0aW9uIGxvb2tzIGxpa2UKICB0aGlzOgoKICBgYGBodG1sCiAgPGRpdiBpZD0iZW1iZXIxIiBjbGFzcz0iZW1iZXItdmlldyBkaXNhYmxlZCI+PC9kaXY+CiAgYGBgCgogIFRoaXMgc3ludGF4IG9mZmVycyB0aGUgY29udmVuaWVuY2UgdG8gYWRkIGEgY2xhc3MgaWYgYSBwcm9wZXJ0eSBpcyBgZmFsc2VgOgoKICBgYGBqYXZhc2NyaXB0CiAgLy8gQXBwbGllcyBubyBjbGFzcyB3aGVuIGlzRW5hYmxlZCBpcyB0cnVlIGFuZCBjbGFzcyAnZGlzYWJsZWQnIHdoZW4gaXNFbmFibGVkIGlzIGZhbHNlCiAgRW1iZXIuVmlldy5leHRlbmQoewogICAgY2xhc3NOYW1lQmluZGluZ3M6IFsnaXNFbmFibGVkOjpkaXNhYmxlZCddCiAgICBpc0VuYWJsZWQ6IHRydWUKICB9KTsKICBgYGAKCiAgV2lsbCByZXN1bHQgaW4gdmlldyBpbnN0YW5jZXMgd2l0aCBhbiBIVE1MIHJlcHJlc2VudGF0aW9uIG9mOgoKICBgYGBodG1sCiAgPGRpdiBpZD0iZW1iZXIxIiBjbGFzcz0iZW1iZXItdmlldyI+PC9kaXY+CiAgYGBgCgogIFdoZW4gdGhlIGBpc0VuYWJsZWRgIHByb3BlcnR5IG9uIHRoZSB2aWV3IGlzIHNldCB0byBgZmFsc2VgLCBpdCB3aWxsIHJlc3VsdAogIGluIHZpZXcgaW5zdGFuY2VzIHdpdGggYW4gSFRNTCByZXByZXNlbnRhdGlvbiBvZjoKCiAgYGBgaHRtbAogIDxkaXYgaWQ9ImVtYmVyMSIgY2xhc3M9ImVtYmVyLXZpZXcgZGlzYWJsZWQiPjwvZGl2PgogIGBgYAoKICBVcGRhdGVzIHRvIHRoZSB0aGUgdmFsdWUgb2YgYSBjbGFzcyBuYW1lIGJpbmRpbmcgd2lsbCByZXN1bHQgaW4gYXV0b21hdGljCiAgdXBkYXRlIG9mIHRoZSAgSFRNTCBgY2xhc3NgIGF0dHJpYnV0ZSBpbiB0aGUgdmlldydzIHJlbmRlcmVkIEhUTUwKICByZXByZXNlbnRhdGlvbi4gSWYgdGhlIHZhbHVlIGJlY29tZXMgYGZhbHNlYCBvciBgdW5kZWZpbmVkYCB0aGUgY2xhc3MgbmFtZQogIHdpbGwgYmUgcmVtb3ZlZC4KCiAgQm90aCBgY2xhc3NOYW1lc2AgYW5kIGBjbGFzc05hbWVCaW5kaW5nc2AgYXJlIGNvbmNhdGVuYXRlZCBwcm9wZXJ0aWVzLiBTZWUKICBbRW1iZXIuT2JqZWN0XSgvYXBpL2NsYXNzZXMvRW1iZXIuT2JqZWN0Lmh0bWwpIGRvY3VtZW50YXRpb24gZm9yIG1vcmUKICBpbmZvcm1hdGlvbiBhYm91dCBjb25jYXRlbmF0ZWQgcHJvcGVydGllcy4KCiAgIyMgSFRNTCBBdHRyaWJ1dGVzCgogIFRoZSBIVE1MIGF0dHJpYnV0ZSBzZWN0aW9uIG9mIGEgdmlldydzIHRhZyBjYW4gYmUgc2V0IGJ5IHByb3ZpZGluZyBhbgogIGBhdHRyaWJ1dGVCaW5kaW5nc2AgcHJvcGVydHkgc2V0IHRvIGFuIGFycmF5IG9mIHByb3BlcnR5IG5hbWVzIG9uIHRoZSB2aWV3LgogIFRoZSByZXR1cm4gdmFsdWUgb2YgdGhlc2UgcHJvcGVydGllcyB3aWxsIGJlIHVzZWQgYXMgdGhlIHZhbHVlIG9mIHRoZSB2aWV3J3MKICBIVE1MIGFzc29jaWF0ZWQgYXR0cmlidXRlOgoKICBgYGBqYXZhc2NyaXB0CiAgQW5jaG9yVmlldyA9IEVtYmVyLlZpZXcuZXh0ZW5kKHsKICAgIHRhZ05hbWU6ICdhJywKICAgIGF0dHJpYnV0ZUJpbmRpbmdzOiBbJ2hyZWYnXSwKICAgIGhyZWY6ICdodHRwOi8vZ29vZ2xlLmNvbScKICB9KTsKICBgYGAKCiAgV2lsbCByZXN1bHQgaW4gdmlldyBpbnN0YW5jZXMgd2l0aCBhbiBIVE1MIHJlcHJlc2VudGF0aW9uIG9mOgoKICBgYGBodG1sCiAgPGEgaWQ9ImVtYmVyMSIgY2xhc3M9ImVtYmVyLXZpZXciIGhyZWY9Imh0dHA6Ly9nb29nbGUuY29tIj48L2E+CiAgYGBgCgogIElmIHRoZSByZXR1cm4gdmFsdWUgb2YgYW4gYGF0dHJpYnV0ZUJpbmRpbmdzYCBtb25pdG9yZWQgcHJvcGVydHkgaXMgYSBib29sZWFuCiAgdGhlIHByb3BlcnR5IHdpbGwgZm9sbG93IEhUTUwncyBwYXR0ZXJuIG9mIHJlcGVhdGluZyB0aGUgYXR0cmlidXRlJ3MgbmFtZSBhcwogIGl0cyB2YWx1ZToKCiAgYGBgamF2YXNjcmlwdAogIE15VGV4dElucHV0ID0gRW1iZXIuVmlldy5leHRlbmQoewogICAgdGFnTmFtZTogJ2lucHV0JywKICAgIGF0dHJpYnV0ZUJpbmRpbmdzOiBbJ2Rpc2FibGVkJ10sCiAgICBkaXNhYmxlZDogdHJ1ZQogIH0pOwogIGBgYAoKICBXaWxsIHJlc3VsdCBpbiB2aWV3IGluc3RhbmNlcyB3aXRoIGFuIEhUTUwgcmVwcmVzZW50YXRpb24gb2Y6CgogIGBgYGh0bWwKICA8aW5wdXQgaWQ9ImVtYmVyMSIgY2xhc3M9ImVtYmVyLXZpZXciIGRpc2FibGVkPSJkaXNhYmxlZCIgLz4KICBgYGAKCiAgYGF0dHJpYnV0ZUJpbmRpbmdzYCBjYW4gcmVmZXIgdG8gY29tcHV0ZWQgcHJvcGVydGllczoKCiAgYGBgamF2YXNjcmlwdAogIE15VGV4dElucHV0ID0gRW1iZXIuVmlldy5leHRlbmQoewogICAgdGFnTmFtZTogJ2lucHV0JywKICAgIGF0dHJpYnV0ZUJpbmRpbmdzOiBbJ2Rpc2FibGVkJ10sCiAgICBkaXNhYmxlZDogZnVuY3Rpb24oKSB7CiAgICAgIGlmIChzb21lTG9naWMpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0ucHJvcGVydHkoKQogIH0pOwogIGBgYAoKICBVcGRhdGVzIHRvIHRoZSB0aGUgcHJvcGVydHkgb2YgYW4gYXR0cmlidXRlIGJpbmRpbmcgd2lsbCByZXN1bHQgaW4gYXV0b21hdGljCiAgdXBkYXRlIG9mIHRoZSAgSFRNTCBhdHRyaWJ1dGUgaW4gdGhlIHZpZXcncyByZW5kZXJlZCBIVE1MIHJlcHJlc2VudGF0aW9uLgoKICBgYXR0cmlidXRlQmluZGluZ3NgIGlzIGEgY29uY2F0ZW5hdGVkIHByb3BlcnR5LiBTZWUgW0VtYmVyLk9iamVjdF0oL2FwaS9jbGFzc2VzL0VtYmVyLk9iamVjdC5odG1sKQogIGRvY3VtZW50YXRpb24gZm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgY29uY2F0ZW5hdGVkIHByb3BlcnRpZXMuCgogICMjIFRlbXBsYXRlcwoKICBUaGUgSFRNTCBjb250ZW50cyBvZiBhIHZpZXcncyByZW5kZXJlZCByZXByZXNlbnRhdGlvbiBhcmUgZGV0ZXJtaW5lZCBieSBpdHMKICB0ZW1wbGF0ZS4gVGVtcGxhdGVzIGNhbiBiZSBhbnkgZnVuY3Rpb24gdGhhdCBhY2NlcHRzIGFuIG9wdGlvbmFsIGNvbnRleHQKICBwYXJhbWV0ZXIgYW5kIHJldHVybnMgYSBzdHJpbmcgb2YgSFRNTCB0aGF0IHdpbGwgYmUgaW5zZXJ0ZWQgd2l0aGluIHRoZQogIHZpZXcncyB0YWcuIE1vc3QgdHlwaWNhbGx5IGluIEVtYmVyIHRoaXMgZnVuY3Rpb24gd2lsbCBiZSBhIGNvbXBpbGVkCiAgYEVtYmVyLkhhbmRsZWJhcnNgIHRlbXBsYXRlLgoKICBgYGBqYXZhc2NyaXB0CiAgQVZpZXcgPSBFbWJlci5WaWV3LmV4dGVuZCh7CiAgICB0ZW1wbGF0ZTogRW1iZXIuSGFuZGxlYmFycy5jb21waWxlKCdJIGFtIHRoZSB0ZW1wbGF0ZScpCiAgfSk7CiAgYGBgCgogIFdpbGwgcmVzdWx0IGluIHZpZXcgaW5zdGFuY2VzIHdpdGggYW4gSFRNTCByZXByZXNlbnRhdGlvbiBvZjoKCiAgYGBgaHRtbAogIDxkaXYgaWQ9ImVtYmVyMSIgY2xhc3M9ImVtYmVyLXZpZXciPkkgYW0gdGhlIHRlbXBsYXRlPC9kaXY+CiAgYGBgCgogIFdpdGhpbiBhbiBFbWJlciBhcHBsaWNhdGlvbiBpcyBtb3JlIGNvbW1vbiB0byBkZWZpbmUgYSBIYW5kbGViYXJzIHRlbXBsYXRlcyBhcwogIHBhcnQgb2YgYSBwYWdlOgoKICBgYGBodG1sCiAgPHNjcmlwdCB0eXBlPSd0ZXh0L3gtaGFuZGxlYmFycycgZGF0YS10ZW1wbGF0ZS1uYW1lPSdzb21lLXRlbXBsYXRlJz4KICAgIEhlbGxvCiAgPC9zY3JpcHQ+CiAgYGBgCgogIEFuZCBhc3NvY2lhdGUgaXQgYnkgbmFtZSB1c2luZyBhIHZpZXcncyBgdGVtcGxhdGVOYW1lYCBwcm9wZXJ0eToKCiAgYGBgamF2YXNjcmlwdAogIEFWaWV3ID0gRW1iZXIuVmlldy5leHRlbmQoewogICAgdGVtcGxhdGVOYW1lOiAnc29tZS10ZW1wbGF0ZScKICB9KTsKICBgYGAKCiAgSWYgeW91IGhhdmUgbmVzdGVkIHJlc291cmNlcywgeW91ciBIYW5kbGViYXJzIHRlbXBsYXRlIHdpbGwgbG9vayBsaWtlIHRoaXM6CgogIGBgYGh0bWwKICA8c2NyaXB0IHR5cGU9J3RleHQveC1oYW5kbGViYXJzJyBkYXRhLXRlbXBsYXRlLW5hbWU9J3Bvc3RzL25ldyc+CiAgICA8aDE+TmV3IFBvc3Q8L2gxPgogIDwvc2NyaXB0PgogIGBgYAoKICBBbmQgYHRlbXBsYXRlTmFtZWAgcHJvcGVydHk6CgogIGBgYGphdmFzY3JpcHQKICBBVmlldyA9IEVtYmVyLlZpZXcuZXh0ZW5kKHsKICAgIHRlbXBsYXRlTmFtZTogJ3Bvc3RzL25ldycKICB9KTsKICBgYGAKCiAgVXNpbmcgYSB2YWx1ZSBmb3IgYHRlbXBsYXRlTmFtZWAgdGhhdCBkb2VzIG5vdCBoYXZlIGEgSGFuZGxlYmFycyB0ZW1wbGF0ZQogIHdpdGggYSBtYXRjaGluZyBgZGF0YS10ZW1wbGF0ZS1uYW1lYCBhdHRyaWJ1dGUgd2lsbCB0aHJvdyBhbiBlcnJvci4KCiAgRm9yIHZpZXdzIGNsYXNzZXMgdGhhdCBtYXkgaGF2ZSBhIHRlbXBsYXRlIGxhdGVyIGRlZmluZWQgKGUuZy4gYXMgdGhlIGJsb2NrCiAgcG9ydGlvbiBvZiBhIGB7e3ZpZXd9fWAgSGFuZGxlYmFycyBoZWxwZXIgY2FsbCBpbiBhbm90aGVyIHRlbXBsYXRlIG9yIGluCiAgYSBzdWJjbGFzcyksIHlvdSBjYW4gcHJvdmlkZSBhIGBkZWZhdWx0VGVtcGxhdGVgIHByb3BlcnR5IHNldCB0byBjb21waWxlZAogIHRlbXBsYXRlIGZ1bmN0aW9uLiBJZiBhIHRlbXBsYXRlIGlzIG5vdCBsYXRlciBwcm92aWRlZCBmb3IgdGhlIHZpZXcgaW5zdGFuY2UKICB0aGUgYGRlZmF1bHRUZW1wbGF0ZWAgdmFsdWUgd2lsbCBiZSB1c2VkOgoKICBgYGBqYXZhc2NyaXB0CiAgQVZpZXcgPSBFbWJlci5WaWV3LmV4dGVuZCh7CiAgICBkZWZhdWx0VGVtcGxhdGU6IEVtYmVyLkhhbmRsZWJhcnMuY29tcGlsZSgnSSB3YXMgdGhlIGRlZmF1bHQnKSwKICAgIHRlbXBsYXRlOiBudWxsLAogICAgdGVtcGxhdGVOYW1lOiBudWxsCiAgfSk7CiAgYGBgCgogIFdpbGwgcmVzdWx0IGluIGluc3RhbmNlcyB3aXRoIGFuIEhUTUwgcmVwcmVzZW50YXRpb24gb2Y6CgogIGBgYGh0bWwKICA8ZGl2IGlkPSJlbWJlcjEiIGNsYXNzPSJlbWJlci12aWV3Ij5JIHdhcyB0aGUgZGVmYXVsdDwvZGl2PgogIGBgYAoKICBJZiBhIGB0ZW1wbGF0ZWAgb3IgYHRlbXBsYXRlTmFtZWAgaXMgcHJvdmlkZWQgaXQgd2lsbCB0YWtlIHByZWNlZGVuY2Ugb3ZlcgogIGBkZWZhdWx0VGVtcGxhdGVgOgoKICBgYGBqYXZhc2NyaXB0CiAgQVZpZXcgPSBFbWJlci5WaWV3LmV4dGVuZCh7CiAgICBkZWZhdWx0VGVtcGxhdGU6IEVtYmVyLkhhbmRsZWJhcnMuY29tcGlsZSgnSSB3YXMgdGhlIGRlZmF1bHQnKQogIH0pOwoKICBhVmlldyA9IEFWaWV3LmNyZWF0ZSh7CiAgICB0ZW1wbGF0ZTogRW1iZXIuSGFuZGxlYmFycy5jb21waWxlKCdJIHdhcyB0aGUgdGVtcGxhdGUsIG5vdCBkZWZhdWx0JykKICB9KTsKICBgYGAKCiAgV2lsbCByZXN1bHQgaW4gdGhlIGZvbGxvd2luZyBIVE1MIHJlcHJlc2VudGF0aW9uIHdoZW4gcmVuZGVyZWQ6CgogIGBgYGh0bWwKICA8ZGl2IGlkPSJlbWJlcjEiIGNsYXNzPSJlbWJlci12aWV3Ij5JIHdhcyB0aGUgdGVtcGxhdGUsIG5vdCBkZWZhdWx0PC9kaXY+CiAgYGBgCgogICMjIFZpZXcgQ29udGV4dAoKICBUaGUgZGVmYXVsdCBjb250ZXh0IG9mIHRoZSBjb21waWxlZCB0ZW1wbGF0ZSBpcyB0aGUgdmlldydzIGNvbnRyb2xsZXI6CgogIGBgYGphdmFzY3JpcHQKICBBVmlldyA9IEVtYmVyLlZpZXcuZXh0ZW5kKHsKICAgIHRlbXBsYXRlOiBFbWJlci5IYW5kbGViYXJzLmNvbXBpbGUoJ0hlbGxvIHt7ZXhjaXRlZEdyZWV0aW5nfX0nKQogIH0pOwoKICBhQ29udHJvbGxlciA9IEVtYmVyLk9iamVjdC5jcmVhdGUoewogICAgZmlyc3ROYW1lOiAnQmFycnknLAogICAgZXhjaXRlZEdyZWV0aW5nOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0KCJjb250ZW50LmZpcnN0TmFtZSIpICsgIiEhISIKICAgIH0ucHJvcGVydHkoKQogIH0pOwoKICBhVmlldyA9IEFWaWV3LmNyZWF0ZSh7CiAgICBjb250cm9sbGVyOiBhQ29udHJvbGxlciwKICB9KTsKICBgYGAKCiAgV2lsbCByZXN1bHQgaW4gYW4gSFRNTCByZXByZXNlbnRhdGlvbiBvZjoKCiAgYGBgaHRtbAogIDxkaXYgaWQ9ImVtYmVyMSIgY2xhc3M9ImVtYmVyLXZpZXciPkhlbGxvIEJhcnJ5ISEhPC9kaXY+CiAgYGBgCgogIEEgY29udGV4dCBjYW4gYWxzbyBiZSBleHBsaWNpdGx5IHN1cHBsaWVkIHRocm91Z2ggdGhlIHZpZXcncyBgY29udGV4dGAKICBwcm9wZXJ0eS4gSWYgdGhlIHZpZXcgaGFzIG5laXRoZXIgYGNvbnRleHRgIG5vciBgY29udHJvbGxlcmAgcHJvcGVydGllcywgdGhlCiAgYHBhcmVudFZpZXdgJ3MgY29udGV4dCB3aWxsIGJlIHVzZWQuCgogICMjIExheW91dHMKCiAgVmlld3MgY2FuIGhhdmUgYSBzZWNvbmRhcnkgdGVtcGxhdGUgdGhhdCB3cmFwcyB0aGVpciBtYWluIHRlbXBsYXRlLiBMaWtlCiAgcHJpbWFyeSB0ZW1wbGF0ZXMsIGxheW91dHMgY2FuIGJlIGFueSBmdW5jdGlvbiB0aGF0ICBhY2NlcHRzIGFuIG9wdGlvbmFsCiAgY29udGV4dCBwYXJhbWV0ZXIgYW5kIHJldHVybnMgYSBzdHJpbmcgb2YgSFRNTCB0aGF0IHdpbGwgYmUgaW5zZXJ0ZWQgaW5zaWRlCiAgdmlldydzIHRhZy4gVmlld3Mgd2hvc2UgSFRNTCBlbGVtZW50IGlzIHNlbGYgY2xvc2luZyAoZS5nLiBgPGlucHV0IC8+YCkKICBjYW5ub3QgaGF2ZSBhIGxheW91dCBhbmQgdGhpcyBwcm9wZXJ0eSB3aWxsIGJlIGlnbm9yZWQuCgogIE1vc3QgdHlwaWNhbGx5IGluIEVtYmVyIGEgbGF5b3V0IHdpbGwgYmUgYSBjb21waWxlZCBgRW1iZXIuSGFuZGxlYmFyc2AKICB0ZW1wbGF0ZS4KCiAgQSB2aWV3J3MgbGF5b3V0IGNhbiBiZSBzZXQgZGlyZWN0bHkgd2l0aCB0aGUgYGxheW91dGAgcHJvcGVydHkgb3IgcmVmZXJlbmNlCiAgYW4gZXhpc3RpbmcgSGFuZGxlYmFycyB0ZW1wbGF0ZSBieSBuYW1lIHdpdGggdGhlIGBsYXlvdXROYW1lYCBwcm9wZXJ0eS4KCiAgQSB0ZW1wbGF0ZSB1c2VkIGFzIGEgbGF5b3V0IG11c3QgY29udGFpbiBhIHNpbmdsZSB1c2Ugb2YgdGhlIEhhbmRsZWJhcnMKICBge3t5aWVsZH19YCBoZWxwZXIuIFRoZSBIVE1MIGNvbnRlbnRzIG9mIGEgdmlldydzIHJlbmRlcmVkIGB0ZW1wbGF0ZWAgd2lsbCBiZQogIGluc2VydGVkIGF0IHRoaXMgbG9jYXRpb246CgogIGBgYGphdmFzY3JpcHQKICBBVmlld1dpdGhMYXlvdXQgPSBFbWJlci5WaWV3LmV4dGVuZCh7CiAgICBsYXlvdXQ6IEVtYmVyLkhhbmRsZWJhcnMuY29tcGlsZSgiPGRpdiBjbGFzcz0nbXktZGVjb3JhdGl2ZS1jbGFzcyc+e3t5aWVsZH19PC9kaXY+IikKICAgIHRlbXBsYXRlOiBFbWJlci5IYW5kbGViYXJzLmNvbXBpbGUoIkkgZ290IHdyYXBwZWQiKSwKICB9KTsKICBgYGAKCiAgV2lsbCByZXN1bHQgaW4gdmlldyBpbnN0YW5jZXMgd2l0aCBhbiBIVE1MIHJlcHJlc2VudGF0aW9uIG9mOgoKICBgYGBodG1sCiAgPGRpdiBpZD0iZW1iZXIxIiBjbGFzcz0iZW1iZXItdmlldyI+CiAgICA8ZGl2IGNsYXNzPSJteS1kZWNvcmF0aXZlLWNsYXNzIj4KICAgICAgSSBnb3Qgd3JhcHBlZAogICAgPC9kaXY+CiAgPC9kaXY+CiAgYGBgCgogIFNlZSBbRW1iZXIuSGFuZGxlYmFycy5oZWxwZXJzLnlpZWxkXSgvYXBpL2NsYXNzZXMvRW1iZXIuSGFuZGxlYmFycy5oZWxwZXJzLmh0bWwjbWV0aG9kX3lpZWxkKQogIGZvciBtb3JlIGluZm9ybWF0aW9uLgoKICAjIyBSZXNwb25kaW5nIHRvIEJyb3dzZXIgRXZlbnRzCgogIFZpZXdzIGNhbiByZXNwb25kIHRvIHVzZXItaW5pdGlhdGVkIGV2ZW50cyBpbiBvbmUgb2YgdGhyZWUgd2F5czogbWV0aG9kCiAgaW1wbGVtZW50YXRpb24sIHRocm91Z2ggYW4gZXZlbnQgbWFuYWdlciwgYW5kIHRocm91Z2ggYHt7YWN0aW9ufX1gIGhlbHBlciB1c2UKICBpbiB0aGVpciB0ZW1wbGF0ZSBvciBsYXlvdXQuCgogICMjIyBNZXRob2QgSW1wbGVtZW50YXRpb24KCiAgVmlld3MgY2FuIHJlc3BvbmQgdG8gdXNlci1pbml0aWF0ZWQgZXZlbnRzIGJ5IGltcGxlbWVudGluZyBhIG1ldGhvZCB0aGF0CiAgbWF0Y2hlcyB0aGUgZXZlbnQgbmFtZS4gQSBgalF1ZXJ5LkV2ZW50YCBvYmplY3Qgd2lsbCBiZSBwYXNzZWQgYXMgdGhlCiAgYXJndW1lbnQgdG8gdGhpcyBtZXRob2QuCgogIGBgYGphdmFzY3JpcHQKICBBVmlldyA9IEVtYmVyLlZpZXcuZXh0ZW5kKHsKICAgIGNsaWNrOiBmdW5jdGlvbihldmVudCkgewogICAgICAvLyB3aWxsIGJlIGNhbGxlZCB3aGVuIHdoZW4gYW4gaW5zdGFuY2UncwogICAgICAvLyByZW5kZXJlZCBlbGVtZW50IGlzIGNsaWNrZWQKICAgIH0KICB9KTsKICBgYGAKCiAgIyMjIEV2ZW50IE1hbmFnZXJzCgogIFZpZXdzIGNhbiBkZWZpbmUgYW4gb2JqZWN0IGFzIHRoZWlyIGBldmVudE1hbmFnZXJgIHByb3BlcnR5LiBUaGlzIG9iamVjdCBjYW4KICB0aGVuIGltcGxlbWVudCBtZXRob2RzIHRoYXQgbWF0Y2ggdGhlIGRlc2lyZWQgZXZlbnQgbmFtZXMuIE1hdGNoaW5nIGV2ZW50cwogIHRoYXQgb2NjdXIgb24gdGhlIHZpZXcncyByZW5kZXJlZCBIVE1MIG9yIHRoZSByZW5kZXJlZCBIVE1MIG9mIGFueSBvZiBpdHMgRE9NCiAgZGVzY2VuZGFudHMgd2lsbCB0cmlnZ2VyIHRoaXMgbWV0aG9kLiBBIGBqUXVlcnkuRXZlbnRgIG9iamVjdCB3aWxsIGJlIHBhc3NlZAogIGFzIHRoZSBmaXJzdCBhcmd1bWVudCB0byB0aGUgbWV0aG9kIGFuZCBhbiAgYEVtYmVyLlZpZXdgIG9iamVjdCBhcyB0aGUKICBzZWNvbmQuIFRoZSBgRW1iZXIuVmlld2Agd2lsbCBiZSB0aGUgdmlldyB3aG9zZSByZW5kZXJlZCBIVE1MIHdhcyBpbnRlcmFjdGVkCiAgd2l0aC4gVGhpcyBtYXkgYmUgdGhlIHZpZXcgd2l0aCB0aGUgYGV2ZW50TWFuYWdlcmAgcHJvcGVydHkgb3Igb25lIG9mIGl0cwogIGRlc2NlbmRlbnQgdmlld3MuCgogIGBgYGphdmFzY3JpcHQKICBBVmlldyA9IEVtYmVyLlZpZXcuZXh0ZW5kKHsKICAgIGV2ZW50TWFuYWdlcjogRW1iZXIuT2JqZWN0LmNyZWF0ZSh7CiAgICAgIGRvdWJsZUNsaWNrOiBmdW5jdGlvbihldmVudCwgdmlldykgewogICAgICAgIC8vIHdpbGwgYmUgY2FsbGVkIHdoZW4gd2hlbiBhbiBpbnN0YW5jZSdzCiAgICAgICAgLy8gcmVuZGVyZWQgZWxlbWVudCBvciBhbnkgcmVuZGVyaW5nCiAgICAgICAgLy8gb2YgdGhpcyB2aWV3cydzIGRlc2NlbmRlbnQKICAgICAgICAvLyBlbGVtZW50cyBpcyBjbGlja2VkCiAgICAgIH0KICAgIH0pCiAgfSk7CiAgYGBgCgogIEFuIGV2ZW50IGRlZmluZWQgZm9yIGFuIGV2ZW50IG1hbmFnZXIgdGFrZXMgcHJlY2VkZW5jZSBvdmVyIGV2ZW50cyBvZiB0aGUKICBzYW1lIG5hbWUgaGFuZGxlZCB0aHJvdWdoIG1ldGhvZHMgb24gdGhlIHZpZXcuCgogIGBgYGphdmFzY3JpcHQKICBBVmlldyA9IEVtYmVyLlZpZXcuZXh0ZW5kKHsKICAgIG1vdXNlRW50ZXI6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIC8vIHdpbGwgbmV2ZXIgdHJpZ2dlci4KICAgIH0sCiAgICBldmVudE1hbmFnZXI6IEVtYmVyLk9iamVjdC5jcmVhdGUoewogICAgICBtb3VzZUVudGVyOiBmdW5jdGlvbihldmVudCwgdmlldykgewogICAgICAgIC8vIHRha2VzIHByZWNlZGVuY2Ugb3ZlciBBVmlldyNtb3VzZUVudGVyCiAgICAgIH0KICAgIH0pCiAgfSk7CiAgYGBgCgogIFNpbWlsYXJseSBhIHZpZXcncyBldmVudCBtYW5hZ2VyIHdpbGwgdGFrZSBwcmVjZWRlbmNlIGZvciBldmVudHMgb2YgYW55IHZpZXdzCiAgcmVuZGVyZWQgYXMgYSBkZXNjZW5kZW50LiBBIG1ldGhvZCBuYW1lIHRoYXQgbWF0Y2hlcyBhbiBldmVudCBuYW1lIHdpbGwgbm90CiAgYmUgY2FsbGVkIGlmIHRoZSB2aWV3IGluc3RhbmNlIHdhcyByZW5kZXJlZCBpbnNpZGUgdGhlIEhUTUwgcmVwcmVzZW50YXRpb24gb2YKICBhIHZpZXcgdGhhdCBoYXMgYW4gYGV2ZW50TWFuYWdlcmAgcHJvcGVydHkgZGVmaW5lZCB0aGF0IGhhbmRsZXMgZXZlbnRzIG9mIHRoZQogIG5hbWUuIEV2ZW50cyBub3QgaGFuZGxlZCBieSB0aGUgZXZlbnQgbWFuYWdlciB3aWxsIHN0aWxsIHRyaWdnZXIgbWV0aG9kIGNhbGxzCiAgb24gdGhlIGRlc2NlbmRlbnQuCgogIGBgYGphdmFzY3JpcHQKICBPdXRlclZpZXcgPSBFbWJlci5WaWV3LmV4dGVuZCh7CiAgICB0ZW1wbGF0ZTogRW1iZXIuSGFuZGxlYmFycy5jb21waWxlKCJvdXRlciB7eyN2aWV3IElubmVyVmlld319aW5uZXJ7ey92aWV3fX0gb3V0ZXIiKSwKICAgIGV2ZW50TWFuYWdlcjogRW1iZXIuT2JqZWN0LmNyZWF0ZSh7CiAgICAgIG1vdXNlRW50ZXI6IGZ1bmN0aW9uKGV2ZW50LCB2aWV3KSB7CiAgICAgICAgLy8gdmlldyBtaWdodCBiZSBpbnN0YW5jZSBvZiBlaXRoZXIKICAgICAgICAvLyBPdXRlclZpZXcgb3IgSW5uZXJWaWV3IGRlcGVuZGluZyBvbgogICAgICAgIC8vIHdoZXJlIG9uIHRoZSBwYWdlIHRoZSB1c2VyIGludGVyYWN0aW9uIG9jY3VyZWQKICAgICAgfQogICAgfSkKICB9KTsKCiAgSW5uZXJWaWV3ID0gRW1iZXIuVmlldy5leHRlbmQoewogICAgY2xpY2s6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIC8vIHdpbGwgYmUgY2FsbGVkIGlmIHJlbmRlcmVkIGluc2lkZQogICAgICAvLyBhbiBPdXRlclZpZXcgYmVjYXVzZSBPdXRlclZpZXcncwogICAgICAvLyBldmVudE1hbmFnZXIgZG9lc24ndCBoYW5kbGUgY2xpY2sgZXZlbnRzCiAgICB9LAogICAgbW91c2VFbnRlcjogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgLy8gd2lsbCBuZXZlciBiZSBjYWxsZWQgaWYgcmVuZGVyZWQgaW5zaWRlCiAgICAgIC8vIGFuIE91dGVyVmlldy4KICAgIH0KICB9KTsKICBgYGAKCiAgIyMjIEhhbmRsZWJhcnMgYHt7YWN0aW9ufX1gIEhlbHBlcgoKICBTZWUgW0hhbmRsZWJhcnMuaGVscGVycy5hY3Rpb25dKC9hcGkvY2xhc3Nlcy9FbWJlci5IYW5kbGViYXJzLmhlbHBlcnMuaHRtbCNtZXRob2RfYWN0aW9uKS4KCiAgIyMjIEV2ZW50IE5hbWVzCgogIEFsbCBvZiB0aGUgZXZlbnQgaGFuZGxpbmcgYXBwcm9hY2hlcyBkZXNjcmliZWQgYWJvdmUgcmVzcG9uZCB0byB0aGUgc2FtZSBzZXQKICBvZiBldmVudHMuIFRoZSBuYW1lcyBvZiB0aGUgYnVpbHQtaW4gZXZlbnRzIGFyZSBsaXN0ZWQgYmVsb3cuIChUaGUgaGFzaCBvZgogIGJ1aWx0LWluIGV2ZW50cyBleGlzdHMgaW4gYEVtYmVyLkV2ZW50RGlzcGF0Y2hlcmAuKSBBZGRpdGlvbmFsLCBjdXN0b20gZXZlbnRzCiAgY2FuIGJlIHJlZ2lzdGVyZWQgYnkgdXNpbmcgYEVtYmVyLkFwcGxpY2F0aW9uLmN1c3RvbUV2ZW50c2AuCgogIFRvdWNoIGV2ZW50czoKCiAgKiBgdG91Y2hTdGFydGAKICAqIGB0b3VjaE1vdmVgCiAgKiBgdG91Y2hFbmRgCiAgKiBgdG91Y2hDYW5jZWxgCgogIEtleWJvYXJkIGV2ZW50cwoKICAqIGBrZXlEb3duYAogICogYGtleVVwYAogICogYGtleVByZXNzYAoKICBNb3VzZSBldmVudHMKCiAgKiBgbW91c2VEb3duYAogICogYG1vdXNlVXBgCiAgKiBgY29udGV4dE1lbnVgCiAgKiBgY2xpY2tgCiAgKiBgZG91YmxlQ2xpY2tgCiAgKiBgbW91c2VNb3ZlYAogICogYGZvY3VzSW5gCiAgKiBgZm9jdXNPdXRgCiAgKiBgbW91c2VFbnRlcmAKICAqIGBtb3VzZUxlYXZlYAoKICBGb3JtIGV2ZW50czoKCiAgKiBgc3VibWl0YAogICogYGNoYW5nZWAKICAqIGBmb2N1c0luYAogICogYGZvY3VzT3V0YAogICogYGlucHV0YAoKICBIVE1MNSBkcmFnIGFuZCBkcm9wIGV2ZW50czoKCiAgKiBgZHJhZ1N0YXJ0YAogICogYGRyYWdgCiAgKiBgZHJhZ0VudGVyYAogICogYGRyYWdMZWF2ZWAKICAqIGBkcm9wYAogICogYGRyYWdFbmRgCgogICMjIEhhbmRsZWJhcnMgYHt7dmlld319YCBIZWxwZXIKCiAgT3RoZXIgYEVtYmVyLlZpZXdgIGluc3RhbmNlcyBjYW4gYmUgaW5jbHVkZWQgYXMgcGFydCBvZiBhIHZpZXcncyB0ZW1wbGF0ZSBieQogIHVzaW5nIHRoZSBge3t2aWV3fX1gIEhhbmRsZWJhcnMgaGVscGVyLiBTZWUgW0VtYmVyLkhhbmRsZWJhcnMuaGVscGVycy52aWV3XSgvYXBpL2NsYXNzZXMvRW1iZXIuSGFuZGxlYmFycy5oZWxwZXJzLmh0bWwjbWV0aG9kX3ZpZXcpCiAgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24uCgogIEBjbGFzcyBWaWV3CiAgQG5hbWVzcGFjZSBFbWJlcgogIEBleHRlbmRzIEVtYmVyLkNvcmVWaWV3CiovCkVtYmVyLlZpZXcgPSBFbWJlci5Db3JlVmlldy5leHRlbmQoewoKICBjb25jYXRlbmF0ZWRQcm9wZXJ0aWVzOiBbJ2NsYXNzTmFtZXMnLCAnY2xhc3NOYW1lQmluZGluZ3MnLCAnYXR0cmlidXRlQmluZGluZ3MnXSwKCiAgLyoqCiAgICBAcHJvcGVydHkgaXNWaWV3CiAgICBAdHlwZSBCb29sZWFuCiAgICBAZGVmYXVsdCB0cnVlCiAgICBAc3RhdGljCiAgKi8KICBpc1ZpZXc6IHRydWUsCgogIC8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KICAvLyBURU1QTEFURSBTVVBQT1JUCiAgLy8KCiAgLyoqCiAgICBUaGUgbmFtZSBvZiB0aGUgdGVtcGxhdGUgdG8gbG9va3VwIGlmIG5vIHRlbXBsYXRlIGlzIHByb3ZpZGVkLgoKICAgIEJ5IGRlZmF1bHQgYEVtYmVyLlZpZXdgIHdpbGwgbG9va3VwIGEgdGVtcGxhdGUgd2l0aCB0aGlzIG5hbWUgaW4KICAgIGBFbWJlci5URU1QTEFURVNgIChhIHNoYXJlZCBnbG9iYWwgb2JqZWN0KS4KCiAgICBAcHJvcGVydHkgdGVtcGxhdGVOYW1lCiAgICBAdHlwZSBTdHJpbmcKICAgIEBkZWZhdWx0IG51bGwKICAqLwogIHRlbXBsYXRlTmFtZTogbnVsbCwKCiAgLyoqCiAgICBUaGUgbmFtZSBvZiB0aGUgbGF5b3V0IHRvIGxvb2t1cCBpZiBubyBsYXlvdXQgaXMgcHJvdmlkZWQuCgogICAgQnkgZGVmYXVsdCBgRW1iZXIuVmlld2Agd2lsbCBsb29rdXAgYSB0ZW1wbGF0ZSB3aXRoIHRoaXMgbmFtZSBpbgogICAgYEVtYmVyLlRFTVBMQVRFU2AgKGEgc2hhcmVkIGdsb2JhbCBvYmplY3QpLgoKICAgIEBwcm9wZXJ0eSBsYXlvdXROYW1lCiAgICBAdHlwZSBTdHJpbmcKICAgIEBkZWZhdWx0IG51bGwKICAqLwogIGxheW91dE5hbWU6IG51bGwsCgogIC8qKgogICAgVGhlIHRlbXBsYXRlIHVzZWQgdG8gcmVuZGVyIHRoZSB2aWV3LiBUaGlzIHNob3VsZCBiZSBhIGZ1bmN0aW9uIHRoYXQKICAgIGFjY2VwdHMgYW4gb3B0aW9uYWwgY29udGV4dCBwYXJhbWV0ZXIgYW5kIHJldHVybnMgYSBzdHJpbmcgb2YgSFRNTCB0aGF0CiAgICB3aWxsIGJlIGluc2VydGVkIGludG8gdGhlIERPTSByZWxhdGl2ZSB0byBpdHMgcGFyZW50IHZpZXcuCgogICAgSW4gZ2VuZXJhbCwgeW91IHNob3VsZCBzZXQgdGhlIGB0ZW1wbGF0ZU5hbWVgIHByb3BlcnR5IGluc3RlYWQgb2Ygc2V0dGluZwogICAgdGhlIHRlbXBsYXRlIHlvdXJzZWxmLgoKICAgIEBwcm9wZXJ0eSB0ZW1wbGF0ZQogICAgQHR5cGUgRnVuY3Rpb24KICAqLwogIHRlbXBsYXRlOiBFbWJlci5jb21wdXRlZChmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgeyByZXR1cm4gdmFsdWU7IH0KCiAgICB2YXIgdGVtcGxhdGVOYW1lID0gZ2V0KHRoaXMsICd0ZW1wbGF0ZU5hbWUnKSwKICAgICAgICB0ZW1wbGF0ZSA9IHRoaXMudGVtcGxhdGVGb3JOYW1lKHRlbXBsYXRlTmFtZSwgJ3RlbXBsYXRlJyk7CgogICAgRW1iZXIuYXNzZXJ0KCJZb3Ugc3BlY2lmaWVkIHRoZSB0ZW1wbGF0ZU5hbWUgIiArIHRlbXBsYXRlTmFtZSArICIgZm9yICIgKyB0aGlzICsgIiwgYnV0IGl0IGRpZCBub3QgZXhpc3QuIiwgIXRlbXBsYXRlTmFtZSB8fCB0ZW1wbGF0ZSk7CgogICAgcmV0dXJuIHRlbXBsYXRlIHx8IGdldCh0aGlzLCAnZGVmYXVsdFRlbXBsYXRlJyk7CiAgfSkucHJvcGVydHkoJ3RlbXBsYXRlTmFtZScpLAoKICAvKioKICAgIFRoZSBjb250cm9sbGVyIG1hbmFnaW5nIHRoaXMgdmlldy4gSWYgdGhpcyBwcm9wZXJ0eSBpcyBzZXQsIGl0IHdpbGwgYmUKICAgIG1hZGUgYXZhaWxhYmxlIGZvciB1c2UgYnkgdGhlIHRlbXBsYXRlLgoKICAgIEBwcm9wZXJ0eSBjb250cm9sbGVyCiAgICBAdHlwZSBPYmplY3QKICAqLwogIGNvbnRyb2xsZXI6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uKGtleSkgewogICAgdmFyIHBhcmVudFZpZXcgPSBnZXQodGhpcywgJ19wYXJlbnRWaWV3Jyk7CiAgICByZXR1cm4gcGFyZW50VmlldyA/IGdldChwYXJlbnRWaWV3LCAnY29udHJvbGxlcicpIDogbnVsbDsKICB9KS5wcm9wZXJ0eSgnX3BhcmVudFZpZXcnKSwKCiAgLyoqCiAgICBBIHZpZXcgbWF5IGNvbnRhaW4gYSBsYXlvdXQuIEEgbGF5b3V0IGlzIGEgcmVndWxhciB0ZW1wbGF0ZSBidXQKICAgIHN1cGVyc2VkZXMgdGhlIGB0ZW1wbGF0ZWAgcHJvcGVydHkgZHVyaW5nIHJlbmRlcmluZy4gSXQgaXMgdGhlCiAgICByZXNwb25zaWJpbGl0eSBvZiB0aGUgbGF5b3V0IHRlbXBsYXRlIHRvIHJldHJpZXZlIHRoZSBgdGVtcGxhdGVgCiAgICBwcm9wZXJ0eSBmcm9tIHRoZSB2aWV3IChvciBhbHRlcm5hdGl2ZWx5LCBjYWxsIGBIYW5kbGViYXJzLmhlbHBlcnMueWllbGRgLAogICAgYHt7eWllbGR9fWApIHRvIHJlbmRlciBpdCBpbiB0aGUgY29ycmVjdCBsb2NhdGlvbi4KCiAgICBUaGlzIGlzIHVzZWZ1bCBmb3IgYSB2aWV3IHRoYXQgaGFzIGEgc2hhcmVkIHdyYXBwZXIsIGJ1dCB3aGljaCBkZWxlZ2F0ZXMKICAgIHRoZSByZW5kZXJpbmcgb2YgdGhlIGNvbnRlbnRzIG9mIHRoZSB3cmFwcGVyIHRvIHRoZSBgdGVtcGxhdGVgIHByb3BlcnR5CiAgICBvbiBhIHN1YmNsYXNzLgoKICAgIEBwcm9wZXJ0eSBsYXlvdXQKICAgIEB0eXBlIEZ1bmN0aW9uCiAgKi8KICBsYXlvdXQ6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uKGtleSkgewogICAgdmFyIGxheW91dE5hbWUgPSBnZXQodGhpcywgJ2xheW91dE5hbWUnKSwKICAgICAgICBsYXlvdXQgPSB0aGlzLnRlbXBsYXRlRm9yTmFtZShsYXlvdXROYW1lLCAnbGF5b3V0Jyk7CgogICAgRW1iZXIuYXNzZXJ0KCJZb3Ugc3BlY2lmaWVkIHRoZSBsYXlvdXROYW1lICIgKyBsYXlvdXROYW1lICsgIiBmb3IgIiArIHRoaXMgKyAiLCBidXQgaXQgZGlkIG5vdCBleGlzdC4iLCAhbGF5b3V0TmFtZSB8fCBsYXlvdXQpOwoKICAgIHJldHVybiBsYXlvdXQgfHwgZ2V0KHRoaXMsICdkZWZhdWx0TGF5b3V0Jyk7CiAgfSkucHJvcGVydHkoJ2xheW91dE5hbWUnKSwKCiAgX3lpZWxkOiBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgICB2YXIgdGVtcGxhdGUgPSBnZXQodGhpcywgJ3RlbXBsYXRlJyk7CiAgICBpZiAodGVtcGxhdGUpIHsgdGVtcGxhdGUoY29udGV4dCwgb3B0aW9ucyk7IH0KICB9LAoKICB0ZW1wbGF0ZUZvck5hbWU6IGZ1bmN0aW9uKG5hbWUsIHR5cGUpIHsKICAgIGlmICghbmFtZSkgeyByZXR1cm47IH0KICAgIEVtYmVyLmFzc2VydCgidGVtcGxhdGVOYW1lcyBhcmUgbm90IGFsbG93ZWQgdG8gY29udGFpbiBwZXJpb2RzOiAiK25hbWUsIG5hbWUuaW5kZXhPZignLicpID09PSAtMSk7CgogICAgLy8gdGhlIGRlZmF1bHRDb250YWluZXIgaXMgZGVwcmVjYXRlZAogICAgdmFyIGNvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyIHx8IChFbWJlci5Db250YWluZXIgJiYgRW1iZXIuQ29udGFpbmVyLmRlZmF1bHRDb250YWluZXIpOwogICAgcmV0dXJuIGNvbnRhaW5lciAmJiBjb250YWluZXIubG9va3VwKCd0ZW1wbGF0ZTonICsgbmFtZSk7CiAgfSwKCiAgLyoqCiAgICBUaGUgb2JqZWN0IGZyb20gd2hpY2ggdGVtcGxhdGVzIHNob3VsZCBhY2Nlc3MgcHJvcGVydGllcy4KCiAgICBUaGlzIG9iamVjdCB3aWxsIGJlIHBhc3NlZCB0byB0aGUgdGVtcGxhdGUgZnVuY3Rpb24gZWFjaCB0aW1lIHRoZSByZW5kZXIKICAgIG1ldGhvZCBpcyBjYWxsZWQsIGJ1dCBpdCBpcyB1cCB0byB0aGUgaW5kaXZpZHVhbCBmdW5jdGlvbiB0byBkZWNpZGUgd2hhdAogICAgdG8gZG8gd2l0aCBpdC4KCiAgICBCeSBkZWZhdWx0LCB0aGlzIHdpbGwgYmUgdGhlIHZpZXcncyBjb250cm9sbGVyLgoKICAgIEBwcm9wZXJ0eSBjb250ZXh0CiAgICBAdHlwZSBPYmplY3QKICAqLwogIGNvbnRleHQ6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CiAgICAgIHNldCh0aGlzLCAnX2NvbnRleHQnLCB2YWx1ZSk7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBnZXQodGhpcywgJ19jb250ZXh0Jyk7CiAgICB9CiAgfSkudm9sYXRpbGUoKSwKCiAgLyoqCiAgICBQcml2YXRlIGNvcHkgb2YgdGhlIHZpZXcncyB0ZW1wbGF0ZSBjb250ZXh0LiBUaGlzIGNhbiBiZSBzZXQgZGlyZWN0bHkKICAgIGJ5IEhhbmRsZWJhcnMgd2l0aG91dCB0cmlnZ2VyaW5nIHRoZSBvYnNlcnZlciB0aGF0IGNhdXNlcyB0aGUgdmlldwogICAgdG8gYmUgcmUtcmVuZGVyZWQuCgogICAgVGhlIGNvbnRleHQgb2YgYSB2aWV3IGlzIGxvb2tlZCB1cCBhcyBmb2xsb3dzOgoKICAgIDEuIFN1cHBsaWVkIGNvbnRleHQgKHVzdWFsbHkgYnkgSGFuZGxlYmFycykKICAgIDIuIFNwZWNpZmllZCBjb250cm9sbGVyCiAgICAzLiBgcGFyZW50Vmlld2AncyBjb250ZXh0IChmb3IgYSBjaGlsZCBvZiBhIENvbnRhaW5lclZpZXcpCgogICAgVGhlIGNvZGUgaW4gSGFuZGxlYmFycyB0aGF0IG92ZXJyaWRlcyB0aGUgYF9jb250ZXh0YCBwcm9wZXJ0eSBmaXJzdAogICAgY2hlY2tzIHRvIHNlZSB3aGV0aGVyIHRoZSB2aWV3IGhhcyBhIHNwZWNpZmllZCBjb250cm9sbGVyLiBUaGlzIGlzCiAgICBzb21ldGhpbmcgb2YgYSBoYWNrIGFuZCBzaG91bGQgYmUgcmV2aXNpdGVkLgoKICAgIEBwcm9wZXJ0eSBfY29udGV4dAogICAgQHByaXZhdGUKICAqLwogIF9jb250ZXh0OiBFbWJlci5jb21wdXRlZChmdW5jdGlvbihrZXkpIHsKICAgIHZhciBwYXJlbnRWaWV3LCBjb250cm9sbGVyOwoKICAgIGlmIChjb250cm9sbGVyID0gZ2V0KHRoaXMsICdjb250cm9sbGVyJykpIHsKICAgICAgcmV0dXJuIGNvbnRyb2xsZXI7CiAgICB9CgogICAgcGFyZW50VmlldyA9IHRoaXMuX3BhcmVudFZpZXc7CiAgICBpZiAocGFyZW50VmlldykgewogICAgICByZXR1cm4gZ2V0KHBhcmVudFZpZXcsICdfY29udGV4dCcpOwogICAgfQoKICAgIHJldHVybiBudWxsOwogIH0pLAoKICAvKioKICAgIElmIGEgdmFsdWUgdGhhdCBhZmZlY3RzIHRlbXBsYXRlIHJlbmRlcmluZyBjaGFuZ2VzLCB0aGUgdmlldyBzaG91bGQgYmUKICAgIHJlLXJlbmRlcmVkIHRvIHJlZmxlY3QgdGhlIG5ldyB2YWx1ZS4KCiAgICBAbWV0aG9kIF9jb250ZXh0RGlkQ2hhbmdlCiAgICBAcHJpdmF0ZQogICovCiAgX2NvbnRleHREaWRDaGFuZ2U6IEVtYmVyLm9ic2VydmVyKCdjb250ZXh0JywgZnVuY3Rpb24oKSB7CiAgICB0aGlzLnJlcmVuZGVyKCk7CiAgfSksCgogIC8qKgogICAgSWYgYGZhbHNlYCwgdGhlIHZpZXcgd2lsbCBhcHBlYXIgaGlkZGVuIGluIERPTS4KCiAgICBAcHJvcGVydHkgaXNWaXNpYmxlCiAgICBAdHlwZSBCb29sZWFuCiAgICBAZGVmYXVsdCBudWxsCiAgKi8KICBpc1Zpc2libGU6IHRydWUsCgogIC8qKgogICAgQXJyYXkgb2YgY2hpbGQgdmlld3MuIFlvdSBzaG91bGQgbmV2ZXIgZWRpdCB0aGlzIGFycmF5IGRpcmVjdGx5LgogICAgSW5zdGVhZCwgdXNlIGBhcHBlbmRDaGlsZGAgYW5kIGByZW1vdmVGcm9tUGFyZW50YC4KCiAgICBAcHJvcGVydHkgY2hpbGRWaWV3cwogICAgQHR5cGUgQXJyYXkKICAgIEBkZWZhdWx0IFtdCiAgICBAcHJpdmF0ZQogICovCiAgY2hpbGRWaWV3czogY2hpbGRWaWV3c1Byb3BlcnR5LAoKICBfY2hpbGRWaWV3czogRU1QVFlfQVJSQVksCgogIC8vIFdoZW4gaXQncyBhIHZpcnR1YWwgdmlldywgd2UgbmVlZCB0byBub3RpZnkgdGhlIHBhcmVudCB0aGF0IHRoZWlyCiAgLy8gY2hpbGRWaWV3cyB3aWxsIGNoYW5nZS4KICBfY2hpbGRWaWV3c1dpbGxDaGFuZ2U6IEVtYmVyLmJlZm9yZU9ic2VydmVyKCdjaGlsZFZpZXdzJywgZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5pc1ZpcnR1YWwpIHsKICAgICAgdmFyIHBhcmVudFZpZXcgPSBnZXQodGhpcywgJ3BhcmVudFZpZXcnKTsKICAgICAgaWYgKHBhcmVudFZpZXcpIHsgRW1iZXIucHJvcGVydHlXaWxsQ2hhbmdlKHBhcmVudFZpZXcsICdjaGlsZFZpZXdzJyk7IH0KICAgIH0KICB9KSwKCiAgLy8gV2hlbiBpdCdzIGEgdmlydHVhbCB2aWV3LCB3ZSBuZWVkIHRvIG5vdGlmeSB0aGUgcGFyZW50IHRoYXQgdGhlaXIKICAvLyBjaGlsZFZpZXdzIGRpZCBjaGFuZ2UuCiAgX2NoaWxkVmlld3NEaWRDaGFuZ2U6IEVtYmVyLm9ic2VydmVyKCdjaGlsZFZpZXdzJywgZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5pc1ZpcnR1YWwpIHsKICAgICAgdmFyIHBhcmVudFZpZXcgPSBnZXQodGhpcywgJ3BhcmVudFZpZXcnKTsKICAgICAgaWYgKHBhcmVudFZpZXcpIHsgRW1iZXIucHJvcGVydHlEaWRDaGFuZ2UocGFyZW50VmlldywgJ2NoaWxkVmlld3MnKTsgfQogICAgfQogIH0pLAoKICAvKioKICAgIFJldHVybiB0aGUgbmVhcmVzdCBhbmNlc3RvciB0aGF0IGlzIGFuIGluc3RhbmNlIG9mIHRoZSBwcm92aWRlZAogICAgY2xhc3MuCgogICAgQHByb3BlcnR5IG5lYXJlc3RJbnN0YW5jZU9mCiAgICBAcGFyYW0ge0NsYXNzfSBrbGFzcyBTdWJjbGFzcyBvZiBFbWJlci5WaWV3IChvciBFbWJlci5WaWV3IGl0c2VsZikKICAgIEByZXR1cm4gRW1iZXIuVmlldwogICAgQGRlcHJlY2F0ZWQKICAqLwogIG5lYXJlc3RJbnN0YW5jZU9mOiBmdW5jdGlvbihrbGFzcykgewogICAgRW1iZXIuZGVwcmVjYXRlKCJuZWFyZXN0SW5zdGFuY2VPZiBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgZnJvbSBmdXR1cmUgcmVsZWFzZXMuIFVzZSBuZWFyZXN0T2ZUeXBlLiIpOwogICAgdmFyIHZpZXcgPSBnZXQodGhpcywgJ3BhcmVudFZpZXcnKTsKCiAgICB3aGlsZSAodmlldykgewogICAgICBpZiAodmlldyBpbnN0YW5jZW9mIGtsYXNzKSB7IHJldHVybiB2aWV3OyB9CiAgICAgIHZpZXcgPSBnZXQodmlldywgJ3BhcmVudFZpZXcnKTsKICAgIH0KICB9LAoKICAvKioKICAgIFJldHVybiB0aGUgbmVhcmVzdCBhbmNlc3RvciB0aGF0IGlzIGFuIGluc3RhbmNlIG9mIHRoZSBwcm92aWRlZAogICAgY2xhc3Mgb3IgbWl4aW4uCgogICAgQHByb3BlcnR5IG5lYXJlc3RPZlR5cGUKICAgIEBwYXJhbSB7Q2xhc3MsTWl4aW59IGtsYXNzIFN1YmNsYXNzIG9mIEVtYmVyLlZpZXcgKG9yIEVtYmVyLlZpZXcgaXRzZWxmKSwKICAgICAgICAgICBvciBhbiBpbnN0YW5jZSBvZiBFbWJlci5NaXhpbi4KICAgIEByZXR1cm4gRW1iZXIuVmlldwogICovCiAgbmVhcmVzdE9mVHlwZTogZnVuY3Rpb24oa2xhc3MpIHsKICAgIHZhciB2aWV3ID0gZ2V0KHRoaXMsICdwYXJlbnRWaWV3JyksCiAgICAgICAgaXNPZlR5cGUgPSBrbGFzcyBpbnN0YW5jZW9mIEVtYmVyLk1peGluID8KICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKHZpZXcpIHsgcmV0dXJuIGtsYXNzLmRldGVjdCh2aWV3KTsgfSA6CiAgICAgICAgICAgICAgICAgICBmdW5jdGlvbih2aWV3KSB7IHJldHVybiBrbGFzcy5kZXRlY3Qodmlldy5jb25zdHJ1Y3Rvcik7IH07CgogICAgd2hpbGUgKHZpZXcpIHsKICAgICAgaWYgKGlzT2ZUeXBlKHZpZXcpKSB7IHJldHVybiB2aWV3OyB9CiAgICAgIHZpZXcgPSBnZXQodmlldywgJ3BhcmVudFZpZXcnKTsKICAgIH0KICB9LAoKICAvKioKICAgIFJldHVybiB0aGUgbmVhcmVzdCBhbmNlc3RvciB0aGF0IGhhcyBhIGdpdmVuIHByb3BlcnR5LgoKICAgIEBmdW5jdGlvbiBuZWFyZXN0V2l0aFByb3BlcnR5CiAgICBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkgQSBwcm9wZXJ0eSBuYW1lCiAgICBAcmV0dXJuIEVtYmVyLlZpZXcKICAqLwogIG5lYXJlc3RXaXRoUHJvcGVydHk6IGZ1bmN0aW9uKHByb3BlcnR5KSB7CiAgICB2YXIgdmlldyA9IGdldCh0aGlzLCAncGFyZW50VmlldycpOwoKICAgIHdoaWxlICh2aWV3KSB7CiAgICAgIGlmIChwcm9wZXJ0eSBpbiB2aWV3KSB7IHJldHVybiB2aWV3OyB9CiAgICAgIHZpZXcgPSBnZXQodmlldywgJ3BhcmVudFZpZXcnKTsKICAgIH0KICB9LAoKICAvKioKICAgIFJldHVybiB0aGUgbmVhcmVzdCBhbmNlc3RvciB3aG9zZSBwYXJlbnQgaXMgYW4gaW5zdGFuY2Ugb2YKICAgIGBrbGFzc2AuCgogICAgQG1ldGhvZCBuZWFyZXN0Q2hpbGRPZgogICAgQHBhcmFtIHtDbGFzc30ga2xhc3MgU3ViY2xhc3Mgb2YgRW1iZXIuVmlldyAob3IgRW1iZXIuVmlldyBpdHNlbGYpCiAgICBAcmV0dXJuIEVtYmVyLlZpZXcKICAqLwogIG5lYXJlc3RDaGlsZE9mOiBmdW5jdGlvbihrbGFzcykgewogICAgdmFyIHZpZXcgPSBnZXQodGhpcywgJ3BhcmVudFZpZXcnKTsKCiAgICB3aGlsZSAodmlldykgewogICAgICBpZiAoZ2V0KHZpZXcsICdwYXJlbnRWaWV3JykgaW5zdGFuY2VvZiBrbGFzcykgeyByZXR1cm4gdmlldzsgfQogICAgICB2aWV3ID0gZ2V0KHZpZXcsICdwYXJlbnRWaWV3Jyk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICBXaGVuIHRoZSBwYXJlbnQgdmlldyBjaGFuZ2VzLCByZWN1cnNpdmVseSBpbnZhbGlkYXRlIGBjb250cm9sbGVyYAoKICAgIEBtZXRob2QgX3BhcmVudFZpZXdEaWRDaGFuZ2UKICAgIEBwcml2YXRlCiAgKi8KICBfcGFyZW50Vmlld0RpZENoYW5nZTogRW1iZXIub2JzZXJ2ZXIoJ19wYXJlbnRWaWV3JywgZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5pc0Rlc3Ryb3lpbmcpIHsgcmV0dXJuOyB9CgogICAgdGhpcy50cmlnZ2VyKCdwYXJlbnRWaWV3RGlkQ2hhbmdlJyk7CgogICAgaWYgKGdldCh0aGlzLCAncGFyZW50Vmlldy5jb250cm9sbGVyJykgJiYgIWdldCh0aGlzLCAnY29udHJvbGxlcicpKSB7CiAgICAgIHRoaXMubm90aWZ5UHJvcGVydHlDaGFuZ2UoJ2NvbnRyb2xsZXInKTsKICAgIH0KICB9KSwKCiAgX2NvbnRyb2xsZXJEaWRDaGFuZ2U6IEVtYmVyLm9ic2VydmVyKCdjb250cm9sbGVyJywgZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5pc0Rlc3Ryb3lpbmcpIHsgcmV0dXJuOyB9CgogICAgdGhpcy5yZXJlbmRlcigpOwoKICAgIHRoaXMuZm9yRWFjaENoaWxkVmlldyhmdW5jdGlvbih2aWV3KSB7CiAgICAgIHZpZXcucHJvcGVydHlEaWRDaGFuZ2UoJ2NvbnRyb2xsZXInKTsKICAgIH0pOwogIH0pLAoKICBjbG9uZUtleXdvcmRzOiBmdW5jdGlvbigpIHsKICAgIHZhciB0ZW1wbGF0ZURhdGEgPSBnZXQodGhpcywgJ3RlbXBsYXRlRGF0YScpOwoKICAgIHZhciBrZXl3b3JkcyA9IHRlbXBsYXRlRGF0YSA/IEVtYmVyLmNvcHkodGVtcGxhdGVEYXRhLmtleXdvcmRzKSA6IHt9OwogICAgc2V0KGtleXdvcmRzLCAndmlldycsIGdldCh0aGlzLCAnY29uY3JldGVWaWV3JykpOwogICAgc2V0KGtleXdvcmRzLCAnX3ZpZXcnLCB0aGlzKTsKICAgIHNldChrZXl3b3JkcywgJ2NvbnRyb2xsZXInLCBnZXQodGhpcywgJ2NvbnRyb2xsZXInKSk7CgogICAgcmV0dXJuIGtleXdvcmRzOwogIH0sCgogIC8qKgogICAgQ2FsbGVkIG9uIHlvdXIgdmlldyB3aGVuIGl0IHNob3VsZCBwdXNoIHN0cmluZ3Mgb2YgSFRNTCBpbnRvIGEKICAgIGBFbWJlci5SZW5kZXJCdWZmZXJgLiBNb3N0IHVzZXJzIHdpbGwgd2FudCB0byBvdmVycmlkZSB0aGUgYHRlbXBsYXRlYAogICAgb3IgYHRlbXBsYXRlTmFtZWAgcHJvcGVydGllcyBpbnN0ZWFkIG9mIHRoaXMgbWV0aG9kLgoKICAgIEJ5IGRlZmF1bHQsIGBFbWJlci5WaWV3YCB3aWxsIGxvb2sgZm9yIGEgZnVuY3Rpb24gaW4gdGhlIGB0ZW1wbGF0ZWAKICAgIHByb3BlcnR5IGFuZCBpbnZva2UgaXQgd2l0aCB0aGUgdmFsdWUgb2YgYGNvbnRleHRgLiBUaGUgdmFsdWUgb2YKICAgIGBjb250ZXh0YCB3aWxsIGJlIHRoZSB2aWV3J3MgY29udHJvbGxlciB1bmxlc3MgeW91IG92ZXJyaWRlIGl0LgoKICAgIEBtZXRob2QgcmVuZGVyCiAgICBAcGFyYW0ge0VtYmVyLlJlbmRlckJ1ZmZlcn0gYnVmZmVyIFRoZSByZW5kZXIgYnVmZmVyCiAgKi8KICByZW5kZXI6IGZ1bmN0aW9uKGJ1ZmZlcikgewogICAgLy8gSWYgdGhpcyB2aWV3IGhhcyBhIGxheW91dCwgaXQgaXMgdGhlIHJlc3BvbnNpYmlsaXR5IG9mIHRoZQogICAgLy8gdGhlIGxheW91dCB0byByZW5kZXIgdGhlIHZpZXcncyB0ZW1wbGF0ZS4gT3RoZXJ3aXNlLCByZW5kZXIgdGhlIHRlbXBsYXRlCiAgICAvLyBkaXJlY3RseS4KICAgIHZhciB0ZW1wbGF0ZSA9IGdldCh0aGlzLCAnbGF5b3V0JykgfHwgZ2V0KHRoaXMsICd0ZW1wbGF0ZScpOwoKICAgIGlmICh0ZW1wbGF0ZSkgewogICAgICB2YXIgY29udGV4dCA9IGdldCh0aGlzLCAnY29udGV4dCcpOwogICAgICB2YXIga2V5d29yZHMgPSB0aGlzLmNsb25lS2V5d29yZHMoKTsKICAgICAgdmFyIG91dHB1dDsKCiAgICAgIHZhciBkYXRhID0gewogICAgICAgIHZpZXc6IHRoaXMsCiAgICAgICAgYnVmZmVyOiBidWZmZXIsCiAgICAgICAgaXNSZW5kZXJEYXRhOiB0cnVlLAogICAgICAgIGtleXdvcmRzOiBrZXl3b3JkcywKICAgICAgICBpbnNpZGVHcm91cDogZ2V0KHRoaXMsICd0ZW1wbGF0ZURhdGEuaW5zaWRlR3JvdXAnKQogICAgICB9OwoKICAgICAgLy8gSW52b2tlIHRoZSB0ZW1wbGF0ZSB3aXRoIHRoZSBwcm92aWRlZCB0ZW1wbGF0ZSBjb250ZXh0LCB3aGljaAogICAgICAvLyBpcyB0aGUgdmlldydzIGNvbnRyb2xsZXIgYnkgZGVmYXVsdC4gQSBoYXNoIG9mIGRhdGEgaXMgYWxzbyBwYXNzZWQgdGhhdCBwcm92aWRlcwogICAgICAvLyB0aGUgdGVtcGxhdGUgd2l0aCBhY2Nlc3MgdG8gdGhlIHZpZXcgYW5kIHJlbmRlciBidWZmZXIuCgogICAgICBFbWJlci5hc3NlcnQoJ3RlbXBsYXRlIG11c3QgYmUgYSBmdW5jdGlvbi4gRGlkIHlvdSBtZWFuIHRvIGNhbGwgRW1iZXIuSGFuZGxlYmFycy5jb21waWxlKCIuLi4iKSBvciBzcGVjaWZ5IHRlbXBsYXRlTmFtZSBpbnN0ZWFkPycsIHR5cGVvZiB0ZW1wbGF0ZSA9PT0gJ2Z1bmN0aW9uJyk7CiAgICAgIC8vIFRoZSB0ZW1wbGF0ZSBzaG91bGQgd3JpdGUgZGlyZWN0bHkgdG8gdGhlIHJlbmRlciBidWZmZXIgaW5zdGVhZAogICAgICAvLyBvZiByZXR1cm5pbmcgYSBzdHJpbmcuCiAgICAgIG91dHB1dCA9IHRlbXBsYXRlKGNvbnRleHQsIHsgZGF0YTogZGF0YSB9KTsKCiAgICAgIC8vIElmIHRoZSB0ZW1wbGF0ZSByZXR1cm5lZCBhIHN0cmluZyBpbnN0ZWFkIG9mIHdyaXRpbmcgdG8gdGhlIGJ1ZmZlciwKICAgICAgLy8gcHVzaCB0aGUgc3RyaW5nIG9udG8gdGhlIGJ1ZmZlci4KICAgICAgaWYgKG91dHB1dCAhPT0gdW5kZWZpbmVkKSB7IGJ1ZmZlci5wdXNoKG91dHB1dCk7IH0KICAgIH0KICB9LAoKICAvKioKICAgIFJlbmRlcnMgdGhlIHZpZXcgYWdhaW4uIFRoaXMgd2lsbCB3b3JrIHJlZ2FyZGxlc3Mgb2Ygd2hldGhlciB0aGUKICAgIHZpZXcgaXMgYWxyZWFkeSBpbiB0aGUgRE9NIG9yIG5vdC4gSWYgdGhlIHZpZXcgaXMgaW4gdGhlIERPTSwgdGhlCiAgICByZW5kZXJpbmcgcHJvY2VzcyB3aWxsIGJlIGRlZmVycmVkIHRvIGdpdmUgYmluZGluZ3MgYSBjaGFuY2UKICAgIHRvIHN5bmNocm9uaXplLgoKICAgIElmIGNoaWxkcmVuIHdlcmUgYWRkZWQgZHVyaW5nIHRoZSByZW5kZXJpbmcgcHJvY2VzcyB1c2luZyBgYXBwZW5kQ2hpbGRgLAogICAgYHJlcmVuZGVyYCB3aWxsIHJlbW92ZSB0aGVtLCBiZWNhdXNlIHRoZXkgd2lsbCBiZSBhZGRlZCBhZ2FpbgogICAgaWYgbmVlZGVkIGJ5IHRoZSBuZXh0IGByZW5kZXJgLgoKICAgIEluIGdlbmVyYWwsIGlmIHRoZSBkaXNwbGF5IG9mIHlvdXIgdmlldyBjaGFuZ2VzLCB5b3Ugc2hvdWxkIG1vZGlmeQogICAgdGhlIERPTSBlbGVtZW50IGRpcmVjdGx5IGluc3RlYWQgb2YgbWFudWFsbHkgY2FsbGluZyBgcmVyZW5kZXJgLCB3aGljaCBjYW4KICAgIGJlIHNsb3cuCgogICAgQG1ldGhvZCByZXJlbmRlcgogICovCiAgcmVyZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuY3VycmVudFN0YXRlLnJlcmVuZGVyKHRoaXMpOwogIH0sCgogIGNsZWFyUmVuZGVyZWRDaGlsZHJlbjogZnVuY3Rpb24oKSB7CiAgICB2YXIgbGVuZ3RoQmVmb3JlID0gdGhpcy5sZW5ndGhCZWZvcmVSZW5kZXIsCiAgICAgICAgbGVuZ3RoQWZ0ZXIgID0gdGhpcy5sZW5ndGhBZnRlclJlbmRlcjsKCiAgICAvLyBJZiB0aGVyZSB3ZXJlIGNoaWxkIHZpZXdzIGNyZWF0ZWQgZHVyaW5nIHRoZSBsYXN0IGNhbGwgdG8gcmVuZGVyKCksCiAgICAvLyByZW1vdmUgdGhlbSB1bmRlciB0aGUgYXNzdW1wdGlvbiB0aGF0IHRoZXkgd2lsbCBiZSByZS1jcmVhdGVkIHdoZW4KICAgIC8vIHdlIHJlLXJlbmRlci4KCiAgICAvLyBWSUVXLVRPRE86IFVuaXQgdGVzdCB0aGlzIHBhdGguCiAgICB2YXIgY2hpbGRWaWV3cyA9IHRoaXMuX2NoaWxkVmlld3M7CiAgICBmb3IgKHZhciBpPWxlbmd0aEFmdGVyLTE7IGk+PWxlbmd0aEJlZm9yZTsgaS0tKSB7CiAgICAgIGlmIChjaGlsZFZpZXdzW2ldKSB7IGNoaWxkVmlld3NbaV0uZGVzdHJveSgpOyB9CiAgICB9CiAgfSwKCiAgLyoqCiAgICBJdGVyYXRlcyBvdmVyIHRoZSB2aWV3J3MgYGNsYXNzTmFtZUJpbmRpbmdzYCBhcnJheSwgaW5zZXJ0cyB0aGUgdmFsdWUKICAgIG9mIHRoZSBzcGVjaWZpZWQgcHJvcGVydHkgaW50byB0aGUgYGNsYXNzTmFtZXNgIGFycmF5LCB0aGVuIGNyZWF0ZXMgYW4KICAgIG9ic2VydmVyIHRvIHVwZGF0ZSB0aGUgdmlldydzIGVsZW1lbnQgaWYgdGhlIGJvdW5kIHByb3BlcnR5IGV2ZXIgY2hhbmdlcwogICAgaW4gdGhlIGZ1dHVyZS4KCiAgICBAbWV0aG9kIF9hcHBseUNsYXNzTmFtZUJpbmRpbmdzCiAgICBAcHJpdmF0ZQogICovCiAgX2FwcGx5Q2xhc3NOYW1lQmluZGluZ3M6IGZ1bmN0aW9uKGNsYXNzQmluZGluZ3MpIHsKICAgIHZhciBjbGFzc05hbWVzID0gdGhpcy5jbGFzc05hbWVzLAogICAgZWxlbSwgbmV3Q2xhc3MsIGRhc2hlcml6ZWRDbGFzczsKCiAgICAvLyBMb29wIHRocm91Z2ggYWxsIG9mIHRoZSBjb25maWd1cmVkIGJpbmRpbmdzLiBUaGVzZSB3aWxsIGJlIGVpdGhlcgogICAgLy8gcHJvcGVydHkgbmFtZXMgKCdpc1VyZ2VudCcpIG9yIHByb3BlcnR5IHBhdGhzIHJlbGF0aXZlIHRvIHRoZSB2aWV3CiAgICAvLyAoJ2NvbnRlbnQuaXNVcmdlbnQnKQogICAgYV9mb3JFYWNoKGNsYXNzQmluZGluZ3MsIGZ1bmN0aW9uKGJpbmRpbmcpIHsKCiAgICAgIC8vIFZhcmlhYmxlIGluIHdoaWNoIHRoZSBvbGQgY2xhc3MgdmFsdWUgaXMgc2F2ZWQuIFRoZSBvYnNlcnZlciBmdW5jdGlvbgogICAgICAvLyBjbG9zZXMgb3ZlciB0aGlzIHZhcmlhYmxlLCBzbyBpdCBrbm93cyB3aGljaCBzdHJpbmcgdG8gcmVtb3ZlIHdoZW4KICAgICAgLy8gdGhlIHByb3BlcnR5IGNoYW5nZXMuCiAgICAgIHZhciBvbGRDbGFzczsKICAgICAgLy8gRXh0cmFjdCBqdXN0IHRoZSBwcm9wZXJ0eSBuYW1lIGZyb20gYmluZGluZ3MgbGlrZSAnZm9vOmJhcicKICAgICAgdmFyIHBhcnNlZFBhdGggPSBFbWJlci5WaWV3Ll9wYXJzZVByb3BlcnR5UGF0aChiaW5kaW5nKTsKCiAgICAgIC8vIFNldCB1cCBhbiBvYnNlcnZlciBvbiB0aGUgY29udGV4dC4gSWYgdGhlIHByb3BlcnR5IGNoYW5nZXMsIHRvZ2dsZSB0aGUKICAgICAgLy8gY2xhc3MgbmFtZS4KICAgICAgdmFyIG9ic2VydmVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gR2V0IHRoZSBjdXJyZW50IHZhbHVlIG9mIHRoZSBwcm9wZXJ0eQogICAgICAgIG5ld0NsYXNzID0gdGhpcy5fY2xhc3NTdHJpbmdGb3JQcm9wZXJ0eShiaW5kaW5nKTsKICAgICAgICBlbGVtID0gdGhpcy4kKCk7CgogICAgICAgIC8vIElmIHdlIGhhZCBwcmV2aW91c2x5IGFkZGVkIGEgY2xhc3MgdG8gdGhlIGVsZW1lbnQsIHJlbW92ZSBpdC4KICAgICAgICBpZiAob2xkQ2xhc3MpIHsKICAgICAgICAgIGVsZW0ucmVtb3ZlQ2xhc3Mob2xkQ2xhc3MpOwogICAgICAgICAgLy8gQWxzbyByZW1vdmUgZnJvbSBjbGFzc05hbWVzIHNvIHRoYXQgaWYgdGhlIHZpZXcgZ2V0cyByZXJlbmRlcmVkLAogICAgICAgICAgLy8gdGhlIGNsYXNzIGRvZXNuJ3QgZ2V0IGFkZGVkIGJhY2sgdG8gdGhlIERPTS4KICAgICAgICAgIGNsYXNzTmFtZXMucmVtb3ZlT2JqZWN0KG9sZENsYXNzKTsKICAgICAgICB9CgogICAgICAgIC8vIElmIG5lY2Vzc2FyeSwgYWRkIGEgbmV3IGNsYXNzLiBNYWtlIHN1cmUgd2Uga2VlcCB0cmFjayBvZiBpdCBzbwogICAgICAgIC8vIGl0IGNhbiBiZSByZW1vdmVkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgaWYgKG5ld0NsYXNzKSB7CiAgICAgICAgICBlbGVtLmFkZENsYXNzKG5ld0NsYXNzKTsKICAgICAgICAgIG9sZENsYXNzID0gbmV3Q2xhc3M7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9sZENsYXNzID0gbnVsbDsKICAgICAgICB9CiAgICAgIH07CgogICAgICAvLyBHZXQgdGhlIGNsYXNzIG5hbWUgZm9yIHRoZSBwcm9wZXJ0eSBhdCBpdHMgY3VycmVudCB2YWx1ZQogICAgICBkYXNoZXJpemVkQ2xhc3MgPSB0aGlzLl9jbGFzc1N0cmluZ0ZvclByb3BlcnR5KGJpbmRpbmcpOwoKICAgICAgaWYgKGRhc2hlcml6ZWRDbGFzcykgewogICAgICAgIC8vIEVuc3VyZSB0aGF0IGl0IGdldHMgaW50byB0aGUgY2xhc3NOYW1lcyBhcnJheQogICAgICAgIC8vIHNvIGl0IGlzIGRpc3BsYXllZCB3aGVuIHdlIHJlbmRlci4KICAgICAgICBhX2FkZE9iamVjdChjbGFzc05hbWVzLCBkYXNoZXJpemVkQ2xhc3MpOwoKICAgICAgICAvLyBTYXZlIGEgcmVmZXJlbmNlIHRvIHRoZSBjbGFzcyBuYW1lIHNvIHdlIGNhbiByZW1vdmUgaXQKICAgICAgICAvLyBpZiB0aGUgb2JzZXJ2ZXIgZmlyZXMuIFJlbWVtYmVyIHRoYXQgdGhpcyB2YXJpYWJsZSBoYXMKICAgICAgICAvLyBiZWVuIGNsb3NlZCBvdmVyIGJ5IHRoZSBvYnNlcnZlci4KICAgICAgICBvbGRDbGFzcyA9IGRhc2hlcml6ZWRDbGFzczsKICAgICAgfQoKICAgICAgdGhpcy5yZWdpc3Rlck9ic2VydmVyKHRoaXMsIHBhcnNlZFBhdGgucGF0aCwgb2JzZXJ2ZXIpOwogICAgICAvLyBSZW1vdmUgY2xhc3NOYW1lIHNvIHdoZW4gdGhlIHZpZXcgaXMgcmVyZW5kZXJlZCwKICAgICAgLy8gdGhlIGNsYXNzTmFtZSBpcyBhZGRlZCBiYXNlZCBvbiBiaW5kaW5nIHJlZXZhbHVhdGlvbgogICAgICB0aGlzLm9uZSgnd2lsbENsZWFyUmVuZGVyJywgZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKG9sZENsYXNzKSB7CiAgICAgICAgICBjbGFzc05hbWVzLnJlbW92ZU9iamVjdChvbGRDbGFzcyk7CiAgICAgICAgICBvbGRDbGFzcyA9IG51bGw7CiAgICAgICAgfQogICAgICB9KTsKCiAgICB9LCB0aGlzKTsKICB9LAoKICAvKioKICAgIEl0ZXJhdGVzIHRocm91Z2ggdGhlIHZpZXcncyBhdHRyaWJ1dGUgYmluZGluZ3MsIHNldHMgdXAgb2JzZXJ2ZXJzIGZvciBlYWNoLAogICAgdGhlbiBhcHBsaWVzIHRoZSBjdXJyZW50IHZhbHVlIG9mIHRoZSBhdHRyaWJ1dGVzIHRvIHRoZSBwYXNzZWQgcmVuZGVyIGJ1ZmZlci4KCiAgICBAbWV0aG9kIF9hcHBseUF0dHJpYnV0ZUJpbmRpbmdzCiAgICBAcGFyYW0ge0VtYmVyLlJlbmRlckJ1ZmZlcn0gYnVmZmVyCiAgICBAcHJpdmF0ZQogICovCiAgX2FwcGx5QXR0cmlidXRlQmluZGluZ3M6IGZ1bmN0aW9uKGJ1ZmZlciwgYXR0cmlidXRlQmluZGluZ3MpIHsKICAgIHZhciBhdHRyaWJ1dGVWYWx1ZSwgZWxlbTsKCiAgICBhX2ZvckVhY2goYXR0cmlidXRlQmluZGluZ3MsIGZ1bmN0aW9uKGJpbmRpbmcpIHsKICAgICAgdmFyIHNwbGl0ID0gYmluZGluZy5zcGxpdCgnOicpLAogICAgICAgICAgcHJvcGVydHkgPSBzcGxpdFswXSwKICAgICAgICAgIGF0dHJpYnV0ZU5hbWUgPSBzcGxpdFsxXSB8fCBwcm9wZXJ0eTsKCiAgICAgIC8vIENyZWF0ZSBhbiBvYnNlcnZlciB0byBhZGQvcmVtb3ZlL2NoYW5nZSB0aGUgYXR0cmlidXRlIGlmIHRoZQogICAgICAvLyBKYXZhU2NyaXB0IHByb3BlcnR5IGNoYW5nZXMuCiAgICAgIHZhciBvYnNlcnZlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIGVsZW0gPSB0aGlzLiQoKTsKCiAgICAgICAgYXR0cmlidXRlVmFsdWUgPSBnZXQodGhpcywgcHJvcGVydHkpOwoKICAgICAgICBFbWJlci5WaWV3LmFwcGx5QXR0cmlidXRlQmluZGluZ3MoZWxlbSwgYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlVmFsdWUpOwogICAgICB9OwoKICAgICAgdGhpcy5yZWdpc3Rlck9ic2VydmVyKHRoaXMsIHByb3BlcnR5LCBvYnNlcnZlcik7CgogICAgICAvLyBEZXRlcm1pbmUgdGhlIGN1cnJlbnQgdmFsdWUgYW5kIGFkZCBpdCB0byB0aGUgcmVuZGVyIGJ1ZmZlcgogICAgICAvLyBpZiBuZWNlc3NhcnkuCiAgICAgIGF0dHJpYnV0ZVZhbHVlID0gZ2V0KHRoaXMsIHByb3BlcnR5KTsKICAgICAgRW1iZXIuVmlldy5hcHBseUF0dHJpYnV0ZUJpbmRpbmdzKGJ1ZmZlciwgYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlVmFsdWUpOwogICAgfSwgdGhpcyk7CiAgfSwKCiAgLyoqCiAgICBHaXZlbiBhIHByb3BlcnR5IG5hbWUsIHJldHVybnMgYSBkYXNoZXJpemVkIHZlcnNpb24gb2YgdGhhdAogICAgcHJvcGVydHkgbmFtZSBpZiB0aGUgcHJvcGVydHkgZXZhbHVhdGVzIHRvIGEgbm9uLWZhbHN5IHZhbHVlLgoKICAgIEZvciBleGFtcGxlLCBpZiB0aGUgdmlldyBoYXMgcHJvcGVydHkgYGlzVXJnZW50YCB0aGF0IGV2YWx1YXRlcyB0byB0cnVlLAogICAgcGFzc2luZyBgaXNVcmdlbnRgIHRvIHRoaXMgbWV0aG9kIHdpbGwgcmV0dXJuIGAiaXMtdXJnZW50ImAuCgogICAgQG1ldGhvZCBfY2xhc3NTdHJpbmdGb3JQcm9wZXJ0eQogICAgQHBhcmFtIHByb3BlcnR5CiAgICBAcHJpdmF0ZQogICovCiAgX2NsYXNzU3RyaW5nRm9yUHJvcGVydHk6IGZ1bmN0aW9uKHByb3BlcnR5KSB7CiAgICB2YXIgcGFyc2VkUGF0aCA9IEVtYmVyLlZpZXcuX3BhcnNlUHJvcGVydHlQYXRoKHByb3BlcnR5KTsKICAgIHZhciBwYXRoID0gcGFyc2VkUGF0aC5wYXRoOwoKICAgIHZhciB2YWwgPSBnZXQodGhpcywgcGF0aCk7CiAgICBpZiAodmFsID09PSB1bmRlZmluZWQgJiYgRW1iZXIuaXNHbG9iYWxQYXRoKHBhdGgpKSB7CiAgICAgIHZhbCA9IGdldChFbWJlci5sb29rdXAsIHBhdGgpOwogICAgfQoKICAgIHJldHVybiBFbWJlci5WaWV3Ll9jbGFzc1N0cmluZ0ZvclZhbHVlKHBhdGgsIHZhbCwgcGFyc2VkUGF0aC5jbGFzc05hbWUsIHBhcnNlZFBhdGguZmFsc3lDbGFzc05hbWUpOwogIH0sCgogIC8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KICAvLyBFTEVNRU5UIFNVUFBPUlQKICAvLwoKICAvKioKICAgIFJldHVybnMgdGhlIGN1cnJlbnQgRE9NIGVsZW1lbnQgZm9yIHRoZSB2aWV3LgoKICAgIEBwcm9wZXJ0eSBlbGVtZW50CiAgICBAdHlwZSBET01FbGVtZW50CiAgKi8KICBlbGVtZW50OiBFbWJlci5jb21wdXRlZChmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm4gdGhpcy5jdXJyZW50U3RhdGUuc2V0RWxlbWVudCh0aGlzLCB2YWx1ZSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdGhpcy5jdXJyZW50U3RhdGUuZ2V0RWxlbWVudCh0aGlzKTsKICAgIH0KICB9KS5wcm9wZXJ0eSgnX3BhcmVudFZpZXcnKSwKCiAgLyoqCiAgICBSZXR1cm5zIGEgalF1ZXJ5IG9iamVjdCBmb3IgdGhpcyB2aWV3J3MgZWxlbWVudC4gSWYgeW91IHBhc3MgaW4gYSBzZWxlY3RvcgogICAgc3RyaW5nLCB0aGlzIG1ldGhvZCB3aWxsIHJldHVybiBhIGpRdWVyeSBvYmplY3QsIHVzaW5nIHRoZSBjdXJyZW50IGVsZW1lbnQKICAgIGFzIGl0cyBidWZmZXIuCgogICAgRm9yIGV4YW1wbGUsIGNhbGxpbmcgYHZpZXcuJCgnbGknKWAgd2lsbCByZXR1cm4gYSBqUXVlcnkgb2JqZWN0IGNvbnRhaW5pbmcKICAgIGFsbCBvZiB0aGUgYGxpYCBlbGVtZW50cyBpbnNpZGUgdGhlIERPTSBlbGVtZW50IG9mIHRoaXMgdmlldy4KCiAgICBAbWV0aG9kICQKICAgIEBwYXJhbSB7U3RyaW5nfSBbc2VsZWN0b3JdIGEgalF1ZXJ5LWNvbXBhdGlibGUgc2VsZWN0b3Igc3RyaW5nCiAgICBAcmV0dXJuIHtqUXVlcnl9IHRoZSBqUXVlcnkgb2JqZWN0IGZvciB0aGUgRE9NIG5vZGUKICAqLwogICQ6IGZ1bmN0aW9uKHNlbCkgewogICAgcmV0dXJuIHRoaXMuY3VycmVudFN0YXRlLiQodGhpcywgc2VsKTsKICB9LAoKICBtdXRhdGVDaGlsZFZpZXdzOiBmdW5jdGlvbihjYWxsYmFjaykgewogICAgdmFyIGNoaWxkVmlld3MgPSB0aGlzLl9jaGlsZFZpZXdzLAogICAgICAgIGlkeCA9IGNoaWxkVmlld3MubGVuZ3RoLAogICAgICAgIHZpZXc7CgogICAgd2hpbGUoLS1pZHggPj0gMCkgewogICAgICB2aWV3ID0gY2hpbGRWaWV3c1tpZHhdOwogICAgICBjYWxsYmFjayh0aGlzLCB2aWV3LCBpZHgpOwogICAgfQoKICAgIHJldHVybiB0aGlzOwogIH0sCgogIGZvckVhY2hDaGlsZFZpZXc6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICB2YXIgY2hpbGRWaWV3cyA9IHRoaXMuX2NoaWxkVmlld3M7CgogICAgaWYgKCFjaGlsZFZpZXdzKSB7IHJldHVybiB0aGlzOyB9CgogICAgdmFyIGxlbiA9IGNoaWxkVmlld3MubGVuZ3RoLAogICAgICAgIHZpZXcsIGlkeDsKCiAgICBmb3IgKGlkeCA9IDA7IGlkeCA8IGxlbjsgaWR4KyspIHsKICAgICAgdmlldyA9IGNoaWxkVmlld3NbaWR4XTsKICAgICAgY2FsbGJhY2sodmlldyk7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICBBcHBlbmRzIHRoZSB2aWV3J3MgZWxlbWVudCB0byB0aGUgc3BlY2lmaWVkIHBhcmVudCBlbGVtZW50LgoKICAgIElmIHRoZSB2aWV3IGRvZXMgbm90IGhhdmUgYW4gSFRNTCByZXByZXNlbnRhdGlvbiB5ZXQsIGBjcmVhdGVFbGVtZW50KClgCiAgICB3aWxsIGJlIGNhbGxlZCBhdXRvbWF0aWNhbGx5LgoKICAgIE5vdGUgdGhhdCB0aGlzIG1ldGhvZCBqdXN0IHNjaGVkdWxlcyB0aGUgdmlldyB0byBiZSBhcHBlbmRlZDsgdGhlIERPTQogICAgZWxlbWVudCB3aWxsIG5vdCBiZSBhcHBlbmRlZCB0byB0aGUgZ2l2ZW4gZWxlbWVudCB1bnRpbCBhbGwgYmluZGluZ3MgaGF2ZQogICAgZmluaXNoZWQgc3luY2hyb25pemluZy4KCiAgICBUaGlzIGlzIG5vdCB0eXBpY2FsbHkgYSBmdW5jdGlvbiB0aGF0IHlvdSB3aWxsIG5lZWQgdG8gY2FsbCBkaXJlY3RseSB3aGVuCiAgICBidWlsZGluZyB5b3VyIGFwcGxpY2F0aW9uLiBZb3UgbWlnaHQgY29uc2lkZXIgdXNpbmcgYEVtYmVyLkNvbnRhaW5lclZpZXdgCiAgICBpbnN0ZWFkLiBJZiB5b3UgZG8gbmVlZCB0byB1c2UgYGFwcGVuZFRvYCwgYmUgc3VyZSB0aGF0IHRoZSB0YXJnZXQgZWxlbWVudAogICAgeW91IGFyZSBwcm92aWRpbmcgaXMgYXNzb2NpYXRlZCB3aXRoIGFuIGBFbWJlci5BcHBsaWNhdGlvbmAgYW5kIGRvZXMgbm90CiAgICBoYXZlIGFuIGFuY2VzdG9yIGVsZW1lbnQgdGhhdCBpcyBhc3NvY2lhdGVkIHdpdGggYW4gRW1iZXIgdmlldy4KCiAgICBAbWV0aG9kIGFwcGVuZFRvCiAgICBAcGFyYW0ge1N0cmluZ3xET01FbGVtZW50fGpRdWVyeX0gQSBzZWxlY3RvciwgZWxlbWVudCwgSFRNTCBzdHJpbmcsIG9yIGpRdWVyeSBvYmplY3QKICAgIEByZXR1cm4ge0VtYmVyLlZpZXd9IHJlY2VpdmVyCiAgKi8KICBhcHBlbmRUbzogZnVuY3Rpb24odGFyZ2V0KSB7CiAgICAvLyBTY2hlZHVsZSB0aGUgRE9NIGVsZW1lbnQgdG8gYmUgY3JlYXRlZCBhbmQgYXBwZW5kZWQgdG8gdGhlIGdpdmVuCiAgICAvLyBlbGVtZW50IGFmdGVyIGJpbmRpbmdzIGhhdmUgc3luY2hyb25pemVkLgogICAgdGhpcy5faW5zZXJ0RWxlbWVudExhdGVyKGZ1bmN0aW9uKCkgewogICAgICBFbWJlci5hc3NlcnQoIllvdSB0cmllZCB0byBhcHBlbmQgdG8gKCIgKyB0YXJnZXQgKyAiKSBidXQgdGhhdCBpc24ndCBpbiB0aGUgRE9NIiwgRW1iZXIuJCh0YXJnZXQpLmxlbmd0aCA+IDApOwogICAgICBFbWJlci5hc3NlcnQoIllvdSBjYW5ub3QgYXBwZW5kIHRvIGFuIGV4aXN0aW5nIEVtYmVyLlZpZXcuIENvbnNpZGVyIHVzaW5nIEVtYmVyLkNvbnRhaW5lclZpZXcgaW5zdGVhZC4iLCAhRW1iZXIuJCh0YXJnZXQpLmlzKCcuZW1iZXItdmlldycpICYmICFFbWJlci4kKHRhcmdldCkucGFyZW50cygpLmlzKCcuZW1iZXItdmlldycpKTsKICAgICAgdGhpcy4kKCkuYXBwZW5kVG8odGFyZ2V0KTsKICAgIH0pOwoKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAgUmVwbGFjZXMgdGhlIGNvbnRlbnQgb2YgdGhlIHNwZWNpZmllZCBwYXJlbnQgZWxlbWVudCB3aXRoIHRoaXMgdmlldydzCiAgICBlbGVtZW50LiBJZiB0aGUgdmlldyBkb2VzIG5vdCBoYXZlIGFuIEhUTUwgcmVwcmVzZW50YXRpb24geWV0LAogICAgYGNyZWF0ZUVsZW1lbnQoKWAgd2lsbCBiZSBjYWxsZWQgYXV0b21hdGljYWxseS4KCiAgICBOb3RlIHRoYXQgdGhpcyBtZXRob2QganVzdCBzY2hlZHVsZXMgdGhlIHZpZXcgdG8gYmUgYXBwZW5kZWQ7IHRoZSBET00KICAgIGVsZW1lbnQgd2lsbCBub3QgYmUgYXBwZW5kZWQgdG8gdGhlIGdpdmVuIGVsZW1lbnQgdW50aWwgYWxsIGJpbmRpbmdzIGhhdmUKICAgIGZpbmlzaGVkIHN5bmNocm9uaXppbmcKCiAgICBAbWV0aG9kIHJlcGxhY2VJbgogICAgQHBhcmFtIHtTdHJpbmd8RE9NRWxlbWVudHxqUXVlcnl9IHRhcmdldCBBIHNlbGVjdG9yLCBlbGVtZW50LCBIVE1MIHN0cmluZywgb3IgalF1ZXJ5IG9iamVjdAogICAgQHJldHVybiB7RW1iZXIuVmlld30gcmVjZWl2ZWQKICAqLwogIHJlcGxhY2VJbjogZnVuY3Rpb24odGFyZ2V0KSB7CiAgICBFbWJlci5hc3NlcnQoIllvdSB0cmllZCB0byByZXBsYWNlIGluICgiICsgdGFyZ2V0ICsgIikgYnV0IHRoYXQgaXNuJ3QgaW4gdGhlIERPTSIsIEVtYmVyLiQodGFyZ2V0KS5sZW5ndGggPiAwKTsKICAgIEVtYmVyLmFzc2VydCgiWW91IGNhbm5vdCByZXBsYWNlIGFuIGV4aXN0aW5nIEVtYmVyLlZpZXcuIENvbnNpZGVyIHVzaW5nIEVtYmVyLkNvbnRhaW5lclZpZXcgaW5zdGVhZC4iLCAhRW1iZXIuJCh0YXJnZXQpLmlzKCcuZW1iZXItdmlldycpICYmICFFbWJlci4kKHRhcmdldCkucGFyZW50cygpLmlzKCcuZW1iZXItdmlldycpKTsKCiAgICB0aGlzLl9pbnNlcnRFbGVtZW50TGF0ZXIoZnVuY3Rpb24oKSB7CiAgICAgIEVtYmVyLiQodGFyZ2V0KS5lbXB0eSgpOwogICAgICB0aGlzLiQoKS5hcHBlbmRUbyh0YXJnZXQpOwogICAgfSk7CgogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICBTY2hlZHVsZXMgYSBET00gb3BlcmF0aW9uIHRvIG9jY3VyIGR1cmluZyB0aGUgbmV4dCByZW5kZXIgcGhhc2UuIFRoaXMKICAgIGVuc3VyZXMgdGhhdCBhbGwgYmluZGluZ3MgaGF2ZSBmaW5pc2hlZCBzeW5jaHJvbml6aW5nIGJlZm9yZSB0aGUgdmlldyBpcwogICAgcmVuZGVyZWQuCgogICAgVG8gdXNlLCBwYXNzIGEgZnVuY3Rpb24gdGhhdCBwZXJmb3JtcyBhIERPTSBvcGVyYXRpb24uCgogICAgQmVmb3JlIHlvdXIgZnVuY3Rpb24gaXMgY2FsbGVkLCB0aGlzIHZpZXcgYW5kIGFsbCBjaGlsZCB2aWV3cyB3aWxsIHJlY2VpdmUKICAgIHRoZSBgd2lsbEluc2VydEVsZW1lbnRgIGV2ZW50LiBBZnRlciB5b3VyIGZ1bmN0aW9uIGlzIGludm9rZWQsIHRoaXMgdmlldwogICAgYW5kIGFsbCBvZiBpdHMgY2hpbGQgdmlld3Mgd2lsbCByZWNlaXZlIHRoZSBgZGlkSW5zZXJ0RWxlbWVudGAgZXZlbnQuCgogICAgYGBgamF2YXNjcmlwdAogICAgdmlldy5faW5zZXJ0RWxlbWVudExhdGVyKGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmNyZWF0ZUVsZW1lbnQoKTsKICAgICAgdGhpcy4kKCkuYXBwZW5kVG8oJ2JvZHknKTsKICAgIH0pOwogICAgYGBgCgogICAgQG1ldGhvZCBfaW5zZXJ0RWxlbWVudExhdGVyCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBmbiB0aGUgZnVuY3Rpb24gdGhhdCBpbnNlcnRzIHRoZSBlbGVtZW50IGludG8gdGhlIERPTQogICAgQHByaXZhdGUKICAqLwogIF9pbnNlcnRFbGVtZW50TGF0ZXI6IGZ1bmN0aW9uKGZuKSB7CiAgICB0aGlzLl9zY2hlZHVsZWRJbnNlcnQgPSBFbWJlci5ydW4uc2NoZWR1bGVPbmNlKCdyZW5kZXInLCB0aGlzLCAnX2luc2VydEVsZW1lbnQnLCBmbik7CiAgfSwKCiAgX2luc2VydEVsZW1lbnQ6IGZ1bmN0aW9uIChmbikgewogICAgdGhpcy5fc2NoZWR1bGVkSW5zZXJ0ID0gbnVsbDsKICAgIHRoaXMuY3VycmVudFN0YXRlLmluc2VydEVsZW1lbnQodGhpcywgZm4pOwogIH0sCgogIC8qKgogICAgQXBwZW5kcyB0aGUgdmlldydzIGVsZW1lbnQgdG8gdGhlIGRvY3VtZW50IGJvZHkuIElmIHRoZSB2aWV3IGRvZXMKICAgIG5vdCBoYXZlIGFuIEhUTUwgcmVwcmVzZW50YXRpb24geWV0LCBgY3JlYXRlRWxlbWVudCgpYCB3aWxsIGJlIGNhbGxlZAogICAgYXV0b21hdGljYWxseS4KCiAgICBJZiB5b3VyIGFwcGxpY2F0aW9uIHVzZXMgdGhlIGByb290RWxlbWVudGAgcHJvcGVydHksIHlvdSBtdXN0IGFwcGVuZAogICAgdGhlIHZpZXcgd2l0aGluIHRoYXQgZWxlbWVudC4gUmVuZGVyaW5nIHZpZXdzIG91dHNpZGUgb2YgdGhlIGByb290RWxlbWVudGAKICAgIGlzIG5vdCBzdXBwb3J0ZWQuCgogICAgTm90ZSB0aGF0IHRoaXMgbWV0aG9kIGp1c3Qgc2NoZWR1bGVzIHRoZSB2aWV3IHRvIGJlIGFwcGVuZGVkOyB0aGUgRE9NCiAgICBlbGVtZW50IHdpbGwgbm90IGJlIGFwcGVuZGVkIHRvIHRoZSBkb2N1bWVudCBib2R5IHVudGlsIGFsbCBiaW5kaW5ncyBoYXZlCiAgICBmaW5pc2hlZCBzeW5jaHJvbml6aW5nLgoKICAgIEBtZXRob2QgYXBwZW5kCiAgICBAcmV0dXJuIHtFbWJlci5WaWV3fSByZWNlaXZlcgogICovCiAgYXBwZW5kOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmFwcGVuZFRvKGRvY3VtZW50LmJvZHkpOwogIH0sCgogIC8qKgogICAgUmVtb3ZlcyB0aGUgdmlldydzIGVsZW1lbnQgZnJvbSB0aGUgZWxlbWVudCB0byB3aGljaCBpdCBpcyBhdHRhY2hlZC4KCiAgICBAbWV0aG9kIHJlbW92ZQogICAgQHJldHVybiB7RW1iZXIuVmlld30gcmVjZWl2ZXIKICAqLwogIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAvLyBXaGF0IHdlIHNob3VsZCByZWFsbHkgZG8gaGVyZSBpcyB3YWl0IHVudGlsIHRoZSBlbmQgb2YgdGhlIHJ1biBsb29wCiAgICAvLyB0byBkZXRlcm1pbmUgaWYgdGhlIGVsZW1lbnQgaGFzIGJlZW4gcmUtYXBwZW5kZWQgdG8gYSBkaWZmZXJlbnQKICAgIC8vIGVsZW1lbnQuCiAgICAvLyBJbiB0aGUgaW50ZXJpbSwgd2Ugd2lsbCBqdXN0IHJlLXJlbmRlciBpZiB0aGF0IGhhcHBlbnMuIEl0IGlzIG1vcmUKICAgIC8vIGltcG9ydGFudCB0aGFuIGVsZW1lbnRzIGdldCBnYXJiYWdlIGNvbGxlY3RlZC4KICAgIGlmICghdGhpcy5yZW1vdmVkRnJvbURPTSkgeyB0aGlzLmRlc3Ryb3lFbGVtZW50KCk7IH0KICAgIHRoaXMuaW52b2tlUmVjdXJzaXZlbHkoZnVuY3Rpb24odmlldykgewogICAgICBpZiAodmlldy5jbGVhclJlbmRlcmVkQ2hpbGRyZW4pIHsgdmlldy5jbGVhclJlbmRlcmVkQ2hpbGRyZW4oKTsgfQogICAgfSk7CiAgfSwKCiAgZWxlbWVudElkOiBudWxsLAoKICAvKioKICAgIEF0dGVtcHRzIHRvIGRpc2NvdmVyIHRoZSBlbGVtZW50IGluIHRoZSBwYXJlbnQgZWxlbWVudC4gVGhlIGRlZmF1bHQKICAgIGltcGxlbWVudGF0aW9uIGxvb2tzIGZvciBhbiBlbGVtZW50IHdpdGggYW4gSUQgb2YgYGVsZW1lbnRJZGAgKG9yIHRoZQogICAgdmlldydzIGd1aWQgaWYgYGVsZW1lbnRJZGAgaXMgbnVsbCkuIFlvdSBjYW4gb3ZlcnJpZGUgdGhpcyBtZXRob2QgdG8KICAgIHByb3ZpZGUgeW91ciBvd24gZm9ybSBvZiBsb29rdXAuIEZvciBleGFtcGxlLCBpZiB5b3Ugd2FudCB0byBkaXNjb3ZlciB5b3VyCiAgICBlbGVtZW50IHVzaW5nIGEgQ1NTIGNsYXNzIG5hbWUgaW5zdGVhZCBvZiBhbiBJRC4KCiAgICBAbWV0aG9kIGZpbmRFbGVtZW50SW5QYXJlbnRFbGVtZW50CiAgICBAcGFyYW0ge0RPTUVsZW1lbnR9IHBhcmVudEVsZW1lbnQgVGhlIHBhcmVudCdzIERPTSBlbGVtZW50CiAgICBAcmV0dXJuIHtET01FbGVtZW50fSBUaGUgZGlzY292ZXJlZCBlbGVtZW50CiAgKi8KICBmaW5kRWxlbWVudEluUGFyZW50RWxlbWVudDogZnVuY3Rpb24ocGFyZW50RWxlbSkgewogICAgdmFyIGlkID0gIiMiICsgdGhpcy5lbGVtZW50SWQ7CiAgICByZXR1cm4gRW1iZXIuJChpZClbMF0gfHwgRW1iZXIuJChpZCwgcGFyZW50RWxlbSlbMF07CiAgfSwKCiAgLyoqCiAgICBDcmVhdGVzIGEgRE9NIHJlcHJlc2VudGF0aW9uIG9mIHRoZSB2aWV3IGFuZCBhbGwgb2YgaXRzCiAgICBjaGlsZCB2aWV3cyBieSByZWN1cnNpdmVseSBjYWxsaW5nIHRoZSBgcmVuZGVyKClgIG1ldGhvZC4KCiAgICBBZnRlciB0aGUgZWxlbWVudCBoYXMgYmVlbiBjcmVhdGVkLCBgZGlkSW5zZXJ0RWxlbWVudGAgd2lsbAogICAgYmUgY2FsbGVkIG9uIHRoaXMgdmlldyBhbmQgYWxsIG9mIGl0cyBjaGlsZCB2aWV3cy4KCiAgICBAbWV0aG9kIGNyZWF0ZUVsZW1lbnQKICAgIEByZXR1cm4ge0VtYmVyLlZpZXd9IHJlY2VpdmVyCiAgKi8KICBjcmVhdGVFbGVtZW50OiBmdW5jdGlvbigpIHsKICAgIGlmIChnZXQodGhpcywgJ2VsZW1lbnQnKSkgeyByZXR1cm4gdGhpczsgfQoKICAgIHZhciBidWZmZXIgPSB0aGlzLnJlbmRlclRvQnVmZmVyKCk7CiAgICBzZXQodGhpcywgJ2VsZW1lbnQnLCBidWZmZXIuZWxlbWVudCgpKTsKCiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvKioKICAgIENhbGxlZCB3aGVuIGEgdmlldyBpcyBnb2luZyB0byBpbnNlcnQgYW4gZWxlbWVudCBpbnRvIHRoZSBET00uCgogICAgQGV2ZW50IHdpbGxJbnNlcnRFbGVtZW50CiAgKi8KICB3aWxsSW5zZXJ0RWxlbWVudDogRW1iZXIuSywKCiAgLyoqCiAgICBDYWxsZWQgd2hlbiB0aGUgZWxlbWVudCBvZiB0aGUgdmlldyBoYXMgYmVlbiBpbnNlcnRlZCBpbnRvIHRoZSBET00KICAgIG9yIGFmdGVyIHRoZSB2aWV3IHdhcyByZS1yZW5kZXJlZC4gT3ZlcnJpZGUgdGhpcyBmdW5jdGlvbiB0byBkbyBhbnkKICAgIHNldCB1cCB0aGF0IHJlcXVpcmVzIGFuIGVsZW1lbnQgaW4gdGhlIGRvY3VtZW50IGJvZHkuCgogICAgQGV2ZW50IGRpZEluc2VydEVsZW1lbnQKICAqLwogIGRpZEluc2VydEVsZW1lbnQ6IEVtYmVyLkssCgogIC8qKgogICAgQ2FsbGVkIHdoZW4gdGhlIHZpZXcgaXMgYWJvdXQgdG8gcmVyZW5kZXIsIGJ1dCBiZWZvcmUgYW55dGhpbmcgaGFzCiAgICBiZWVuIHRvcm4gZG93bi4gVGhpcyBpcyBhIGdvb2Qgb3Bwb3J0dW5pdHkgdG8gdGVhciBkb3duIGFueSBtYW51YWwKICAgIG9ic2VydmVycyB5b3UgaGF2ZSBpbnN0YWxsZWQgYmFzZWQgb24gdGhlIERPTSBzdGF0ZQoKICAgIEBldmVudCB3aWxsQ2xlYXJSZW5kZXIKICAqLwogIHdpbGxDbGVhclJlbmRlcjogRW1iZXIuSywKCiAgLyoqCiAgICBSdW4gdGhpcyBjYWxsYmFjayBvbiB0aGUgY3VycmVudCB2aWV3ICh1bmxlc3MgaW5jbHVkZVNlbGYgaXMgZmFsc2UpIGFuZCByZWN1cnNpdmVseSBvbiBjaGlsZCB2aWV3cy4KCiAgICBAbWV0aG9kIGludm9rZVJlY3Vyc2l2ZWx5CiAgICBAcGFyYW0gZm4ge0Z1bmN0aW9ufQogICAgQHBhcmFtIGluY2x1ZGVTZWxmIHtCb29sZWFufSBJbmNsdWRlcyBpdHNlbGYgaWYgdHJ1ZS4KICAgIEBwcml2YXRlCiAgKi8KICBpbnZva2VSZWN1cnNpdmVseTogZnVuY3Rpb24oZm4sIGluY2x1ZGVTZWxmKSB7CiAgICB2YXIgY2hpbGRWaWV3cyA9IChpbmNsdWRlU2VsZiA9PT0gZmFsc2UpID8gdGhpcy5fY2hpbGRWaWV3cyA6IFt0aGlzXTsKICAgIHZhciBjdXJyZW50Vmlld3MsIHZpZXcsIGN1cnJlbnRDaGlsZFZpZXdzOwoKICAgIHdoaWxlIChjaGlsZFZpZXdzLmxlbmd0aCkgewogICAgICBjdXJyZW50Vmlld3MgPSBjaGlsZFZpZXdzLnNsaWNlKCk7CiAgICAgIGNoaWxkVmlld3MgPSBbXTsKCiAgICAgIGZvciAodmFyIGk9MCwgbD1jdXJyZW50Vmlld3MubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIHZpZXcgPSBjdXJyZW50Vmlld3NbaV07CiAgICAgICAgY3VycmVudENoaWxkVmlld3MgPSB2aWV3Ll9jaGlsZFZpZXdzID8gdmlldy5fY2hpbGRWaWV3cy5zbGljZSgwKSA6IG51bGw7CiAgICAgICAgZm4odmlldyk7CiAgICAgICAgaWYgKGN1cnJlbnRDaGlsZFZpZXdzKSB7CiAgICAgICAgICBjaGlsZFZpZXdzLnB1c2guYXBwbHkoY2hpbGRWaWV3cywgY3VycmVudENoaWxkVmlld3MpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0sCgogIHRyaWdnZXJSZWN1cnNpdmVseTogZnVuY3Rpb24oZXZlbnROYW1lKSB7CiAgICB2YXIgY2hpbGRWaWV3cyA9IFt0aGlzXSwgY3VycmVudFZpZXdzLCB2aWV3LCBjdXJyZW50Q2hpbGRWaWV3czsKCiAgICB3aGlsZSAoY2hpbGRWaWV3cy5sZW5ndGgpIHsKICAgICAgY3VycmVudFZpZXdzID0gY2hpbGRWaWV3cy5zbGljZSgpOwogICAgICBjaGlsZFZpZXdzID0gW107CgogICAgICBmb3IgKHZhciBpPTAsIGw9Y3VycmVudFZpZXdzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICB2aWV3ID0gY3VycmVudFZpZXdzW2ldOwogICAgICAgIGN1cnJlbnRDaGlsZFZpZXdzID0gdmlldy5fY2hpbGRWaWV3cyA/IHZpZXcuX2NoaWxkVmlld3Muc2xpY2UoMCkgOiBudWxsOwogICAgICAgIGlmICh2aWV3LnRyaWdnZXIpIHsgdmlldy50cmlnZ2VyKGV2ZW50TmFtZSk7IH0KICAgICAgICBpZiAoY3VycmVudENoaWxkVmlld3MpIHsKICAgICAgICAgIGNoaWxkVmlld3MucHVzaC5hcHBseShjaGlsZFZpZXdzLCBjdXJyZW50Q2hpbGRWaWV3cyk7CiAgICAgICAgfQoKICAgICAgfQogICAgfQogIH0sCgogIHZpZXdIaWVyYXJjaHlDb2xsZWN0aW9uOiBmdW5jdGlvbigpIHsKICAgIHZhciBjdXJyZW50Vmlldywgdmlld0NvbGxlY3Rpb24gPSBuZXcgVmlld0NvbGxlY3Rpb24oW3RoaXNdKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZpZXdDb2xsZWN0aW9uLmxlbmd0aDsgaSsrKSB7CiAgICAgIGN1cnJlbnRWaWV3ID0gdmlld0NvbGxlY3Rpb24ub2JqZWN0QXQoaSk7CiAgICAgIGlmIChjdXJyZW50Vmlldy5fY2hpbGRWaWV3cykgewogICAgICAgIHZpZXdDb2xsZWN0aW9uLnB1c2guYXBwbHkodmlld0NvbGxlY3Rpb24sIGN1cnJlbnRWaWV3Ll9jaGlsZFZpZXdzKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB2aWV3Q29sbGVjdGlvbjsKICB9LAoKICAvKioKICAgIERlc3Ryb3lzIGFueSBleGlzdGluZyBlbGVtZW50IGFsb25nIHdpdGggdGhlIGVsZW1lbnQgZm9yIGFueSBjaGlsZCB2aWV3cwogICAgYXMgd2VsbC4gSWYgdGhlIHZpZXcgZG9lcyBub3QgY3VycmVudGx5IGhhdmUgYSBlbGVtZW50LCB0aGVuIHRoaXMgbWV0aG9kCiAgICB3aWxsIGRvIG5vdGhpbmcuCgogICAgSWYgeW91IGltcGxlbWVudCBgd2lsbERlc3Ryb3lFbGVtZW50KClgIG9uIHlvdXIgdmlldywgdGhlbiB0aGlzIG1ldGhvZCB3aWxsCiAgICBiZSBpbnZva2VkIG9uIHlvdXIgdmlldyBiZWZvcmUgeW91ciBlbGVtZW50IGlzIGRlc3Ryb3llZCB0byBnaXZlIHlvdSBhCiAgICBjaGFuY2UgdG8gY2xlYW4gdXAgYW55IGV2ZW50IGhhbmRsZXJzLCBldGMuCgogICAgSWYgeW91IHdyaXRlIGEgYHdpbGxEZXN0cm95RWxlbWVudCgpYCBoYW5kbGVyLCB5b3UgY2FuIGFzc3VtZSB0aGF0IHlvdXIKICAgIGBkaWRJbnNlcnRFbGVtZW50KClgIGhhbmRsZXIgd2FzIGNhbGxlZCBlYXJsaWVyIGZvciB0aGUgc2FtZSBlbGVtZW50LgoKICAgIFlvdSBzaG91bGQgbm90IGNhbGwgb3Igb3ZlcnJpZGUgdGhpcyBtZXRob2QgeW91cnNlbGYsIGJ1dCB5b3UgbWF5CiAgICB3YW50IHRvIGltcGxlbWVudCB0aGUgYWJvdmUgY2FsbGJhY2tzLgoKICAgIEBtZXRob2QgZGVzdHJveUVsZW1lbnQKICAgIEByZXR1cm4ge0VtYmVyLlZpZXd9IHJlY2VpdmVyCiAgKi8KICBkZXN0cm95RWxlbWVudDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5jdXJyZW50U3RhdGUuZGVzdHJveUVsZW1lbnQodGhpcyk7CiAgfSwKCiAgLyoqCiAgICBDYWxsZWQgd2hlbiB0aGUgZWxlbWVudCBvZiB0aGUgdmlldyBpcyBnb2luZyB0byBiZSBkZXN0cm95ZWQuIE92ZXJyaWRlCiAgICB0aGlzIGZ1bmN0aW9uIHRvIGRvIGFueSB0ZWFyZG93biB0aGF0IHJlcXVpcmVzIGFuIGVsZW1lbnQsIGxpa2UgcmVtb3ZpbmcKICAgIGV2ZW50IGxpc3RlbmVycy4KCiAgICBAZXZlbnQgd2lsbERlc3Ryb3lFbGVtZW50CiAgKi8KICB3aWxsRGVzdHJveUVsZW1lbnQ6IEVtYmVyLkssCgogIC8qKgogICAgVHJpZ2dlcnMgdGhlIGB3aWxsRGVzdHJveUVsZW1lbnRgIGV2ZW50ICh3aGljaCBpbnZva2VzIHRoZQogICAgYHdpbGxEZXN0cm95RWxlbWVudCgpYCBtZXRob2QgaWYgaXQgZXhpc3RzKSBvbiB0aGlzIHZpZXcgYW5kIGFsbCBjaGlsZAogICAgdmlld3MuCgogICAgQmVmb3JlIHRyaWdnZXJpbmcgYHdpbGxEZXN0cm95RWxlbWVudGAsIGl0IGZpcnN0IHRyaWdnZXJzIHRoZQogICAgYHdpbGxDbGVhclJlbmRlcmAgZXZlbnQgcmVjdXJzaXZlbHkuCgogICAgQG1ldGhvZCBfbm90aWZ5V2lsbERlc3Ryb3lFbGVtZW50CiAgICBAcHJpdmF0ZQogICovCiAgX25vdGlmeVdpbGxEZXN0cm95RWxlbWVudDogZnVuY3Rpb24oKSB7CiAgICB2YXIgdmlld0NvbGxlY3Rpb24gPSB0aGlzLnZpZXdIaWVyYXJjaHlDb2xsZWN0aW9uKCk7CiAgICB2aWV3Q29sbGVjdGlvbi50cmlnZ2VyKCd3aWxsQ2xlYXJSZW5kZXInKTsKICAgIHZpZXdDb2xsZWN0aW9uLnRyaWdnZXIoJ3dpbGxEZXN0cm95RWxlbWVudCcpOwogICAgcmV0dXJuIHZpZXdDb2xsZWN0aW9uOwogIH0sCgogIC8qKgogICAgSWYgdGhpcyB2aWV3J3MgZWxlbWVudCBjaGFuZ2VzLCB3ZSBuZWVkIHRvIGludmFsaWRhdGUgdGhlIGNhY2hlcyBvZiBvdXIKICAgIGNoaWxkIHZpZXdzIHNvIHRoYXQgd2UgZG8gbm90IHJldGFpbiByZWZlcmVuY2VzIHRvIERPTSBlbGVtZW50cyB0aGF0IGFyZQogICAgbm8gbG9uZ2VyIG5lZWRlZC4KCiAgICBAbWV0aG9kIF9lbGVtZW50RGlkQ2hhbmdlCiAgICBAcHJpdmF0ZQogICovCiAgX2VsZW1lbnREaWRDaGFuZ2U6IEVtYmVyLm9ic2VydmVyKCdlbGVtZW50JywgZnVuY3Rpb24oKSB7CiAgICB0aGlzLmZvckVhY2hDaGlsZFZpZXcoZnVuY3Rpb24odmlldykgewogICAgICBkZWxldGUgbWV0YSh2aWV3KS5jYWNoZS5lbGVtZW50OwogICAgfSk7CiAgfSksCgogIC8qKgogICAgQ2FsbGVkIHdoZW4gdGhlIHBhcmVudFZpZXcgcHJvcGVydHkgaGFzIGNoYW5nZWQuCgogICAgQGV2ZW50IHBhcmVudFZpZXdEaWRDaGFuZ2UKICAqLwogIHBhcmVudFZpZXdEaWRDaGFuZ2U6IEVtYmVyLkssCgogIGluc3RydW1lbnROYW1lOiAndmlldycsCgogIGluc3RydW1lbnREZXRhaWxzOiBmdW5jdGlvbihoYXNoKSB7CiAgICBoYXNoLnRlbXBsYXRlID0gZ2V0KHRoaXMsICd0ZW1wbGF0ZU5hbWUnKTsKICAgIHRoaXMuX3N1cGVyKGhhc2gpOwogIH0sCgogIF9yZW5kZXJUb0J1ZmZlcjogZnVuY3Rpb24ocGFyZW50QnVmZmVyLCBidWZmZXJPcGVyYXRpb24pIHsKICAgIHRoaXMubGVuZ3RoQmVmb3JlUmVuZGVyID0gdGhpcy5fY2hpbGRWaWV3cy5sZW5ndGg7CiAgICB2YXIgYnVmZmVyID0gdGhpcy5fc3VwZXIocGFyZW50QnVmZmVyLCBidWZmZXJPcGVyYXRpb24pOwogICAgdGhpcy5sZW5ndGhBZnRlclJlbmRlciA9IHRoaXMuX2NoaWxkVmlld3MubGVuZ3RoOwoKICAgIHJldHVybiBidWZmZXI7CiAgfSwKCiAgcmVuZGVyVG9CdWZmZXJJZk5lZWRlZDogZnVuY3Rpb24gKGJ1ZmZlcikgewogICAgcmV0dXJuIHRoaXMuY3VycmVudFN0YXRlLnJlbmRlclRvQnVmZmVySWZOZWVkZWQodGhpcywgYnVmZmVyKTsKICB9LAoKICBiZWZvcmVSZW5kZXI6IGZ1bmN0aW9uKGJ1ZmZlcikgewogICAgdGhpcy5hcHBseUF0dHJpYnV0ZXNUb0J1ZmZlcihidWZmZXIpOwogICAgYnVmZmVyLnB1c2hPcGVuaW5nVGFnKCk7CiAgfSwKCiAgYWZ0ZXJSZW5kZXI6IGZ1bmN0aW9uKGJ1ZmZlcikgewogICAgYnVmZmVyLnB1c2hDbG9zaW5nVGFnKCk7CiAgfSwKCiAgYXBwbHlBdHRyaWJ1dGVzVG9CdWZmZXI6IGZ1bmN0aW9uKGJ1ZmZlcikgewogICAgLy8gQ3JlYXRlcyBvYnNlcnZlcnMgZm9yIGFsbCByZWdpc3RlcmVkIGNsYXNzIG5hbWUgYW5kIGF0dHJpYnV0ZSBiaW5kaW5ncywKICAgIC8vIHRoZW4gYWRkcyB0aGVtIHRvIHRoZSBlbGVtZW50LgogICAgdmFyIGNsYXNzTmFtZUJpbmRpbmdzID0gZ2V0KHRoaXMsICdjbGFzc05hbWVCaW5kaW5ncycpOwogICAgaWYgKGNsYXNzTmFtZUJpbmRpbmdzLmxlbmd0aCkgewogICAgICB0aGlzLl9hcHBseUNsYXNzTmFtZUJpbmRpbmdzKGNsYXNzTmFtZUJpbmRpbmdzKTsKICAgIH0KCiAgICAvLyBQYXNzIHRoZSByZW5kZXIgYnVmZmVyIHNvIHRoZSBtZXRob2QgY2FuIGFwcGx5IGF0dHJpYnV0ZXMgZGlyZWN0bHkuCiAgICAvLyBUaGlzIGlzbid0IG5lZWRlZCBmb3IgY2xhc3MgbmFtZSBiaW5kaW5ncyBiZWNhdXNlIHRoZXkgdXNlIHRoZQogICAgLy8gZXhpc3RpbmcgY2xhc3NOYW1lcyBpbmZyYXN0cnVjdHVyZS4KICAgIHZhciBhdHRyaWJ1dGVCaW5kaW5ncyA9IGdldCh0aGlzLCAnYXR0cmlidXRlQmluZGluZ3MnKTsKICAgIGlmIChhdHRyaWJ1dGVCaW5kaW5ncy5sZW5ndGgpIHsKICAgICAgdGhpcy5fYXBwbHlBdHRyaWJ1dGVCaW5kaW5ncyhidWZmZXIsIGF0dHJpYnV0ZUJpbmRpbmdzKTsKICAgIH0KCiAgICBidWZmZXIuc2V0Q2xhc3Nlcyh0aGlzLmNsYXNzTmFtZXMpOwogICAgYnVmZmVyLmlkKHRoaXMuZWxlbWVudElkKTsKCiAgICB2YXIgcm9sZSA9IGdldCh0aGlzLCAnYXJpYVJvbGUnKTsKICAgIGlmIChyb2xlKSB7CiAgICAgIGJ1ZmZlci5hdHRyKCdyb2xlJywgcm9sZSk7CiAgICB9CgogICAgaWYgKGdldCh0aGlzLCAnaXNWaXNpYmxlJykgPT09IGZhbHNlKSB7CiAgICAgIGJ1ZmZlci5zdHlsZSgnZGlzcGxheScsICdub25lJyk7CiAgICB9CiAgfSwKCiAgLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgogIC8vIFNUQU5EQVJEIFJFTkRFUiBQUk9QRVJUSUVTCiAgLy8KCiAgLyoqCiAgICBUYWcgbmFtZSBmb3IgdGhlIHZpZXcncyBvdXRlciBlbGVtZW50LiBUaGUgdGFnIG5hbWUgaXMgb25seSB1c2VkIHdoZW4gYW4KICAgIGVsZW1lbnQgaXMgZmlyc3QgY3JlYXRlZC4gSWYgeW91IGNoYW5nZSB0aGUgYHRhZ05hbWVgIGZvciBhbiBlbGVtZW50LCB5b3UKICAgIG11c3QgZGVzdHJveSBhbmQgcmVjcmVhdGUgdGhlIHZpZXcgZWxlbWVudC4KCiAgICBCeSBkZWZhdWx0LCB0aGUgcmVuZGVyIGJ1ZmZlciB3aWxsIHVzZSBhIGA8ZGl2PmAgdGFnIGZvciB2aWV3cy4KCiAgICBAcHJvcGVydHkgdGFnTmFtZQogICAgQHR5cGUgU3RyaW5nCiAgICBAZGVmYXVsdCBudWxsCiAgKi8KCiAgLy8gV2UgbGVhdmUgdGhpcyBudWxsIGJ5IGRlZmF1bHQgc28gd2UgY2FuIHRlbGwgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbgogIC8vIHRoZSBkZWZhdWx0IGNhc2UgYW5kIGEgdXNlci1zcGVjaWZpZWQgdGFnLgogIHRhZ05hbWU6IG51bGwsCgogIC8qKgogICAgVGhlIFdBSS1BUklBIHJvbGUgb2YgdGhlIGNvbnRyb2wgcmVwcmVzZW50ZWQgYnkgdGhpcyB2aWV3LiBGb3IgZXhhbXBsZSwgYQogICAgYnV0dG9uIG1heSBoYXZlIGEgcm9sZSBvZiB0eXBlICdidXR0b24nLCBvciBhIHBhbmUgbWF5IGhhdmUgYSByb2xlIG9mCiAgICB0eXBlICdhbGVydGRpYWxvZycuIFRoaXMgcHJvcGVydHkgaXMgdXNlZCBieSBhc3Npc3RpdmUgc29mdHdhcmUgdG8gaGVscAogICAgdmlzdWFsbHkgY2hhbGxlbmdlZCB1c2VycyBuYXZpZ2F0ZSByaWNoIHdlYiBhcHBsaWNhdGlvbnMuCgogICAgVGhlIGZ1bGwgbGlzdCBvZiB2YWxpZCBXQUktQVJJQSByb2xlcyBpcyBhdmFpbGFibGUgYXQ6CiAgICBbaHR0cDovL3d3dy53My5vcmcvVFIvd2FpLWFyaWEvcm9sZXMjcm9sZXNfY2F0ZWdvcml6YXRpb25dKGh0dHA6Ly93d3cudzMub3JnL1RSL3dhaS1hcmlhL3JvbGVzI3JvbGVzX2NhdGVnb3JpemF0aW9uKQoKICAgIEBwcm9wZXJ0eSBhcmlhUm9sZQogICAgQHR5cGUgU3RyaW5nCiAgICBAZGVmYXVsdCBudWxsCiAgKi8KICBhcmlhUm9sZTogbnVsbCwKCiAgLyoqCiAgICBTdGFuZGFyZCBDU1MgY2xhc3MgbmFtZXMgdG8gYXBwbHkgdG8gdGhlIHZpZXcncyBvdXRlciBlbGVtZW50LiBUaGlzCiAgICBwcm9wZXJ0eSBhdXRvbWF0aWNhbGx5IGluaGVyaXRzIGFueSBjbGFzcyBuYW1lcyBkZWZpbmVkIGJ5IHRoZSB2aWV3J3MKICAgIHN1cGVyY2xhc3NlcyBhcyB3ZWxsLgoKICAgIEBwcm9wZXJ0eSBjbGFzc05hbWVzCiAgICBAdHlwZSBBcnJheQogICAgQGRlZmF1bHQgWydlbWJlci12aWV3J10KICAqLwogIGNsYXNzTmFtZXM6IFsnZW1iZXItdmlldyddLAoKICAvKioKICAgIEEgbGlzdCBvZiBwcm9wZXJ0aWVzIG9mIHRoZSB2aWV3IHRvIGFwcGx5IGFzIGNsYXNzIG5hbWVzLiBJZiB0aGUgcHJvcGVydHkKICAgIGlzIGEgc3RyaW5nIHZhbHVlLCB0aGUgdmFsdWUgb2YgdGhhdCBzdHJpbmcgd2lsbCBiZSBhcHBsaWVkIGFzIGEgY2xhc3MKICAgIG5hbWUuCgogICAgYGBgamF2YXNjcmlwdAogICAgLy8gQXBwbGllcyB0aGUgJ2hpZ2gnIGNsYXNzIHRvIHRoZSB2aWV3IGVsZW1lbnQKICAgIEVtYmVyLlZpZXcuZXh0ZW5kKHsKICAgICAgY2xhc3NOYW1lQmluZGluZ3M6IFsncHJpb3JpdHknXQogICAgICBwcmlvcml0eTogJ2hpZ2gnCiAgICB9KTsKICAgIGBgYAoKICAgIElmIHRoZSB2YWx1ZSBvZiB0aGUgcHJvcGVydHkgaXMgYSBCb29sZWFuLCB0aGUgbmFtZSBvZiB0aGF0IHByb3BlcnR5IGlzCiAgICBhZGRlZCBhcyBhIGRhc2hlcml6ZWQgY2xhc3MgbmFtZS4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICAvLyBBcHBsaWVzIHRoZSAnaXMtdXJnZW50JyBjbGFzcyB0byB0aGUgdmlldyBlbGVtZW50CiAgICBFbWJlci5WaWV3LmV4dGVuZCh7CiAgICAgIGNsYXNzTmFtZUJpbmRpbmdzOiBbJ2lzVXJnZW50J10KICAgICAgaXNVcmdlbnQ6IHRydWUKICAgIH0pOwogICAgYGBgCgogICAgSWYgeW91IHdvdWxkIHByZWZlciB0byB1c2UgYSBjdXN0b20gdmFsdWUgaW5zdGVhZCBvZiB0aGUgZGFzaGVyaXplZAogICAgcHJvcGVydHkgbmFtZSwgeW91IGNhbiBwYXNzIGEgYmluZGluZyBsaWtlIHRoaXM6CgogICAgYGBgamF2YXNjcmlwdAogICAgLy8gQXBwbGllcyB0aGUgJ3VyZ2VudCcgY2xhc3MgdG8gdGhlIHZpZXcgZWxlbWVudAogICAgRW1iZXIuVmlldy5leHRlbmQoewogICAgICBjbGFzc05hbWVCaW5kaW5nczogWydpc1VyZ2VudDp1cmdlbnQnXQogICAgICBpc1VyZ2VudDogdHJ1ZQogICAgfSk7CiAgICBgYGAKCiAgICBUaGlzIGxpc3Qgb2YgcHJvcGVydGllcyBpcyBpbmhlcml0ZWQgZnJvbSB0aGUgdmlldydzIHN1cGVyY2xhc3NlcyBhcyB3ZWxsLgoKICAgIEBwcm9wZXJ0eSBjbGFzc05hbWVCaW5kaW5ncwogICAgQHR5cGUgQXJyYXkKICAgIEBkZWZhdWx0IFtdCiAgKi8KICBjbGFzc05hbWVCaW5kaW5nczogRU1QVFlfQVJSQVksCgogIC8qKgogICAgQSBsaXN0IG9mIHByb3BlcnRpZXMgb2YgdGhlIHZpZXcgdG8gYXBwbHkgYXMgYXR0cmlidXRlcy4gSWYgdGhlIHByb3BlcnR5IGlzCiAgICBhIHN0cmluZyB2YWx1ZSwgdGhlIHZhbHVlIG9mIHRoYXQgc3RyaW5nIHdpbGwgYmUgYXBwbGllZCBhcyB0aGUgYXR0cmlidXRlLgoKICAgIGBgYGphdmFzY3JpcHQKICAgIC8vIEFwcGxpZXMgdGhlIHR5cGUgYXR0cmlidXRlIHRvIHRoZSBlbGVtZW50CiAgICAvLyB3aXRoIHRoZSB2YWx1ZSAiYnV0dG9uIiwgbGlrZSA8ZGl2IHR5cGU9ImJ1dHRvbiI+CiAgICBFbWJlci5WaWV3LmV4dGVuZCh7CiAgICAgIGF0dHJpYnV0ZUJpbmRpbmdzOiBbJ3R5cGUnXSwKICAgICAgdHlwZTogJ2J1dHRvbicKICAgIH0pOwogICAgYGBgCgogICAgSWYgdGhlIHZhbHVlIG9mIHRoZSBwcm9wZXJ0eSBpcyBhIEJvb2xlYW4sIHRoZSBuYW1lIG9mIHRoYXQgcHJvcGVydHkgaXMKICAgIGFkZGVkIGFzIGFuIGF0dHJpYnV0ZS4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICAvLyBSZW5kZXJzIHNvbWV0aGluZyBsaWtlIDxkaXYgZW5hYmxlZD0iZW5hYmxlZCI+CiAgICBFbWJlci5WaWV3LmV4dGVuZCh7CiAgICAgIGF0dHJpYnV0ZUJpbmRpbmdzOiBbJ2VuYWJsZWQnXSwKICAgICAgZW5hYmxlZDogdHJ1ZQogICAgfSk7CiAgICBgYGAKCiAgICBAcHJvcGVydHkgYXR0cmlidXRlQmluZGluZ3MKICAqLwogIGF0dHJpYnV0ZUJpbmRpbmdzOiBFTVBUWV9BUlJBWSwKCiAgLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgogIC8vIENPUkUgRElTUExBWSBNRVRIT0RTCiAgLy8KCiAgLyoqCiAgICBTZXR1cCBhIHZpZXcsIGJ1dCBkbyBub3QgZmluaXNoIHdha2luZyBpdCB1cC4KCiAgICAqIGNvbmZpZ3VyZSBgY2hpbGRWaWV3c2AKICAgICogcmVnaXN0ZXIgdGhlIHZpZXcgd2l0aCB0aGUgZ2xvYmFsIHZpZXdzIGhhc2gsIHdoaWNoIGlzIHVzZWQgZm9yIGV2ZW50CiAgICAgIGRpc3BhdGNoCgogICAgQG1ldGhvZCBpbml0CiAgICBAcHJpdmF0ZQogICovCiAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLmVsZW1lbnRJZCA9IHRoaXMuZWxlbWVudElkIHx8IGd1aWRGb3IodGhpcyk7CgogICAgdGhpcy5fc3VwZXIoKTsKCiAgICAvLyBzZXR1cCBjaGlsZCB2aWV3cy4gYmUgc3VyZSB0byBjbG9uZSB0aGUgY2hpbGQgdmlld3MgYXJyYXkgZmlyc3QKICAgIHRoaXMuX2NoaWxkVmlld3MgPSB0aGlzLl9jaGlsZFZpZXdzLnNsaWNlKCk7CgogICAgRW1iZXIuYXNzZXJ0KCJPbmx5IGFycmF5cyBhcmUgYWxsb3dlZCBmb3IgJ2NsYXNzTmFtZUJpbmRpbmdzJyIsIEVtYmVyLnR5cGVPZih0aGlzLmNsYXNzTmFtZUJpbmRpbmdzKSA9PT0gJ2FycmF5Jyk7CiAgICB0aGlzLmNsYXNzTmFtZUJpbmRpbmdzID0gRW1iZXIuQSh0aGlzLmNsYXNzTmFtZUJpbmRpbmdzLnNsaWNlKCkpOwoKICAgIEVtYmVyLmFzc2VydCgiT25seSBhcnJheXMgYXJlIGFsbG93ZWQgZm9yICdjbGFzc05hbWVzJyIsIEVtYmVyLnR5cGVPZih0aGlzLmNsYXNzTmFtZXMpID09PSAnYXJyYXknKTsKICAgIHRoaXMuY2xhc3NOYW1lcyA9IEVtYmVyLkEodGhpcy5jbGFzc05hbWVzLnNsaWNlKCkpOwogIH0sCgogIGFwcGVuZENoaWxkOiBmdW5jdGlvbih2aWV3LCBvcHRpb25zKSB7CiAgICByZXR1cm4gdGhpcy5jdXJyZW50U3RhdGUuYXBwZW5kQ2hpbGQodGhpcywgdmlldywgb3B0aW9ucyk7CiAgfSwKCiAgLyoqCiAgICBSZW1vdmVzIHRoZSBjaGlsZCB2aWV3IGZyb20gdGhlIHBhcmVudCB2aWV3LgoKICAgIEBtZXRob2QgcmVtb3ZlQ2hpbGQKICAgIEBwYXJhbSB7RW1iZXIuVmlld30gdmlldwogICAgQHJldHVybiB7RW1iZXIuVmlld30gcmVjZWl2ZXIKICAqLwogIHJlbW92ZUNoaWxkOiBmdW5jdGlvbih2aWV3KSB7CiAgICAvLyBJZiB3ZSdyZSBkZXN0cm95aW5nLCB0aGUgZW50aXJlIHN1YnRyZWUgd2lsbCBiZQogICAgLy8gZnJlZWQsIGFuZCB0aGUgRE9NIHdpbGwgYmUgaGFuZGxlZCBzZXBhcmF0ZWx5LAogICAgLy8gc28gbm8gbmVlZCB0byBtZXNzIHdpdGggY2hpbGRWaWV3cy4KICAgIGlmICh0aGlzLmlzRGVzdHJveWluZykgeyByZXR1cm47IH0KCiAgICAvLyB1cGRhdGUgcGFyZW50IG5vZGUKICAgIHNldCh2aWV3LCAnX3BhcmVudFZpZXcnLCBudWxsKTsKCiAgICAvLyByZW1vdmUgdmlldyBmcm9tIGNoaWxkVmlld3MgYXJyYXkuCiAgICB2YXIgY2hpbGRWaWV3cyA9IHRoaXMuX2NoaWxkVmlld3M7CgogICAgRW1iZXIuRW51bWVyYWJsZVV0aWxzLnJlbW92ZU9iamVjdChjaGlsZFZpZXdzLCB2aWV3KTsKCiAgICB0aGlzLnByb3BlcnR5RGlkQ2hhbmdlKCdjaGlsZFZpZXdzJyk7IC8vIEhVSD8hIHdoYXQgaGFwcGVuZWQgdG8gd2lsbCBjaGFuZ2U/CgogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICBSZW1vdmVzIGFsbCBjaGlsZHJlbiBmcm9tIHRoZSBgcGFyZW50Vmlld2AuCgogICAgQG1ldGhvZCByZW1vdmVBbGxDaGlsZHJlbgogICAgQHJldHVybiB7RW1iZXIuVmlld30gcmVjZWl2ZXIKICAqLwogIHJlbW92ZUFsbENoaWxkcmVuOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLm11dGF0ZUNoaWxkVmlld3MoZnVuY3Rpb24ocGFyZW50VmlldywgdmlldykgewogICAgICBwYXJlbnRWaWV3LnJlbW92ZUNoaWxkKHZpZXcpOwogICAgfSk7CiAgfSwKCiAgZGVzdHJveUFsbENoaWxkcmVuOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLm11dGF0ZUNoaWxkVmlld3MoZnVuY3Rpb24ocGFyZW50VmlldywgdmlldykgewogICAgICB2aWV3LmRlc3Ryb3koKTsKICAgIH0pOwogIH0sCgogIC8qKgogICAgUmVtb3ZlcyB0aGUgdmlldyBmcm9tIGl0cyBgcGFyZW50Vmlld2AsIGlmIG9uZSBpcyBmb3VuZC4gT3RoZXJ3aXNlCiAgICBkb2VzIG5vdGhpbmcuCgogICAgQG1ldGhvZCByZW1vdmVGcm9tUGFyZW50CiAgICBAcmV0dXJuIHtFbWJlci5WaWV3fSByZWNlaXZlcgogICovCiAgcmVtb3ZlRnJvbVBhcmVudDogZnVuY3Rpb24oKSB7CiAgICB2YXIgcGFyZW50ID0gdGhpcy5fcGFyZW50VmlldzsKCiAgICAvLyBSZW1vdmUgRE9NIGVsZW1lbnQgZnJvbSBwYXJlbnQKICAgIHRoaXMucmVtb3ZlKCk7CgogICAgaWYgKHBhcmVudCkgeyBwYXJlbnQucmVtb3ZlQ2hpbGQodGhpcyk7IH0KICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAgWW91IG11c3QgY2FsbCBgZGVzdHJveWAgb24gYSB2aWV3IHRvIGRlc3Ryb3kgdGhlIHZpZXcgKGFuZCBhbGwgb2YgaXRzCiAgICBjaGlsZCB2aWV3cykuIFRoaXMgd2lsbCByZW1vdmUgdGhlIHZpZXcgZnJvbSBhbnkgcGFyZW50IG5vZGUsIHRoZW4gbWFrZQogICAgc3VyZSB0aGF0IHRoZSBET00gZWxlbWVudCBtYW5hZ2VkIGJ5IHRoZSB2aWV3IGNhbiBiZSByZWxlYXNlZCBieSB0aGUKICAgIG1lbW9yeSBtYW5hZ2VyLgoKICAgIEBtZXRob2QgZGVzdHJveQogICovCiAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICB2YXIgY2hpbGRWaWV3cyA9IHRoaXMuX2NoaWxkVmlld3MsCiAgICAgICAgLy8gZ2V0IHBhcmVudFZpZXcgYmVmb3JlIGNhbGxpbmcgc3VwZXIgYmVjYXVzZSBpdCdsbCBiZSBkZXN0cm95ZWQKICAgICAgICBub25WaXJ0dWFsUGFyZW50VmlldyA9IGdldCh0aGlzLCAncGFyZW50VmlldycpLAogICAgICAgIHZpZXdOYW1lID0gdGhpcy52aWV3TmFtZSwKICAgICAgICBjaGlsZExlbiwgaTsKCiAgICBpZiAoIXRoaXMuX3N1cGVyKCkpIHsgcmV0dXJuOyB9CgogICAgY2hpbGRMZW4gPSBjaGlsZFZpZXdzLmxlbmd0aDsKICAgIGZvciAoaT1jaGlsZExlbi0xOyBpPj0wOyBpLS0pIHsKICAgICAgY2hpbGRWaWV3c1tpXS5yZW1vdmVkRnJvbURPTSA9IHRydWU7CiAgICB9CgogICAgLy8gcmVtb3ZlIGZyb20gbm9uLXZpcnR1YWwgcGFyZW50IHZpZXcgaWYgdmlld05hbWUgd2FzIHNwZWNpZmllZAogICAgaWYgKHZpZXdOYW1lICYmIG5vblZpcnR1YWxQYXJlbnRWaWV3KSB7CiAgICAgIG5vblZpcnR1YWxQYXJlbnRWaWV3LnNldCh2aWV3TmFtZSwgbnVsbCk7CiAgICB9CgogICAgY2hpbGRMZW4gPSBjaGlsZFZpZXdzLmxlbmd0aDsKICAgIGZvciAoaT1jaGlsZExlbi0xOyBpPj0wOyBpLS0pIHsKICAgICAgY2hpbGRWaWV3c1tpXS5kZXN0cm95KCk7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICBJbnN0YW50aWF0ZXMgYSB2aWV3IHRvIGJlIGFkZGVkIHRvIHRoZSBjaGlsZFZpZXdzIGFycmF5IGR1cmluZyB2aWV3CiAgICBpbml0aWFsaXphdGlvbi4gWW91IGdlbmVyYWxseSB3aWxsIG5vdCBjYWxsIHRoaXMgbWV0aG9kIGRpcmVjdGx5IHVubGVzcwogICAgeW91IGFyZSBvdmVycmlkaW5nIGBjcmVhdGVDaGlsZFZpZXdzKClgLiBOb3RlIHRoYXQgdGhpcyBtZXRob2Qgd2lsbAogICAgYXV0b21hdGljYWxseSBjb25maWd1cmUgdGhlIGNvcnJlY3Qgc2V0dGluZ3Mgb24gdGhlIG5ldyB2aWV3IGluc3RhbmNlIHRvCiAgICBhY3QgYXMgYSBjaGlsZCBvZiB0aGUgcGFyZW50LgoKICAgIEBtZXRob2QgY3JlYXRlQ2hpbGRWaWV3CiAgICBAcGFyYW0ge0NsYXNzfFN0cmluZ30gdmlld0NsYXNzCiAgICBAcGFyYW0ge0hhc2h9IFthdHRyc10gQXR0cmlidXRlcyB0byBhZGQKICAgIEByZXR1cm4ge0VtYmVyLlZpZXd9IG5ldyBpbnN0YW5jZQogICovCiAgY3JlYXRlQ2hpbGRWaWV3OiBmdW5jdGlvbih2aWV3LCBhdHRycykgewogICAgaWYgKCF2aWV3KSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoImNyZWF0ZUNoaWxkVmlld3MgZmlyc3QgYXJndW1lbnQgbXVzdCBleGlzdCIpOwogICAgfQoKICAgIGlmICh2aWV3LmlzVmlldyAmJiB2aWV3Ll9wYXJlbnRWaWV3ID09PSB0aGlzICYmIHZpZXcuY29udGFpbmVyID09PSB0aGlzLmNvbnRhaW5lcikgewogICAgICByZXR1cm4gdmlldzsKICAgIH0KCiAgICBhdHRycyA9IGF0dHJzIHx8IHt9OwogICAgYXR0cnMuX3BhcmVudFZpZXcgPSB0aGlzOwoKICAgIGlmIChFbWJlci5Db3JlVmlldy5kZXRlY3QodmlldykpIHsKICAgICAgYXR0cnMudGVtcGxhdGVEYXRhID0gYXR0cnMudGVtcGxhdGVEYXRhIHx8IGdldCh0aGlzLCAndGVtcGxhdGVEYXRhJyk7CgogICAgICBhdHRycy5jb250YWluZXIgPSB0aGlzLmNvbnRhaW5lcjsKICAgICAgdmlldyA9IHZpZXcuY3JlYXRlKGF0dHJzKTsKCiAgICAgIC8vIGRvbid0IHNldCB0aGUgcHJvcGVydHkgb24gYSB2aXJ0dWFsIHZpZXcsIGFzIHRoZXkgYXJlIGludmlzaWJsZSB0bwogICAgICAvLyBjb25zdW1lcnMgb2YgdGhlIHZpZXcgQVBJCiAgICAgIGlmICh2aWV3LnZpZXdOYW1lKSB7CiAgICAgICAgc2V0KGdldCh0aGlzLCAnY29uY3JldGVWaWV3JyksIHZpZXcudmlld05hbWUsIHZpZXcpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKCdzdHJpbmcnID09PSB0eXBlb2YgdmlldykgewogICAgICB2YXIgZnVsbE5hbWUgPSAndmlldzonICsgdmlldzsKICAgICAgdmFyIFZpZXcgPSB0aGlzLmNvbnRhaW5lci5sb29rdXBGYWN0b3J5KGZ1bGxOYW1lKTsKCiAgICAgIEVtYmVyLmFzc2VydCgiQ291bGQgbm90IGZpbmQgdmlldzogJyIgKyBmdWxsTmFtZSArICInIiwgISFWaWV3KTsKCiAgICAgIGF0dHJzLnRlbXBsYXRlRGF0YSA9IGdldCh0aGlzLCAndGVtcGxhdGVEYXRhJyk7CiAgICAgIHZpZXcgPSBWaWV3LmNyZWF0ZShhdHRycyk7CiAgICB9IGVsc2UgewogICAgICBFbWJlci5hc3NlcnQoJ1lvdSBtdXN0IHBhc3MgaW5zdGFuY2Ugb3Igc3ViY2xhc3Mgb2YgVmlldycsIHZpZXcuaXNWaWV3KTsKICAgICAgYXR0cnMuY29udGFpbmVyID0gdGhpcy5jb250YWluZXI7CgogICAgICBpZiAoIWdldCh2aWV3LCAndGVtcGxhdGVEYXRhJykpIHsKICAgICAgICBhdHRycy50ZW1wbGF0ZURhdGEgPSBnZXQodGhpcywgJ3RlbXBsYXRlRGF0YScpOwogICAgICB9CgogICAgICBFbWJlci5zZXRQcm9wZXJ0aWVzKHZpZXcsIGF0dHJzKTsKCiAgICB9CgogICAgcmV0dXJuIHZpZXc7CiAgfSwKCiAgYmVjYW1lVmlzaWJsZTogRW1iZXIuSywKICBiZWNhbWVIaWRkZW46IEVtYmVyLkssCgogIC8qKgogICAgV2hlbiB0aGUgdmlldydzIGBpc1Zpc2libGVgIHByb3BlcnR5IGNoYW5nZXMsIHRvZ2dsZSB0aGUgdmlzaWJpbGl0eQogICAgZWxlbWVudCBvZiB0aGUgYWN0dWFsIERPTSBlbGVtZW50LgoKICAgIEBtZXRob2QgX2lzVmlzaWJsZURpZENoYW5nZQogICAgQHByaXZhdGUKICAqLwogIF9pc1Zpc2libGVEaWRDaGFuZ2U6IEVtYmVyLm9ic2VydmVyKCdpc1Zpc2libGUnLCBmdW5jdGlvbigpIHsKICAgIHZhciAkZWwgPSB0aGlzLiQoKTsKICAgIGlmICghJGVsKSB7IHJldHVybjsgfQoKICAgIHZhciBpc1Zpc2libGUgPSBnZXQodGhpcywgJ2lzVmlzaWJsZScpOwoKICAgICRlbC50b2dnbGUoaXNWaXNpYmxlKTsKCiAgICBpZiAodGhpcy5faXNBbmNlc3RvckhpZGRlbigpKSB7IHJldHVybjsgfQoKICAgIGlmIChpc1Zpc2libGUpIHsKICAgICAgdGhpcy5fbm90aWZ5QmVjYW1lVmlzaWJsZSgpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fbm90aWZ5QmVjYW1lSGlkZGVuKCk7CiAgICB9CiAgfSksCgogIF9ub3RpZnlCZWNhbWVWaXNpYmxlOiBmdW5jdGlvbigpIHsKICAgIHRoaXMudHJpZ2dlcignYmVjYW1lVmlzaWJsZScpOwoKICAgIHRoaXMuZm9yRWFjaENoaWxkVmlldyhmdW5jdGlvbih2aWV3KSB7CiAgICAgIHZhciBpc1Zpc2libGUgPSBnZXQodmlldywgJ2lzVmlzaWJsZScpOwoKICAgICAgaWYgKGlzVmlzaWJsZSB8fCBpc1Zpc2libGUgPT09IG51bGwpIHsKICAgICAgICB2aWV3Ll9ub3RpZnlCZWNhbWVWaXNpYmxlKCk7CiAgICAgIH0KICAgIH0pOwogIH0sCgogIF9ub3RpZnlCZWNhbWVIaWRkZW46IGZ1bmN0aW9uKCkgewogICAgdGhpcy50cmlnZ2VyKCdiZWNhbWVIaWRkZW4nKTsKICAgIHRoaXMuZm9yRWFjaENoaWxkVmlldyhmdW5jdGlvbih2aWV3KSB7CiAgICAgIHZhciBpc1Zpc2libGUgPSBnZXQodmlldywgJ2lzVmlzaWJsZScpOwoKICAgICAgaWYgKGlzVmlzaWJsZSB8fCBpc1Zpc2libGUgPT09IG51bGwpIHsKICAgICAgICB2aWV3Ll9ub3RpZnlCZWNhbWVIaWRkZW4oKTsKICAgICAgfQogICAgfSk7CiAgfSwKCiAgX2lzQW5jZXN0b3JIaWRkZW46IGZ1bmN0aW9uKCkgewogICAgdmFyIHBhcmVudCA9IGdldCh0aGlzLCAncGFyZW50VmlldycpOwoKICAgIHdoaWxlIChwYXJlbnQpIHsKICAgICAgaWYgKGdldChwYXJlbnQsICdpc1Zpc2libGUnKSA9PT0gZmFsc2UpIHsgcmV0dXJuIHRydWU7IH0KCiAgICAgIHBhcmVudCA9IGdldChwYXJlbnQsICdwYXJlbnRWaWV3Jyk7CiAgICB9CgogICAgcmV0dXJuIGZhbHNlOwogIH0sCgogIGNsZWFyQnVmZmVyOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuaW52b2tlUmVjdXJzaXZlbHkoZnVuY3Rpb24odmlldykgewogICAgICB2aWV3LmJ1ZmZlciA9IG51bGw7CiAgICB9KTsKICB9LAoKICB0cmFuc2l0aW9uVG86IGZ1bmN0aW9uKHN0YXRlLCBjaGlsZHJlbikgewogICAgdmFyIHByaW9yU3RhdGUgPSB0aGlzLmN1cnJlbnRTdGF0ZSwKICAgICAgICBjdXJyZW50U3RhdGUgPSB0aGlzLmN1cnJlbnRTdGF0ZSA9IHRoaXMuc3RhdGVzW3N0YXRlXTsKICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTsKCiAgICBpZiAocHJpb3JTdGF0ZSAmJiBwcmlvclN0YXRlLmV4aXQpIHsgcHJpb3JTdGF0ZS5leGl0KHRoaXMpOyB9CiAgICBpZiAoY3VycmVudFN0YXRlLmVudGVyKSB7IGN1cnJlbnRTdGF0ZS5lbnRlcih0aGlzKTsgfQogICAgaWYgKHN0YXRlID09PSAnaW5ET00nKSB7IGRlbGV0ZSBFbWJlci5tZXRhKHRoaXMpLmNhY2hlLmVsZW1lbnQ7IH0KCiAgICBpZiAoY2hpbGRyZW4gIT09IGZhbHNlKSB7CiAgICAgIHRoaXMuZm9yRWFjaENoaWxkVmlldyhmdW5jdGlvbih2aWV3KSB7CiAgICAgICAgdmlldy50cmFuc2l0aW9uVG8oc3RhdGUpOwogICAgICB9KTsKICAgIH0KICB9LAoKICAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCiAgLy8gRVZFTlQgSEFORExJTkcKICAvLwoKICAvKioKICAgIEhhbmRsZSBldmVudHMgZnJvbSBgRW1iZXIuRXZlbnREaXNwYXRjaGVyYAoKICAgIEBtZXRob2QgaGFuZGxlRXZlbnQKICAgIEBwYXJhbSBldmVudE5hbWUge1N0cmluZ30KICAgIEBwYXJhbSBldnQge0V2ZW50fQogICAgQHByaXZhdGUKICAqLwogIGhhbmRsZUV2ZW50OiBmdW5jdGlvbihldmVudE5hbWUsIGV2dCkgewogICAgcmV0dXJuIHRoaXMuY3VycmVudFN0YXRlLmhhbmRsZUV2ZW50KHRoaXMsIGV2ZW50TmFtZSwgZXZ0KTsKICB9LAoKICByZWdpc3Rlck9ic2VydmVyOiBmdW5jdGlvbihyb290LCBwYXRoLCB0YXJnZXQsIG9ic2VydmVyKSB7CiAgICBpZiAoIW9ic2VydmVyICYmICdmdW5jdGlvbicgPT09IHR5cGVvZiB0YXJnZXQpIHsKICAgICAgb2JzZXJ2ZXIgPSB0YXJnZXQ7CiAgICAgIHRhcmdldCA9IG51bGw7CiAgICB9CgogICAgaWYgKCFyb290IHx8IHR5cGVvZiByb290ICE9PSAnb2JqZWN0JykgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIHZpZXcgPSB0aGlzLAogICAgICAgIHN0YXRlQ2hlY2tlZE9ic2VydmVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2aWV3LmN1cnJlbnRTdGF0ZS5pbnZva2VPYnNlcnZlcih0aGlzLCBvYnNlcnZlcik7CiAgICAgICAgfSwKICAgICAgICBzY2hlZHVsZWRPYnNlcnZlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgRW1iZXIucnVuLnNjaGVkdWxlT25jZSgncmVuZGVyJywgdGhpcywgc3RhdGVDaGVja2VkT2JzZXJ2ZXIpOwogICAgICAgIH07CgogICAgRW1iZXIuYWRkT2JzZXJ2ZXIocm9vdCwgcGF0aCwgdGFyZ2V0LCBzY2hlZHVsZWRPYnNlcnZlcik7CgogICAgdGhpcy5vbmUoJ3dpbGxDbGVhclJlbmRlcicsIGZ1bmN0aW9uKCkgewogICAgICBFbWJlci5yZW1vdmVPYnNlcnZlcihyb290LCBwYXRoLCB0YXJnZXQsIHNjaGVkdWxlZE9ic2VydmVyKTsKICAgIH0pOwogIH0KCn0pOwoKLyoKICBEZXNjcmliZSBob3cgdGhlIHNwZWNpZmllZCBhY3Rpb25zIHNob3VsZCBiZWhhdmUgaW4gdGhlIHZhcmlvdXMKICBzdGF0ZXMgdGhhdCBhIHZpZXcgY2FuIGV4aXN0IGluLiBQb3NzaWJsZSBzdGF0ZXM6CgogICogcHJlUmVuZGVyOiB3aGVuIGEgdmlldyBpcyBmaXJzdCBpbnN0YW50aWF0ZWQsIGFuZCBhZnRlciBpdHMKICAgIGVsZW1lbnQgd2FzIGRlc3Ryb3llZCwgaXQgaXMgaW4gdGhlIHByZVJlbmRlciBzdGF0ZQogICogaW5CdWZmZXI6IG9uY2UgYSB2aWV3IGhhcyBiZWVuIHJlbmRlcmVkLCBidXQgYmVmb3JlIGl0IGhhcwogICAgYmVlbiBpbnNlcnRlZCBpbnRvIHRoZSBET00sIGl0IGlzIGluIHRoZSBpbkJ1ZmZlciBzdGF0ZQogICogaW5ET006IG9uY2UgYSB2aWV3IGhhcyBiZWVuIGluc2VydGVkIGludG8gdGhlIERPTSBpdCBpcyBpbgogICAgdGhlIGluRE9NIHN0YXRlLiBBIHZpZXcgc3BlbmRzIHRoZSB2YXN0IG1ham9yaXR5IG9mIGl0cwogICAgZXhpc3RlbmNlIGluIHRoaXMgc3RhdGUuCiAgKiBkZXN0cm95ZWQ6IG9uY2UgYSB2aWV3IGhhcyBiZWVuIGRlc3Ryb3llZCAodXNpbmcgdGhlIGRlc3Ryb3kKICAgIG1ldGhvZCksIGl0IGlzIGluIHRoaXMgc3RhdGUuIE5vIGZ1cnRoZXIgYWN0aW9ucyBjYW4gYmUgaW52b2tlZAogICAgb24gYSBkZXN0cm95ZWQgdmlldy4KKi8KCiAgLy8gaW4gdGhlIGRlc3Ryb3llZCBzdGF0ZSwgZXZlcnl0aGluZyBpcyBpbGxlZ2FsCgogIC8vIGJlZm9yZSByZW5kZXJpbmcgaGFzIGJlZ3VuLCBhbGwgbGVnYWwgbWFuaXB1bGF0aW9ucyBhcmUgbm9vcHMuCgogIC8vIGluc2lkZSB0aGUgYnVmZmVyLCBsZWdhbCBtYW5pcHVsYXRpb25zIGFyZSBkb25lIG9uIHRoZSBidWZmZXIKCiAgLy8gb25jZSB0aGUgdmlldyBoYXMgYmVlbiBpbnNlcnRlZCBpbnRvIHRoZSBET00sIGxlZ2FsIG1hbmlwdWxhdGlvbnMKICAvLyBhcmUgZG9uZSBvbiB0aGUgRE9NIGVsZW1lbnQuCgpmdW5jdGlvbiBub3RpZnlNdXRhdGlvbkxpc3RlbmVycygpIHsKICBFbWJlci5ydW4ub25jZShFbWJlci5WaWV3LCAnbm90aWZ5TXV0YXRpb25MaXN0ZW5lcnMnKTsKfQoKdmFyIERPTU1hbmFnZXIgPSB7CiAgcHJlcGVuZDogZnVuY3Rpb24odmlldywgaHRtbCkgewogICAgdmlldy4kKCkucHJlcGVuZChodG1sKTsKICAgIG5vdGlmeU11dGF0aW9uTGlzdGVuZXJzKCk7CiAgfSwKCiAgYWZ0ZXI6IGZ1bmN0aW9uKHZpZXcsIGh0bWwpIHsKICAgIHZpZXcuJCgpLmFmdGVyKGh0bWwpOwogICAgbm90aWZ5TXV0YXRpb25MaXN0ZW5lcnMoKTsKICB9LAoKICBodG1sOiBmdW5jdGlvbih2aWV3LCBodG1sKSB7CiAgICB2aWV3LiQoKS5odG1sKGh0bWwpOwogICAgbm90aWZ5TXV0YXRpb25MaXN0ZW5lcnMoKTsKICB9LAoKICByZXBsYWNlOiBmdW5jdGlvbih2aWV3KSB7CiAgICB2YXIgZWxlbWVudCA9IGdldCh2aWV3LCAnZWxlbWVudCcpOwoKICAgIHNldCh2aWV3LCAnZWxlbWVudCcsIG51bGwpOwoKICAgIHZpZXcuX2luc2VydEVsZW1lbnRMYXRlcihmdW5jdGlvbigpIHsKICAgICAgRW1iZXIuJChlbGVtZW50KS5yZXBsYWNlV2l0aChnZXQodmlldywgJ2VsZW1lbnQnKSk7CiAgICAgIG5vdGlmeU11dGF0aW9uTGlzdGVuZXJzKCk7CiAgICB9KTsKICB9LAoKICByZW1vdmU6IGZ1bmN0aW9uKHZpZXcpIHsKICAgIHZpZXcuJCgpLnJlbW92ZSgpOwogICAgbm90aWZ5TXV0YXRpb25MaXN0ZW5lcnMoKTsKICB9LAoKICBlbXB0eTogZnVuY3Rpb24odmlldykgewogICAgdmlldy4kKCkuZW1wdHkoKTsKICAgIG5vdGlmeU11dGF0aW9uTGlzdGVuZXJzKCk7CiAgfQp9OwoKRW1iZXIuVmlldy5yZW9wZW4oewogIGRvbU1hbmFnZXI6IERPTU1hbmFnZXIKfSk7CgpFbWJlci5WaWV3LnJlb3BlbkNsYXNzKHsKCiAgLyoqCiAgICBQYXJzZSBhIHBhdGggYW5kIHJldHVybiBhbiBvYmplY3Qgd2hpY2ggaG9sZHMgdGhlIHBhcnNlZCBwcm9wZXJ0aWVzLgoKICAgIEZvciBleGFtcGxlIGEgcGF0aCBsaWtlICJjb250ZW50LmlzRW5hYmxlZDplbmFibGVkOmRpc2FibGVkIiB3aWxsIHJldHVybiB0aGUKICAgIGZvbGxvd2luZyBvYmplY3Q6CgogICAgYGBgamF2YXNjcmlwdAogICAgewogICAgICBwYXRoOiAiY29udGVudC5pc0VuYWJsZWQiLAogICAgICBjbGFzc05hbWU6ICJlbmFibGVkIiwKICAgICAgZmFsc3lDbGFzc05hbWU6ICJkaXNhYmxlZCIsCiAgICAgIGNsYXNzTmFtZXM6ICI6ZW5hYmxlZDpkaXNhYmxlZCIKICAgIH0KICAgIGBgYAoKICAgIEBtZXRob2QgX3BhcnNlUHJvcGVydHlQYXRoCiAgICBAc3RhdGljCiAgICBAcHJpdmF0ZQogICovCiAgX3BhcnNlUHJvcGVydHlQYXRoOiBmdW5jdGlvbihwYXRoKSB7CiAgICB2YXIgc3BsaXQgPSBwYXRoLnNwbGl0KCc6JyksCiAgICAgICAgcHJvcGVydHlQYXRoID0gc3BsaXRbMF0sCiAgICAgICAgY2xhc3NOYW1lcyA9ICIiLAogICAgICAgIGNsYXNzTmFtZSwKICAgICAgICBmYWxzeUNsYXNzTmFtZTsKCiAgICAvLyBjaGVjayBpZiB0aGUgcHJvcGVydHkgaXMgZGVmaW5lZCBhcyBwcm9wOmNsYXNzIG9yIHByb3A6dHJ1ZUNsYXNzOmZhbHNlQ2xhc3MKICAgIGlmIChzcGxpdC5sZW5ndGggPiAxKSB7CiAgICAgIGNsYXNzTmFtZSA9IHNwbGl0WzFdOwogICAgICBpZiAoc3BsaXQubGVuZ3RoID09PSAzKSB7IGZhbHN5Q2xhc3NOYW1lID0gc3BsaXRbMl07IH0KCiAgICAgIGNsYXNzTmFtZXMgPSAnOicgKyBjbGFzc05hbWU7CiAgICAgIGlmIChmYWxzeUNsYXNzTmFtZSkgeyBjbGFzc05hbWVzICs9ICI6IiArIGZhbHN5Q2xhc3NOYW1lOyB9CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgcGF0aDogcHJvcGVydHlQYXRoLAogICAgICBjbGFzc05hbWVzOiBjbGFzc05hbWVzLAogICAgICBjbGFzc05hbWU6IChjbGFzc05hbWUgPT09ICcnKSA/IHVuZGVmaW5lZCA6IGNsYXNzTmFtZSwKICAgICAgZmFsc3lDbGFzc05hbWU6IGZhbHN5Q2xhc3NOYW1lCiAgICB9OwogIH0sCgogIC8qKgogICAgR2V0IHRoZSBjbGFzcyBuYW1lIGZvciBhIGdpdmVuIHZhbHVlLCBiYXNlZCBvbiB0aGUgcGF0aCwgb3B0aW9uYWwKICAgIGBjbGFzc05hbWVgIGFuZCBvcHRpb25hbCBgZmFsc3lDbGFzc05hbWVgLgoKICAgIC0gaWYgYSBgY2xhc3NOYW1lYCBvciBgZmFsc3lDbGFzc05hbWVgIGhhcyBiZWVuIHNwZWNpZmllZDoKICAgICAgLSBpZiB0aGUgdmFsdWUgaXMgdHJ1dGh5IGFuZCBgY2xhc3NOYW1lYCBoYXMgYmVlbiBzcGVjaWZpZWQsCiAgICAgICAgYGNsYXNzTmFtZWAgaXMgcmV0dXJuZWQKICAgICAgLSBpZiB0aGUgdmFsdWUgaXMgZmFsc3kgYW5kIGBmYWxzeUNsYXNzTmFtZWAgaGFzIGJlZW4gc3BlY2lmaWVkLAogICAgICAgIGBmYWxzeUNsYXNzTmFtZWAgaXMgcmV0dXJuZWQKICAgICAgLSBvdGhlcndpc2UgYG51bGxgIGlzIHJldHVybmVkCiAgICAtIGlmIHRoZSB2YWx1ZSBpcyBgdHJ1ZWAsIHRoZSBkYXNoZXJpemVkIGxhc3QgcGFydCBvZiB0aGUgc3VwcGxpZWQgcGF0aAogICAgICBpcyByZXR1cm5lZAogICAgLSBpZiB0aGUgdmFsdWUgaXMgbm90IGBmYWxzZWAsIGB1bmRlZmluZWRgIG9yIGBudWxsYCwgdGhlIGB2YWx1ZWAKICAgICAgaXMgcmV0dXJuZWQKICAgIC0gaWYgbm9uZSBvZiB0aGUgYWJvdmUgcnVsZXMgYXBwbHksIGBudWxsYCBpcyByZXR1cm5lZAoKICAgIEBtZXRob2QgX2NsYXNzU3RyaW5nRm9yVmFsdWUKICAgIEBwYXJhbSBwYXRoCiAgICBAcGFyYW0gdmFsCiAgICBAcGFyYW0gY2xhc3NOYW1lCiAgICBAcGFyYW0gZmFsc3lDbGFzc05hbWUKICAgIEBzdGF0aWMKICAgIEBwcml2YXRlCiAgKi8KICBfY2xhc3NTdHJpbmdGb3JWYWx1ZTogZnVuY3Rpb24ocGF0aCwgdmFsLCBjbGFzc05hbWUsIGZhbHN5Q2xhc3NOYW1lKSB7CiAgICAvLyBXaGVuIHVzaW5nIHRoZSBjb2xvbiBzeW50YXgsIGV2YWx1YXRlIHRoZSB0cnV0aGluZXNzIG9yIGZhbHNpbmVzcwogICAgLy8gb2YgdGhlIHZhbHVlIHRvIGRldGVybWluZSB3aGljaCBjbGFzc05hbWUgdG8gcmV0dXJuCiAgICBpZiAoY2xhc3NOYW1lIHx8IGZhbHN5Q2xhc3NOYW1lKSB7CiAgICAgIGlmIChjbGFzc05hbWUgJiYgISF2YWwpIHsKICAgICAgICByZXR1cm4gY2xhc3NOYW1lOwoKICAgICAgfSBlbHNlIGlmIChmYWxzeUNsYXNzTmFtZSAmJiAhdmFsKSB7CiAgICAgICAgcmV0dXJuIGZhbHN5Q2xhc3NOYW1lOwoKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQoKICAgIC8vIElmIHZhbHVlIGlzIGEgQm9vbGVhbiBhbmQgdHJ1ZSwgcmV0dXJuIHRoZSBkYXNoZXJpemVkIHByb3BlcnR5CiAgICAvLyBuYW1lLgogICAgfSBlbHNlIGlmICh2YWwgPT09IHRydWUpIHsKICAgICAgLy8gTm9ybWFsaXplIHByb3BlcnR5IHBhdGggdG8gYmUgc3VpdGFibGUgZm9yIHVzZQogICAgICAvLyBhcyBhIGNsYXNzIG5hbWUuIEZvciBleGFwbGUsIGNvbnRlbnQuZm9vLmJhckJhegogICAgICAvLyBiZWNvbWVzIGJhci1iYXouCiAgICAgIHZhciBwYXJ0cyA9IHBhdGguc3BsaXQoJy4nKTsKICAgICAgcmV0dXJuIEVtYmVyLlN0cmluZy5kYXNoZXJpemUocGFydHNbcGFydHMubGVuZ3RoLTFdKTsKCiAgICAvLyBJZiB0aGUgdmFsdWUgaXMgbm90IGZhbHNlLCB1bmRlZmluZWQsIG9yIG51bGwsIHJldHVybiB0aGUgY3VycmVudAogICAgLy8gdmFsdWUgb2YgdGhlIHByb3BlcnR5LgogICAgfSBlbHNlIGlmICh2YWwgIT09IGZhbHNlICYmIHZhbCAhPSBudWxsKSB7CiAgICAgIHJldHVybiB2YWw7CgogICAgLy8gTm90aGluZyB0byBkaXNwbGF5LiBSZXR1cm4gbnVsbCBzbyB0aGF0IHRoZSBvbGQgY2xhc3MgaXMgcmVtb3ZlZAogICAgLy8gYnV0IG5vIG5ldyBjbGFzcyBpcyBhZGRlZC4KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogIH0KfSk7Cgp2YXIgbXV0YXRpb24gPSBFbWJlci5PYmplY3QuZXh0ZW5kKEVtYmVyLkV2ZW50ZWQpLmNyZWF0ZSgpOwoKRW1iZXIuVmlldy5hZGRNdXRhdGlvbkxpc3RlbmVyID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICBtdXRhdGlvbi5vbignY2hhbmdlJywgY2FsbGJhY2spOwp9OwoKRW1iZXIuVmlldy5yZW1vdmVNdXRhdGlvbkxpc3RlbmVyID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICBtdXRhdGlvbi5vZmYoJ2NoYW5nZScsIGNhbGxiYWNrKTsKfTsKCkVtYmVyLlZpZXcubm90aWZ5TXV0YXRpb25MaXN0ZW5lcnMgPSBmdW5jdGlvbigpIHsKICBtdXRhdGlvbi50cmlnZ2VyKCdjaGFuZ2UnKTsKfTsKCi8qKgogIEdsb2JhbCB2aWV3cyBoYXNoCgogIEBwcm9wZXJ0eSB2aWV3cwogIEBzdGF0aWMKICBAdHlwZSBIYXNoCiovCkVtYmVyLlZpZXcudmlld3MgPSB7fTsKCi8vIElmIHNvbWVvbmUgb3ZlcnJpZGVzIHRoZSBjaGlsZCB2aWV3cyBjb21wdXRlZCBwcm9wZXJ0eSB3aGVuCi8vIGRlZmluaW5nIHRoZWlyIGNsYXNzLCB3ZSB3YW50IHRvIGJlIGFibGUgdG8gcHJvY2VzcyB0aGUgdXNlcidzCi8vIHN1cHBsaWVkIGNoaWxkVmlld3MgYW5kIHRoZW4gcmVzdG9yZSB0aGUgb3JpZ2luYWwgY29tcHV0ZWQgcHJvcGVydHkKLy8gYXQgdmlldyBpbml0aWFsaXphdGlvbiB0aW1lLiBUaGlzIGhhcHBlbnMgaW4gRW1iZXIuQ29udGFpbmVyVmlldydzIGluaXQKLy8gbWV0aG9kLgpFbWJlci5WaWV3LmNoaWxkVmlld3NQcm9wZXJ0eSA9IGNoaWxkVmlld3NQcm9wZXJ0eTsKCkVtYmVyLlZpZXcuYXBwbHlBdHRyaWJ1dGVCaW5kaW5ncyA9IGZ1bmN0aW9uKGVsZW0sIG5hbWUsIHZhbHVlKSB7CiAgdmFyIHR5cGUgPSBFbWJlci50eXBlT2YodmFsdWUpOwoKICAvLyBpZiB0aGlzIGNoYW5nZXMsIGFsc28gY2hhbmdlIHRoZSBsb2dpYyBpbiBlbWJlci1oYW5kbGViYXJzL2xpYi9oZWxwZXJzL2JpbmRpbmcuanMKICBpZiAobmFtZSAhPT0gJ3ZhbHVlJyAmJiAodHlwZSA9PT0gJ3N0cmluZycgfHwgKHR5cGUgPT09ICdudW1iZXInICYmICFpc05hTih2YWx1ZSkpKSkgewogICAgaWYgKHZhbHVlICE9PSBlbGVtLmF0dHIobmFtZSkpIHsKICAgICAgZWxlbS5hdHRyKG5hbWUsIHZhbHVlKTsKICAgIH0KICB9IGVsc2UgaWYgKG5hbWUgPT09ICd2YWx1ZScgfHwgdHlwZSA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAvLyBXZSBjYW4ndCBzZXQgcHJvcGVydGllcyB0byB1bmRlZmluZWQgb3IgbnVsbAogICAgaWYgKEVtYmVyLmlzTm9uZSh2YWx1ZSkpIHsgdmFsdWUgPSAnJzsgfQoKICAgIGlmICghdmFsdWUpIHsKICAgICAgZWxlbS5yZW1vdmVBdHRyKG5hbWUpOwogICAgfQoKICAgIGlmICh2YWx1ZSAhPT0gZWxlbS5wcm9wKG5hbWUpKSB7CiAgICAgIC8vIHZhbHVlIGFuZCBib29sZWFucyBzaG91bGQgYWx3YXlzIGJlIHByb3BlcnRpZXMKICAgICAgZWxlbS5wcm9wKG5hbWUsIHZhbHVlKTsKICAgIH0KICB9IGVsc2UgaWYgKCF2YWx1ZSkgewogICAgZWxlbS5yZW1vdmVBdHRyKG5hbWUpOwogIH0KfTsKCkVtYmVyLlZpZXcuc3RhdGVzID0gc3RhdGVzOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLXZpZXdzCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQ7CgpFbWJlci5WaWV3LnN0YXRlcy5fZGVmYXVsdCA9IHsKICAvLyBhcHBlbmRDaGlsZCBpcyBvbmx5IGxlZ2FsIHdoaWxlIHJlbmRlcmluZyB0aGUgYnVmZmVyLgogIGFwcGVuZENoaWxkOiBmdW5jdGlvbigpIHsKICAgIHRocm93ICJZb3UgY2FuJ3QgdXNlIGFwcGVuZENoaWxkIG91dHNpZGUgb2YgdGhlIHJlbmRlcmluZyBwcm9jZXNzIjsKICB9LAoKICAkOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB1bmRlZmluZWQ7CiAgfSwKCiAgZ2V0RWxlbWVudDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gbnVsbDsKICB9LAoKICAvLyBIYW5kbGUgZXZlbnRzIGZyb20gYEVtYmVyLkV2ZW50RGlzcGF0Y2hlcmAKICBoYW5kbGVFdmVudDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdHJ1ZTsgLy8gY29udGludWUgZXZlbnQgcHJvcGFnYXRpb24KICB9LAoKICBkZXN0cm95RWxlbWVudDogZnVuY3Rpb24odmlldykgewogICAgc2V0KHZpZXcsICdlbGVtZW50JywgbnVsbCk7CiAgICBpZiAodmlldy5fc2NoZWR1bGVkSW5zZXJ0KSB7CiAgICAgIEVtYmVyLnJ1bi5jYW5jZWwodmlldy5fc2NoZWR1bGVkSW5zZXJ0KTsKICAgICAgdmlldy5fc2NoZWR1bGVkSW5zZXJ0ID0gbnVsbDsKICAgIH0KICAgIHJldHVybiB2aWV3OwogIH0sCgogIHJlbmRlclRvQnVmZmVySWZOZWVkZWQ6IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBmYWxzZTsKICB9LAoKICByZXJlbmRlcjogRW1iZXIuSywKICBpbnZva2VPYnNlcnZlcjogRW1iZXIuSwp9OwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLXZpZXdzCiovCgp2YXIgcHJlUmVuZGVyID0gRW1iZXIuVmlldy5zdGF0ZXMucHJlUmVuZGVyID0gRW1iZXIuY3JlYXRlKEVtYmVyLlZpZXcuc3RhdGVzLl9kZWZhdWx0KTsKCkVtYmVyLm1lcmdlKHByZVJlbmRlciwgewogIC8vIGEgdmlldyBsZWF2ZXMgdGhlIHByZVJlbmRlciBzdGF0ZSBvbmNlIGl0cyBlbGVtZW50IGhhcyBiZWVuCiAgLy8gY3JlYXRlZCAoY3JlYXRlRWxlbWVudCkuCiAgaW5zZXJ0RWxlbWVudDogZnVuY3Rpb24odmlldywgZm4pIHsKICAgIHZpZXcuY3JlYXRlRWxlbWVudCgpOwogICAgdmFyIHZpZXdDb2xsZWN0aW9uID0gdmlldy52aWV3SGllcmFyY2h5Q29sbGVjdGlvbigpOwoKICAgIHZpZXdDb2xsZWN0aW9uLnRyaWdnZXIoJ3dpbGxJbnNlcnRFbGVtZW50Jyk7CgogICAgZm4uY2FsbCh2aWV3KTsKCiAgICAvLyBXZSB0cmFuc2l0aW9uIHRvIGBpbkRPTWAgaWYgdGhlIGVsZW1lbnQgZXhpc3RzIGluIHRoZSBET00KICAgIHZhciBlbGVtZW50ID0gdmlldy5nZXQoJ2VsZW1lbnQnKTsKICAgIHdoaWxlIChlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlKSB7CiAgICAgIGlmIChlbGVtZW50ID09PSBkb2N1bWVudCkgewogICAgICAgIHZpZXdDb2xsZWN0aW9uLnRyYW5zaXRpb25UbygnaW5ET00nLCBmYWxzZSk7CiAgICAgICAgdmlld0NvbGxlY3Rpb24udHJpZ2dlcignZGlkSW5zZXJ0RWxlbWVudCcpOwogICAgICB9CiAgICB9CgogIH0sCgogIHJlbmRlclRvQnVmZmVySWZOZWVkZWQ6IGZ1bmN0aW9uKHZpZXcsIGJ1ZmZlcikgewogICAgdmlldy5yZW5kZXJUb0J1ZmZlcihidWZmZXIpOwogICAgcmV0dXJuIHRydWU7CiAgfSwKCiAgZW1wdHk6IEVtYmVyLkssCgogIHNldEVsZW1lbnQ6IGZ1bmN0aW9uKHZpZXcsIHZhbHVlKSB7CiAgICBpZiAodmFsdWUgIT09IG51bGwpIHsKICAgICAgdmlldy50cmFuc2l0aW9uVG8oJ2hhc0VsZW1lbnQnKTsKICAgIH0KICAgIHJldHVybiB2YWx1ZTsKICB9Cn0pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLXZpZXdzCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQ7Cgp2YXIgaW5CdWZmZXIgPSBFbWJlci5WaWV3LnN0YXRlcy5pbkJ1ZmZlciA9IEVtYmVyLmNyZWF0ZShFbWJlci5WaWV3LnN0YXRlcy5fZGVmYXVsdCk7CgpFbWJlci5tZXJnZShpbkJ1ZmZlciwgewogICQ6IGZ1bmN0aW9uKHZpZXcsIHNlbCkgewogICAgLy8gaWYgd2UgZG9uJ3QgaGF2ZSBhbiBlbGVtZW50IHlldCwgc29tZW9uZSBjYWxsaW5nIHRoaXMuJCgpIGlzCiAgICAvLyB0cnlpbmcgdG8gdXBkYXRlIGFuIGVsZW1lbnQgdGhhdCBpc24ndCBpbiB0aGUgRE9NLiBJbnN0ZWFkLAogICAgLy8gcmVyZW5kZXIgdGhlIHZpZXcgdG8gYWxsb3cgdGhlIHJlbmRlciBtZXRob2QgdG8gcmVmbGVjdCB0aGUKICAgIC8vIGNoYW5nZXMuCiAgICB2aWV3LnJlcmVuZGVyKCk7CiAgICByZXR1cm4gRW1iZXIuJCgpOwogIH0sCgogIC8vIHdoZW4gYSB2aWV3IGlzIHJlbmRlcmVkIGluIGEgYnVmZmVyLCByZXJlbmRlcmluZyBpdCBzaW1wbHkKICAvLyByZXBsYWNlcyB0aGUgZXhpc3RpbmcgYnVmZmVyIHdpdGggYSBuZXcgb25lCiAgcmVyZW5kZXI6IGZ1bmN0aW9uKHZpZXcpIHsKICAgIHRocm93IG5ldyBFbWJlci5FcnJvcigiU29tZXRoaW5nIHlvdSBkaWQgY2F1c2VkIGEgdmlldyB0byByZS1yZW5kZXIgYWZ0ZXIgaXQgcmVuZGVyZWQgYnV0IGJlZm9yZSBpdCB3YXMgaW5zZXJ0ZWQgaW50byB0aGUgRE9NLiIpOwogIH0sCgogIC8vIHdoZW4gYSB2aWV3IGlzIHJlbmRlcmVkIGluIGEgYnVmZmVyLCBhcHBlbmRpbmcgYSBjaGlsZAogIC8vIHZpZXcgd2lsbCByZW5kZXIgdGhhdCB2aWV3IGFuZCBhcHBlbmQgdGhlIHJlc3VsdGluZwogIC8vIGJ1ZmZlciBpbnRvIGl0cyBidWZmZXIuCiAgYXBwZW5kQ2hpbGQ6IGZ1bmN0aW9uKHZpZXcsIGNoaWxkVmlldywgb3B0aW9ucykgewogICAgdmFyIGJ1ZmZlciA9IHZpZXcuYnVmZmVyLCBfY2hpbGRWaWV3cyA9IHZpZXcuX2NoaWxkVmlld3M7CgogICAgY2hpbGRWaWV3ID0gdmlldy5jcmVhdGVDaGlsZFZpZXcoY2hpbGRWaWV3LCBvcHRpb25zKTsKICAgIGlmICghX2NoaWxkVmlld3MubGVuZ3RoKSB7IF9jaGlsZFZpZXdzID0gdmlldy5fY2hpbGRWaWV3cyA9IF9jaGlsZFZpZXdzLnNsaWNlKCk7IH0KICAgIF9jaGlsZFZpZXdzLnB1c2goY2hpbGRWaWV3KTsKCiAgICBjaGlsZFZpZXcucmVuZGVyVG9CdWZmZXIoYnVmZmVyKTsKCiAgICB2aWV3LnByb3BlcnR5RGlkQ2hhbmdlKCdjaGlsZFZpZXdzJyk7CgogICAgcmV0dXJuIGNoaWxkVmlldzsKICB9LAoKICAvLyB3aGVuIGEgdmlldyBpcyByZW5kZXJlZCBpbiBhIGJ1ZmZlciwgZGVzdHJveWluZyB0aGUKICAvLyBlbGVtZW50IHdpbGwgc2ltcGx5IGRlc3Ryb3kgdGhlIGJ1ZmZlciBhbmQgcHV0IHRoZQogIC8vIHN0YXRlIGJhY2sgaW50byB0aGUgcHJlUmVuZGVyIHN0YXRlLgogIGRlc3Ryb3lFbGVtZW50OiBmdW5jdGlvbih2aWV3KSB7CiAgICB2aWV3LmNsZWFyQnVmZmVyKCk7CiAgICB2YXIgdmlld0NvbGxlY3Rpb24gPSB2aWV3Ll9ub3RpZnlXaWxsRGVzdHJveUVsZW1lbnQoKTsKICAgIHZpZXdDb2xsZWN0aW9uLnRyYW5zaXRpb25UbygncHJlUmVuZGVyJywgZmFsc2UpOwoKICAgIHJldHVybiB2aWV3OwogIH0sCgogIGVtcHR5OiBmdW5jdGlvbigpIHsKICAgIEVtYmVyLmFzc2VydCgiRW1wdHlpbmcgYSB2aWV3IGluIHRoZSBpbkJ1ZmZlciBzdGF0ZSBpcyBub3QgYWxsb3dlZCBhbmQgIiArCiAgICAgICAgICAgICAgICAgInNob3VsZCBub3QgaGFwcGVuIHVuZGVyIG5vcm1hbCBjaXJjdW1zdGFuY2VzLiBNb3N0IGxpa2VseSAiICsKICAgICAgICAgICAgICAgICAidGhlcmUgaXMgYSBidWcgaW4geW91ciBhcHBsaWNhdGlvbi4gVGhpcyBtYXkgYmUgZHVlIHRvICIgKwogICAgICAgICAgICAgICAgICJleGNlc3NpdmUgcHJvcGVydHkgY2hhbmdlIG5vdGlmaWNhdGlvbnMuIik7CiAgfSwKCiAgcmVuZGVyVG9CdWZmZXJJZk5lZWRlZDogZnVuY3Rpb24gKHZpZXcsIGJ1ZmZlcikgewogICAgcmV0dXJuIGZhbHNlOwogIH0sCgogIC8vIEl0IHNob3VsZCBiZSBpbXBvc3NpYmxlIGZvciBhIHJlbmRlcmVkIHZpZXcgdG8gYmUgc2NoZWR1bGVkIGZvcgogIC8vIGluc2VydGlvbi4KICBpbnNlcnRFbGVtZW50OiBmdW5jdGlvbigpIHsKICAgIHRocm93ICJZb3UgY2FuJ3QgaW5zZXJ0IGFuIGVsZW1lbnQgdGhhdCBoYXMgYWxyZWFkeSBiZWVuIHJlbmRlcmVkIjsKICB9LAoKICBzZXRFbGVtZW50OiBmdW5jdGlvbih2aWV3LCB2YWx1ZSkgewogICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgIHZpZXcudHJhbnNpdGlvblRvKCdwcmVSZW5kZXInKTsKICAgIH0gZWxzZSB7CiAgICAgIHZpZXcuY2xlYXJCdWZmZXIoKTsKICAgICAgdmlldy50cmFuc2l0aW9uVG8oJ2hhc0VsZW1lbnQnKTsKICAgIH0KCiAgICByZXR1cm4gdmFsdWU7CiAgfSwKCiAgaW52b2tlT2JzZXJ2ZXI6IGZ1bmN0aW9uKHRhcmdldCwgb2JzZXJ2ZXIpIHsKICAgIG9ic2VydmVyLmNhbGwodGFyZ2V0KTsKICB9Cn0pOwoKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci12aWV3cwoqLwoKdmFyIGdldCA9IEVtYmVyLmdldCwgc2V0ID0gRW1iZXIuc2V0OwoKdmFyIGhhc0VsZW1lbnQgPSBFbWJlci5WaWV3LnN0YXRlcy5oYXNFbGVtZW50ID0gRW1iZXIuY3JlYXRlKEVtYmVyLlZpZXcuc3RhdGVzLl9kZWZhdWx0KTsKCkVtYmVyLm1lcmdlKGhhc0VsZW1lbnQsIHsKICAkOiBmdW5jdGlvbih2aWV3LCBzZWwpIHsKICAgIHZhciBlbGVtID0gZ2V0KHZpZXcsICdlbGVtZW50Jyk7CiAgICByZXR1cm4gc2VsID8gRW1iZXIuJChzZWwsIGVsZW0pIDogRW1iZXIuJChlbGVtKTsKICB9LAoKICBnZXRFbGVtZW50OiBmdW5jdGlvbih2aWV3KSB7CiAgICB2YXIgcGFyZW50ID0gZ2V0KHZpZXcsICdwYXJlbnRWaWV3Jyk7CiAgICBpZiAocGFyZW50KSB7IHBhcmVudCA9IGdldChwYXJlbnQsICdlbGVtZW50Jyk7IH0KICAgIGlmIChwYXJlbnQpIHsgcmV0dXJuIHZpZXcuZmluZEVsZW1lbnRJblBhcmVudEVsZW1lbnQocGFyZW50KTsgfQogICAgcmV0dXJuIEVtYmVyLiQoIiMiICsgZ2V0KHZpZXcsICdlbGVtZW50SWQnKSlbMF07CiAgfSwKCiAgc2V0RWxlbWVudDogZnVuY3Rpb24odmlldywgdmFsdWUpIHsKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICB2aWV3LnRyYW5zaXRpb25UbygncHJlUmVuZGVyJyk7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyAiWW91IGNhbm5vdCBzZXQgYW4gZWxlbWVudCB0byBhIG5vbi1udWxsIHZhbHVlIHdoZW4gdGhlIGVsZW1lbnQgaXMgYWxyZWFkeSBpbiB0aGUgRE9NLiI7CiAgICB9CgogICAgcmV0dXJuIHZhbHVlOwogIH0sCgogIC8vIG9uY2UgdGhlIHZpZXcgaGFzIGJlZW4gaW5zZXJ0ZWQgaW50byB0aGUgRE9NLCByZXJlbmRlcmluZyBpcwogIC8vIGRlZmVycmVkIHRvIGFsbG93IGJpbmRpbmdzIHRvIHN5bmNocm9uaXplLgogIHJlcmVuZGVyOiBmdW5jdGlvbih2aWV3KSB7CiAgICB2aWV3LnRyaWdnZXJSZWN1cnNpdmVseSgnd2lsbENsZWFyUmVuZGVyJyk7CgogICAgdmlldy5jbGVhclJlbmRlcmVkQ2hpbGRyZW4oKTsKCiAgICB2aWV3LmRvbU1hbmFnZXIucmVwbGFjZSh2aWV3KTsKICAgIHJldHVybiB2aWV3OwogIH0sCgogIC8vIG9uY2UgdGhlIHZpZXcgaXMgYWxyZWFkeSBpbiB0aGUgRE9NLCBkZXN0cm95aW5nIGl0IHJlbW92ZXMgaXQKICAvLyBmcm9tIHRoZSBET00sIG51a2VzIGl0cyBlbGVtZW50LCBhbmQgcHV0cyBpdCBiYWNrIGludG8gdGhlCiAgLy8gcHJlUmVuZGVyIHN0YXRlIGlmIGluRE9NLgoKICBkZXN0cm95RWxlbWVudDogZnVuY3Rpb24odmlldykgewogICAgdmlldy5fbm90aWZ5V2lsbERlc3Ryb3lFbGVtZW50KCk7CiAgICB2aWV3LmRvbU1hbmFnZXIucmVtb3ZlKHZpZXcpOwogICAgc2V0KHZpZXcsICdlbGVtZW50JywgbnVsbCk7CiAgICBpZiAodmlldy5fc2NoZWR1bGVkSW5zZXJ0KSB7CiAgICAgIEVtYmVyLnJ1bi5jYW5jZWwodmlldy5fc2NoZWR1bGVkSW5zZXJ0KTsKICAgICAgdmlldy5fc2NoZWR1bGVkSW5zZXJ0ID0gbnVsbDsKICAgIH0KICAgIHJldHVybiB2aWV3OwogIH0sCgogIGVtcHR5OiBmdW5jdGlvbih2aWV3KSB7CiAgICB2YXIgX2NoaWxkVmlld3MgPSB2aWV3Ll9jaGlsZFZpZXdzLCBsZW4sIGlkeDsKICAgIGlmIChfY2hpbGRWaWV3cykgewogICAgICBsZW4gPSBfY2hpbGRWaWV3cy5sZW5ndGg7CiAgICAgIGZvciAoaWR4ID0gMDsgaWR4IDwgbGVuOyBpZHgrKykgewogICAgICAgIF9jaGlsZFZpZXdzW2lkeF0uX25vdGlmeVdpbGxEZXN0cm95RWxlbWVudCgpOwogICAgICB9CiAgICB9CiAgICB2aWV3LmRvbU1hbmFnZXIuZW1wdHkodmlldyk7CiAgfSwKCiAgLy8gSGFuZGxlIGV2ZW50cyBmcm9tIGBFbWJlci5FdmVudERpc3BhdGNoZXJgCiAgaGFuZGxlRXZlbnQ6IGZ1bmN0aW9uKHZpZXcsIGV2ZW50TmFtZSwgZXZ0KSB7CiAgICBpZiAodmlldy5oYXMoZXZlbnROYW1lKSkgewogICAgICAvLyBIYW5kbGVyIHNob3VsZCBiZSBhYmxlIHRvIHJlLWRpc3BhdGNoIGV2ZW50cywgc28gd2UgZG9uJ3QKICAgICAgLy8gcHJldmVudERlZmF1bHQgb3Igc3RvcFByb3BhZ2F0aW9uLgogICAgICByZXR1cm4gdmlldy50cmlnZ2VyKGV2ZW50TmFtZSwgZXZ0KTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0cnVlOyAvLyBjb250aW51ZSBldmVudCBwcm9wYWdhdGlvbgogICAgfQogIH0sCgogIGludm9rZU9ic2VydmVyOiBmdW5jdGlvbih0YXJnZXQsIG9ic2VydmVyKSB7CiAgICBvYnNlcnZlci5jYWxsKHRhcmdldCk7CiAgfQp9KTsKCnZhciBpbkRPTSA9IEVtYmVyLlZpZXcuc3RhdGVzLmluRE9NID0gRW1iZXIuY3JlYXRlKGhhc0VsZW1lbnQpOwoKRW1iZXIubWVyZ2UoaW5ET00sIHsKICBlbnRlcjogZnVuY3Rpb24odmlldykgewogICAgLy8gUmVnaXN0ZXIgdGhlIHZpZXcgZm9yIGV2ZW50IGhhbmRsaW5nLiBUaGlzIGhhc2ggaXMgdXNlZCBieQogICAgLy8gRW1iZXIuRXZlbnREaXNwYXRjaGVyIHRvIGRpc3BhdGNoIGluY29taW5nIGV2ZW50cy4KICAgIGlmICghdmlldy5pc1ZpcnR1YWwpIHsKICAgICAgRW1iZXIuYXNzZXJ0KCJBdHRlbXB0ZWQgdG8gcmVnaXN0ZXIgYSB2aWV3IHdpdGggYW4gaWQgYWxyZWFkeSBpbiB1c2U6ICIrdmlldy5lbGVtZW50SWQsICFFbWJlci5WaWV3LnZpZXdzW3ZpZXcuZWxlbWVudElkXSk7CiAgICAgIEVtYmVyLlZpZXcudmlld3Nbdmlldy5lbGVtZW50SWRdID0gdmlldzsKICAgIH0KCiAgICB2aWV3LmFkZEJlZm9yZU9ic2VydmVyKCdlbGVtZW50SWQnLCBmdW5jdGlvbigpIHsKICAgICAgdGhyb3cgbmV3IEVtYmVyLkVycm9yKCJDaGFuZ2luZyBhIHZpZXcncyBlbGVtZW50SWQgYWZ0ZXIgY3JlYXRpb24gaXMgbm90IGFsbG93ZWQiKTsKICAgIH0pOwogIH0sCgogIGV4aXQ6IGZ1bmN0aW9uKHZpZXcpIHsKICAgIGlmICghdGhpcy5pc1ZpcnR1YWwpIGRlbGV0ZSBFbWJlci5WaWV3LnZpZXdzW3ZpZXcuZWxlbWVudElkXTsKICB9LAoKICBpbnNlcnRFbGVtZW50OiBmdW5jdGlvbih2aWV3LCBmbikgewogICAgdGhyb3cgIllvdSBjYW4ndCBpbnNlcnQgYW4gZWxlbWVudCBpbnRvIHRoZSBET00gdGhhdCBoYXMgYWxyZWFkeSBiZWVuIGluc2VydGVkIjsKICB9Cn0pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLXZpZXdzCiovCgp2YXIgZGVzdHJveWluZ0Vycm9yID0gIllvdSBjYW4ndCBjYWxsICVAIG9uIGEgdmlldyBiZWluZyBkZXN0cm95ZWQiLCBmbXQgPSBFbWJlci5TdHJpbmcuZm10OwoKdmFyIGRlc3Ryb3lpbmcgPSBFbWJlci5WaWV3LnN0YXRlcy5kZXN0cm95aW5nID0gRW1iZXIuY3JlYXRlKEVtYmVyLlZpZXcuc3RhdGVzLl9kZWZhdWx0KTsKCkVtYmVyLm1lcmdlKGRlc3Ryb3lpbmcsIHsKICBhcHBlbmRDaGlsZDogZnVuY3Rpb24oKSB7CiAgICB0aHJvdyBmbXQoZGVzdHJveWluZ0Vycm9yLCBbJ2FwcGVuZENoaWxkJ10pOwogIH0sCiAgcmVyZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgdGhyb3cgZm10KGRlc3Ryb3lpbmdFcnJvciwgWydyZXJlbmRlciddKTsKICB9LAogIGRlc3Ryb3lFbGVtZW50OiBmdW5jdGlvbigpIHsKICAgIHRocm93IGZtdChkZXN0cm95aW5nRXJyb3IsIFsnZGVzdHJveUVsZW1lbnQnXSk7CiAgfSwKICBlbXB0eTogZnVuY3Rpb24oKSB7CiAgICB0aHJvdyBmbXQoZGVzdHJveWluZ0Vycm9yLCBbJ2VtcHR5J10pOwogIH0sCgogIHNldEVsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgdGhyb3cgZm10KGRlc3Ryb3lpbmdFcnJvciwgWyJzZXQoJ2VsZW1lbnQnLCAuLi4pIl0pOwogIH0sCgogIHJlbmRlclRvQnVmZmVySWZOZWVkZWQ6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0sCgogIC8vIFNpbmNlIGVsZW1lbnQgaW5zZXJ0aW9uIGlzIHNjaGVkdWxlZCwgZG9uJ3QgZG8gYW55dGhpbmcgaWYKICAvLyB0aGUgdmlldyBoYXMgYmVlbiBkZXN0cm95ZWQgYmV0d2VlbiBzY2hlZHVsaW5nIGFuZCBleGVjdXRpb24KICBpbnNlcnRFbGVtZW50OiBFbWJlci5LCn0pOwoKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKRW1iZXIuVmlldy5jbG9uZVN0YXRlcyA9IGZ1bmN0aW9uKGZyb20pIHsKICB2YXIgaW50byA9IHt9OwoKICBpbnRvLl9kZWZhdWx0ID0ge307CiAgaW50by5wcmVSZW5kZXIgPSBFbWJlci5jcmVhdGUoaW50by5fZGVmYXVsdCk7CiAgaW50by5kZXN0cm95aW5nID0gRW1iZXIuY3JlYXRlKGludG8uX2RlZmF1bHQpOwogIGludG8uaW5CdWZmZXIgPSBFbWJlci5jcmVhdGUoaW50by5fZGVmYXVsdCk7CiAgaW50by5oYXNFbGVtZW50ID0gRW1iZXIuY3JlYXRlKGludG8uX2RlZmF1bHQpOwogIGludG8uaW5ET00gPSBFbWJlci5jcmVhdGUoaW50by5oYXNFbGVtZW50KTsKCiAgZm9yICh2YXIgc3RhdGVOYW1lIGluIGZyb20pIHsKICAgIGlmICghZnJvbS5oYXNPd25Qcm9wZXJ0eShzdGF0ZU5hbWUpKSB7IGNvbnRpbnVlOyB9CiAgICBFbWJlci5tZXJnZShpbnRvW3N0YXRlTmFtZV0sIGZyb21bc3RhdGVOYW1lXSk7CiAgfQoKICByZXR1cm4gaW50bzsKfTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKdmFyIHN0YXRlcyA9IEVtYmVyLlZpZXcuY2xvbmVTdGF0ZXMoRW1iZXIuVmlldy5zdGF0ZXMpOwoKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci12aWV3cwoqLwoKdmFyIGdldCA9IEVtYmVyLmdldCwgc2V0ID0gRW1iZXIuc2V0Owp2YXIgZm9yRWFjaCA9IEVtYmVyLkVudW1lcmFibGVVdGlscy5mb3JFYWNoOwp2YXIgVmlld0NvbGxlY3Rpb24gPSBFbWJlci5fVmlld0NvbGxlY3Rpb247CgovKioKICBBIGBDb250YWluZXJWaWV3YCBpcyBhbiBgRW1iZXIuVmlld2Agc3ViY2xhc3MgdGhhdCBpbXBsZW1lbnRzIGBFbWJlci5NdXRhYmxlQXJyYXlgCiAgYWxsb3dpbmcgcHJvZ3JhbW1hdGljIG1hbmFnZW1lbnQgb2YgaXRzIGNoaWxkIHZpZXdzLgoKICAjIyBTZXR0aW5nIEluaXRpYWwgQ2hpbGQgVmlld3MKCiAgVGhlIGluaXRpYWwgYXJyYXkgb2YgY2hpbGQgdmlld3MgY2FuIGJlIHNldCBpbiBvbmUgb2YgdHdvIHdheXMuIFlvdSBjYW4KICBwcm92aWRlIGEgYGNoaWxkVmlld3NgIHByb3BlcnR5IGF0IGNyZWF0aW9uIHRpbWUgdGhhdCBjb250YWlucyBpbnN0YW5jZSBvZgogIGBFbWJlci5WaWV3YDoKCiAgYGBgamF2YXNjcmlwdAogIGFDb250YWluZXIgPSBFbWJlci5Db250YWluZXJWaWV3LmNyZWF0ZSh7CiAgICBjaGlsZFZpZXdzOiBbRW1iZXIuVmlldy5jcmVhdGUoKSwgRW1iZXIuVmlldy5jcmVhdGUoKV0KICB9KTsKICBgYGAKCiAgWW91IGNhbiBhbHNvIHByb3ZpZGUgYSBsaXN0IG9mIHByb3BlcnR5IG5hbWVzIHdob3NlIHZhbHVlcyBhcmUgaW5zdGFuY2VzIG9mCiAgYEVtYmVyLlZpZXdgOgoKICBgYGBqYXZhc2NyaXB0CiAgYUNvbnRhaW5lciA9IEVtYmVyLkNvbnRhaW5lclZpZXcuY3JlYXRlKHsKICAgIGNoaWxkVmlld3M6IFsnYVZpZXcnLCAnYlZpZXcnLCAnY1ZpZXcnXSwKICAgIGFWaWV3OiBFbWJlci5WaWV3LmNyZWF0ZSgpLAogICAgYlZpZXc6IEVtYmVyLlZpZXcuY3JlYXRlKCksCiAgICBjVmlldzogRW1iZXIuVmlldy5jcmVhdGUoKQogIH0pOwogIGBgYAoKICBUaGUgdHdvIHN0cmF0ZWdpZXMgY2FuIGJlIGNvbWJpbmVkOgoKICBgYGBqYXZhc2NyaXB0CiAgYUNvbnRhaW5lciA9IEVtYmVyLkNvbnRhaW5lclZpZXcuY3JlYXRlKHsKICAgIGNoaWxkVmlld3M6IFsnYVZpZXcnLCBFbWJlci5WaWV3LmNyZWF0ZSgpXSwKICAgIGFWaWV3OiBFbWJlci5WaWV3LmNyZWF0ZSgpCiAgfSk7CiAgYGBgCgogIEVhY2ggY2hpbGQgdmlldydzIHJlbmRlcmluZyB3aWxsIGJlIGluc2VydGVkIGludG8gdGhlIGNvbnRhaW5lcidzIHJlbmRlcmVkCiAgSFRNTCBpbiB0aGUgc2FtZSBvcmRlciBhcyBpdHMgcG9zaXRpb24gaW4gdGhlIGBjaGlsZFZpZXdzYCBwcm9wZXJ0eS4KCiAgIyMgQWRkaW5nIGFuZCBSZW1vdmluZyBDaGlsZCBWaWV3cwoKICBUaGUgY29udGFpbmVyIHZpZXcgaW1wbGVtZW50cyBgRW1iZXIuTXV0YWJsZUFycmF5YCBhbGxvd2luZyBwcm9ncmFtbWF0aWMgbWFuYWdlbWVudCBvZiBpdHMgY2hpbGQgdmlld3MuCgogIFRvIHJlbW92ZSBhIHZpZXcsIHBhc3MgdGhhdCB2aWV3IGludG8gYSBgcmVtb3ZlT2JqZWN0YCBjYWxsIG9uIHRoZSBjb250YWluZXIgdmlldy4KCiAgR2l2ZW4gYW4gZW1wdHkgYDxib2R5PmAgdGhlIGZvbGxvd2luZyBjb2RlCgogIGBgYGphdmFzY3JpcHQKICBhQ29udGFpbmVyID0gRW1iZXIuQ29udGFpbmVyVmlldy5jcmVhdGUoewogICAgY2xhc3NOYW1lczogWyd0aGUtY29udGFpbmVyJ10sCiAgICBjaGlsZFZpZXdzOiBbJ2FWaWV3JywgJ2JWaWV3J10sCiAgICBhVmlldzogRW1iZXIuVmlldy5jcmVhdGUoewogICAgICB0ZW1wbGF0ZTogRW1iZXIuSGFuZGxlYmFycy5jb21waWxlKCJBIikKICAgIH0pLAogICAgYlZpZXc6IEVtYmVyLlZpZXcuY3JlYXRlKHsKICAgICAgdGVtcGxhdGU6IEVtYmVyLkhhbmRsZWJhcnMuY29tcGlsZSgiQiIpCiAgICB9KQogIH0pOwoKICBhQ29udGFpbmVyLmFwcGVuZFRvKCdib2R5Jyk7CiAgYGBgCgogIFJlc3VsdHMgaW4gdGhlIEhUTUwKCiAgYGBgaHRtbAogIDxkaXYgY2xhc3M9ImVtYmVyLXZpZXcgdGhlLWNvbnRhaW5lciI+CiAgICA8ZGl2IGNsYXNzPSJlbWJlci12aWV3Ij5BPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJlbWJlci12aWV3Ij5CPC9kaXY+CiAgPC9kaXY+CiAgYGBgCgogIFJlbW92aW5nIGEgdmlldwoKICBgYGBqYXZhc2NyaXB0CiAgYUNvbnRhaW5lci50b0FycmF5KCk7ICAvLyBbYUNvbnRhaW5lci5hVmlldywgYUNvbnRhaW5lci5iVmlld10KICBhQ29udGFpbmVyLnJlbW92ZU9iamVjdChhQ29udGFpbmVyLmdldCgnYlZpZXcnKSk7CiAgYUNvbnRhaW5lci50b0FycmF5KCk7ICAvLyBbYUNvbnRhaW5lci5hVmlld10KICBgYGAKCiAgV2lsbCByZXN1bHQgaW4gdGhlIGZvbGxvd2luZyBIVE1MCgogIGBgYGh0bWwKICA8ZGl2IGNsYXNzPSJlbWJlci12aWV3IHRoZS1jb250YWluZXIiPgogICAgPGRpdiBjbGFzcz0iZW1iZXItdmlldyI+QTwvZGl2PgogIDwvZGl2PgogIGBgYAoKICBTaW1pbGFybHksIGFkZGluZyBhIGNoaWxkIHZpZXcgaXMgYWNjb21wbGlzaGVkIGJ5IGFkZGluZyBgRW1iZXIuVmlld2AgaW5zdGFuY2VzIHRvIHRoZQogIGNvbnRhaW5lciB2aWV3LgoKICBHaXZlbiBhbiBlbXB0eSBgPGJvZHk+YCB0aGUgZm9sbG93aW5nIGNvZGUKCiAgYGBgamF2YXNjcmlwdAogIGFDb250YWluZXIgPSBFbWJlci5Db250YWluZXJWaWV3LmNyZWF0ZSh7CiAgICBjbGFzc05hbWVzOiBbJ3RoZS1jb250YWluZXInXSwKICAgIGNoaWxkVmlld3M6IFsnYVZpZXcnLCAnYlZpZXcnXSwKICAgIGFWaWV3OiBFbWJlci5WaWV3LmNyZWF0ZSh7CiAgICAgIHRlbXBsYXRlOiBFbWJlci5IYW5kbGViYXJzLmNvbXBpbGUoIkEiKQogICAgfSksCiAgICBiVmlldzogRW1iZXIuVmlldy5jcmVhdGUoewogICAgICB0ZW1wbGF0ZTogRW1iZXIuSGFuZGxlYmFycy5jb21waWxlKCJCIikKICAgIH0pCiAgfSk7CgogIGFDb250YWluZXIuYXBwZW5kVG8oJ2JvZHknKTsKICBgYGAKCiAgUmVzdWx0cyBpbiB0aGUgSFRNTAoKICBgYGBodG1sCiAgPGRpdiBjbGFzcz0iZW1iZXItdmlldyB0aGUtY29udGFpbmVyIj4KICAgIDxkaXYgY2xhc3M9ImVtYmVyLXZpZXciPkE8L2Rpdj4KICAgIDxkaXYgY2xhc3M9ImVtYmVyLXZpZXciPkI8L2Rpdj4KICA8L2Rpdj4KICBgYGAKCiAgQWRkaW5nIGEgdmlldwoKICBgYGBqYXZhc2NyaXB0CiAgQW5vdGhlclZpZXdDbGFzcyA9IEVtYmVyLlZpZXcuZXh0ZW5kKHsKICAgIHRlbXBsYXRlOiBFbWJlci5IYW5kbGViYXJzLmNvbXBpbGUoIkFub3RoZXIgdmlldyIpCiAgfSk7CgogIGFDb250YWluZXIudG9BcnJheSgpOyAgLy8gW2FDb250YWluZXIuYVZpZXcsIGFDb250YWluZXIuYlZpZXddCiAgYUNvbnRhaW5lci5wdXNoT2JqZWN0KEFub3RoZXJWaWV3Q2xhc3MuY3JlYXRlKCkpOwogIGFDb250YWluZXIudG9BcnJheSgpOyAvLyBbYUNvbnRhaW5lci5hVmlldywgYUNvbnRhaW5lci5iVmlldywgPEFub3RoZXJWaWV3Q2xhc3MgaW5zdGFuY2U+XQogIGBgYAoKICBXaWxsIHJlc3VsdCBpbiB0aGUgZm9sbG93aW5nIEhUTUwKCiAgYGBgaHRtbAogIDxkaXYgY2xhc3M9ImVtYmVyLXZpZXcgdGhlLWNvbnRhaW5lciI+CiAgICA8ZGl2IGNsYXNzPSJlbWJlci12aWV3Ij5BPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJlbWJlci12aWV3Ij5CPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJlbWJlci12aWV3Ij5Bbm90aGVyIHZpZXc8L2Rpdj4KICA8L2Rpdj4KICBgYGAKCiAgIyMgVGVtcGxhdGVzIGFuZCBMYXlvdXQKCiAgQSBgdGVtcGxhdGVgLCBgdGVtcGxhdGVOYW1lYCwgYGRlZmF1bHRUZW1wbGF0ZWAsIGBsYXlvdXRgLCBgbGF5b3V0TmFtZWAgb3IKICBgZGVmYXVsdExheW91dGAgcHJvcGVydHkgb24gYSBjb250YWluZXIgdmlldyB3aWxsIG5vdCByZXN1bHQgaW4gdGhlIHRlbXBsYXRlCiAgb3IgbGF5b3V0IGJlaW5nIHJlbmRlcmVkLiBUaGUgSFRNTCBjb250ZW50cyBvZiBhIGBFbWJlci5Db250YWluZXJWaWV3YCdzIERPTQogIHJlcHJlc2VudGF0aW9uIHdpbGwgb25seSBiZSB0aGUgcmVuZGVyZWQgSFRNTCBvZiBpdHMgY2hpbGQgdmlld3MuCgogIEBjbGFzcyBDb250YWluZXJWaWV3CiAgQG5hbWVzcGFjZSBFbWJlcgogIEBleHRlbmRzIEVtYmVyLlZpZXcKKi8KRW1iZXIuQ29udGFpbmVyVmlldyA9IEVtYmVyLlZpZXcuZXh0ZW5kKEVtYmVyLk11dGFibGVBcnJheSwgewogIHN0YXRlczogc3RhdGVzLAoKICBpbml0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3N1cGVyKCk7CgogICAgdmFyIGNoaWxkVmlld3MgPSBnZXQodGhpcywgJ2NoaWxkVmlld3MnKTsKCiAgICAvLyByZWRlZmluZSB2aWV3J3MgY2hpbGRWaWV3cyBwcm9wZXJ0eSB0aGF0IHdhcyBvYmxpdGVyYXRlZAogICAgRW1iZXIuZGVmaW5lUHJvcGVydHkodGhpcywgJ2NoaWxkVmlld3MnLCBFbWJlci5WaWV3LmNoaWxkVmlld3NQcm9wZXJ0eSk7CgogICAgdmFyIF9jaGlsZFZpZXdzID0gdGhpcy5fY2hpbGRWaWV3czsKCiAgICBmb3JFYWNoKGNoaWxkVmlld3MsIGZ1bmN0aW9uKHZpZXdOYW1lLCBpZHgpIHsKICAgICAgdmFyIHZpZXc7CgogICAgICBpZiAoJ3N0cmluZycgPT09IHR5cGVvZiB2aWV3TmFtZSkgewogICAgICAgIHZpZXcgPSBnZXQodGhpcywgdmlld05hbWUpOwogICAgICAgIHZpZXcgPSB0aGlzLmNyZWF0ZUNoaWxkVmlldyh2aWV3KTsKICAgICAgICBzZXQodGhpcywgdmlld05hbWUsIHZpZXcpOwogICAgICB9IGVsc2UgewogICAgICAgIHZpZXcgPSB0aGlzLmNyZWF0ZUNoaWxkVmlldyh2aWV3TmFtZSk7CiAgICAgIH0KCiAgICAgIF9jaGlsZFZpZXdzW2lkeF0gPSB2aWV3OwogICAgfSwgdGhpcyk7CgogICAgdmFyIGN1cnJlbnRWaWV3ID0gZ2V0KHRoaXMsICdjdXJyZW50VmlldycpOwogICAgaWYgKGN1cnJlbnRWaWV3KSB7CiAgICAgIGlmICghX2NoaWxkVmlld3MubGVuZ3RoKSB7IF9jaGlsZFZpZXdzID0gdGhpcy5fY2hpbGRWaWV3cyA9IHRoaXMuX2NoaWxkVmlld3Muc2xpY2UoKTsgfQogICAgICBfY2hpbGRWaWV3cy5wdXNoKHRoaXMuY3JlYXRlQ2hpbGRWaWV3KGN1cnJlbnRWaWV3KSk7CiAgICB9CiAgfSwKCiAgcmVwbGFjZTogZnVuY3Rpb24oaWR4LCByZW1vdmVkQ291bnQsIGFkZGVkVmlld3MpIHsKICAgIHZhciBhZGRlZENvdW50ID0gYWRkZWRWaWV3cyA/IGdldChhZGRlZFZpZXdzLCAnbGVuZ3RoJykgOiAwOwogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgRW1iZXIuYXNzZXJ0KCJZb3UgY2FuJ3QgYWRkIGEgY2hpbGQgdG8gYSBjb250YWluZXIgdGhhdCBpcyBhbHJlYWR5IGEgY2hpbGQgb2YgYW5vdGhlciB2aWV3IiwgRW1iZXIuQShhZGRlZFZpZXdzKS5ldmVyeShmdW5jdGlvbihpdGVtKSB7IHJldHVybiAhZ2V0KGl0ZW0sICdfcGFyZW50VmlldycpIHx8IGdldChpdGVtLCAnX3BhcmVudFZpZXcnKSA9PT0gc2VsZjsgfSkpOwoKICAgIHRoaXMuYXJyYXlDb250ZW50V2lsbENoYW5nZShpZHgsIHJlbW92ZWRDb3VudCwgYWRkZWRDb3VudCk7CiAgICB0aGlzLmNoaWxkVmlld3NXaWxsQ2hhbmdlKHRoaXMuX2NoaWxkVmlld3MsIGlkeCwgcmVtb3ZlZENvdW50KTsKCiAgICBpZiAoYWRkZWRDb3VudCA9PT0gMCkgewogICAgICB0aGlzLl9jaGlsZFZpZXdzLnNwbGljZShpZHgsIHJlbW92ZWRDb3VudCkgOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGFyZ3MgPSBbaWR4LCByZW1vdmVkQ291bnRdLmNvbmNhdChhZGRlZFZpZXdzKTsKICAgICAgaWYgKGFkZGVkVmlld3MubGVuZ3RoICYmICF0aGlzLl9jaGlsZFZpZXdzLmxlbmd0aCkgeyB0aGlzLl9jaGlsZFZpZXdzID0gdGhpcy5fY2hpbGRWaWV3cy5zbGljZSgpOyB9CiAgICAgIHRoaXMuX2NoaWxkVmlld3Muc3BsaWNlLmFwcGx5KHRoaXMuX2NoaWxkVmlld3MsIGFyZ3MpOwogICAgfQoKICAgIHRoaXMuYXJyYXlDb250ZW50RGlkQ2hhbmdlKGlkeCwgcmVtb3ZlZENvdW50LCBhZGRlZENvdW50KTsKICAgIHRoaXMuY2hpbGRWaWV3c0RpZENoYW5nZSh0aGlzLl9jaGlsZFZpZXdzLCBpZHgsIHJlbW92ZWRDb3VudCwgYWRkZWRDb3VudCk7CgogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgb2JqZWN0QXQ6IGZ1bmN0aW9uKGlkeCkgewogICAgcmV0dXJuIHRoaXMuX2NoaWxkVmlld3NbaWR4XTsKICB9LAoKICBsZW5ndGg6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9jaGlsZFZpZXdzLmxlbmd0aDsKICB9KS52b2xhdGlsZSgpLAoKICAvKioKICAgIEluc3RydWN0cyBlYWNoIGNoaWxkIHZpZXcgdG8gcmVuZGVyIHRvIHRoZSBwYXNzZWQgcmVuZGVyIGJ1ZmZlci4KCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCByZW5kZXIKICAgIEBwYXJhbSB7RW1iZXIuUmVuZGVyQnVmZmVyfSBidWZmZXIgdGhlIGJ1ZmZlciB0byByZW5kZXIgdG8KICAqLwogIHJlbmRlcjogZnVuY3Rpb24oYnVmZmVyKSB7CiAgICB0aGlzLmZvckVhY2hDaGlsZFZpZXcoZnVuY3Rpb24odmlldykgewogICAgICB2aWV3LnJlbmRlclRvQnVmZmVyKGJ1ZmZlcik7CiAgICB9KTsKICB9LAoKICBpbnN0cnVtZW50TmFtZTogJ2NvbnRhaW5lcicsCgogIC8qKgogICAgV2hlbiBhIGNoaWxkIHZpZXcgaXMgcmVtb3ZlZCwgZGVzdHJveSBpdHMgZWxlbWVudCBzbyB0aGF0CiAgICBpdCBpcyByZW1vdmVkIGZyb20gdGhlIERPTS4KCiAgICBUaGUgYXJyYXkgb2JzZXJ2ZXIgdGhhdCB0cmlnZ2VycyB0aGlzIGFjdGlvbiBpcyBzZXQgdXAgaW4gdGhlCiAgICBgcmVuZGVyVG9CdWZmZXJgIG1ldGhvZC4KCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBjaGlsZFZpZXdzV2lsbENoYW5nZQogICAgQHBhcmFtIHtFbWJlci5BcnJheX0gdmlld3MgdGhlIGNoaWxkIHZpZXdzIGFycmF5IGJlZm9yZSBtdXRhdGlvbgogICAgQHBhcmFtIHtOdW1iZXJ9IHN0YXJ0IHRoZSBzdGFydCBwb3NpdGlvbiBvZiB0aGUgbXV0YXRpb24KICAgIEBwYXJhbSB7TnVtYmVyfSByZW1vdmVkIHRoZSBudW1iZXIgb2YgY2hpbGQgdmlld3MgcmVtb3ZlZAogICoqLwogIGNoaWxkVmlld3NXaWxsQ2hhbmdlOiBmdW5jdGlvbih2aWV3cywgc3RhcnQsIHJlbW92ZWQpIHsKICAgIHRoaXMucHJvcGVydHlXaWxsQ2hhbmdlKCdjaGlsZFZpZXdzJyk7CgogICAgaWYgKHJlbW92ZWQgPiAwKSB7CiAgICAgIHZhciBjaGFuZ2VkVmlld3MgPSB2aWV3cy5zbGljZShzdGFydCwgc3RhcnQrcmVtb3ZlZCk7CiAgICAgIC8vIHRyYW5zaXRpb24gdG8gcHJlUmVuZGVyIGJlZm9yZSBjbGVhcmluZyBwYXJlbnRWaWV3CiAgICAgIHRoaXMuY3VycmVudFN0YXRlLmNoaWxkVmlld3NXaWxsQ2hhbmdlKHRoaXMsIHZpZXdzLCBzdGFydCwgcmVtb3ZlZCk7CiAgICAgIHRoaXMuaW5pdGlhbGl6ZVZpZXdzKGNoYW5nZWRWaWV3cywgbnVsbCwgbnVsbCk7CiAgICB9CiAgfSwKCiAgcmVtb3ZlQ2hpbGQ6IGZ1bmN0aW9uKGNoaWxkKSB7CiAgICB0aGlzLnJlbW92ZU9iamVjdChjaGlsZCk7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvKioKICAgIFdoZW4gYSBjaGlsZCB2aWV3IGlzIGFkZGVkLCBtYWtlIHN1cmUgdGhlIERPTSBnZXRzIHVwZGF0ZWQgYXBwcm9wcmlhdGVseS4KCiAgICBJZiB0aGUgdmlldyBoYXMgYWxyZWFkeSByZW5kZXJlZCBhbiBlbGVtZW50LCB3ZSB0ZWxsIHRoZSBjaGlsZCB2aWV3IHRvCiAgICBjcmVhdGUgYW4gZWxlbWVudCBhbmQgaW5zZXJ0IGl0IGludG8gdGhlIERPTS4gSWYgdGhlIGVuY2xvc2luZyBjb250YWluZXIKICAgIHZpZXcgaGFzIGFscmVhZHkgd3JpdHRlbiB0byBhIGJ1ZmZlciwgYnV0IG5vdCB5ZXQgY29udmVydGVkIHRoYXQgYnVmZmVyCiAgICBpbnRvIGFuIGVsZW1lbnQsIHdlIGluc2VydCB0aGUgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBjaGlsZCBpbnRvIHRoZQogICAgYXBwcm9wcmlhdGUgcGxhY2UgaW4gdGhlIGJ1ZmZlci4KCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBjaGlsZFZpZXdzRGlkQ2hhbmdlCiAgICBAcGFyYW0ge0VtYmVyLkFycmF5fSB2aWV3cyB0aGUgYXJyYXkgb2YgY2hpbGQgdmlld3MgYWZ0ZSB0aGUgbXV0YXRpb24gaGFzIG9jY3VycmVkCiAgICBAcGFyYW0ge051bWJlcn0gc3RhcnQgdGhlIHN0YXJ0IHBvc2l0aW9uIG9mIHRoZSBtdXRhdGlvbgogICAgQHBhcmFtIHtOdW1iZXJ9IHJlbW92ZWQgdGhlIG51bWJlciBvZiBjaGlsZCB2aWV3cyByZW1vdmVkCiAgICBAcGFyYW0ge051bWJlcn0gdGhlIG51bWJlciBvZiBjaGlsZCB2aWV3cyBhZGRlZAogICovCiAgY2hpbGRWaWV3c0RpZENoYW5nZTogZnVuY3Rpb24odmlld3MsIHN0YXJ0LCByZW1vdmVkLCBhZGRlZCkgewogICAgaWYgKGFkZGVkID4gMCkgewogICAgICB2YXIgY2hhbmdlZFZpZXdzID0gdmlld3Muc2xpY2Uoc3RhcnQsIHN0YXJ0K2FkZGVkKTsKICAgICAgdGhpcy5pbml0aWFsaXplVmlld3MoY2hhbmdlZFZpZXdzLCB0aGlzLCBnZXQodGhpcywgJ3RlbXBsYXRlRGF0YScpKTsKICAgICAgdGhpcy5jdXJyZW50U3RhdGUuY2hpbGRWaWV3c0RpZENoYW5nZSh0aGlzLCB2aWV3cywgc3RhcnQsIGFkZGVkKTsKICAgIH0KICAgIHRoaXMucHJvcGVydHlEaWRDaGFuZ2UoJ2NoaWxkVmlld3MnKTsKICB9LAoKICBpbml0aWFsaXplVmlld3M6IGZ1bmN0aW9uKHZpZXdzLCBwYXJlbnRWaWV3LCB0ZW1wbGF0ZURhdGEpIHsKICAgIGZvckVhY2godmlld3MsIGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgc2V0KHZpZXcsICdfcGFyZW50VmlldycsIHBhcmVudFZpZXcpOwoKICAgICAgaWYgKCF2aWV3LmNvbnRhaW5lciAmJiBwYXJlbnRWaWV3KSB7CiAgICAgICAgc2V0KHZpZXcsICdjb250YWluZXInLCBwYXJlbnRWaWV3LmNvbnRhaW5lcik7CiAgICAgIH0KCiAgICAgIGlmICghZ2V0KHZpZXcsICd0ZW1wbGF0ZURhdGEnKSkgewogICAgICAgIHNldCh2aWV3LCAndGVtcGxhdGVEYXRhJywgdGVtcGxhdGVEYXRhKTsKICAgICAgfQogICAgfSk7CiAgfSwKCiAgY3VycmVudFZpZXc6IG51bGwsCgogIF9jdXJyZW50Vmlld1dpbGxDaGFuZ2U6IEVtYmVyLmJlZm9yZU9ic2VydmVyKCdjdXJyZW50VmlldycsIGZ1bmN0aW9uKCkgewogICAgdmFyIGN1cnJlbnRWaWV3ID0gZ2V0KHRoaXMsICdjdXJyZW50VmlldycpOwogICAgaWYgKGN1cnJlbnRWaWV3KSB7CiAgICAgIGN1cnJlbnRWaWV3LmRlc3Ryb3koKTsKICAgIH0KICB9KSwKCiAgX2N1cnJlbnRWaWV3RGlkQ2hhbmdlOiBFbWJlci5vYnNlcnZlcignY3VycmVudFZpZXcnLCBmdW5jdGlvbigpIHsKICAgIHZhciBjdXJyZW50VmlldyA9IGdldCh0aGlzLCAnY3VycmVudFZpZXcnKTsKICAgIGlmIChjdXJyZW50VmlldykgewogICAgICBFbWJlci5hc3NlcnQoIllvdSB0cmllZCB0byBzZXQgYSBjdXJyZW50IHZpZXcgdGhhdCBhbHJlYWR5IGhhcyBhIHBhcmVudC4gTWFrZSBzdXJlIHlvdSBkb24ndCBoYXZlIG11bHRpcGxlIG91dGxldHMgaW4gdGhlIHNhbWUgdmlldy4iLCAhZ2V0KGN1cnJlbnRWaWV3LCAnX3BhcmVudFZpZXcnKSk7CiAgICAgIHRoaXMucHVzaE9iamVjdChjdXJyZW50Vmlldyk7CiAgICB9CiAgfSksCgogIF9lbnN1cmVDaGlsZHJlbkFyZUluRE9NOiBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLmN1cnJlbnRTdGF0ZS5lbnN1cmVDaGlsZHJlbkFyZUluRE9NKHRoaXMpOwogIH0KfSk7CgpFbWJlci5tZXJnZShzdGF0ZXMuX2RlZmF1bHQsIHsKICBjaGlsZFZpZXdzV2lsbENoYW5nZTogRW1iZXIuSywKICBjaGlsZFZpZXdzRGlkQ2hhbmdlOiBFbWJlci5LLAogIGVuc3VyZUNoaWxkcmVuQXJlSW5ET006IEVtYmVyLksKfSk7CgpFbWJlci5tZXJnZShzdGF0ZXMuaW5CdWZmZXIsIHsKICBjaGlsZFZpZXdzRGlkQ2hhbmdlOiBmdW5jdGlvbihwYXJlbnRWaWV3LCB2aWV3cywgc3RhcnQsIGFkZGVkKSB7CiAgICB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoJ1lvdSBjYW5ub3QgbW9kaWZ5IGNoaWxkIHZpZXdzIHdoaWxlIGluIHRoZSBpbkJ1ZmZlciBzdGF0ZScpOwogIH0KfSk7CgpFbWJlci5tZXJnZShzdGF0ZXMuaGFzRWxlbWVudCwgewogIGNoaWxkVmlld3NXaWxsQ2hhbmdlOiBmdW5jdGlvbih2aWV3LCB2aWV3cywgc3RhcnQsIHJlbW92ZWQpIHsKICAgIGZvciAodmFyIGk9c3RhcnQ7IGk8c3RhcnQrcmVtb3ZlZDsgaSsrKSB7CiAgICAgIHZpZXdzW2ldLnJlbW92ZSgpOwogICAgfQogIH0sCgogIGNoaWxkVmlld3NEaWRDaGFuZ2U6IGZ1bmN0aW9uKHZpZXcsIHZpZXdzLCBzdGFydCwgYWRkZWQpIHsKICAgIEVtYmVyLnJ1bi5zY2hlZHVsZU9uY2UoJ3JlbmRlcicsIHZpZXcsICdfZW5zdXJlQ2hpbGRyZW5BcmVJbkRPTScpOwogIH0sCgogIGVuc3VyZUNoaWxkcmVuQXJlSW5ET006IGZ1bmN0aW9uKHZpZXcpIHsKICAgIHZhciBjaGlsZFZpZXdzID0gdmlldy5fY2hpbGRWaWV3cywgaSwgbGVuLCBjaGlsZFZpZXcsIHByZXZpb3VzLCBidWZmZXIsIHZpZXdDb2xsZWN0aW9uID0gbmV3IFZpZXdDb2xsZWN0aW9uKCk7CgogICAgZm9yIChpID0gMCwgbGVuID0gY2hpbGRWaWV3cy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICBjaGlsZFZpZXcgPSBjaGlsZFZpZXdzW2ldOwoKICAgICAgaWYgKCFidWZmZXIpIHsgYnVmZmVyID0gRW1iZXIuUmVuZGVyQnVmZmVyKCk7IGJ1ZmZlci5faGFzRWxlbWVudCA9IGZhbHNlOyB9CgogICAgICBpZiAoY2hpbGRWaWV3LnJlbmRlclRvQnVmZmVySWZOZWVkZWQoYnVmZmVyKSkgewogICAgICAgIHZpZXdDb2xsZWN0aW9uLnB1c2goY2hpbGRWaWV3KTsKICAgICAgfSBlbHNlIGlmICh2aWV3Q29sbGVjdGlvbi5sZW5ndGgpIHsKICAgICAgICBpbnNlcnRWaWV3Q29sbGVjdGlvbih2aWV3LCB2aWV3Q29sbGVjdGlvbiwgcHJldmlvdXMsIGJ1ZmZlcik7CiAgICAgICAgYnVmZmVyID0gbnVsbDsKICAgICAgICBwcmV2aW91cyA9IGNoaWxkVmlldzsKICAgICAgICB2aWV3Q29sbGVjdGlvbi5jbGVhcigpOwogICAgICB9IGVsc2UgewogICAgICAgIHByZXZpb3VzID0gY2hpbGRWaWV3OwogICAgICB9CiAgICB9CgogICAgaWYgKHZpZXdDb2xsZWN0aW9uLmxlbmd0aCkgewogICAgICBpbnNlcnRWaWV3Q29sbGVjdGlvbih2aWV3LCB2aWV3Q29sbGVjdGlvbiwgcHJldmlvdXMsIGJ1ZmZlcik7CiAgICB9CiAgfQp9KTsKCmZ1bmN0aW9uIGluc2VydFZpZXdDb2xsZWN0aW9uKHZpZXcsIHZpZXdDb2xsZWN0aW9uLCBwcmV2aW91cywgYnVmZmVyKSB7CiAgdmlld0NvbGxlY3Rpb24udHJpZ2dlclJlY3Vyc2l2ZWx5KCd3aWxsSW5zZXJ0RWxlbWVudCcpOwoKICBpZiAocHJldmlvdXMpIHsKICAgIHByZXZpb3VzLmRvbU1hbmFnZXIuYWZ0ZXIocHJldmlvdXMsIGJ1ZmZlci5zdHJpbmcoKSk7CiAgfSBlbHNlIHsKICAgIHZpZXcuZG9tTWFuYWdlci5wcmVwZW5kKHZpZXcsIGJ1ZmZlci5zdHJpbmcoKSk7CiAgfQoKICB2aWV3Q29sbGVjdGlvbi5mb3JFYWNoKGZ1bmN0aW9uKHYpIHsKICAgIHYudHJhbnNpdGlvblRvKCdpbkRPTScpOwogICAgdi5wcm9wZXJ0eURpZENoYW5nZSgnZWxlbWVudCcpOwogICAgdi50cmlnZ2VyUmVjdXJzaXZlbHkoJ2RpZEluc2VydEVsZW1lbnQnKTsKICB9KTsKfQoKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci12aWV3cwoqLwoKdmFyIGdldCA9IEVtYmVyLmdldCwgc2V0ID0gRW1iZXIuc2V0LCBmbXQgPSBFbWJlci5TdHJpbmcuZm10OwoKLyoqCiAgYEVtYmVyLkNvbGxlY3Rpb25WaWV3YCBpcyBhbiBgRW1iZXIuVmlld2AgZGVzY2VuZGVudCByZXNwb25zaWJsZSBmb3IgbWFuYWdpbmcKICBhIGNvbGxlY3Rpb24gKGFuIGFycmF5IG9yIGFycmF5LWxpa2Ugb2JqZWN0KSBieSBtYWludGFpbmluZyBhIGNoaWxkIHZpZXcgb2JqZWN0CiAgYW5kIGFzc29jaWF0ZWQgRE9NIHJlcHJlc2VudGF0aW9uIGZvciBlYWNoIGl0ZW0gaW4gdGhlIGFycmF5IGFuZCBlbnN1cmluZwogIHRoYXQgY2hpbGQgdmlld3MgYW5kIHRoZWlyIGFzc29jaWF0ZWQgcmVuZGVyZWQgSFRNTCBhcmUgdXBkYXRlZCB3aGVuIGl0ZW1zIGluCiAgdGhlIGFycmF5IGFyZSBhZGRlZCwgcmVtb3ZlZCwgb3IgcmVwbGFjZWQuCgogICMjIFNldHRpbmcgY29udGVudAoKICBUaGUgbWFuYWdlZCBjb2xsZWN0aW9uIG9mIG9iamVjdHMgaXMgcmVmZXJlbmNlZCBhcyB0aGUgYEVtYmVyLkNvbGxlY3Rpb25WaWV3YAogIGluc3RhbmNlJ3MgYGNvbnRlbnRgIHByb3BlcnR5LgoKICBgYGBqYXZhc2NyaXB0CiAgc29tZUl0ZW1zVmlldyA9IEVtYmVyLkNvbGxlY3Rpb25WaWV3LmNyZWF0ZSh7CiAgICBjb250ZW50OiBbJ0EnLCAnQicsJ0MnXQogIH0pCiAgYGBgCgogIFRoZSB2aWV3IGZvciBlYWNoIGl0ZW0gaW4gdGhlIGNvbGxlY3Rpb24gd2lsbCBoYXZlIGl0cyBgY29udGVudGAgcHJvcGVydHkgc2V0CiAgdG8gdGhlIGl0ZW0uCgogICMjIFNwZWNpZnlpbmcgaXRlbVZpZXdDbGFzcwoKICBCeSBkZWZhdWx0IHRoZSB2aWV3IGNsYXNzIGZvciBlYWNoIGl0ZW0gaW4gdGhlIG1hbmFnZWQgY29sbGVjdGlvbiB3aWxsIGJlIGFuCiAgaW5zdGFuY2Ugb2YgYEVtYmVyLlZpZXdgLiBZb3UgY2FuIHN1cHBseSBhIGRpZmZlcmVudCBjbGFzcyBieSBzZXR0aW5nIHRoZQogIGBDb2xsZWN0aW9uVmlld2AncyBgaXRlbVZpZXdDbGFzc2AgcHJvcGVydHkuCgogIEdpdmVuIGFuIGVtcHR5IGA8Ym9keT5gIGFuZCB0aGUgZm9sbG93aW5nIGNvZGU6CgogIGBgYGphdmFzY3JpcHQKICBzb21lSXRlbXNWaWV3ID0gRW1iZXIuQ29sbGVjdGlvblZpZXcuY3JlYXRlKHsKICAgIGNsYXNzTmFtZXM6IFsnYS1jb2xsZWN0aW9uJ10sCiAgICBjb250ZW50OiBbJ0EnLCdCJywnQyddLAogICAgaXRlbVZpZXdDbGFzczogRW1iZXIuVmlldy5leHRlbmQoewogICAgICB0ZW1wbGF0ZTogRW1iZXIuSGFuZGxlYmFycy5jb21waWxlKCJ0aGUgbGV0dGVyOiB7e3ZpZXcuY29udGVudH19IikKICAgIH0pCiAgfSk7CgogIHNvbWVJdGVtc1ZpZXcuYXBwZW5kVG8oJ2JvZHknKTsKICBgYGAKCiAgV2lsbCByZXN1bHQgaW4gdGhlIGZvbGxvd2luZyBIVE1MIHN0cnVjdHVyZQoKICBgYGBodG1sCiAgPGRpdiBjbGFzcz0iZW1iZXItdmlldyBhLWNvbGxlY3Rpb24iPgogICAgPGRpdiBjbGFzcz0iZW1iZXItdmlldyI+dGhlIGxldHRlcjogQTwvZGl2PgogICAgPGRpdiBjbGFzcz0iZW1iZXItdmlldyI+dGhlIGxldHRlcjogQjwvZGl2PgogICAgPGRpdiBjbGFzcz0iZW1iZXItdmlldyI+dGhlIGxldHRlcjogQzwvZGl2PgogIDwvZGl2PgogIGBgYAoKICAjIyBBdXRvbWF0aWMgbWF0Y2hpbmcgb2YgcGFyZW50L2NoaWxkIHRhZ05hbWVzCgogIFNldHRpbmcgdGhlIGB0YWdOYW1lYCBwcm9wZXJ0eSBvZiBhIGBDb2xsZWN0aW9uVmlld2AgdG8gYW55IG9mCiAgInVsIiwgIm9sIiwgInRhYmxlIiwgInRoZWFkIiwgInRib2R5IiwgInRmb290IiwgInRyIiwgb3IgInNlbGVjdCIgd2lsbCByZXN1bHQKICBpbiB0aGUgaXRlbSB2aWV3cyByZWNlaXZpbmcgYW4gYXBwcm9wcmlhdGVseSBtYXRjaGVkIGB0YWdOYW1lYCBwcm9wZXJ0eS4KCiAgR2l2ZW4gYW4gZW1wdHkgYDxib2R5PmAgYW5kIHRoZSBmb2xsb3dpbmcgY29kZToKCiAgYGBgamF2YXNjcmlwdAogIGFuVW5kb3JkZXJlZExpc3RWaWV3ID0gRW1iZXIuQ29sbGVjdGlvblZpZXcuY3JlYXRlKHsKICAgIHRhZ05hbWU6ICd1bCcsCiAgICBjb250ZW50OiBbJ0EnLCdCJywnQyddLAogICAgaXRlbVZpZXdDbGFzczogRW1iZXIuVmlldy5leHRlbmQoewogICAgICB0ZW1wbGF0ZTogRW1iZXIuSGFuZGxlYmFycy5jb21waWxlKCJ0aGUgbGV0dGVyOiB7e3ZpZXcuY29udGVudH19IikKICAgIH0pCiAgfSk7CgogIGFuVW5kb3JkZXJlZExpc3RWaWV3LmFwcGVuZFRvKCdib2R5Jyk7CiAgYGBgCgogIFdpbGwgcmVzdWx0IGluIHRoZSBmb2xsb3dpbmcgSFRNTCBzdHJ1Y3R1cmUKCiAgYGBgaHRtbAogIDx1bCBjbGFzcz0iZW1iZXItdmlldyBhLWNvbGxlY3Rpb24iPgogICAgPGxpIGNsYXNzPSJlbWJlci12aWV3Ij50aGUgbGV0dGVyOiBBPC9saT4KICAgIDxsaSBjbGFzcz0iZW1iZXItdmlldyI+dGhlIGxldHRlcjogQjwvbGk+CiAgICA8bGkgY2xhc3M9ImVtYmVyLXZpZXciPnRoZSBsZXR0ZXI6IEM8L2xpPgogIDwvdWw+CiAgYGBgCgogIEFkZGl0aW9uYWwgYHRhZ05hbWVgIHBhaXJzIGNhbiBiZSBwcm92aWRlZCBieSBhZGRpbmcgdG8KICBgRW1iZXIuQ29sbGVjdGlvblZpZXcuQ09OVEFJTkVSX01BUCBgCgogIGBgYGphdmFzY3JpcHQKICBFbWJlci5Db2xsZWN0aW9uVmlldy5DT05UQUlORVJfTUFQWydhcnRpY2xlJ10gPSAnc2VjdGlvbicKICBgYGAKCiAgIyMgUHJvZ3JhbW1hdGljIGNyZWF0aW9uIG9mIGNoaWxkIHZpZXdzCgogIEZvciBjYXNlcyB3aGVyZSBhZGRpdGlvbmFsIGN1c3RvbWl6YXRpb24gYmV5b25kIHRoZSB1c2Ugb2YgYSBzaW5nbGUKICBgaXRlbVZpZXdDbGFzc2Agb3IgYHRhZ05hbWVgIG1hdGNoaW5nIGlzIHJlcXVpcmVkIENvbGxlY3Rpb25WaWV3J3MKICBgY3JlYXRlQ2hpbGRWaWV3YCBtZXRob2QgY2FuIGJlIG92ZXJpZGRlbjoKCiAgYGBgamF2YXNjcmlwdAogIEN1c3RvbUNvbGxlY3Rpb25WaWV3ID0gRW1iZXIuQ29sbGVjdGlvblZpZXcuZXh0ZW5kKHsKICAgIGNyZWF0ZUNoaWxkVmlldzogZnVuY3Rpb24odmlld0NsYXNzLCBhdHRycykgewogICAgICBpZiAoYXR0cnMuY29udGVudC5raW5kID09ICdhbGJ1bScpIHsKICAgICAgICB2aWV3Q2xhc3MgPSBBcHAuQWxidW1WaWV3OwogICAgICB9IGVsc2UgewogICAgICAgIHZpZXdDbGFzcyA9IEFwcC5Tb25nVmlldzsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5fc3VwZXIodmlld0NsYXNzLCBhdHRycyk7CiAgICB9CiAgfSk7CiAgYGBgCgogICMjIEVtcHR5IFZpZXcKCiAgWW91IGNhbiBwcm92aWRlIGFuIGBFbWJlci5WaWV3YCBzdWJjbGFzcyB0byB0aGUgYEVtYmVyLkNvbGxlY3Rpb25WaWV3YAogIGluc3RhbmNlIGFzIGl0cyBgZW1wdHlWaWV3YCBwcm9wZXJ0eS4gSWYgdGhlIGBjb250ZW50YCBwcm9wZXJ0eSBvZiBhCiAgYENvbGxlY3Rpb25WaWV3YCBpcyBzZXQgdG8gYG51bGxgIG9yIGFuIGVtcHR5IGFycmF5LCBhbiBpbnN0YW5jZSBvZiB0aGlzIHZpZXcKICB3aWxsIGJlIHRoZSBgQ29sbGVjdGlvblZpZXdgcyBvbmx5IGNoaWxkLgoKICBgYGBqYXZhc2NyaXB0CiAgYUxpc3RXaXRoTm90aGluZyA9IEVtYmVyLkNvbGxlY3Rpb25WaWV3LmNyZWF0ZSh7CiAgICBjbGFzc05hbWVzOiBbJ25vdGhpbmcnXQogICAgY29udGVudDogbnVsbCwKICAgIGVtcHR5VmlldzogRW1iZXIuVmlldy5leHRlbmQoewogICAgICB0ZW1wbGF0ZTogRW1iZXIuSGFuZGxlYmFycy5jb21waWxlKCJUaGUgY29sbGVjdGlvbiBpcyBlbXB0eSIpCiAgICB9KQogIH0pOwoKICBhTGlzdFdpdGhOb3RoaW5nLmFwcGVuZFRvKCdib2R5Jyk7CiAgYGBgCgogIFdpbGwgcmVzdWx0IGluIHRoZSBmb2xsb3dpbmcgSFRNTCBzdHJ1Y3R1cmUKCiAgYGBgaHRtbAogIDxkaXYgY2xhc3M9ImVtYmVyLXZpZXcgbm90aGluZyI+CiAgICA8ZGl2IGNsYXNzPSJlbWJlci12aWV3Ij4KICAgICAgVGhlIGNvbGxlY3Rpb24gaXMgZW1wdHkKICAgIDwvZGl2PgogIDwvZGl2PgogIGBgYAoKICAjIyBBZGRpbmcgYW5kIFJlbW92aW5nIGl0ZW1zCgogIFRoZSBgY2hpbGRWaWV3c2AgcHJvcGVydHkgb2YgYSBgQ29sbGVjdGlvblZpZXdgIHNob3VsZCBub3QgYmUgZGlyZWN0bHkKICBtYW5pcHVsYXRlZC4gSW5zdGVhZCwgYWRkLCByZW1vdmUsIHJlcGxhY2UgaXRlbXMgZnJvbSBpdHMgYGNvbnRlbnRgIHByb3BlcnR5LgogIFRoaXMgd2lsbCB0cmlnZ2VyIGFwcHJvcHJpYXRlIGNoYW5nZXMgdG8gaXRzIHJlbmRlcmVkIEhUTUwuCgoKICBAY2xhc3MgQ29sbGVjdGlvblZpZXcKICBAbmFtZXNwYWNlIEVtYmVyCiAgQGV4dGVuZHMgRW1iZXIuQ29udGFpbmVyVmlldwogIEBzaW5jZSBFbWJlciAwLjkKKi8KRW1iZXIuQ29sbGVjdGlvblZpZXcgPSBFbWJlci5Db250YWluZXJWaWV3LmV4dGVuZCh7CgogIC8qKgogICAgQSBsaXN0IG9mIGl0ZW1zIHRvIGJlIGRpc3BsYXllZCBieSB0aGUgYEVtYmVyLkNvbGxlY3Rpb25WaWV3YC4KCiAgICBAcHJvcGVydHkgY29udGVudAogICAgQHR5cGUgRW1iZXIuQXJyYXkKICAgIEBkZWZhdWx0IG51bGwKICAqLwogIGNvbnRlbnQ6IG51bGwsCgogIC8qKgogICAgVGhpcyBwcm92aWRlcyBtZXRhZGF0YSBhYm91dCB3aGF0IGtpbmQgb2YgZW1wdHkgdmlldyBjbGFzcyB0aGlzCiAgICBjb2xsZWN0aW9uIHdvdWxkIGxpa2UgaWYgaXQgaXMgYmVpbmcgaW5zdGFudGlhdGVkIGZyb20gYW5vdGhlcgogICAgc3lzdGVtIChsaWtlIEhhbmRsZWJhcnMpCgogICAgQHByaXZhdGUKICAgIEBwcm9wZXJ0eSBlbXB0eVZpZXdDbGFzcwogICovCiAgZW1wdHlWaWV3Q2xhc3M6IEVtYmVyLlZpZXcsCgogIC8qKgogICAgQW4gb3B0aW9uYWwgdmlldyB0byBkaXNwbGF5IGlmIGNvbnRlbnQgaXMgc2V0IHRvIGFuIGVtcHR5IGFycmF5LgoKICAgIEBwcm9wZXJ0eSBlbXB0eVZpZXcKICAgIEB0eXBlIEVtYmVyLlZpZXcKICAgIEBkZWZhdWx0IG51bGwKICAqLwogIGVtcHR5VmlldzogbnVsbCwKCiAgLyoqCiAgICBAcHJvcGVydHkgaXRlbVZpZXdDbGFzcwogICAgQHR5cGUgRW1iZXIuVmlldwogICAgQGRlZmF1bHQgRW1iZXIuVmlldwogICovCiAgaXRlbVZpZXdDbGFzczogRW1iZXIuVmlldywKCiAgLyoqCiAgICBTZXR1cCBhIENvbGxlY3Rpb25WaWV3CgogICAgQG1ldGhvZCBpbml0CiAgKi8KICBpbml0OiBmdW5jdGlvbigpIHsKICAgIHZhciByZXQgPSB0aGlzLl9zdXBlcigpOwogICAgdGhpcy5fY29udGVudERpZENoYW5nZSgpOwogICAgcmV0dXJuIHJldDsKICB9LAoKICAvKioKICAgIEludm9rZWQgd2hlbiB0aGUgY29udGVudCBwcm9wZXJ0eSBpcyBhYm91dCB0byBjaGFuZ2UuIE5vdGlmaWVzIG9ic2VydmVycyB0aGF0IHRoZQogICAgZW50aXJlIGFycmF5IGNvbnRlbnQgd2lsbCBjaGFuZ2UuCgogICAgQHByaXZhdGUKICAgIEBtZXRob2QgX2NvbnRlbnRXaWxsQ2hhbmdlCiAgKi8KICBfY29udGVudFdpbGxDaGFuZ2U6IEVtYmVyLmJlZm9yZU9ic2VydmVyKCdjb250ZW50JywgZnVuY3Rpb24oKSB7CiAgICB2YXIgY29udGVudCA9IHRoaXMuZ2V0KCdjb250ZW50Jyk7CgogICAgaWYgKGNvbnRlbnQpIHsgY29udGVudC5yZW1vdmVBcnJheU9ic2VydmVyKHRoaXMpOyB9CiAgICB2YXIgbGVuID0gY29udGVudCA/IGdldChjb250ZW50LCAnbGVuZ3RoJykgOiAwOwogICAgdGhpcy5hcnJheVdpbGxDaGFuZ2UoY29udGVudCwgMCwgbGVuKTsKICB9KSwKCiAgLyoqCiAgICBDaGVjayB0byBtYWtlIHN1cmUgdGhhdCB0aGUgY29udGVudCBoYXMgY2hhbmdlZCwgYW5kIGlmIHNvLAogICAgdXBkYXRlIHRoZSBjaGlsZHJlbiBkaXJlY3RseS4gVGhpcyBpcyBhbHdheXMgc2NoZWR1bGVkCiAgICBhc3luY2hyb25vdXNseSwgdG8gYWxsb3cgdGhlIGVsZW1lbnQgdG8gYmUgY3JlYXRlZCBiZWZvcmUKICAgIGJpbmRpbmdzIGhhdmUgc3luY2hyb25pemVkIGFuZCB2aWNlIHZlcnNhLgoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIF9jb250ZW50RGlkQ2hhbmdlCiAgKi8KICBfY29udGVudERpZENoYW5nZTogRW1iZXIub2JzZXJ2ZXIoJ2NvbnRlbnQnLCBmdW5jdGlvbigpIHsKICAgIHZhciBjb250ZW50ID0gZ2V0KHRoaXMsICdjb250ZW50Jyk7CgogICAgaWYgKGNvbnRlbnQpIHsKICAgICAgdGhpcy5fYXNzZXJ0QXJyYXlMaWtlKGNvbnRlbnQpOwogICAgICBjb250ZW50LmFkZEFycmF5T2JzZXJ2ZXIodGhpcyk7CiAgICB9CgogICAgdmFyIGxlbiA9IGNvbnRlbnQgPyBnZXQoY29udGVudCwgJ2xlbmd0aCcpIDogMDsKICAgIHRoaXMuYXJyYXlEaWRDaGFuZ2UoY29udGVudCwgMCwgbnVsbCwgbGVuKTsKICB9KSwKCiAgLyoqCiAgICBFbnN1cmUgdGhhdCB0aGUgY29udGVudCBpbXBsZW1lbnRzIEVtYmVyLkFycmF5CgogICAgQHByaXZhdGUKICAgIEBtZXRob2QgX2Fzc2VydEFycmF5TGlrZQogICovCiAgX2Fzc2VydEFycmF5TGlrZTogZnVuY3Rpb24oY29udGVudCkgewogICAgRW1iZXIuYXNzZXJ0KGZtdCgiYW4gRW1iZXIuQ29sbGVjdGlvblZpZXcncyBjb250ZW50IG11c3QgaW1wbGVtZW50IEVtYmVyLkFycmF5LiBZb3UgcGFzc2VkICVAIiwgW2NvbnRlbnRdKSwgRW1iZXIuQXJyYXkuZGV0ZWN0KGNvbnRlbnQpKTsKICB9LAoKICAvKioKICAgIFJlbW92ZXMgdGhlIGNvbnRlbnQgYW5kIGNvbnRlbnQgb2JzZXJ2ZXJzLgoKICAgIEBtZXRob2QgZGVzdHJveQogICovCiAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICBpZiAoIXRoaXMuX3N1cGVyKCkpIHsgcmV0dXJuOyB9CgogICAgdmFyIGNvbnRlbnQgPSBnZXQodGhpcywgJ2NvbnRlbnQnKTsKICAgIGlmIChjb250ZW50KSB7IGNvbnRlbnQucmVtb3ZlQXJyYXlPYnNlcnZlcih0aGlzKTsgfQoKICAgIGlmICh0aGlzLl9jcmVhdGVkRW1wdHlWaWV3KSB7CiAgICAgIHRoaXMuX2NyZWF0ZWRFbXB0eVZpZXcuZGVzdHJveSgpOwogICAgfQoKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAgQ2FsbGVkIHdoZW4gYSBtdXRhdGlvbiB0byB0aGUgdW5kZXJseWluZyBjb250ZW50IGFycmF5IHdpbGwgb2NjdXIuCgogICAgVGhpcyBtZXRob2Qgd2lsbCByZW1vdmUgYW55IHZpZXdzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgdW5kZXJseWluZwogICAgY29udGVudCBhcnJheS4KCiAgICBJbnZva2VzIHdoZW5ldmVyIHRoZSBjb250ZW50IGFycmF5IGl0c2VsZiB3aWxsIGNoYW5nZS4KCiAgICBAbWV0aG9kIGFycmF5V2lsbENoYW5nZQogICAgQHBhcmFtIHtBcnJheX0gY29udGVudCB0aGUgbWFuYWdlZCBjb2xsZWN0aW9uIG9mIG9iamVjdHMKICAgIEBwYXJhbSB7TnVtYmVyfSBzdGFydCB0aGUgaW5kZXggYXQgd2hpY2ggdGhlIGNoYW5nZXMgd2lsbCBvY2N1cnIKICAgIEBwYXJhbSB7TnVtYmVyfSByZW1vdmVkIG51bWJlciBvZiBvYmplY3QgdG8gYmUgcmVtb3ZlZCBmcm9tIGNvbnRlbnQKICAqLwogIGFycmF5V2lsbENoYW5nZTogZnVuY3Rpb24oY29udGVudCwgc3RhcnQsIHJlbW92ZWRDb3VudCkgewogICAgLy8gSWYgdGhlIGNvbnRlbnRzIHdlcmUgZW1wdHkgYmVmb3JlIGFuZCB0aGlzIHRlbXBsYXRlIGNvbGxlY3Rpb24gaGFzIGFuCiAgICAvLyBlbXB0eSB2aWV3IHJlbW92ZSBpdCBub3cuCiAgICB2YXIgZW1wdHlWaWV3ID0gZ2V0KHRoaXMsICdlbXB0eVZpZXcnKTsKICAgIGlmIChlbXB0eVZpZXcgJiYgZW1wdHlWaWV3IGluc3RhbmNlb2YgRW1iZXIuVmlldykgewogICAgICBlbXB0eVZpZXcucmVtb3ZlRnJvbVBhcmVudCgpOwogICAgfQoKICAgIC8vIExvb3AgdGhyb3VnaCBjaGlsZCB2aWV3cyB0aGF0IGNvcnJlc3BvbmQgd2l0aCB0aGUgcmVtb3ZlZCBpdGVtcy4KICAgIC8vIE5vdGUgdGhhdCB3ZSBsb29wIGZyb20gdGhlIGVuZCBvZiB0aGUgYXJyYXkgdG8gdGhlIGJlZ2lubmluZyBiZWNhdXNlCiAgICAvLyB3ZSBhcmUgbXV0YXRpbmcgaXQgYXMgd2UgZ28uCiAgICB2YXIgY2hpbGRWaWV3cyA9IHRoaXMuX2NoaWxkVmlld3MsIGNoaWxkVmlldywgaWR4LCBsZW47CgogICAgbGVuID0gdGhpcy5fY2hpbGRWaWV3cy5sZW5ndGg7CgogICAgdmFyIHJlbW92aW5nQWxsID0gcmVtb3ZlZENvdW50ID09PSBsZW47CgogICAgaWYgKHJlbW92aW5nQWxsKSB7CiAgICAgIHRoaXMuY3VycmVudFN0YXRlLmVtcHR5KHRoaXMpOwogICAgICB0aGlzLmludm9rZVJlY3Vyc2l2ZWx5KGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgICB2aWV3LnJlbW92ZWRGcm9tRE9NID0gdHJ1ZTsKICAgICAgfSwgZmFsc2UpOwogICAgfQoKICAgIGZvciAoaWR4ID0gc3RhcnQgKyByZW1vdmVkQ291bnQgLSAxOyBpZHggPj0gc3RhcnQ7IGlkeC0tKSB7CiAgICAgIGNoaWxkVmlldyA9IGNoaWxkVmlld3NbaWR4XTsKICAgICAgY2hpbGRWaWV3LmRlc3Ryb3koKTsKICAgIH0KICB9LAoKICAvKioKICAgIENhbGxlZCB3aGVuIGEgbXV0YXRpb24gdG8gdGhlIHVuZGVybHlpbmcgY29udGVudCBhcnJheSBvY2N1cnMuCgogICAgVGhpcyBtZXRob2Qgd2lsbCByZXBsYXkgdGhhdCBtdXRhdGlvbiBhZ2FpbnN0IHRoZSB2aWV3cyB0aGF0IGNvbXBvc2UgdGhlCiAgICBgRW1iZXIuQ29sbGVjdGlvblZpZXdgLCBlbnN1cmluZyB0aGF0IHRoZSB2aWV3IHJlZmxlY3RzIHRoZSBtb2RlbC4KCiAgICBUaGlzIGFycmF5IG9ic2VydmVyIGlzIGFkZGVkIGluIGBjb250ZW50RGlkQ2hhbmdlYC4KCiAgICBAbWV0aG9kIGFycmF5RGlkQ2hhbmdlCiAgICBAcGFyYW0ge0FycmF5fSBjb250ZW50IHRoZSBtYW5hZ2VkIGNvbGxlY3Rpb24gb2Ygb2JqZWN0cwogICAgQHBhcmFtIHtOdW1iZXJ9IHN0YXJ0IHRoZSBpbmRleCBhdCB3aGljaCB0aGUgY2hhbmdlcyBvY2N1cnJlZAogICAgQHBhcmFtIHtOdW1iZXJ9IHJlbW92ZWQgbnVtYmVyIG9mIG9iamVjdCByZW1vdmVkIGZyb20gY29udGVudAogICAgQHBhcmFtIHtOdW1iZXJ9IGFkZGVkIG51bWJlciBvZiBvYmplY3QgYWRkZWQgdG8gY29udGVudAogICovCiAgYXJyYXlEaWRDaGFuZ2U6IGZ1bmN0aW9uKGNvbnRlbnQsIHN0YXJ0LCByZW1vdmVkLCBhZGRlZCkgewogICAgdmFyIGFkZGVkVmlld3MgPSBbXSwgdmlldywgaXRlbSwgaWR4LCBsZW4sIGl0ZW1WaWV3Q2xhc3MsCiAgICAgIGVtcHR5VmlldzsKCiAgICBsZW4gPSBjb250ZW50ID8gZ2V0KGNvbnRlbnQsICdsZW5ndGgnKSA6IDA7CgogICAgaWYgKGxlbikgewogICAgICBpdGVtVmlld0NsYXNzID0gZ2V0KHRoaXMsICdpdGVtVmlld0NsYXNzJyk7CgogICAgICBpZiAoJ3N0cmluZycgPT09IHR5cGVvZiBpdGVtVmlld0NsYXNzKSB7CiAgICAgICAgaXRlbVZpZXdDbGFzcyA9IGdldChpdGVtVmlld0NsYXNzKSB8fCBpdGVtVmlld0NsYXNzOwogICAgICB9CgogICAgICBFbWJlci5hc3NlcnQoZm10KCJpdGVtVmlld0NsYXNzIG11c3QgYmUgYSBzdWJjbGFzcyBvZiBFbWJlci5WaWV3LCBub3QgJUAiLCBbaXRlbVZpZXdDbGFzc10pLCAnc3RyaW5nJyA9PT0gdHlwZW9mIGl0ZW1WaWV3Q2xhc3MgfHwgRW1iZXIuVmlldy5kZXRlY3QoaXRlbVZpZXdDbGFzcykpOwoKICAgICAgZm9yIChpZHggPSBzdGFydDsgaWR4IDwgc3RhcnQrYWRkZWQ7IGlkeCsrKSB7CiAgICAgICAgaXRlbSA9IGNvbnRlbnQub2JqZWN0QXQoaWR4KTsKCiAgICAgICAgdmlldyA9IHRoaXMuY3JlYXRlQ2hpbGRWaWV3KGl0ZW1WaWV3Q2xhc3MsIHsKICAgICAgICAgIGNvbnRlbnQ6IGl0ZW0sCiAgICAgICAgICBjb250ZW50SW5kZXg6IGlkeAogICAgICAgIH0pOwoKICAgICAgICBhZGRlZFZpZXdzLnB1c2godmlldyk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGVtcHR5VmlldyA9IGdldCh0aGlzLCAnZW1wdHlWaWV3Jyk7CgogICAgICBpZiAoIWVtcHR5VmlldykgeyByZXR1cm47IH0KCiAgICAgIGlmICgnc3RyaW5nJyA9PT0gdHlwZW9mIGVtcHR5VmlldykgewogICAgICAgIGVtcHR5VmlldyA9IGdldChlbXB0eVZpZXcpIHx8IGVtcHR5VmlldzsKICAgICAgfQoKICAgICAgZW1wdHlWaWV3ID0gdGhpcy5jcmVhdGVDaGlsZFZpZXcoZW1wdHlWaWV3KTsKICAgICAgYWRkZWRWaWV3cy5wdXNoKGVtcHR5Vmlldyk7CiAgICAgIHNldCh0aGlzLCAnZW1wdHlWaWV3JywgZW1wdHlWaWV3KTsKCiAgICAgIGlmIChFbWJlci5Db3JlVmlldy5kZXRlY3QoZW1wdHlWaWV3KSkgewogICAgICAgIHRoaXMuX2NyZWF0ZWRFbXB0eVZpZXcgPSBlbXB0eVZpZXc7CiAgICAgIH0KICAgIH0KCiAgICB0aGlzLnJlcGxhY2Uoc3RhcnQsIDAsIGFkZGVkVmlld3MpOwogIH0sCgogIC8qKgogICAgSW5zdGFudGlhdGVzIGEgdmlldyB0byBiZSBhZGRlZCB0byB0aGUgY2hpbGRWaWV3cyBhcnJheSBkdXJpbmcgdmlldwogICAgaW5pdGlhbGl6YXRpb24uIFlvdSBnZW5lcmFsbHkgd2lsbCBub3QgY2FsbCB0aGlzIG1ldGhvZCBkaXJlY3RseSB1bmxlc3MKICAgIHlvdSBhcmUgb3ZlcnJpZGluZyBgY3JlYXRlQ2hpbGRWaWV3cygpYC4gTm90ZSB0aGF0IHRoaXMgbWV0aG9kIHdpbGwKICAgIGF1dG9tYXRpY2FsbHkgY29uZmlndXJlIHRoZSBjb3JyZWN0IHNldHRpbmdzIG9uIHRoZSBuZXcgdmlldyBpbnN0YW5jZSB0bwogICAgYWN0IGFzIGEgY2hpbGQgb2YgdGhlIHBhcmVudC4KCiAgICBUaGUgdGFnIG5hbWUgZm9yIHRoZSB2aWV3IHdpbGwgYmUgc2V0IHRvIHRoZSB0YWdOYW1lIG9mIHRoZSB2aWV3Q2xhc3MKICAgIHBhc3NlZCBpbi4KCiAgICBAbWV0aG9kIGNyZWF0ZUNoaWxkVmlldwogICAgQHBhcmFtIHtDbGFzc30gdmlld0NsYXNzCiAgICBAcGFyYW0ge0hhc2h9IFthdHRyc10gQXR0cmlidXRlcyB0byBhZGQKICAgIEByZXR1cm4ge0VtYmVyLlZpZXd9IG5ldyBpbnN0YW5jZQogICovCiAgY3JlYXRlQ2hpbGRWaWV3OiBmdW5jdGlvbih2aWV3LCBhdHRycykgewogICAgdmlldyA9IHRoaXMuX3N1cGVyKHZpZXcsIGF0dHJzKTsKCiAgICB2YXIgaXRlbVRhZ05hbWUgPSBnZXQodmlldywgJ3RhZ05hbWUnKTsKCiAgICBpZiAoaXRlbVRhZ05hbWUgPT09IG51bGwgfHwgaXRlbVRhZ05hbWUgPT09IHVuZGVmaW5lZCkgewogICAgICBpdGVtVGFnTmFtZSA9IEVtYmVyLkNvbGxlY3Rpb25WaWV3LkNPTlRBSU5FUl9NQVBbZ2V0KHRoaXMsICd0YWdOYW1lJyldOwogICAgICBzZXQodmlldywgJ3RhZ05hbWUnLCBpdGVtVGFnTmFtZSk7CiAgICB9CgogICAgcmV0dXJuIHZpZXc7CiAgfQp9KTsKCi8qKgogIEEgbWFwIG9mIHBhcmVudCB0YWdzIHRvIHRoZWlyIGRlZmF1bHQgY2hpbGQgdGFncy4gWW91IGNhbiBhZGQKICBhZGRpdGlvbmFsIHBhcmVudCB0YWdzIGlmIHlvdSB3YW50IGNvbGxlY3Rpb24gdmlld3MgdGhhdCB1c2UKICBhIHBhcnRpY3VsYXIgcGFyZW50IHRhZyB0byBkZWZhdWx0IHRvIGEgY2hpbGQgdGFnLgoKICBAcHJvcGVydHkgQ09OVEFJTkVSX01BUAogIEB0eXBlIEhhc2gKICBAc3RhdGljCiAgQGZpbmFsCiovCkVtYmVyLkNvbGxlY3Rpb25WaWV3LkNPTlRBSU5FUl9NQVAgPSB7CiAgdWw6ICdsaScsCiAgb2w6ICdsaScsCiAgdGFibGU6ICd0cicsCiAgdGhlYWQ6ICd0cicsCiAgdGJvZHk6ICd0cicsCiAgdGZvb3Q6ICd0cicsCiAgdHI6ICd0ZCcsCiAgc2VsZWN0OiAnb3B0aW9uJwp9OwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQsIGlzTm9uZSA9IEVtYmVyLmlzTm9uZSwKICAgIGFfc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CgoKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci12aWV3cwoqLwoKLyoqCiAgQW4gYEVtYmVyLkNvbXBvbmVudGAgaXMgYSB2aWV3IHRoYXQgaXMgY29tcGxldGVseQogIGlzb2xhdGVkLiBQcm9wZXJ0eSBhY2Nlc3MgaW4gaXRzIHRlbXBsYXRlcyBnbwogIHRvIHRoZSB2aWV3IG9iamVjdCBhbmQgYWN0aW9ucyBhcmUgdGFyZ2V0ZWQgYXQKICB0aGUgdmlldyBvYmplY3QuIFRoZXJlIGlzIG5vIGFjY2VzcyB0byB0aGUKICBzdXJyb3VuZGluZyBjb250ZXh0IG9yIG91dGVyIGNvbnRyb2xsZXI7IGFsbAogIGNvbnRleHR1YWwgaW5mb3JtYXRpb24gbXVzdCBiZSBwYXNzZWQgaW4uCgogIFRoZSBlYXNpZXN0IHdheSB0byBjcmVhdGUgYW4gYEVtYmVyLkNvbXBvbmVudGAgaXMgdmlhCiAgYSB0ZW1wbGF0ZS4gSWYgeW91IG5hbWUgYSB0ZW1wbGF0ZQogIGBjb21wb25lbnRzL215LWZvb2AsIHlvdSB3aWxsIGJlIGFibGUgdG8gdXNlCiAgYHt7bXktZm9vfX1gIGluIG90aGVyIHRlbXBsYXRlcywgd2hpY2ggd2lsbCBtYWtlCiAgYW4gaW5zdGFuY2Ugb2YgdGhlIGlzb2xhdGVkIGNvbXBvbmVudC4KCiAgYGBgaHRtbAogIHt7YXBwLXByb2ZpbGUgcGVyc29uPWN1cnJlbnRVc2VyfX0KICBgYGAKCiAgYGBgaHRtbAogIDwhLS0gYXBwLXByb2ZpbGUgdGVtcGxhdGUgLS0+CiAgPGgxPnt7cGVyc29uLnRpdGxlfX08L2gxPgogIDxpbWcge3tiaW5kLWF0dHIgc3JjPXBlcnNvbi5hdmF0YXJ9fT4KICA8cCBjbGFzcz0nc2lnbmF0dXJlJz57e3BlcnNvbi5zaWduYXR1cmV9fTwvcD4KICBgYGAKCiAgWW91IGNhbiB1c2UgYHlpZWxkYCBpbnNpZGUgYSB0ZW1wbGF0ZSB0bwogIGluY2x1ZGUgdGhlICoqY29udGVudHMqKiBvZiBhbnkgYmxvY2sgYXR0YWNoZWQgdG8KICB0aGUgY29tcG9uZW50LiBUaGUgYmxvY2sgd2lsbCBiZSBleGVjdXRlZCBpbiB0aGUKICBjb250ZXh0IG9mIHRoZSBzdXJyb3VuZGluZyBjb250ZXh0IG9yIG91dGVyIGNvbnRyb2xsZXI6CgogIGBgYGhhbmRsZWJhcnMKICB7eyNhcHAtcHJvZmlsZSBwZXJzb249Y3VycmVudFVzZXJ9fQogICAgPHA+QWRtaW4gbW9kZTwvcD4KICAgIHt7ISBFeGVjdXRlZCBpbiB0aGUgY29udHJvbGxlcnMgY29udGV4dC4gfX0KICB7ey9hcHAtcHJvZmlsZX19CiAgYGBgCgogIGBgYGhhbmRsZWJhcnMKICA8IS0tIGFwcC1wcm9maWxlIHRlbXBsYXRlIC0tPgogIDxoMT57e3BlcnNvbi50aXRsZX19PC9oMT4KICB7eyEgRXhlY3V0ZWQgaW4gdGhlIGNvbXBvbmVudHMgY29udGV4dC4gfX0KICB7e3lpZWxkfX0ge3shIGJsb2NrIGNvbnRlbnRzIH19CiAgYGBgCgogIElmIHlvdSB3YW50IHRvIGN1c3RvbWl6ZSB0aGUgY29tcG9uZW50LCBpbiBvcmRlciB0bwogIGhhbmRsZSBldmVudHMgb3IgYWN0aW9ucywgeW91IGltcGxlbWVudCBhIHN1YmNsYXNzCiAgb2YgYEVtYmVyLkNvbXBvbmVudGAgbmFtZWQgYWZ0ZXIgdGhlIG5hbWUgb2YgdGhlCiAgY29tcG9uZW50LiBOb3RlIHRoYXQgYENvbXBvbmVudGAgbmVlZHMgdG8gYmUgYXBwZW5kZWQgdG8gdGhlIG5hbWUgb2YKICB5b3VyIHN1YmNsYXNzIGxpa2UgYEFwcFByb2ZpbGVDb21wb25lbnRgLgoKICBGb3IgZXhhbXBsZSwgeW91IGNvdWxkIGltcGxlbWVudCB0aGUgYWN0aW9uCiAgYGhlbGxvYCBmb3IgdGhlIGBhcHAtcHJvZmlsZWAgY29tcG9uZW50OgoKICBgYGBqYXZhc2NyaXB0CiAgQXBwLkFwcFByb2ZpbGVDb21wb25lbnQgPSBFbWJlci5Db21wb25lbnQuZXh0ZW5kKHsKICAgIGFjdGlvbnM6IHsKICAgICAgaGVsbG86IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICBjb25zb2xlLmxvZygiSGVsbG8iLCBuYW1lKTsKICAgICAgfQogICAgfQogIH0pOwogIGBgYAoKICBBbmQgdGhlbiB1c2UgaXQgaW4gdGhlIGNvbXBvbmVudCdzIHRlbXBsYXRlOgoKICBgYGBodG1sCiAgPCEtLSBhcHAtcHJvZmlsZSB0ZW1wbGF0ZSAtLT4KCiAgPGgxPnt7cGVyc29uLnRpdGxlfX08L2gxPgogIHt7eWllbGR9fSA8IS0tIGJsb2NrIGNvbnRlbnRzIC0tPgoKICA8YnV0dG9uIHt7YWN0aW9uICdoZWxsbycgcGVyc29uLm5hbWV9fT4KICAgIFNheSBIZWxsbyB0byB7e3BlcnNvbi5uYW1lfX0KICA8L2J1dHRvbj4KICBgYGAKCiAgQ29tcG9uZW50cyBtdXN0IGhhdmUgYSBgLWAgaW4gdGhlaXIgbmFtZSB0byBhdm9pZAogIGNvbmZsaWN0cyB3aXRoIGJ1aWx0LWluIGNvbnRyb2xzIHRoYXQgd3JhcCBIVE1MCiAgZWxlbWVudHMuIFRoaXMgaXMgY29uc2lzdGVudCB3aXRoIHRoZSBzYW1lCiAgcmVxdWlyZW1lbnQgaW4gd2ViIGNvbXBvbmVudHMuCgogIEBjbGFzcyBDb21wb25lbnQKICBAbmFtZXNwYWNlIEVtYmVyCiAgQGV4dGVuZHMgRW1iZXIuVmlldwoqLwpFbWJlci5Db21wb25lbnQgPSBFbWJlci5WaWV3LmV4dGVuZChFbWJlci5UYXJnZXRBY3Rpb25TdXBwb3J0LCB7CiAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9zdXBlcigpOwogICAgc2V0KHRoaXMsICdjb250ZXh0JywgdGhpcyk7CiAgICBzZXQodGhpcywgJ2NvbnRyb2xsZXInLCB0aGlzKTsKICB9LAoKICBkZWZhdWx0TGF5b3V0OiBmdW5jdGlvbihvcHRpb25zKXsKICAgIG9wdGlvbnMuZGF0YSA9IHt2aWV3OiBvcHRpb25zLl9jb250ZXh0fTsKICAgIEVtYmVyLkhhbmRsZWJhcnMuaGVscGVyc1sneWllbGQnXS5hcHBseSh0aGlzLCBbb3B0aW9uc10pOwogIH0sCgogIC8vIGR1cmluZyByZW5kZXIsIGlzb2xhdGUga2V5d29yZHMKICBjbG9uZUtleXdvcmRzOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgIHZpZXc6IHRoaXMsCiAgICAgIGNvbnRyb2xsZXI6IHRoaXMKICAgIH07CiAgfSwKCiAgX3lpZWxkOiBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgICB2YXIgdmlldyA9IG9wdGlvbnMuZGF0YS52aWV3LAogICAgICAgIHBhcmVudFZpZXcgPSB0aGlzLl9wYXJlbnRWaWV3LAogICAgICAgIHRlbXBsYXRlID0gZ2V0KHRoaXMsICd0ZW1wbGF0ZScpOwoKICAgIGlmICh0ZW1wbGF0ZSkgewogICAgICBFbWJlci5hc3NlcnQoIkEgQ29tcG9uZW50IG11c3QgaGF2ZSBhIHBhcmVudCB2aWV3IGluIG9yZGVyIHRvIHlpZWxkLiIsIHBhcmVudFZpZXcpOwoKICAgICAgdmlldy5hcHBlbmRDaGlsZChFbWJlci5WaWV3LCB7CiAgICAgICAgaXNWaXJ0dWFsOiB0cnVlLAogICAgICAgIHRhZ05hbWU6ICcnLAogICAgICAgIF9jb250ZXh0VmlldzogcGFyZW50VmlldywKICAgICAgICB0ZW1wbGF0ZTogdGVtcGxhdGUsCiAgICAgICAgY29udGV4dDogZ2V0KHBhcmVudFZpZXcsICdjb250ZXh0JyksCiAgICAgICAgY29udHJvbGxlcjogZ2V0KHBhcmVudFZpZXcsICdjb250cm9sbGVyJyksCiAgICAgICAgdGVtcGxhdGVEYXRhOiB7IGtleXdvcmRzOiBwYXJlbnRWaWV3LmNsb25lS2V5d29yZHMoKSB9CiAgICAgIH0pOwogICAgfQogIH0sCgogIC8qKgogICAgSWYgdGhlIGNvbXBvbmVudCBpcyBjdXJyZW50bHkgaW5zZXJ0ZWQgaW50byB0aGUgRE9NIG9mIGEgcGFyZW50IHZpZXcsIHRoaXMKICAgIHByb3BlcnR5IHdpbGwgcG9pbnQgdG8gdGhlIGNvbnRyb2xsZXIgb2YgdGhlIHBhcmVudCB2aWV3LgoKICAgIEBwcm9wZXJ0eSB0YXJnZXRPYmplY3QKICAgIEB0eXBlIEVtYmVyLkNvbnRyb2xsZXIKICAgIEBkZWZhdWx0IG51bGwKICAqLwogIHRhcmdldE9iamVjdDogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oa2V5KSB7CiAgICB2YXIgcGFyZW50VmlldyA9IGdldCh0aGlzLCAnX3BhcmVudFZpZXcnKTsKICAgIHJldHVybiBwYXJlbnRWaWV3ID8gZ2V0KHBhcmVudFZpZXcsICdjb250cm9sbGVyJykgOiBudWxsOwogIH0pLnByb3BlcnR5KCdfcGFyZW50VmlldycpLAoKICAvKioKICAgIFRyaWdnZXJzIGEgbmFtZWQgYWN0aW9uIG9uIHRoZSBjb250cm9sbGVyIGNvbnRleHQgd2hlcmUgdGhlIGNvbXBvbmVudCBpcyB1c2VkIGlmCiAgICB0aGlzIGNvbnRyb2xsZXIgaGFzIHJlZ2lzdGVyZWQgZm9yIG5vdGlmaWNhdGlvbnMgb2YgdGhlIGFjdGlvbi4KCiAgICBGb3IgZXhhbXBsZSBhIGNvbXBvbmVudCBmb3IgcGxheWluZyBvciBwYXVzaW5nIG11c2ljIG1heSB0cmFuc2xhdGUgY2xpY2sgZXZlbnRzCiAgICBpbnRvIGFjdGlvbiBub3RpZmljYXRpb25zIG9mICJwbGF5IiBvciAic3RvcCIgZGVwZW5kaW5nIG9uIHNvbWUgaW50ZXJuYWwgc3RhdGUKICAgIG9mIHRoZSBjb21wb25lbnQ6CgoKICAgIGBgYGphdmFzY3JpcHQKICAgIEFwcC5QbGF5QnV0dG9uQ29tcG9uZW50ID0gRW1iZXIuQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgIGNsaWNrOiBmdW5jdGlvbigpewogICAgICAgIGlmICh0aGlzLmdldCgnaXNQbGF5aW5nJykpIHsKICAgICAgICAgIHRoaXMudHJpZ2dlckFjdGlvbigncGxheScpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnRyaWdnZXJBY3Rpb24oJ3N0b3AnKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgV2hlbiB1c2VkIGluc2lkZSBhIHRlbXBsYXRlIHRoZXNlIGNvbXBvbmVudCBhY3Rpb25zIGFyZSBjb25maWd1cmVkIHRvCiAgICB0cmlnZ2VyIGFjdGlvbnMgaW4gdGhlIG91dGVyIGFwcGxpY2F0aW9uIGNvbnRleHQ6CgogICAgYGBgaGFuZGxlYmFycwogICAge3shIGFwcGxpY2F0aW9uLmhicyB9fQogICAge3twbGF5LWJ1dHRvbiBwbGF5PSJtdXNpY1N0YXJ0ZWQiIHN0b3A9Im11c2ljU3RvcHBlZCJ9fQogICAgYGBgCgogICAgV2hlbiB0aGUgY29tcG9uZW50IHJlY2VpdmVzIGEgYnJvd3NlciBgY2xpY2tgIGV2ZW50IGl0IHRyYW5zbGF0ZSB0aGlzCiAgICBpbnRlcmFjdGlvbiBpbnRvIGFwcGxpY2F0aW9uLXNwZWNpZmljIHNlbWFudGljcyAoInBsYXkiIG9yICJzdG9wIikgYW5kCiAgICB0cmlnZ2VycyB0aGUgc3BlY2lmaWVkIGFjdGlvbiBuYW1lIG9uIHRoZSBjb250cm9sbGVyIGZvciB0aGUgdGVtcGxhdGUKICAgIHdoZXJlIHRoZSBjb21wb25lbnQgaXMgdXNlZDogCgoKICAgIGBgYGphdmFzY3JpcHQKICAgIEFwcC5BcHBsaWNhdGlvbkNvbnRyb2xsZXIgPSBFbWJlci5Db250cm9sbGVyLmV4dGVuZCh7CiAgICAgIGFjdGlvbnM6IHsKICAgICAgICBtdXNpY1N0YXJ0ZWQ6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAvLyBjYWxsZWQgd2hlbiB0aGUgcGxheSBidXR0b24gaXMgY2xpY2tlZAogICAgICAgICAgLy8gYW5kIHRoZSBtdXNpYyBzdGFydGVkIHBsYXlpbmcKICAgICAgICB9LAogICAgICAgIG11c2ljU3RvcHBlZDogZnVuY3Rpb24oKXsKICAgICAgICAgIC8vIGNhbGxlZCB3aGVuIHRoZSBwbGF5IGJ1dHRvbiBpcyBjbGlja2VkCiAgICAgICAgICAvLyBhbmQgdGhlIG11c2ljIHN0b3BwZWQgcGxheWluZwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBgYGAKCiAgICBJZiBubyBhY3Rpb24gbmFtZSBpcyBwYXNzZWQgdG8gYHNlbmRBY3Rpb25gIGEgZGVmYXVsdCBuYW1lIG9mICJhY3Rpb24iCiAgICBpcyBhc3N1bWVkLgoKICAgIGBgYGphdmFzY3JpcHQKICAgIEFwcC5OZXh0QnV0dG9uQ29tcG9uZW50ID0gRW1iZXIuQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgIGNsaWNrOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuc2VuZEFjdGlvbigpOwogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgIGBgYGhhbmRsZWJhcnMKICAgIHt7ISBhcHBsaWNhdGlvbi5oYnMgfX0KICAgIHt7bmV4dC1idXR0b24gYWN0aW9uPSJwbGF5TmV4dFNvbmdJbkFsYnVtIn19CiAgICBgYGAKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuQXBwbGljYXRpb25Db250cm9sbGVyID0gRW1iZXIuQ29udHJvbGxlci5leHRlbmQoewogICAgICBhY3Rpb25zOiB7CiAgICAgICAgcGxheU5leHRTb25nSW5BbGJ1bTogZnVuY3Rpb24oKXsKICAgICAgICAgIC4uLgogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBgYGAKCiAgICBAbWV0aG9kIHNlbmRBY3Rpb24KICAgIEBwYXJhbSBbYWN0aW9uXSB7U3RyaW5nfSB0aGUgYWN0aW9uIHRvIHRyaWdnZXIKICAgIEBwYXJhbSBbY29udGV4dF0geyp9IGEgY29udGV4dCB0byBzZW5kIHdpdGggdGhlIGFjdGlvbgogICovCiAgc2VuZEFjdGlvbjogZnVuY3Rpb24oYWN0aW9uKSB7CiAgICB2YXIgYWN0aW9uTmFtZSwKICAgICAgICBjb250ZXh0cyA9IGFfc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwoKICAgIC8vIFNlbmQgdGhlIGRlZmF1bHQgYWN0aW9uCiAgICBpZiAoYWN0aW9uID09PSB1bmRlZmluZWQpIHsKICAgICAgYWN0aW9uTmFtZSA9IGdldCh0aGlzLCAnYWN0aW9uJyk7CiAgICAgIEVtYmVyLmFzc2VydCgiVGhlIGRlZmF1bHQgYWN0aW9uIHdhcyB0cmlnZ2VyZWQgb24gdGhlIGNvbXBvbmVudCAiICsgdGhpcy50b1N0cmluZygpICsKICAgICAgICAgICAgICAgICAgICIsIGJ1dCB0aGUgYWN0aW9uIG5hbWUgKCIgKyBhY3Rpb25OYW1lICsgIikgd2FzIG5vdCBhIHN0cmluZy4iLAogICAgICAgICAgICAgICAgICAgaXNOb25lKGFjdGlvbk5hbWUpIHx8IHR5cGVvZiBhY3Rpb25OYW1lID09PSAnc3RyaW5nJyk7CiAgICB9IGVsc2UgewogICAgICBhY3Rpb25OYW1lID0gZ2V0KHRoaXMsIGFjdGlvbik7CiAgICAgIEVtYmVyLmFzc2VydCgiVGhlICIgKyBhY3Rpb24gKyAiIGFjdGlvbiB3YXMgdHJpZ2dlcmVkIG9uIHRoZSBjb21wb25lbnQgIiArCiAgICAgICAgICAgICAgICAgICB0aGlzLnRvU3RyaW5nKCkgKyAiLCBidXQgdGhlIGFjdGlvbiBuYW1lICgiICsgYWN0aW9uTmFtZSArCiAgICAgICAgICAgICAgICAgICAiKSB3YXMgbm90IGEgc3RyaW5nLiIsCiAgICAgICAgICAgICAgICAgICBpc05vbmUoYWN0aW9uTmFtZSkgfHwgdHlwZW9mIGFjdGlvbk5hbWUgPT09ICdzdHJpbmcnKTsKICAgIH0KCiAgICAvLyBJZiBubyBhY3Rpb24gbmFtZSBmb3IgdGhhdCBhY3Rpb24gY291bGQgYmUgZm91bmQsIGp1c3QgYWJvcnQuCiAgICBpZiAoYWN0aW9uTmFtZSA9PT0gdW5kZWZpbmVkKSB7IHJldHVybjsgfQoKICAgIHRoaXMudHJpZ2dlckFjdGlvbih7CiAgICAgIGFjdGlvbjogYWN0aW9uTmFtZSwKICAgICAgYWN0aW9uQ29udGV4dDogY29udGV4dHMKICAgIH0pOwogIH0KfSk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpgRW1iZXIuVmlld1RhcmdldEFjdGlvblN1cHBvcnRgIGlzIGEgbWl4aW4gdGhhdCBjYW4gYmUgaW5jbHVkZWQgaW4gYQp2aWV3IGNsYXNzIHRvIGFkZCBhIGB0cmlnZ2VyQWN0aW9uYCBtZXRob2Qgd2l0aCBzZW1hbnRpY3Mgc2ltaWxhciB0bwp0aGUgSGFuZGxlYmFycyBge3thY3Rpb259fWAgaGVscGVyLiBJdCBwcm92aWRlcyBpbnRlbGxpZ2VudCBkZWZhdWx0cwpmb3IgdGhlIGFjdGlvbidzIHRhcmdldDogdGhlIHZpZXcncyBjb250cm9sbGVyOyBhbmQgdGhlIGNvbnRleHQgdGhhdCBpcwpzZW50IHdpdGggdGhlIGFjdGlvbjogdGhlIHZpZXcncyBjb250ZXh0LgoKTm90ZTogSW4gbm9ybWFsIEVtYmVyIHVzYWdlLCB0aGUgYHt7YWN0aW9ufX1gIGhlbHBlciBpcyB1c3VhbGx5IHRoZSBiZXN0CmNob2ljZS4gVGhpcyBtaXhpbiBpcyBtb3N0IG9mdGVuIHVzZWZ1bCB3aGVuIHlvdSBhcmUgZG9pbmcgbW9yZSBjb21wbGV4CmV2ZW50IGhhbmRsaW5nIGluIGN1c3RvbSBWaWV3IHN1YmNsYXNzZXMuCgpGb3IgZXhhbXBsZToKCmBgYGphdmFzY3JpcHQKQXBwLlNhdmVCdXR0b25WaWV3ID0gRW1iZXIuVmlldy5leHRlbmQoRW1iZXIuVmlld1RhcmdldEFjdGlvblN1cHBvcnQsIHsKICBhY3Rpb246ICdzYXZlJywKICBjbGljazogZnVuY3Rpb24oKSB7CiAgICB0aGlzLnRyaWdnZXJBY3Rpb24oKTsgLy8gU2VuZHMgdGhlIGBzYXZlYCBhY3Rpb24sIGFsb25nIHdpdGggdGhlIGN1cnJlbnQgY29udGV4dAogICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRvIHRoZSBjdXJyZW50IGNvbnRyb2xsZXIKICB9Cn0pOwpgYGAKClRoZSBgYWN0aW9uYCBjYW4gYmUgcHJvdmlkZWQgYXMgcHJvcGVydGllcyBvZiBhbiBvcHRpb25hbCBvYmplY3QgYXJndW1lbnQKdG8gYHRyaWdnZXJBY3Rpb25gIGFzIHdlbGwuCgpgYGBqYXZhc2NyaXB0CkFwcC5TYXZlQnV0dG9uVmlldyA9IEVtYmVyLlZpZXcuZXh0ZW5kKEVtYmVyLlZpZXdUYXJnZXRBY3Rpb25TdXBwb3J0LCB7CiAgY2xpY2s6IGZ1bmN0aW9uKCkgewogICAgdGhpcy50cmlnZ2VyQWN0aW9uKHsKICAgICAgYWN0aW9uOiAnc2F2ZScKICAgIH0pOyAvLyBTZW5kcyB0aGUgYHNhdmVgIGFjdGlvbiwgYWxvbmcgd2l0aCB0aGUgY3VycmVudCBjb250ZXh0CiAgICAgICAgLy8gdG8gdGhlIGN1cnJlbnQgY29udHJvbGxlcgogIH0KfSk7CmBgYAoKQGNsYXNzIFZpZXdUYXJnZXRBY3Rpb25TdXBwb3J0CkBuYW1lc3BhY2UgRW1iZXIKQGV4dGVuZHMgRW1iZXIuVGFyZ2V0QWN0aW9uU3VwcG9ydAoqLwpFbWJlci5WaWV3VGFyZ2V0QWN0aW9uU3VwcG9ydCA9IEVtYmVyLk1peGluLmNyZWF0ZShFbWJlci5UYXJnZXRBY3Rpb25TdXBwb3J0LCB7CiAgLyoqCiAgQHByb3BlcnR5IHRhcmdldAogICovCiAgdGFyZ2V0OiBFbWJlci5jb21wdXRlZC5hbGlhcygnY29udHJvbGxlcicpLAogIC8qKgogIEBwcm9wZXJ0eSBhY3Rpb25Db250ZXh0CiAgKi8KICBhY3Rpb25Db250ZXh0OiBFbWJlci5jb21wdXRlZC5hbGlhcygnY29udGV4dCcpCn0pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKRW1iZXIgVmlld3MKCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci12aWV3cwpAcmVxdWlyZXMgZW1iZXItcnVudGltZQpAbWFpbiBlbWJlci12aWV3cwoqLwoKfSkoKTsKCihmdW5jdGlvbigpIHsKZGVmaW5lKCJtZXRhbW9ycGgiLAogIFtdLAogIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgIC8vIFByb2plY3Q6ICAgbWV0YW1vcnBoCiAgICAvLyBDb3B5cmlnaHQ6IMKpMjAxNCBUaWxkZSwgSW5jLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KCiAgICB2YXIgSyA9IGZ1bmN0aW9uKCkge30sCiAgICAgICAgZ3VpZCA9IDAsCiAgICAgICAgZGlzYWJsZVJhbmdlID0gKGZ1bmN0aW9uKCl7CiAgICAgICAgICBpZiAoJ3VuZGVmaW5lZCcgIT09IHR5cGVvZiBNZXRhbW9ycGhFTlYpIHsKICAgICAgICAgICAgcmV0dXJuIE1ldGFtb3JwaEVOVi5ESVNBQkxFX1JBTkdFX0FQSTsKICAgICAgICAgIH0gZWxzZSBpZiAoJ3VuZGVmaW5lZCcgIT09IEVOVikgewogICAgICAgICAgICByZXR1cm4gRU5WLkRJU0FCTEVfUkFOR0VfQVBJOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0pKCksCgogICAgICAgIC8vIEZlYXR1cmUtZGV0ZWN0IHRoZSBXM0MgcmFuZ2UgQVBJLCB0aGUgZXh0ZW5kZWQgY2hlY2sgaXMgZm9yIElFOSB3aGljaCBvbmx5IHBhcnRpYWxseSBzdXBwb3J0cyByYW5nZXMKICAgICAgICBzdXBwb3J0c1JhbmdlID0gKCFkaXNhYmxlUmFuZ2UpICYmIGRvY3VtZW50ICYmICgnY3JlYXRlUmFuZ2UnIGluIGRvY3VtZW50KSAmJiAodHlwZW9mIFJhbmdlICE9PSAndW5kZWZpbmVkJykgJiYgUmFuZ2UucHJvdG90eXBlLmNyZWF0ZUNvbnRleHR1YWxGcmFnbWVudCwKCiAgICAgICAgLy8gSW50ZXJuZXQgRXhwbG9yZXIgcHJpb3IgdG8gOSBkb2VzIG5vdCBhbGxvdyBzZXR0aW5nIGlubmVySFRNTCBpZiB0aGUgZmlyc3QgZWxlbWVudAogICAgICAgIC8vIGlzIGEgInplcm8tc2NvcGUiIGVsZW1lbnQuIFRoaXMgcHJvYmxlbSBjYW4gYmUgd29ya2VkIGFyb3VuZCBieSBtYWtpbmcKICAgICAgICAvLyB0aGUgZmlyc3Qgbm9kZSBhbiBpbnZpc2libGUgdGV4dCBub2RlLiBXZSwgbGlrZSBNb2Rlcm5penIsIHVzZSAmc2h5OwogICAgICAgIG5lZWRzU2h5ID0gZG9jdW1lbnQgJiYgKGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHRlc3RFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgdGVzdEVsLmlubmVySFRNTCA9ICI8ZGl2PjwvZGl2PiI7CiAgICAgICAgICB0ZXN0RWwuZmlyc3RDaGlsZC5pbm5lckhUTUwgPSAiPHNjcmlwdD48L3NjcmlwdD4iOwogICAgICAgICAgcmV0dXJuIHRlc3RFbC5maXJzdENoaWxkLmlubmVySFRNTCA9PT0gJyc7CiAgICAgICAgfSkoKSwKCgogICAgICAgIC8vIElFIDggKGFuZCBsaWtlbHkgZWFybGllcikgbGlrZXMgdG8gbW92ZSB3aGl0ZXNwYWNlIHByZWNlZWRpbmcKICAgICAgICAvLyBhIHNjcmlwdCB0YWcgdG8gYXBwZWFyIGFmdGVyIGl0LiBUaGlzIG1lYW5zIHRoYXQgd2UgY2FuCiAgICAgICAgLy8gYWNjaWRlbnRhbGx5IHJlbW92ZSB3aGl0ZXNwYWNlIHdoZW4gdXBkYXRpbmcgYSBtb3JwaC4KICAgICAgICBtb3Zlc1doaXRlc3BhY2UgPSBkb2N1bWVudCAmJiAoZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgdGVzdEVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICB0ZXN0RWwuaW5uZXJIVE1MID0gIlRlc3Q6IDxzY3JpcHQgdHlwZT0ndGV4dC94LXBsYWNlaG9sZGVyJz48L3NjcmlwdD5WYWx1ZSI7CiAgICAgICAgICByZXR1cm4gdGVzdEVsLmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAnVGVzdDonICYmCiAgICAgICAgICAgICAgICAgIHRlc3RFbC5jaGlsZE5vZGVzWzJdLm5vZGVWYWx1ZSA9PT0gJyBWYWx1ZSc7CiAgICAgICAgfSkoKTsKCiAgICAvLyBDb25zdHJ1Y3RvciB0aGF0IHN1cHBvcnRzIGVpdGhlciBNZXRhbW9ycGgoJ2ZvbycpIG9yIG5ldwogICAgLy8gTWV0YW1vcnBoKCdmb28nKTsKICAgIC8vCiAgICAvLyBUYWtlcyBhIHN0cmluZyBvZiBIVE1MIGFzIHRoZSBhcmd1bWVudC4KCiAgICB2YXIgTWV0YW1vcnBoID0gZnVuY3Rpb24oaHRtbCkgewogICAgICB2YXIgc2VsZjsKCiAgICAgIGlmICh0aGlzIGluc3RhbmNlb2YgTWV0YW1vcnBoKSB7CiAgICAgICAgc2VsZiA9IHRoaXM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2VsZiA9IG5ldyBLKCk7CiAgICAgIH0KCiAgICAgIHNlbGYuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgdmFyIG15R3VpZCA9ICdtZXRhbW9ycGgtJysoZ3VpZCsrKTsKICAgICAgc2VsZi5zdGFydCA9IG15R3VpZCArICctc3RhcnQnOwogICAgICBzZWxmLmVuZCA9IG15R3VpZCArICctZW5kJzsKCiAgICAgIHJldHVybiBzZWxmOwogICAgfTsKCiAgICBLLnByb3RvdHlwZSA9IE1ldGFtb3JwaC5wcm90b3R5cGU7CgogICAgdmFyIHJhbmdlRm9yLCBodG1sRnVuYywgcmVtb3ZlRnVuYywgb3V0ZXJIVE1MRnVuYywgYXBwZW5kVG9GdW5jLCBhZnRlckZ1bmMsIHByZXBlbmRGdW5jLCBzdGFydFRhZ0Z1bmMsIGVuZFRhZ0Z1bmM7CgogICAgb3V0ZXJIVE1MRnVuYyA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5zdGFydFRhZygpICsgdGhpcy5pbm5lckhUTUwgKyB0aGlzLmVuZFRhZygpOwogICAgfTsKCiAgICBzdGFydFRhZ0Z1bmMgPSBmdW5jdGlvbigpIHsKICAgICAgLyoKICAgICAgICogV2UgcmVwbGFjZSBjaGV2cm9uIGJ5IGl0cyBoZXggY29kZSBpbiBvcmRlciB0byBwcmV2ZW50IGVzY2FwaW5nIHByb2JsZW1zLgogICAgICAgKiBDaGVjayB0aGlzIHRocmVhZCBmb3IgbW9yZSBleHBsYWluYXRpb246CiAgICAgICAqIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvODIzMTA0OC93aHktdXNlLXgzYy1pbnN0ZWFkLW9mLXdoZW4tZ2VuZXJhdGluZy1odG1sLWZyb20tamF2YXNjcmlwdAogICAgICAgKi8KICAgICAgcmV0dXJuICI8c2NyaXB0IGlkPSciICsgdGhpcy5zdGFydCArICInIHR5cGU9J3RleHQveC1wbGFjZWhvbGRlcic+XHgzQy9zY3JpcHQ+IjsKICAgIH07CgogICAgZW5kVGFnRnVuYyA9IGZ1bmN0aW9uKCkgewogICAgICAvKgogICAgICAgKiBXZSByZXBsYWNlIGNoZXZyb24gYnkgaXRzIGhleCBjb2RlIGluIG9yZGVyIHRvIHByZXZlbnQgZXNjYXBpbmcgcHJvYmxlbXMuCiAgICAgICAqIENoZWNrIHRoaXMgdGhyZWFkIGZvciBtb3JlIGV4cGxhaW5hdGlvbjoKICAgICAgICogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy84MjMxMDQ4L3doeS11c2UteDNjLWluc3RlYWQtb2Ytd2hlbi1nZW5lcmF0aW5nLWh0bWwtZnJvbS1qYXZhc2NyaXB0CiAgICAgICAqLwogICAgICByZXR1cm4gIjxzY3JpcHQgaWQ9JyIgKyB0aGlzLmVuZCArICInIHR5cGU9J3RleHQveC1wbGFjZWhvbGRlcic+XHgzQy9zY3JpcHQ+IjsKICAgIH07CgogICAgLy8gSWYgd2UgaGF2ZSB0aGUgVzNDIHJhbmdlIEFQSSwgdGhpcyBwcm9jZXNzIGlzIHJlbGF0aXZlbHkgc3RyYWlnaHQgZm9yd2FyZC4KICAgIGlmIChzdXBwb3J0c1JhbmdlKSB7CgogICAgICAvLyBHZXQgYSByYW5nZSBmb3IgdGhlIGN1cnJlbnQgbW9ycGguIE9wdGlvbmFsbHkgaW5jbHVkZSB0aGUgc3RhcnRpbmcgYW5kCiAgICAgIC8vIGVuZGluZyBwbGFjZWhvbGRlcnMuCiAgICAgIHJhbmdlRm9yID0gZnVuY3Rpb24obW9ycGgsIG91dGVyVG9vKSB7CiAgICAgICAgdmFyIHJhbmdlID0gZG9jdW1lbnQuY3JlYXRlUmFuZ2UoKTsKICAgICAgICB2YXIgYmVmb3JlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobW9ycGguc3RhcnQpOwogICAgICAgIHZhciBhZnRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKG1vcnBoLmVuZCk7CgogICAgICAgIGlmIChvdXRlclRvbykgewogICAgICAgICAgcmFuZ2Uuc2V0U3RhcnRCZWZvcmUoYmVmb3JlKTsKICAgICAgICAgIHJhbmdlLnNldEVuZEFmdGVyKGFmdGVyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmFuZ2Uuc2V0U3RhcnRBZnRlcihiZWZvcmUpOwogICAgICAgICAgcmFuZ2Uuc2V0RW5kQmVmb3JlKGFmdGVyKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiByYW5nZTsKICAgICAgfTsKCiAgICAgIGh0bWxGdW5jID0gZnVuY3Rpb24oaHRtbCwgb3V0ZXJUb28pIHsKICAgICAgICAvLyBnZXQgYSByYW5nZSBmb3IgdGhlIGN1cnJlbnQgbWV0YW1vcnBoIG9iamVjdAogICAgICAgIHZhciByYW5nZSA9IHJhbmdlRm9yKHRoaXMsIG91dGVyVG9vKTsKCiAgICAgICAgLy8gZGVsZXRlIHRoZSBjb250ZW50cyBvZiB0aGUgcmFuZ2UsIHdoaWNoIHdpbGwgYmUgdGhlCiAgICAgICAgLy8gbm9kZXMgYmV0d2VlbiB0aGUgc3RhcnRpbmcgYW5kIGVuZGluZyBwbGFjZWhvbGRlci4KICAgICAgICByYW5nZS5kZWxldGVDb250ZW50cygpOwoKICAgICAgICAvLyBjcmVhdGUgYSBuZXcgZG9jdW1lbnQgZnJhZ21lbnQgZm9yIHRoZSBIVE1MCiAgICAgICAgdmFyIGZyYWdtZW50ID0gcmFuZ2UuY3JlYXRlQ29udGV4dHVhbEZyYWdtZW50KGh0bWwpOwoKICAgICAgICAvLyBpbnNlcnQgdGhlIGZyYWdtZW50IGludG8gdGhlIHJhbmdlCiAgICAgICAgcmFuZ2UuaW5zZXJ0Tm9kZShmcmFnbWVudCk7CiAgICAgIH07CgogICAgICAvKioKICAgICAgKiBAcHVibGljCiAgICAgICoKICAgICAgKiBSZW1vdmUgdGhpcyBvYmplY3QgKGluY2x1ZGluZyBzdGFydGluZyBhbmQgZW5kaW5nCiAgICAgICogcGxhY2Vob2xkZXJzKS4KICAgICAgKgogICAgICAqIEBtZXRob2QgcmVtb3ZlCiAgICAgICovCiAgICAgIHJlbW92ZUZ1bmMgPSBmdW5jdGlvbigpIHsKICAgICAgICAvLyBnZXQgYSByYW5nZSBmb3IgdGhlIGN1cnJlbnQgbWV0YW1vcnBoIG9iamVjdCBpbmNsdWRpbmcKICAgICAgICAvLyB0aGUgc3RhcnRpbmcgYW5kIGVuZGluZyBwbGFjZWhvbGRlcnMuCiAgICAgICAgdmFyIHJhbmdlID0gcmFuZ2VGb3IodGhpcywgdHJ1ZSk7CgogICAgICAgIC8vIGRlbGV0ZSB0aGUgZW50aXJlIHJhbmdlLgogICAgICAgIHJhbmdlLmRlbGV0ZUNvbnRlbnRzKCk7CiAgICAgIH07CgogICAgICBhcHBlbmRUb0Z1bmMgPSBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgdmFyIHJhbmdlID0gZG9jdW1lbnQuY3JlYXRlUmFuZ2UoKTsKICAgICAgICByYW5nZS5zZXRTdGFydChub2RlKTsKICAgICAgICByYW5nZS5jb2xsYXBzZShmYWxzZSk7CiAgICAgICAgdmFyIGZyYWcgPSByYW5nZS5jcmVhdGVDb250ZXh0dWFsRnJhZ21lbnQodGhpcy5vdXRlckhUTUwoKSk7CiAgICAgICAgbm9kZS5hcHBlbmRDaGlsZChmcmFnKTsKICAgICAgfTsKCiAgICAgIGFmdGVyRnVuYyA9IGZ1bmN0aW9uKGh0bWwpIHsKICAgICAgICB2YXIgcmFuZ2UgPSBkb2N1bWVudC5jcmVhdGVSYW5nZSgpOwogICAgICAgIHZhciBhZnRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuZW5kKTsKCiAgICAgICAgcmFuZ2Uuc2V0U3RhcnRBZnRlcihhZnRlcik7CiAgICAgICAgcmFuZ2Uuc2V0RW5kQWZ0ZXIoYWZ0ZXIpOwoKICAgICAgICB2YXIgZnJhZ21lbnQgPSByYW5nZS5jcmVhdGVDb250ZXh0dWFsRnJhZ21lbnQoaHRtbCk7CiAgICAgICAgcmFuZ2UuaW5zZXJ0Tm9kZShmcmFnbWVudCk7CiAgICAgIH07CgogICAgICBwcmVwZW5kRnVuYyA9IGZ1bmN0aW9uKGh0bWwpIHsKICAgICAgICB2YXIgcmFuZ2UgPSBkb2N1bWVudC5jcmVhdGVSYW5nZSgpOwogICAgICAgIHZhciBzdGFydCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuc3RhcnQpOwoKICAgICAgICByYW5nZS5zZXRTdGFydEFmdGVyKHN0YXJ0KTsKICAgICAgICByYW5nZS5zZXRFbmRBZnRlcihzdGFydCk7CgogICAgICAgIHZhciBmcmFnbWVudCA9IHJhbmdlLmNyZWF0ZUNvbnRleHR1YWxGcmFnbWVudChodG1sKTsKICAgICAgICByYW5nZS5pbnNlcnROb2RlKGZyYWdtZW50KTsKICAgICAgfTsKCiAgICB9IGVsc2UgewogICAgICAvKgogICAgICAgKiBUaGlzIGNvZGUgaXMgbW9zdGx5IHRha2VuIGZyb20galF1ZXJ5LCB3aXRoIG9uZSBleGNlcHRpb24uIEluIGpRdWVyeSdzIGNhc2UsIHdlCiAgICAgICAqIGhhdmUgc29tZSBIVE1MIGFuZCB3ZSBuZWVkIHRvIGZpZ3VyZSBvdXQgaG93IHRvIGNvbnZlcnQgaXQgaW50byBzb21lIG5vZGVzLgogICAgICAgKgogICAgICAgKiBJbiB0aGlzIGNhc2UsIGpRdWVyeSBuZWVkcyB0byBzY2FuIHRoZSBIVE1MIGxvb2tpbmcgZm9yIGFuIG9wZW5pbmcgdGFnIGFuZCB1c2UKICAgICAgICogdGhhdCBhcyB0aGUga2V5IGZvciB0aGUgd3JhcCBtYXAuIEluIG91ciBjYXNlLCB3ZSBrbm93IHRoZSBwYXJlbnQgbm9kZSwgYW5kCiAgICAgICAqIGNhbiB1c2UgaXRzIHR5cGUgYXMgdGhlIGtleSBmb3IgdGhlIHdyYXAgbWFwLgogICAgICAgKiovCiAgICAgIHZhciB3cmFwTWFwID0gewogICAgICAgIHNlbGVjdDogWyAxLCAiPHNlbGVjdCBtdWx0aXBsZT0nbXVsdGlwbGUnPiIsICI8L3NlbGVjdD4iIF0sCiAgICAgICAgZmllbGRzZXQ6IFsgMSwgIjxmaWVsZHNldD4iLCAiPC9maWVsZHNldD4iIF0sCiAgICAgICAgdGFibGU6IFsgMSwgIjx0YWJsZT4iLCAiPC90YWJsZT4iIF0sCiAgICAgICAgdGJvZHk6IFsgMiwgIjx0YWJsZT48dGJvZHk+IiwgIjwvdGJvZHk+PC90YWJsZT4iIF0sCiAgICAgICAgdHI6IFsgMywgIjx0YWJsZT48dGJvZHk+PHRyPiIsICI8L3RyPjwvdGJvZHk+PC90YWJsZT4iIF0sCiAgICAgICAgY29sZ3JvdXA6IFsgMiwgIjx0YWJsZT48dGJvZHk+PC90Ym9keT48Y29sZ3JvdXA+IiwgIjwvY29sZ3JvdXA+PC90YWJsZT4iIF0sCiAgICAgICAgbWFwOiBbIDEsICI8bWFwPiIsICI8L21hcD4iIF0sCiAgICAgICAgX2RlZmF1bHQ6IFsgMCwgIiIsICIiIF0KICAgICAgfTsKCiAgICAgIHZhciBmaW5kQ2hpbGRCeUlkID0gZnVuY3Rpb24oZWxlbWVudCwgaWQpIHsKICAgICAgICBpZiAoZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2lkJykgPT09IGlkKSB7IHJldHVybiBlbGVtZW50OyB9CgogICAgICAgIHZhciBsZW4gPSBlbGVtZW50LmNoaWxkTm9kZXMubGVuZ3RoLCBpZHgsIG5vZGUsIGZvdW5kOwogICAgICAgIGZvciAoaWR4PTA7IGlkeDxsZW47IGlkeCsrKSB7CiAgICAgICAgICBub2RlID0gZWxlbWVudC5jaGlsZE5vZGVzW2lkeF07CiAgICAgICAgICBmb3VuZCA9IG5vZGUubm9kZVR5cGUgPT09IDEgJiYgZmluZENoaWxkQnlJZChub2RlLCBpZCk7CiAgICAgICAgICBpZiAoZm91bmQpIHsgcmV0dXJuIGZvdW5kOyB9CiAgICAgICAgfQogICAgICB9OwoKICAgICAgdmFyIHNldElubmVySFRNTCA9IGZ1bmN0aW9uKGVsZW1lbnQsIGh0bWwpIHsKICAgICAgICB2YXIgbWF0Y2hlcyA9IFtdOwogICAgICAgIGlmIChtb3Zlc1doaXRlc3BhY2UpIHsKICAgICAgICAgIC8vIFJpZ2h0IG5vdyB3ZSBvbmx5IGNoZWNrIGZvciBzY3JpcHQgdGFncyB3aXRoIGlkcyB3aXRoIHRoZQogICAgICAgICAgLy8gZ29hbCBvZiB0YXJnZXRpbmcgbW9ycGhzLgogICAgICAgICAgaHRtbCA9IGh0bWwucmVwbGFjZSgvKFxzKykoPHNjcmlwdCBpZD0nKFteJ10rKScpL2csIGZ1bmN0aW9uKG1hdGNoLCBzcGFjZXMsIHRhZywgaWQpIHsKICAgICAgICAgICAgbWF0Y2hlcy5wdXNoKFtpZCwgc3BhY2VzXSk7CiAgICAgICAgICAgIHJldHVybiB0YWc7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGVsZW1lbnQuaW5uZXJIVE1MID0gaHRtbDsKCiAgICAgICAgLy8gSWYgd2UgaGF2ZSB0byBkbyBhbnkgd2hpdGVzcGFjZSBhZGp1c3RtZW50cyBkbyB0aGVtIG5vdwogICAgICAgIGlmIChtYXRjaGVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHZhciBsZW4gPSBtYXRjaGVzLmxlbmd0aCwgaWR4OwogICAgICAgICAgZm9yIChpZHg9MDsgaWR4PGxlbjsgaWR4KyspIHsKICAgICAgICAgICAgdmFyIHNjcmlwdCA9IGZpbmRDaGlsZEJ5SWQoZWxlbWVudCwgbWF0Y2hlc1tpZHhdWzBdKSwKICAgICAgICAgICAgICAgIG5vZGUgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShtYXRjaGVzW2lkeF1bMV0pOwogICAgICAgICAgICBzY3JpcHQucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZSwgc2NyaXB0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CgogICAgICAvKgogICAgICAgKiBHaXZlbiBhIHBhcmVudCBub2RlIGFuZCBzb21lIEhUTUwsIGdlbmVyYXRlIGEgc2V0IG9mIG5vZGVzLiBSZXR1cm4gdGhlIGZpcnN0CiAgICAgICAqIG5vZGUsIHdoaWNoIHdpbGwgYWxsb3cgdXMgdG8gdHJhdmVyc2UgdGhlIHJlc3QgdXNpbmcgbmV4dFNpYmxpbmcuCiAgICAgICAqCiAgICAgICAqIFdlIG5lZWQgdG8gZG8gdGhpcyBiZWNhdXNlIGlubmVySFRNTCBpbiBJRSBkb2VzIG5vdCByZWFsbHkgcGFyc2UgdGhlIG5vZGVzLgogICAgICAgKi8KICAgICAgdmFyIGZpcnN0Tm9kZUZvciA9IGZ1bmN0aW9uKHBhcmVudE5vZGUsIGh0bWwpIHsKICAgICAgICB2YXIgYXJyID0gd3JhcE1hcFtwYXJlbnROb2RlLnRhZ05hbWUudG9Mb3dlckNhc2UoKV0gfHwgd3JhcE1hcC5fZGVmYXVsdDsKICAgICAgICB2YXIgZGVwdGggPSBhcnJbMF0sIHN0YXJ0ID0gYXJyWzFdLCBlbmQgPSBhcnJbMl07CgogICAgICAgIGlmIChuZWVkc1NoeSkgeyBodG1sID0gJyZzaHk7JytodG1sOyB9CgogICAgICAgIHZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgogICAgICAgIHNldElubmVySFRNTChlbGVtZW50LCBzdGFydCArIGh0bWwgKyBlbmQpOwoKICAgICAgICBmb3IgKHZhciBpPTA7IGk8PWRlcHRoOyBpKyspIHsKICAgICAgICAgIGVsZW1lbnQgPSBlbGVtZW50LmZpcnN0Q2hpbGQ7CiAgICAgICAgfQoKICAgICAgICAvLyBMb29rIGZvciAmc2h5OyB0byByZW1vdmUgaXQuCiAgICAgICAgaWYgKG5lZWRzU2h5KSB7CiAgICAgICAgICB2YXIgc2h5RWxlbWVudCA9IGVsZW1lbnQ7CgogICAgICAgICAgLy8gU29tZXRpbWVzIHdlIGdldCBuYW1lbGVzcyBlbGVtZW50cyB3aXRoIHRoZSBzaHkgaW5zaWRlCiAgICAgICAgICB3aGlsZSAoc2h5RWxlbWVudC5ub2RlVHlwZSA9PT0gMSAmJiAhc2h5RWxlbWVudC5ub2RlTmFtZSkgewogICAgICAgICAgICBzaHlFbGVtZW50ID0gc2h5RWxlbWVudC5maXJzdENoaWxkOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIEF0IHRoaXMgcG9pbnQgaXQncyB0aGUgYWN0dWFsIHVuaWNvZGUgY2hhcmFjdGVyLgogICAgICAgICAgaWYgKHNoeUVsZW1lbnQubm9kZVR5cGUgPT09IDMgJiYgc2h5RWxlbWVudC5ub2RlVmFsdWUuY2hhckF0KDApID09PSAiXHUwMEFEIikgewogICAgICAgICAgICBzaHlFbGVtZW50Lm5vZGVWYWx1ZSA9IHNoeUVsZW1lbnQubm9kZVZhbHVlLnNsaWNlKDEpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgIH07CgogICAgICAvKgogICAgICAgKiBJbiBzb21lIGNhc2VzLCBJbnRlcm5ldCBFeHBsb3JlciBjYW4gY3JlYXRlIGFuIGFub255bW91cyBub2RlIGluCiAgICAgICAqIHRoZSBoaWVyYXJjaHkgd2l0aCBubyB0YWdOYW1lLiBZb3UgY2FuIGNyZWF0ZSB0aGlzIHNjZW5hcmlvIHZpYToKICAgICAgICoKICAgICAgICogICAgIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgKiAgICAgZGl2LmlubmVySFRNTCA9ICI8dGFibGU+JnNoeTxzY3JpcHQ+PC9zY3JpcHQ+PHRyPjx0ZD5oaTwvdGQ+PC90cj48L3RhYmxlPiI7CiAgICAgICAqICAgICBkaXYuZmlyc3RDaGlsZC5maXJzdENoaWxkLnRhZ05hbWUgLy89PiAiIgogICAgICAgKgogICAgICAgKiBJZiBvdXIgc2NyaXB0IG1hcmtlcnMgYXJlIGluc2lkZSBzdWNoIGEgbm9kZSwgd2UgbmVlZCB0byBmaW5kIHRoYXQKICAgICAgICogbm9kZSBhbmQgdXNlICppdCogYXMgdGhlIG1hcmtlci4KICAgICAgICovCiAgICAgIHZhciByZWFsTm9kZSA9IGZ1bmN0aW9uKHN0YXJ0KSB7CiAgICAgICAgd2hpbGUgKHN0YXJ0LnBhcmVudE5vZGUudGFnTmFtZSA9PT0gIiIpIHsKICAgICAgICAgIHN0YXJ0ID0gc3RhcnQucGFyZW50Tm9kZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBzdGFydDsKICAgICAgfTsKCiAgICAgIC8qCiAgICAgICAqIFdoZW4gYXV0b21hdGljYWxseSBhZGRpbmcgYSB0Ym9keSwgSW50ZXJuZXQgRXhwbG9yZXIgaW5zZXJ0cyB0aGUKICAgICAgICogdGJvZHkgaW1tZWRpYXRlbHkgYmVmb3JlIHRoZSBmaXJzdCA8dHI+LiBPdGhlciBicm93c2VycyBjcmVhdGUgaXQKICAgICAgICogYmVmb3JlIHRoZSBmaXJzdCBub2RlLCBubyBtYXR0ZXIgd2hhdC4KICAgICAgICoKICAgICAgICogVGhpcyBtZWFucyB0aGUgdGhlIGZvbGxvd2luZyBjb2RlOgogICAgICAgKgogICAgICAgKiAgICAgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAqICAgICBkaXYuaW5uZXJIVE1MID0gIjx0YWJsZT48c2NyaXB0IGlkPSdmaXJzdCc+PC9zY3JpcHQ+PHRyPjx0ZD5oaTwvdGQ+PC90cj48c2NyaXB0IGlkPSdsYXN0Jz48L3NjcmlwdD48L3RhYmxlPgogICAgICAgKgogICAgICAgKiBHZW5lcmF0ZXMgdGhlIGZvbGxvd2luZyBET00gaW4gSUU6CiAgICAgICAqCiAgICAgICAqICAgICArIGRpdgogICAgICAgKiAgICAgICArIHRhYmxlCiAgICAgICAqICAgICAgICAgLSBzY3JpcHQgaWQ9J2ZpcnN0JwogICAgICAgKiAgICAgICAgICsgdGJvZHkKICAgICAgICogICAgICAgICAgICsgdHIKICAgICAgICogICAgICAgICAgICAgKyB0ZAogICAgICAgKiAgICAgICAgICAgICAgIC0gImhpIgogICAgICAgKiAgICAgICAgICAgLSBzY3JpcHQgaWQ9J2xhc3QnCiAgICAgICAqCiAgICAgICAqIFdoaWNoIG1lYW5zIHRoYXQgdGhlIHR3byBzY3JpcHQgdGFncywgZXZlbiB0aG91Z2ggdGhleSB3ZXJlCiAgICAgICAqIGluc2VydGVkIGF0IHRoZSBzYW1lIHBvaW50IGluIHRoZSBoaWVyYXJjaHkgaW4gdGhlIG9yaWdpbmFsCiAgICAgICAqIEhUTUwsIG5vdyBoYXZlIGRpZmZlcmVudCBwYXJlbnRzLgogICAgICAgKgogICAgICAgKiBUaGlzIGNvZGUgcmVwYXJlbnRzIHRoZSBmaXJzdCBzY3JpcHQgdGFnIGJ5IG1ha2luZyBpdCB0aGUgdGJvZHkncwogICAgICAgKiBmaXJzdCBjaGlsZC4KICAgICAgICoKICAgICAgICovCiAgICAgIHZhciBmaXhQYXJlbnRhZ2UgPSBmdW5jdGlvbihzdGFydCwgZW5kKSB7CiAgICAgICAgaWYgKHN0YXJ0LnBhcmVudE5vZGUgIT09IGVuZC5wYXJlbnROb2RlKSB7CiAgICAgICAgICBlbmQucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoc3RhcnQsIGVuZC5wYXJlbnROb2RlLmZpcnN0Q2hpbGQpOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGh0bWxGdW5jID0gZnVuY3Rpb24oaHRtbCwgb3V0ZXJUb28pIHsKICAgICAgICAvLyBnZXQgdGhlIHJlYWwgc3RhcnRpbmcgbm9kZS4gc2VlIHJlYWxOb2RlIGZvciBkZXRhaWxzLgogICAgICAgIHZhciBzdGFydCA9IHJlYWxOb2RlKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuc3RhcnQpKTsKICAgICAgICB2YXIgZW5kID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGhpcy5lbmQpOwogICAgICAgIHZhciBwYXJlbnROb2RlID0gZW5kLnBhcmVudE5vZGU7CiAgICAgICAgdmFyIG5vZGUsIG5leHRTaWJsaW5nLCBsYXN0OwoKICAgICAgICAvLyBtYWtlIHN1cmUgdGhhdCB0aGUgc3RhcnQgYW5kIGVuZCBub2RlcyBzaGFyZSB0aGUgc2FtZQogICAgICAgIC8vIHBhcmVudC4gSWYgbm90LCBmaXggaXQuCiAgICAgICAgZml4UGFyZW50YWdlKHN0YXJ0LCBlbmQpOwoKICAgICAgICAvLyByZW1vdmUgYWxsIG9mIHRoZSBub2RlcyBhZnRlciB0aGUgc3RhcnRpbmcgcGxhY2Vob2xkZXIgYW5kCiAgICAgICAgLy8gYmVmb3JlIHRoZSBlbmRpbmcgcGxhY2Vob2xkZXIuCiAgICAgICAgbm9kZSA9IHN0YXJ0Lm5leHRTaWJsaW5nOwogICAgICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgICBuZXh0U2libGluZyA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICBsYXN0ID0gbm9kZSA9PT0gZW5kOwoKICAgICAgICAgIC8vIGlmIHRoaXMgaXMgdGhlIGxhc3Qgbm9kZSwgYW5kIHdlIHdhbnQgdG8gcmVtb3ZlIGl0IGFzIHdlbGwsCiAgICAgICAgICAvLyBzZXQgdGhlIGBlbmRgIG5vZGUgdG8gdGhlIG5leHQgc2libGluZy4gVGhpcyBpcyBiZWNhdXNlCiAgICAgICAgICAvLyBmb3IgdGhlIHJlc3Qgb2YgdGhlIGZ1bmN0aW9uLCB3ZSBpbnNlcnQgdGhlIG5ldyBub2RlcwogICAgICAgICAgLy8gYmVmb3JlIHRoZSBlbmQgKG5vdGUgdGhhdCBpbnNlcnRCZWZvcmUobm9kZSwgbnVsbCkgaXMKICAgICAgICAgIC8vIHRoZSBzYW1lIGFzIGFwcGVuZENoaWxkKG5vZGUpKS4KICAgICAgICAgIC8vCiAgICAgICAgICAvLyBpZiB3ZSBkbyBub3Qgd2FudCB0byByZW1vdmUgaXQsIGp1c3QgYnJlYWsuCiAgICAgICAgICBpZiAobGFzdCkgewogICAgICAgICAgICBpZiAob3V0ZXJUb28pIHsgZW5kID0gbm9kZS5uZXh0U2libGluZzsgfSBlbHNlIHsgYnJlYWs7IH0KICAgICAgICAgIH0KCiAgICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSk7CgogICAgICAgICAgLy8gaWYgdGhpcyBpcyB0aGUgbGFzdCBub2RlIGFuZCB3ZSBkaWRuJ3QgYnJlYWsgYmVmb3JlCiAgICAgICAgICAvLyAoYmVjYXVzZSB3ZSB3YW50ZWQgdG8gcmVtb3ZlIHRoZSBvdXRlciBub2RlcyksIGJyZWFrCiAgICAgICAgICAvLyBub3cuCiAgICAgICAgICBpZiAobGFzdCkgeyBicmVhazsgfQoKICAgICAgICAgIG5vZGUgPSBuZXh0U2libGluZzsKICAgICAgICB9CgogICAgICAgIC8vIGdldCB0aGUgZmlyc3Qgbm9kZSBmb3IgdGhlIEhUTUwgc3RyaW5nLCBldmVuIGluIGNhc2VzIGxpa2UKICAgICAgICAvLyB0YWJsZXMgYW5kIGxpc3RzIHdoZXJlIGEgc2ltcGxlIGlubmVySFRNTCBvbiBhIGRpdiB3b3VsZAogICAgICAgIC8vIHN3YWxsb3cgc29tZSBvZiB0aGUgY29udGVudC4KICAgICAgICBub2RlID0gZmlyc3ROb2RlRm9yKHN0YXJ0LnBhcmVudE5vZGUsIGh0bWwpOwoKICAgICAgICBpZiAob3V0ZXJUb28pIHsKICAgICAgICAgIHN0YXJ0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoc3RhcnQpOwogICAgICAgIH0KCiAgICAgICAgLy8gY29weSB0aGUgbm9kZXMgZm9yIHRoZSBIVE1MIGJldHdlZW4gdGhlIHN0YXJ0aW5nIGFuZCBlbmRpbmcKICAgICAgICAvLyBwbGFjZWhvbGRlci4KICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgbmV4dFNpYmxpbmcgPSBub2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgcGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZSwgZW5kKTsKICAgICAgICAgIG5vZGUgPSBuZXh0U2libGluZzsKICAgICAgICB9CiAgICAgIH07CgogICAgICAvLyByZW1vdmUgdGhlIG5vZGVzIGluIHRoZSBET00gcmVwcmVzZW50aW5nIHRoaXMgbWV0YW1vcnBoLgogICAgICAvLwogICAgICAvLyB0aGlzIGluY2x1ZGVzIHRoZSBzdGFydGluZyBhbmQgZW5kaW5nIHBsYWNlaG9sZGVycy4KICAgICAgcmVtb3ZlRnVuYyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzdGFydCA9IHJlYWxOb2RlKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuc3RhcnQpKTsKICAgICAgICB2YXIgZW5kID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGhpcy5lbmQpOwoKICAgICAgICB0aGlzLmh0bWwoJycpOwogICAgICAgIHN0YXJ0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoc3RhcnQpOwogICAgICAgIGVuZC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGVuZCk7CiAgICAgIH07CgogICAgICBhcHBlbmRUb0Z1bmMgPSBmdW5jdGlvbihwYXJlbnROb2RlKSB7CiAgICAgICAgdmFyIG5vZGUgPSBmaXJzdE5vZGVGb3IocGFyZW50Tm9kZSwgdGhpcy5vdXRlckhUTUwoKSk7CiAgICAgICAgdmFyIG5leHRTaWJsaW5nOwoKICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgbmV4dFNpYmxpbmcgPSBub2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgcGFyZW50Tm9kZS5hcHBlbmRDaGlsZChub2RlKTsKICAgICAgICAgIG5vZGUgPSBuZXh0U2libGluZzsKICAgICAgICB9CiAgICAgIH07CgogICAgICBhZnRlckZ1bmMgPSBmdW5jdGlvbihodG1sKSB7CiAgICAgICAgLy8gZ2V0IHRoZSByZWFsIHN0YXJ0aW5nIG5vZGUuIHNlZSByZWFsTm9kZSBmb3IgZGV0YWlscy4KICAgICAgICB2YXIgZW5kID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGhpcy5lbmQpOwogICAgICAgIHZhciBpbnNlcnRCZWZvcmUgPSBlbmQubmV4dFNpYmxpbmc7CiAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBlbmQucGFyZW50Tm9kZTsKICAgICAgICB2YXIgbmV4dFNpYmxpbmc7CiAgICAgICAgdmFyIG5vZGU7CgogICAgICAgIC8vIGdldCB0aGUgZmlyc3Qgbm9kZSBmb3IgdGhlIEhUTUwgc3RyaW5nLCBldmVuIGluIGNhc2VzIGxpa2UKICAgICAgICAvLyB0YWJsZXMgYW5kIGxpc3RzIHdoZXJlIGEgc2ltcGxlIGlubmVySFRNTCBvbiBhIGRpdiB3b3VsZAogICAgICAgIC8vIHN3YWxsb3cgc29tZSBvZiB0aGUgY29udGVudC4KICAgICAgICBub2RlID0gZmlyc3ROb2RlRm9yKHBhcmVudE5vZGUsIGh0bWwpOwoKICAgICAgICAvLyBjb3B5IHRoZSBub2RlcyBmb3IgdGhlIEhUTUwgYmV0d2VlbiB0aGUgc3RhcnRpbmcgYW5kIGVuZGluZwogICAgICAgIC8vIHBsYWNlaG9sZGVyLgogICAgICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgICBuZXh0U2libGluZyA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICBwYXJlbnROb2RlLmluc2VydEJlZm9yZShub2RlLCBpbnNlcnRCZWZvcmUpOwogICAgICAgICAgbm9kZSA9IG5leHRTaWJsaW5nOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHByZXBlbmRGdW5jID0gZnVuY3Rpb24oaHRtbCkgewogICAgICAgIHZhciBzdGFydCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuc3RhcnQpOwogICAgICAgIHZhciBwYXJlbnROb2RlID0gc3RhcnQucGFyZW50Tm9kZTsKICAgICAgICB2YXIgbmV4dFNpYmxpbmc7CiAgICAgICAgdmFyIG5vZGU7CgogICAgICAgIG5vZGUgPSBmaXJzdE5vZGVGb3IocGFyZW50Tm9kZSwgaHRtbCk7CiAgICAgICAgdmFyIGluc2VydEJlZm9yZSA9IHN0YXJ0Lm5leHRTaWJsaW5nOwoKICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgbmV4dFNpYmxpbmcgPSBub2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgcGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZSwgaW5zZXJ0QmVmb3JlKTsKICAgICAgICAgIG5vZGUgPSBuZXh0U2libGluZzsKICAgICAgICB9CiAgICAgIH07CiAgICB9CgogICAgTWV0YW1vcnBoLnByb3RvdHlwZS5odG1sID0gZnVuY3Rpb24oaHRtbCkgewogICAgICB0aGlzLmNoZWNrUmVtb3ZlZCgpOwogICAgICBpZiAoaHRtbCA9PT0gdW5kZWZpbmVkKSB7IHJldHVybiB0aGlzLmlubmVySFRNTDsgfQoKICAgICAgaHRtbEZ1bmMuY2FsbCh0aGlzLCBodG1sKTsKCiAgICAgIHRoaXMuaW5uZXJIVE1MID0gaHRtbDsKICAgIH07CgogICAgTWV0YW1vcnBoLnByb3RvdHlwZS5yZXBsYWNlV2l0aCA9IGZ1bmN0aW9uKGh0bWwpIHsKICAgICAgdGhpcy5jaGVja1JlbW92ZWQoKTsKICAgICAgaHRtbEZ1bmMuY2FsbCh0aGlzLCBodG1sLCB0cnVlKTsKICAgIH07CgogICAgTWV0YW1vcnBoLnByb3RvdHlwZS5yZW1vdmUgPSByZW1vdmVGdW5jOwogICAgTWV0YW1vcnBoLnByb3RvdHlwZS5vdXRlckhUTUwgPSBvdXRlckhUTUxGdW5jOwogICAgTWV0YW1vcnBoLnByb3RvdHlwZS5hcHBlbmRUbyA9IGFwcGVuZFRvRnVuYzsKICAgIE1ldGFtb3JwaC5wcm90b3R5cGUuYWZ0ZXIgPSBhZnRlckZ1bmM7CiAgICBNZXRhbW9ycGgucHJvdG90eXBlLnByZXBlbmQgPSBwcmVwZW5kRnVuYzsKICAgIE1ldGFtb3JwaC5wcm90b3R5cGUuc3RhcnRUYWcgPSBzdGFydFRhZ0Z1bmM7CiAgICBNZXRhbW9ycGgucHJvdG90eXBlLmVuZFRhZyA9IGVuZFRhZ0Z1bmM7CgogICAgTWV0YW1vcnBoLnByb3RvdHlwZS5pc1JlbW92ZWQgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGJlZm9yZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuc3RhcnQpOwogICAgICB2YXIgYWZ0ZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0aGlzLmVuZCk7CgogICAgICByZXR1cm4gIWJlZm9yZSB8fCAhYWZ0ZXI7CiAgICB9OwoKICAgIE1ldGFtb3JwaC5wcm90b3R5cGUuY2hlY2tSZW1vdmVkID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLmlzUmVtb3ZlZCgpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgcGVyZm9ybSBvcGVyYXRpb25zIG9uIGEgTWV0YW1vcnBoIHRoYXQgaXMgbm90IGluIHRoZSBET00uIik7CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIE1ldGFtb3JwaDsKICB9KTsKCn0pKCk7CgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItaGFuZGxlYmFycy1jb21waWxlcgoqLwoKLy8gRWxpbWluYXRlIGRlcGVuZGVuY3kgb24gYW55IEVtYmVyIHRvIHNpbXBsaWZ5IHByZWNvbXBpbGF0aW9uIHdvcmtmbG93CnZhciBvYmplY3RDcmVhdGUgPSBPYmplY3QuY3JlYXRlIHx8IGZ1bmN0aW9uKHBhcmVudCkgewogIGZ1bmN0aW9uIEYoKSB7fQogIEYucHJvdG90eXBlID0gcGFyZW50OwogIHJldHVybiBuZXcgRigpOwp9OwoKdmFyIEhhbmRsZWJhcnMgPSAoRW1iZXIuaW1wb3J0cyAmJiBFbWJlci5pbXBvcnRzLkhhbmRsZWJhcnMpIHx8ICh0aGlzICYmIHRoaXMuSGFuZGxlYmFycyk7CmlmICghSGFuZGxlYmFycyAmJiB0eXBlb2YgcmVxdWlyZSA9PT0gJ2Z1bmN0aW9uJykgewogIEhhbmRsZWJhcnMgPSByZXF1aXJlKCdoYW5kbGViYXJzJyk7Cn0KCkVtYmVyLmFzc2VydCgiRW1iZXIgSGFuZGxlYmFycyByZXF1aXJlcyBIYW5kbGViYXJzIHZlcnNpb24gMS4wIG9yIDEuMS4gSW5jbHVkZSAiICsKICAgICAgICAgICAgICJhIFNDUklQVCB0YWcgaW4gdGhlIEhUTUwgSEVBRCBsaW5raW5nIHRvIHRoZSBIYW5kbGViYXJzIGZpbGUgIiArCiAgICAgICAgICAgICAiYmVmb3JlIHlvdSBsaW5rIHRvIEVtYmVyLiIsIEhhbmRsZWJhcnMpOwoKRW1iZXIuYXNzZXJ0KCJFbWJlciBIYW5kbGViYXJzIHJlcXVpcmVzIEhhbmRsZWJhcnMgdmVyc2lvbiAxLjAgb3IgMS4xLCAiICsKICAgICAgICAgICAgICJDT01QSUxFUl9SRVZJU0lPTiBleHBlY3RlZDogNCwgZ290OiAiICsgIEhhbmRsZWJhcnMuQ09NUElMRVJfUkVWSVNJT04gKwogICAgICAgICAgICAgIiAtIFBsZWFzZSBub3RlOiBCdWlsZHMgb2YgbWFzdGVyIG1heSBoYXZlIG90aGVyIENPTVBJTEVSX1JFVklTSU9OIHZhbHVlcy4iLAogICAgICAgICAgICAgSGFuZGxlYmFycy5DT01QSUxFUl9SRVZJU0lPTiA9PT0gNCk7CgovKioKICBQcmVwYXJlcyB0aGUgSGFuZGxlYmFycyB0ZW1wbGF0aW5nIGxpYnJhcnkgZm9yIHVzZSBpbnNpZGUgRW1iZXIncyB2aWV3CiAgc3lzdGVtLgoKICBUaGUgYEVtYmVyLkhhbmRsZWJhcnNgIG9iamVjdCBpcyB0aGUgc3RhbmRhcmQgSGFuZGxlYmFycyBsaWJyYXJ5LCBleHRlbmRlZCB0bwogIHVzZSBFbWJlcidzIGBnZXQoKWAgbWV0aG9kIGluc3RlYWQgb2YgZGlyZWN0IHByb3BlcnR5IGFjY2Vzcywgd2hpY2ggYWxsb3dzCiAgY29tcHV0ZWQgcHJvcGVydGllcyB0byBiZSB1c2VkIGluc2lkZSB0ZW1wbGF0ZXMuCgogIFRvIGNyZWF0ZSBhbiBgRW1iZXIuSGFuZGxlYmFyc2AgdGVtcGxhdGUsIGNhbGwgYEVtYmVyLkhhbmRsZWJhcnMuY29tcGlsZSgpYC4KICBUaGlzIHdpbGwgcmV0dXJuIGEgZnVuY3Rpb24gdGhhdCBjYW4gYmUgdXNlZCBieSBgRW1iZXIuVmlld2AgZm9yIHJlbmRlcmluZy4KCiAgQGNsYXNzIEhhbmRsZWJhcnMKICBAbmFtZXNwYWNlIEVtYmVyCiovCkVtYmVyLkhhbmRsZWJhcnMgPSBvYmplY3RDcmVhdGUoSGFuZGxlYmFycyk7CgovKioKICBSZWdpc3RlciBhIGJvdW5kIGhlbHBlciBvciBjdXN0b20gdmlldyBoZWxwZXIuCgogICMjIFNpbXBsZSBib3VuZCBoZWxwZXIgZXhhbXBsZQoKICBgYGBqYXZhc2NyaXB0CiAgRW1iZXIuSGFuZGxlYmFycy5oZWxwZXIoJ2NhcGl0YWxpemUnLCBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlLnRvVXBwZXJDYXNlKCk7CiAgfSk7CiAgYGBgCgogIFRoZSBhYm92ZSBib3VuZCBoZWxwZXIgY2FuIGJlIHVzZWQgaW5zaWRlIG9mIHRlbXBsYXRlcyBhcyBmb2xsb3dzOgoKICBgYGBoYW5kbGViYXJzCiAge3tjYXBpdGFsaXplIG5hbWV9fQogIGBgYAoKICBJbiB0aGlzIGNhc2UsIHdoZW4gdGhlIGBuYW1lYCBwcm9wZXJ0eSBvZiB0aGUgdGVtcGxhdGUncyBjb250ZXh0IGNoYW5nZXMsCiAgdGhlIHJlbmRlcmVkIHZhbHVlIG9mIHRoZSBoZWxwZXIgd2lsbCB1cGRhdGUgdG8gcmVmbGVjdCB0aGlzIGNoYW5nZS4KCiAgRm9yIG1vcmUgZXhhbXBsZXMgb2YgYm91bmQgaGVscGVycywgc2VlIGRvY3VtZW50YXRpb24gZm9yCiAgYEVtYmVyLkhhbmRsZWJhcnMucmVnaXN0ZXJCb3VuZEhlbHBlcmAuCgogICMjIEN1c3RvbSB2aWV3IGhlbHBlciBleGFtcGxlCgogIEFzc3VtaW5nIGEgdmlldyBzdWJjbGFzcyBuYW1lZCBgQXBwLkNhbGVuZGFyVmlld2Agd2VyZSBkZWZpbmVkLCBhIGhlbHBlcgogIGZvciByZW5kZXJpbmcgaW5zdGFuY2VzIG9mIHRoaXMgdmlldyBjb3VsZCBiZSByZWdpc3RlcmVkIGFzIGZvbGxvd3M6CgogIGBgYGphdmFzY3JpcHQKICBFbWJlci5IYW5kbGViYXJzLmhlbHBlcignY2FsZW5kYXInLCBBcHAuQ2FsZW5kYXJWaWV3KToKICBgYGAKCiAgVGhlIGFib3ZlIGJvdW5kIGhlbHBlciBjYW4gYmUgdXNlZCBpbnNpZGUgb2YgdGVtcGxhdGVzIGFzIGZvbGxvd3M6CgogIGBgYGhhbmRsZWJhcnMKICB7e2NhbGVuZGFyfX0KICBgYGAKCiAgV2hpY2ggaXMgZnVuY3Rpb25hbGx5IGVxdWl2YWxlbnQgdG86CgogIGBgYGhhbmRsZWJhcnMKICB7e3ZpZXcgQXBwLkNhbGVuZGFyVmlld319CiAgYGBgCgogIE9wdGlvbnMgaW4gdGhlIGhlbHBlciB3aWxsIGJlIHBhc3NlZCB0byB0aGUgdmlldyBpbiBleGFjdGx5IHRoZSBzYW1lCiAgbWFubmVyIGFzIHdpdGggdGhlIGB2aWV3YCBoZWxwZXIuCgogIEBtZXRob2QgaGVscGVyCiAgQGZvciBFbWJlci5IYW5kbGViYXJzCiAgQHBhcmFtIHtTdHJpbmd9IG5hbWUKICBAcGFyYW0ge0Z1bmN0aW9ufEVtYmVyLlZpZXd9IGZ1bmN0aW9uIG9yIHZpZXcgY2xhc3MgY29uc3RydWN0b3IKICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5cyoKKi8KRW1iZXIuSGFuZGxlYmFycy5oZWxwZXIgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogIEVtYmVyLmFzc2VydCgiWW91IHRyaWVkIHRvIHJlZ2lzdGVyIGEgY29tcG9uZW50IG5hbWVkICciICsgbmFtZSArICInLCBidXQgY29tcG9uZW50IG5hbWVzIG11c3QgaW5jbHVkZSBhICctJyIsICFFbWJlci5Db21wb25lbnQuZGV0ZWN0KHZhbHVlKSB8fCBuYW1lLm1hdGNoKC8tLykpOwoKICBpZiAoRW1iZXIuVmlldy5kZXRlY3QodmFsdWUpKSB7CiAgICBFbWJlci5IYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKG5hbWUsIEVtYmVyLkhhbmRsZWJhcnMubWFrZVZpZXdIZWxwZXIodmFsdWUpKTsKICB9IGVsc2UgewogICAgRW1iZXIuSGFuZGxlYmFycy5yZWdpc3RlckJvdW5kSGVscGVyLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgfQp9OwoKLyoqCiAgUmV0dXJucyBhIGhlbHBlciBmdW5jdGlvbiB0aGF0IHJlbmRlcnMgdGhlIHByb3ZpZGVkIFZpZXdDbGFzcy4KCiAgVXNlZCBpbnRlcm5hbGx5IGJ5IEVtYmVyLkhhbmRsZWJhcnMuaGVscGVyIGFuZCBvdGhlciBtZXRob2RzCiAgaW52b2x2aW5nIGhlbHBlci9jb21wb25lbnQgcmVnaXN0cmF0aW9uLgoKICBAcHJpdmF0ZQogIEBtZXRob2QgaGVscGVyCiAgQGZvciBFbWJlci5IYW5kbGViYXJzCiAgQHBhcmFtIHtGdW5jdGlvbn0gVmlld0NsYXNzIHZpZXcgY2xhc3MgY29uc3RydWN0b3IKKi8KRW1iZXIuSGFuZGxlYmFycy5tYWtlVmlld0hlbHBlciA9IGZ1bmN0aW9uKFZpZXdDbGFzcykgewogIHJldHVybiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBFbWJlci5hc3NlcnQoIllvdSBjYW4gb25seSBwYXNzIGF0dHJpYnV0ZXMgKHN1Y2ggYXMgbmFtZT12YWx1ZSkgbm90IGJhcmUgdmFsdWVzIHRvIGEgaGVscGVyIGZvciBhIFZpZXcgZm91bmQgaW4gJyIgKyBWaWV3Q2xhc3MudG9TdHJpbmcoKSArICInIiwgYXJndW1lbnRzLmxlbmd0aCA8IDIpOwogICAgcmV0dXJuIEVtYmVyLkhhbmRsZWJhcnMuaGVscGVycy52aWV3LmNhbGwodGhpcywgVmlld0NsYXNzLCBvcHRpb25zKTsKICB9Owp9OwoKLyoqCkBjbGFzcyBoZWxwZXJzCkBuYW1lc3BhY2UgRW1iZXIuSGFuZGxlYmFycwoqLwpFbWJlci5IYW5kbGViYXJzLmhlbHBlcnMgPSBvYmplY3RDcmVhdGUoSGFuZGxlYmFycy5oZWxwZXJzKTsKCi8qKgogIE92ZXJyaWRlIHRoZSB0aGUgb3Bjb2RlIGNvbXBpbGVyIGFuZCBKYXZhU2NyaXB0IGNvbXBpbGVyIGZvciBIYW5kbGViYXJzLgoKICBAY2xhc3MgQ29tcGlsZXIKICBAbmFtZXNwYWNlIEVtYmVyLkhhbmRsZWJhcnMKICBAcHJpdmF0ZQogIEBjb25zdHJ1Y3RvcgoqLwpFbWJlci5IYW5kbGViYXJzLkNvbXBpbGVyID0gZnVuY3Rpb24oKSB7fTsKCi8vIEhhbmRsZWJhcnMuQ29tcGlsZXIgZG9lc24ndCBleGlzdCBpbiBydW50aW1lLW9ubHkKaWYgKEhhbmRsZWJhcnMuQ29tcGlsZXIpIHsKICBFbWJlci5IYW5kbGViYXJzLkNvbXBpbGVyLnByb3RvdHlwZSA9IG9iamVjdENyZWF0ZShIYW5kbGViYXJzLkNvbXBpbGVyLnByb3RvdHlwZSk7Cn0KCkVtYmVyLkhhbmRsZWJhcnMuQ29tcGlsZXIucHJvdG90eXBlLmNvbXBpbGVyID0gRW1iZXIuSGFuZGxlYmFycy5Db21waWxlcjsKCi8qKgogIEBjbGFzcyBKYXZhU2NyaXB0Q29tcGlsZXIKICBAbmFtZXNwYWNlIEVtYmVyLkhhbmRsZWJhcnMKICBAcHJpdmF0ZQogIEBjb25zdHJ1Y3RvcgoqLwpFbWJlci5IYW5kbGViYXJzLkphdmFTY3JpcHRDb21waWxlciA9IGZ1bmN0aW9uKCkge307CgovLyBIYW5kbGViYXJzLkphdmFTY3JpcHRDb21waWxlciBkb2Vzbid0IGV4aXN0IGluIHJ1bnRpbWUtb25seQppZiAoSGFuZGxlYmFycy5KYXZhU2NyaXB0Q29tcGlsZXIpIHsKICBFbWJlci5IYW5kbGViYXJzLkphdmFTY3JpcHRDb21waWxlci5wcm90b3R5cGUgPSBvYmplY3RDcmVhdGUoSGFuZGxlYmFycy5KYXZhU2NyaXB0Q29tcGlsZXIucHJvdG90eXBlKTsKICBFbWJlci5IYW5kbGViYXJzLkphdmFTY3JpcHRDb21waWxlci5wcm90b3R5cGUuY29tcGlsZXIgPSBFbWJlci5IYW5kbGViYXJzLkphdmFTY3JpcHRDb21waWxlcjsKfQoKCkVtYmVyLkhhbmRsZWJhcnMuSmF2YVNjcmlwdENvbXBpbGVyLnByb3RvdHlwZS5uYW1lc3BhY2UgPSAiRW1iZXIuSGFuZGxlYmFycyI7CgpFbWJlci5IYW5kbGViYXJzLkphdmFTY3JpcHRDb21waWxlci5wcm90b3R5cGUuaW5pdGlhbGl6ZUJ1ZmZlciA9IGZ1bmN0aW9uKCkgewogIHJldHVybiAiJyciOwp9OwoKLyoqCiAgT3ZlcnJpZGUgdGhlIGRlZmF1bHQgYnVmZmVyIGZvciBFbWJlciBIYW5kbGViYXJzLiBCeSBkZWZhdWx0LCBIYW5kbGViYXJzCiAgY3JlYXRlcyBhbiBlbXB0eSBTdHJpbmcgYXQgdGhlIGJlZ2lubmluZyBvZiBlYWNoIGludm9jYXRpb24gYW5kIGFwcGVuZHMgdG8KICBpdC4gRW1iZXIncyBIYW5kbGViYXJzIG92ZXJyaWRlcyB0aGlzIHRvIGFwcGVuZCB0byBhIHNpbmdsZSBzaGFyZWQgYnVmZmVyLgoKICBAcHJpdmF0ZQogIEBtZXRob2QgYXBwZW5kVG9CdWZmZXIKICBAcGFyYW0gc3RyaW5nIHtTdHJpbmd9CiovCkVtYmVyLkhhbmRsZWJhcnMuSmF2YVNjcmlwdENvbXBpbGVyLnByb3RvdHlwZS5hcHBlbmRUb0J1ZmZlciA9IGZ1bmN0aW9uKHN0cmluZykgewogIHJldHVybiAiZGF0YS5idWZmZXIucHVzaCgiK3N0cmluZysiKTsiOwp9OwoKLy8gSGFja3MgYWhlYWQ6Ci8vIEhhbmRsZWJhcnMgcHJlc2VudGx5IGhhcyBhIGJ1ZyB3aGVyZSB0aGUgYGJsb2NrSGVscGVyTWlzc2luZ2AgaG9vawovLyBkb2Vzbid0IGdldCBwYXNzZWQgdGhlIG5hbWUgb2YgdGhlIG1pc3NpbmcgaGVscGVyIG5hbWUsIGJ1dCByYXRoZXIKLy8gZ2V0cyBwYXNzZWQgdGhlIHZhbHVlIG9mIHRoYXQgbWlzc2luZyBoZWxwZXIgZXZhbHVhdGVkIG9uIHRoZSBjdXJyZW50Ci8vIGNvbnRleHQsIHdoaWNoIGlzIG1vc3QgbGlrZWx5IGB1bmRlZmluZWRgIGFuZCB0b3RhbGx5IHVzZWxlc3MuCi8vCi8vIFNvIHdlIGFsdGVyIHRoZSBjb21waWxlZCB0ZW1wbGF0ZSBmdW5jdGlvbiB0byBwYXNzIHRoZSBuYW1lIG9mIHRoZSBoZWxwZXIKLy8gaW5zdGVhZCwgYXMgZXhwZWN0ZWQuCi8vCi8vIFRoaXMgY2FuIGdvIGF3YXkgb25jZSB0aGUgZm9sbG93aW5nIGlzIGNsb3NlZDoKLy8gaHR0cHM6Ly9naXRodWIuY29tL3d5Y2F0cy9oYW5kbGViYXJzLmpzL2lzc3Vlcy82MzQKCnZhciBET1RfTE9PS1VQX1JFR0VYID0gL2hlbHBlcnNcLiguKj8pXCkvLAogICAgQlJBQ0tFVF9TVFJJTkdfTE9PS1VQX1JFR0VYID0gL2hlbHBlcnNcWycoLio/KScvLAogICAgSU5WT0NBVElPTl9TUExJVFRJTkdfUkVHRVggPSAvKC4qYmxvY2tIZWxwZXJNaXNzaW5nXC5jYWxsXCguKikoc3RhY2tbMC05XSspKCwuKikvOwoKRW1iZXIuSGFuZGxlYmFycy5KYXZhU2NyaXB0Q29tcGlsZXIuc3RyaW5naWZ5TGFzdEJsb2NrSGVscGVyTWlzc2luZ0ludm9jYXRpb24gPSBmdW5jdGlvbihzb3VyY2UpIHsKICB2YXIgaGVscGVySW52b2NhdGlvbiA9IHNvdXJjZVtzb3VyY2UubGVuZ3RoIC0gMV0sCiAgICAgIGhlbHBlck5hbWUgPSAoRE9UX0xPT0tVUF9SRUdFWC5leGVjKGhlbHBlckludm9jYXRpb24pIHx8IEJSQUNLRVRfU1RSSU5HX0xPT0tVUF9SRUdFWC5leGVjKGhlbHBlckludm9jYXRpb24pKVsxXSwKICAgICAgbWF0Y2hlcyA9IElOVk9DQVRJT05fU1BMSVRUSU5HX1JFR0VYLmV4ZWMoaGVscGVySW52b2NhdGlvbik7CgogIHNvdXJjZVtzb3VyY2UubGVuZ3RoIC0gMV0gPSBtYXRjaGVzWzFdICsgIiciICsgaGVscGVyTmFtZSArICInIiArIG1hdGNoZXNbM107Cn0KdmFyIHN0cmluZ2lmeUJsb2NrSGVscGVyTWlzc2luZyA9IEVtYmVyLkhhbmRsZWJhcnMuSmF2YVNjcmlwdENvbXBpbGVyLnN0cmluZ2lmeUxhc3RCbG9ja0hlbHBlck1pc3NpbmdJbnZvY2F0aW9uOwoKdmFyIG9yaWdpbmFsQmxvY2tWYWx1ZSA9IEVtYmVyLkhhbmRsZWJhcnMuSmF2YVNjcmlwdENvbXBpbGVyLnByb3RvdHlwZS5ibG9ja1ZhbHVlOwpFbWJlci5IYW5kbGViYXJzLkphdmFTY3JpcHRDb21waWxlci5wcm90b3R5cGUuYmxvY2tWYWx1ZSA9IGZ1bmN0aW9uKCkgewogIG9yaWdpbmFsQmxvY2tWYWx1ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIHN0cmluZ2lmeUJsb2NrSGVscGVyTWlzc2luZyh0aGlzLnNvdXJjZSk7Cn07Cgp2YXIgb3JpZ2luYWxBbWJpZ3VvdXNCbG9ja1ZhbHVlID0gRW1iZXIuSGFuZGxlYmFycy5KYXZhU2NyaXB0Q29tcGlsZXIucHJvdG90eXBlLmFtYmlndW91c0Jsb2NrVmFsdWU7CkVtYmVyLkhhbmRsZWJhcnMuSmF2YVNjcmlwdENvbXBpbGVyLnByb3RvdHlwZS5hbWJpZ3VvdXNCbG9ja1ZhbHVlID0gZnVuY3Rpb24oKSB7CiAgb3JpZ2luYWxBbWJpZ3VvdXNCbG9ja1ZhbHVlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgc3RyaW5naWZ5QmxvY2tIZWxwZXJNaXNzaW5nKHRoaXMuc291cmNlKTsKfTsKCnZhciBwcmVmaXggPSAiZW1iZXIiICsgKCtuZXcgRGF0ZSgpKSwgaW5jciA9IDE7CgovKioKICBSZXdyaXRlIHNpbXBsZSBtdXN0YWNoZXMgZnJvbSBge3tmb299fWAgdG8gYHt7YmluZCAiZm9vIn19YC4gVGhpcyBtZWFucyB0aGF0CiAgYWxsIHNpbXBsZSBtdXN0YWNoZXMgaW4gRW1iZXIncyBIYW5kbGViYXJzIHdpbGwgYWxzbyBzZXQgdXAgYW4gb2JzZXJ2ZXIgdG8KICBrZWVwIHRoZSBET00gdXAgdG8gZGF0ZSB3aGVuIHRoZSB1bmRlcmx5aW5nIHByb3BlcnR5IGNoYW5nZXMuCgogIEBwcml2YXRlCiAgQG1ldGhvZCBtdXN0YWNoZQogIEBmb3IgRW1iZXIuSGFuZGxlYmFycy5Db21waWxlcgogIEBwYXJhbSBtdXN0YWNoZQoqLwpFbWJlci5IYW5kbGViYXJzLkNvbXBpbGVyLnByb3RvdHlwZS5tdXN0YWNoZSA9IGZ1bmN0aW9uKG11c3RhY2hlKSB7CiAgaWYgKG11c3RhY2hlLmlzSGVscGVyICYmIG11c3RhY2hlLmlkLnN0cmluZyA9PT0gJ2NvbnRyb2wnKSB7CiAgICBtdXN0YWNoZS5oYXNoID0gbXVzdGFjaGUuaGFzaCB8fCBuZXcgSGFuZGxlYmFycy5BU1QuSGFzaE5vZGUoW10pOwogICAgbXVzdGFjaGUuaGFzaC5wYWlycy5wdXNoKFsiY29udHJvbElEIiwgbmV3IEhhbmRsZWJhcnMuQVNULlN0cmluZ05vZGUocHJlZml4ICsgaW5jcisrKV0pOwogIH0gZWxzZSBpZiAobXVzdGFjaGUucGFyYW1zLmxlbmd0aCB8fCBtdXN0YWNoZS5oYXNoKSB7CiAgICAvLyBubyBjaGFuZ2VzIHJlcXVpcmVkCiAgfSBlbHNlIHsKICAgIHZhciBpZCA9IG5ldyBIYW5kbGViYXJzLkFTVC5JZE5vZGUoW3sgcGFydDogJ190cmlhZ2VNdXN0YWNoZScgfV0pOwoKICAgIC8vIFVwZGF0ZSB0aGUgbXVzdGFjaGUgbm9kZSB0byBpbmNsdWRlIGEgaGFzaCB2YWx1ZSBpbmRpY2F0aW5nIHdoZXRoZXIgdGhlIG9yaWdpbmFsIG5vZGUKICAgIC8vIHdhcyBlc2NhcGVkLiBUaGlzIHdpbGwgYWxsb3cgdXMgdG8gcHJvcGVybHkgZXNjYXBlIHZhbHVlcyB3aGVuIHRoZSB1bmRlcmx5aW5nIHZhbHVlCiAgICAvLyBjaGFuZ2VzIGFuZCB3ZSBuZWVkIHRvIHJlLXJlbmRlciB0aGUgdmFsdWUuCiAgICBpZiAoIW11c3RhY2hlLmVzY2FwZWQpIHsKICAgICAgbXVzdGFjaGUuaGFzaCA9IG11c3RhY2hlLmhhc2ggfHwgbmV3IEhhbmRsZWJhcnMuQVNULkhhc2hOb2RlKFtdKTsKICAgICAgbXVzdGFjaGUuaGFzaC5wYWlycy5wdXNoKFsidW5lc2NhcGVkIiwgbmV3IEhhbmRsZWJhcnMuQVNULlN0cmluZ05vZGUoInRydWUiKV0pOwogICAgfQogICAgbXVzdGFjaGUgPSBuZXcgSGFuZGxlYmFycy5BU1QuTXVzdGFjaGVOb2RlKFtpZF0uY29uY2F0KFttdXN0YWNoZS5pZF0pLCBtdXN0YWNoZS5oYXNoLCAhbXVzdGFjaGUuZXNjYXBlZCk7CiAgfQoKICByZXR1cm4gSGFuZGxlYmFycy5Db21waWxlci5wcm90b3R5cGUubXVzdGFjaGUuY2FsbCh0aGlzLCBtdXN0YWNoZSk7Cn07CgovKioKICBVc2VkIGZvciBwcmVjb21waWxhdGlvbiBvZiBFbWJlciBIYW5kbGViYXJzIHRlbXBsYXRlcy4gVGhpcyB3aWxsIG5vdCBiZSB1c2VkCiAgZHVyaW5nIG5vcm1hbCBhcHAgZXhlY3V0aW9uLgoKICBAbWV0aG9kIHByZWNvbXBpbGUKICBAZm9yIEVtYmVyLkhhbmRsZWJhcnMKICBAc3RhdGljCiAgQHBhcmFtIHtTdHJpbmd9IHN0cmluZyBUaGUgdGVtcGxhdGUgdG8gcHJlY29tcGlsZQoqLwpFbWJlci5IYW5kbGViYXJzLnByZWNvbXBpbGUgPSBmdW5jdGlvbihzdHJpbmcpIHsKICB2YXIgYXN0ID0gSGFuZGxlYmFycy5wYXJzZShzdHJpbmcpOwoKICB2YXIgb3B0aW9ucyA9IHsKICAgIGtub3duSGVscGVyczogewogICAgICBhY3Rpb246IHRydWUsCiAgICAgIHVuYm91bmQ6IHRydWUsCiAgICAgICdiaW5kLWF0dHInOiB0cnVlLAogICAgICB0ZW1wbGF0ZTogdHJ1ZSwKICAgICAgdmlldzogdHJ1ZSwKICAgICAgX3RyaWFnZU11c3RhY2hlOiB0cnVlCiAgICB9LAogICAgZGF0YTogdHJ1ZSwKICAgIHN0cmluZ1BhcmFtczogdHJ1ZQogIH07CgogIHZhciBlbnZpcm9ubWVudCA9IG5ldyBFbWJlci5IYW5kbGViYXJzLkNvbXBpbGVyKCkuY29tcGlsZShhc3QsIG9wdGlvbnMpOwogIHJldHVybiBuZXcgRW1iZXIuSGFuZGxlYmFycy5KYXZhU2NyaXB0Q29tcGlsZXIoKS5jb21waWxlKGVudmlyb25tZW50LCBvcHRpb25zLCB1bmRlZmluZWQsIHRydWUpOwp9OwoKLy8gV2UgZG9uJ3Qgc3VwcG9ydCB0aGlzIGZvciBIYW5kbGViYXJzIHJ1bnRpbWUtb25seQppZiAoSGFuZGxlYmFycy5jb21waWxlKSB7CiAgLyoqCiAgICBUaGUgZW50cnkgcG9pbnQgZm9yIEVtYmVyIEhhbmRsZWJhcnMuIFRoaXMgcmVwbGFjZXMgdGhlIGRlZmF1bHQKICAgIGBIYW5kbGViYXJzLmNvbXBpbGVgIGFuZCB0dXJucyBvbiB0ZW1wbGF0ZS1sb2NhbCBkYXRhIGFuZCBTdHJpbmcKICAgIHBhcmFtZXRlcnMuCgogICAgQG1ldGhvZCBjb21waWxlCiAgICBAZm9yIEVtYmVyLkhhbmRsZWJhcnMKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBzdHJpbmcgVGhlIHRlbXBsYXRlIHRvIGNvbXBpbGUKICAgIEByZXR1cm4ge0Z1bmN0aW9ufQogICovCiAgRW1iZXIuSGFuZGxlYmFycy5jb21waWxlID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgICB2YXIgYXN0ID0gSGFuZGxlYmFycy5wYXJzZShzdHJpbmcpOwogICAgdmFyIG9wdGlvbnMgPSB7IGRhdGE6IHRydWUsIHN0cmluZ1BhcmFtczogdHJ1ZSB9OwogICAgdmFyIGVudmlyb25tZW50ID0gbmV3IEVtYmVyLkhhbmRsZWJhcnMuQ29tcGlsZXIoKS5jb21waWxlKGFzdCwgb3B0aW9ucyk7CiAgICB2YXIgdGVtcGxhdGVTcGVjID0gbmV3IEVtYmVyLkhhbmRsZWJhcnMuSmF2YVNjcmlwdENvbXBpbGVyKCkuY29tcGlsZShlbnZpcm9ubWVudCwgb3B0aW9ucywgdW5kZWZpbmVkLCB0cnVlKTsKCiAgICB2YXIgdGVtcGxhdGUgPSBFbWJlci5IYW5kbGViYXJzLnRlbXBsYXRlKHRlbXBsYXRlU3BlYyk7CiAgICB0ZW1wbGF0ZS5pc01ldGhvZCA9IGZhbHNlOyAvL01ha2Ugc3VyZSB3ZSBkb24ndCB3cmFwIHRlbXBsYXRlcyB3aXRoIC5fc3VwZXIKCiAgICByZXR1cm4gdGVtcGxhdGU7CiAgfTsKfQoKCn0pKCk7CgooZnVuY3Rpb24oKSB7CnZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwKICAgIG9yaWdpbmFsVGVtcGxhdGUgPSBFbWJlci5IYW5kbGViYXJzLnRlbXBsYXRlOwoKLyoqCiAgSWYgYSBwYXRoIHN0YXJ0cyB3aXRoIGEgcmVzZXJ2ZWQga2V5d29yZCwgcmV0dXJucyB0aGUgcm9vdAogIHRoYXQgc2hvdWxkIGJlIHVzZWQuCgogIEBwcml2YXRlCiAgQG1ldGhvZCBub3JtYWxpemVQYXRoCiAgQGZvciBFbWJlcgogIEBwYXJhbSByb290IHtPYmplY3R9CiAgQHBhcmFtIHBhdGgge1N0cmluZ30KICBAcGFyYW0gZGF0YSB7SGFzaH0KKi8KdmFyIG5vcm1hbGl6ZVBhdGggPSBFbWJlci5IYW5kbGViYXJzLm5vcm1hbGl6ZVBhdGggPSBmdW5jdGlvbihyb290LCBwYXRoLCBkYXRhKSB7CiAgdmFyIGtleXdvcmRzID0gKGRhdGEgJiYgZGF0YS5rZXl3b3JkcykgfHwge30sCiAgICAgIGtleXdvcmQsIGlzS2V5d29yZDsKCiAgLy8gR2V0IHRoZSBmaXJzdCBzZWdtZW50IG9mIHRoZSBwYXRoLiBGb3IgZXhhbXBsZSwgaWYgdGhlCiAgLy8gcGF0aCBpcyAiZm9vLmJhci5iYXoiLCByZXR1cm5zICJmb28iLgogIGtleXdvcmQgPSBwYXRoLnNwbGl0KCcuJywgMSlbMF07CgogIC8vIFRlc3QgdG8gc2VlIGlmIHRoZSBmaXJzdCBwYXRoIGlzIGEga2V5d29yZCB0aGF0IGhhcyBiZWVuCiAgLy8gcGFzc2VkIGFsb25nIGluIHRoZSB2aWV3J3MgZGF0YSBoYXNoLiBJZiBzbywgd2Ugd2lsbCB0cmVhdAogIC8vIHRoYXQgb2JqZWN0IGFzIHRoZSBuZXcgcm9vdC4KICBpZiAoa2V5d29yZHMuaGFzT3duUHJvcGVydHkoa2V5d29yZCkpIHsKICAgIC8vIExvb2sgdXAgdGhlIHZhbHVlIGluIHRoZSB0ZW1wbGF0ZSdzIGRhdGEgaGFzaC4KICAgIHJvb3QgPSBrZXl3b3Jkc1trZXl3b3JkXTsKICAgIGlzS2V5d29yZCA9IHRydWU7CgogICAgLy8gSGFuZGxlIGNhc2VzIHdoZXJlIHRoZSBlbnRpcmUgcGF0aCBpcyB0aGUgcmVzZXJ2ZWQKICAgIC8vIHdvcmQuIEluIHRoYXQgY2FzZSwgcmV0dXJuIHRoZSBvYmplY3QgaXRzZWxmLgogICAgaWYgKHBhdGggPT09IGtleXdvcmQpIHsKICAgICAgcGF0aCA9ICcnOwogICAgfSBlbHNlIHsKICAgICAgLy8gU3RyaXAgdGhlIGtleXdvcmQgZnJvbSB0aGUgcGF0aCBhbmQgbG9vayB1cAogICAgICAvLyB0aGUgcmVtYWluZGVyIGZyb20gdGhlIG5ld2x5IGZvdW5kIHJvb3QuCiAgICAgIHBhdGggPSBwYXRoLnN1YnN0cihrZXl3b3JkLmxlbmd0aCsxKTsKICAgIH0KICB9CgogIHJldHVybiB7IHJvb3Q6IHJvb3QsIHBhdGg6IHBhdGgsIGlzS2V5d29yZDogaXNLZXl3b3JkIH07Cn07CgoKLyoqCiAgTG9va3VwIGJvdGggb24gcm9vdCBhbmQgb24gd2luZG93LiBJZiB0aGUgcGF0aCBzdGFydHMgd2l0aAogIGEga2V5d29yZCwgdGhlIGNvcnJlc3BvbmRpbmcgb2JqZWN0IHdpbGwgYmUgbG9va2VkIHVwIGluIHRoZQogIHRlbXBsYXRlJ3MgZGF0YSBoYXNoIGFuZCB1c2VkIHRvIHJlc29sdmUgdGhlIHBhdGguCgogIEBtZXRob2QgZ2V0CiAgQGZvciBFbWJlci5IYW5kbGViYXJzCiAgQHBhcmFtIHtPYmplY3R9IHJvb3QgVGhlIG9iamVjdCB0byBsb29rIHVwIHRoZSBwcm9wZXJ0eSBvbgogIEBwYXJhbSB7U3RyaW5nfSBwYXRoIFRoZSBwYXRoIHRvIGJlIGxvb2tlZHVwCiAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgVGhlIHRlbXBsYXRlJ3Mgb3B0aW9uIGhhc2gKKi8KdmFyIGhhbmRsZWJhcnNHZXQgPSBFbWJlci5IYW5kbGViYXJzLmdldCA9IGZ1bmN0aW9uKHJvb3QsIHBhdGgsIG9wdGlvbnMpIHsKICB2YXIgZGF0YSA9IG9wdGlvbnMgJiYgb3B0aW9ucy5kYXRhLAogICAgICBub3JtYWxpemVkUGF0aCA9IG5vcm1hbGl6ZVBhdGgocm9vdCwgcGF0aCwgZGF0YSksCiAgICAgIHZhbHVlOwoKICAKICAgIHJvb3QgPSBub3JtYWxpemVkUGF0aC5yb290OwogICAgcGF0aCA9IG5vcm1hbGl6ZWRQYXRoLnBhdGg7CgogICAgdmFsdWUgPSBFbWJlci5nZXQocm9vdCwgcGF0aCk7CgogICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgJiYgcm9vdCAhPT0gRW1iZXIubG9va3VwICYmIEVtYmVyLmlzR2xvYmFsUGF0aChwYXRoKSkgewogICAgICB2YWx1ZSA9IEVtYmVyLmdldChFbWJlci5sb29rdXAsIHBhdGgpOwogICAgfQogIAoKICByZXR1cm4gdmFsdWU7Cn07CgpFbWJlci5IYW5kbGViYXJzLnJlc29sdmVQYXJhbXMgPSBmdW5jdGlvbihjb250ZXh0LCBwYXJhbXMsIG9wdGlvbnMpIHsKICB2YXIgcmVzb2x2ZWRQYXJhbXMgPSBbXSwgdHlwZXMgPSBvcHRpb25zLnR5cGVzLCBwYXJhbSwgdHlwZTsKCiAgZm9yICh2YXIgaT0wLCBsPXBhcmFtcy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICBwYXJhbSA9IHBhcmFtc1tpXTsKICAgIHR5cGUgPSB0eXBlc1tpXTsKCiAgICBpZiAodHlwZSA9PT0gJ0lEJykgewogICAgICByZXNvbHZlZFBhcmFtcy5wdXNoKGhhbmRsZWJhcnNHZXQoY29udGV4dCwgcGFyYW0sIG9wdGlvbnMpKTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc29sdmVkUGFyYW1zLnB1c2gocGFyYW0pOwogICAgfQogIH0KCiAgcmV0dXJuIHJlc29sdmVkUGFyYW1zOwp9OwoKRW1iZXIuSGFuZGxlYmFycy5yZXNvbHZlSGFzaCA9IGZ1bmN0aW9uKGNvbnRleHQsIGhhc2gsIG9wdGlvbnMpIHsKICB2YXIgcmVzb2x2ZWRIYXNoID0ge30sIHR5cGVzID0gb3B0aW9ucy5oYXNoVHlwZXMsIHR5cGU7CgogIGZvciAodmFyIGtleSBpbiBoYXNoKSB7CiAgICBpZiAoIWhhc2guaGFzT3duUHJvcGVydHkoa2V5KSkgeyBjb250aW51ZTsgfQoKICAgIHR5cGUgPSB0eXBlc1trZXldOwoKICAgIGlmICh0eXBlID09PSAnSUQnKSB7CiAgICAgIHJlc29sdmVkSGFzaFtrZXldID0gaGFuZGxlYmFyc0dldChjb250ZXh0LCBoYXNoW2tleV0sIG9wdGlvbnMpOwogICAgfSBlbHNlIHsKICAgICAgcmVzb2x2ZWRIYXNoW2tleV0gPSBoYXNoW2tleV07CiAgICB9CiAgfQoKICByZXR1cm4gcmVzb2x2ZWRIYXNoOwp9OwoKLyoqCiAgUmVnaXN0ZXJzIGEgaGVscGVyIGluIEhhbmRsZWJhcnMgdGhhdCB3aWxsIGJlIGNhbGxlZCBpZiBubyBwcm9wZXJ0eSB3aXRoIHRoZQogIGdpdmVuIG5hbWUgY2FuIGJlIGZvdW5kIG9uIHRoZSBjdXJyZW50IGNvbnRleHQgb2JqZWN0LCBhbmQgbm8gaGVscGVyIHdpdGgKICB0aGF0IG5hbWUgaXMgcmVnaXN0ZXJlZC4KCiAgVGhpcyB0aHJvd3MgYW4gZXhjZXB0aW9uIHdpdGggYSBtb3JlIGhlbHBmdWwgZXJyb3IgbWVzc2FnZSBzbyB0aGUgdXNlciBjYW4KICB0cmFjayBkb3duIHdoZXJlIHRoZSBwcm9ibGVtIGlzIGhhcHBlbmluZy4KCiAgQHByaXZhdGUKICBAbWV0aG9kIGhlbHBlck1pc3NpbmcKICBAZm9yIEVtYmVyLkhhbmRsZWJhcnMuaGVscGVycwogIEBwYXJhbSB7U3RyaW5nfSBwYXRoCiAgQHBhcmFtIHtIYXNofSBvcHRpb25zCiovCkVtYmVyLkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2hlbHBlck1pc3NpbmcnLCBmdW5jdGlvbihwYXRoKSB7CiAgdmFyIGVycm9yLCB2aWV3ID0gIiI7CgogIHZhciBvcHRpb25zID0gYXJndW1lbnRzW2FyZ3VtZW50cy5sZW5ndGggLSAxXTsKCiAgdmFyIGhlbHBlciA9IEVtYmVyLkhhbmRsZWJhcnMucmVzb2x2ZUhlbHBlcihvcHRpb25zLmRhdGEudmlldy5jb250YWluZXIsIHBhdGgpOwoKICBpZiAoaGVscGVyKSB7CiAgICByZXR1cm4gaGVscGVyLmFwcGx5KHRoaXMsIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgfQoKICBlcnJvciA9ICIlQCBIYW5kbGViYXJzIGVycm9yOiBDb3VsZCBub3QgZmluZCBwcm9wZXJ0eSAnJUAnIG9uIG9iamVjdCAlQC4iOwogIGlmIChvcHRpb25zLmRhdGEpIHsKICAgIHZpZXcgPSBvcHRpb25zLmRhdGEudmlldzsKICB9CiAgdGhyb3cgbmV3IEVtYmVyLkVycm9yKEVtYmVyLlN0cmluZy5mbXQoZXJyb3IsIFt2aWV3LCBwYXRoLCB0aGlzXSkpOwp9KTsKCi8qKgogIFJlZ2lzdGVycyBhIGhlbHBlciBpbiBIYW5kbGViYXJzIHRoYXQgd2lsbCBiZSBjYWxsZWQgaWYgbm8gcHJvcGVydHkgd2l0aCB0aGUKICBnaXZlbiBuYW1lIGNhbiBiZSBmb3VuZCBvbiB0aGUgY3VycmVudCBjb250ZXh0IG9iamVjdCwgYW5kIG5vIGhlbHBlciB3aXRoCiAgdGhhdCBuYW1lIGlzIHJlZ2lzdGVyZWQuCgogIFRoaXMgdGhyb3dzIGFuIGV4Y2VwdGlvbiB3aXRoIGEgbW9yZSBoZWxwZnVsIGVycm9yIG1lc3NhZ2Ugc28gdGhlIHVzZXIgY2FuCiAgdHJhY2sgZG93biB3aGVyZSB0aGUgcHJvYmxlbSBpcyBoYXBwZW5pbmcuCgogIEBwcml2YXRlCiAgQG1ldGhvZCBoZWxwZXJNaXNzaW5nCiAgQGZvciBFbWJlci5IYW5kbGViYXJzLmhlbHBlcnMKICBAcGFyYW0ge1N0cmluZ30gcGF0aAogIEBwYXJhbSB7SGFzaH0gb3B0aW9ucwoqLwpFbWJlci5IYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdibG9ja0hlbHBlck1pc3NpbmcnLCBmdW5jdGlvbihwYXRoKSB7CgogIHZhciBvcHRpb25zID0gYXJndW1lbnRzW2FyZ3VtZW50cy5sZW5ndGggLSAxXTsKCiAgRW1iZXIuYXNzZXJ0KCJgYmxvY2tIZWxwZXJNaXNzaW5nYCB3YXMgaW52b2tlZCB3aXRob3V0IGEgaGVscGVyIG5hbWUsIHdoaWNoICIgKwogICAgICAgICAgICAgICAiaXMgbW9zdCBsaWtlbHkgZHVlIHRvIGEgbWlzbWF0Y2ggYmV0d2VlbiB0aGUgdmVyc2lvbiBvZiAiICsKICAgICAgICAgICAgICAgIkVtYmVyLmpzIHlvdSdyZSBydW5uaW5nIG5vdyBhbmQgdGhlIG9uZSB1c2VkIHRvIHByZWNvbXBpbGUgeW91ciAiICsKICAgICAgICAgICAgICAgInRlbXBsYXRlcy4gUGxlYXNlIG1ha2Ugc3VyZSB0aGUgdmVyc2lvbiBvZiAiICsKICAgICAgICAgICAgICAgImBlbWJlci1oYW5kbGViYXJzLWNvbXBpbGVyYCB5b3UncmUgdXNpbmcgaXMgdXAgdG8gZGF0ZS4iLCBwYXRoKTsKCiAgdmFyIGhlbHBlciA9IEVtYmVyLkhhbmRsZWJhcnMucmVzb2x2ZUhlbHBlcihvcHRpb25zLmRhdGEudmlldy5jb250YWluZXIsIHBhdGgpOwoKICBpZiAoaGVscGVyKSB7CiAgICByZXR1cm4gaGVscGVyLmFwcGx5KHRoaXMsIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgfSBlbHNlIHsKICAgIHJldHVybiBIYW5kbGViYXJzLmhlbHBlcnMuaGVscGVyTWlzc2luZy5jYWxsKHRoaXMsIHBhdGgpOwogIH0KCiAgcmV0dXJuIEhhbmRsZWJhcnMuaGVscGVycy5ibG9ja0hlbHBlck1pc3NpbmcuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfSk7CgovKioKICBSZWdpc3RlciBhIGJvdW5kIGhhbmRsZWJhcnMgaGVscGVyLiBCb3VuZCBoZWxwZXJzIGJlaGF2ZSBzaW1pbGFybHkgdG8gcmVndWxhcgogIGhhbmRsZWJhcnMgaGVscGVycywgd2l0aCB0aGUgYWRkZWQgYWJpbGl0eSB0byByZS1yZW5kZXIgd2hlbiB0aGUgdW5kZXJseWluZyBkYXRhCiAgY2hhbmdlcy4KCiAgIyMgU2ltcGxlIGV4YW1wbGUKCiAgYGBgamF2YXNjcmlwdAogIEVtYmVyLkhhbmRsZWJhcnMucmVnaXN0ZXJCb3VuZEhlbHBlcignY2FwaXRhbGl6ZScsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUudG9VcHBlckNhc2UoKTsKICB9KTsKICBgYGAKCiAgVGhlIGFib3ZlIGJvdW5kIGhlbHBlciBjYW4gYmUgdXNlZCBpbnNpZGUgb2YgdGVtcGxhdGVzIGFzIGZvbGxvd3M6CgogIGBgYGhhbmRsZWJhcnMKICB7e2NhcGl0YWxpemUgbmFtZX19CiAgYGBgCgogIEluIHRoaXMgY2FzZSwgd2hlbiB0aGUgYG5hbWVgIHByb3BlcnR5IG9mIHRoZSB0ZW1wbGF0ZSdzIGNvbnRleHQgY2hhbmdlcywKICB0aGUgcmVuZGVyZWQgdmFsdWUgb2YgdGhlIGhlbHBlciB3aWxsIHVwZGF0ZSB0byByZWZsZWN0IHRoaXMgY2hhbmdlLgoKICAjIyBFeGFtcGxlIHdpdGggb3B0aW9ucwoKICBMaWtlIG5vcm1hbCBoYW5kbGViYXJzIGhlbHBlcnMsIGJvdW5kIGhlbHBlcnMgaGF2ZSBhY2Nlc3MgdG8gdGhlIG9wdGlvbnMKICBwYXNzZWQgaW50byB0aGUgaGVscGVyIGNhbGwuCgogIGBgYGphdmFzY3JpcHQKICBFbWJlci5IYW5kbGViYXJzLnJlZ2lzdGVyQm91bmRIZWxwZXIoJ3JlcGVhdCcsIGZ1bmN0aW9uKHZhbHVlLCBvcHRpb25zKSB7CiAgICB2YXIgY291bnQgPSBvcHRpb25zLmhhc2guY291bnQ7CiAgICB2YXIgYSA9IFtdOwogICAgd2hpbGUoYS5sZW5ndGggPCBjb3VudCkgewogICAgICAgIGEucHVzaCh2YWx1ZSk7CiAgICB9CiAgICByZXR1cm4gYS5qb2luKCcnKTsKICB9KTsKICBgYGAKCiAgVGhpcyBoZWxwZXIgY291bGQgYmUgdXNlZCBpbiBhIHRlbXBsYXRlIGFzIGZvbGxvd3M6CgogIGBgYGhhbmRsZWJhcnMKICB7e3JlcGVhdCB0ZXh0IGNvdW50PTN9fQogIGBgYAoKICAjIyBFeGFtcGxlIHdpdGggYm91bmQgb3B0aW9ucwoKICBCb3VuZCBoYXNoIG9wdGlvbnMgYXJlIGFsc28gc3VwcG9ydGVkLiBFeGFtcGxlOgoKICBgYGBoYW5kbGViYXJzCiAge3tyZXBlYXQgdGV4dCBjb3VudEJpbmRpbmc9Im51bVJlcGVhdHMifX0KICBgYGAKCiAgSW4gdGhpcyBleGFtcGxlLCBjb3VudCB3aWxsIGJlIGJvdW5kIHRvIHRoZSB2YWx1ZSBvZgogIHRoZSBgbnVtUmVwZWF0c2AgcHJvcGVydHkgb24gdGhlIGNvbnRleHQuIElmIHRoYXQgcHJvcGVydHkKICBjaGFuZ2VzLCB0aGUgaGVscGVyIHdpbGwgYmUgcmUtcmVuZGVyZWQuCgogICMjIEV4YW1wbGUgd2l0aCBleHRyYSBkZXBlbmRlbmNpZXMKCiAgVGhlIGBFbWJlci5IYW5kbGViYXJzLnJlZ2lzdGVyQm91bmRIZWxwZXJgIG1ldGhvZCB0YWtlcyBhIHZhcmlhYmxlIGxlbmd0aAogIHRoaXJkIHBhcmFtZXRlciB3aGljaCBpbmRpY2F0ZXMgZXh0cmEgZGVwZW5kZW5jaWVzIG9uIHRoZSBwYXNzZWQgaW4gdmFsdWUuCiAgVGhpcyBhbGxvd3MgdGhlIGhhbmRsZWJhcnMgaGVscGVyIHRvIHVwZGF0ZSB3aGVuIHRoZXNlIGRlcGVuZGVuY2llcyBjaGFuZ2UuCgogIGBgYGphdmFzY3JpcHQKICBFbWJlci5IYW5kbGViYXJzLnJlZ2lzdGVyQm91bmRIZWxwZXIoJ2NhcGl0YWxpemVOYW1lJywgZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZS5nZXQoJ25hbWUnKS50b1VwcGVyQ2FzZSgpOwogIH0sICduYW1lJyk7CiAgYGBgCgogICMjIEV4YW1wbGUgd2l0aCBtdWx0aXBsZSBib3VuZCBwcm9wZXJ0aWVzCgogIGBFbWJlci5IYW5kbGViYXJzLnJlZ2lzdGVyQm91bmRIZWxwZXJgIHN1cHBvcnRzIGJpbmRpbmcgdG8KICBtdWx0aXBsZSBwcm9wZXJ0aWVzLCBlLmcuOgoKICBgYGBqYXZhc2NyaXB0CiAgRW1iZXIuSGFuZGxlYmFycy5yZWdpc3RlckJvdW5kSGVscGVyKCdjb25jYXRlbmF0ZScsIGZ1bmN0aW9uKCkgewogICAgdmFyIHZhbHVlcyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCwgLTEpOwogICAgcmV0dXJuIHZhbHVlcy5qb2luKCd8fCcpOwogIH0pOwogIGBgYAoKICBXaGljaCBhbGxvd3MgZm9yIHRlbXBsYXRlIHN5bnRheCBzdWNoIGFzIGB7e2NvbmNhdGVuYXRlIHByb3AxIHByb3AyfX1gIG9yCiAgYHt7Y29uY2F0ZW5hdGUgcHJvcDEgcHJvcDIgcHJvcDN9fWAuIElmIGFueSBvZiB0aGUgcHJvcGVydGllcyBjaGFuZ2UsCiAgdGhlIGhlbHByIHdpbGwgcmUtcmVuZGVyLiAgTm90ZSB0aGF0IGRlcGVuZGVuY3kga2V5cyBjYW5ub3QgYmUKICB1c2luZyBpbiBjb25qdW5jdGlvbiB3aXRoIG11bHRpLXByb3BlcnR5IGhlbHBlcnMsIHNpbmNlIGl0IGlzIGFtYmlndW91cwogIHdoaWNoIHByb3BlcnR5IHRoZSBkZXBlbmRlbnQga2V5cyB3b3VsZCBiZWxvbmcgdG8uCgogICMjIFVzZSB3aXRoIHVuYm91bmQgaGVscGVyCgogIFRoZSBge3t1bmJvdW5kfX1gIGhlbHBlciBjYW4gYmUgdXNlZCB3aXRoIGJvdW5kIGhlbHBlciBpbnZvY2F0aW9ucwogIHRvIHJlbmRlciB0aGVtIGluIHRoZWlyIHVuYm91bmQgZm9ybSwgZS5nLgoKICBgYGBoYW5kbGViYXJzCiAge3t1bmJvdW5kIGNhcGl0YWxpemUgbmFtZX19CiAgYGBgCgogIEluIHRoaXMgZXhhbXBsZSwgaWYgdGhlIG5hbWUgcHJvcGVydHkgY2hhbmdlcywgdGhlIGhlbHBlcgogIHdpbGwgbm90IHJlLXJlbmRlci4KCiAgIyMgVXNlIHdpdGggYmxvY2tzIG5vdCBzdXBwb3J0ZWQKCiAgQm91bmQgaGVscGVycyBkbyBub3Qgc3VwcG9ydCB1c2Ugd2l0aCBIYW5kbGViYXJzIGJsb2NrcyBvcgogIHRoZSBhZGRpdGlvbiBvZiBjaGlsZCB2aWV3cyBvZiBhbnkga2luZC4KCiAgQG1ldGhvZCByZWdpc3RlckJvdW5kSGVscGVyCiAgQGZvciBFbWJlci5IYW5kbGViYXJzCiAgQHBhcmFtIHtTdHJpbmd9IG5hbWUKICBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jdGlvbgogIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXlzKgoqLwpFbWJlci5IYW5kbGViYXJzLnJlZ2lzdGVyQm91bmRIZWxwZXIgPSBmdW5jdGlvbihuYW1lLCBmbikgewogIHZhciBib3VuZEhlbHBlckFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksCiAgICAgIGJvdW5kRm4gPSBFbWJlci5IYW5kbGViYXJzLm1ha2VCb3VuZEhlbHBlci5hcHBseSh0aGlzLCBib3VuZEhlbHBlckFyZ3MpOwogIEVtYmVyLkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIobmFtZSwgYm91bmRGbik7Cn07CgovKioKICBBIChtb3N0bHkpIHByaXZhdGUgaGVscGVyIGZ1bmN0aW9uIHRvIGByZWdpc3RlckJvdW5kSGVscGVyYC4gVGFrZXMgdGhlCiAgcHJvdmlkZWQgSGFuZGxlYmFycyBoZWxwZXIgZnVuY3Rpb24gZm4gYW5kIHJldHVybnMgaXQgaW4gd3JhcHBlZAogIGJvdW5kIGhlbHBlciBmb3JtLgoKICBUaGUgbWFpbiB1c2UgY2FzZSBmb3IgdXNpbmcgdGhpcyBvdXRzaWRlIG9mIGByZWdpc3RlckJvdW5kSGVscGVyYAogIGlzIGZvciByZWdpc3RlcmluZyBoZWxwZXJzIG9uIHRoZSBjb250YWluZXI6CgogIGBgYGpzCiAgdmFyIGJvdW5kSGVscGVyRm4gPSBFbWJlci5IYW5kbGViYXJzLm1ha2VCb3VuZEhlbHBlcihmdW5jdGlvbih3b3JkKSB7CiAgICByZXR1cm4gd29yZC50b1VwcGVyQ2FzZSgpOwogIH0pOwoKICBjb250YWluZXIucmVnaXN0ZXIoJ2hlbHBlcjpteS1ib3VuZC1oZWxwZXInLCBib3VuZEhlbHBlckZuKTsKICBgYGAKCiAgSW4gdGhlIGFib3ZlIGV4YW1wbGUsIGlmIHRoZSBoZWxwZXIgZnVuY3Rpb24gaGFkbid0IGJlZW4gd3JhcHBlZCBpbgogIGBtYWtlQm91bmRIZWxwZXJgLCB0aGUgcmVnaXN0ZXJlZCBoZWxwZXIgd291bGQgYmUgdW5ib3VuZC4KCiAgQHByaXZhdGUKICBAbWV0aG9kIG1ha2VCb3VuZEhlbHBlcgogIEBmb3IgRW1iZXIuSGFuZGxlYmFycwogIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmN0aW9uCiAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleXMqCiovCkVtYmVyLkhhbmRsZWJhcnMubWFrZUJvdW5kSGVscGVyID0gZnVuY3Rpb24oZm4pIHsKICB2YXIgZGVwZW5kZW50S2V5cyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCiAgZnVuY3Rpb24gaGVscGVyKCkgewogICAgdmFyIHByb3BlcnRpZXMgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMCwgLTEpLAogICAgICBudW1Qcm9wZXJ0aWVzID0gcHJvcGVydGllcy5sZW5ndGgsCiAgICAgIG9wdGlvbnMgPSBhcmd1bWVudHNbYXJndW1lbnRzLmxlbmd0aCAtIDFdLAogICAgICBub3JtYWxpemVkUHJvcGVydGllcyA9IFtdLAogICAgICBkYXRhID0gb3B0aW9ucy5kYXRhLAogICAgICB0eXBlcyA9IGRhdGEuaXNVbmJvdW5kID8gc2xpY2UuY2FsbChvcHRpb25zLnR5cGVzLCAxKSA6IG9wdGlvbnMudHlwZXMsCiAgICAgIGhhc2ggPSBvcHRpb25zLmhhc2gsCiAgICAgIHZpZXcgPSBkYXRhLnZpZXcsCiAgICAgIGNvbnRleHRzID0gb3B0aW9ucy5jb250ZXh0cywKICAgICAgY3VycmVudENvbnRleHQgPSAoY29udGV4dHMgJiYgY29udGV4dHMubGVuZ3RoKSA/IGNvbnRleHRzWzBdIDogdGhpcywKICAgICAgcHJlZml4UGF0aEZvckRlcGVuZGVudEtleXMgPSAnJywKICAgICAgbG9jLCBsZW4sIGhhc2hPcHRpb24sCiAgICAgIGJvdW5kT3B0aW9uLCBwcm9wZXJ0eSwKICAgICAgbm9ybWFsaXplZFZhbHVlID0gRW1iZXIuX1NpbXBsZUhhbmRsZWJhcnNWaWV3LnByb3RvdHlwZS5ub3JtYWxpemVkVmFsdWU7CgogICAgRW1iZXIuYXNzZXJ0KCJyZWdpc3RlckJvdW5kSGVscGVyLWdlbmVyYXRlZCBoZWxwZXJzIGRvIG5vdCBzdXBwb3J0IHVzZSB3aXRoIEhhbmRsZWJhcnMgYmxvY2tzLiIsICFvcHRpb25zLmZuKTsKCiAgICAvLyBEZXRlY3QgYm91bmQgb3B0aW9ucyAoZS5nLiBjb3VudEJpbmRpbmc9Im90aGVyQ291bnQiKQogICAgdmFyIGJvdW5kT3B0aW9ucyA9IGhhc2guYm91bmRPcHRpb25zID0ge307CiAgICBmb3IgKGhhc2hPcHRpb24gaW4gaGFzaCkgewogICAgICBpZiAoRW1iZXIuSVNfQklORElORy50ZXN0KGhhc2hPcHRpb24pKSB7CiAgICAgICAgLy8gTG9wIG9mZiAnQmluZGluZycgc3VmZml4LgogICAgICAgIGJvdW5kT3B0aW9uc1toYXNoT3B0aW9uLnNsaWNlKDAsIC03KV0gPSBoYXNoW2hhc2hPcHRpb25dOwogICAgICB9CiAgICB9CgogICAgLy8gRXhwb3NlIHByb3BlcnR5IG5hbWVzIG9uIGRhdGEucHJvcGVydGllcyBvYmplY3QuCiAgICB2YXIgd2F0Y2hlZFByb3BlcnRpZXMgPSBbXTsKICAgIGRhdGEucHJvcGVydGllcyA9IFtdOwogICAgZm9yIChsb2MgPSAwOyBsb2MgPCBudW1Qcm9wZXJ0aWVzOyArK2xvYykgewogICAgICBkYXRhLnByb3BlcnRpZXMucHVzaChwcm9wZXJ0aWVzW2xvY10pOwogICAgICBpZiAodHlwZXNbbG9jXSA9PT0gJ0lEJykgewogICAgICAgIHZhciBub3JtYWxpemVkUHJvcCA9IG5vcm1hbGl6ZVBhdGgoY3VycmVudENvbnRleHQsIHByb3BlcnRpZXNbbG9jXSwgZGF0YSk7CiAgICAgICAgbm9ybWFsaXplZFByb3BlcnRpZXMucHVzaChub3JtYWxpemVkUHJvcCk7CiAgICAgICAgd2F0Y2hlZFByb3BlcnRpZXMucHVzaChub3JtYWxpemVkUHJvcCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYoZGF0YS5pc1VuYm91bmQpIHsKICAgICAgICAgIG5vcm1hbGl6ZWRQcm9wZXJ0aWVzLnB1c2goe3BhdGg6IHByb3BlcnRpZXNbbG9jXX0pOwogICAgICAgIH1lbHNlIHsKICAgICAgICAgIG5vcm1hbGl6ZWRQcm9wZXJ0aWVzLnB1c2gobnVsbCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLy8gSGFuZGxlIGNhc2Ugd2hlbiBoZWxwZXIgaW52b2NhdGlvbiBpcyBwcmVjZWRlZCBieSBgdW5ib3VuZGAsIGUuZy4KICAgIC8vIHt7dW5ib3VuZCBteUhlbHBlciBmb299fQogICAgaWYgKGRhdGEuaXNVbmJvdW5kKSB7CiAgICAgIHJldHVybiBldmFsdWF0ZVVuYm91bmRIZWxwZXIodGhpcywgZm4sIG5vcm1hbGl6ZWRQcm9wZXJ0aWVzLCBvcHRpb25zKTsKICAgIH0KCiAgICB2YXIgYmluZFZpZXcgPSBuZXcgRW1iZXIuX1NpbXBsZUhhbmRsZWJhcnNWaWV3KG51bGwsIG51bGwsICFvcHRpb25zLmhhc2gudW5lc2NhcGVkLCBvcHRpb25zLmRhdGEpOwoKICAgIC8vIE92ZXJyaWRlIFNpbXBsZUhhbmRsZWJhcnNWaWV3J3MgbWV0aG9kIGZvciBnZW5lcmF0aW5nIHRoZSB2aWV3J3MgY29udGVudC4KICAgIGJpbmRWaWV3Lm5vcm1hbGl6ZWRWYWx1ZSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXJncyA9IFtdLCBib3VuZE9wdGlvbjsKCiAgICAgIC8vIENvcHkgb3ZlciBib3VuZCBoYXNoIG9wdGlvbnMuCiAgICAgIGZvciAoYm91bmRPcHRpb24gaW4gYm91bmRPcHRpb25zKSB7CiAgICAgICAgaWYgKCFib3VuZE9wdGlvbnMuaGFzT3duUHJvcGVydHkoYm91bmRPcHRpb24pKSB7IGNvbnRpbnVlOyB9CiAgICAgICAgcHJvcGVydHkgPSBub3JtYWxpemVQYXRoKGN1cnJlbnRDb250ZXh0LCBib3VuZE9wdGlvbnNbYm91bmRPcHRpb25dLCBkYXRhKTsKICAgICAgICBiaW5kVmlldy5wYXRoID0gcHJvcGVydHkucGF0aDsKICAgICAgICBiaW5kVmlldy5wYXRoUm9vdCA9IHByb3BlcnR5LnJvb3Q7CiAgICAgICAgaGFzaFtib3VuZE9wdGlvbl0gPSBub3JtYWxpemVkVmFsdWUuY2FsbChiaW5kVmlldyk7CiAgICAgIH0KCiAgICAgIGZvciAobG9jID0gMDsgbG9jIDwgbnVtUHJvcGVydGllczsgKytsb2MpIHsKICAgICAgICBwcm9wZXJ0eSA9IG5vcm1hbGl6ZWRQcm9wZXJ0aWVzW2xvY107CiAgICAgICAgaWYgKHByb3BlcnR5KSB7CiAgICAgICAgICBiaW5kVmlldy5wYXRoID0gcHJvcGVydHkucGF0aDsKICAgICAgICAgIGJpbmRWaWV3LnBhdGhSb290ID0gcHJvcGVydHkucm9vdDsKICAgICAgICAgIGFyZ3MucHVzaChub3JtYWxpemVkVmFsdWUuY2FsbChiaW5kVmlldykpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhcmdzLnB1c2gocHJvcGVydGllc1tsb2NdKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgYXJncy5wdXNoKG9wdGlvbnMpOwoKICAgICAgLy8gUnVuIHRoZSBzdXBwbGllZCBoZWxwZXIgZnVuY3Rpb24uCiAgICAgIHJldHVybiBmbi5hcHBseShjdXJyZW50Q29udGV4dCwgYXJncyk7CiAgICB9OwoKICAgIHZpZXcuYXBwZW5kQ2hpbGQoYmluZFZpZXcpOwoKICAgIC8vIEFzc2VtYmxlIGxpc3Qgb2Ygd2F0Y2hlZCBwcm9wZXJ0aWVzIHRoYXQnbGwgcmUtcmVuZGVyIHRoaXMgaGVscGVyLgogICAgZm9yIChib3VuZE9wdGlvbiBpbiBib3VuZE9wdGlvbnMpIHsKICAgICAgaWYgKGJvdW5kT3B0aW9ucy5oYXNPd25Qcm9wZXJ0eShib3VuZE9wdGlvbikpIHsKICAgICAgICB3YXRjaGVkUHJvcGVydGllcy5wdXNoKG5vcm1hbGl6ZVBhdGgoY3VycmVudENvbnRleHQsIGJvdW5kT3B0aW9uc1tib3VuZE9wdGlvbl0sIGRhdGEpKTsKICAgICAgfQogICAgfQoKICAgIC8vIE9ic2VydmUgZWFjaCBwcm9wZXJ0eS4KICAgIGZvciAobG9jID0gMCwgbGVuID0gd2F0Y2hlZFByb3BlcnRpZXMubGVuZ3RoOyBsb2MgPCBsZW47ICsrbG9jKSB7CiAgICAgIHByb3BlcnR5ID0gd2F0Y2hlZFByb3BlcnRpZXNbbG9jXTsKICAgICAgdmlldy5yZWdpc3Rlck9ic2VydmVyKHByb3BlcnR5LnJvb3QsIHByb3BlcnR5LnBhdGgsIGJpbmRWaWV3LCBiaW5kVmlldy5yZXJlbmRlcik7CiAgICB9CgogICAgaWYgKHR5cGVzWzBdICE9PSAnSUQnIHx8IG5vcm1hbGl6ZWRQcm9wZXJ0aWVzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gQWRkIGRlcGVuZGVudCBrZXkgb2JzZXJ2ZXJzIHRvIHRoZSBmaXJzdCBwYXJhbQogICAgdmFyIG5vcm1hbGl6ZWQgPSBub3JtYWxpemVkUHJvcGVydGllc1swXSwKICAgICAgICBwYXRoUm9vdCA9IG5vcm1hbGl6ZWQucm9vdCwKICAgICAgICBwYXRoID0gbm9ybWFsaXplZC5wYXRoOwoKICAgIGlmKCFFbWJlci5pc0VtcHR5KHBhdGgpKSB7CiAgICAgIHByZWZpeFBhdGhGb3JEZXBlbmRlbnRLZXlzID0gcGF0aCArICcuJzsKICAgIH0KICAgIGZvciAodmFyIGk9MCwgbD1kZXBlbmRlbnRLZXlzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgdmlldy5yZWdpc3Rlck9ic2VydmVyKHBhdGhSb290LCBwcmVmaXhQYXRoRm9yRGVwZW5kZW50S2V5cyArIGRlcGVuZGVudEtleXNbaV0sIGJpbmRWaWV3LCBiaW5kVmlldy5yZXJlbmRlcik7CiAgICB9CiAgfQoKICBoZWxwZXIuX3Jhd0Z1bmN0aW9uID0gZm47CiAgcmV0dXJuIGhlbHBlcjsKfTsKCi8qKgogIFJlbmRlcnMgdGhlIHVuYm91bmQgZm9ybSBvZiBhbiBvdGhlcndpc2UgYm91bmQgaGVscGVyIGZ1bmN0aW9uLgoKICBAcHJpdmF0ZQogIEBtZXRob2QgZXZhbHVhdGVVbmJvdW5kSGVscGVyCiAgQHBhcmFtIHtGdW5jdGlvbn0gZm4KICBAcGFyYW0ge09iamVjdH0gY29udGV4dAogIEBwYXJhbSB7QXJyYXl9IG5vcm1hbGl6ZWRQcm9wZXJ0aWVzCiAgQHBhcmFtIHtTdHJpbmd9IG9wdGlvbnMKKi8KZnVuY3Rpb24gZXZhbHVhdGVVbmJvdW5kSGVscGVyKGNvbnRleHQsIGZuLCBub3JtYWxpemVkUHJvcGVydGllcywgb3B0aW9ucykgewogIHZhciBhcmdzID0gW10sCiAgIGhhc2ggPSBvcHRpb25zLmhhc2gsCiAgIGJvdW5kT3B0aW9ucyA9IGhhc2guYm91bmRPcHRpb25zLAogICB0eXBlcyA9IHNsaWNlLmNhbGwob3B0aW9ucy50eXBlcywgMSksCiAgIGxvYywKICAgbGVuLAogICBwcm9wZXJ0eSwKICAgcHJvcGVydHlUeXBlLAogICBib3VuZE9wdGlvbjsKCiAgZm9yIChib3VuZE9wdGlvbiBpbiBib3VuZE9wdGlvbnMpIHsKICAgIGlmICghYm91bmRPcHRpb25zLmhhc093blByb3BlcnR5KGJvdW5kT3B0aW9uKSkgeyBjb250aW51ZTsgfQogICAgaGFzaFtib3VuZE9wdGlvbl0gPSBFbWJlci5IYW5kbGViYXJzLmdldChjb250ZXh0LCBib3VuZE9wdGlvbnNbYm91bmRPcHRpb25dLCBvcHRpb25zKTsKICB9CgogIGZvcihsb2MgPSAwLCBsZW4gPSBub3JtYWxpemVkUHJvcGVydGllcy5sZW5ndGg7IGxvYyA8IGxlbjsgKytsb2MpIHsKICAgIHByb3BlcnR5ID0gbm9ybWFsaXplZFByb3BlcnRpZXNbbG9jXTsKICAgIHByb3BlcnR5VHlwZSA9IHR5cGVzW2xvY107CiAgICBpZihwcm9wZXJ0eVR5cGUgPT09ICJJRCIpIHsKICAgICAgYXJncy5wdXNoKEVtYmVyLkhhbmRsZWJhcnMuZ2V0KHByb3BlcnR5LnJvb3QsIHByb3BlcnR5LnBhdGgsIG9wdGlvbnMpKTsKICAgIH0gZWxzZSB7CiAgICAgIGFyZ3MucHVzaChwcm9wZXJ0eS5wYXRoKTsKICAgIH0KICB9CiAgYXJncy5wdXNoKG9wdGlvbnMpOwogIHJldHVybiBmbi5hcHBseShjb250ZXh0LCBhcmdzKTsKfQoKLyoqCiAgT3ZlcnJpZGVzIEhhbmRsZWJhcnMudGVtcGxhdGUgc28gdGhhdCB3ZSBjYW4gZGlzdGluZ3Vpc2gKICB1c2VyLWNyZWF0ZWQsIHRvcC1sZXZlbCB0ZW1wbGF0ZXMgZnJvbSBpbm5lciBjb250ZXh0cy4KCiAgQHByaXZhdGUKICBAbWV0aG9kIHRlbXBsYXRlCiAgQGZvciBFbWJlci5IYW5kbGViYXJzCiAgQHBhcmFtIHtTdHJpbmd9IHNwZWMKKi8KRW1iZXIuSGFuZGxlYmFycy50ZW1wbGF0ZSA9IGZ1bmN0aW9uKHNwZWMpIHsKICB2YXIgdCA9IG9yaWdpbmFsVGVtcGxhdGUoc3BlYyk7CiAgdC5pc1RvcCA9IHRydWU7CiAgcmV0dXJuIHQ7Cn07Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgogIE1hcmsgYSBzdHJpbmcgYXMgc2FmZSBmb3IgdW5lc2NhcGVkIG91dHB1dCB3aXRoIEhhbmRsZWJhcnMuIElmIHlvdQogIHJldHVybiBIVE1MIGZyb20gYSBIYW5kbGViYXJzIGhlbHBlciwgdXNlIHRoaXMgZnVuY3Rpb24gdG8KICBlbnN1cmUgSGFuZGxlYmFycyBkb2VzIG5vdCBlc2NhcGUgdGhlIEhUTUwuCgogIGBgYGphdmFzY3JpcHQKICBFbWJlci5TdHJpbmcuaHRtbFNhZmUoJzxkaXY+c29tZVN0cmluZzwvZGl2PicpCiAgYGBgCgogIEBtZXRob2QgaHRtbFNhZmUKICBAZm9yIEVtYmVyLlN0cmluZwogIEBzdGF0aWMKICBAcmV0dXJuIHtIYW5kbGViYXJzLlNhZmVTdHJpbmd9IGEgc3RyaW5nIHRoYXQgd2lsbCBub3QgYmUgaHRtbCBlc2NhcGVkIGJ5IEhhbmRsZWJhcnMKKi8KRW1iZXIuU3RyaW5nLmh0bWxTYWZlID0gZnVuY3Rpb24oc3RyKSB7CiAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcoc3RyKTsKfTsKCnZhciBodG1sU2FmZSA9IEVtYmVyLlN0cmluZy5odG1sU2FmZTsKCmlmIChFbWJlci5FWFRFTkRfUFJPVE9UWVBFUyA9PT0gdHJ1ZSB8fCBFbWJlci5FWFRFTkRfUFJPVE9UWVBFUy5TdHJpbmcpIHsKCiAgLyoqCiAgICBNYXJrIGEgc3RyaW5nIGFzIGJlaW5nIHNhZmUgZm9yIHVuZXNjYXBlZCBvdXRwdXQgd2l0aCBIYW5kbGViYXJzLgoKICAgIGBgYGphdmFzY3JpcHQKICAgICc8ZGl2PnNvbWVTdHJpbmc8L2Rpdj4nLmh0bWxTYWZlKCkKICAgIGBgYAoKICAgIFNlZSBbRW1iZXIuU3RyaW5nLmh0bWxTYWZlXSgvYXBpL2NsYXNzZXMvRW1iZXIuU3RyaW5nLmh0bWwjbWV0aG9kX2h0bWxTYWZlKS4KCiAgICBAbWV0aG9kIGh0bWxTYWZlCiAgICBAZm9yIFN0cmluZwogICAgQHJldHVybiB7SGFuZGxlYmFycy5TYWZlU3RyaW5nfSBhIHN0cmluZyB0aGF0IHdpbGwgbm90IGJlIGh0bWwgZXNjYXBlZCBieSBIYW5kbGViYXJzCiAgKi8KICBTdHJpbmcucHJvdG90eXBlLmh0bWxTYWZlID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gaHRtbFNhZmUodGhpcyk7CiAgfTsKfQoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewpFbWJlci5IYW5kbGViYXJzLnJlc29sdmVQYXRocyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB2YXIgcmV0ID0gW10sCiAgICAgIGNvbnRleHRzID0gb3B0aW9ucy5jb250ZXh0cywKICAgICAgcm9vdHMgPSBvcHRpb25zLnJvb3RzLAogICAgICBkYXRhID0gb3B0aW9ucy5kYXRhOwoKICBmb3IgKHZhciBpPTAsIGw9Y29udGV4dHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgcmV0LnB1c2goIEVtYmVyLkhhbmRsZWJhcnMuZ2V0KHJvb3RzW2ldLCBjb250ZXh0c1tpXSwgeyBkYXRhOiBkYXRhIH0pICk7CiAgfQoKICByZXR1cm4gcmV0Owp9OwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKmpzaGludCBuZXdjYXA6ZmFsc2UqLwovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLWhhbmRsZWJhcnMKKi8KCnZhciBzZXQgPSBFbWJlci5zZXQsIGdldCA9IEVtYmVyLmdldDsKdmFyIE1ldGFtb3JwaCA9IHJlcXVpcmVNb2R1bGUoJ21ldGFtb3JwaCcpOwoKZnVuY3Rpb24gbm90aWZ5TXV0YXRpb25MaXN0ZW5lcnMoKSB7CiAgRW1iZXIucnVuLm9uY2UoRW1iZXIuVmlldywgJ25vdGlmeU11dGF0aW9uTGlzdGVuZXJzJyk7Cn0KCi8vIERPTU1hbmFnZXIgc2hvdWxkIGp1c3QgYWJzdHJhY3QgZG9tIG1hbmlwdWxhdGlvbiBiZXR3ZWVuIGpxdWVyeSBhbmQgbWV0YW1vcnBoCnZhciBET01NYW5hZ2VyID0gewogIHJlbW92ZTogZnVuY3Rpb24odmlldykgewogICAgdmlldy5tb3JwaC5yZW1vdmUoKTsKICAgIG5vdGlmeU11dGF0aW9uTGlzdGVuZXJzKCk7CiAgfSwKCiAgcHJlcGVuZDogZnVuY3Rpb24odmlldywgaHRtbCkgewogICAgdmlldy5tb3JwaC5wcmVwZW5kKGh0bWwpOwogICAgbm90aWZ5TXV0YXRpb25MaXN0ZW5lcnMoKTsKICB9LAoKICBhZnRlcjogZnVuY3Rpb24odmlldywgaHRtbCkgewogICAgdmlldy5tb3JwaC5hZnRlcihodG1sKTsKICAgIG5vdGlmeU11dGF0aW9uTGlzdGVuZXJzKCk7CiAgfSwKCiAgaHRtbDogZnVuY3Rpb24odmlldywgaHRtbCkgewogICAgdmlldy5tb3JwaC5odG1sKGh0bWwpOwogICAgbm90aWZ5TXV0YXRpb25MaXN0ZW5lcnMoKTsKICB9LAoKICAvLyBUaGlzIGlzIG1lc3NlZCB1cC4KICByZXBsYWNlOiBmdW5jdGlvbih2aWV3KSB7CiAgICB2YXIgbW9ycGggPSB2aWV3Lm1vcnBoOwoKICAgIHZpZXcudHJhbnNpdGlvblRvKCdwcmVSZW5kZXInKTsKCiAgICBFbWJlci5ydW4uc2NoZWR1bGUoJ3JlbmRlcicsIHRoaXMsIGZ1bmN0aW9uIHJlbmRlck1ldGFtb3JwaFZpZXcoKSB7CiAgICAgIGlmICh2aWV3LmlzRGVzdHJveWluZykgeyByZXR1cm47IH0KCiAgICAgIHZpZXcuY2xlYXJSZW5kZXJlZENoaWxkcmVuKCk7CiAgICAgIHZhciBidWZmZXIgPSB2aWV3LnJlbmRlclRvQnVmZmVyKCk7CgogICAgICB2aWV3Lmludm9rZVJlY3Vyc2l2ZWx5KGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgICB2aWV3LnByb3BlcnR5V2lsbENoYW5nZSgnZWxlbWVudCcpOwogICAgICB9KTsKICAgICAgdmlldy50cmlnZ2VyUmVjdXJzaXZlbHkoJ3dpbGxJbnNlcnRFbGVtZW50Jyk7CgogICAgICBtb3JwaC5yZXBsYWNlV2l0aChidWZmZXIuc3RyaW5nKCkpOwogICAgICB2aWV3LnRyYW5zaXRpb25UbygnaW5ET00nKTsKCiAgICAgIHZpZXcuaW52b2tlUmVjdXJzaXZlbHkoZnVuY3Rpb24odmlldykgewogICAgICAgIHZpZXcucHJvcGVydHlEaWRDaGFuZ2UoJ2VsZW1lbnQnKTsKICAgICAgfSk7CiAgICAgIHZpZXcudHJpZ2dlclJlY3Vyc2l2ZWx5KCdkaWRJbnNlcnRFbGVtZW50Jyk7CgogICAgICBub3RpZnlNdXRhdGlvbkxpc3RlbmVycygpOwogICAgfSk7CiAgfSwKCiAgZW1wdHk6IGZ1bmN0aW9uKHZpZXcpIHsKICAgIHZpZXcubW9ycGguaHRtbCgiIik7CiAgICBub3RpZnlNdXRhdGlvbkxpc3RlbmVycygpOwogIH0KfTsKCi8vIFRoZSBgbW9ycGhgIGFuZCBgb3V0ZXJIVE1MYCBwcm9wZXJ0aWVzIGFyZSBpbnRlcm5hbCBvbmx5Ci8vIGFuZCBub3Qgb2JzZXJ2YWJsZS4KCi8qKgogIEBjbGFzcyBfTWV0YW1vcnBoCiAgQG5hbWVzcGFjZSBFbWJlcgogIEBwcml2YXRlCiovCkVtYmVyLl9NZXRhbW9ycGggPSBFbWJlci5NaXhpbi5jcmVhdGUoewogIGlzVmlydHVhbDogdHJ1ZSwKICB0YWdOYW1lOiAnJywKCiAgaW5zdHJ1bWVudE5hbWU6ICdtZXRhbW9ycGgnLAoKICBpbml0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3N1cGVyKCk7CiAgICB0aGlzLm1vcnBoID0gTWV0YW1vcnBoKCk7CiAgICBFbWJlci5kZXByZWNhdGUoJ1N1cHBseWluZyBhIHRhZ05hbWUgdG8gTWV0YW1vcnBoIHZpZXdzIGlzIHVucmVsaWFibGUgYW5kIGlzIGRlcHJlY2F0ZWQuIFlvdSBtYXkgYmUgc2V0dGluZyB0aGUgdGFnTmFtZSBvbiBhIEhhbmRsZWJhcnMgaGVscGVyIHRoYXQgY3JlYXRlcyBhIE1ldGFtb3JwaC4nLCAhdGhpcy50YWdOYW1lKTsKICB9LAoKICBiZWZvcmVSZW5kZXI6IGZ1bmN0aW9uKGJ1ZmZlcikgewogICAgYnVmZmVyLnB1c2godGhpcy5tb3JwaC5zdGFydFRhZygpKTsKICAgIGJ1ZmZlci5wdXNoT3BlbmluZ1RhZygpOwogIH0sCgogIGFmdGVyUmVuZGVyOiBmdW5jdGlvbihidWZmZXIpIHsKICAgIGJ1ZmZlci5wdXNoQ2xvc2luZ1RhZygpOwogICAgYnVmZmVyLnB1c2godGhpcy5tb3JwaC5lbmRUYWcoKSk7CiAgfSwKCiAgY3JlYXRlRWxlbWVudDogZnVuY3Rpb24oKSB7CiAgICB2YXIgYnVmZmVyID0gdGhpcy5yZW5kZXJUb0J1ZmZlcigpOwogICAgdGhpcy5vdXRlckhUTUwgPSBidWZmZXIuc3RyaW5nKCk7CiAgICB0aGlzLmNsZWFyQnVmZmVyKCk7CiAgfSwKCiAgZG9tTWFuYWdlcjogRE9NTWFuYWdlcgp9KTsKCi8qKgogIEBjbGFzcyBfTWV0YW1vcnBoVmlldwogIEBuYW1lc3BhY2UgRW1iZXIKICBAZXh0ZW5kcyBFbWJlci5WaWV3CiAgQHVzZXMgRW1iZXIuX01ldGFtb3JwaAogIEBwcml2YXRlCiovCkVtYmVyLl9NZXRhbW9ycGhWaWV3ID0gRW1iZXIuVmlldy5leHRlbmQoRW1iZXIuX01ldGFtb3JwaCk7CgovKioKICBAY2xhc3MgX1NpbXBsZU1ldGFtb3JwaFZpZXcKICBAbmFtZXNwYWNlIEVtYmVyCiAgQGV4dGVuZHMgRW1iZXIuQ29yZVZpZXcKICBAdXNlcyBFbWJlci5fTWV0YW1vcnBoCiAgQHByaXZhdGUKKi8KRW1iZXIuX1NpbXBsZU1ldGFtb3JwaFZpZXcgPSBFbWJlci5Db3JlVmlldy5leHRlbmQoRW1iZXIuX01ldGFtb3JwaCk7CgoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKmdsb2JhbHMgSGFuZGxlYmFycyAqLwovKmpzaGludCBuZXdjYXA6ZmFsc2UqLwovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLWhhbmRsZWJhcnMKKi8KCnZhciBnZXQgPSBFbWJlci5nZXQsIHNldCA9IEVtYmVyLnNldCwgaGFuZGxlYmFyc0dldCA9IEVtYmVyLkhhbmRsZWJhcnMuZ2V0Owp2YXIgTWV0YW1vcnBoID0gcmVxdWlyZU1vZHVsZSgnbWV0YW1vcnBoJyk7CmZ1bmN0aW9uIFNpbXBsZUhhbmRsZWJhcnNWaWV3KHBhdGgsIHBhdGhSb290LCBpc0VzY2FwZWQsIHRlbXBsYXRlRGF0YSkgewogIHRoaXMucGF0aCA9IHBhdGg7CiAgdGhpcy5wYXRoUm9vdCA9IHBhdGhSb290OwogIHRoaXMuaXNFc2NhcGVkID0gaXNFc2NhcGVkOwogIHRoaXMudGVtcGxhdGVEYXRhID0gdGVtcGxhdGVEYXRhOwoKICB0aGlzLm1vcnBoID0gTWV0YW1vcnBoKCk7CiAgdGhpcy5zdGF0ZSA9ICdwcmVSZW5kZXInOwogIHRoaXMudXBkYXRlSWQgPSBudWxsOwogIHRoaXMuX3BhcmVudFZpZXcgPSBudWxsOwogIHRoaXMuYnVmZmVyID0gbnVsbDsKfQoKRW1iZXIuX1NpbXBsZUhhbmRsZWJhcnNWaWV3ID0gU2ltcGxlSGFuZGxlYmFyc1ZpZXc7CgpTaW1wbGVIYW5kbGViYXJzVmlldy5wcm90b3R5cGUgPSB7CiAgaXNWaXJ0dWFsOiB0cnVlLAogIGlzVmlldzogdHJ1ZSwKCiAgZGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgaWYgKHRoaXMudXBkYXRlSWQpIHsKICAgICAgRW1iZXIucnVuLmNhbmNlbCh0aGlzLnVwZGF0ZUlkKTsKICAgICAgdGhpcy51cGRhdGVJZCA9IG51bGw7CiAgICB9CiAgICBpZiAodGhpcy5fcGFyZW50VmlldykgewogICAgICB0aGlzLl9wYXJlbnRWaWV3LnJlbW92ZUNoaWxkKHRoaXMpOwogICAgfQogICAgdGhpcy5tb3JwaCA9IG51bGw7CiAgICB0aGlzLnN0YXRlID0gJ2Rlc3Ryb3llZCc7CiAgfSwKCiAgcHJvcGVydHlXaWxsQ2hhbmdlOiBFbWJlci5LLAoKICBwcm9wZXJ0eURpZENoYW5nZTogRW1iZXIuSywKCiAgbm9ybWFsaXplZFZhbHVlOiBmdW5jdGlvbigpIHsKICAgIHZhciBwYXRoID0gdGhpcy5wYXRoLAogICAgICAgIHBhdGhSb290ID0gdGhpcy5wYXRoUm9vdCwKICAgICAgICByZXN1bHQsIHRlbXBsYXRlRGF0YTsKCiAgICAvLyBVc2UgdGhlIHBhdGhSb290IGFzIHRoZSByZXN1bHQgaWYgbm8gcGF0aCBpcyBwcm92aWRlZC4gVGhpcwogICAgLy8gaGFwcGVucyBpZiB0aGUgcGF0aCBpcyBgdGhpc2AsIHdoaWNoIGdldHMgbm9ybWFsaXplZCBpbnRvCiAgICAvLyBhIGBwYXRoUm9vdGAgb2YgdGhlIGN1cnJlbnQgSGFuZGxlYmFycyBjb250ZXh0IGFuZCBhIHBhdGgKICAgIC8vIG9mIGAnJ2AuCiAgICBpZiAocGF0aCA9PT0gJycpIHsKICAgICAgcmVzdWx0ID0gcGF0aFJvb3Q7CiAgICB9IGVsc2UgewogICAgICB0ZW1wbGF0ZURhdGEgPSB0aGlzLnRlbXBsYXRlRGF0YTsKICAgICAgcmVzdWx0ID0gaGFuZGxlYmFyc0dldChwYXRoUm9vdCwgcGF0aCwgeyBkYXRhOiB0ZW1wbGF0ZURhdGEgfSk7CiAgICB9CgogICAgcmV0dXJuIHJlc3VsdDsKICB9LAoKICByZW5kZXJUb0J1ZmZlcjogZnVuY3Rpb24oYnVmZmVyKSB7CiAgICB2YXIgc3RyaW5nID0gJyc7CgogICAgc3RyaW5nICs9IHRoaXMubW9ycGguc3RhcnRUYWcoKTsKICAgIHN0cmluZyArPSB0aGlzLnJlbmRlcigpOwogICAgc3RyaW5nICs9IHRoaXMubW9ycGguZW5kVGFnKCk7CgogICAgYnVmZmVyLnB1c2goc3RyaW5nKTsKICB9LAoKICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgLy8gSWYgbm90IGludm9rZWQgdmlhIGEgdHJpcGxlLW11c3RhY2hlICh7e3tmb299fX0pLCBlc2NhcGUKICAgIC8vIHRoZSBjb250ZW50IG9mIHRoZSB0ZW1wbGF0ZS4KICAgIHZhciBlc2NhcGUgPSB0aGlzLmlzRXNjYXBlZDsKICAgIHZhciByZXN1bHQgPSB0aGlzLm5vcm1hbGl6ZWRWYWx1ZSgpOwoKICAgIGlmIChyZXN1bHQgPT09IG51bGwgfHwgcmVzdWx0ID09PSB1bmRlZmluZWQpIHsKICAgICAgcmVzdWx0ID0gIiI7CiAgICB9IGVsc2UgaWYgKCEocmVzdWx0IGluc3RhbmNlb2YgSGFuZGxlYmFycy5TYWZlU3RyaW5nKSkgewogICAgICByZXN1bHQgPSBTdHJpbmcocmVzdWx0KTsKICAgIH0KCiAgICBpZiAoZXNjYXBlKSB7IHJlc3VsdCA9IEhhbmRsZWJhcnMuVXRpbHMuZXNjYXBlRXhwcmVzc2lvbihyZXN1bHQpOyB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0sCgogIHJlcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgIHN3aXRjaCh0aGlzLnN0YXRlKSB7CiAgICAgIGNhc2UgJ3ByZVJlbmRlcic6CiAgICAgIGNhc2UgJ2Rlc3Ryb3llZCc6CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ2luQnVmZmVyJzoKICAgICAgICB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoIlNvbWV0aGluZyB5b3UgZGlkIHRyaWVkIHRvIHJlcGxhY2UgYW4ge3tleHByZXNzaW9ufX0gYmVmb3JlIGl0IHdhcyBpbnNlcnRlZCBpbnRvIHRoZSBET00uIik7CiAgICAgIGNhc2UgJ2hhc0VsZW1lbnQnOgogICAgICBjYXNlICdpbkRPTSc6CiAgICAgICAgdGhpcy51cGRhdGVJZCA9IEVtYmVyLnJ1bi5zY2hlZHVsZU9uY2UoJ3JlbmRlcicsIHRoaXMsICd1cGRhdGUnKTsKICAgICAgICBicmVhazsKICAgIH0KCiAgICByZXR1cm4gdGhpczsKICB9LAoKICB1cGRhdGU6IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMudXBkYXRlSWQgPSBudWxsOwogICAgdGhpcy5tb3JwaC5odG1sKHRoaXMucmVuZGVyKCkpOwogIH0sCgogIHRyYW5zaXRpb25UbzogZnVuY3Rpb24oc3RhdGUpIHsKICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTsKICB9Cn07Cgp2YXIgc3RhdGVzID0gRW1iZXIuVmlldy5jbG9uZVN0YXRlcyhFbWJlci5WaWV3LnN0YXRlcyksIG1lcmdlID0gRW1iZXIubWVyZ2U7CgptZXJnZShzdGF0ZXMuX2RlZmF1bHQsIHsKICByZXJlbmRlcklmTmVlZGVkOiBFbWJlci5LCn0pOwoKbWVyZ2Uoc3RhdGVzLmluRE9NLCB7CiAgcmVyZW5kZXJJZk5lZWRlZDogZnVuY3Rpb24odmlldykgewogICAgaWYgKHZpZXcubm9ybWFsaXplZFZhbHVlKCkgIT09IHZpZXcuX2xhc3ROb3JtYWxpemVkVmFsdWUpIHsKICAgICAgdmlldy5yZXJlbmRlcigpOwogICAgfQogIH0KfSk7CgovKioKICBgRW1iZXIuX0hhbmRsZWJhcnNCb3VuZFZpZXdgIGlzIGEgcHJpdmF0ZSB2aWV3IGNyZWF0ZWQgYnkgdGhlIEhhbmRsZWJhcnMKICBge3tiaW5kfX1gIGhlbHBlcnMgdGhhdCBpcyB1c2VkIHRvIGtlZXAgdHJhY2sgb2YgYm91bmQgcHJvcGVydGllcy4KCiAgRXZlcnkgdGltZSBhIHByb3BlcnR5IGlzIGJvdW5kIHVzaW5nIGEgYHt7bXVzdGFjaGV9fWAsIGFuIGFub255bW91cyBzdWJjbGFzcwogIG9mIGBFbWJlci5fSGFuZGxlYmFyc0JvdW5kVmlld2AgaXMgY3JlYXRlZCB3aXRoIHRoZSBhcHByb3ByaWF0ZSBzdWItdGVtcGxhdGUKICBhbmQgY29udGV4dCBzZXQgdXAuIFdoZW4gdGhlIGFzc29jaWF0ZWQgcHJvcGVydHkgY2hhbmdlcywganVzdCB0aGUgdGVtcGxhdGUKICBmb3IgdGhpcyB2aWV3IHdpbGwgcmUtcmVuZGVyLgoKICBAY2xhc3MgX0hhbmRsZWJhcnNCb3VuZFZpZXcKICBAbmFtZXNwYWNlIEVtYmVyCiAgQGV4dGVuZHMgRW1iZXIuX01ldGFtb3JwaFZpZXcKICBAcHJpdmF0ZQoqLwpFbWJlci5fSGFuZGxlYmFyc0JvdW5kVmlldyA9IEVtYmVyLl9NZXRhbW9ycGhWaWV3LmV4dGVuZCh7CiAgaW5zdHJ1bWVudE5hbWU6ICdib3VuZEhhbmRsZWJhcnMnLAogIHN0YXRlczogc3RhdGVzLAoKICAvKioKICAgIFRoZSBmdW5jdGlvbiB1c2VkIHRvIGRldGVybWluZSBpZiB0aGUgYGRpc3BsYXlUZW1wbGF0ZWAgb3IKICAgIGBpbnZlcnNlVGVtcGxhdGVgIHNob3VsZCBiZSByZW5kZXJlZC4gVGhpcyBzaG91bGQgYmUgYSBmdW5jdGlvbiB0aGF0IHRha2VzCiAgICBhIHZhbHVlIGFuZCByZXR1cm5zIGEgQm9vbGVhbi4KCiAgICBAcHJvcGVydHkgc2hvdWxkRGlzcGxheUZ1bmMKICAgIEB0eXBlIEZ1bmN0aW9uCiAgICBAZGVmYXVsdCBudWxsCiAgKi8KICBzaG91bGREaXNwbGF5RnVuYzogbnVsbCwKCiAgLyoqCiAgICBXaGV0aGVyIHRoZSB0ZW1wbGF0ZSByZW5kZXJlZCBieSB0aGlzIHZpZXcgZ2V0cyBwYXNzZWQgdGhlIGNvbnRleHQgb2JqZWN0CiAgICBvZiBpdHMgcGFyZW50IHRlbXBsYXRlLCBvciBnZXRzIHBhc3NlZCB0aGUgdmFsdWUgb2YgcmV0cmlldmluZyBgcGF0aGAKICAgIGZyb20gdGhlIGBwYXRoUm9vdGAuCgogICAgRm9yIGV4YW1wbGUsIHRoaXMgaXMgdHJ1ZSB3aGVuIHVzaW5nIHRoZSBge3sjaWZ9fWAgaGVscGVyLCBiZWNhdXNlIHRoZQogICAgdGVtcGxhdGUgaW5zaWRlIHRoZSBoZWxwZXIgc2hvdWxkIGxvb2sgdXAgcHJvcGVydGllcyByZWxhdGl2ZSB0byB0aGUgc2FtZQogICAgb2JqZWN0IGFzIG91dHNpZGUgdGhlIGJsb2NrLiBUaGlzIHdvdWxkIGJlIGBmYWxzZWAgd2hlbiB1c2VkIHdpdGggYHt7I3dpdGgKICAgIGZvb319YCBiZWNhdXNlIHRoZSB0ZW1wbGF0ZSBzaG91bGQgcmVjZWl2ZSB0aGUgb2JqZWN0IGZvdW5kIGJ5IGV2YWx1YXRpbmcKICAgIGBmb29gLgoKICAgIEBwcm9wZXJ0eSBwcmVzZXJ2ZUNvbnRleHQKICAgIEB0eXBlIEJvb2xlYW4KICAgIEBkZWZhdWx0IGZhbHNlCiAgKi8KICBwcmVzZXJ2ZUNvbnRleHQ6IGZhbHNlLAoKICAvKioKICAgIElmIGBwcmVzZXJ2ZUNvbnRleHRgIGlzIHRydWUsIHRoaXMgaXMgdGhlIG9iamVjdCB0aGF0IHdpbGwgYmUgdXNlZAogICAgdG8gcmVuZGVyIHRoZSB0ZW1wbGF0ZS4KCiAgICBAcHJvcGVydHkgcHJldmlvdXNDb250ZXh0CiAgICBAdHlwZSBPYmplY3QKICAqLwogIHByZXZpb3VzQ29udGV4dDogbnVsbCwKCiAgLyoqCiAgICBUaGUgdGVtcGxhdGUgdG8gcmVuZGVyIHdoZW4gYHNob3VsZERpc3BsYXlGdW5jYCBldmFsdWF0ZXMgdG8gYHRydWVgLgoKICAgIEBwcm9wZXJ0eSBkaXNwbGF5VGVtcGxhdGUKICAgIEB0eXBlIEZ1bmN0aW9uCiAgICBAZGVmYXVsdCBudWxsCiAgKi8KICBkaXNwbGF5VGVtcGxhdGU6IG51bGwsCgogIC8qKgogICAgVGhlIHRlbXBsYXRlIHRvIHJlbmRlciB3aGVuIGBzaG91bGREaXNwbGF5RnVuY2AgZXZhbHVhdGVzIHRvIGBmYWxzZWAuCgogICAgQHByb3BlcnR5IGludmVyc2VUZW1wbGF0ZQogICAgQHR5cGUgRnVuY3Rpb24KICAgIEBkZWZhdWx0IG51bGwKICAqLwogIGludmVyc2VUZW1wbGF0ZTogbnVsbCwKCgogIC8qKgogICAgVGhlIHBhdGggdG8gbG9vayB1cCBvbiBgcGF0aFJvb3RgIHRoYXQgaXMgcGFzc2VkIHRvCiAgICBgc2hvdWxkRGlzcGxheUZ1bmNgIHRvIGRldGVybWluZSB3aGljaCB0ZW1wbGF0ZSB0byByZW5kZXIuCgogICAgSW4gYWRkaXRpb24sIGlmIGBwcmVzZXJ2ZUNvbnRleHRgIGlzIGBmYWxzZSxgIHRoZSBvYmplY3QgYXQgdGhpcyBwYXRoIHdpbGwKICAgIGJlIHBhc3NlZCB0byB0aGUgdGVtcGxhdGUgd2hlbiByZW5kZXJpbmcuCgogICAgQHByb3BlcnR5IHBhdGgKICAgIEB0eXBlIFN0cmluZwogICAgQGRlZmF1bHQgbnVsbAogICovCiAgcGF0aDogbnVsbCwKCiAgLyoqCiAgICBUaGUgb2JqZWN0IGZyb20gd2hpY2ggdGhlIGBwYXRoYCB3aWxsIGJlIGxvb2tlZCB1cC4gU29tZXRpbWVzIHRoaXMgaXMgdGhlCiAgICBzYW1lIGFzIHRoZSBgcHJldmlvdXNDb250ZXh0YCwgYnV0IGluIGNhc2VzIHdoZXJlIHRoaXMgdmlldyBoYXMgYmVlbgogICAgZ2VuZXJhdGVkIGZvciBwYXRocyB0aGF0IHN0YXJ0IHdpdGggYSBrZXl3b3JkIHN1Y2ggYXMgYHZpZXdgIG9yCiAgICBgY29udHJvbGxlcmAsIHRoZSBwYXRoIHJvb3Qgd2lsbCBiZSB0aGF0IHJlc29sdmVkIG9iamVjdC4KCiAgICBAcHJvcGVydHkgcGF0aFJvb3QKICAgIEB0eXBlIE9iamVjdAogICovCiAgcGF0aFJvb3Q6IG51bGwsCgogIG5vcm1hbGl6ZWRWYWx1ZTogZnVuY3Rpb24oKSB7CiAgICB2YXIgcGF0aCA9IGdldCh0aGlzLCAncGF0aCcpLAogICAgICAgIHBhdGhSb290ICA9IGdldCh0aGlzLCAncGF0aFJvb3QnKSwKICAgICAgICB2YWx1ZU5vcm1hbGl6ZXIgPSBnZXQodGhpcywgJ3ZhbHVlTm9ybWFsaXplckZ1bmMnKSwKICAgICAgICByZXN1bHQsIHRlbXBsYXRlRGF0YTsKCiAgICAvLyBVc2UgdGhlIHBhdGhSb290IGFzIHRoZSByZXN1bHQgaWYgbm8gcGF0aCBpcyBwcm92aWRlZC4gVGhpcwogICAgLy8gaGFwcGVucyBpZiB0aGUgcGF0aCBpcyBgdGhpc2AsIHdoaWNoIGdldHMgbm9ybWFsaXplZCBpbnRvCiAgICAvLyBhIGBwYXRoUm9vdGAgb2YgdGhlIGN1cnJlbnQgSGFuZGxlYmFycyBjb250ZXh0IGFuZCBhIHBhdGgKICAgIC8vIG9mIGAnJ2AuCiAgICBpZiAocGF0aCA9PT0gJycpIHsKICAgICAgcmVzdWx0ID0gcGF0aFJvb3Q7CiAgICB9IGVsc2UgewogICAgICB0ZW1wbGF0ZURhdGEgPSBnZXQodGhpcywgJ3RlbXBsYXRlRGF0YScpOwogICAgICByZXN1bHQgPSBoYW5kbGViYXJzR2V0KHBhdGhSb290LCBwYXRoLCB7IGRhdGE6IHRlbXBsYXRlRGF0YSB9KTsKICAgIH0KCiAgICByZXR1cm4gdmFsdWVOb3JtYWxpemVyID8gdmFsdWVOb3JtYWxpemVyKHJlc3VsdCkgOiByZXN1bHQ7CiAgfSwKCiAgcmVyZW5kZXJJZk5lZWRlZDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLmN1cnJlbnRTdGF0ZS5yZXJlbmRlcklmTmVlZGVkKHRoaXMpOwogIH0sCgogIC8qKgogICAgRGV0ZXJtaW5lcyB3aGljaCB0ZW1wbGF0ZSB0byBpbnZva2UsIHNldHMgdXAgdGhlIGNvcnJlY3Qgc3RhdGUgYmFzZWQgb24KICAgIHRoYXQgbG9naWMsIHRoZW4gaW52b2tlcyB0aGUgZGVmYXVsdCBgRW1iZXIuVmlld2AgYHJlbmRlcmAgaW1wbGVtZW50YXRpb24uCgogICAgVGhpcyBtZXRob2Qgd2lsbCBmaXJzdCBsb29rIHVwIHRoZSBgcGF0aGAga2V5IG9uIGBwYXRoUm9vdGAsCiAgICB0aGVuIHBhc3MgdGhhdCB2YWx1ZSB0byB0aGUgYHNob3VsZERpc3BsYXlGdW5jYCBmdW5jdGlvbi4gSWYgdGhhdCByZXR1cm5zCiAgICBgdHJ1ZSxgIHRoZSBgZGlzcGxheVRlbXBsYXRlYCBmdW5jdGlvbiB3aWxsIGJlIHJlbmRlcmVkIHRvIERPTS4gT3RoZXJ3aXNlLAogICAgYGludmVyc2VUZW1wbGF0ZWAsIGlmIHNwZWNpZmllZCwgd2lsbCBiZSByZW5kZXJlZC4KCiAgICBGb3IgZXhhbXBsZSwgaWYgdGhpcyBgRW1iZXIuX0hhbmRsZWJhcnNCb3VuZFZpZXdgIHJlcHJlc2VudGVkIHRoZSBge3sjd2l0aAogICAgZm9vfX1gIGhlbHBlciwgaXQgd291bGQgbG9vayB1cCB0aGUgYGZvb2AgcHJvcGVydHkgb2YgaXRzIGNvbnRleHQsIGFuZAogICAgYHNob3VsZERpc3BsYXlGdW5jYCB3b3VsZCBhbHdheXMgcmV0dXJuIHRydWUuIFRoZSBvYmplY3QgZm91bmQgYnkgbG9va2luZwogICAgdXAgYGZvb2Agd291bGQgYmUgcGFzc2VkIHRvIGBkaXNwbGF5VGVtcGxhdGVgLgoKICAgIEBtZXRob2QgcmVuZGVyCiAgICBAcGFyYW0ge0VtYmVyLlJlbmRlckJ1ZmZlcn0gYnVmZmVyCiAgKi8KICByZW5kZXI6IGZ1bmN0aW9uKGJ1ZmZlcikgewogICAgLy8gSWYgbm90IGludm9rZWQgdmlhIGEgdHJpcGxlLW11c3RhY2hlICh7e3tmb299fX0pLCBlc2NhcGUKICAgIC8vIHRoZSBjb250ZW50IG9mIHRoZSB0ZW1wbGF0ZS4KICAgIHZhciBlc2NhcGUgPSBnZXQodGhpcywgJ2lzRXNjYXBlZCcpOwoKICAgIHZhciBzaG91bGREaXNwbGF5ID0gZ2V0KHRoaXMsICdzaG91bGREaXNwbGF5RnVuYycpLAogICAgICAgIHByZXNlcnZlQ29udGV4dCA9IGdldCh0aGlzLCAncHJlc2VydmVDb250ZXh0JyksCiAgICAgICAgY29udGV4dCA9IGdldCh0aGlzLCAncHJldmlvdXNDb250ZXh0Jyk7CgogICAgdmFyIGludmVyc2VUZW1wbGF0ZSA9IGdldCh0aGlzLCAnaW52ZXJzZVRlbXBsYXRlJyksCiAgICAgICAgZGlzcGxheVRlbXBsYXRlID0gZ2V0KHRoaXMsICdkaXNwbGF5VGVtcGxhdGUnKTsKCiAgICB2YXIgcmVzdWx0ID0gdGhpcy5ub3JtYWxpemVkVmFsdWUoKTsKICAgIHRoaXMuX2xhc3ROb3JtYWxpemVkVmFsdWUgPSByZXN1bHQ7CgogICAgLy8gRmlyc3QsIHRlc3QgdGhlIGNvbmRpdGlvbmFsIHRvIHNlZSBpZiB3ZSBzaG91bGQKICAgIC8vIHJlbmRlciB0aGUgdGVtcGxhdGUgb3Igbm90LgogICAgaWYgKHNob3VsZERpc3BsYXkocmVzdWx0KSkgewogICAgICBzZXQodGhpcywgJ3RlbXBsYXRlJywgZGlzcGxheVRlbXBsYXRlKTsKCiAgICAgIC8vIElmIHdlIGFyZSBwcmVzZXJ2aW5nIHRoZSBjb250ZXh0IChmb3IgZXhhbXBsZSwgaWYgdGhpcwogICAgICAvLyBpcyBhbiAjaWYgYmxvY2ssIGNhbGwgdGhlIHRlbXBsYXRlIHdpdGggdGhlIHNhbWUgb2JqZWN0LgogICAgICBpZiAocHJlc2VydmVDb250ZXh0KSB7CiAgICAgICAgc2V0KHRoaXMsICdfY29udGV4dCcsIGNvbnRleHQpOwogICAgICB9IGVsc2UgewogICAgICAvLyBPdGhlcndpc2UsIGRldGVybWluZSBpZiB0aGlzIGlzIGEgYmxvY2sgYmluZCBvciBub3QuCiAgICAgIC8vIElmIHNvLCBwYXNzIHRoZSBzcGVjaWZpZWQgb2JqZWN0IHRvIHRoZSB0ZW1wbGF0ZQogICAgICAgIGlmIChkaXNwbGF5VGVtcGxhdGUpIHsKICAgICAgICAgIHNldCh0aGlzLCAnX2NvbnRleHQnLCByZXN1bHQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gVGhpcyBpcyBub3QgYSBiaW5kIGJsb2NrLCBqdXN0IHB1c2ggdGhlIHJlc3VsdCBvZiB0aGUKICAgICAgICAvLyBleHByZXNzaW9uIHRvIHRoZSByZW5kZXIgY29udGV4dCBhbmQgcmV0dXJuLgogICAgICAgICAgaWYgKHJlc3VsdCA9PT0gbnVsbCB8fCByZXN1bHQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXN1bHQgPSAiIjsKICAgICAgICAgIH0gZWxzZSBpZiAoIShyZXN1bHQgaW5zdGFuY2VvZiBIYW5kbGViYXJzLlNhZmVTdHJpbmcpKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IFN0cmluZyhyZXN1bHQpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChlc2NhcGUpIHsgcmVzdWx0ID0gSGFuZGxlYmFycy5VdGlscy5lc2NhcGVFeHByZXNzaW9uKHJlc3VsdCk7IH0KICAgICAgICAgIGJ1ZmZlci5wdXNoKHJlc3VsdCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKGludmVyc2VUZW1wbGF0ZSkgewogICAgICBzZXQodGhpcywgJ3RlbXBsYXRlJywgaW52ZXJzZVRlbXBsYXRlKTsKCiAgICAgIGlmIChwcmVzZXJ2ZUNvbnRleHQpIHsKICAgICAgICBzZXQodGhpcywgJ19jb250ZXh0JywgY29udGV4dCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0KHRoaXMsICdfY29udGV4dCcsIHJlc3VsdCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHNldCh0aGlzLCAndGVtcGxhdGUnLCBmdW5jdGlvbigpIHsgcmV0dXJuICcnOyB9KTsKICAgIH0KCiAgICByZXR1cm4gdGhpcy5fc3VwZXIoYnVmZmVyKTsKICB9Cn0pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLWhhbmRsZWJhcnMKKi8KCnZhciBnZXQgPSBFbWJlci5nZXQsIHNldCA9IEVtYmVyLnNldCwgZm10ID0gRW1iZXIuU3RyaW5nLmZtdDsKdmFyIGhhbmRsZWJhcnNHZXQgPSBFbWJlci5IYW5kbGViYXJzLmdldCwgbm9ybWFsaXplUGF0aCA9IEVtYmVyLkhhbmRsZWJhcnMubm9ybWFsaXplUGF0aDsKdmFyIGZvckVhY2ggPSBFbWJlci5BcnJheVBvbHlmaWxscy5mb3JFYWNoOwp2YXIgb19jcmVhdGUgPSBFbWJlci5jcmVhdGU7Cgp2YXIgRW1iZXJIYW5kbGViYXJzID0gRW1iZXIuSGFuZGxlYmFycywgaGVscGVycyA9IEVtYmVySGFuZGxlYmFycy5oZWxwZXJzOwoKZnVuY3Rpb24gZXhpc3RzKHZhbHVlKSB7CiAgcmV0dXJuICFFbWJlci5pc05vbmUodmFsdWUpOwp9CgpmdW5jdGlvbiBzYW5pdGl6ZWRIYW5kbGViYXJzR2V0KGN1cnJlbnRDb250ZXh0LCBwcm9wZXJ0eSwgb3B0aW9ucykgewogIHZhciByZXN1bHQgPSBoYW5kbGViYXJzR2V0KGN1cnJlbnRDb250ZXh0LCBwcm9wZXJ0eSwgb3B0aW9ucyk7CiAgaWYgKHJlc3VsdCA9PT0gbnVsbCB8fCByZXN1bHQgPT09IHVuZGVmaW5lZCkgewogICAgcmVzdWx0ID0gIiI7CiAgfSBlbHNlIGlmICghKHJlc3VsdCBpbnN0YW5jZW9mIEhhbmRsZWJhcnMuU2FmZVN0cmluZykpIHsKICAgIHJlc3VsdCA9IFN0cmluZyhyZXN1bHQpOwogIH0KICBpZiAoIW9wdGlvbnMuaGFzaC51bmVzY2FwZWQpewogICAgcmVzdWx0ID0gSGFuZGxlYmFycy5VdGlscy5lc2NhcGVFeHByZXNzaW9uKHJlc3VsdCk7CiAgfQoKICByZXR1cm4gcmVzdWx0Owp9CgovLyBCaW5kcyBhIHByb3BlcnR5IGludG8gdGhlIERPTS4gVGhpcyB3aWxsIGNyZWF0ZSBhIGhvb2sgaW4gRE9NIHRoYXQgdGhlCi8vIEtWTyBzeXN0ZW0gd2lsbCBsb29rIGZvciBhbmQgdXBkYXRlIGlmIHRoZSBwcm9wZXJ0eSBjaGFuZ2VzLgpmdW5jdGlvbiBiaW5kKHByb3BlcnR5LCBvcHRpb25zLCBwcmVzZXJ2ZUNvbnRleHQsIHNob3VsZERpc3BsYXksIHZhbHVlTm9ybWFsaXplciwgY2hpbGRQcm9wZXJ0aWVzKSB7CiAgdmFyIGRhdGEgPSBvcHRpb25zLmRhdGEsCiAgICAgIGZuID0gb3B0aW9ucy5mbiwKICAgICAgaW52ZXJzZSA9IG9wdGlvbnMuaW52ZXJzZSwKICAgICAgdmlldyA9IGRhdGEudmlldywKICAgICAgY3VycmVudENvbnRleHQgPSB0aGlzLAogICAgICBub3JtYWxpemVkLCBvYnNlcnZlciwgaTsKCiAgbm9ybWFsaXplZCA9IG5vcm1hbGl6ZVBhdGgoY3VycmVudENvbnRleHQsIHByb3BlcnR5LCBkYXRhKTsKCiAgLy8gU2V0IHVwIG9ic2VydmVycyBmb3Igb2JzZXJ2YWJsZSBvYmplY3RzCiAgaWYgKCdvYmplY3QnID09PSB0eXBlb2YgdGhpcykgewogICAgaWYgKGRhdGEuaW5zaWRlR3JvdXApIHsKICAgICAgb2JzZXJ2ZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICBFbWJlci5ydW4ub25jZSh2aWV3LCAncmVyZW5kZXInKTsKICAgICAgfTsKCiAgICAgIHZhciB0ZW1wbGF0ZSwgY29udGV4dCwgcmVzdWx0ID0gaGFuZGxlYmFyc0dldChjdXJyZW50Q29udGV4dCwgcHJvcGVydHksIG9wdGlvbnMpOwoKICAgICAgcmVzdWx0ID0gdmFsdWVOb3JtYWxpemVyID8gdmFsdWVOb3JtYWxpemVyKHJlc3VsdCkgOiByZXN1bHQ7CgogICAgICBjb250ZXh0ID0gcHJlc2VydmVDb250ZXh0ID8gY3VycmVudENvbnRleHQgOiByZXN1bHQ7CiAgICAgIGlmIChzaG91bGREaXNwbGF5KHJlc3VsdCkpIHsKICAgICAgICB0ZW1wbGF0ZSA9IGZuOwogICAgICB9IGVsc2UgaWYgKGludmVyc2UpIHsKICAgICAgICB0ZW1wbGF0ZSA9IGludmVyc2U7CiAgICAgIH0KCiAgICAgIHRlbXBsYXRlKGNvbnRleHQsIHsgZGF0YTogb3B0aW9ucy5kYXRhIH0pOwogICAgfSBlbHNlIHsKICAgICAgLy8gQ3JlYXRlIHRoZSB2aWV3IHRoYXQgd2lsbCB3cmFwIHRoZSBvdXRwdXQgb2YgdGhpcyB0ZW1wbGF0ZS9wcm9wZXJ0eQogICAgICAvLyBhbmQgYWRkIGl0IHRvIHRoZSBuZWFyZXN0IHZpZXcncyBjaGlsZFZpZXdzIGFycmF5LgogICAgICAvLyBTZWUgdGhlIGRvY3VtZW50YXRpb24gb2YgRW1iZXIuX0hhbmRsZWJhcnNCb3VuZFZpZXcgZm9yIG1vcmUuCiAgICAgIHZhciBiaW5kVmlldyA9IHZpZXcuY3JlYXRlQ2hpbGRWaWV3KEVtYmVyLl9IYW5kbGViYXJzQm91bmRWaWV3LCB7CiAgICAgICAgcHJlc2VydmVDb250ZXh0OiBwcmVzZXJ2ZUNvbnRleHQsCiAgICAgICAgc2hvdWxkRGlzcGxheUZ1bmM6IHNob3VsZERpc3BsYXksCiAgICAgICAgdmFsdWVOb3JtYWxpemVyRnVuYzogdmFsdWVOb3JtYWxpemVyLAogICAgICAgIGRpc3BsYXlUZW1wbGF0ZTogZm4sCiAgICAgICAgaW52ZXJzZVRlbXBsYXRlOiBpbnZlcnNlLAogICAgICAgIHBhdGg6IHByb3BlcnR5LAogICAgICAgIHBhdGhSb290OiBjdXJyZW50Q29udGV4dCwKICAgICAgICBwcmV2aW91c0NvbnRleHQ6IGN1cnJlbnRDb250ZXh0LAogICAgICAgIGlzRXNjYXBlZDogIW9wdGlvbnMuaGFzaC51bmVzY2FwZWQsCiAgICAgICAgdGVtcGxhdGVEYXRhOiBvcHRpb25zLmRhdGEKICAgICAgfSk7CgogICAgICB2aWV3LmFwcGVuZENoaWxkKGJpbmRWaWV3KTsKCiAgICAgIG9ic2VydmVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgRW1iZXIucnVuLnNjaGVkdWxlT25jZSgncmVuZGVyJywgYmluZFZpZXcsICdyZXJlbmRlcklmTmVlZGVkJyk7CiAgICAgIH07CiAgICB9CgogICAgLy8gT2JzZXJ2ZXMgdGhlIGdpdmVuIHByb3BlcnR5IG9uIHRoZSBjb250ZXh0IGFuZAogICAgLy8gdGVsbHMgdGhlIEVtYmVyLl9IYW5kbGViYXJzQm91bmRWaWV3IHRvIHJlLXJlbmRlci4gSWYgcHJvcGVydHkKICAgIC8vIGlzIGFuIGVtcHR5IHN0cmluZywgd2UgYXJlIHByaW50aW5nIHRoZSBjdXJyZW50IGNvbnRleHQKICAgIC8vIG9iamVjdCAoe3t0aGlzfX0pIHNvIHVwZGF0aW5nIGl0IGlzIG5vdCBvdXIgcmVzcG9uc2liaWxpdHkuCiAgICBpZiAobm9ybWFsaXplZC5wYXRoICE9PSAnJykgewogICAgICB2aWV3LnJlZ2lzdGVyT2JzZXJ2ZXIobm9ybWFsaXplZC5yb290LCBub3JtYWxpemVkLnBhdGgsIG9ic2VydmVyKTsKICAgICAgaWYgKGNoaWxkUHJvcGVydGllcykgewogICAgICAgIGZvciAoaT0wOyBpPGNoaWxkUHJvcGVydGllcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmlldy5yZWdpc3Rlck9ic2VydmVyKG5vcm1hbGl6ZWQucm9vdCwgbm9ybWFsaXplZC5wYXRoKycuJytjaGlsZFByb3BlcnRpZXNbaV0sIG9ic2VydmVyKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgLy8gVGhlIG9iamVjdCBpcyBub3Qgb2JzZXJ2YWJsZSwgc28ganVzdCByZW5kZXIgaXQgb3V0IGFuZAogICAgLy8gYmUgZG9uZSB3aXRoIGl0LgogICAgZGF0YS5idWZmZXIucHVzaChoYW5kbGViYXJzR2V0KGN1cnJlbnRDb250ZXh0LCBwcm9wZXJ0eSwgb3B0aW9ucykpOwogIH0KfQoKRW1iZXJIYW5kbGViYXJzLmJpbmQgPSBiaW5kOwoKZnVuY3Rpb24gc2ltcGxlQmluZChjdXJyZW50Q29udGV4dCwgcHJvcGVydHksIG9wdGlvbnMpIHsKICB2YXIgZGF0YSA9IG9wdGlvbnMuZGF0YSwKICAgICAgdmlldyA9IGRhdGEudmlldywKICAgICAgbm9ybWFsaXplZCwgb2JzZXJ2ZXIsIHBhdGhSb290LCBvdXRwdXQ7CgogIG5vcm1hbGl6ZWQgPSBub3JtYWxpemVQYXRoKGN1cnJlbnRDb250ZXh0LCBwcm9wZXJ0eSwgZGF0YSk7CiAgcGF0aFJvb3QgPSBub3JtYWxpemVkLnJvb3Q7CgogIC8vIFNldCB1cCBvYnNlcnZlcnMgZm9yIG9ic2VydmFibGUgb2JqZWN0cwogIGlmIChwYXRoUm9vdCAmJiAoJ29iamVjdCcgPT09IHR5cGVvZiBwYXRoUm9vdCkpIHsKICAgIGlmIChkYXRhLmluc2lkZUdyb3VwKSB7CiAgICAgIG9ic2VydmVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgRW1iZXIucnVuLm9uY2UodmlldywgJ3JlcmVuZGVyJyk7CiAgICAgIH07CgogICAgICBvdXRwdXQgPSBzYW5pdGl6ZWRIYW5kbGViYXJzR2V0KGN1cnJlbnRDb250ZXh0LCBwcm9wZXJ0eSwgb3B0aW9ucyk7CgogICAgICBkYXRhLmJ1ZmZlci5wdXNoKG91dHB1dCk7CiAgICB9IGVsc2UgewogICAgICB2YXIgYmluZFZpZXcgPSBuZXcgRW1iZXIuX1NpbXBsZUhhbmRsZWJhcnNWaWV3KAogICAgICAgIHByb3BlcnR5LCBjdXJyZW50Q29udGV4dCwgIW9wdGlvbnMuaGFzaC51bmVzY2FwZWQsIG9wdGlvbnMuZGF0YQogICAgICApOwoKICAgICAgYmluZFZpZXcuX3BhcmVudFZpZXcgPSB2aWV3OwogICAgICB2aWV3LmFwcGVuZENoaWxkKGJpbmRWaWV3KTsKCiAgICAgIG9ic2VydmVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgRW1iZXIucnVuLnNjaGVkdWxlT25jZSgncmVuZGVyJywgYmluZFZpZXcsICdyZXJlbmRlcicpOwogICAgICB9OwogICAgfQoKICAgIC8vIE9ic2VydmVzIHRoZSBnaXZlbiBwcm9wZXJ0eSBvbiB0aGUgY29udGV4dCBhbmQKICAgIC8vIHRlbGxzIHRoZSBFbWJlci5fSGFuZGxlYmFyc0JvdW5kVmlldyB0byByZS1yZW5kZXIuIElmIHByb3BlcnR5CiAgICAvLyBpcyBhbiBlbXB0eSBzdHJpbmcsIHdlIGFyZSBwcmludGluZyB0aGUgY3VycmVudCBjb250ZXh0CiAgICAvLyBvYmplY3QgKHt7dGhpc319KSBzbyB1cGRhdGluZyBpdCBpcyBub3Qgb3VyIHJlc3BvbnNpYmlsaXR5LgogICAgaWYgKG5vcm1hbGl6ZWQucGF0aCAhPT0gJycpIHsKICAgICAgdmlldy5yZWdpc3Rlck9ic2VydmVyKG5vcm1hbGl6ZWQucm9vdCwgbm9ybWFsaXplZC5wYXRoLCBvYnNlcnZlcik7CiAgICB9CiAgfSBlbHNlIHsKICAgIC8vIFRoZSBvYmplY3QgaXMgbm90IG9ic2VydmFibGUsIHNvIGp1c3QgcmVuZGVyIGl0IG91dCBhbmQKICAgIC8vIGJlIGRvbmUgd2l0aCBpdC4KICAgIG91dHB1dCA9IHNhbml0aXplZEhhbmRsZWJhcnNHZXQoY3VycmVudENvbnRleHQsIHByb3BlcnR5LCBvcHRpb25zKTsKCiAgICBkYXRhLmJ1ZmZlci5wdXNoKG91dHB1dCk7CiAgfQp9CgovKioKICAnX3RyaWFnZU11c3RhY2hlJyBpcyB1c2VkIGludGVybmFsbHkgc2VsZWN0IGJldHdlZW4gYSBiaW5kaW5nLCBoZWxwZXIsIG9yIGNvbXBvbmVudCBmb3IKICB0aGUgZ2l2ZW4gY29udGV4dC4gVW50aWwgdGhpcyBwb2ludCwgaXQgd291bGQgYmUgaGFyZCB0byBkZXRlcm1pbmUgaWYgdGhlCiAgbXVzdGFjaGUgaXMgYSBwcm9wZXJ0eSByZWZlcmVuY2Ugb3IgYSByZWd1bGFyIGhlbHBlciByZWZlcmVuY2UuIFRoaXMgdHJpYWdlCiAgaGVscGVyIHJlc29sdmVzIHRoYXQuCgogIFRoaXMgd291bGQgbm90IGJlIHR5cGljYWxseSBpbnZva2VkIGJ5IGRpcmVjdGx5LgoKICBAcHJpdmF0ZQogIEBtZXRob2QgX3RyaWFnZU11c3RhY2hlCiAgQGZvciBFbWJlci5IYW5kbGViYXJzLmhlbHBlcnMKICBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkgUHJvcGVydHkvaGVscGVySUQgdG8gdHJpYWdlCiAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgaGFzaCBvZiB0ZW1wbGF0ZS9yZW5kZXJpbmcgb3B0aW9ucwogIEByZXR1cm4ge1N0cmluZ30gSFRNTCBzdHJpbmcKKi8KRW1iZXJIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdfdHJpYWdlTXVzdGFjaGUnLCBmdW5jdGlvbihwcm9wZXJ0eSwgb3B0aW9ucykgewogIEVtYmVyLmFzc2VydCgiWW91IGNhbm5vdCBwYXNzIG1vcmUgdGhhbiBvbmUgYXJndW1lbnQgdG8gdGhlIF90cmlhZ2VNdXN0YWNoZSBoZWxwZXIiLCBhcmd1bWVudHMubGVuZ3RoIDw9IDIpOwoKICBpZiAoaGVscGVyc1twcm9wZXJ0eV0pIHsKICAgIHJldHVybiBoZWxwZXJzW3Byb3BlcnR5XS5jYWxsKHRoaXMsIG9wdGlvbnMpOwogIH0KCiAgdmFyIGhlbHBlciA9IEVtYmVyLkhhbmRsZWJhcnMucmVzb2x2ZUhlbHBlcihvcHRpb25zLmRhdGEudmlldy5jb250YWluZXIsIHByb3BlcnR5KTsKICBpZiAoaGVscGVyKSB7CiAgICByZXR1cm4gaGVscGVyLmNhbGwodGhpcywgb3B0aW9ucyk7CiAgfQoKICByZXR1cm4gaGVscGVycy5iaW5kLmNhbGwodGhpcywgcHJvcGVydHksIG9wdGlvbnMpOwp9KTsKCkVtYmVyLkhhbmRsZWJhcnMucmVzb2x2ZUhlbHBlciA9IGZ1bmN0aW9uKGNvbnRhaW5lciwgbmFtZSkgewoKICBpZiAoIWNvbnRhaW5lciB8fCBuYW1lLmluZGV4T2YoJy0nKSA9PT0gLTEpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBoZWxwZXIgPSBjb250YWluZXIubG9va3VwKCdoZWxwZXI6JyArIG5hbWUpOwogIGlmICghaGVscGVyKSB7CiAgICB2YXIgY29tcG9uZW50TG9va3VwID0gY29udGFpbmVyLmxvb2t1cCgnY29tcG9uZW50LWxvb2t1cDptYWluJyk7CiAgICBFbWJlci5hc3NlcnQoIkNvdWxkIG5vdCBmaW5kICdjb21wb25lbnQtbG9va3VwOm1haW4nIG9uIHRoZSBwcm92aWRlZCBjb250YWluZXIsIHdoaWNoIGlzIG5lY2Vzc2FyeSBmb3IgcGVyZm9ybWluZyBjb21wb25lbnQgbG9va3VwcyIsIGNvbXBvbmVudExvb2t1cCk7CgogICAgdmFyIENvbXBvbmVudCA9IGNvbXBvbmVudExvb2t1cC5sb29rdXBGYWN0b3J5KG5hbWUsIGNvbnRhaW5lcik7CiAgICBpZiAoQ29tcG9uZW50KSB7CiAgICAgIGhlbHBlciA9IEVtYmVySGFuZGxlYmFycy5tYWtlVmlld0hlbHBlcihDb21wb25lbnQpOwogICAgICBjb250YWluZXIucmVnaXN0ZXIoJ2hlbHBlcjonICsgbmFtZSwgaGVscGVyKTsKICAgIH0KICB9CiAgcmV0dXJuIGhlbHBlcjsKfTsKCi8qKgogIGBiaW5kYCBjYW4gYmUgdXNlZCB0byBkaXNwbGF5IGEgdmFsdWUsIHRoZW4gdXBkYXRlIHRoYXQgdmFsdWUgaWYgaXQKICBjaGFuZ2VzLiBGb3IgZXhhbXBsZSwgaWYgeW91IHdhbnRlZCB0byBwcmludCB0aGUgYHRpdGxlYCBwcm9wZXJ0eSBvZgogIGBjb250ZW50YDoKCiAgYGBgaGFuZGxlYmFycwogIHt7YmluZCAiY29udGVudC50aXRsZSJ9fQogIGBgYAoKICBUaGlzIHdpbGwgcmV0dXJuIHRoZSBgdGl0bGVgIHByb3BlcnR5IGFzIGEgc3RyaW5nLCB0aGVuIGNyZWF0ZSBhIG5ldyBvYnNlcnZlcgogIGF0IHRoZSBzcGVjaWZpZWQgcGF0aC4gSWYgaXQgY2hhbmdlcywgaXQgd2lsbCB1cGRhdGUgdGhlIHZhbHVlIGluIERPTS4gTm90ZQogIHRoYXQgaWYgeW91IG5lZWQgdG8gc3VwcG9ydCBJRTcgYW5kIElFOCB5b3UgbXVzdCBtb2RpZnkgdGhlIG1vZGVsIG9iamVjdHMKICBwcm9wZXJ0aWVzIHVzaW5nIGBFbWJlci5nZXQoKWAgYW5kIGBFbWJlci5zZXQoKWAgZm9yIHRoaXMgdG8gd29yayBhcyBpdAogIHJlbGllcyBvbiBFbWJlcidzIEtWTyBzeXN0ZW0uIEZvciBhbGwgb3RoZXIgYnJvd3NlcnMgdGhpcyB3aWxsIGJlIGhhbmRsZWQgZm9yCiAgeW91IGF1dG9tYXRpY2FsbHkuCgogIEBwcml2YXRlCiAgQG1ldGhvZCBiaW5kCiAgQGZvciBFbWJlci5IYW5kbGViYXJzLmhlbHBlcnMKICBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkgUHJvcGVydHkgdG8gYmluZAogIEBwYXJhbSB7RnVuY3Rpb259IGZuIENvbnRleHQgdG8gcHJvdmlkZSBmb3IgcmVuZGVyaW5nCiAgQHJldHVybiB7U3RyaW5nfSBIVE1MIHN0cmluZwoqLwpFbWJlckhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2JpbmQnLCBmdW5jdGlvbiBiaW5kSGVscGVyKHByb3BlcnR5LCBvcHRpb25zKSB7CiAgRW1iZXIuYXNzZXJ0KCJZb3UgY2Fubm90IHBhc3MgbW9yZSB0aGFuIG9uZSBhcmd1bWVudCB0byB0aGUgYmluZCBoZWxwZXIiLCBhcmd1bWVudHMubGVuZ3RoIDw9IDIpOwoKICB2YXIgY29udGV4dCA9IChvcHRpb25zLmNvbnRleHRzICYmIG9wdGlvbnMuY29udGV4dHMubGVuZ3RoKSA/IG9wdGlvbnMuY29udGV4dHNbMF0gOiB0aGlzOwoKICBpZiAoIW9wdGlvbnMuZm4pIHsKICAgIHJldHVybiBzaW1wbGVCaW5kKGNvbnRleHQsIHByb3BlcnR5LCBvcHRpb25zKTsKICB9CgogIHJldHVybiBiaW5kLmNhbGwoY29udGV4dCwgcHJvcGVydHksIG9wdGlvbnMsIGZhbHNlLCBleGlzdHMpOwp9KTsKCi8qKgogIFVzZSB0aGUgYGJvdW5kSWZgIGhlbHBlciB0byBjcmVhdGUgYSBjb25kaXRpb25hbCB0aGF0IHJlLWV2YWx1YXRlcwogIHdoZW5ldmVyIHRoZSB0cnV0aGluZXNzIG9mIHRoZSBib3VuZCB2YWx1ZSBjaGFuZ2VzLgoKICBgYGBoYW5kbGViYXJzCiAge3sjYm91bmRJZiAiY29udGVudC5zaG91bGREaXNwbGF5VGl0bGUifX0KICAgIHt7Y29udGVudC50aXRsZX19CiAge3svYm91bmRJZn19CiAgYGBgCgogIEBwcml2YXRlCiAgQG1ldGhvZCBib3VuZElmCiAgQGZvciBFbWJlci5IYW5kbGViYXJzLmhlbHBlcnMKICBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkgUHJvcGVydHkgdG8gYmluZAogIEBwYXJhbSB7RnVuY3Rpb259IGZuIENvbnRleHQgdG8gcHJvdmlkZSBmb3IgcmVuZGVyaW5nCiAgQHJldHVybiB7U3RyaW5nfSBIVE1MIHN0cmluZwoqLwpFbWJlckhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2JvdW5kSWYnLCBmdW5jdGlvbiBib3VuZElmSGVscGVyKHByb3BlcnR5LCBmbikgewogIHZhciBjb250ZXh0ID0gKGZuLmNvbnRleHRzICYmIGZuLmNvbnRleHRzLmxlbmd0aCkgPyBmbi5jb250ZXh0c1swXSA6IHRoaXM7CiAgdmFyIGZ1bmMgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgIHZhciB0cnV0aHkgPSByZXN1bHQgJiYgZ2V0KHJlc3VsdCwgJ2lzVHJ1dGh5Jyk7CiAgICBpZiAodHlwZW9mIHRydXRoeSA9PT0gJ2Jvb2xlYW4nKSB7IHJldHVybiB0cnV0aHk7IH0KCiAgICBpZiAoRW1iZXIuaXNBcnJheShyZXN1bHQpKSB7CiAgICAgIHJldHVybiBnZXQocmVzdWx0LCAnbGVuZ3RoJykgIT09IDA7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gISFyZXN1bHQ7CiAgICB9CiAgfTsKCiAgcmV0dXJuIGJpbmQuY2FsbChjb250ZXh0LCBwcm9wZXJ0eSwgZm4sIHRydWUsIGZ1bmMsIGZ1bmMsIFsnaXNUcnV0aHknLCAnbGVuZ3RoJ10pOwp9KTsKCi8qKgogIFVzZSB0aGUgYHt7d2l0aH19YCBoZWxwZXIgd2hlbiB5b3Ugd2FudCB0byBzY29wZSBjb250ZXh0LiBUYWtlIHRoZSBmb2xsb3dpbmcgY29kZSBhcyBhbiBleGFtcGxlOgoKICBgYGBoYW5kbGViYXJzCiAgPGg1Pnt7dXNlci5uYW1lfX08L2g1PgoKICA8ZGl2IGNsYXNzPSJyb2xlIj4KICAgIDxoNj57e3VzZXIucm9sZS5sYWJlbH19PC9oNj4KICAgIDxzcGFuIGNsYXNzPSJyb2xlLWlkIj57e3VzZXIucm9sZS5pZH19PC9zcGFuPgoKICAgIDxwIGNsYXNzPSJyb2xlLWRlc2MiPnt7dXNlci5yb2xlLmRlc2NyaXB0aW9ufX08L3A+CiAgPC9kaXY+CiAgYGBgCgogIGB7e3dpdGh9fWAgY2FuIGJlIG91ciBiZXN0IGZyaWVuZCBpbiB0aGVzZSBjYXNlcywgCiAgaW5zdGVhZCBvZiB3cml0aW5nIGB1c2VyLnJvbGUuKmAgb3ZlciBhbmQgb3Zlciwgd2UgdXNlIGB7eyN3aXRoIHVzZXIucm9sZX19YC4KICBOb3cgdGhlIGNvbnRleHQgd2l0aGluIHRoZSBge3sjd2l0aH19IC4uIHt7L3dpdGh9fWAgYmxvY2sgaXMgYHVzZXIucm9sZWAgc28geW91IGNhbiBkbyB0aGUgZm9sbG93aW5nOgoKICBgYGBoYW5kbGViYXJzCiAgPGg1Pnt7dXNlci5uYW1lfX08L2g1PgoKICA8ZGl2IGNsYXNzPSJyb2xlIj4KICAgIHt7I3dpdGggdXNlci5yb2xlfX0KICAgICAgPGg2Pnt7bGFiZWx9fTwvaDY+CiAgICAgIDxzcGFuIGNsYXNzPSJyb2xlLWlkIj57e2lkfX08L3NwYW4+CgogICAgICA8cCBjbGFzcz0icm9sZS1kZXNjIj57e2Rlc2NyaXB0aW9ufX08L3A+CiAgICB7ey93aXRofX0KICA8L2Rpdj4KICBgYGAKCiAgIyMjIGBhc2Agb3BlcmF0b3IKCiAgVGhpcyBvcGVyYXRvciBhbGlhc2VzIHRoZSBzY29wZSB0byBhIG5ldyBuYW1lLiBJdCdzIGhlbHBmdWwgZm9yIHNlbWFudGljIGNsYXJpdHkgYW5kIHRvIHJldGFpbiAKICBkZWZhdWx0IHNjb3BlIG9yIHRvIHJlZmVyZW5jZSBmcm9tIGFub3RoZXIgYHt7d2l0aH19YCBibG9jay4KCiAgYGBgaGFuZGxlYmFycwogIC8vIHBvc3RzIG1pZ2h0IG5vdCBiZQogIHt7I3dpdGggdXNlci5wb3N0cyBhcyBibG9nUG9zdHN9fQogICAgPGRpdiBjbGFzcz0ibm90aWNlIj4KICAgICAgVGhlcmUgYXJlIHt7YmxvZ1Bvc3RzLmxlbmd0aH19IGJsb2cgcG9zdHMgd3JpdHRlbiBieSB7e3VzZXIubmFtZX19LgogICAgPC9kaXY+CgogICAge3sjZWFjaCBwb3N0IGluIGJsb2dQb3N0c319CiAgICAgIDxsaT57e3Bvc3QudGl0bGV9fTwvbGk+CiAgICB7ey9lYWNofX0KICB7ey93aXRofX0KICBgYGAKCiAgV2l0aG91dCB0aGUgYGFzYCBvcGVyYXRvciwgaXQgd291bGQgYmUgaW1wb3NzaWJsZSB0byByZWZlcmVuY2UgYHVzZXIubmFtZWAgaW4gdGhlIGV4YW1wbGUgYWJvdmUuCgogIEBtZXRob2Qgd2l0aAogIEBmb3IgRW1iZXIuSGFuZGxlYmFycy5oZWxwZXJzCiAgQHBhcmFtIHtGdW5jdGlvbn0gY29udGV4dAogIEBwYXJhbSB7SGFzaH0gb3B0aW9ucwogIEByZXR1cm4ge1N0cmluZ30gSFRNTCBzdHJpbmcKKi8KRW1iZXJIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd3aXRoJywgZnVuY3Rpb24gd2l0aEhlbHBlcihjb250ZXh0LCBvcHRpb25zKSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDQpIHsKICAgIHZhciBrZXl3b3JkTmFtZSwgcGF0aCwgcm9vdFBhdGgsIG5vcm1hbGl6ZWQsIGNvbnRleHRQYXRoOwoKICAgIEVtYmVyLmFzc2VydCgiSWYgeW91IHBhc3MgbW9yZSB0aGFuIG9uZSBhcmd1bWVudCB0byB0aGUgd2l0aCBoZWxwZXIsIGl0IG11c3QgYmUgaW4gdGhlIGZvcm0gI3dpdGggZm9vIGFzIGJhciIsIGFyZ3VtZW50c1sxXSA9PT0gImFzIik7CiAgICBvcHRpb25zID0gYXJndW1lbnRzWzNdOwogICAga2V5d29yZE5hbWUgPSBhcmd1bWVudHNbMl07CiAgICBwYXRoID0gYXJndW1lbnRzWzBdOwoKICAgIEVtYmVyLmFzc2VydCgiWW91IG11c3QgcGFzcyBhIGJsb2NrIHRvIHRoZSB3aXRoIGhlbHBlciIsIG9wdGlvbnMuZm4gJiYgb3B0aW9ucy5mbiAhPT0gSGFuZGxlYmFycy5WTS5ub29wKTsKCiAgICB2YXIgbG9jYWxpemVkT3B0aW9ucyA9IG9fY3JlYXRlKG9wdGlvbnMpOwogICAgbG9jYWxpemVkT3B0aW9ucy5kYXRhID0gb19jcmVhdGUob3B0aW9ucy5kYXRhKTsKICAgIGxvY2FsaXplZE9wdGlvbnMuZGF0YS5rZXl3b3JkcyA9IG9fY3JlYXRlKG9wdGlvbnMuZGF0YS5rZXl3b3JkcyB8fCB7fSk7CgogICAgaWYgKEVtYmVyLmlzR2xvYmFsUGF0aChwYXRoKSkgewogICAgICBjb250ZXh0UGF0aCA9IHBhdGg7CiAgICB9IGVsc2UgewogICAgICBub3JtYWxpemVkID0gbm9ybWFsaXplUGF0aCh0aGlzLCBwYXRoLCBvcHRpb25zLmRhdGEpOwogICAgICBwYXRoID0gbm9ybWFsaXplZC5wYXRoOwogICAgICByb290UGF0aCA9IG5vcm1hbGl6ZWQucm9vdDsKCiAgICAgIC8vIFRoaXMgaXMgYSB3b3JrYXJvdW5kIGZvciB0aGUgZmFjdCB0aGF0IHlvdSBjYW5ub3QgYmluZCBzZXBhcmF0ZSBvYmplY3RzCiAgICAgIC8vIHRvZ2V0aGVyLiBXaGVuIHdlIGltcGxlbWVudCB0aGF0IGZ1bmN0aW9uYWxpdHksIHdlIHNob3VsZCB1c2UgaXQgaGVyZS4KICAgICAgdmFyIGNvbnRleHRLZXkgPSBFbWJlci4kLmV4cGFuZG8gKyBFbWJlci5ndWlkRm9yKHJvb3RQYXRoKTsKICAgICAgbG9jYWxpemVkT3B0aW9ucy5kYXRhLmtleXdvcmRzW2NvbnRleHRLZXldID0gcm9vdFBhdGg7CiAgICAgIC8vIGlmIHRoZSBwYXRoIGlzICcnICgidGhpcyIpLCBqdXN0IGJpbmQgZGlyZWN0bHkgdG8gdGhlIGN1cnJlbnQgY29udGV4dAogICAgICBjb250ZXh0UGF0aCA9IHBhdGggPyBjb250ZXh0S2V5ICsgJy4nICsgcGF0aCA6IGNvbnRleHRLZXk7CiAgICB9CgogICAgRW1iZXIuYmluZChsb2NhbGl6ZWRPcHRpb25zLmRhdGEua2V5d29yZHMsIGtleXdvcmROYW1lLCBjb250ZXh0UGF0aCk7CgogICAgcmV0dXJuIGJpbmQuY2FsbCh0aGlzLCBwYXRoLCBsb2NhbGl6ZWRPcHRpb25zLCB0cnVlLCBleGlzdHMpOwogIH0gZWxzZSB7CiAgICBFbWJlci5hc3NlcnQoIllvdSBtdXN0IHBhc3MgZXhhY3RseSBvbmUgYXJndW1lbnQgdG8gdGhlIHdpdGggaGVscGVyIiwgYXJndW1lbnRzLmxlbmd0aCA9PT0gMik7CiAgICBFbWJlci5hc3NlcnQoIllvdSBtdXN0IHBhc3MgYSBibG9jayB0byB0aGUgd2l0aCBoZWxwZXIiLCBvcHRpb25zLmZuICYmIG9wdGlvbnMuZm4gIT09IEhhbmRsZWJhcnMuVk0ubm9vcCk7CiAgICByZXR1cm4gaGVscGVycy5iaW5kLmNhbGwob3B0aW9ucy5jb250ZXh0c1swXSwgY29udGV4dCwgb3B0aW9ucyk7CiAgfQp9KTsKCgovKioKICBTZWUgW2JvdW5kSWZdKC9hcGkvY2xhc3Nlcy9FbWJlci5IYW5kbGViYXJzLmhlbHBlcnMuaHRtbCNtZXRob2RfYm91bmRJZikKCiAgQG1ldGhvZCBpZgogIEBmb3IgRW1iZXIuSGFuZGxlYmFycy5oZWxwZXJzCiAgQHBhcmFtIHtGdW5jdGlvbn0gY29udGV4dAogIEBwYXJhbSB7SGFzaH0gb3B0aW9ucwogIEByZXR1cm4ge1N0cmluZ30gSFRNTCBzdHJpbmcKKi8KRW1iZXJIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpZicsIGZ1bmN0aW9uIGlmSGVscGVyKGNvbnRleHQsIG9wdGlvbnMpIHsKICBFbWJlci5hc3NlcnQoIllvdSBtdXN0IHBhc3MgZXhhY3RseSBvbmUgYXJndW1lbnQgdG8gdGhlIGlmIGhlbHBlciIsIGFyZ3VtZW50cy5sZW5ndGggPT09IDIpOwogIEVtYmVyLmFzc2VydCgiWW91IG11c3QgcGFzcyBhIGJsb2NrIHRvIHRoZSBpZiBoZWxwZXIiLCBvcHRpb25zLmZuICYmIG9wdGlvbnMuZm4gIT09IEhhbmRsZWJhcnMuVk0ubm9vcCk7CgogIHJldHVybiBoZWxwZXJzLmJvdW5kSWYuY2FsbChvcHRpb25zLmNvbnRleHRzWzBdLCBjb250ZXh0LCBvcHRpb25zKTsKfSk7CgovKioKICBAbWV0aG9kIHVubGVzcwogIEBmb3IgRW1iZXIuSGFuZGxlYmFycy5oZWxwZXJzCiAgQHBhcmFtIHtGdW5jdGlvbn0gY29udGV4dAogIEBwYXJhbSB7SGFzaH0gb3B0aW9ucwogIEByZXR1cm4ge1N0cmluZ30gSFRNTCBzdHJpbmcKKi8KRW1iZXJIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd1bmxlc3MnLCBmdW5jdGlvbiB1bmxlc3NIZWxwZXIoY29udGV4dCwgb3B0aW9ucykgewogIEVtYmVyLmFzc2VydCgiWW91IG11c3QgcGFzcyBleGFjdGx5IG9uZSBhcmd1bWVudCB0byB0aGUgdW5sZXNzIGhlbHBlciIsIGFyZ3VtZW50cy5sZW5ndGggPT09IDIpOwogIEVtYmVyLmFzc2VydCgiWW91IG11c3QgcGFzcyBhIGJsb2NrIHRvIHRoZSB1bmxlc3MgaGVscGVyIiwgb3B0aW9ucy5mbiAmJiBvcHRpb25zLmZuICE9PSBIYW5kbGViYXJzLlZNLm5vb3ApOwoKICB2YXIgZm4gPSBvcHRpb25zLmZuLCBpbnZlcnNlID0gb3B0aW9ucy5pbnZlcnNlOwoKICBvcHRpb25zLmZuID0gaW52ZXJzZTsKICBvcHRpb25zLmludmVyc2UgPSBmbjsKCiAgcmV0dXJuIGhlbHBlcnMuYm91bmRJZi5jYWxsKG9wdGlvbnMuY29udGV4dHNbMF0sIGNvbnRleHQsIG9wdGlvbnMpOwp9KTsKCi8qKgogIGBiaW5kLWF0dHJgIGFsbG93cyB5b3UgdG8gY3JlYXRlIGEgYmluZGluZyBiZXR3ZWVuIERPTSBlbGVtZW50IGF0dHJpYnV0ZXMgYW5kCiAgRW1iZXIgb2JqZWN0cy4gRm9yIGV4YW1wbGU6CgogIGBgYGhhbmRsZWJhcnMKICA8aW1nIHt7YmluZC1hdHRyIHNyYz0iaW1hZ2VVcmwiIGFsdD0iaW1hZ2VUaXRsZSJ9fT4KICBgYGAKCiAgVGhlIGFib3ZlIGhhbmRsZWJhcnMgdGVtcGxhdGUgd2lsbCBmaWxsIHRoZSBgPGltZz5gJ3MgYHNyY2AgYXR0cmlidXRlIHdpbGwKICB0aGUgdmFsdWUgb2YgdGhlIHByb3BlcnR5IHJlZmVyZW5jZWQgd2l0aCBgImltYWdlVXJsImAgYW5kIGl0cyBgYWx0YAogIGF0dHJpYnV0ZSB3aXRoIHRoZSB2YWx1ZSBvZiB0aGUgcHJvcGVydHkgcmVmZXJlbmNlZCB3aXRoIGAiaW1hZ2VUaXRsZSJgLgoKICBJZiB0aGUgcmVuZGVyaW5nIGNvbnRleHQgb2YgdGhpcyB0ZW1wbGF0ZSBpcyB0aGUgZm9sbG93aW5nIG9iamVjdDoKCiAgYGBgamF2YXNjcmlwdAogIHsKICAgIGltYWdlVXJsOiAnaHR0cDovL2xvbGNhdHMuaW5mby9oYXotYS1mdW5ueScsCiAgICBpbWFnZVRpdGxlOiAnQSBodW1vcm91cyBpbWFnZSBvZiBhIGNhdCcKICB9CiAgYGBgCgogIFRoZSByZXN1bHRpbmcgSFRNTCBvdXRwdXQgd2lsbCBiZToKCiAgYGBgaHRtbAogIDxpbWcgc3JjPSJodHRwOi8vbG9sY2F0cy5pbmZvL2hhei1hLWZ1bm55IiBhbHQ9IkEgaHVtb3JvdXMgaW1hZ2Ugb2YgYSBjYXQiPgogIGBgYAoKICBgYmluZC1hdHRyYCBjYW5ub3QgcmVkZWNsYXJlIGV4aXN0aW5nIERPTSBlbGVtZW50IGF0dHJpYnV0ZXMuIFRoZSB1c2Ugb2YgYHNyY2AKICBpbiB0aGUgZm9sbG93aW5nIGBiaW5kLWF0dHJgIGV4YW1wbGUgd2lsbCBiZSBpZ25vcmVkIGFuZCB0aGUgaGFyZCBjb2RlZCB2YWx1ZQogIG9mIGBzcmM9Ii9mYWlsd2hhbGUuZ2lmImAgd2lsbCB0YWtlIHByZWNlZGVuY2U6CgogIGBgYGhhbmRsZWJhcnMKICA8aW1nIHNyYz0iL2ZhaWx3aGFsZS5naWYiIHt7YmluZC1hdHRyIHNyYz0iaW1hZ2VVcmwiIGFsdD0iaW1hZ2VUaXRsZSJ9fT4KICBgYGAKCiAgIyMjIGBiaW5kLWF0dHJgIGFuZCB0aGUgYGNsYXNzYCBhdHRyaWJ1dGUKCiAgYGJpbmQtYXR0cmAgc3VwcG9ydHMgYSBzcGVjaWFsIHN5bnRheCBmb3IgaGFuZGxpbmcgYSBudW1iZXIgb2YgY2FzZXMgdW5pcXVlCiAgdG8gdGhlIGBjbGFzc2AgRE9NIGVsZW1lbnQgYXR0cmlidXRlLiBUaGUgYGNsYXNzYCBhdHRyaWJ1dGUgY29tYmluZXMKICBtdWx0aXBsZSBkaXNjcmV0ZSB2YWx1ZXMgaW50byBhIHNpbmdsZSBhdHRyaWJ1dGUgYXMgYSBzcGFjZS1kZWxpbWl0ZWQKICBsaXN0IG9mIHN0cmluZ3MuIEVhY2ggc3RyaW5nIGNhbiBiZToKCiAgKiBhIHN0cmluZyByZXR1cm4gdmFsdWUgb2YgYW4gb2JqZWN0J3MgcHJvcGVydHkuCiAgKiBhIGJvb2xlYW4gcmV0dXJuIHZhbHVlIG9mIGFuIG9iamVjdCdzIHByb3BlcnR5CiAgKiBhIGhhcmQtY29kZWQgdmFsdWUKCiAgQSBzdHJpbmcgcmV0dXJuIHZhbHVlIHdvcmtzIGlkZW50aWNhbGx5IHRvIG90aGVyIHVzZXMgb2YgYGJpbmQtYXR0cmAuIFRoZQogIHJldHVybiB2YWx1ZSBvZiB0aGUgcHJvcGVydHkgd2lsbCBiZWNvbWUgdGhlIHZhbHVlIG9mIHRoZSBhdHRyaWJ1dGUuIEZvcgogIGV4YW1wbGUsIHRoZSBmb2xsb3dpbmcgdmlldyBhbmQgdGVtcGxhdGU6CgogIGBgYGphdmFzY3JpcHQKICAgIEFWaWV3ID0gRW1iZXIuVmlldy5leHRlbmQoewogICAgICBzb21lUHJvcGVydHk6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiAiYVZhbHVlIjsKICAgICAgfS5wcm9wZXJ0eSgpCiAgICB9KQogIGBgYAoKICBgYGBoYW5kbGViYXJzCiAgPGltZyB7e2JpbmQtYXR0ciBjbGFzcz0idmlldy5zb21lUHJvcGVydHl9fT4KICBgYGAKCiAgUmVzdWx0IGluIHRoZSBmb2xsb3dpbmcgcmVuZGVyZWQgb3V0cHV0OgoKICBgYGBodG1sCiAgPGltZyBjbGFzcz0iYVZhbHVlIj4KICBgYGAKCiAgQSBib29sZWFuIHJldHVybiB2YWx1ZSB3aWxsIGluc2VydCBhIHNwZWNpZmllZCBjbGFzcyBuYW1lIGlmIHRoZSBwcm9wZXJ0eQogIHJldHVybnMgYHRydWVgIGFuZCByZW1vdmUgdGhlIGNsYXNzIG5hbWUgaWYgdGhlIHByb3BlcnR5IHJldHVybnMgYGZhbHNlYC4KCiAgQSBjbGFzcyBuYW1lIGlzIHByb3ZpZGVkIHZpYSB0aGUgc3ludGF4CiAgYHNvbWVQcm9wZXJ0eU5hbWU6Y2xhc3MtbmFtZS1pZi10cnVlYC4KCiAgYGBgamF2YXNjcmlwdAogIEFWaWV3ID0gRW1iZXIuVmlldy5leHRlbmQoewogICAgc29tZUJvb2w6IHRydWUKICB9KQogIGBgYAoKICBgYGBoYW5kbGViYXJzCiAgPGltZyB7e2JpbmQtYXR0ciBjbGFzcz0idmlldy5zb21lQm9vbDpjbGFzcy1uYW1lLWlmLXRydWUifX0+CiAgYGBgCgogIFJlc3VsdCBpbiB0aGUgZm9sbG93aW5nIHJlbmRlcmVkIG91dHB1dDoKCiAgYGBgaHRtbAogIDxpbWcgY2xhc3M9ImNsYXNzLW5hbWUtaWYtdHJ1ZSI+CiAgYGBgCgogIEFuIGFkZGl0aW9uYWwgc2VjdGlvbiBvZiB0aGUgYmluZGluZyBjYW4gYmUgcHJvdmlkZWQgaWYgeW91IHdhbnQgdG8KICByZXBsYWNlIHRoZSBleGlzdGluZyBjbGFzcyBpbnN0ZWFkIG9mIHJlbW92aW5nIGl0IHdoZW4gdGhlIGJvb2xlYW4KICB2YWx1ZSBjaGFuZ2VzOgoKICBgYGBoYW5kbGViYXJzCiAgPGltZyB7e2JpbmQtYXR0ciBjbGFzcz0idmlldy5zb21lQm9vbDpjbGFzcy1uYW1lLWlmLXRydWU6Y2xhc3MtbmFtZS1pZi1mYWxzZSJ9fT4KICBgYGAKCiAgQSBoYXJkLWNvZGVkIHZhbHVlIGNhbiBiZSB1c2VkIGJ5IHByZXBlbmRpbmcgYDpgIHRvIHRoZSBkZXNpcmVkCiAgY2xhc3MgbmFtZTogYDpjbGFzcy1uYW1lLXRvLWFsd2F5cy1hcHBseWAuCgogIGBgYGhhbmRsZWJhcnMKICA8aW1nIHt7YmluZC1hdHRyIGNsYXNzPSI6Y2xhc3MtbmFtZS10by1hbHdheXMtYXBwbHkifX0+CiAgYGBgCgogIFJlc3VsdHMgaW4gdGhlIGZvbGxvd2luZyByZW5kZXJlZCBvdXRwdXQ6CgogIGBgYGh0bWwKICA8aW1nIGNsYXNzPSJjbGFzcy1uYW1lLXRvLWFsd2F5cy1hcHBseSI+CiAgYGBgCgogIEFsbCB0aHJlZSBzdHJhdGVnaWVzIC0gc3RyaW5nIHJldHVybiB2YWx1ZSwgYm9vbGVhbiByZXR1cm4gdmFsdWUsIGFuZAogIGhhcmQtY29kZWQgdmFsdWUg4oCTIGNhbiBiZSBjb21iaW5lZCBpbiBhIHNpbmdsZSBkZWNsYXJhdGlvbjoKCiAgYGBgaGFuZGxlYmFycwogIDxpbWcge3tiaW5kLWF0dHIgY2xhc3M9IjpjbGFzcy1uYW1lLXRvLWFsd2F5cy1hcHBseSB2aWV3LnNvbWVCb29sOmNsYXNzLW5hbWUtaWYtdHJ1ZSB2aWV3LnNvbWVQcm9wZXJ0eSJ9fT4KICBgYGAKCiAgQG1ldGhvZCBiaW5kLWF0dHIKICBAZm9yIEVtYmVyLkhhbmRsZWJhcnMuaGVscGVycwogIEBwYXJhbSB7SGFzaH0gb3B0aW9ucwogIEByZXR1cm4ge1N0cmluZ30gSFRNTCBzdHJpbmcKKi8KRW1iZXJIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdiaW5kLWF0dHInLCBmdW5jdGlvbiBiaW5kQXR0ckhlbHBlcihvcHRpb25zKSB7CgogIHZhciBhdHRycyA9IG9wdGlvbnMuaGFzaDsKCiAgRW1iZXIuYXNzZXJ0KCJZb3UgbXVzdCBzcGVjaWZ5IGF0IGxlYXN0IG9uZSBoYXNoIGFyZ3VtZW50IHRvIGJpbmQtYXR0ciIsICEhRW1iZXIua2V5cyhhdHRycykubGVuZ3RoKTsKCiAgdmFyIHZpZXcgPSBvcHRpb25zLmRhdGEudmlldzsKICB2YXIgcmV0ID0gW107CiAgdmFyIGN0eCA9IHRoaXM7CgogIC8vIEdlbmVyYXRlIGEgdW5pcXVlIGlkIGZvciB0aGlzIGVsZW1lbnQuIFRoaXMgd2lsbCBiZSBhZGRlZCBhcyBhCiAgLy8gZGF0YSBhdHRyaWJ1dGUgdG8gdGhlIGVsZW1lbnQgc28gaXQgY2FuIGJlIGxvb2tlZCB1cCB3aGVuCiAgLy8gdGhlIGJvdW5kIHByb3BlcnR5IGNoYW5nZXMuCiAgdmFyIGRhdGFJZCA9ICsrRW1iZXIudXVpZDsKCiAgLy8gSGFuZGxlIGNsYXNzZXMgZGlmZmVyZW50bHksIGFzIHdlIGNhbiBiaW5kIG11bHRpcGxlIGNsYXNzZXMKICB2YXIgY2xhc3NCaW5kaW5ncyA9IGF0dHJzWydjbGFzcyddOwogIGlmIChjbGFzc0JpbmRpbmdzICE9IG51bGwpIHsKICAgIHZhciBjbGFzc1Jlc3VsdHMgPSBFbWJlckhhbmRsZWJhcnMuYmluZENsYXNzZXModGhpcywgY2xhc3NCaW5kaW5ncywgdmlldywgZGF0YUlkLCBvcHRpb25zKTsKCiAgICByZXQucHVzaCgnY2xhc3M9IicgKyBIYW5kbGViYXJzLlV0aWxzLmVzY2FwZUV4cHJlc3Npb24oY2xhc3NSZXN1bHRzLmpvaW4oJyAnKSkgKyAnIicpOwogICAgZGVsZXRlIGF0dHJzWydjbGFzcyddOwogIH0KCiAgdmFyIGF0dHJLZXlzID0gRW1iZXIua2V5cyhhdHRycyk7CgogIC8vIEZvciBlYWNoIGF0dHJpYnV0ZSBwYXNzZWQsIGNyZWF0ZSBhbiBvYnNlcnZlciBhbmQgZW1pdCB0aGUKICAvLyBjdXJyZW50IHZhbHVlIG9mIHRoZSBwcm9wZXJ0eSBhcyBhbiBhdHRyaWJ1dGUuCiAgZm9yRWFjaC5jYWxsKGF0dHJLZXlzLCBmdW5jdGlvbihhdHRyKSB7CiAgICB2YXIgcGF0aCA9IGF0dHJzW2F0dHJdLAogICAgICAgIG5vcm1hbGl6ZWQ7CgogICAgRW1iZXIuYXNzZXJ0KGZtdCgiWW91IG11c3QgcHJvdmlkZSBhbiBleHByZXNzaW9uIGFzIHRoZSB2YWx1ZSBvZiBib3VuZCBhdHRyaWJ1dGUuIFlvdSBzcGVjaWZpZWQ6ICVAPSVAIiwgW2F0dHIsIHBhdGhdKSwgdHlwZW9mIHBhdGggPT09ICdzdHJpbmcnKTsKCiAgICBub3JtYWxpemVkID0gbm9ybWFsaXplUGF0aChjdHgsIHBhdGgsIG9wdGlvbnMuZGF0YSk7CgogICAgdmFyIHZhbHVlID0gKHBhdGggPT09ICd0aGlzJykgPyBub3JtYWxpemVkLnJvb3QgOiBoYW5kbGViYXJzR2V0KGN0eCwgcGF0aCwgb3B0aW9ucyksCiAgICAgICAgdHlwZSA9IEVtYmVyLnR5cGVPZih2YWx1ZSk7CgogICAgRW1iZXIuYXNzZXJ0KGZtdCgiQXR0cmlidXRlcyBtdXN0IGJlIG51bWJlcnMsIHN0cmluZ3Mgb3IgYm9vbGVhbnMsIG5vdCAlQCIsIFt2YWx1ZV0pLCB2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHR5cGUgPT09ICdudW1iZXInIHx8IHR5cGUgPT09ICdzdHJpbmcnIHx8IHR5cGUgPT09ICdib29sZWFuJyk7CgogICAgdmFyIG9ic2VydmVyLCBpbnZva2VyOwoKICAgIG9ic2VydmVyID0gZnVuY3Rpb24gb2JzZXJ2ZXIoKSB7CiAgICAgIHZhciByZXN1bHQgPSBoYW5kbGViYXJzR2V0KGN0eCwgcGF0aCwgb3B0aW9ucyk7CgogICAgICBFbWJlci5hc3NlcnQoZm10KCJBdHRyaWJ1dGVzIG11c3QgYmUgbnVtYmVycywgc3RyaW5ncyBvciBib29sZWFucywgbm90ICVAIiwgW3Jlc3VsdF0pLAogICAgICAgICAgICAgICAgICAgcmVzdWx0ID09PSBudWxsIHx8IHJlc3VsdCA9PT0gdW5kZWZpbmVkIHx8IHR5cGVvZiByZXN1bHQgPT09ICdudW1iZXInIHx8CiAgICAgICAgICAgICAgICAgICAgIHR5cGVvZiByZXN1bHQgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiByZXN1bHQgPT09ICdib29sZWFuJyk7CgogICAgICB2YXIgZWxlbSA9IHZpZXcuJCgiW2RhdGEtYmluZGF0dHItIiArIGRhdGFJZCArICI9JyIgKyBkYXRhSWQgKyAiJ10iKTsKCiAgICAgIC8vIElmIHdlIGFyZW4ndCBhYmxlIHRvIGZpbmQgdGhlIGVsZW1lbnQsIGl0IG1lYW5zIHRoZSBlbGVtZW50CiAgICAgIC8vIHRvIHdoaWNoIHdlIHdlcmUgYm91bmQgaGFzIGJlZW4gcmVtb3ZlZCBmcm9tIHRoZSB2aWV3LgogICAgICAvLyBJbiB0aGF0IGNhc2UsIHdlIGNhbiBhc3N1bWUgdGhlIHRlbXBsYXRlIGhhcyBiZWVuIHJlLXJlbmRlcmVkCiAgICAgIC8vIGFuZCB3ZSBuZWVkIHRvIGNsZWFuIHVwIHRoZSBvYnNlcnZlci4KICAgICAgaWYgKCFlbGVtIHx8IGVsZW0ubGVuZ3RoID09PSAwKSB7CiAgICAgICAgRW1iZXIucmVtb3ZlT2JzZXJ2ZXIobm9ybWFsaXplZC5yb290LCBub3JtYWxpemVkLnBhdGgsIGludm9rZXIpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgRW1iZXIuVmlldy5hcHBseUF0dHJpYnV0ZUJpbmRpbmdzKGVsZW0sIGF0dHIsIHJlc3VsdCk7CiAgICB9OwoKICAgIC8vIEFkZCBhbiBvYnNlcnZlciB0byB0aGUgdmlldyBmb3Igd2hlbiB0aGUgcHJvcGVydHkgY2hhbmdlcy4KICAgIC8vIFdoZW4gdGhlIG9ic2VydmVyIGZpcmVzLCBmaW5kIHRoZSBlbGVtZW50IHVzaW5nIHRoZQogICAgLy8gdW5pcXVlIGRhdGEgaWQgYW5kIHVwZGF0ZSB0aGUgYXR0cmlidXRlIHRvIHRoZSBuZXcgdmFsdWUuCiAgICAvLyBOb3RlOiBkb24ndCBhZGQgb2JzZXJ2ZXIgd2hlbiBwYXRoIGlzICd0aGlzJyBvciBwYXRoCiAgICAvLyBpcyB3aG9sZSBrZXl3b3JkIGUuZy4ge3sjZWFjaCB4IGluIGxpc3R9fSAuLi4ge3tiaW5kLWF0dHIgYXR0cj0ieCJ9fQogICAgaWYgKHBhdGggIT09ICd0aGlzJyAmJiAhKG5vcm1hbGl6ZWQuaXNLZXl3b3JkICYmIG5vcm1hbGl6ZWQucGF0aCA9PT0gJycgKSkgewogICAgICB2aWV3LnJlZ2lzdGVyT2JzZXJ2ZXIobm9ybWFsaXplZC5yb290LCBub3JtYWxpemVkLnBhdGgsIG9ic2VydmVyKTsKICAgIH0KCiAgICAvLyBpZiB0aGlzIGNoYW5nZXMsIGFsc28gY2hhbmdlIHRoZSBsb2dpYyBpbiBlbWJlci12aWV3cy9saWIvdmlld3Mvdmlldy5qcwogICAgaWYgKCh0eXBlID09PSAnc3RyaW5nJyB8fCAodHlwZSA9PT0gJ251bWJlcicgJiYgIWlzTmFOKHZhbHVlKSkpKSB7CiAgICAgIHJldC5wdXNoKGF0dHIgKyAnPSInICsgSGFuZGxlYmFycy5VdGlscy5lc2NhcGVFeHByZXNzaW9uKHZhbHVlKSArICciJyk7CiAgICB9IGVsc2UgaWYgKHZhbHVlICYmIHR5cGUgPT09ICdib29sZWFuJykgewogICAgICAvLyBUaGUgZGV2ZWxvcGVyIGNvbnRyb2xzIHRoZSBhdHRyIG5hbWUsIHNvIGl0IHNob3VsZCBhbHdheXMgYmUgc2FmZQogICAgICByZXQucHVzaChhdHRyICsgJz0iJyArIGF0dHIgKyAnIicpOwogICAgfQogIH0sIHRoaXMpOwoKICAvLyBBZGQgdGhlIHVuaXF1ZSBpZGVudGlmaWVyCiAgLy8gTk9URTogV2UgdXNlIGFsbCBsb3dlci1jYXNlIHNpbmNlIEZpcmVmb3ggaGFzIHByb2JsZW1zIHdpdGggbWl4ZWQgY2FzZSBpbiBTVkcKICByZXQucHVzaCgnZGF0YS1iaW5kYXR0ci0nICsgZGF0YUlkICsgJz0iJyArIGRhdGFJZCArICciJyk7CiAgcmV0dXJuIG5ldyBFbWJlckhhbmRsZWJhcnMuU2FmZVN0cmluZyhyZXQuam9pbignICcpKTsKfSk7CgovKioKICBTZWUgYGJpbmQtYXR0cmAKCiAgQG1ldGhvZCBiaW5kQXR0cgogIEBmb3IgRW1iZXIuSGFuZGxlYmFycy5oZWxwZXJzCiAgQGRlcHJlY2F0ZWQKICBAcGFyYW0ge0Z1bmN0aW9ufSBjb250ZXh0CiAgQHBhcmFtIHtIYXNofSBvcHRpb25zCiAgQHJldHVybiB7U3RyaW5nfSBIVE1MIHN0cmluZwoqLwpFbWJlckhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2JpbmRBdHRyJywgZnVuY3Rpb24gYmluZEF0dHJIZWxwZXIoKSB7CiAgRW1iZXIud2FybigiVGhlICdiaW5kQXR0cicgdmlldyBoZWxwZXIgaXMgZGVwcmVjYXRlZCBpbiBmYXZvciBvZiAnYmluZC1hdHRyJyIpOwogIHJldHVybiBFbWJlckhhbmRsZWJhcnMuaGVscGVyc1snYmluZC1hdHRyJ10uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfSk7CgovKioKICBIZWxwZXIgdGhhdCwgZ2l2ZW4gYSBzcGFjZS1zZXBhcmF0ZWQgc3RyaW5nIG9mIHByb3BlcnR5IHBhdGhzIGFuZCBhIGNvbnRleHQsCiAgcmV0dXJucyBhbiBhcnJheSBvZiBjbGFzcyBuYW1lcy4gQ2FsbGluZyB0aGlzIG1ldGhvZCBhbHNvIGhhcyB0aGUgc2lkZQogIGVmZmVjdCBvZiBzZXR0aW5nIHVwIG9ic2VydmVycyBhdCB0aG9zZSBwcm9wZXJ0eSBwYXRocywgc3VjaCB0aGF0IGlmIHRoZXkKICBjaGFuZ2UsIHRoZSBjb3JyZWN0IGNsYXNzIG5hbWUgd2lsbCBiZSByZWFwcGxpZWQgdG8gdGhlIERPTSBlbGVtZW50LgoKICBGb3IgZXhhbXBsZSwgaWYgeW91IHBhc3MgdGhlIHN0cmluZyAiZm9vQmFyIiwgaXQgd2lsbCBmaXJzdCBsb29rIHVwIHRoZQogICJmb29CYXIiIHZhbHVlIG9mIHRoZSBjb250ZXh0LiBJZiB0aGF0IHZhbHVlIGlzIHRydWUsIGl0IHdpbGwgYWRkIHRoZQogICJmb28tYmFyIiBjbGFzcyB0byB0aGUgY3VycmVudCBlbGVtZW50IChpLmUuLCB0aGUgZGFzaGVyaXplZCBmb3JtIG9mCiAgImZvb0JhciIpLiBJZiB0aGUgdmFsdWUgaXMgYSBzdHJpbmcsIGl0IHdpbGwgYWRkIHRoYXQgc3RyaW5nIGFzIHRoZSBjbGFzcy4KICBPdGhlcndpc2UsIGl0IHdpbGwgbm90IGFkZCBhbnkgbmV3IGNsYXNzIG5hbWUuCgogIEBwcml2YXRlCiAgQG1ldGhvZCBiaW5kQ2xhc3NlcwogIEBmb3IgRW1iZXIuSGFuZGxlYmFycwogIEBwYXJhbSB7RW1iZXIuT2JqZWN0fSBjb250ZXh0IFRoZSBjb250ZXh0IGZyb20gd2hpY2ggdG8gbG9va3VwIHByb3BlcnRpZXMKICBAcGFyYW0ge1N0cmluZ30gY2xhc3NCaW5kaW5ncyBBIHN0cmluZywgc3BhY2Utc2VwYXJhdGVkLCBvZiBjbGFzcyBiaW5kaW5ncwogICAgdG8gdXNlCiAgQHBhcmFtIHtFbWJlci5WaWV3fSB2aWV3IFRoZSB2aWV3IGluIHdoaWNoIG9ic2VydmVycyBzaG91bGQgbG9vayBmb3IgdGhlCiAgICBlbGVtZW50IHRvIHVwZGF0ZQogIEBwYXJhbSB7U3J0aW5nfSBiaW5kQXR0cklkIE9wdGlvbmFsIGJpbmRBdHRyIGlkIHVzZWQgdG8gbG9va3VwIGVsZW1lbnRzCiAgQHJldHVybiB7QXJyYXl9IEFuIGFycmF5IG9mIGNsYXNzIG5hbWVzIHRvIGFkZAoqLwpFbWJlckhhbmRsZWJhcnMuYmluZENsYXNzZXMgPSBmdW5jdGlvbihjb250ZXh0LCBjbGFzc0JpbmRpbmdzLCB2aWV3LCBiaW5kQXR0cklkLCBvcHRpb25zKSB7CiAgdmFyIHJldCA9IFtdLCBuZXdDbGFzcywgdmFsdWUsIGVsZW07CgogIC8vIEhlbHBlciBtZXRob2QgdG8gcmV0cmlldmUgdGhlIHByb3BlcnR5IGZyb20gdGhlIGNvbnRleHQgYW5kCiAgLy8gZGV0ZXJtaW5lIHdoaWNoIGNsYXNzIHN0cmluZyB0byByZXR1cm4sIGJhc2VkIG9uIHdoZXRoZXIgaXQgaXMKICAvLyBhIEJvb2xlYW4gb3Igbm90LgogIHZhciBjbGFzc1N0cmluZ0ZvclBhdGggPSBmdW5jdGlvbihyb290LCBwYXJzZWRQYXRoLCBvcHRpb25zKSB7CiAgICB2YXIgdmFsLAogICAgICAgIHBhdGggPSBwYXJzZWRQYXRoLnBhdGg7CgogICAgaWYgKHBhdGggPT09ICd0aGlzJykgewogICAgICB2YWwgPSByb290OwogICAgfSBlbHNlIGlmIChwYXRoID09PSAnJykgewogICAgICB2YWwgPSB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgdmFsID0gaGFuZGxlYmFyc0dldChyb290LCBwYXRoLCBvcHRpb25zKTsKICAgIH0KCiAgICByZXR1cm4gRW1iZXIuVmlldy5fY2xhc3NTdHJpbmdGb3JWYWx1ZShwYXRoLCB2YWwsIHBhcnNlZFBhdGguY2xhc3NOYW1lLCBwYXJzZWRQYXRoLmZhbHN5Q2xhc3NOYW1lKTsKICB9OwoKICAvLyBGb3IgZWFjaCBwcm9wZXJ0eSBwYXNzZWQsIGxvb3AgdGhyb3VnaCBhbmQgc2V0dXAKICAvLyBhbiBvYnNlcnZlci4KICBmb3JFYWNoLmNhbGwoY2xhc3NCaW5kaW5ncy5zcGxpdCgnICcpLCBmdW5jdGlvbihiaW5kaW5nKSB7CgogICAgLy8gVmFyaWFibGUgaW4gd2hpY2ggdGhlIG9sZCBjbGFzcyB2YWx1ZSBpcyBzYXZlZC4gVGhlIG9ic2VydmVyIGZ1bmN0aW9uCiAgICAvLyBjbG9zZXMgb3ZlciB0aGlzIHZhcmlhYmxlLCBzbyBpdCBrbm93cyB3aGljaCBzdHJpbmcgdG8gcmVtb3ZlIHdoZW4KICAgIC8vIHRoZSBwcm9wZXJ0eSBjaGFuZ2VzLgogICAgdmFyIG9sZENsYXNzOwoKICAgIHZhciBvYnNlcnZlciwgaW52b2tlcjsKCiAgICB2YXIgcGFyc2VkUGF0aCA9IEVtYmVyLlZpZXcuX3BhcnNlUHJvcGVydHlQYXRoKGJpbmRpbmcpLAogICAgICAgIHBhdGggPSBwYXJzZWRQYXRoLnBhdGgsCiAgICAgICAgcGF0aFJvb3QgPSBjb250ZXh0LAogICAgICAgIG5vcm1hbGl6ZWQ7CgogICAgaWYgKHBhdGggIT09ICcnICYmIHBhdGggIT09ICd0aGlzJykgewogICAgICBub3JtYWxpemVkID0gbm9ybWFsaXplUGF0aChjb250ZXh0LCBwYXRoLCBvcHRpb25zLmRhdGEpOwoKICAgICAgcGF0aFJvb3QgPSBub3JtYWxpemVkLnJvb3Q7CiAgICAgIHBhdGggPSBub3JtYWxpemVkLnBhdGg7CiAgICB9CgogICAgLy8gU2V0IHVwIGFuIG9ic2VydmVyIG9uIHRoZSBjb250ZXh0LiBJZiB0aGUgcHJvcGVydHkgY2hhbmdlcywgdG9nZ2xlIHRoZQogICAgLy8gY2xhc3MgbmFtZS4KICAgIG9ic2VydmVyID0gZnVuY3Rpb24oKSB7CiAgICAgIC8vIEdldCB0aGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgcHJvcGVydHkKICAgICAgbmV3Q2xhc3MgPSBjbGFzc1N0cmluZ0ZvclBhdGgoY29udGV4dCwgcGFyc2VkUGF0aCwgb3B0aW9ucyk7CiAgICAgIGVsZW0gPSBiaW5kQXR0cklkID8gdmlldy4kKCJbZGF0YS1iaW5kYXR0ci0iICsgYmluZEF0dHJJZCArICI9JyIgKyBiaW5kQXR0cklkICsgIiddIikgOiB2aWV3LiQoKTsKCiAgICAgIC8vIElmIHdlIGNhbid0IGZpbmQgdGhlIGVsZW1lbnQgYW55bW9yZSwgYSBwYXJlbnQgdGVtcGxhdGUgaGFzIGJlZW4KICAgICAgLy8gcmUtcmVuZGVyZWQgYW5kIHdlJ3ZlIGJlZW4gbnVrZWQuIFJlbW92ZSB0aGUgb2JzZXJ2ZXIuCiAgICAgIGlmICghZWxlbSB8fCBlbGVtLmxlbmd0aCA9PT0gMCkgewogICAgICAgIEVtYmVyLnJlbW92ZU9ic2VydmVyKHBhdGhSb290LCBwYXRoLCBpbnZva2VyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBJZiB3ZSBoYWQgcHJldmlvdXNseSBhZGRlZCBhIGNsYXNzIHRvIHRoZSBlbGVtZW50LCByZW1vdmUgaXQuCiAgICAgICAgaWYgKG9sZENsYXNzKSB7CiAgICAgICAgICBlbGVtLnJlbW92ZUNsYXNzKG9sZENsYXNzKTsKICAgICAgICB9CgogICAgICAgIC8vIElmIG5lY2Vzc2FyeSwgYWRkIGEgbmV3IGNsYXNzLiBNYWtlIHN1cmUgd2Uga2VlcCB0cmFjayBvZiBpdCBzbwogICAgICAgIC8vIGl0IGNhbiBiZSByZW1vdmVkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgaWYgKG5ld0NsYXNzKSB7CiAgICAgICAgICBlbGVtLmFkZENsYXNzKG5ld0NsYXNzKTsKICAgICAgICAgIG9sZENsYXNzID0gbmV3Q2xhc3M7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9sZENsYXNzID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgaWYgKHBhdGggIT09ICcnICYmIHBhdGggIT09ICd0aGlzJykgewogICAgICB2aWV3LnJlZ2lzdGVyT2JzZXJ2ZXIocGF0aFJvb3QsIHBhdGgsIG9ic2VydmVyKTsKICAgIH0KCiAgICAvLyBXZSd2ZSBhbHJlYWR5IHNldHVwIHRoZSBvYnNlcnZlcjsgbm93IHdlIGp1c3QgbmVlZCB0byBmaWd1cmUgb3V0IHRoZQogICAgLy8gY29ycmVjdCBiZWhhdmlvciByaWdodCBub3cgb24gdGhlIGZpcnN0IHBhc3MgdGhyb3VnaC4KICAgIHZhbHVlID0gY2xhc3NTdHJpbmdGb3JQYXRoKGNvbnRleHQsIHBhcnNlZFBhdGgsIG9wdGlvbnMpOwoKICAgIGlmICh2YWx1ZSkgewogICAgICByZXQucHVzaCh2YWx1ZSk7CgogICAgICAvLyBNYWtlIHN1cmUgd2Ugc2F2ZSB0aGUgY3VycmVudCB2YWx1ZSBzbyB0aGF0IGl0IGNhbiBiZSByZW1vdmVkIGlmIHRoZQogICAgICAvLyBvYnNlcnZlciBmaXJlcy4KICAgICAgb2xkQ2xhc3MgPSB2YWx1ZTsKICAgIH0KICB9KTsKCiAgcmV0dXJuIHJldDsKfTsKCgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qZ2xvYmFscyBIYW5kbGViYXJzICovCgovLyBUT0RPOiBEb24ndCByZXF1aXJlIHRoZSBlbnRpcmUgbW9kdWxlCi8qKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItaGFuZGxlYmFycwoqLwoKdmFyIGdldCA9IEVtYmVyLmdldCwgc2V0ID0gRW1iZXIuc2V0Owp2YXIgRW1iZXJIYW5kbGViYXJzID0gRW1iZXIuSGFuZGxlYmFyczsKdmFyIExPV0VSQ0FTRV9BX1ogPSAvXlthLXpdLzsKdmFyIFZJRVdfUFJFRklYID0gL152aWV3XC4vOwoKZnVuY3Rpb24gbWFrZUJpbmRpbmdzKHRoaXNDb250ZXh0LCBvcHRpb25zKSB7CiAgdmFyIGhhc2ggPSBvcHRpb25zLmhhc2gsCiAgICAgIGhhc2hUeXBlID0gb3B0aW9ucy5oYXNoVHlwZXM7CgogIGZvciAodmFyIHByb3AgaW4gaGFzaCkgewogICAgaWYgKGhhc2hUeXBlW3Byb3BdID09PSAnSUQnKSB7CgogICAgICB2YXIgdmFsdWUgPSBoYXNoW3Byb3BdOwoKICAgICAgaWYgKEVtYmVyLklTX0JJTkRJTkcudGVzdChwcm9wKSkgewogICAgICAgIEVtYmVyLndhcm4oIllvdSdyZSBhdHRlbXB0aW5nIHRvIHJlbmRlciBhIHZpZXcgYnkgcGFzc2luZyAiICsgcHJvcCArICI9IiArIHZhbHVlICsgIiB0byBhIHZpZXcgaGVscGVyLCBidXQgdGhpcyBzeW50YXggaXMgYW1iaWd1b3VzLiBZb3Ugc2hvdWxkIGVpdGhlciBzdXJyb3VuZCAiICsgdmFsdWUgKyAiIGluIHF1b3RlcyBvciByZW1vdmUgYEJpbmRpbmdgIGZyb20gIiArIHByb3AgKyAiLiIpOwogICAgICB9IGVsc2UgewogICAgICAgIGhhc2hbcHJvcCArICdCaW5kaW5nJ10gPSB2YWx1ZTsKICAgICAgICBoYXNoVHlwZVtwcm9wICsgJ0JpbmRpbmcnXSA9ICdTVFJJTkcnOwogICAgICAgIGRlbGV0ZSBoYXNoW3Byb3BdOwogICAgICAgIGRlbGV0ZSBoYXNoVHlwZVtwcm9wXTsKICAgICAgfQogICAgfQogIH0KCiAgaWYgKGhhc2guaGFzT3duUHJvcGVydHkoJ2lkQmluZGluZycpKSB7CiAgICAvLyBpZCBjYW4ndCBiZSBib3VuZCwgc28ganVzdCBwZXJmb3JtIG9uZS10aW1lIGxvb2t1cC4KICAgIGhhc2guaWQgPSBFbWJlckhhbmRsZWJhcnMuZ2V0KHRoaXNDb250ZXh0LCBoYXNoLmlkQmluZGluZywgb3B0aW9ucyk7CiAgICBoYXNoVHlwZS5pZCA9ICdTVFJJTkcnOwogICAgZGVsZXRlIGhhc2guaWRCaW5kaW5nOwogICAgZGVsZXRlIGhhc2hUeXBlLmlkQmluZGluZzsKICB9Cn0KCkVtYmVySGFuZGxlYmFycy5WaWV3SGVscGVyID0gRW1iZXIuT2JqZWN0LmNyZWF0ZSh7CgogIHByb3BlcnRpZXNGcm9tSFRNTE9wdGlvbnM6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHZhciBoYXNoID0gb3B0aW9ucy5oYXNoLCBkYXRhID0gb3B0aW9ucy5kYXRhOwogICAgdmFyIGV4dGVuc2lvbnMgPSB7fSwKICAgICAgICBjbGFzc2VzID0gaGFzaFsnY2xhc3MnXSwKICAgICAgICBkdXAgPSBmYWxzZTsKCiAgICBpZiAoaGFzaC5pZCkgewogICAgICBleHRlbnNpb25zLmVsZW1lbnRJZCA9IGhhc2guaWQ7CiAgICAgIGR1cCA9IHRydWU7CiAgICB9CgogICAgaWYgKGhhc2gudGFnKSB7CiAgICAgIGV4dGVuc2lvbnMudGFnTmFtZSA9IGhhc2gudGFnOwogICAgICBkdXAgPSB0cnVlOwogICAgfQoKICAgIGlmIChjbGFzc2VzKSB7CiAgICAgIGNsYXNzZXMgPSBjbGFzc2VzLnNwbGl0KCcgJyk7CiAgICAgIGV4dGVuc2lvbnMuY2xhc3NOYW1lcyA9IGNsYXNzZXM7CiAgICAgIGR1cCA9IHRydWU7CiAgICB9CgogICAgaWYgKGhhc2guY2xhc3NCaW5kaW5nKSB7CiAgICAgIGV4dGVuc2lvbnMuY2xhc3NOYW1lQmluZGluZ3MgPSBoYXNoLmNsYXNzQmluZGluZy5zcGxpdCgnICcpOwogICAgICBkdXAgPSB0cnVlOwogICAgfQoKICAgIGlmIChoYXNoLmNsYXNzTmFtZUJpbmRpbmdzKSB7CiAgICAgIGlmIChleHRlbnNpb25zLmNsYXNzTmFtZUJpbmRpbmdzID09PSB1bmRlZmluZWQpIGV4dGVuc2lvbnMuY2xhc3NOYW1lQmluZGluZ3MgPSBbXTsKICAgICAgZXh0ZW5zaW9ucy5jbGFzc05hbWVCaW5kaW5ncyA9IGV4dGVuc2lvbnMuY2xhc3NOYW1lQmluZGluZ3MuY29uY2F0KGhhc2guY2xhc3NOYW1lQmluZGluZ3Muc3BsaXQoJyAnKSk7CiAgICAgIGR1cCA9IHRydWU7CiAgICB9CgogICAgaWYgKGhhc2guYXR0cmlidXRlQmluZGluZ3MpIHsKICAgICAgRW1iZXIuYXNzZXJ0KCJTZXR0aW5nICdhdHRyaWJ1dGVCaW5kaW5ncycgdmlhIEhhbmRsZWJhcnMgaXMgbm90IGFsbG93ZWQuIFBsZWFzZSBzdWJjbGFzcyBFbWJlci5WaWV3IGFuZCBzZXQgaXQgdGhlcmUgaW5zdGVhZC4iKTsKICAgICAgZXh0ZW5zaW9ucy5hdHRyaWJ1dGVCaW5kaW5ncyA9IG51bGw7CiAgICAgIGR1cCA9IHRydWU7CiAgICB9CgogICAgaWYgKGR1cCkgewogICAgICBoYXNoID0gRW1iZXIuJC5leHRlbmQoe30sIGhhc2gpOwogICAgICBkZWxldGUgaGFzaC5pZDsKICAgICAgZGVsZXRlIGhhc2gudGFnOwogICAgICBkZWxldGUgaGFzaFsnY2xhc3MnXTsKICAgICAgZGVsZXRlIGhhc2guY2xhc3NCaW5kaW5nOwogICAgfQoKICAgIC8vIFNldCB0aGUgcHJvcGVyIGNvbnRleHQgZm9yIGFsbCBiaW5kaW5ncyBwYXNzZWQgdG8gdGhlIGhlbHBlci4gVGhpcyBhcHBsaWVzIHRvIHJlZ3VsYXIgYXR0cmlidXRlIGJpbmRpbmdzCiAgICAvLyBhcyB3ZWxsIGFzIGNsYXNzIG5hbWUgYmluZGluZ3MuIElmIHRoZSBiaW5kaW5ncyBhcmUgbG9jYWwsIG1ha2UgdGhlbSByZWxhdGl2ZSB0byB0aGUgY3VycmVudCBjb250ZXh0CiAgICAvLyBpbnN0ZWFkIG9mIHRoZSB2aWV3LgogICAgdmFyIHBhdGg7CgogICAgLy8gRXZhbHVhdGUgdGhlIGNvbnRleHQgb2YgcmVndWxhciBhdHRyaWJ1dGUgYmluZGluZ3M6CiAgICBmb3IgKHZhciBwcm9wIGluIGhhc2gpIHsKICAgICAgaWYgKCFoYXNoLmhhc093blByb3BlcnR5KHByb3ApKSB7IGNvbnRpbnVlOyB9CgogICAgICAvLyBUZXN0IGlmIHRoZSBwcm9wZXJ0eSBlbmRzIGluICJCaW5kaW5nIgogICAgICBpZiAoRW1iZXIuSVNfQklORElORy50ZXN0KHByb3ApICYmIHR5cGVvZiBoYXNoW3Byb3BdID09PSAnc3RyaW5nJykgewogICAgICAgIHBhdGggPSB0aGlzLmNvbnRleHR1YWxpemVCaW5kaW5nUGF0aChoYXNoW3Byb3BdLCBkYXRhKTsKICAgICAgICBpZiAocGF0aCkgeyBoYXNoW3Byb3BdID0gcGF0aDsgfQogICAgICB9CiAgICB9CgogICAgLy8gRXZhbHVhdGUgdGhlIGNvbnRleHQgb2YgY2xhc3MgbmFtZSBiaW5kaW5nczoKICAgIGlmIChleHRlbnNpb25zLmNsYXNzTmFtZUJpbmRpbmdzKSB7CiAgICAgIGZvciAodmFyIGIgaW4gZXh0ZW5zaW9ucy5jbGFzc05hbWVCaW5kaW5ncykgewogICAgICAgIHZhciBmdWxsID0gZXh0ZW5zaW9ucy5jbGFzc05hbWVCaW5kaW5nc1tiXTsKICAgICAgICBpZiAodHlwZW9mIGZ1bGwgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAvLyBDb250ZXh0dWFsaXplIHRoZSBwYXRoIG9mIGNsYXNzTmFtZUJpbmRpbmcgc28gdGhpczoKICAgICAgICAgIC8vCiAgICAgICAgICAvLyAgICAgY2xhc3NOYW1lQmluZGluZz0iaXNHcmVlbjpncmVlbiIKICAgICAgICAgIC8vCiAgICAgICAgICAvLyBpcyBjb252ZXJ0ZWQgdG8gdGhpczoKICAgICAgICAgIC8vCiAgICAgICAgICAvLyAgICAgY2xhc3NOYW1lQmluZGluZz0iX3BhcmVudFZpZXcuY29udGV4dC5pc0dyZWVuOmdyZWVuIgogICAgICAgICAgdmFyIHBhcnNlZFBhdGggPSBFbWJlci5WaWV3Ll9wYXJzZVByb3BlcnR5UGF0aChmdWxsKTsKICAgICAgICAgIHBhdGggPSB0aGlzLmNvbnRleHR1YWxpemVCaW5kaW5nUGF0aChwYXJzZWRQYXRoLnBhdGgsIGRhdGEpOwogICAgICAgICAgaWYgKHBhdGgpIHsgZXh0ZW5zaW9ucy5jbGFzc05hbWVCaW5kaW5nc1tiXSA9IHBhdGggKyBwYXJzZWRQYXRoLmNsYXNzTmFtZXM7IH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gRW1iZXIuJC5leHRlbmQoaGFzaCwgZXh0ZW5zaW9ucyk7CiAgfSwKCiAgLy8gVHJhbnNmb3JtIGJpbmRpbmdzIGZyb20gdGhlIGN1cnJlbnQgY29udGV4dCB0byBhIGNvbnRleHQgdGhhdCBjYW4gYmUgZXZhbHVhdGVkIHdpdGhpbiB0aGUgdmlldy4KICAvLyBSZXR1cm5zIG51bGwgaWYgdGhlIHBhdGggc2hvdWxkbid0IGJlIGNoYW5nZWQuCiAgLy8KICAvLyBUT0RPOiBjb25zaWRlciB0aGUgYWRkaXRpb24gb2YgYSBwcmVmaXggdGhhdCB3b3VsZCBhbGxvdyB0aGlzIG1ldGhvZCB0byByZXR1cm4gYHBhdGhgLgogIGNvbnRleHR1YWxpemVCaW5kaW5nUGF0aDogZnVuY3Rpb24ocGF0aCwgZGF0YSkgewogICAgdmFyIG5vcm1hbGl6ZWQgPSBFbWJlci5IYW5kbGViYXJzLm5vcm1hbGl6ZVBhdGgobnVsbCwgcGF0aCwgZGF0YSk7CiAgICBpZiAobm9ybWFsaXplZC5pc0tleXdvcmQpIHsKICAgICAgcmV0dXJuICd0ZW1wbGF0ZURhdGEua2V5d29yZHMuJyArIHBhdGg7CiAgICB9IGVsc2UgaWYgKEVtYmVyLmlzR2xvYmFsUGF0aChwYXRoKSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0gZWxzZSBpZiAocGF0aCA9PT0gJ3RoaXMnIHx8IHBhdGggPT09ICcnKSB7CiAgICAgIHJldHVybiAnX3BhcmVudFZpZXcuY29udGV4dCc7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gJ19wYXJlbnRWaWV3LmNvbnRleHQuJyArIHBhdGg7CiAgICB9CiAgfSwKCiAgaGVscGVyOiBmdW5jdGlvbih0aGlzQ29udGV4dCwgcGF0aCwgb3B0aW9ucykgewogICAgdmFyIGRhdGEgPSBvcHRpb25zLmRhdGEsCiAgICAgICAgZm4gPSBvcHRpb25zLmZuLAogICAgICAgIG5ld1ZpZXc7CgogICAgbWFrZUJpbmRpbmdzKHRoaXNDb250ZXh0LCBvcHRpb25zKTsKCiAgICBpZiAoJ3N0cmluZycgPT09IHR5cGVvZiBwYXRoKSB7CgogICAgICAvLyBUT0RPOiB0aGlzIGlzIGEgbGFtZSBjb25kaXRpb25hbCwgdGhpcyBzaG91bGQgbGlrZWx5IGNoYW5nZQogICAgICAvLyBidXQgc29tZXRoaW5nIGFsb25nIHRoZXNlIGxpbmVzIHdpbGwgbGlrZWx5IG5lZWQgdG8gYmUgYWRkZWQKICAgICAgLy8gYXMgZGVwcmVjYXRpb24gd2FybmluZ3MKICAgICAgLy8KICAgICAgaWYgKG9wdGlvbnMudHlwZXNbMF0gPT09ICdTVFJJTkcnICYmIExPV0VSQ0FTRV9BX1oudGVzdChwYXRoKSAmJiAhVklFV19QUkVGSVgudGVzdChwYXRoKSkgewogICAgICAgIEVtYmVyLmFzc2VydCgiVmlldyByZXF1aXJlcyBhIGNvbnRhaW5lciIsICEhZGF0YS52aWV3LmNvbnRhaW5lcik7CiAgICAgICAgbmV3VmlldyA9IGRhdGEudmlldy5jb250YWluZXIubG9va3VwRmFjdG9yeSgndmlldzonICsgcGF0aCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbmV3VmlldyA9IEVtYmVySGFuZGxlYmFycy5nZXQodGhpc0NvbnRleHQsIHBhdGgsIG9wdGlvbnMpOwogICAgICB9CgogICAgICBFbWJlci5hc3NlcnQoIlVuYWJsZSB0byBmaW5kIHZpZXcgYXQgcGF0aCAnIiArIHBhdGggKyAiJyIsICEhbmV3Vmlldyk7CiAgICB9IGVsc2UgewogICAgICBuZXdWaWV3ID0gcGF0aDsKICAgIH0KCiAgICBFbWJlci5hc3NlcnQoRW1iZXIuU3RyaW5nLmZtdCgnWW91IG11c3QgcGFzcyBhIHZpZXcgdG8gdGhlICN2aWV3IGhlbHBlciwgbm90ICVAICglQCknLCBbcGF0aCwgbmV3Vmlld10pLCBFbWJlci5WaWV3LmRldGVjdChuZXdWaWV3KSB8fCBFbWJlci5WaWV3LmRldGVjdEluc3RhbmNlKG5ld1ZpZXcpKTsKCiAgICB2YXIgdmlld09wdGlvbnMgPSB0aGlzLnByb3BlcnRpZXNGcm9tSFRNTE9wdGlvbnMob3B0aW9ucywgdGhpc0NvbnRleHQpOwogICAgdmFyIGN1cnJlbnRWaWV3ID0gZGF0YS52aWV3OwogICAgdmlld09wdGlvbnMudGVtcGxhdGVEYXRhID0gZGF0YTsKICAgIHZhciBuZXdWaWV3UHJvdG8gPSBuZXdWaWV3LnByb3RvID8gbmV3Vmlldy5wcm90bygpIDogbmV3VmlldzsKCiAgICBpZiAoZm4pIHsKICAgICAgRW1iZXIuYXNzZXJ0KCJZb3UgY2Fubm90IHByb3ZpZGUgYSB0ZW1wbGF0ZSBibG9jayBpZiB5b3UgYWxzbyBzcGVjaWZpZWQgYSB0ZW1wbGF0ZU5hbWUiLCAhZ2V0KHZpZXdPcHRpb25zLCAndGVtcGxhdGVOYW1lJykgJiYgIWdldChuZXdWaWV3UHJvdG8sICd0ZW1wbGF0ZU5hbWUnKSk7CiAgICAgIHZpZXdPcHRpb25zLnRlbXBsYXRlID0gZm47CiAgICB9CgogICAgLy8gV2Ugb25seSB3YW50IHRvIG92ZXJyaWRlIHRoZSBgX2NvbnRleHRgIGNvbXB1dGVkIHByb3BlcnR5IGlmIHRoZXJlIGlzCiAgICAvLyBubyBzcGVjaWZpZWQgY29udHJvbGxlci4gU2VlIFZpZXcjX2NvbnRleHQgZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAgICBpZiAoIW5ld1ZpZXdQcm90by5jb250cm9sbGVyICYmICFuZXdWaWV3UHJvdG8uY29udHJvbGxlckJpbmRpbmcgJiYgIXZpZXdPcHRpb25zLmNvbnRyb2xsZXIgJiYgIXZpZXdPcHRpb25zLmNvbnRyb2xsZXJCaW5kaW5nKSB7CiAgICAgIHZpZXdPcHRpb25zLl9jb250ZXh0ID0gdGhpc0NvbnRleHQ7CiAgICB9CgogICAgY3VycmVudFZpZXcuYXBwZW5kQ2hpbGQobmV3Vmlldywgdmlld09wdGlvbnMpOwogIH0KfSk7CgovKioKICBge3t2aWV3fX1gIGluc2VydHMgYSBuZXcgaW5zdGFuY2Ugb2YgYEVtYmVyLlZpZXdgIGludG8gYSB0ZW1wbGF0ZSBwYXNzaW5nIGl0cwogIG9wdGlvbnMgdG8gdGhlIGBFbWJlci5WaWV3YCdzIGBjcmVhdGVgIG1ldGhvZCBhbmQgdXNpbmcgdGhlIHN1cHBsaWVkIGJsb2NrIGFzCiAgdGhlIHZpZXcncyBvd24gdGVtcGxhdGUuCgogIEFuIGVtcHR5IGA8Ym9keT5gIGFuZCB0aGUgZm9sbG93aW5nIHRlbXBsYXRlOgoKICBgYGBoYW5kbGViYXJzCiAgQSBzcGFuOgogIHt7I3ZpZXcgdGFnTmFtZT0ic3BhbiJ9fQogICAgaGVsbG8uCiAge3svdmlld319CiAgYGBgCgogIFdpbGwgcmVzdWx0IGluIEhUTUwgc3RydWN0dXJlOgoKICBgYGBodG1sCiAgPGJvZHk+CiAgICA8IS0tIE5vdGU6IHRoZSBoYW5kbGViYXJzIHRlbXBsYXRlIHNjcmlwdAogICAgICAgICBhbHNvIHJlc3VsdHMgaW4gYSByZW5kZXJlZCBFbWJlci5WaWV3CiAgICAgICAgIHdoaWNoIGlzIHRoZSBvdXRlciA8ZGl2PiBoZXJlIC0tPgoKICAgIDxkaXYgY2xhc3M9ImVtYmVyLXZpZXciPgogICAgICBBIHNwYW46CiAgICAgIDxzcGFuIGlkPSJlbWJlcjEiIGNsYXNzPSJlbWJlci12aWV3Ij4KICAgICAgICBIZWxsby4KICAgICAgPC9zcGFuPgogICAgPC9kaXY+CiAgPC9ib2R5PgogIGBgYAoKICAjIyMgYHBhcmVudFZpZXdgIHNldHRpbmcKCiAgVGhlIGBwYXJlbnRWaWV3YCBwcm9wZXJ0eSBvZiB0aGUgbmV3IGBFbWJlci5WaWV3YCBpbnN0YW5jZSBjcmVhdGVkIHRocm91Z2gKICBge3t2aWV3fX1gIHdpbGwgYmUgc2V0IHRvIHRoZSBgRW1iZXIuVmlld2AgaW5zdGFuY2Ugb2YgdGhlIHRlbXBsYXRlIHdoZXJlCiAgYHt7dmlld319YCB3YXMgY2FsbGVkLgoKICBgYGBqYXZhc2NyaXB0CiAgYVZpZXcgPSBFbWJlci5WaWV3LmNyZWF0ZSh7CiAgICB0ZW1wbGF0ZTogRW1iZXIuSGFuZGxlYmFycy5jb21waWxlKCJ7eyN2aWV3fX0gbXkgcGFyZW50OiB7e3BhcmVudFZpZXcuZWxlbWVudElkfX0ge3svdmlld319IikKICB9KTsKCiAgYVZpZXcuYXBwZW5kVG8oJ2JvZHknKTsKICBgYGAKCiAgV2lsbCByZXN1bHQgaW4gSFRNTCBzdHJ1Y3R1cmU6CgogIGBgYGh0bWwKICA8ZGl2IGlkPSJlbWJlcjEiIGNsYXNzPSJlbWJlci12aWV3Ij4KICAgIDxkaXYgaWQ9ImVtYmVyMiIgY2xhc3M9ImVtYmVyLXZpZXciPgogICAgICBteSBwYXJlbnQ6IGVtYmVyMQogICAgPC9kaXY+CiAgPC9kaXY+CiAgYGBgCgogICMjIyBTZXR0aW5nIENTUyBpZCBhbmQgY2xhc3MgYXR0cmlidXRlcwoKICBUaGUgSFRNTCBgaWRgIGF0dHJpYnV0ZSBjYW4gYmUgc2V0IG9uIHRoZSBge3t2aWV3fX1gJ3MgcmVzdWx0aW5nIGVsZW1lbnQgd2l0aAogIHRoZSBgaWRgIG9wdGlvbi4gVGhpcyBvcHRpb24gd2lsbCBfbm90XyBiZSBwYXNzZWQgdG8gYEVtYmVyLlZpZXcuY3JlYXRlYC4KCiAgYGBgaGFuZGxlYmFycwogIHt7I3ZpZXcgdGFnTmFtZT0ic3BhbiIgaWQ9ImEtY3VzdG9tLWlkIn19CiAgICBoZWxsby4KICB7ey92aWV3fX0KICBgYGAKCiAgUmVzdWx0cyBpbiB0aGUgZm9sbG93aW5nIEhUTUwgc3RydWN0dXJlOgoKICBgYGBodG1sCiAgPGRpdiBjbGFzcz0iZW1iZXItdmlldyI+CiAgICA8c3BhbiBpZD0iYS1jdXN0b20taWQiIGNsYXNzPSJlbWJlci12aWV3Ij4KICAgICAgaGVsbG8uCiAgICA8L3NwYW4+CiAgPC9kaXY+CiAgYGBgCgogIFRoZSBIVE1MIGBjbGFzc2AgYXR0cmlidXRlIGNhbiBiZSBzZXQgb24gdGhlIGB7e3ZpZXd9fWAncyByZXN1bHRpbmcgZWxlbWVudAogIHdpdGggdGhlIGBjbGFzc2Agb3IgYGNsYXNzTmFtZUJpbmRpbmdzYCBvcHRpb25zLiBUaGUgYGNsYXNzYCBvcHRpb24gd2lsbAogIGRpcmVjdGx5IHNldCB0aGUgQ1NTIGBjbGFzc2AgYXR0cmlidXRlIGFuZCB3aWxsIG5vdCBiZSBwYXNzZWQgdG8KICBgRW1iZXIuVmlldy5jcmVhdGVgLiBgY2xhc3NOYW1lQmluZGluZ3NgIHdpbGwgYmUgcGFzc2VkIHRvIGBjcmVhdGVgIGFuZCB1c2UKICBgRW1iZXIuVmlld2AncyBjbGFzcyBuYW1lIGJpbmRpbmcgZnVuY3Rpb25hbGl0eToKCiAgYGBgaGFuZGxlYmFycwogIHt7I3ZpZXcgdGFnTmFtZT0ic3BhbiIgY2xhc3M9ImEtY3VzdG9tLWNsYXNzIn19CiAgICBoZWxsby4KICB7ey92aWV3fX0KICBgYGAKCiAgUmVzdWx0cyBpbiB0aGUgZm9sbG93aW5nIEhUTUwgc3RydWN0dXJlOgoKICBgYGBodG1sCiAgPGRpdiBjbGFzcz0iZW1iZXItdmlldyI+CiAgICA8c3BhbiBpZD0iZW1iZXIyIiBjbGFzcz0iZW1iZXItdmlldyBhLWN1c3RvbS1jbGFzcyI+CiAgICAgIGhlbGxvLgogICAgPC9zcGFuPgogIDwvZGl2PgogIGBgYAoKICAjIyMgU3VwcGx5aW5nIGEgZGlmZmVyZW50IHZpZXcgY2xhc3MKCiAgYHt7dmlld319YCBjYW4gdGFrZSBhbiBvcHRpb25hbCBmaXJzdCBhcmd1bWVudCBiZWZvcmUgaXRzIHN1cHBsaWVkIG9wdGlvbnMgdG8KICBzcGVjaWZ5IGEgcGF0aCB0byBhIGN1c3RvbSB2aWV3IGNsYXNzLgoKICBgYGBoYW5kbGViYXJzCiAge3sjdmlldyAiTXlBcHAuQ3VzdG9tVmlldyJ9fQogICAgaGVsbG8uCiAge3svdmlld319CiAgYGBgCgogIFRoZSBmaXJzdCBhcmd1bWVudCBjYW4gYWxzbyBiZSBhIHJlbGF0aXZlIHBhdGggYWNjZXNzaWJsZSBmcm9tIHRoZSBjdXJyZW50CiAgY29udGV4dC4KCiAgYGBgamF2YXNjcmlwdAogIE15QXBwID0gRW1iZXIuQXBwbGljYXRpb24uY3JlYXRlKHt9KTsKICBNeUFwcC5PdXRlclZpZXcgPSBFbWJlci5WaWV3LmV4dGVuZCh7CiAgICBpbm5lclZpZXdDbGFzczogRW1iZXIuVmlldy5leHRlbmQoewogICAgICBjbGFzc05hbWVzOiBbJ2EtY3VzdG9tLXZpZXctY2xhc3MtYXMtcHJvcGVydHknXQogICAgfSksCiAgICB0ZW1wbGF0ZTogRW1iZXIuSGFuZGxlYmFycy5jb21waWxlKCd7eyN2aWV3ICJ2aWV3LmlubmVyVmlld0NsYXNzIn19IGhpIHt7L3ZpZXd9fScpCiAgfSk7CgogIE15QXBwLk91dGVyVmlldy5jcmVhdGUoKS5hcHBlbmRUbygnYm9keScpOwogIGBgYAoKICBXaWxsIHJlc3VsdCBpbiB0aGUgZm9sbG93aW5nIEhUTUw6CgogIGBgYGh0bWwKICA8ZGl2IGlkPSJlbWJlcjEiIGNsYXNzPSJlbWJlci12aWV3Ij4KICAgIDxkaXYgaWQ9ImVtYmVyMiIgY2xhc3M9ImVtYmVyLXZpZXcgYS1jdXN0b20tdmlldy1jbGFzcy1hcy1wcm9wZXJ0eSI+CiAgICAgIGhpCiAgICA8L2Rpdj4KICA8L2Rpdj4KICBgYGAKCiAgIyMjIEJsb2NrbGVzcyB1c2UKCiAgSWYgeW91IHN1cHBseSBhIGN1c3RvbSBgRW1iZXIuVmlld2Agc3ViY2xhc3MgdGhhdCBzcGVjaWZpZXMgaXRzIG93biB0ZW1wbGF0ZQogIG9yIHByb3ZpZGUgYSBgdGVtcGxhdGVOYW1lYCBvcHRpb24gdG8gYHt7dmlld319YCBpdCBjYW4gYmUgdXNlZCB3aXRob3V0CiAgc3VwcGx5aW5nIGEgYmxvY2suIEF0dGVtcHRzIHRvIHVzZSBib3RoIGEgYHRlbXBsYXRlTmFtZWAgb3B0aW9uIGFuZCBzdXBwbHkgYQogIGJsb2NrIHdpbGwgdGhyb3cgYW4gZXJyb3IuCgogIGBgYGhhbmRsZWJhcnMKICB7e3ZpZXcgIk15QXBwLlZpZXdXaXRoQVRlbXBsYXRlRGVmaW5lZCJ9fQogIGBgYAoKICAjIyMgYHZpZXdOYW1lYCBwcm9wZXJ0eQoKICBZb3UgY2FuIHN1cHBseSBhIGB2aWV3TmFtZWAgb3B0aW9uIHRvIGB7e3ZpZXd9fWAuIFRoZSBgRW1iZXIuVmlld2AgaW5zdGFuY2UKICB3aWxsIGJlIHJlZmVyZW5jZWQgYXMgYSBwcm9wZXJ0eSBvZiBpdHMgcGFyZW50IHZpZXcgYnkgdGhpcyBuYW1lLgoKICBgYGBqYXZhc2NyaXB0CiAgYVZpZXcgPSBFbWJlci5WaWV3LmNyZWF0ZSh7CiAgICB0ZW1wbGF0ZTogRW1iZXIuSGFuZGxlYmFycy5jb21waWxlKCd7eyN2aWV3IHZpZXdOYW1lPSJhQ2hpbGRCeU5hbWUifX0gaGkge3svdmlld319JykKICB9KTsKCiAgYVZpZXcuYXBwZW5kVG8oJ2JvZHknKTsKICBhVmlldy5nZXQoJ2FDaGlsZEJ5TmFtZScpIC8vIHRoZSBpbnN0YW5jZSBvZiBFbWJlci5WaWV3IGNyZWF0ZWQgYnkge3t2aWV3fX0gaGVscGVyCiAgYGBgCgogIEBtZXRob2QgdmlldwogIEBmb3IgRW1iZXIuSGFuZGxlYmFycy5oZWxwZXJzCiAgQHBhcmFtIHtTdHJpbmd9IHBhdGgKICBAcGFyYW0ge0hhc2h9IG9wdGlvbnMKICBAcmV0dXJuIHtTdHJpbmd9IEhUTUwgc3RyaW5nCiovCkVtYmVySGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcigndmlldycsIGZ1bmN0aW9uIHZpZXdIZWxwZXIocGF0aCwgb3B0aW9ucykgewogIEVtYmVyLmFzc2VydCgiVGhlIHZpZXcgaGVscGVyIG9ubHkgdGFrZXMgYSBzaW5nbGUgYXJndW1lbnQiLCBhcmd1bWVudHMubGVuZ3RoIDw9IDIpOwoKICAvLyBJZiBubyBwYXRoIGlzIHByb3ZpZGVkLCB0cmVhdCBwYXRoIHBhcmFtIGFzIG9wdGlvbnMuCiAgaWYgKHBhdGggJiYgcGF0aC5kYXRhICYmIHBhdGguZGF0YS5pc1JlbmRlckRhdGEpIHsKICAgIG9wdGlvbnMgPSBwYXRoOwogICAgcGF0aCA9ICJFbWJlci5WaWV3IjsKICB9CgogIHJldHVybiBFbWJlckhhbmRsZWJhcnMuVmlld0hlbHBlci5oZWxwZXIodGhpcywgcGF0aCwgb3B0aW9ucyk7Cn0pOwoKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLy8gVE9ETzogRG9uJ3QgcmVxdWlyZSBhbGwgb2YgdGhpcyBtb2R1bGUKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1oYW5kbGViYXJzCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBoYW5kbGViYXJzR2V0ID0gRW1iZXIuSGFuZGxlYmFycy5nZXQsIGZtdCA9IEVtYmVyLlN0cmluZy5mbXQ7CgovKioKICBge3tjb2xsZWN0aW9ufX1gIGlzIGEgYEVtYmVyLkhhbmRsZWJhcnNgIGhlbHBlciBmb3IgYWRkaW5nIGluc3RhbmNlcyBvZgogIGBFbWJlci5Db2xsZWN0aW9uVmlld2AgdG8gYSB0ZW1wbGF0ZS4gU2VlIFtFbWJlci5Db2xsZWN0aW9uVmlld10oL2FwaS9jbGFzc2VzL0VtYmVyLkNvbGxlY3Rpb25WaWV3Lmh0bWwpCiAgIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uIG9uIGhvdyBhIGBDb2xsZWN0aW9uVmlld2AgZnVuY3Rpb25zLgoKICBge3tjb2xsZWN0aW9ufX1gJ3MgcHJpbWFyeSB1c2UgaXMgYXMgYSBibG9jayBoZWxwZXIgd2l0aCBhIGBjb250ZW50QmluZGluZ2AKICBvcHRpb24gcG9pbnRpbmcgdG93YXJkcyBhbiBgRW1iZXIuQXJyYXlgLWNvbXBhdGlibGUgb2JqZWN0LiBBbiBgRW1iZXIuVmlld2AKICBpbnN0YW5jZSB3aWxsIGJlIGNyZWF0ZWQgZm9yIGVhY2ggaXRlbSBpbiBpdHMgYGNvbnRlbnRgIHByb3BlcnR5LiBFYWNoIHZpZXcKICB3aWxsIGhhdmUgaXRzIG93biBgY29udGVudGAgcHJvcGVydHkgc2V0IHRvIHRoZSBhcHByb3ByaWF0ZSBpdGVtIGluIHRoZQogIGNvbGxlY3Rpb24uCgogIFRoZSBwcm92aWRlZCBibG9jayB3aWxsIGJlIGFwcGxpZWQgYXMgdGhlIHRlbXBsYXRlIGZvciBlYWNoIGl0ZW0ncyB2aWV3LgoKICBHaXZlbiBhbiBlbXB0eSBgPGJvZHk+YCB0aGUgZm9sbG93aW5nIHRlbXBsYXRlOgoKICBgYGBoYW5kbGViYXJzCiAge3sjY29sbGVjdGlvbiBjb250ZW50QmluZGluZz0iQXBwLml0ZW1zIn19CiAgICBIaSB7e3ZpZXcuY29udGVudC5uYW1lfX0KICB7ey9jb2xsZWN0aW9ufX0KICBgYGAKCiAgQW5kIHRoZSBmb2xsb3dpbmcgYXBwbGljYXRpb24gY29kZQoKICBgYGBqYXZhc2NyaXB0CiAgQXBwID0gRW1iZXIuQXBwbGljYXRpb24uY3JlYXRlKCkKICBBcHAuaXRlbXMgPSBbCiAgICBFbWJlci5PYmplY3QuY3JlYXRlKHtuYW1lOiAnRGF2ZSd9KSwKICAgIEVtYmVyLk9iamVjdC5jcmVhdGUoe25hbWU6ICdNYXJ5J30pLAogICAgRW1iZXIuT2JqZWN0LmNyZWF0ZSh7bmFtZTogJ1NhcmEnfSkKICBdCiAgYGBgCgogIFdpbGwgcmVzdWx0IGluIHRoZSBIVE1MIHN0cnVjdHVyZSBiZWxvdwoKICBgYGBodG1sCiAgPGRpdiBjbGFzcz0iZW1iZXItdmlldyI+CiAgICA8ZGl2IGNsYXNzPSJlbWJlci12aWV3Ij5IaSBEYXZlPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJlbWJlci12aWV3Ij5IaSBNYXJ5PC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJlbWJlci12aWV3Ij5IaSBTYXJhPC9kaXY+CiAgPC9kaXY+CiAgYGBgCgogICMjIyBCbG9ja2xlc3MgVXNlCgogIElmIHlvdSBwcm92aWRlIGFuIGBpdGVtVmlld0NsYXNzYCBvcHRpb24gdGhhdCBoYXMgaXRzIG93biBgdGVtcGxhdGVgIHlvdSBjYW4KICBvbWl0IHRoZSBibG9jay4KCiAgVGhlIGZvbGxvd2luZyB0ZW1wbGF0ZToKCiAgYGBgaGFuZGxlYmFycwogIHt7Y29sbGVjdGlvbiBjb250ZW50QmluZGluZz0iQXBwLml0ZW1zIiBpdGVtVmlld0NsYXNzPSJBcHAuQW5JdGVtVmlldyJ9fQogIGBgYAoKICBBbmQgYXBwbGljYXRpb24gY29kZQoKICBgYGBqYXZhc2NyaXB0CiAgQXBwID0gRW1iZXIuQXBwbGljYXRpb24uY3JlYXRlKCk7CiAgQXBwLml0ZW1zID0gWwogICAgRW1iZXIuT2JqZWN0LmNyZWF0ZSh7bmFtZTogJ0RhdmUnfSksCiAgICBFbWJlci5PYmplY3QuY3JlYXRlKHtuYW1lOiAnTWFyeSd9KSwKICAgIEVtYmVyLk9iamVjdC5jcmVhdGUoe25hbWU6ICdTYXJhJ30pCiAgXTsKCiAgQXBwLkFuSXRlbVZpZXcgPSBFbWJlci5WaWV3LmV4dGVuZCh7CiAgICB0ZW1wbGF0ZTogRW1iZXIuSGFuZGxlYmFycy5jb21waWxlKCJHcmVldGluZ3Mge3t2aWV3LmNvbnRlbnQubmFtZX19IikKICB9KTsKICBgYGAKCiAgV2lsbCByZXN1bHQgaW4gdGhlIEhUTUwgc3RydWN0dXJlIGJlbG93CgogIGBgYGh0bWwKICA8ZGl2IGNsYXNzPSJlbWJlci12aWV3Ij4KICAgIDxkaXYgY2xhc3M9ImVtYmVyLXZpZXciPkdyZWV0aW5ncyBEYXZlPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJlbWJlci12aWV3Ij5HcmVldGluZ3MgTWFyeTwvZGl2PgogICAgPGRpdiBjbGFzcz0iZW1iZXItdmlldyI+R3JlZXRpbmdzIFNhcmE8L2Rpdj4KICA8L2Rpdj4KICBgYGAKCiAgIyMjIFNwZWNpZnlpbmcgYSBDb2xsZWN0aW9uVmlldyBzdWJjbGFzcwoKICBCeSBkZWZhdWx0IHRoZSBge3tjb2xsZWN0aW9ufX1gIGhlbHBlciB3aWxsIGNyZWF0ZSBhbiBpbnN0YW5jZSBvZgogIGBFbWJlci5Db2xsZWN0aW9uVmlld2AuIFlvdSBjYW4gc3VwcGx5IGEgYEVtYmVyLkNvbGxlY3Rpb25WaWV3YCBzdWJjbGFzcyB0bwogIHRoZSBoZWxwZXIgYnkgcGFzc2luZyBpdCBhcyB0aGUgZmlyc3QgYXJndW1lbnQ6CgogIGBgYGhhbmRsZWJhcnMKICB7eyNjb2xsZWN0aW9uIEFwcC5NeUN1c3RvbUNvbGxlY3Rpb25DbGFzcyBjb250ZW50QmluZGluZz0iQXBwLml0ZW1zIn19CiAgICBIaSB7e3ZpZXcuY29udGVudC5uYW1lfX0KICB7ey9jb2xsZWN0aW9ufX0KICBgYGAKCiAgIyMjIEZvcndhcmRlZCBgaXRlbS4qYC1uYW1lZCBPcHRpb25zCgogIEFzIHdpdGggdGhlIGB7e3ZpZXd9fWAsIGhlbHBlciBvcHRpb25zIHBhc3NlZCB0byB0aGUgYHt7Y29sbGVjdGlvbn19YCB3aWxsIGJlCiAgc2V0IG9uIHRoZSByZXN1bHRpbmcgYEVtYmVyLkNvbGxlY3Rpb25WaWV3YCBhcyBwcm9wZXJ0aWVzLiBBZGRpdGlvbmFsbHksCiAgb3B0aW9ucyBwcmVmaXhlZCB3aXRoIGBpdGVtYCB3aWxsIGJlIGFwcGxpZWQgdG8gdGhlIHZpZXdzIHJlbmRlcmVkIGZvciBlYWNoCiAgaXRlbSAobm90ZSB0aGUgY2FtZWxjYXNpbmcpOgoKICBgYGBoYW5kbGViYXJzCiAge3sjY29sbGVjdGlvbiBjb250ZW50QmluZGluZz0iQXBwLml0ZW1zIgogICAgICAgICAgICAgICAgaXRlbVRhZ05hbWU9InAiCiAgICAgICAgICAgICAgICBpdGVtQ2xhc3NOYW1lcz0iZ3JlZXRpbmcifX0KICAgIEhvd2R5IHt7dmlldy5jb250ZW50Lm5hbWV9fQogIHt7L2NvbGxlY3Rpb259fQogIGBgYAoKICBXaWxsIHJlc3VsdCBpbiB0aGUgZm9sbG93aW5nIEhUTUwgc3RydWN0dXJlOgoKICBgYGBodG1sCiAgPGRpdiBjbGFzcz0iZW1iZXItdmlldyI+CiAgICA8cCBjbGFzcz0iZW1iZXItdmlldyBncmVldGluZyI+SG93ZHkgRGF2ZTwvcD4KICAgIDxwIGNsYXNzPSJlbWJlci12aWV3IGdyZWV0aW5nIj5Ib3dkeSBNYXJ5PC9wPgogICAgPHAgY2xhc3M9ImVtYmVyLXZpZXcgZ3JlZXRpbmciPkhvd2R5IFNhcmE8L3A+CiAgPC9kaXY+CiAgYGBgCgogIEBtZXRob2QgY29sbGVjdGlvbgogIEBmb3IgRW1iZXIuSGFuZGxlYmFycy5oZWxwZXJzCiAgQHBhcmFtIHtTdHJpbmd9IHBhdGgKICBAcGFyYW0ge0hhc2h9IG9wdGlvbnMKICBAcmV0dXJuIHtTdHJpbmd9IEhUTUwgc3RyaW5nCiAgQGRlcHJlY2F0ZWQgVXNlIGB7e2VhY2h9fWAgaGVscGVyIGluc3RlYWQuCiovCkVtYmVyLkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2NvbGxlY3Rpb24nLCBmdW5jdGlvbiBjb2xsZWN0aW9uSGVscGVyKHBhdGgsIG9wdGlvbnMpIHsKICBFbWJlci5kZXByZWNhdGUoIlVzaW5nIHRoZSB7e2NvbGxlY3Rpb259fSBoZWxwZXIgd2l0aG91dCBzcGVjaWZ5aW5nIGEgY2xhc3MgaGFzIGJlZW4gZGVwcmVjYXRlZCBhcyB0aGUge3tlYWNofX0gaGVscGVyIG5vdyBzdXBwb3J0cyB0aGUgc2FtZSBmdW5jdGlvbmFsaXR5LiIsIHBhdGggIT09ICdjb2xsZWN0aW9uJyk7CgogIC8vIElmIG5vIHBhdGggaXMgcHJvdmlkZWQsIHRyZWF0IHBhdGggcGFyYW0gYXMgb3B0aW9ucy4KICBpZiAocGF0aCAmJiBwYXRoLmRhdGEgJiYgcGF0aC5kYXRhLmlzUmVuZGVyRGF0YSkgewogICAgb3B0aW9ucyA9IHBhdGg7CiAgICBwYXRoID0gdW5kZWZpbmVkOwogICAgRW1iZXIuYXNzZXJ0KCJZb3UgY2Fubm90IHBhc3MgbW9yZSB0aGFuIG9uZSBhcmd1bWVudCB0byB0aGUgY29sbGVjdGlvbiBoZWxwZXIiLCBhcmd1bWVudHMubGVuZ3RoID09PSAxKTsKICB9IGVsc2UgewogICAgRW1iZXIuYXNzZXJ0KCJZb3UgY2Fubm90IHBhc3MgbW9yZSB0aGFuIG9uZSBhcmd1bWVudCB0byB0aGUgY29sbGVjdGlvbiBoZWxwZXIiLCBhcmd1bWVudHMubGVuZ3RoID09PSAyKTsKICB9CgogIHZhciBmbiA9IG9wdGlvbnMuZm47CiAgdmFyIGRhdGEgPSBvcHRpb25zLmRhdGE7CiAgdmFyIGludmVyc2UgPSBvcHRpb25zLmludmVyc2U7CiAgdmFyIHZpZXcgPSBvcHRpb25zLmRhdGEudmlldzsKCiAgLy8gSWYgcGFzc2VkIGEgcGF0aCBzdHJpbmcsIGNvbnZlcnQgdGhhdCBpbnRvIGFuIG9iamVjdC4KICAvLyBPdGhlcndpc2UsIGp1c3QgZGVmYXVsdCB0byB0aGUgc3RhbmRhcmQgY2xhc3MuCiAgdmFyIGNvbGxlY3Rpb25DbGFzczsKICBjb2xsZWN0aW9uQ2xhc3MgPSBwYXRoID8gaGFuZGxlYmFyc0dldCh0aGlzLCBwYXRoLCBvcHRpb25zKSA6IEVtYmVyLkNvbGxlY3Rpb25WaWV3OwogIEVtYmVyLmFzc2VydChmbXQoIiVAICNjb2xsZWN0aW9uOiBDb3VsZCBub3QgZmluZCBjb2xsZWN0aW9uIGNsYXNzICVAIiwgW2RhdGEudmlldywgcGF0aF0pLCAhIWNvbGxlY3Rpb25DbGFzcyk7CgogIHZhciBoYXNoID0gb3B0aW9ucy5oYXNoLCBpdGVtSGFzaCA9IHt9LCBtYXRjaDsKCiAgLy8gRXh0cmFjdCBpdGVtIHZpZXcgY2xhc3MgaWYgcHJvdmlkZWQgZWxzZSBkZWZhdWx0IHRvIHRoZSBzdGFuZGFyZCBjbGFzcwogIHZhciBjb2xsZWN0aW9uUHJvdG90eXBlID0gY29sbGVjdGlvbkNsYXNzLnByb3RvKCksCiAgICAgIGl0ZW1WaWV3Q2xhc3M7CgogIGlmIChoYXNoLml0ZW1WaWV3KSB7CiAgICB2YXIgY29udHJvbGxlciA9IGRhdGEua2V5d29yZHMuY29udHJvbGxlcjsKICAgIEVtYmVyLmFzc2VydCgnWW91IHNwZWNpZmllZCBhbiBpdGVtVmlldywgYnV0IHRoZSBjdXJyZW50IGNvbnRleHQgaGFzIG5vICcgKwogICAgICAgICAgICAgICAgICdjb250YWluZXIgdG8gbG9vayB0aGUgaXRlbVZpZXcgdXAgaW4uIFRoaXMgcHJvYmFibHkgbWVhbnMgJyArCiAgICAgICAgICAgICAgICAgJ3RoYXQgeW91IGNyZWF0ZWQgYSB2aWV3IG1hbnVhbGx5LCBpbnN0ZWFkIG9mIHRocm91Z2ggdGhlICcgKwogICAgICAgICAgICAgICAgICdjb250YWluZXIuIEluc3RlYWQsIHVzZSBjb250YWluZXIubG9va3VwKCJ2aWV3OnZpZXdOYW1lIiksICcgKwogICAgICAgICAgICAgICAgICd3aGljaCB3aWxsIHByb3Blcmx5IGluc3RhbnRpYXRlIHlvdXIgdmlldy4nLAogICAgICAgICAgICAgICAgIGNvbnRyb2xsZXIgJiYgY29udHJvbGxlci5jb250YWluZXIpOwogICAgdmFyIGNvbnRhaW5lciA9IGNvbnRyb2xsZXIuY29udGFpbmVyOwogICAgaXRlbVZpZXdDbGFzcyA9IGNvbnRhaW5lci5yZXNvbHZlKCd2aWV3OicgKyBoYXNoLml0ZW1WaWV3KTsKICAgIEVtYmVyLmFzc2VydCgnWW91IHNwZWNpZmllZCB0aGUgaXRlbVZpZXcgJyArIGhhc2guaXRlbVZpZXcgKyAiLCBidXQgaXQgd2FzICIgKwogICAgICAgICAgICAgICAgICJub3QgZm91bmQgYXQgIiArIGNvbnRhaW5lci5kZXNjcmliZSgidmlldzoiICsgaGFzaC5pdGVtVmlldykgKwogICAgICAgICAgICAgICAgICIgKGFuZCBpdCB3YXMgbm90IHJlZ2lzdGVyZWQgaW4gdGhlIGNvbnRhaW5lcikiLCAhIWl0ZW1WaWV3Q2xhc3MpOwogIH0gZWxzZSBpZiAoaGFzaC5pdGVtVmlld0NsYXNzKSB7CiAgICBpdGVtVmlld0NsYXNzID0gaGFuZGxlYmFyc0dldChjb2xsZWN0aW9uUHJvdG90eXBlLCBoYXNoLml0ZW1WaWV3Q2xhc3MsIG9wdGlvbnMpOwogIH0gZWxzZSB7CiAgICBpdGVtVmlld0NsYXNzID0gY29sbGVjdGlvblByb3RvdHlwZS5pdGVtVmlld0NsYXNzOwogIH0KCiAgRW1iZXIuYXNzZXJ0KGZtdCgiJUAgI2NvbGxlY3Rpb246IENvdWxkIG5vdCBmaW5kIGl0ZW1WaWV3Q2xhc3MgJUAiLCBbZGF0YS52aWV3LCBpdGVtVmlld0NsYXNzXSksICEhaXRlbVZpZXdDbGFzcyk7CgogIGRlbGV0ZSBoYXNoLml0ZW1WaWV3Q2xhc3M7CiAgZGVsZXRlIGhhc2guaXRlbVZpZXc7CgogIC8vIEdvIHRocm91Z2ggb3B0aW9ucyBwYXNzZWQgdG8gdGhlIHt7Y29sbGVjdGlvbn19IGhlbHBlciBhbmQgZXh0cmFjdCBvcHRpb25zCiAgLy8gdGhhdCBjb25maWd1cmUgaXRlbSB2aWV3cyBpbnN0ZWFkIG9mIHRoZSBjb2xsZWN0aW9uIGl0c2VsZi4KICBmb3IgKHZhciBwcm9wIGluIGhhc2gpIHsKICAgIGlmIChoYXNoLmhhc093blByb3BlcnR5KHByb3ApKSB7CiAgICAgIG1hdGNoID0gcHJvcC5tYXRjaCgvXml0ZW0oLikoLiopJC8pOwoKICAgICAgaWYgKG1hdGNoICYmIHByb3AgIT09ICdpdGVtQ29udHJvbGxlcicpIHsKICAgICAgICAvLyBDb252ZXJ0IGl0ZW1TaG91bGRGb28gLT4gc2hvdWxkRm9vCiAgICAgICAgaXRlbUhhc2hbbWF0Y2hbMV0udG9Mb3dlckNhc2UoKSArIG1hdGNoWzJdXSA9IGhhc2hbcHJvcF07CiAgICAgICAgLy8gRGVsZXRlIGZyb20gaGFzaCBhcyB0aGlzIHdpbGwgZW5kIHVwIGdldHRpbmcgcGFzc2VkIHRvIHRoZQogICAgICAgIC8vIHt7dmlld319IGhlbHBlciBtZXRob2QuCiAgICAgICAgZGVsZXRlIGhhc2hbcHJvcF07CiAgICAgIH0KICAgIH0KICB9CgogIGlmIChmbikgewogICAgaXRlbUhhc2gudGVtcGxhdGUgPSBmbjsKICAgIGRlbGV0ZSBvcHRpb25zLmZuOwogIH0KCiAgdmFyIGVtcHR5Vmlld0NsYXNzOwogIGlmIChpbnZlcnNlICYmIGludmVyc2UgIT09IEVtYmVyLkhhbmRsZWJhcnMuVk0ubm9vcCkgewogICAgZW1wdHlWaWV3Q2xhc3MgPSBnZXQoY29sbGVjdGlvblByb3RvdHlwZSwgJ2VtcHR5Vmlld0NsYXNzJyk7CiAgICBlbXB0eVZpZXdDbGFzcyA9IGVtcHR5Vmlld0NsYXNzLmV4dGVuZCh7CiAgICAgICAgICB0ZW1wbGF0ZTogaW52ZXJzZSwKICAgICAgICAgIHRhZ05hbWU6IGl0ZW1IYXNoLnRhZ05hbWUKICAgIH0pOwogIH0gZWxzZSBpZiAoaGFzaC5lbXB0eVZpZXdDbGFzcykgewogICAgZW1wdHlWaWV3Q2xhc3MgPSBoYW5kbGViYXJzR2V0KHRoaXMsIGhhc2guZW1wdHlWaWV3Q2xhc3MsIG9wdGlvbnMpOwogIH0KICBpZiAoZW1wdHlWaWV3Q2xhc3MpIHsgaGFzaC5lbXB0eVZpZXcgPSBlbXB0eVZpZXdDbGFzczsgfQoKICBpZiAoIWhhc2gua2V5d29yZCkgewogICAgaXRlbUhhc2guX2NvbnRleHQgPSBFbWJlci5jb21wdXRlZC5hbGlhcygnY29udGVudCcpOwogIH0KCiAgdmFyIHZpZXdPcHRpb25zID0gRW1iZXIuSGFuZGxlYmFycy5WaWV3SGVscGVyLnByb3BlcnRpZXNGcm9tSFRNTE9wdGlvbnMoeyBkYXRhOiBkYXRhLCBoYXNoOiBpdGVtSGFzaCB9LCB0aGlzKTsKICBoYXNoLml0ZW1WaWV3Q2xhc3MgPSBpdGVtVmlld0NsYXNzLmV4dGVuZCh2aWV3T3B0aW9ucyk7CgogIHJldHVybiBFbWJlci5IYW5kbGViYXJzLmhlbHBlcnMudmlldy5jYWxsKHRoaXMsIGNvbGxlY3Rpb25DbGFzcywgb3B0aW9ucyk7Cn0pOwoKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLypnbG9iYWxzIEhhbmRsZWJhcnMgKi8KLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1oYW5kbGViYXJzCiovCgp2YXIgaGFuZGxlYmFyc0dldCA9IEVtYmVyLkhhbmRsZWJhcnMuZ2V0OwoKLyoqCiAgYHVuYm91bmRgIGFsbG93cyB5b3UgdG8gb3V0cHV0IGEgcHJvcGVydHkgd2l0aG91dCBiaW5kaW5nLiAqSW1wb3J0YW50OiogVGhlCiAgb3V0cHV0IHdpbGwgbm90IGJlIHVwZGF0ZWQgaWYgdGhlIHByb3BlcnR5IGNoYW5nZXMuIFVzZSB3aXRoIGNhdXRpb24uCgogIGBgYGhhbmRsZWJhcnMKICA8ZGl2Pnt7dW5ib3VuZCBzb21lUHJvcGVydHlUaGF0RG9lc250Q2hhbmdlfX08L2Rpdj4KICBgYGAKCiAgYHVuYm91bmRgIGNhbiBhbHNvIGJlIHVzZWQgaW4gY29uanVuY3Rpb24gd2l0aCBhIGJvdW5kIGhlbHBlciB0bwogIHJlbmRlciBpdCBpbiBpdHMgdW5ib3VuZCBmb3JtOgoKICBgYGBoYW5kbGViYXJzCiAgPGRpdj57e3VuYm91bmQgaGVscGVyTmFtZSBzb21lUHJvcGVydHlUaGF0RG9lc250Q2hhbmdlfX08L2Rpdj4KICBgYGAKCiAgQG1ldGhvZCB1bmJvdW5kCiAgQGZvciBFbWJlci5IYW5kbGViYXJzLmhlbHBlcnMKICBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkKICBAcmV0dXJuIHtTdHJpbmd9IEhUTUwgc3RyaW5nCiovCkVtYmVyLkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3VuYm91bmQnLCBmdW5jdGlvbiB1bmJvdW5kSGVscGVyKHByb3BlcnR5LCBmbikgewogIHZhciBvcHRpb25zID0gYXJndW1lbnRzW2FyZ3VtZW50cy5sZW5ndGggLSAxXSwgaGVscGVyLCBjb250ZXh0LCBvdXQ7CgogIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMikgewogICAgLy8gVW5ib3VuZCBoZWxwZXIgY2FsbC4KICAgIG9wdGlvbnMuZGF0YS5pc1VuYm91bmQgPSB0cnVlOwogICAgaGVscGVyID0gRW1iZXIuSGFuZGxlYmFycy5oZWxwZXJzW2FyZ3VtZW50c1swXV0gfHwgRW1iZXIuSGFuZGxlYmFycy5oZWxwZXJzLmhlbHBlck1pc3Npbmc7CiAgICBvdXQgPSBoZWxwZXIuYXBwbHkodGhpcywgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBkZWxldGUgb3B0aW9ucy5kYXRhLmlzVW5ib3VuZDsKICAgIHJldHVybiBvdXQ7CiAgfQoKICBjb250ZXh0ID0gKGZuLmNvbnRleHRzICYmIGZuLmNvbnRleHRzLmxlbmd0aCkgPyBmbi5jb250ZXh0c1swXSA6IHRoaXM7CiAgcmV0dXJuIGhhbmRsZWJhcnNHZXQoY29udGV4dCwgcHJvcGVydHksIGZuKTsKfSk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qanNoaW50IGRlYnVnOnRydWUqLwovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLWhhbmRsZWJhcnMKKi8KCnZhciBnZXQgPSBFbWJlci5nZXQsIGhhbmRsZWJhcnNHZXQgPSBFbWJlci5IYW5kbGViYXJzLmdldCwgbm9ybWFsaXplUGF0aCA9IEVtYmVyLkhhbmRsZWJhcnMubm9ybWFsaXplUGF0aDsKCi8qKgogIGBsb2dgIGFsbG93cyB5b3UgdG8gb3V0cHV0IHRoZSB2YWx1ZSBvZiBhIHZhcmlhYmxlIGluIHRoZSBjdXJyZW50IHJlbmRlcmluZwogIGNvbnRleHQuCgogIGBgYGhhbmRsZWJhcnMKICB7e2xvZyBteVZhcmlhYmxlfX0KICBgYGAKCiAgQG1ldGhvZCBsb2cKICBAZm9yIEVtYmVyLkhhbmRsZWJhcnMuaGVscGVycwogIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eQoqLwpFbWJlci5IYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdsb2cnLCBmdW5jdGlvbiBsb2dIZWxwZXIocHJvcGVydHksIG9wdGlvbnMpIHsKICB2YXIgY29udGV4dCA9IChvcHRpb25zLmNvbnRleHRzICYmIG9wdGlvbnMuY29udGV4dHMubGVuZ3RoKSA/IG9wdGlvbnMuY29udGV4dHNbMF0gOiB0aGlzLAogICAgICBub3JtYWxpemVkID0gbm9ybWFsaXplUGF0aChjb250ZXh0LCBwcm9wZXJ0eSwgb3B0aW9ucy5kYXRhKSwKICAgICAgcGF0aFJvb3QgPSBub3JtYWxpemVkLnJvb3QsCiAgICAgIHBhdGggPSBub3JtYWxpemVkLnBhdGgsCiAgICAgIHZhbHVlID0gKHBhdGggPT09ICd0aGlzJykgPyBwYXRoUm9vdCA6IGhhbmRsZWJhcnNHZXQocGF0aFJvb3QsIHBhdGgsIG9wdGlvbnMpOwogIEVtYmVyLkxvZ2dlci5sb2codmFsdWUpOwp9KTsKCi8qKgogIEV4ZWN1dGUgdGhlIGBkZWJ1Z2dlcmAgc3RhdGVtZW50IGluIHRoZSBjdXJyZW50IGNvbnRleHQuCgogIGBgYGhhbmRsZWJhcnMKICB7e2RlYnVnZ2VyfX0KICBgYGAKCiAgQmVmb3JlIGludm9raW5nIHRoZSBgZGVidWdnZXJgIHN0YXRlbWVudCwgdGhlcmUKICBhcmUgYSBmZXcgaGVscGZ1bCB2YXJpYWJsZXMgZGVmaW5lZCBpbiB0aGUKICBib2R5IG9mIHRoaXMgaGVscGVyIHRoYXQgeW91IGNhbiBpbnNwZWN0IHdoaWxlCiAgZGVidWdnaW5nIHRoYXQgZGVzY3JpYmUgaG93IGFuZCB3aGVyZSB0aGlzCiAgaGVscGVyIHdhcyBpbnZva2VkOgoKICAtIHRlbXBsYXRlQ29udGV4dDogdGhpcyBpcyBtb3N0IGxpa2VseSBhIGNvbnRyb2xsZXIKICAgIGZyb20gd2hpY2ggdGhpcyB0ZW1wbGF0ZSBsb29rcyB1cCAvIGRpc3BsYXlzIHByb3BlcnRpZXMKICAtIHR5cGVPZlRlbXBsYXRlQ29udGV4dDogYSBzdHJpbmcgZGVzY3JpcHRpb24gb2YKICAgIHdoYXQgdGhlIHRlbXBsYXRlQ29udGV4dCBpcwoKICBGb3IgZXhhbXBsZSwgaWYgeW91J3JlIHdvbmRlcmluZyB3aHkgYSB2YWx1ZSBge3tmb299fWAKICBpc24ndCByZW5kZXJpbmcgYXMgZXhwZWN0ZWQgd2l0aGluIGEgdGVtcGxhdGUsIHlvdQogIGNvdWxkIHBsYWNlIGEgYHt7ZGVidWdnZXJ9fWAgc3RhdGVtZW50LCBhbmQgd2hlbgogIHRoZSBgZGVidWdnZXI7YCBicmVha3BvaW50IGlzIGhpdCwgeW91IGNhbiBpbnNwZWN0CiAgYHRlbXBsYXRlQ29udGV4dGAsIGRldGVybWluZSBpZiBpdCdzIHRoZSBvYmplY3QgeW91CiAgZXhwZWN0LCBhbmQvb3IgZXZhbHVhdGUgZXhwcmVzc2lvbnMgaW4gdGhlIGNvbnNvbGUKICB0byBwZXJmb3JtIHByb3BlcnR5IGxvb2t1cHMgb24gdGhlIGB0ZW1wbGF0ZUNvbnRleHRgOgoKICBgYGAKICAgID4gdGVtcGxhdGVDb250ZXh0LmdldCgnZm9vJykgLy8gLT4gIjx2YWx1ZSBvZiB7e2Zvb319PiIKICBgYGAKCiAgQG1ldGhvZCBkZWJ1Z2dlcgogIEBmb3IgRW1iZXIuSGFuZGxlYmFycy5oZWxwZXJzCiAgQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5CiovCkVtYmVyLkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2RlYnVnZ2VyJywgZnVuY3Rpb24gZGVidWdnZXJIZWxwZXIob3B0aW9ucykgewoKICAvLyBUaGVzZSBhcmUgaGVscGZ1bCB2YWx1ZXMgeW91IGNhbiBpbnNwZWN0IHdoaWxlIGRlYnVnZ2luZy4KICB2YXIgdGVtcGxhdGVDb250ZXh0ID0gdGhpczsKICB2YXIgdHlwZU9mVGVtcGxhdGVDb250ZXh0ID0gRW1iZXIuaW5zcGVjdCh0ZW1wbGF0ZUNvbnRleHQpOwoKICBkZWJ1Z2dlcjsKfSk7CgoKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1oYW5kbGViYXJzCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQ7CgpFbWJlci5IYW5kbGViYXJzLkVhY2hWaWV3ID0gRW1iZXIuQ29sbGVjdGlvblZpZXcuZXh0ZW5kKEVtYmVyLl9NZXRhbW9ycGgsIHsKICBpbml0OiBmdW5jdGlvbigpIHsKICAgIHZhciBpdGVtQ29udHJvbGxlciA9IGdldCh0aGlzLCAnaXRlbUNvbnRyb2xsZXInKTsKICAgIHZhciBiaW5kaW5nOwoKICAgIGlmIChpdGVtQ29udHJvbGxlcikgewogICAgICB2YXIgY29udHJvbGxlciA9IGdldCh0aGlzLCAnY29udHJvbGxlci5jb250YWluZXInKS5sb29rdXBGYWN0b3J5KCdjb250cm9sbGVyOmFycmF5JykuY3JlYXRlKHsKICAgICAgICBwYXJlbnRDb250cm9sbGVyOiBnZXQodGhpcywgJ2NvbnRyb2xsZXInKSwKICAgICAgICBpdGVtQ29udHJvbGxlcjogaXRlbUNvbnRyb2xsZXIsCiAgICAgICAgdGFyZ2V0OiBnZXQodGhpcywgJ2NvbnRyb2xsZXInKSwKICAgICAgICBfZWFjaFZpZXc6IHRoaXMKICAgICAgfSk7CgogICAgICB0aGlzLmRpc2FibGVDb250ZW50T2JzZXJ2ZXJzKGZ1bmN0aW9uKCkgewogICAgICAgIHNldCh0aGlzLCAnY29udGVudCcsIGNvbnRyb2xsZXIpOwogICAgICAgIGJpbmRpbmcgPSBuZXcgRW1iZXIuQmluZGluZygnY29udGVudCcsICdfZWFjaFZpZXcuZGF0YVNvdXJjZScpLm9uZVdheSgpOwogICAgICAgIGJpbmRpbmcuY29ubmVjdChjb250cm9sbGVyKTsKICAgICAgfSk7CgogICAgICBzZXQodGhpcywgJ19hcnJheUNvbnRyb2xsZXInLCBjb250cm9sbGVyKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuZGlzYWJsZUNvbnRlbnRPYnNlcnZlcnMoZnVuY3Rpb24oKSB7CiAgICAgICAgYmluZGluZyA9IG5ldyBFbWJlci5CaW5kaW5nKCdjb250ZW50JywgJ2RhdGFTb3VyY2UnKS5vbmVXYXkoKTsKICAgICAgICBiaW5kaW5nLmNvbm5lY3QodGhpcyk7CiAgICAgIH0pOwogICAgfQoKICAgIHJldHVybiB0aGlzLl9zdXBlcigpOwogIH0sCgogIF9hc3NlcnRBcnJheUxpa2U6IGZ1bmN0aW9uKGNvbnRlbnQpIHsKICAgIEVtYmVyLmFzc2VydCgiVGhlIHZhbHVlIHRoYXQgI2VhY2ggbG9vcHMgb3ZlciBtdXN0IGJlIGFuIEFycmF5LiBZb3UgcGFzc2VkICIgKyBjb250ZW50LmNvbnN0cnVjdG9yICsgIiwgYnV0IGl0IHNob3VsZCBoYXZlIGJlZW4gYW4gQXJyYXlDb250cm9sbGVyIiwgIUVtYmVyLkNvbnRyb2xsZXJNaXhpbi5kZXRlY3QoY29udGVudCkgfHwgKGNvbnRlbnQgJiYgY29udGVudC5pc0dlbmVyYXRlZCkgfHwgY29udGVudCBpbnN0YW5jZW9mIEVtYmVyLkFycmF5Q29udHJvbGxlcik7CiAgICBFbWJlci5hc3NlcnQoIlRoZSB2YWx1ZSB0aGF0ICNlYWNoIGxvb3BzIG92ZXIgbXVzdCBiZSBhbiBBcnJheS4gWW91IHBhc3NlZCAiICsgKChFbWJlci5Db250cm9sbGVyTWl4aW4uZGV0ZWN0KGNvbnRlbnQpICYmIGNvbnRlbnQuZ2V0KCdtb2RlbCcpICE9PSB1bmRlZmluZWQpID8gKCIiICsgY29udGVudC5nZXQoJ21vZGVsJykgKyAiICh3cmFwcGVkIGluICIgKyBjb250ZW50ICsgIikiKSA6ICgiIiArIGNvbnRlbnQpKSwgRW1iZXIuQXJyYXkuZGV0ZWN0KGNvbnRlbnQpKTsKICB9LAoKICBkaXNhYmxlQ29udGVudE9ic2VydmVyczogZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgIEVtYmVyLnJlbW92ZUJlZm9yZU9ic2VydmVyKHRoaXMsICdjb250ZW50JywgbnVsbCwgJ19jb250ZW50V2lsbENoYW5nZScpOwogICAgRW1iZXIucmVtb3ZlT2JzZXJ2ZXIodGhpcywgJ2NvbnRlbnQnLCBudWxsLCAnX2NvbnRlbnREaWRDaGFuZ2UnKTsKCiAgICBjYWxsYmFjay5jYWxsKHRoaXMpOwoKICAgIEVtYmVyLmFkZEJlZm9yZU9ic2VydmVyKHRoaXMsICdjb250ZW50JywgbnVsbCwgJ19jb250ZW50V2lsbENoYW5nZScpOwogICAgRW1iZXIuYWRkT2JzZXJ2ZXIodGhpcywgJ2NvbnRlbnQnLCBudWxsLCAnX2NvbnRlbnREaWRDaGFuZ2UnKTsKICB9LAoKICBpdGVtVmlld0NsYXNzOiBFbWJlci5fTWV0YW1vcnBoVmlldywKICBlbXB0eVZpZXdDbGFzczogRW1iZXIuX01ldGFtb3JwaFZpZXcsCgogIGNyZWF0ZUNoaWxkVmlldzogZnVuY3Rpb24odmlldywgYXR0cnMpIHsKICAgIHZpZXcgPSB0aGlzLl9zdXBlcih2aWV3LCBhdHRycyk7CgogICAgLy8gQXQgdGhlIG1vbWVudCwgaWYgYSBjb250YWluZXIgdmlldyBzdWJjbGFzcyB3YW50cwogICAgLy8gdG8gaW5zZXJ0IGtleXdvcmRzLCBpdCBpcyByZXNwb25zaWJsZSBmb3IgY2xvbmluZwogICAgLy8gdGhlIGtleXdvcmRzIGhhc2guIFRoaXMgd2lsbCBiZSBmaXhlZCBtb21lbnRhcmlseS4KICAgIHZhciBrZXl3b3JkID0gZ2V0KHRoaXMsICdrZXl3b3JkJyk7CiAgICB2YXIgY29udGVudCA9IGdldCh2aWV3LCAnY29udGVudCcpOwoKICAgIGlmIChrZXl3b3JkKSB7CiAgICAgIHZhciBkYXRhID0gZ2V0KHZpZXcsICd0ZW1wbGF0ZURhdGEnKTsKCiAgICAgIGRhdGEgPSBFbWJlci5jb3B5KGRhdGEpOwogICAgICBkYXRhLmtleXdvcmRzID0gdmlldy5jbG9uZUtleXdvcmRzKCk7CiAgICAgIHNldCh2aWV3LCAndGVtcGxhdGVEYXRhJywgZGF0YSk7CgogICAgICAvLyBJbiB0aGlzIGNhc2UsIHdlIGRvIG5vdCBiaW5kLCBiZWNhdXNlIHRoZSBgY29udGVudGAgb2YKICAgICAgLy8gYSAjZWFjaCBpdGVtIGNhbm5vdCBjaGFuZ2UuCiAgICAgIGRhdGEua2V5d29yZHNba2V5d29yZF0gPSBjb250ZW50OwogICAgfQoKICAgIC8vIElmIHt7I2VhY2h9fSBpcyBsb29waW5nIG92ZXIgYW4gYXJyYXkgb2YgY29udHJvbGxlcnMsCiAgICAvLyBwb2ludCBlYWNoIGNoaWxkIHZpZXcgYXQgdGhlaXIgcmVzcGVjdGl2ZSBjb250cm9sbGVyLgogICAgaWYgKGNvbnRlbnQgJiYgZ2V0KGNvbnRlbnQsICdpc0NvbnRyb2xsZXInKSkgewogICAgICBzZXQodmlldywgJ2NvbnRyb2xsZXInLCBjb250ZW50KTsKICAgIH0KCiAgICByZXR1cm4gdmlldzsKICB9LAoKICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgIGlmICghdGhpcy5fc3VwZXIoKSkgeyByZXR1cm47IH0KCiAgICB2YXIgYXJyYXlDb250cm9sbGVyID0gZ2V0KHRoaXMsICdfYXJyYXlDb250cm9sbGVyJyk7CgogICAgaWYgKGFycmF5Q29udHJvbGxlcikgewogICAgICBhcnJheUNvbnRyb2xsZXIuZGVzdHJveSgpOwogICAgfQoKICAgIHJldHVybiB0aGlzOwogIH0KfSk7Cgp2YXIgR3JvdXBlZEVhY2ggPSBFbWJlci5IYW5kbGViYXJzLkdyb3VwZWRFYWNoID0gZnVuY3Rpb24oY29udGV4dCwgcGF0aCwgb3B0aW9ucykgewogIHZhciBzZWxmID0gdGhpcywKICAgICAgbm9ybWFsaXplZCA9IEVtYmVyLkhhbmRsZWJhcnMubm9ybWFsaXplUGF0aChjb250ZXh0LCBwYXRoLCBvcHRpb25zLmRhdGEpOwoKICB0aGlzLmNvbnRleHQgPSBjb250ZXh0OwogIHRoaXMucGF0aCA9IHBhdGg7CiAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICB0aGlzLnRlbXBsYXRlID0gb3B0aW9ucy5mbjsKICB0aGlzLmNvbnRhaW5pbmdWaWV3ID0gb3B0aW9ucy5kYXRhLnZpZXc7CiAgdGhpcy5ub3JtYWxpemVkUm9vdCA9IG5vcm1hbGl6ZWQucm9vdDsKICB0aGlzLm5vcm1hbGl6ZWRQYXRoID0gbm9ybWFsaXplZC5wYXRoOwogIHRoaXMuY29udGVudCA9IHRoaXMubG9va3VwQ29udGVudCgpOwoKICB0aGlzLmFkZENvbnRlbnRPYnNlcnZlcnMoKTsKICB0aGlzLmFkZEFycmF5T2JzZXJ2ZXJzKCk7CgogIHRoaXMuY29udGFpbmluZ1ZpZXcub24oJ3dpbGxDbGVhclJlbmRlcicsIGZ1bmN0aW9uKCkgewogICAgc2VsZi5kZXN0cm95KCk7CiAgfSk7Cn07CgpHcm91cGVkRWFjaC5wcm90b3R5cGUgPSB7CiAgY29udGVudFdpbGxDaGFuZ2U6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5yZW1vdmVBcnJheU9ic2VydmVycygpOwogIH0sCgogIGNvbnRlbnREaWRDaGFuZ2U6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5jb250ZW50ID0gdGhpcy5sb29rdXBDb250ZW50KCk7CiAgICB0aGlzLmFkZEFycmF5T2JzZXJ2ZXJzKCk7CiAgICB0aGlzLnJlcmVuZGVyQ29udGFpbmluZ1ZpZXcoKTsKICB9LAoKICBjb250ZW50QXJyYXlXaWxsQ2hhbmdlOiBFbWJlci5LLAoKICBjb250ZW50QXJyYXlEaWRDaGFuZ2U6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5yZXJlbmRlckNvbnRhaW5pbmdWaWV3KCk7CiAgfSwKCiAgbG9va3VwQ29udGVudDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gRW1iZXIuSGFuZGxlYmFycy5nZXQodGhpcy5ub3JtYWxpemVkUm9vdCwgdGhpcy5ub3JtYWxpemVkUGF0aCwgdGhpcy5vcHRpb25zKTsKICB9LAoKICBhZGRBcnJheU9ic2VydmVyczogZnVuY3Rpb24oKSB7CiAgICBpZiAoIXRoaXMuY29udGVudCkgeyByZXR1cm47IH0KCiAgICB0aGlzLmNvbnRlbnQuYWRkQXJyYXlPYnNlcnZlcih0aGlzLCB7CiAgICAgIHdpbGxDaGFuZ2U6ICdjb250ZW50QXJyYXlXaWxsQ2hhbmdlJywKICAgICAgZGlkQ2hhbmdlOiAnY29udGVudEFycmF5RGlkQ2hhbmdlJwogICAgfSk7CiAgfSwKCiAgcmVtb3ZlQXJyYXlPYnNlcnZlcnM6IGZ1bmN0aW9uKCkgewogICAgaWYgKCF0aGlzLmNvbnRlbnQpIHsgcmV0dXJuOyB9CgogICAgdGhpcy5jb250ZW50LnJlbW92ZUFycmF5T2JzZXJ2ZXIodGhpcywgewogICAgICB3aWxsQ2hhbmdlOiAnY29udGVudEFycmF5V2lsbENoYW5nZScsCiAgICAgIGRpZENoYW5nZTogJ2NvbnRlbnRBcnJheURpZENoYW5nZScKICAgIH0pOwogIH0sCgogIGFkZENvbnRlbnRPYnNlcnZlcnM6IGZ1bmN0aW9uKCkgewogICAgRW1iZXIuYWRkQmVmb3JlT2JzZXJ2ZXIodGhpcy5ub3JtYWxpemVkUm9vdCwgdGhpcy5ub3JtYWxpemVkUGF0aCwgdGhpcywgdGhpcy5jb250ZW50V2lsbENoYW5nZSk7CiAgICBFbWJlci5hZGRPYnNlcnZlcih0aGlzLm5vcm1hbGl6ZWRSb290LCB0aGlzLm5vcm1hbGl6ZWRQYXRoLCB0aGlzLCB0aGlzLmNvbnRlbnREaWRDaGFuZ2UpOwogIH0sCgogIHJlbW92ZUNvbnRlbnRPYnNlcnZlcnM6IGZ1bmN0aW9uKCkgewogICAgRW1iZXIucmVtb3ZlQmVmb3JlT2JzZXJ2ZXIodGhpcy5ub3JtYWxpemVkUm9vdCwgdGhpcy5ub3JtYWxpemVkUGF0aCwgdGhpcy5jb250ZW50V2lsbENoYW5nZSk7CiAgICBFbWJlci5yZW1vdmVPYnNlcnZlcih0aGlzLm5vcm1hbGl6ZWRSb290LCB0aGlzLm5vcm1hbGl6ZWRQYXRoLCB0aGlzLmNvbnRlbnREaWRDaGFuZ2UpOwogIH0sCgogIHJlbmRlcjogZnVuY3Rpb24oKSB7CiAgICBpZiAoIXRoaXMuY29udGVudCkgeyByZXR1cm47IH0KCiAgICB2YXIgY29udGVudCA9IHRoaXMuY29udGVudCwKICAgICAgICBjb250ZW50TGVuZ3RoID0gZ2V0KGNvbnRlbnQsICdsZW5ndGgnKSwKICAgICAgICBkYXRhID0gdGhpcy5vcHRpb25zLmRhdGEsCiAgICAgICAgdGVtcGxhdGUgPSB0aGlzLnRlbXBsYXRlOwoKICAgIGRhdGEuaW5zaWRlRWFjaCA9IHRydWU7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvbnRlbnRMZW5ndGg7IGkrKykgewogICAgICB0ZW1wbGF0ZShjb250ZW50Lm9iamVjdEF0KGkpLCB7IGRhdGE6IGRhdGEgfSk7CiAgICB9CiAgfSwKCiAgcmVyZW5kZXJDb250YWluaW5nVmlldzogZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBFbWJlci5ydW4uc2NoZWR1bGVPbmNlKCdyZW5kZXInLCB0aGlzLCBmdW5jdGlvbigpIHsKICAgICAgLy8gSXQncyBwb3NzaWJsZSBpdCdzIGJlZW4gZGVzdHJveWVkIGFmdGVyIHdlIGVucXVldWVkIGEgcmUtcmVuZGVyIGNhbGwuCiAgICAgIGlmICghc2VsZi5kZXN0cm95ZWQpIHsKICAgICAgICBzZWxmLmNvbnRhaW5pbmdWaWV3LnJlcmVuZGVyKCk7CiAgICAgIH0KICAgIH0pOwogIH0sCgogIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5yZW1vdmVDb250ZW50T2JzZXJ2ZXJzKCk7CiAgICBpZiAodGhpcy5jb250ZW50KSB7CiAgICAgIHRoaXMucmVtb3ZlQXJyYXlPYnNlcnZlcnMoKTsKICAgIH0KICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZTsKICB9Cn07CgovKioKICBUaGUgYHt7I2VhY2h9fWAgaGVscGVyIGxvb3BzIG92ZXIgZWxlbWVudHMgaW4gYSBjb2xsZWN0aW9uLCByZW5kZXJpbmcgaXRzCiAgYmxvY2sgb25jZSBmb3IgZWFjaCBpdGVtLiBJdCBpcyBhbiBleHRlbnNpb24gb2YgdGhlIGJhc2UgSGFuZGxlYmFycyBge3sjZWFjaH19YAogIGhlbHBlcjoKCiAgYGBgamF2YXNjcmlwdAogIERldmVsb3BlcnMgPSBbe25hbWU6ICdZZWh1ZGEnfSx7bmFtZTogJ1RvbSd9LCB7bmFtZTogJ1BhdWwnfV07CiAgYGBgCgogIGBgYGhhbmRsZWJhcnMKICB7eyNlYWNoIERldmVsb3BlcnN9fQogICAge3tuYW1lfX0KICB7ey9lYWNofX0KICBgYGAKCiAgYHt7ZWFjaH19YCBzdXBwb3J0cyBhbiBhbHRlcm5hdGl2ZSBzeW50YXggd2l0aCBlbGVtZW50IG5hbWluZzoKCiAgYGBgaGFuZGxlYmFycwogIHt7I2VhY2ggcGVyc29uIGluIERldmVsb3BlcnN9fQogICAge3twZXJzb24ubmFtZX19CiAge3svZWFjaH19CiAgYGBgCgogIFdoZW4gbG9vcGluZyBvdmVyIG9iamVjdHMgdGhhdCBkbyBub3QgaGF2ZSBwcm9wZXJ0aWVzLCBge3t0aGlzfX1gIGNhbiBiZSB1c2VkCiAgdG8gcmVuZGVyIHRoZSBvYmplY3Q6CgogIGBgYGphdmFzY3JpcHQKICBEZXZlbG9wZXJOYW1lcyA9IFsnWWVodWRhJywgJ1RvbScsICdQYXVsJ10KICBgYGAKCiAgYGBgaGFuZGxlYmFycwogIHt7I2VhY2ggRGV2ZWxvcGVyTmFtZXN9fQogICAge3t0aGlzfX0KICB7ey9lYWNofX0KICBgYGAKICAjIyMge3tlbHNlfX0gY29uZGl0aW9uCiAgYHt7I2VhY2h9fWAgY2FuIGhhdmUgYSBtYXRjaGluZyBge3tlbHNlfX1gLiBUaGUgY29udGVudHMgb2YgdGhpcyBibG9jayB3aWxsIHJlbmRlcgogIGlmIHRoZSBjb2xsZWN0aW9uIGlzIGVtcHR5LgoKICBgYGAKICB7eyNlYWNoIHBlcnNvbiBpbiBEZXZlbG9wZXJzfX0KICAgIHt7cGVyc29uLm5hbWV9fQogIHt7ZWxzZX19CiAgICA8cD5Tb3JyeSwgbm9ib2R5IGlzIGF2YWlsYWJsZSBmb3IgdGhpcyB0YXNrLjwvcD4KICB7ey9lYWNofX0KICBgYGAKICAjIyMgU3BlY2lmeWluZyBhIFZpZXcgY2xhc3MgZm9yIGl0ZW1zCiAgSWYgeW91IHByb3ZpZGUgYW4gYGl0ZW1WaWV3Q2xhc3NgIG9wdGlvbiB0aGF0IHJlZmVyZW5jZXMgYSB2aWV3IGNsYXNzCiAgd2l0aCBpdHMgb3duIGB0ZW1wbGF0ZWAgeW91IGNhbiBvbWl0IHRoZSBibG9jay4KCiAgVGhlIGZvbGxvd2luZyB0ZW1wbGF0ZToKCiAgYGBgaGFuZGxlYmFycwogIHt7I3ZpZXcgQXBwLk15VmlldyB9fQogICAge3tlYWNoIHZpZXcuaXRlbXMgaXRlbVZpZXdDbGFzcz0iQXBwLkFuSXRlbVZpZXcifX0KICB7ey92aWV3fX0KICBgYGAKCiAgQW5kIGFwcGxpY2F0aW9uIGNvZGUKCiAgYGBgamF2YXNjcmlwdAogIEFwcCA9IEVtYmVyLkFwcGxpY2F0aW9uLmNyZWF0ZSh7CiAgICBNeVZpZXc6IEVtYmVyLlZpZXcuZXh0ZW5kKHsKICAgICAgaXRlbXM6IFsKICAgICAgICBFbWJlci5PYmplY3QuY3JlYXRlKHtuYW1lOiAnRGF2ZSd9KSwKICAgICAgICBFbWJlci5PYmplY3QuY3JlYXRlKHtuYW1lOiAnTWFyeSd9KSwKICAgICAgICBFbWJlci5PYmplY3QuY3JlYXRlKHtuYW1lOiAnU2FyYSd9KQogICAgICBdCiAgICB9KQogIH0pOwoKICBBcHAuQW5JdGVtVmlldyA9IEVtYmVyLlZpZXcuZXh0ZW5kKHsKICAgIHRlbXBsYXRlOiBFbWJlci5IYW5kbGViYXJzLmNvbXBpbGUoIkdyZWV0aW5ncyB7e25hbWV9fSIpCiAgfSk7CiAgYGBgCgogIFdpbGwgcmVzdWx0IGluIHRoZSBIVE1MIHN0cnVjdHVyZSBiZWxvdwoKICBgYGBodG1sCiAgPGRpdiBjbGFzcz0iZW1iZXItdmlldyI+CiAgICA8ZGl2IGNsYXNzPSJlbWJlci12aWV3Ij5HcmVldGluZ3MgRGF2ZTwvZGl2PgogICAgPGRpdiBjbGFzcz0iZW1iZXItdmlldyI+R3JlZXRpbmdzIE1hcnk8L2Rpdj4KICAgIDxkaXYgY2xhc3M9ImVtYmVyLXZpZXciPkdyZWV0aW5ncyBTYXJhPC9kaXY+CiAgPC9kaXY+CiAgYGBgCgogIElmIGFuIGBpdGVtVmlld0NsYXNzYCBpcyBkZWZpbmVkIG9uIHRoZSBoZWxwZXIsIGFuZCB0aGVyZWZvcmUgdGhlIGhlbHBlciBpcyBub3QKICBiZWluZyB1c2VkIGFzIGEgYmxvY2ssIGFuIGBlbXB0eVZpZXdDbGFzc2AgY2FuIGFsc28gYmUgcHJvdmlkZWQgb3B0aW9uYWxseS4KICBUaGUgYGVtcHR5Vmlld0NsYXNzYCB3aWxsIG1hdGNoIHRoZSBiZWhhdmlvciBvZiB0aGUgYHt7ZWxzZX19YCBjb25kaXRpb24KICBkZXNjcmliZWQgYWJvdmUuIFRoYXQgaXMsIHRoZSBgZW1wdHlWaWV3Q2xhc3NgIHdpbGwgcmVuZGVyIGlmIHRoZSBjb2xsZWN0aW9uCiAgaXMgZW1wdHkuCgogICMjIyBSZXByZXNlbnRpbmcgZWFjaCBpdGVtIHdpdGggYSBDb250cm9sbGVyLgogIEJ5IGRlZmF1bHQgdGhlIGNvbnRyb2xsZXIgbG9va3VwIHdpdGhpbiBhbiBge3sjZWFjaH19YCBibG9jayB3aWxsIGJlCiAgdGhlIGNvbnRyb2xsZXIgb2YgdGhlIHRlbXBsYXRlIHdoZXJlIHRoZSBge3sjZWFjaH19YCB3YXMgdXNlZC4gSWYgZWFjaAogIGl0ZW0gbmVlZHMgdG8gYmUgcHJlc2VudGVkIGJ5IGEgY3VzdG9tIGNvbnRyb2xsZXIgeW91IGNhbiBwcm92aWRlIGEKICBgaXRlbUNvbnRyb2xsZXJgIG9wdGlvbiB3aGljaCByZWZlcmVuY2VzIGEgY29udHJvbGxlciBieSBsb29rdXAgbmFtZS4KICBFYWNoIGl0ZW0gaW4gdGhlIGxvb3Agd2lsbCBiZSB3cmFwcGVkIGluIGFuIGluc3RhbmNlIG9mIHRoaXMgY29udHJvbGxlcgogIGFuZCB0aGUgaXRlbSBpdHNlbGYgd2lsbCBiZSBzZXQgdG8gdGhlIGBjb250ZW50YCBwcm9wZXJ0eSBvZiB0aGF0IGNvbnRyb2xsZXIuCgogIFRoaXMgaXMgdXNlZnVsIGluIGNhc2VzIHdoZXJlIHByb3BlcnRpZXMgb2YgbW9kZWwgb2JqZWN0cyBuZWVkIHRyYW5zZm9ybWF0aW9uCiAgb3Igc3ludGhlc2lzIGZvciBkaXNwbGF5OgoKICBgYGBqYXZhc2NyaXB0CiAgQXBwLkRldmVsb3BlckNvbnRyb2xsZXIgPSBFbWJlci5PYmplY3RDb250cm9sbGVyLmV4dGVuZCh7CiAgICBpc0F2YWlsYWJsZUZvckhpcmU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gIXRoaXMuZ2V0KCdjb250ZW50LmlzRW1wbG95ZWQnKSAmJiB0aGlzLmdldCgnY29udGVudC5pc1NlZWtpbmdXb3JrJyk7CiAgICB9LnByb3BlcnR5KCdpc0VtcGxveWVkJywgJ2lzU2Vla2luZ1dvcmsnKQogIH0pCiAgYGBgCgogIGBgYGhhbmRsZWJhcnMKICB7eyNlYWNoIHBlcnNvbiBpbiBkZXZlbG9wZXJzIGl0ZW1Db250cm9sbGVyPSJkZXZlbG9wZXIifX0KICAgIHt7cGVyc29uLm5hbWV9fSB7eyNpZiBwZXJzb24uaXNBdmFpbGFibGVGb3JIaXJlfX1IaXJlIG1lIXt7L2lmfX0KICB7ey9lYWNofX0KICBgYGAKCiAgRWFjaCBpdGVtQ29udHJvbGxlciB3aWxsIHJlY2VpdmUgYSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnQgY29udHJvbGxlciBhcwogIGEgYHBhcmVudENvbnRyb2xsZXJgIHByb3BlcnR5LgoKICAjIyMgKEV4cGVyaW1lbnRhbCkgR3JvdXBlZCBFYWNoCgogIFdoZW4gdXNlZCBpbiBjb25qdW5jdGlvbiB3aXRoIHRoZSBleHBlcmltZW50YWwgW2dyb3VwIGhlbHBlcl0oaHR0cHM6Ly9naXRodWIuY29tL2VtYmVyanMvZ3JvdXAtaGVscGVyKSwKICB5b3UgY2FuIGluZm9ybSBIYW5kbGViYXJzIHRvIHJlLXJlbmRlciBhbiBlbnRpcmUgZ3JvdXAgb2YgaXRlbXMgaW5zdGVhZCBvZgogIHJlLXJlbmRlcmluZyB0aGVtIG9uZSBhdCBhIHRpbWUgKGluIHRoZSBldmVudCB0aGF0IHRoZXkgYXJlIGNoYW5nZWQgZW4gbWFzc2UKICBvciBhbiBpdGVtIGlzIGFkZGVkL3JlbW92ZWQpLgoKICBgYGBoYW5kbGViYXJzCiAge3sjZ3JvdXB9fQogICAge3sjZWFjaCBwZW9wbGV9fQogICAgICB7e2ZpcnN0TmFtZX19IHt7bGFzdE5hbWV9fQogICAge3svZWFjaH19CiAge3svZ3JvdXB9fQogIGBgYAoKICBUaGlzIGNhbiBiZSBmYXN0ZXIgdGhhbiB0aGUgbm9ybWFsIHdheSB0aGF0IEhhbmRsZWJhcnMgcmUtcmVuZGVycyBpdGVtcwogIGluIHNvbWUgY2FzZXMuCgogIElmIGZvciBzb21lIHJlYXNvbiB5b3UgaGF2ZSBhIGdyb3VwIHdpdGggbW9yZSB0aGFuIG9uZSBgI2VhY2hgLCB5b3UgY2FuIG1ha2UKICBvbmUgb2YgdGhlIGNvbGxlY3Rpb25zIGJlIHVwZGF0ZWQgaW4gbm9ybWFsIChub24tZ3JvdXBlZCkgZmFzaGlvbiBieSBzZXR0aW5nCiAgdGhlIG9wdGlvbiBgZ3JvdXBlZFJvd3M9dHJ1ZWAgKGNvdW50ZXItaW50dWl0aXZlLCBJIGtub3cpLgoKICBGb3IgZXhhbXBsZSwKCiAgYGBgaGFuZGxlYmFycwogIHt7ZGVhbGVyc2hpcE5hbWV9fQoKICB7eyNncm91cH19CiAgICB7eyNlYWNoIGRlYWxlcnN9fQogICAgICB7e2ZpcnN0TmFtZX19IHt7bGFzdE5hbWV9fQogICAge3svZWFjaH19CgogICAge3sjZWFjaCBjYXIgaW4gY2FycyBncm91cGVkUm93cz10cnVlfX0KICAgICAge3tjYXIubWFrZX19IHt7Y2FyLm1vZGVsfX0ge3tjYXIuY29sb3J9fQogICAge3svZWFjaH19CiAge3svZ3JvdXB9fQogIGBgYAogIEFueSBjaGFuZ2UgdG8gYGRlYWxlcnNoaXBOYW1lYCBvciB0aGUgYGRlYWxlcnNgIGNvbGxlY3Rpb24gd2lsbCBjYXVzZSB0aGUKICBlbnRpcmUgZ3JvdXAgdG8gYmUgcmUtcmVuZGVyZWQuIEhvd2V2ZXIsIGNoYW5nZXMgdG8gdGhlIGBjYXJzYCBjb2xsZWN0aW9uCiAgd2lsbCBiZSByZS1yZW5kZXJlZCBpbmRpdmlkdWFsbHkgKGFzIG5vcm1hbCkuCgogIE5vdGUgdGhhdCBgZ3JvdXBgIGJlaGF2aW9yIGlzIGFsc28gZGlzYWJsZWQgYnkgc3BlY2lmeWluZyBhbiBgaXRlbVZpZXdDbGFzc2AuCgogIEBtZXRob2QgZWFjaAogIEBmb3IgRW1iZXIuSGFuZGxlYmFycy5oZWxwZXJzCiAgQHBhcmFtIFtuYW1lXSB7U3RyaW5nfSBuYW1lIGZvciBpdGVtICh1c2VkIHdpdGggYGluYCkKICBAcGFyYW0gW3BhdGhdIHtTdHJpbmd9IHBhdGgKICBAcGFyYW0gW29wdGlvbnNdIHtPYmplY3R9IEhhbmRsZWJhcnMga2V5L3ZhbHVlIHBhaXJzIG9mIG9wdGlvbnMKICBAcGFyYW0gW29wdGlvbnMuaXRlbVZpZXdDbGFzc10ge1N0cmluZ30gYSBwYXRoIHRvIGEgdmlldyBjbGFzcyB1c2VkIGZvciBlYWNoIGl0ZW0KICBAcGFyYW0gW29wdGlvbnMuaXRlbUNvbnRyb2xsZXJdIHtTdHJpbmd9IG5hbWUgb2YgYSBjb250cm9sbGVyIHRvIGJlIGNyZWF0ZWQgZm9yIGVhY2ggaXRlbQogIEBwYXJhbSBbb3B0aW9ucy5ncm91cGVkUm93c10ge2Jvb2xlYW59IGVuYWJsZSBub3JtYWwgaXRlbS1ieS1pdGVtIHJlbmRlcmluZyB3aGVuIGluc2lkZSBhIGAjZ3JvdXBgIGhlbHBlcgoqLwpFbWJlci5IYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdlYWNoJywgZnVuY3Rpb24gZWFjaEhlbHBlcihwYXRoLCBvcHRpb25zKSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDQpIHsKICAgIEVtYmVyLmFzc2VydCgiSWYgeW91IHBhc3MgbW9yZSB0aGFuIG9uZSBhcmd1bWVudCB0byB0aGUgZWFjaCBoZWxwZXIsIGl0IG11c3QgYmUgaW4gdGhlIGZvcm0gI2VhY2ggZm9vIGluIGJhciIsIGFyZ3VtZW50c1sxXSA9PT0gImluIik7CgogICAgdmFyIGtleXdvcmROYW1lID0gYXJndW1lbnRzWzBdOwoKICAgIG9wdGlvbnMgPSBhcmd1bWVudHNbM107CiAgICBwYXRoID0gYXJndW1lbnRzWzJdOwogICAgaWYgKHBhdGggPT09ICcnKSB7IHBhdGggPSAidGhpcyI7IH0KCiAgICBvcHRpb25zLmhhc2gua2V5d29yZCA9IGtleXdvcmROYW1lOwogIH0KCiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgIG9wdGlvbnMgPSBwYXRoOwogICAgcGF0aCA9ICd0aGlzJzsKICB9CgogIG9wdGlvbnMuaGFzaC5kYXRhU291cmNlQmluZGluZyA9IHBhdGg7CiAgLy8gU2V0IHVwIGVtcHR5VmlldyBhcyBhIG1ldGFtb3JwaCB3aXRoIG5vIHRhZwogIC8vb3B0aW9ucy5oYXNoLmVtcHR5Vmlld0NsYXNzID0gRW1iZXIuX01ldGFtb3JwaFZpZXc7CgogIGlmIChvcHRpb25zLmRhdGEuaW5zaWRlR3JvdXAgJiYgIW9wdGlvbnMuaGFzaC5ncm91cGVkUm93cyAmJiAhb3B0aW9ucy5oYXNoLml0ZW1WaWV3Q2xhc3MpIHsKICAgIG5ldyBFbWJlci5IYW5kbGViYXJzLkdyb3VwZWRFYWNoKHRoaXMsIHBhdGgsIG9wdGlvbnMpLnJlbmRlcigpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gRW1iZXIuSGFuZGxlYmFycy5oZWxwZXJzLmNvbGxlY3Rpb24uY2FsbCh0aGlzLCAnRW1iZXIuSGFuZGxlYmFycy5FYWNoVmlldycsIG9wdGlvbnMpOwogIH0KfSk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItaGFuZGxlYmFycwoqLwoKLyoqCiAgYHRlbXBsYXRlYCBhbGxvd3MgeW91IHRvIHJlbmRlciBhIHRlbXBsYXRlIGZyb20gaW5zaWRlIGFub3RoZXIgdGVtcGxhdGUuCiAgVGhpcyBhbGxvd3MgeW91IHRvIHJlLXVzZSB0aGUgc2FtZSB0ZW1wbGF0ZSBpbiBtdWx0aXBsZSBwbGFjZXMuIEZvciBleGFtcGxlOgoKICBgYGBodG1sCiAgPHNjcmlwdCB0eXBlPSJ0ZXh0L3gtaGFuZGxlYmFycyIgZGF0YS10ZW1wbGF0ZS1uYW1lPSJsb2dnZWRfaW5fdXNlciI+CiAgICB7eyN3aXRoIGxvZ2dlZEluVXNlcn19CiAgICAgIExhc3QgTG9naW46IHt7bGFzdExvZ2lufX0KICAgICAgVXNlciBJbmZvOiB7e3RlbXBsYXRlICJ1c2VyX2luZm8ifX0KICAgIHt7L3dpdGh9fQogIDwvc2NyaXB0PgogIGBgYAoKICBgYGBodG1sCiAgPHNjcmlwdCB0eXBlPSJ0ZXh0L3gtaGFuZGxlYmFycyIgZGF0YS10ZW1wbGF0ZS1uYW1lPSJ1c2VyX2luZm8iPgogICAgTmFtZTogPGVtPnt7bmFtZX19PC9lbT4KICAgIEthcm1hOiA8ZW0+e3trYXJtYX19PC9lbT4KICA8L3NjcmlwdD4KICBgYGAKCiAgYGBgaGFuZGxlYmFycwogIHt7I2lmIGlzVXNlcn19CiAgICB7e3RlbXBsYXRlICJ1c2VyX2luZm8ifX0KICB7e2Vsc2V9fQogICAge3t0ZW1wbGF0ZSAidW5sb2dnZWRfdXNlcl9pbmZvIn19CiAge3svaWZ9fQogIGBgYAoKICBUaGlzIGhlbHBlciBsb29rcyBmb3IgdGVtcGxhdGVzIGluIHRoZSBnbG9iYWwgYEVtYmVyLlRFTVBMQVRFU2AgaGFzaC4gSWYgeW91CiAgYWRkIGA8c2NyaXB0PmAgdGFncyB0byB5b3VyIHBhZ2Ugd2l0aCB0aGUgYGRhdGEtdGVtcGxhdGUtbmFtZWAgYXR0cmlidXRlIHNldCwKICB0aGV5IHdpbGwgYmUgY29tcGlsZWQgYW5kIHBsYWNlZCBpbiB0aGlzIGhhc2ggYXV0b21hdGljYWxseS4KCiAgWW91IGNhbiBhbHNvIG1hbnVhbGx5IHJlZ2lzdGVyIHRlbXBsYXRlcyBieSBhZGRpbmcgdGhlbSB0byB0aGUgaGFzaDoKCiAgYGBgamF2YXNjcmlwdAogIEVtYmVyLlRFTVBMQVRFU1sibXlfY29vbF90ZW1wbGF0ZSJdID0gRW1iZXIuSGFuZGxlYmFycy5jb21waWxlKCc8Yj57e3VzZXJ9fTwvYj4nKTsKICBgYGAKCiAgQGRlcHJlY2F0ZWQKICBAbWV0aG9kIHRlbXBsYXRlCiAgQGZvciBFbWJlci5IYW5kbGViYXJzLmhlbHBlcnMKICBAcGFyYW0ge1N0cmluZ30gdGVtcGxhdGVOYW1lIHRoZSB0ZW1wbGF0ZSB0byByZW5kZXIKKi8KCkVtYmVyLkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3RlbXBsYXRlJywgZnVuY3Rpb24obmFtZSwgb3B0aW9ucykgewogIEVtYmVyLmRlcHJlY2F0ZSgiVGhlIGB0ZW1wbGF0ZWAgaGVscGVyIGhhcyBiZWVuIGRlcHJlY2F0ZWQgaW4gZmF2b3Igb2YgdGhlIGBwYXJ0aWFsYCBoZWxwZXIuIFBsZWFzZSB1c2UgYHBhcnRpYWxgIGluc3RlYWQsIHdoaWNoIHdpbGwgd29yayB0aGUgc2FtZSB3YXkuIik7CiAgcmV0dXJuIEVtYmVyLkhhbmRsZWJhcnMuaGVscGVycy5wYXJ0aWFsLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn0pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLWhhbmRsZWJhcnMKKi8KCi8qKgogIFRoZSBgcGFydGlhbGAgaGVscGVyIHJlbmRlcnMgYW5vdGhlciB0ZW1wbGF0ZSB3aXRob3V0CiAgY2hhbmdpbmcgdGhlIHRlbXBsYXRlIGNvbnRleHQ6CgogIGBgYGhhbmRsZWJhcnMKICB7e2Zvb319CiAge3twYXJ0aWFsICJuYXYifX0KICBgYGAKCiAgVGhlIGFib3ZlIGV4YW1wbGUgdGVtcGxhdGUgd2lsbCByZW5kZXIgYSB0ZW1wbGF0ZSBuYW1lZAogICJfbmF2Iiwgd2hpY2ggaGFzIHRoZSBzYW1lIGNvbnRleHQgYXMgdGhlIHBhcmVudCB0ZW1wbGF0ZQogIGl0J3MgcmVuZGVyZWQgaW50bywgc28gaWYgdGhlICJfbmF2IiB0ZW1wbGF0ZSBhbHNvIHJlZmVyZW5jZWQKICBge3tmb299fWAsIGl0IHdvdWxkIHByaW50IHRoZSBzYW1lIHRoaW5nIGFzIHRoZSBge3tmb299fWAKICBpbiB0aGUgYWJvdmUgZXhhbXBsZS4KCiAgSWYgYSAiX25hdiIgdGVtcGxhdGUgaXNuJ3QgZm91bmQsIHRoZSBgcGFydGlhbGAgaGVscGVyIHdpbGwKICBmYWxsIGJhY2sgdG8gYSB0ZW1wbGF0ZSBuYW1lZCAibmF2Ii4KCiAgIyMgQm91bmQgdGVtcGxhdGUgbmFtZXMKCiAgVGhlIHBhcmFtZXRlciBzdXBwbGllZCB0byBgcGFydGlhbGAgY2FuIGFsc28gYmUgYSBwYXRoCiAgdG8gYSBwcm9wZXJ0eSBjb250YWluaW5nIGEgdGVtcGxhdGUgbmFtZSwgZS5nLjoKCiAgYGBgaGFuZGxlYmFycwogIHt7cGFydGlhbCBzb21lVGVtcGxhdGVOYW1lfX0KICBgYGAKCiAgVGhlIGFib3ZlIGV4YW1wbGUgd2lsbCBsb29rIHVwIHRoZSB2YWx1ZSBvZiBgc29tZVRlbXBsYXRlTmFtZWAKICBvbiB0aGUgdGVtcGxhdGUgY29udGV4dCAoZS5nLiBhIGNvbnRyb2xsZXIpIGFuZCB1c2UgdGhhdAogIHZhbHVlIGFzIHRoZSBuYW1lIG9mIHRoZSB0ZW1wbGF0ZSB0byByZW5kZXIuIElmIHRoZSByZXNvbHZlZAogIHZhbHVlIGlzIGZhbHN5LCBub3RoaW5nIHdpbGwgYmUgcmVuZGVyZWQuIElmIGBzb21lVGVtcGxhdGVOYW1lYAogIGNoYW5nZXMsIHRoZSBwYXJ0aWFsIHdpbGwgYmUgcmUtcmVuZGVyZWQgdXNpbmcgdGhlIG5ldyB0ZW1wbGF0ZQogIG5hbWUuCgogICMjIFNldHRpbmcgdGhlIHBhcnRpYWwncyBjb250ZXh0IHdpdGggYHdpdGhgCgogIFRoZSBgcGFydGlhbGAgaGVscGVyIGNhbiBiZSB1c2VkIGluIGNvbmp1bmN0aW9uIHdpdGggdGhlIGB3aXRoYAogIGhlbHBlciB0byBzZXQgYSBjb250ZXh0IHRoYXQgd2lsbCBiZSB1c2VkIGJ5IHRoZSBwYXJ0aWFsOgoKICBgYGBoYW5kbGViYXJzCiAge3sjd2l0aCBjdXJyZW50VXNlcn19CiAgICB7e3BhcnRpYWwgInVzZXJfaW5mbyJ9fQogIHt7L3dpdGh9fQogIGBgYAoKICBAbWV0aG9kIHBhcnRpYWwKICBAZm9yIEVtYmVyLkhhbmRsZWJhcnMuaGVscGVycwogIEBwYXJhbSB7U3RyaW5nfSBwYXJ0aWFsTmFtZSB0aGUgbmFtZSBvZiB0aGUgdGVtcGxhdGUgdG8gcmVuZGVyIG1pbnVzIHRoZSBsZWFkaW5nIHVuZGVyc2NvcmUKKi8KCkVtYmVyLkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3BhcnRpYWwnLCBmdW5jdGlvbiBwYXJ0aWFsSGVscGVyKG5hbWUsIG9wdGlvbnMpIHsKCiAgdmFyIGNvbnRleHQgPSAob3B0aW9ucy5jb250ZXh0cyAmJiBvcHRpb25zLmNvbnRleHRzLmxlbmd0aCkgPyBvcHRpb25zLmNvbnRleHRzWzBdIDogdGhpczsKCiAgaWYgKG9wdGlvbnMudHlwZXNbMF0gPT09ICJJRCIpIHsKICAgIC8vIEhlbHBlciB3YXMgcGFzc2VkIGEgcHJvcGVydHkgcGF0aDsgd2UgbmVlZCB0bwogICAgLy8gY3JlYXRlIGEgYmluZGluZyB0aGF0IHdpbGwgcmUtcmVuZGVyIHdoZW5ldmVyCiAgICAvLyB0aGlzIHByb3BlcnR5IGNoYW5nZXMuCiAgICBvcHRpb25zLmZuID0gZnVuY3Rpb24oY29udGV4dCwgZm5PcHRpb25zKSB7CiAgICAgIHZhciBwYXJ0aWFsTmFtZSA9IEVtYmVyLkhhbmRsZWJhcnMuZ2V0KGNvbnRleHQsIG5hbWUsIGZuT3B0aW9ucyk7CiAgICAgIHJlbmRlclBhcnRpYWwoY29udGV4dCwgcGFydGlhbE5hbWUsIGZuT3B0aW9ucyk7CiAgICB9OwoKICAgIHJldHVybiBFbWJlci5IYW5kbGViYXJzLmJpbmQuY2FsbChjb250ZXh0LCBuYW1lLCBvcHRpb25zLCB0cnVlLCBleGlzdHMpOwogIH0gZWxzZSB7CiAgICAvLyBSZW5kZXIgdGhlIHBhcnRpYWwgcmlnaHQgaW50byBwYXJlbnQgdGVtcGxhdGUuCiAgICByZW5kZXJQYXJ0aWFsKGNvbnRleHQsIG5hbWUsIG9wdGlvbnMpOwogIH0KfSk7CgpmdW5jdGlvbiBleGlzdHModmFsdWUpIHsKICByZXR1cm4gIUVtYmVyLmlzTm9uZSh2YWx1ZSk7Cn0KCmZ1bmN0aW9uIHJlbmRlclBhcnRpYWwoY29udGV4dCwgbmFtZSwgb3B0aW9ucykgewogIHZhciBuYW1lUGFydHMgPSBuYW1lLnNwbGl0KCIvIiksCiAgICAgIGxhc3RQYXJ0ID0gbmFtZVBhcnRzW25hbWVQYXJ0cy5sZW5ndGggLSAxXTsKCiAgbmFtZVBhcnRzW25hbWVQYXJ0cy5sZW5ndGggLSAxXSA9ICJfIiArIGxhc3RQYXJ0OwoKICB2YXIgdmlldyA9IG9wdGlvbnMuZGF0YS52aWV3LAogICAgICB1bmRlcnNjb3JlZE5hbWUgPSBuYW1lUGFydHMuam9pbigiLyIpLAogICAgICB0ZW1wbGF0ZSA9IHZpZXcudGVtcGxhdGVGb3JOYW1lKHVuZGVyc2NvcmVkTmFtZSksCiAgICAgIGRlcHJlY2F0ZWRUZW1wbGF0ZSA9ICF0ZW1wbGF0ZSAmJiB2aWV3LnRlbXBsYXRlRm9yTmFtZShuYW1lKTsKCiAgRW1iZXIuYXNzZXJ0KCJVbmFibGUgdG8gZmluZCBwYXJ0aWFsIHdpdGggbmFtZSAnIituYW1lKyInLiIsIHRlbXBsYXRlIHx8IGRlcHJlY2F0ZWRUZW1wbGF0ZSk7CgogIHRlbXBsYXRlID0gdGVtcGxhdGUgfHwgZGVwcmVjYXRlZFRlbXBsYXRlOwoKICB0ZW1wbGF0ZShjb250ZXh0LCB7IGRhdGE6IG9wdGlvbnMuZGF0YSB9KTsKfQoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLWhhbmRsZWJhcnMKKi8KCnZhciBnZXQgPSBFbWJlci5nZXQsIHNldCA9IEVtYmVyLnNldDsKCi8qKgogIGB7e3lpZWxkfX1gIGRlbm90ZXMgYW4gYXJlYSBvZiBhIHRlbXBsYXRlIHRoYXQgd2lsbCBiZSByZW5kZXJlZCBpbnNpZGUKICBvZiBhbm90aGVyIHRlbXBsYXRlLiBJdCBoYXMgdHdvIG1haW4gdXNlczoKCiAgIyMjIFVzZSB3aXRoIGBsYXlvdXRgCiAgV2hlbiB1c2VkIGluIGEgSGFuZGxlYmFycyB0ZW1wbGF0ZSB0aGF0IGlzIGFzc2lnbmVkIHRvIGFuIGBFbWJlci5WaWV3YAogIGluc3RhbmNlJ3MgYGxheW91dGAgcHJvcGVydHkgRW1iZXIgd2lsbCByZW5kZXIgdGhlIGxheW91dCB0ZW1wbGF0ZSBmaXJzdCwKICBpbnNlcnRpbmcgdGhlIHZpZXcncyBvd24gcmVuZGVyZWQgb3V0cHV0IGF0IHRoZSBge3t5aWVsZH19YCBsb2NhdGlvbi4KCiAgQW4gZW1wdHkgYDxib2R5PmAgYW5kIHRoZSBmb2xsb3dpbmcgYXBwbGljYXRpb24gY29kZToKCiAgYGBgamF2YXNjcmlwdAogIEFWaWV3ID0gRW1iZXIuVmlldy5leHRlbmQoewogICAgY2xhc3NOYW1lczogWydhLXZpZXctd2l0aC1sYXlvdXQnXSwKICAgIGxheW91dDogRW1iZXIuSGFuZGxlYmFycy5jb21waWxlKCc8ZGl2IGNsYXNzPSJ3cmFwcGVyIj57e3lpZWxkfX08L2Rpdj4nKSwKICAgIHRlbXBsYXRlOiBFbWJlci5IYW5kbGViYXJzLmNvbXBpbGUoJzxzcGFuPkkgYW0gd3JhcHBlZDwvc3Bhbj4nKQogIH0pOwoKICBhVmlldyA9IEFWaWV3LmNyZWF0ZSgpOwogIGFWaWV3LmFwcGVuZFRvKCdib2R5Jyk7CiAgYGBgCgogIFdpbGwgcmVzdWx0IGluIHRoZSBmb2xsb3dpbmcgSFRNTCBvdXRwdXQ6CgogIGBgYGh0bWwKICA8Ym9keT4KICAgIDxkaXYgY2xhc3M9J2VtYmVyLXZpZXcgYS12aWV3LXdpdGgtbGF5b3V0Jz4KICAgICAgPGRpdiBjbGFzcz0id3JhcHBlciI+CiAgICAgICAgPHNwYW4+SSBhbSB3cmFwcGVkPC9zcGFuPgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgogIDwvYm9keT4KICBgYGAKCiAgVGhlIGB5aWVsZGAgaGVscGVyIGNhbm5vdCBiZSB1c2VkIG91dHNpZGUgb2YgYSB0ZW1wbGF0ZSBhc3NpZ25lZCB0byBhbgogIGBFbWJlci5WaWV3YCdzIGBsYXlvdXRgIHByb3BlcnR5IGFuZCB3aWxsIHRocm93IGFuIGVycm9yIGlmIGF0dGVtcHRlZC4KCiAgYGBgamF2YXNjcmlwdAogIEJWaWV3ID0gRW1iZXIuVmlldy5leHRlbmQoewogICAgY2xhc3NOYW1lczogWydhLXZpZXctd2l0aC1sYXlvdXQnXSwKICAgIHRlbXBsYXRlOiBFbWJlci5IYW5kbGViYXJzLmNvbXBpbGUoJ3t7eWllbGR9fScpCiAgfSk7CgogIGJWaWV3ID0gQlZpZXcuY3JlYXRlKCk7CiAgYlZpZXcuYXBwZW5kVG8oJ2JvZHknKTsKCiAgLy8gdGhyb3dzCiAgLy8gVW5jYXVnaHQgRXJyb3I6IGFzc2VydGlvbiBmYWlsZWQ6CiAgLy8gWW91IGNhbGxlZCB5aWVsZCBpbiBhIHRlbXBsYXRlIHRoYXQgd2FzIG5vdCBhIGxheW91dAogIGBgYAoKICAjIyMgVXNlIHdpdGggRW1iZXIuQ29tcG9uZW50CiAgV2hlbiBkZXNpZ25pbmcgY29tcG9uZW50cyBge3t5aWVsZH19YCBpcyB1c2VkIHRvIGRlbm90ZSB3aGVyZSwgaW5zaWRlIHRoZSBjb21wb25lbnQncwogIHRlbXBsYXRlLCBhbiBvcHRpb25hbCBibG9jayBwYXNzZWQgdG8gdGhlIGNvbXBvbmVudCBzaG91bGQgcmVuZGVyOgoKICBgYGBoYW5kbGViYXJzCiAgPCEtLSBhcHBsaWNhdGlvbi5oYnMgLS0+CiAge3sjbGFiZWxlZC10ZXh0ZmllbGQgdmFsdWU9c29tZVByb3BlcnR5fX0KICAgIEZpcnN0IG5hbWU6CiAge3svbGFiZWxlZC10ZXh0ZmllbGR9fQogIGBgYAoKICBgYGBoYW5kbGViYXJzCiAgPCEtLSBjb21wb25lbnRzL2xhYmVsZWQtdGV4dGZpZWxkLmhicyAtLT4KICA8bGFiZWw+CiAgICB7e3lpZWxkfX0ge3tpbnB1dCB2YWx1ZT12YWx1ZX19CiAgPC9sYWJlbD4KICBgYGAKCiAgUmVzdWx0OgoKICBgYGBodG1sCiAgPGxhYmVsPgogICAgRmlyc3QgbmFtZTogPGlucHV0IHR5cGU9InRleHQiIC8+CiAgPGxhYmVsPgogIGBgYAoKICBAbWV0aG9kIHlpZWxkCiAgQGZvciBFbWJlci5IYW5kbGViYXJzLmhlbHBlcnMKICBAcGFyYW0ge0hhc2h9IG9wdGlvbnMKICBAcmV0dXJuIHtTdHJpbmd9IEhUTUwgc3RyaW5nCiovCkVtYmVyLkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3lpZWxkJywgZnVuY3Rpb24geWllbGRIZWxwZXIob3B0aW9ucykgewogIHZhciB2aWV3ID0gb3B0aW9ucy5kYXRhLnZpZXc7CgogIHdoaWxlICh2aWV3ICYmICFnZXQodmlldywgJ2xheW91dCcpKSB7CiAgICBpZiAodmlldy5fY29udGV4dFZpZXcpIHsKICAgICAgdmlldyA9IHZpZXcuX2NvbnRleHRWaWV3OwogICAgfSBlbHNlIHsKICAgICAgdmlldyA9IGdldCh2aWV3LCAncGFyZW50VmlldycpOwogICAgfQogIH0KCiAgRW1iZXIuYXNzZXJ0KCJZb3UgY2FsbGVkIHlpZWxkIGluIGEgdGVtcGxhdGUgdGhhdCB3YXMgbm90IGEgbGF5b3V0IiwgISF2aWV3KTsKCiAgdmlldy5feWllbGQodGhpcywgb3B0aW9ucyk7Cn0pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLWhhbmRsZWJhcnMKKi8KCi8qKgogIGBsb2NgIGxvb2tzIHVwIHRoZSBzdHJpbmcgaW4gdGhlIGxvY2FsaXplZCBzdHJpbmdzIGhhc2guCiAgVGhpcyBpcyBhIGNvbnZlbmllbnQgd2F5IHRvIGxvY2FsaXplIHRleHQuIEZvciBleGFtcGxlOgoKICBgYGBodG1sCiAgPHNjcmlwdCB0eXBlPSJ0ZXh0L3gtaGFuZGxlYmFycyIgZGF0YS10ZW1wbGF0ZS1uYW1lPSJob21lIj4KICAgIHt7bG9jICJ3ZWxjb21lIn19CiAgPC9zY3JpcHQ+CiAgYGBgCgogIFRha2Ugbm90ZSB0aGF0IGAid2VsY29tZSJgIGlzIGEgc3RyaW5nIGFuZCBub3QgYW4gb2JqZWN0CiAgcmVmZXJlbmNlLgoKICBAbWV0aG9kIGxvYwogIEBmb3IgRW1iZXIuSGFuZGxlYmFycy5oZWxwZXJzCiAgQHBhcmFtIHtTdHJpbmd9IHN0ciBUaGUgc3RyaW5nIHRvIGZvcm1hdAoqLwoKRW1iZXIuSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignbG9jJywgZnVuY3Rpb24gbG9jSGVscGVyKHN0cikgewogIHJldHVybiBFbWJlci5TdHJpbmcubG9jKHN0cik7Cn0pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLWhhbmRsZWJhcnMKKi8KCnZhciBzZXQgPSBFbWJlci5zZXQsIGdldCA9IEVtYmVyLmdldDsKCi8qKgogIFRoZSBpbnRlcm5hbCBjbGFzcyB1c2VkIHRvIGNyZWF0ZSB0ZXh0IGlucHV0cyB3aGVuIHRoZSBge3tpbnB1dH19YAogIGhlbHBlciBpcyB1c2VkIHdpdGggYHR5cGVgIG9mIGBjaGVja2JveGAuCgogIFNlZSBbaGFuZGxlYmFycy5oZWxwZXJzLmlucHV0XSgvYXBpL2NsYXNzZXMvRW1iZXIuSGFuZGxlYmFycy5oZWxwZXJzLmh0bWwjbWV0aG9kX2lucHV0KSAgZm9yIHVzYWdlIGRldGFpbHMuCgogICMjIERpcmVjdCBtYW5pcHVsYXRpb24gb2YgYGNoZWNrZWRgCgogIFRoZSBgY2hlY2tlZGAgYXR0cmlidXRlIG9mIGFuIGBFbWJlci5DaGVja2JveGAgb2JqZWN0IHNob3VsZCBhbHdheXMgYmUgc2V0CiAgdGhyb3VnaCB0aGUgRW1iZXIgb2JqZWN0IG9yIGJ5IGludGVyYWN0aW5nIHdpdGggaXRzIHJlbmRlcmVkIGVsZW1lbnQKICByZXByZXNlbnRhdGlvbiB2aWEgdGhlIG1vdXNlLCBrZXlib2FyZCwgb3IgdG91Y2guIFVwZGF0aW5nIHRoZSB2YWx1ZSBvZiB0aGUKICBjaGVja2JveCB2aWEgalF1ZXJ5IHdpbGwgcmVzdWx0IGluIHRoZSBjaGVja2VkIHZhbHVlIG9mIHRoZSBvYmplY3QgYW5kIGl0cwogIGVsZW1lbnQgbG9zaW5nIHN5bmNocm9uaXphdGlvbi4KCiAgIyMgTGF5b3V0IGFuZCBMYXlvdXROYW1lIHByb3BlcnRpZXMKCiAgQmVjYXVzZSBIVE1MIGBpbnB1dGAgZWxlbWVudHMgYXJlIHNlbGYgY2xvc2luZyBgbGF5b3V0YCBhbmQgYGxheW91dE5hbWVgCiAgcHJvcGVydGllcyB3aWxsIG5vdCBiZSBhcHBsaWVkLiBTZWUgW0VtYmVyLlZpZXddKC9hcGkvY2xhc3Nlcy9FbWJlci5WaWV3Lmh0bWwpJ3MKICBsYXlvdXQgc2VjdGlvbiBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KCiAgQGNsYXNzIENoZWNrYm94CiAgQG5hbWVzcGFjZSBFbWJlcgogIEBleHRlbmRzIEVtYmVyLlZpZXcKKi8KRW1iZXIuQ2hlY2tib3ggPSBFbWJlci5WaWV3LmV4dGVuZCh7CiAgY2xhc3NOYW1lczogWydlbWJlci1jaGVja2JveCddLAoKICB0YWdOYW1lOiAnaW5wdXQnLAoKICBhdHRyaWJ1dGVCaW5kaW5nczogWyd0eXBlJywgJ2NoZWNrZWQnLCAnaW5kZXRlcm1pbmF0ZScsICdkaXNhYmxlZCcsICd0YWJpbmRleCcsICduYW1lJ10sCgogIHR5cGU6ICJjaGVja2JveCIsCiAgY2hlY2tlZDogZmFsc2UsCiAgZGlzYWJsZWQ6IGZhbHNlLAogIGluZGV0ZXJtaW5hdGU6IGZhbHNlLAoKICBpbml0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3N1cGVyKCk7CiAgICB0aGlzLm9uKCJjaGFuZ2UiLCB0aGlzLCB0aGlzLl91cGRhdGVFbGVtZW50VmFsdWUpOwogIH0sCgogIGRpZEluc2VydEVsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fc3VwZXIoKTsKICAgIHRoaXMuZ2V0KCdlbGVtZW50JykuaW5kZXRlcm1pbmF0ZSA9ICEhdGhpcy5nZXQoJ2luZGV0ZXJtaW5hdGUnKTsKICB9LAoKICBfdXBkYXRlRWxlbWVudFZhbHVlOiBmdW5jdGlvbigpIHsKICAgIHNldCh0aGlzLCAnY2hlY2tlZCcsIHRoaXMuJCgpLnByb3AoJ2NoZWNrZWQnKSk7CiAgfQp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1oYW5kbGViYXJzCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQ7CgovKioKICBTaGFyZWQgbWl4aW4gdXNlZCBieSBgRW1iZXIuVGV4dEZpZWxkYCBhbmQgYEVtYmVyLlRleHRBcmVhYC4KCiAgQGNsYXNzIFRleHRTdXBwb3J0CiAgQG5hbWVzcGFjZSBFbWJlcgogIEBwcml2YXRlCiovCkVtYmVyLlRleHRTdXBwb3J0ID0gRW1iZXIuTWl4aW4uY3JlYXRlKHsKICB2YWx1ZTogIiIsCgogIGF0dHJpYnV0ZUJpbmRpbmdzOiBbJ3BsYWNlaG9sZGVyJywgJ2Rpc2FibGVkJywgJ21heGxlbmd0aCcsICd0YWJpbmRleCcsICdyZWFkb25seSddLAogIHBsYWNlaG9sZGVyOiBudWxsLAogIGRpc2FibGVkOiBmYWxzZSwKICBtYXhsZW5ndGg6IG51bGwsCgogIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fc3VwZXIoKTsKICAgIHRoaXMub24oImZvY3VzT3V0IiwgdGhpcywgdGhpcy5fZWxlbWVudFZhbHVlRGlkQ2hhbmdlKTsKICAgIHRoaXMub24oImNoYW5nZSIsIHRoaXMsIHRoaXMuX2VsZW1lbnRWYWx1ZURpZENoYW5nZSk7CiAgICB0aGlzLm9uKCJwYXN0ZSIsIHRoaXMsIHRoaXMuX2VsZW1lbnRWYWx1ZURpZENoYW5nZSk7CiAgICB0aGlzLm9uKCJjdXQiLCB0aGlzLCB0aGlzLl9lbGVtZW50VmFsdWVEaWRDaGFuZ2UpOwogICAgdGhpcy5vbigiaW5wdXQiLCB0aGlzLCB0aGlzLl9lbGVtZW50VmFsdWVEaWRDaGFuZ2UpOwogICAgdGhpcy5vbigia2V5VXAiLCB0aGlzLCB0aGlzLmludGVycHJldEtleUV2ZW50cyk7CiAgfSwKCiAgLyoqCiAgICBUaGUgYWN0aW9uIHRvIGJlIHNlbnQgd2hlbiB0aGUgdXNlciBwcmVzc2VzIHRoZSByZXR1cm4ga2V5LgoKICAgIFRoaXMgaXMgc2ltaWxhciB0byB0aGUgYHt7YWN0aW9ufX1gIGhlbHBlciwgYnV0IGlzIGZpcmVkIHdoZW4KICAgIHRoZSB1c2VyIHByZXNzZXMgdGhlIHJldHVybiBrZXkgd2hlbiBlZGl0aW5nIGEgdGV4dCBmaWVsZCwgYW5kIHNlbmRzCiAgICB0aGUgdmFsdWUgb2YgdGhlIGZpZWxkIGFzIHRoZSBjb250ZXh0LgoKICAgIEBwcm9wZXJ0eSBhY3Rpb24KICAgIEB0eXBlIFN0cmluZwogICAgQGRlZmF1bHQgbnVsbAogICovCiAgYWN0aW9uOiBudWxsLAoKICAvKioKICAgIFRoZSBldmVudCB0aGF0IHNob3VsZCBzZW5kIHRoZSBhY3Rpb24uCgogICAgT3B0aW9ucyBhcmU6CgogICAgKiBgZW50ZXJgOiB0aGUgdXNlciBwcmVzc2VkIGVudGVyCiAgICAqIGBrZXlQcmVzc2A6IHRoZSB1c2VyIHByZXNzZWQgYSBrZXkKCiAgICBAcHJvcGVydHkgb25FdmVudAogICAgQHR5cGUgU3RyaW5nCiAgICBAZGVmYXVsdCBlbnRlcgogICovCiAgb25FdmVudDogJ2VudGVyJywKCiAgLyoqCiAgICBXaGV0aGVyIHRoZXkgYGtleVVwYCBldmVudCB0aGF0IHRyaWdnZXJzIGFuIGBhY3Rpb25gIHRvIGJlIHNlbnQgY29udGludWVzCiAgICBwcm9wYWdhdGluZyB0byBvdGhlciB2aWV3cy4KCiAgICBCeSBkZWZhdWx0LCB3aGVuIHRoZSB1c2VyIHByZXNzZXMgdGhlIHJldHVybiBrZXkgb24gdGhlaXIga2V5Ym9hcmQgYW5kCiAgICB0aGUgdGV4dCBmaWVsZCBoYXMgYW4gYGFjdGlvbmAgc2V0LCB0aGUgYWN0aW9uIHdpbGwgYmUgc2VudCB0byB0aGUgdmlldydzCiAgICBjb250cm9sbGVyIGFuZCB0aGUga2V5IGV2ZW50IHdpbGwgc3RvcCBwcm9wYWdhdGluZy4KCiAgICBJZiB5b3Ugd291bGQgbGlrZSBwYXJlbnQgdmlld3MgdG8gcmVjZWl2ZSB0aGUgYGtleVVwYCBldmVudCBldmVuIGFmdGVyIGFuCiAgICBhY3Rpb24gaGFzIGJlZW4gZGlzcGF0Y2hlZCwgc2V0IGBidWJibGVzYCB0byB0cnVlLgoKICAgIEBwcm9wZXJ0eSBidWJibGVzCiAgICBAdHlwZSBCb29sZWFuCiAgICBAZGVmYXVsdCBmYWxzZQogICovCiAgYnViYmxlczogZmFsc2UsCgogIGludGVycHJldEtleUV2ZW50czogZnVuY3Rpb24oZXZlbnQpIHsKICAgIHZhciBtYXAgPSBFbWJlci5UZXh0U3VwcG9ydC5LRVlfRVZFTlRTOwogICAgdmFyIG1ldGhvZCA9IG1hcFtldmVudC5rZXlDb2RlXTsKCiAgICB0aGlzLl9lbGVtZW50VmFsdWVEaWRDaGFuZ2UoKTsKICAgIGlmIChtZXRob2QpIHsgcmV0dXJuIHRoaXNbbWV0aG9kXShldmVudCk7IH0KICB9LAoKICBfZWxlbWVudFZhbHVlRGlkQ2hhbmdlOiBmdW5jdGlvbigpIHsKICAgIHNldCh0aGlzLCAndmFsdWUnLCB0aGlzLiQoKS52YWwoKSk7CiAgfSwKCiAgLyoqCiAgICBUaGUgYWN0aW9uIHRvIGJlIHNlbnQgd2hlbiB0aGUgdXNlciBpbnNlcnRzIGEgbmV3IGxpbmUuCgogICAgQ2FsbGVkIGJ5IHRoZSBgRW1iZXIuVGV4dFN1cHBvcnRgIG1peGluIG9uIGtleVVwIGlmIGtleWNvZGUgbWF0Y2hlcyAxMy4KICAgIFVzZXMgc2VuZEFjdGlvbiB0byBzZW5kIHRoZSBgZW50ZXJgIGFjdGlvbiB0byB0aGUgY29udHJvbGxlci4KCiAgICBAbWV0aG9kIGluc2VydE5ld2xpbmUKICAgIEBwYXJhbSB7RXZlbnR9IGV2ZW50CiAgKi8KICBpbnNlcnROZXdsaW5lOiBmdW5jdGlvbihldmVudCkgewogICAgc2VuZEFjdGlvbignZW50ZXInLCB0aGlzLCBldmVudCk7CiAgICBzZW5kQWN0aW9uKCdpbnNlcnQtbmV3bGluZScsIHRoaXMsIGV2ZW50KTsKICB9LAoKICAvKioKICAgIENhbGxlZCB3aGVuIHRoZSB1c2VyIGhpdHMgZXNjYXBlLgoKICAgIENhbGxlZCBieSB0aGUgYEVtYmVyLlRleHRTdXBwb3J0YCBtaXhpbiBvbiBrZXlVcCBpZiBrZXljb2RlIG1hdGNoZXMgMjcuCiAgICBVc2VzIHNlbmRBY3Rpb24gdG8gc2VuZCB0aGUgYGVzY2FwZS1wcmVzc2AgYWN0aW9uIHRvIHRoZSBjb250cm9sbGVyLgoKICAgIEBtZXRob2QgY2FuY2VsCiAgICBAcGFyYW0ge0V2ZW50fSBldmVudAogICovCiAgY2FuY2VsOiBmdW5jdGlvbihldmVudCkgewogICAgc2VuZEFjdGlvbignZXNjYXBlLXByZXNzJywgdGhpcywgZXZlbnQpOwogIH0sCgogIC8qKgogICAgQ2FsbGVkIHdoZW4gdGhlIHRleHQgYXJlYSBpcyBmb2N1c2VkLgoKICAgIEBtZXRob2QgZm9jdXNJbgogICAgQHBhcmFtIHtFdmVudH0gZXZlbnQKICAqLwogIGZvY3VzSW46IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICBzZW5kQWN0aW9uKCdmb2N1cy1pbicsIHRoaXMsIGV2ZW50KTsKICB9LAoKICAvKioKICAgIENhbGxlZCB3aGVuIHRoZSB0ZXh0IGFyZWEgaXMgYmx1cnJlZC4KCiAgICBAbWV0aG9kIGZvY3VzT3V0CiAgICBAcGFyYW0ge0V2ZW50fSBldmVudAogICovCiAgZm9jdXNPdXQ6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICBzZW5kQWN0aW9uKCdmb2N1cy1vdXQnLCB0aGlzLCBldmVudCk7CiAgfSwKCiAgLyoqCiAgICBUaGUgYWN0aW9uIHRvIGJlIHNlbnQgd2hlbiB0aGUgdXNlciBwcmVzc2VzIGEga2V5LiBFbmFibGVkIGJ5IHNldHRpbmcKICAgIHRoZSBgb25FdmVudGAgcHJvcGVydHkgdG8gYGtleVByZXNzYC4KCiAgICBVc2VzIHNlbmRBY3Rpb24gdG8gc2VuZCB0aGUgYGtleVByZXNzYCBhY3Rpb24gdG8gdGhlIGNvbnRyb2xsZXIuCgogICAgQG1ldGhvZCBrZXlQcmVzcwogICAgQHBhcmFtIHtFdmVudH0gZXZlbnQKICAqLwogIGtleVByZXNzOiBmdW5jdGlvbihldmVudCkgewogICAgc2VuZEFjdGlvbigna2V5LXByZXNzJywgdGhpcywgZXZlbnQpOwogIH0KCn0pOwoKRW1iZXIuVGV4dFN1cHBvcnQuS0VZX0VWRU5UUyA9IHsKICAxMzogJ2luc2VydE5ld2xpbmUnLAogIDI3OiAnY2FuY2VsJwp9OwoKLy8gSW4gcHJpbmNpcGxlLCB0aGlzIHNob3VsZG4ndCBiZSBuZWNlc3NhcnksIGJ1dCB0aGUgbGVnYWN5Ci8vIHNlY3Rpb25BY3Rpb24gc2VtYW50aWNzIGZvciBUZXh0RmllbGQgYXJlIGRpZmZlcmVudCBmcm9tCi8vIHRoZSBjb21wb25lbnQgc2VtYW50aWNzIHNvIHRoaXMgbWV0aG9kIG5vcm1hbGl6ZXMgdGhlbS4KZnVuY3Rpb24gc2VuZEFjdGlvbihldmVudE5hbWUsIHZpZXcsIGV2ZW50KSB7CiAgdmFyIGFjdGlvbiA9IGdldCh2aWV3LCBldmVudE5hbWUpLAogICAgICBvbiA9IGdldCh2aWV3LCAnb25FdmVudCcpLAogICAgICB2YWx1ZSA9IGdldCh2aWV3LCAndmFsdWUnKTsKCiAgLy8gYmFjay1jb21wYXQgc3VwcG9ydCBmb3Iga2V5UHJlc3MgYXMgYW4gZXZlbnQgbmFtZSBldmVuIHRob3VnaAogIC8vIGl0J3MgYWxzbyBhIG1ldGhvZCBuYW1lIHRoYXQgY29uc3VtZXMgdGhlIGV2ZW50IChhbmQgdGhlcmVmb3JlCiAgLy8gaW5jb21wYXRpYmxlIHdpdGggc2VuZEFjdGlvbiBzZW1hbnRpY3MpLgogIGlmIChvbiA9PT0gZXZlbnROYW1lIHx8IChvbiA9PT0gJ2tleVByZXNzJyAmJiBldmVudE5hbWUgPT09ICdrZXktcHJlc3MnKSkgewogICAgdmlldy5zZW5kQWN0aW9uKCdhY3Rpb24nLCB2YWx1ZSk7CiAgfQoKICB2aWV3LnNlbmRBY3Rpb24oZXZlbnROYW1lLCB2YWx1ZSk7CgogIGlmIChhY3Rpb24gfHwgb24gPT09IGV2ZW50TmFtZSkgewogICAgaWYoIWdldCh2aWV3LCAnYnViYmxlcycpKSB7CiAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgfQogIH0KfQoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLWhhbmRsZWJhcnMKKi8KCnZhciBnZXQgPSBFbWJlci5nZXQsIHNldCA9IEVtYmVyLnNldDsKCi8qKgoKICBUaGUgaW50ZXJuYWwgY2xhc3MgdXNlZCB0byBjcmVhdGUgdGV4dCBpbnB1dHMgd2hlbiB0aGUgYHt7aW5wdXR9fWAKICBoZWxwZXIgaXMgdXNlZCB3aXRoIGB0eXBlYCBvZiBgdGV4dGAuCgogIFNlZSBbSGFuZGxlYmFycy5oZWxwZXJzLmlucHV0XSgvYXBpL2NsYXNzZXMvRW1iZXIuSGFuZGxlYmFycy5oZWxwZXJzLmh0bWwjbWV0aG9kX2lucHV0KSAgZm9yIHVzYWdlIGRldGFpbHMuCgogICMjIExheW91dCBhbmQgTGF5b3V0TmFtZSBwcm9wZXJ0aWVzCgogIEJlY2F1c2UgSFRNTCBgaW5wdXRgIGVsZW1lbnRzIGFyZSBzZWxmIGNsb3NpbmcgYGxheW91dGAgYW5kIGBsYXlvdXROYW1lYAogIHByb3BlcnRpZXMgd2lsbCBub3QgYmUgYXBwbGllZC4gU2VlIFtFbWJlci5WaWV3XSgvYXBpL2NsYXNzZXMvRW1iZXIuVmlldy5odG1sKSdzCiAgbGF5b3V0IHNlY3Rpb24gZm9yIG1vcmUgaW5mb3JtYXRpb24uCgogIEBjbGFzcyBUZXh0RmllbGQKICBAbmFtZXNwYWNlIEVtYmVyCiAgQGV4dGVuZHMgRW1iZXIuQ29tcG9uZW50CiAgQHVzZXMgRW1iZXIuVGV4dFN1cHBvcnQKKi8KRW1iZXIuVGV4dEZpZWxkID0gRW1iZXIuQ29tcG9uZW50LmV4dGVuZChFbWJlci5UZXh0U3VwcG9ydCwgewoKICBjbGFzc05hbWVzOiBbJ2VtYmVyLXRleHQtZmllbGQnXSwKICB0YWdOYW1lOiAiaW5wdXQiLAogIGF0dHJpYnV0ZUJpbmRpbmdzOiBbJ3R5cGUnLCAndmFsdWUnLCAnc2l6ZScsICdwYXR0ZXJuJywgJ25hbWUnXSwKCiAgLyoqCiAgICBUaGUgYHZhbHVlYCBhdHRyaWJ1dGUgb2YgdGhlIGlucHV0IGVsZW1lbnQuIEFzIHRoZSB1c2VyIGlucHV0cyB0ZXh0LCB0aGlzCiAgICBwcm9wZXJ0eSBpcyB1cGRhdGVkIGxpdmUuCgogICAgQHByb3BlcnR5IHZhbHVlCiAgICBAdHlwZSBTdHJpbmcKICAgIEBkZWZhdWx0ICIiCiAgKi8KICB2YWx1ZTogIiIsCgogIC8qKgogICAgVGhlIGB0eXBlYCBhdHRyaWJ1dGUgb2YgdGhlIGlucHV0IGVsZW1lbnQuCgogICAgQHByb3BlcnR5IHR5cGUKICAgIEB0eXBlIFN0cmluZwogICAgQGRlZmF1bHQgInRleHQiCiAgKi8KICB0eXBlOiAidGV4dCIsCgogIC8qKgogICAgVGhlIGBzaXplYCBvZiB0aGUgdGV4dCBmaWVsZCBpbiBjaGFyYWN0ZXJzLgoKICAgIEBwcm9wZXJ0eSBzaXplCiAgICBAdHlwZSBTdHJpbmcKICAgIEBkZWZhdWx0IG51bGwKICAqLwogIHNpemU6IG51bGwsCgogIC8qKgogICAgVGhlIGBwYXR0ZXJuYCB0aGUgcGF0dGVybiBhdHRyaWJ1dGUgb2YgaW5wdXQgZWxlbWVudC4KCiAgICBAcHJvcGVydHkgcGF0dGVybgogICAgQHR5cGUgU3RyaW5nCiAgICBAZGVmYXVsdCBudWxsCiAgKi8KICBwYXR0ZXJuOiBudWxsCn0pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItaGFuZGxlYmFycwoqLwoKdmFyIGdldCA9IEVtYmVyLmdldCwgc2V0ID0gRW1iZXIuc2V0OwoKLyoKICBAY2xhc3MgQnV0dG9uCiAgQG5hbWVzcGFjZSBFbWJlcgogIEBleHRlbmRzIEVtYmVyLlZpZXcKICBAdXNlcyBFbWJlci5UYXJnZXRBY3Rpb25TdXBwb3J0CiAgQGRlcHJlY2F0ZWQKKi8KRW1iZXIuQnV0dG9uID0gRW1iZXIuVmlldy5leHRlbmQoRW1iZXIuVGFyZ2V0QWN0aW9uU3VwcG9ydCwgewogIGNsYXNzTmFtZXM6IFsnZW1iZXItYnV0dG9uJ10sCiAgY2xhc3NOYW1lQmluZGluZ3M6IFsnaXNBY3RpdmUnXSwKCiAgdGFnTmFtZTogJ2J1dHRvbicsCgogIHByb3BhZ2F0ZUV2ZW50czogZmFsc2UsCgogIGF0dHJpYnV0ZUJpbmRpbmdzOiBbJ3R5cGUnLCAnZGlzYWJsZWQnLCAnaHJlZicsICd0YWJpbmRleCddLAoKICAvKgogICAgQHByaXZhdGUKCiAgICBPdmVycmlkZXMgYFRhcmdldEFjdGlvblN1cHBvcnRgJ3MgYHRhcmdldE9iamVjdGAgY29tcHV0ZWQKICAgIHByb3BlcnR5IHRvIHVzZSBIYW5kbGViYXJzLXNwZWNpZmljIHBhdGggcmVzb2x1dGlvbi4KCiAgICBAcHJvcGVydHkgdGFyZ2V0T2JqZWN0CiAgKi8KICB0YXJnZXRPYmplY3Q6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewogICAgdmFyIHRhcmdldCA9IGdldCh0aGlzLCAndGFyZ2V0JyksCiAgICAgICAgcm9vdCA9IGdldCh0aGlzLCAnY29udGV4dCcpLAogICAgICAgIGRhdGEgPSBnZXQodGhpcywgJ3RlbXBsYXRlRGF0YScpOwoKICAgIGlmICh0eXBlb2YgdGFyZ2V0ICE9PSAnc3RyaW5nJykgeyByZXR1cm4gdGFyZ2V0OyB9CgogICAgcmV0dXJuIEVtYmVyLkhhbmRsZWJhcnMuZ2V0KHJvb3QsIHRhcmdldCwgeyBkYXRhOiBkYXRhIH0pOwogIH0pLnByb3BlcnR5KCd0YXJnZXQnKSwKCiAgLy8gRGVmYXVsdHMgdG8gJ2J1dHRvbicgaWYgdGFnTmFtZSBpcyAnaW5wdXQnIG9yICdidXR0b24nCiAgdHlwZTogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oa2V5KSB7CiAgICB2YXIgdGFnTmFtZSA9IHRoaXMudGFnTmFtZTsKICAgIGlmICh0YWdOYW1lID09PSAnaW5wdXQnIHx8IHRhZ05hbWUgPT09ICdidXR0b24nKSB7IHJldHVybiAnYnV0dG9uJzsgfQogIH0pLAoKICBkaXNhYmxlZDogZmFsc2UsCgogIC8vIEFsbG93ICdhJyB0YWdzIHRvIGFjdCBsaWtlIGJ1dHRvbnMKICBocmVmOiBFbWJlci5jb21wdXRlZChmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLnRhZ05hbWUgPT09ICdhJyA/ICcjJyA6IG51bGw7CiAgfSksCgogIG1vdXNlRG93bjogZnVuY3Rpb24oKSB7CiAgICBpZiAoIWdldCh0aGlzLCAnZGlzYWJsZWQnKSkgewogICAgICBzZXQodGhpcywgJ2lzQWN0aXZlJywgdHJ1ZSk7CiAgICAgIHRoaXMuX21vdXNlRG93biA9IHRydWU7CiAgICAgIHRoaXMuX21vdXNlRW50ZXJlZCA9IHRydWU7CiAgICB9CiAgICByZXR1cm4gZ2V0KHRoaXMsICdwcm9wYWdhdGVFdmVudHMnKTsKICB9LAoKICBtb3VzZUxlYXZlOiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLl9tb3VzZURvd24pIHsKICAgICAgc2V0KHRoaXMsICdpc0FjdGl2ZScsIGZhbHNlKTsKICAgICAgdGhpcy5fbW91c2VFbnRlcmVkID0gZmFsc2U7CiAgICB9CiAgfSwKCiAgbW91c2VFbnRlcjogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5fbW91c2VEb3duKSB7CiAgICAgIHNldCh0aGlzLCAnaXNBY3RpdmUnLCB0cnVlKTsKICAgICAgdGhpcy5fbW91c2VFbnRlcmVkID0gdHJ1ZTsKICAgIH0KICB9LAoKICBtb3VzZVVwOiBmdW5jdGlvbihldmVudCkgewogICAgaWYgKGdldCh0aGlzLCAnaXNBY3RpdmUnKSkgewogICAgICAvLyBBY3R1YWxseSBpbnZva2UgdGhlIGJ1dHRvbidzIHRhcmdldCBhbmQgYWN0aW9uLgogICAgICAvLyBUaGlzIG1ldGhvZCBjb21lcyBmcm9tIHRoZSBFbWJlci5UYXJnZXRBY3Rpb25TdXBwb3J0IG1peGluLgogICAgICB0aGlzLnRyaWdnZXJBY3Rpb24oKTsKICAgICAgc2V0KHRoaXMsICdpc0FjdGl2ZScsIGZhbHNlKTsKICAgIH0KCiAgICB0aGlzLl9tb3VzZURvd24gPSBmYWxzZTsKICAgIHRoaXMuX21vdXNlRW50ZXJlZCA9IGZhbHNlOwogICAgcmV0dXJuIGdldCh0aGlzLCAncHJvcGFnYXRlRXZlbnRzJyk7CiAgfSwKCiAga2V5RG93bjogZnVuY3Rpb24oZXZlbnQpIHsKICAgIC8vIEhhbmRsZSBzcGFjZSBvciBlbnRlcgogICAgaWYgKGV2ZW50LmtleUNvZGUgPT09IDEzIHx8IGV2ZW50LmtleUNvZGUgPT09IDMyKSB7CiAgICAgIHRoaXMubW91c2VEb3duKCk7CiAgICB9CiAgfSwKCiAga2V5VXA6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAvLyBIYW5kbGUgc3BhY2Ugb3IgZW50ZXIKICAgIGlmIChldmVudC5rZXlDb2RlID09PSAxMyB8fCBldmVudC5rZXlDb2RlID09PSAzMikgewogICAgICB0aGlzLm1vdXNlVXAoKTsKICAgIH0KICB9LAoKICAvLyBUT0RPOiBIYW5kbGUgcHJvcGVyIHRvdWNoIGJlaGF2aW9yLiBJbmNsdWRpbmcgc2hvdWxkIG1ha2UgaW5hY3RpdmUgd2hlbgogIC8vIGZpbmdlciBtb3ZlcyBtb3JlIHRoYW4gMjB4IG91dHNpZGUgb2YgdGhlIGVkZ2Ugb2YgdGhlIGJ1dHRvbiAodnMgbW91c2UKICAvLyB3aGljaCBnb2VzIGluYWN0aXZlIGFzIHNvb24gYXMgbW91c2UgZ29lcyBvdXQgb2YgZWRnZXMuKQoKICB0b3VjaFN0YXJ0OiBmdW5jdGlvbih0b3VjaCkgewogICAgcmV0dXJuIHRoaXMubW91c2VEb3duKHRvdWNoKTsKICB9LAoKICB0b3VjaEVuZDogZnVuY3Rpb24odG91Y2gpIHsKICAgIHJldHVybiB0aGlzLm1vdXNlVXAodG91Y2gpOwogIH0sCgogIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgRW1iZXIuZGVwcmVjYXRlKCJFbWJlci5CdXR0b24gaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGZyb20gZnV0dXJlIHJlbGVhc2VzLiBDb25zaWRlciB1c2luZyB0aGUgYHt7YWN0aW9ufX1gIGhlbHBlci4iKTsKICAgIHRoaXMuX3N1cGVyKCk7CiAgfQp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1oYW5kbGViYXJzCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQ7CgovKioKICBUaGUgaW50ZXJuYWwgY2xhc3MgdXNlZCB0byBjcmVhdGUgdGV4dGFyZWEgZWxlbWVudCB3aGVuIHRoZSBge3t0ZXh0YXJlYX19YAogIGhlbHBlciBpcyB1c2VkLgoKICBTZWUgW2hhbmRsZWJhcnMuaGVscGVycy50ZXh0YXJlYV0oL2FwaS9jbGFzc2VzL0VtYmVyLkhhbmRsZWJhcnMuaGVscGVycy5odG1sI21ldGhvZF90ZXh0YXJlYSkgIGZvciB1c2FnZSBkZXRhaWxzLgoKICAjIyBMYXlvdXQgYW5kIExheW91dE5hbWUgcHJvcGVydGllcwoKICBCZWNhdXNlIEhUTUwgYHRleHRhcmVhYCBlbGVtZW50cyBkbyBub3QgY29udGFpbiBpbm5lciBIVE1MIHRoZSBgbGF5b3V0YCBhbmQKICBgbGF5b3V0TmFtZWAgcHJvcGVydGllcyB3aWxsIG5vdCBiZSBhcHBsaWVkLiBTZWUgW0VtYmVyLlZpZXddKC9hcGkvY2xhc3Nlcy9FbWJlci5WaWV3Lmh0bWwpJ3MKICBsYXlvdXQgc2VjdGlvbiBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KCiAgQGNsYXNzIFRleHRBcmVhCiAgQG5hbWVzcGFjZSBFbWJlcgogIEBleHRlbmRzIEVtYmVyLkNvbXBvbmVudAogIEB1c2VzIEVtYmVyLlRleHRTdXBwb3J0CiovCkVtYmVyLlRleHRBcmVhID0gRW1iZXIuQ29tcG9uZW50LmV4dGVuZChFbWJlci5UZXh0U3VwcG9ydCwgewogIGNsYXNzTmFtZXM6IFsnZW1iZXItdGV4dC1hcmVhJ10sCgogIHRhZ05hbWU6ICJ0ZXh0YXJlYSIsCiAgYXR0cmlidXRlQmluZGluZ3M6IFsncm93cycsICdjb2xzJywgJ25hbWUnXSwKICByb3dzOiBudWxsLAogIGNvbHM6IG51bGwsCgogIF91cGRhdGVFbGVtZW50VmFsdWU6IEVtYmVyLm9ic2VydmVyKCd2YWx1ZScsIGZ1bmN0aW9uKCkgewogICAgLy8gV2UgZG8gdGhpcyBjaGVjayBzbyBjdXJzb3IgcG9zaXRpb24gZG9lc24ndCBnZXQgYWZmZWN0ZWQgaW4gSUUKICAgIHZhciB2YWx1ZSA9IGdldCh0aGlzLCAndmFsdWUnKSwKICAgICAgICAkZWwgPSB0aGlzLiQoKTsKICAgIGlmICgkZWwgJiYgdmFsdWUgIT09ICRlbC52YWwoKSkgewogICAgICAkZWwudmFsKHZhbHVlKTsKICAgIH0KICB9KSwKCiAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9zdXBlcigpOwogICAgdGhpcy5vbigiZGlkSW5zZXJ0RWxlbWVudCIsIHRoaXMsIHRoaXMuX3VwZGF0ZUVsZW1lbnRWYWx1ZSk7CiAgfQoKfSk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qanNoaW50IGVxZXFlcTpmYWxzZSAqLwoKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1oYW5kbGViYXJzCiovCgp2YXIgc2V0ID0gRW1iZXIuc2V0LAogICAgZ2V0ID0gRW1iZXIuZ2V0LAogICAgaW5kZXhPZiA9IEVtYmVyLkVudW1lcmFibGVVdGlscy5pbmRleE9mLAogICAgaW5kZXhlc09mID0gRW1iZXIuRW51bWVyYWJsZVV0aWxzLmluZGV4ZXNPZiwKICAgIGZvckVhY2ggPSBFbWJlci5FbnVtZXJhYmxlVXRpbHMuZm9yRWFjaCwKICAgIHJlcGxhY2UgPSBFbWJlci5FbnVtZXJhYmxlVXRpbHMucmVwbGFjZSwKICAgIGlzQXJyYXkgPSBFbWJlci5pc0FycmF5LAogICAgcHJlY29tcGlsZVRlbXBsYXRlID0gRW1iZXIuSGFuZGxlYmFycy5jb21waWxlOwoKRW1iZXIuU2VsZWN0T3B0aW9uID0gRW1iZXIuVmlldy5leHRlbmQoewogIHRhZ05hbWU6ICdvcHRpb24nLAogIGF0dHJpYnV0ZUJpbmRpbmdzOiBbJ3ZhbHVlJywgJ3NlbGVjdGVkJ10sCgogIGRlZmF1bHRUZW1wbGF0ZTogZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IHsgZGF0YTogb3B0aW9ucy5kYXRhLCBoYXNoOiB7fSB9OwogICAgRW1iZXIuSGFuZGxlYmFycy5oZWxwZXJzLmJpbmQuY2FsbChjb250ZXh0LCAidmlldy5sYWJlbCIsIG9wdGlvbnMpOwogIH0sCgogIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5sYWJlbFBhdGhEaWRDaGFuZ2UoKTsKICAgIHRoaXMudmFsdWVQYXRoRGlkQ2hhbmdlKCk7CgogICAgdGhpcy5fc3VwZXIoKTsKICB9LAoKICBzZWxlY3RlZDogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oKSB7CiAgICB2YXIgY29udGVudCA9IGdldCh0aGlzLCAnY29udGVudCcpLAogICAgICAgIHNlbGVjdGlvbiA9IGdldCh0aGlzLCAncGFyZW50Vmlldy5zZWxlY3Rpb24nKTsKICAgIGlmIChnZXQodGhpcywgJ3BhcmVudFZpZXcubXVsdGlwbGUnKSkgewogICAgICByZXR1cm4gc2VsZWN0aW9uICYmIGluZGV4T2Yoc2VsZWN0aW9uLCBjb250ZW50LnZhbHVlT2YoKSkgPiAtMTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIFByaW1pdGl2ZXMgZ2V0IHBhc3NlZCB0aHJvdWdoIGJpbmRpbmdzIGFzIG9iamVjdHMuLi4gc2luY2UKICAgICAgLy8gYG5ldyBOdW1iZXIoNCkgIT09IDRgLCB3ZSB1c2UgYD09YCBiZWxvdwogICAgICByZXR1cm4gY29udGVudCA9PSBzZWxlY3Rpb247CiAgICB9CiAgfSkucHJvcGVydHkoJ2NvbnRlbnQnLCAncGFyZW50Vmlldy5zZWxlY3Rpb24nKSwKCiAgbGFiZWxQYXRoRGlkQ2hhbmdlOiBFbWJlci5vYnNlcnZlcigncGFyZW50Vmlldy5vcHRpb25MYWJlbFBhdGgnLCBmdW5jdGlvbigpIHsKICAgIHZhciBsYWJlbFBhdGggPSBnZXQodGhpcywgJ3BhcmVudFZpZXcub3B0aW9uTGFiZWxQYXRoJyk7CgogICAgaWYgKCFsYWJlbFBhdGgpIHsgcmV0dXJuOyB9CgogICAgRW1iZXIuZGVmaW5lUHJvcGVydHkodGhpcywgJ2xhYmVsJywgRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBnZXQodGhpcywgbGFiZWxQYXRoKTsKICAgIH0pLnByb3BlcnR5KGxhYmVsUGF0aCkpOwogIH0pLAoKICB2YWx1ZVBhdGhEaWRDaGFuZ2U6IEVtYmVyLm9ic2VydmVyKCdwYXJlbnRWaWV3Lm9wdGlvblZhbHVlUGF0aCcsIGZ1bmN0aW9uKCkgewogICAgdmFyIHZhbHVlUGF0aCA9IGdldCh0aGlzLCAncGFyZW50Vmlldy5vcHRpb25WYWx1ZVBhdGgnKTsKCiAgICBpZiAoIXZhbHVlUGF0aCkgeyByZXR1cm47IH0KCiAgICBFbWJlci5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAndmFsdWUnLCBFbWJlci5jb21wdXRlZChmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGdldCh0aGlzLCB2YWx1ZVBhdGgpOwogICAgfSkucHJvcGVydHkodmFsdWVQYXRoKSk7CiAgfSkKfSk7CgpFbWJlci5TZWxlY3RPcHRncm91cCA9IEVtYmVyLkNvbGxlY3Rpb25WaWV3LmV4dGVuZCh7CiAgdGFnTmFtZTogJ29wdGdyb3VwJywKICBhdHRyaWJ1dGVCaW5kaW5nczogWydsYWJlbCddLAoKICBzZWxlY3Rpb25CaW5kaW5nOiAncGFyZW50Vmlldy5zZWxlY3Rpb24nLAogIG11bHRpcGxlQmluZGluZzogJ3BhcmVudFZpZXcubXVsdGlwbGUnLAogIG9wdGlvbkxhYmVsUGF0aEJpbmRpbmc6ICdwYXJlbnRWaWV3Lm9wdGlvbkxhYmVsUGF0aCcsCiAgb3B0aW9uVmFsdWVQYXRoQmluZGluZzogJ3BhcmVudFZpZXcub3B0aW9uVmFsdWVQYXRoJywKCiAgaXRlbVZpZXdDbGFzc0JpbmRpbmc6ICdwYXJlbnRWaWV3Lm9wdGlvblZpZXcnCn0pOwoKLyoqCiAgVGhlIGBFbWJlci5TZWxlY3RgIHZpZXcgY2xhc3MgcmVuZGVycyBhCiAgW3NlbGVjdF0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vSFRNTC9FbGVtZW50L3NlbGVjdCkgSFRNTCBlbGVtZW50LAogIGFsbG93aW5nIHRoZSB1c2VyIHRvIGNob29zZSBmcm9tIGEgbGlzdCBvZiBvcHRpb25zLgoKICBUaGUgdGV4dCBhbmQgYHZhbHVlYCBwcm9wZXJ0eSBvZiBlYWNoIGA8b3B0aW9uPmAgZWxlbWVudCB3aXRoaW4gdGhlCiAgYDxzZWxlY3Q+YCBlbGVtZW50IGFyZSBwb3B1bGF0ZWQgZnJvbSB0aGUgb2JqZWN0cyBpbiB0aGUgYEVsZW1lbnQuU2VsZWN0YCdzCiAgYGNvbnRlbnRgIHByb3BlcnR5LiBUaGUgdW5kZXJseWluZyBkYXRhIG9iamVjdCBvZiB0aGUgc2VsZWN0ZWQgYDxvcHRpb24+YCBpcwogIHN0b3JlZCBpbiB0aGUgYEVsZW1lbnQuU2VsZWN0YCdzIGB2YWx1ZWAgcHJvcGVydHkuCgogICMjIFRoZSBDb250ZW50IFByb3BlcnR5IChhcnJheSBvZiBzdHJpbmdzKQoKICBUaGUgc2ltcGxlc3QgdmVyc2lvbiBvZiBhbiBgRW1iZXIuU2VsZWN0YCB0YWtlcyBhbiBhcnJheSBvZiBzdHJpbmdzIGFzIGl0cwogIGBjb250ZW50YCBwcm9wZXJ0eS4gVGhlIHN0cmluZyB3aWxsIGJlIHVzZWQgYXMgYm90aCB0aGUgYHZhbHVlYCBwcm9wZXJ0eSBhbmQKICB0aGUgaW5uZXIgdGV4dCBvZiBlYWNoIGA8b3B0aW9uPmAgZWxlbWVudCBpbnNpZGUgdGhlIHJlbmRlcmVkIGA8c2VsZWN0PmAuCgogIEV4YW1wbGU6CgogIGBgYGphdmFzY3JpcHQKICBBcHAuQXBwbGljYXRpb25Db250cm9sbGVyID0gRW1iZXIuQ29udHJvbGxlci5leHRlbmQoewogICAgbmFtZXM6IFsiWWVodWRhIiwgIlRvbSJdCiAgfSk7CiAgYGBgCgogIGBgYGhhbmRsZWJhcnMKICB7e3ZpZXcgRW1iZXIuU2VsZWN0IGNvbnRlbnQ9bmFtZXN9fQogIGBgYAoKICBXb3VsZCByZXN1bHQgaW4gdGhlIGZvbGxvd2luZyBIVE1MOgoKICBgYGBodG1sCiAgPHNlbGVjdCBjbGFzcz0iZW1iZXItc2VsZWN0Ij4KICAgIDxvcHRpb24gdmFsdWU9IlllaHVkYSI+WWVodWRhPC9vcHRpb24+CiAgICA8b3B0aW9uIHZhbHVlPSJUb20iPlRvbTwvb3B0aW9uPgogIDwvc2VsZWN0PgogIGBgYAoKICBZb3UgY2FuIGNvbnRyb2wgd2hpY2ggYDxvcHRpb24+YCBpcyBzZWxlY3RlZCB0aHJvdWdoIHRoZSBgRW1iZXIuU2VsZWN0YCdzCiAgYHZhbHVlYCBwcm9wZXJ0eToKCiAgYGBgamF2YXNjcmlwdAogIEFwcC5BcHBsaWNhdGlvbkNvbnRyb2xsZXIgPSBFbWJlci5Db250cm9sbGVyLmV4dGVuZCh7CiAgICBzZWxlY3RlZE5hbWU6ICdUb20nLAogICAgbmFtZXM6IFsiWWVodWRhIiwgIlRvbSJdCiAgfSk7CiAgYGBgCgogIGBgYGhhbmRsZWJhcnMKICB7e3ZpZXcgRW1iZXIuU2VsZWN0CiAgICAgICAgIGNvbnRlbnQ9bmFtZXMKICAgICAgICAgdmFsdWU9c2VsZWN0ZWROYW1lCiAgfX0KICBgYGAKCiAgV291bGQgcmVzdWx0IGluIHRoZSBmb2xsb3dpbmcgSFRNTCB3aXRoIHRoZSBgPG9wdGlvbj5gIGZvciAnVG9tJyBzZWxlY3RlZDoKCiAgYGBgaHRtbAogIDxzZWxlY3QgY2xhc3M9ImVtYmVyLXNlbGVjdCI+CiAgICA8b3B0aW9uIHZhbHVlPSJZZWh1ZGEiPlllaHVkYTwvb3B0aW9uPgogICAgPG9wdGlvbiB2YWx1ZT0iVG9tIiBzZWxlY3RlZD0ic2VsZWN0ZWQiPlRvbTwvb3B0aW9uPgogIDwvc2VsZWN0PgogIGBgYAoKICBBIHVzZXIgaW50ZXJhY3Rpbmcgd2l0aCB0aGUgcmVuZGVyZWQgYDxzZWxlY3Q+YCB0byBjaG9vc2UgIlllaHVkYSIgd291bGQKICB1cGRhdGUgdGhlIHZhbHVlIG9mIGBzZWxlY3RlZE5hbWVgIHRvICJZZWh1ZGEiLgoKICAjIyBUaGUgQ29udGVudCBQcm9wZXJ0eSAoYXJyYXkgb2YgT2JqZWN0cykKCiAgQW4gYEVtYmVyLlNlbGVjdGAgY2FuIGFsc28gdGFrZSBhbiBhcnJheSBvZiBKYXZhU2NyaXB0IG9yIEVtYmVyIG9iamVjdHMgYXMKICBpdHMgYGNvbnRlbnRgIHByb3BlcnR5LgoKICBXaGVuIHVzaW5nIG9iamVjdHMgeW91IG5lZWQgdG8gdGVsbCB0aGUgYEVtYmVyLlNlbGVjdGAgd2hpY2ggcHJvcGVydHkgc2hvdWxkCiAgYmUgYWNjZXNzZWQgb24gZWFjaCBvYmplY3QgdG8gc3VwcGx5IHRoZSBgdmFsdWVgIGF0dHJpYnV0ZSBvZiB0aGUgYDxvcHRpb24+YAogIGFuZCB3aGljaCBwcm9wZXJ0eSBzaG91bGQgYmUgdXNlZCB0byBzdXBwbHkgdGhlIGVsZW1lbnQgdGV4dC4KCiAgVGhlIGBvcHRpb25WYWx1ZVBhdGhgIG9wdGlvbiBpcyB1c2VkIHRvIHNwZWNpZnkgdGhlIHBhdGggb24gZWFjaCBvYmplY3QgdG8KICB0aGUgZGVzaXJlZCBwcm9wZXJ0eSBmb3IgdGhlIGB2YWx1ZWAgYXR0cmlidXRlLiBUaGUgYG9wdGlvbkxhYmVsUGF0aGAKICBzcGVjaWZpZXMgdGhlIHBhdGggb24gZWFjaCBvYmplY3QgdG8gdGhlIGRlc2lyZWQgcHJvcGVydHkgZm9yIHRoZQogIGVsZW1lbnQncyB0ZXh0LiBCb3RoIHBhdGhzIG11c3QgcmVmZXJlbmNlIGVhY2ggb2JqZWN0IGl0c2VsZiBhcyBgY29udGVudGA6CgogIGBgYGphdmFzY3JpcHQKICBBcHAuQXBwbGljYXRpb25Db250cm9sbGVyID0gRW1iZXIuQ29udHJvbGxlci5leHRlbmQoewogICAgcHJvZ3JhbW1lcnM6IFsKICAgICAge2ZpcnN0TmFtZTogIlllaHVkYSIsIGlkOiAxfSwKICAgICAge2ZpcnN0TmFtZTogIlRvbSIsICAgIGlkOiAyfQogICAgXQogIH0pOwogIGBgYAoKICBgYGBoYW5kbGViYXJzCiAge3t2aWV3IEVtYmVyLlNlbGVjdAogICAgICAgICBjb250ZW50PXByb2dyYW1tZXJzCiAgICAgICAgIG9wdGlvblZhbHVlUGF0aD0iY29udGVudC5pZCIKICAgICAgICAgb3B0aW9uTGFiZWxQYXRoPSJjb250ZW50LmZpcnN0TmFtZSJ9fQogIGBgYAoKICBXb3VsZCByZXN1bHQgaW4gdGhlIGZvbGxvd2luZyBIVE1MOgoKICBgYGBodG1sCiAgPHNlbGVjdCBjbGFzcz0iZW1iZXItc2VsZWN0Ij4KICAgIDxvcHRpb24gdmFsdWU9IjEiPlllaHVkYTwvb3B0aW9uPgogICAgPG9wdGlvbiB2YWx1ZT0iMiI+VG9tPC9vcHRpb24+CiAgPC9zZWxlY3Q+CiAgYGBgCgogIFRoZSBgdmFsdWVgIGF0dHJpYnV0ZSBvZiB0aGUgc2VsZWN0ZWQgYDxvcHRpb24+YCB3aXRoaW4gYW4gYEVtYmVyLlNlbGVjdGAKICBjYW4gYmUgYm91bmQgdG8gYSBwcm9wZXJ0eSBvbiBhbm90aGVyIG9iamVjdDoKCiAgYGBgamF2YXNjcmlwdAogIEFwcC5BcHBsaWNhdGlvbkNvbnRyb2xsZXIgPSBFbWJlci5Db250cm9sbGVyLmV4dGVuZCh7CiAgICBwcm9ncmFtbWVyczogWwogICAgICB7Zmlyc3ROYW1lOiAiWWVodWRhIiwgaWQ6IDF9LAogICAgICB7Zmlyc3ROYW1lOiAiVG9tIiwgICAgaWQ6IDJ9CiAgICBdLAogICAgY3VycmVudFByb2dyYW1tZXI6IHsKICAgICAgaWQ6IDIKICAgIH0KICB9KTsKICBgYGAKCiAgYGBgaGFuZGxlYmFycwogIHt7dmlldyBFbWJlci5TZWxlY3QKICAgICAgICAgY29udGVudD1wcm9ncmFtbWVycwogICAgICAgICBvcHRpb25WYWx1ZVBhdGg9ImNvbnRlbnQuaWQiCiAgICAgICAgIG9wdGlvbkxhYmVsUGF0aD0iY29udGVudC5maXJzdE5hbWUiCiAgICAgICAgIHZhbHVlPWN1cnJlbnRQcm9ncmFtbWVyLmlkfX0KICBgYGAKCiAgV291bGQgcmVzdWx0IGluIHRoZSBmb2xsb3dpbmcgSFRNTCB3aXRoIGEgc2VsZWN0ZWQgb3B0aW9uOgoKICBgYGBodG1sCiAgPHNlbGVjdCBjbGFzcz0iZW1iZXItc2VsZWN0Ij4KICAgIDxvcHRpb24gdmFsdWU9IjEiPlllaHVkYTwvb3B0aW9uPgogICAgPG9wdGlvbiB2YWx1ZT0iMiIgc2VsZWN0ZWQ9InNlbGVjdGVkIj5Ub208L29wdGlvbj4KICA8L3NlbGVjdD4KICBgYGAKCiAgSW50ZXJhY3Rpbmcgd2l0aCB0aGUgcmVuZGVyZWQgZWxlbWVudCBieSBzZWxlY3RpbmcgdGhlIGZpcnN0IG9wdGlvbgogICgnWWVodWRhJykgd2lsbCB1cGRhdGUgdGhlIGBpZGAgb2YgYGN1cnJlbnRQcm9ncmFtbWVyYAogIHRvIG1hdGNoIHRoZSBgdmFsdWVgIHByb3BlcnR5IG9mIHRoZSBuZXdseSBzZWxlY3RlZCBgPG9wdGlvbj5gLgoKICBBbHRlcm5hdGl2ZWx5LCB5b3UgY2FuIGNvbnRyb2wgc2VsZWN0aW9uIHRocm91Z2ggdGhlIHVuZGVybHlpbmcgb2JqZWN0cwogIHVzZWQgdG8gcmVuZGVyIGVhY2ggb2JqZWN0IGJ5IGJpbmRpbmcgdGhlIGBzZWxlY3Rpb25gIG9wdGlvbi4gV2hlbiB0aGUgc2VsZWN0ZWQKICBgPG9wdGlvbj5gIGlzIGNoYW5nZWQsIHRoZSBwcm9wZXJ0eSBwYXRoIHByb3ZpZGVkIHRvIGBzZWxlY3Rpb25gCiAgd2lsbCBiZSB1cGRhdGVkIHRvIG1hdGNoIHRoZSBjb250ZW50IG9iamVjdCBvZiB0aGUgcmVuZGVyZWQgYDxvcHRpb24+YAogIGVsZW1lbnQ6CgogIGBgYGphdmFzY3JpcHQKICBBcHAuQXBwbGljYXRpb25Db250cm9sbGVyID0gRW1iZXIuQ29udHJvbGxlci5leHRlbmQoewogICAgc2VsZWN0ZWRQZXJzb246IG51bGwsCiAgICBwcm9ncmFtbWVyczogWwogICAgICB7Zmlyc3ROYW1lOiAiWWVodWRhIiwgaWQ6IDF9LAogICAgICB7Zmlyc3ROYW1lOiAiVG9tIiwgICAgaWQ6IDJ9CiAgICBdCiAgfSk7CiAgYGBgCgogIGBgYGhhbmRsZWJhcnMKICB7e3ZpZXcgRW1iZXIuU2VsZWN0CiAgICAgICAgIGNvbnRlbnQ9cHJvZ3JhbW1lcnMKICAgICAgICAgb3B0aW9uVmFsdWVQYXRoPSJjb250ZW50LmlkIgogICAgICAgICBvcHRpb25MYWJlbFBhdGg9ImNvbnRlbnQuZmlyc3ROYW1lIgogICAgICAgICBzZWxlY3Rpb249c2VsZWN0ZWRQZXJzb259fQogIGBgYAoKICBXb3VsZCByZXN1bHQgaW4gdGhlIGZvbGxvd2luZyBIVE1MIHdpdGggYSBzZWxlY3RlZCBvcHRpb246CgogIGBgYGh0bWwKICA8c2VsZWN0IGNsYXNzPSJlbWJlci1zZWxlY3QiPgogICAgPG9wdGlvbiB2YWx1ZT0iMSI+WWVodWRhPC9vcHRpb24+CiAgICA8b3B0aW9uIHZhbHVlPSIyIiBzZWxlY3RlZD0ic2VsZWN0ZWQiPlRvbTwvb3B0aW9uPgogIDwvc2VsZWN0PgogIGBgYAoKICBJbnRlcmFjdGluZyB3aXRoIHRoZSByZW5kZXJlZCBlbGVtZW50IGJ5IHNlbGVjdGluZyB0aGUgZmlyc3Qgb3B0aW9uCiAgKCdZZWh1ZGEnKSB3aWxsIHVwZGF0ZSB0aGUgYHNlbGVjdGVkUGVyc29uYCB0byBtYXRjaCB0aGUgb2JqZWN0IG9mCiAgdGhlIG5ld2x5IHNlbGVjdGVkIGA8b3B0aW9uPmAuIEluIHRoaXMgY2FzZSBpdCBpcyB0aGUgZmlyc3Qgb2JqZWN0CiAgaW4gdGhlIGBwcm9ncmFtbWVyc2AKCiAgIyMgU3VwcGx5aW5nIGEgUHJvbXB0CgogIEEgYG51bGxgIHZhbHVlIGZvciB0aGUgYEVtYmVyLlNlbGVjdGAncyBgdmFsdWVgIG9yIGBzZWxlY3Rpb25gIHByb3BlcnR5CiAgcmVzdWx0cyBpbiB0aGVyZSBiZWluZyBubyBgPG9wdGlvbj5gIHdpdGggYSBgc2VsZWN0ZWRgIGF0dHJpYnV0ZToKCiAgYGBgamF2YXNjcmlwdAogIEFwcC5BcHBsaWNhdGlvbkNvbnRyb2xsZXIgPSBFbWJlci5Db250cm9sbGVyLmV4dGVuZCh7CiAgICBzZWxlY3RlZFByb2dyYW1tZXI6IG51bGwsCiAgICBwcm9ncmFtbWVyczogWwogICAgICAiWWVodWRhIiwKICAgICAgIlRvbSIKICAgIF0KICB9KTsKICBgYGAKCiAgYGBgIGhhbmRsZWJhcnMKICB7e3ZpZXcgRW1iZXIuU2VsZWN0CiAgICAgICAgIGNvbnRlbnQ9cHJvZ3JhbW1lcnMKICAgICAgICAgdmFsdWU9c2VsZWN0ZWRQcm9ncmFtbWVyCiAgfX0KICBgYGAKCiAgV291bGQgcmVzdWx0IGluIHRoZSBmb2xsb3dpbmcgSFRNTDoKCiAgYGBgaHRtbAogIDxzZWxlY3QgY2xhc3M9ImVtYmVyLXNlbGVjdCI+CiAgICA8b3B0aW9uIHZhbHVlPSJZZWh1ZGEiPlllaHVkYTwvb3B0aW9uPgogICAgPG9wdGlvbiB2YWx1ZT0iVG9tIj5Ub208L29wdGlvbj4KICA8L3NlbGVjdD4KICBgYGAKCiAgQWx0aG91Z2ggYHNlbGVjdGVkUHJvZ3JhbW1lcmAgaXMgYG51bGxgIGFuZCBubyBgPG9wdGlvbj5gCiAgaGFzIGEgYHNlbGVjdGVkYCBhdHRyaWJ1dGUgdGhlIHJlbmRlcmVkIEhUTUwgd2lsbCBkaXNwbGF5IHRoZQogIGZpcnN0IGl0ZW0gYXMgdGhvdWdoIGl0IHdlcmUgc2VsZWN0ZWQuIFlvdSBjYW4gc3VwcGx5IGEgc3RyaW5nCiAgdmFsdWUgZm9yIHRoZSBgRW1iZXIuU2VsZWN0YCB0byBkaXNwbGF5IHdoZW4gdGhlcmUgaXMgbm8gc2VsZWN0aW9uCiAgd2l0aCB0aGUgYHByb21wdGAgb3B0aW9uOgoKICBgYGBqYXZhc2NyaXB0CiAgQXBwLkFwcGxpY2F0aW9uQ29udHJvbGxlciA9IEVtYmVyLkNvbnRyb2xsZXIuZXh0ZW5kKHsKICAgIHNlbGVjdGVkUHJvZ3JhbW1lcjogbnVsbCwKICAgIHByb2dyYW1tZXJzOiBbCiAgICAgICJZZWh1ZGEiLAogICAgICAiVG9tIgogICAgXQogIH0pOwogIGBgYAoKICBgYGBoYW5kbGViYXJzCiAge3t2aWV3IEVtYmVyLlNlbGVjdAogICAgICAgICBjb250ZW50PXByb2dyYW1tZXJzCiAgICAgICAgIHZhbHVlPXNlbGVjdGVkUHJvZ3JhbW1lcgogICAgICAgICBwcm9tcHQ9IlBsZWFzZSBzZWxlY3QgYSBuYW1lIgogIH19CiAgYGBgCgogIFdvdWxkIHJlc3VsdCBpbiB0aGUgZm9sbG93aW5nIEhUTUw6CgogIGBgYGh0bWwKICA8c2VsZWN0IGNsYXNzPSJlbWJlci1zZWxlY3QiPgogICAgPG9wdGlvbj5QbGVhc2Ugc2VsZWN0IGEgbmFtZTwvb3B0aW9uPgogICAgPG9wdGlvbiB2YWx1ZT0iWWVodWRhIj5ZZWh1ZGE8L29wdGlvbj4KICAgIDxvcHRpb24gdmFsdWU9IlRvbSI+VG9tPC9vcHRpb24+CiAgPC9zZWxlY3Q+CiAgYGBgCgogIEBjbGFzcyBTZWxlY3QKICBAbmFtZXNwYWNlIEVtYmVyCiAgQGV4dGVuZHMgRW1iZXIuVmlldwoqLwpFbWJlci5TZWxlY3QgPSBFbWJlci5WaWV3LmV4dGVuZCh7CiAgdGFnTmFtZTogJ3NlbGVjdCcsCiAgY2xhc3NOYW1lczogWydlbWJlci1zZWxlY3QnXSwKICBkZWZhdWx0VGVtcGxhdGU6IEVtYmVyLkhhbmRsZWJhcnMudGVtcGxhdGUoZnVuY3Rpb24gYW5vbnltb3VzKEhhbmRsZWJhcnMsZGVwdGgwLGhlbHBlcnMscGFydGlhbHMsZGF0YSkgewp0aGlzLmNvbXBpbGVySW5mbyA9IFs0LCc+PSAxLjAuMCddOwpoZWxwZXJzID0gdGhpcy5tZXJnZShoZWxwZXJzLCBFbWJlci5IYW5kbGViYXJzLmhlbHBlcnMpOyBkYXRhID0gZGF0YSB8fCB7fTsKICB2YXIgYnVmZmVyID0gJycsIHN0YWNrMSwgaGFzaFR5cGVzLCBoYXNoQ29udGV4dHMsIGVzY2FwZUV4cHJlc3Npb249dGhpcy5lc2NhcGVFeHByZXNzaW9uLCBzZWxmPXRoaXM7CgpmdW5jdGlvbiBwcm9ncmFtMShkZXB0aDAsZGF0YSkgewogIAogIHZhciBidWZmZXIgPSAnJywgc3RhY2sxLCBoYXNoVHlwZXMsIGhhc2hDb250ZXh0czsKICBkYXRhLmJ1ZmZlci5wdXNoKCI8b3B0aW9uIHZhbHVlPVwiXCI+Iik7CiAgaGFzaFR5cGVzID0ge307CiAgaGFzaENvbnRleHRzID0ge307CiAgc3RhY2sxID0gaGVscGVycy5fdHJpYWdlTXVzdGFjaGUuY2FsbChkZXB0aDAsICJ2aWV3LnByb21wdCIsIHtoYXNoOnt9LGNvbnRleHRzOltkZXB0aDBdLHR5cGVzOlsiSUQiXSxoYXNoQ29udGV4dHM6aGFzaENvbnRleHRzLGhhc2hUeXBlczpoYXNoVHlwZXMsZGF0YTpkYXRhfSk7CiAgaWYoc3RhY2sxIHx8IHN0YWNrMSA9PT0gMCkgeyBkYXRhLmJ1ZmZlci5wdXNoKHN0YWNrMSk7IH0KICBkYXRhLmJ1ZmZlci5wdXNoKCI8L29wdGlvbj4iKTsKICByZXR1cm4gYnVmZmVyOwogIH0KCmZ1bmN0aW9uIHByb2dyYW0zKGRlcHRoMCxkYXRhKSB7CiAgCiAgdmFyIHN0YWNrMSwgaGFzaFR5cGVzLCBoYXNoQ29udGV4dHM7CiAgaGFzaFR5cGVzID0ge307CiAgaGFzaENvbnRleHRzID0ge307CiAgc3RhY2sxID0gaGVscGVycy5lYWNoLmNhbGwoZGVwdGgwLCAidmlldy5ncm91cGVkQ29udGVudCIsIHtoYXNoOnt9LGludmVyc2U6c2VsZi5ub29wLGZuOnNlbGYucHJvZ3JhbSg0LCBwcm9ncmFtNCwgZGF0YSksY29udGV4dHM6W2RlcHRoMF0sdHlwZXM6WyJJRCJdLGhhc2hDb250ZXh0czpoYXNoQ29udGV4dHMsaGFzaFR5cGVzOmhhc2hUeXBlcyxkYXRhOmRhdGF9KTsKICBpZihzdGFjazEgfHwgc3RhY2sxID09PSAwKSB7IGRhdGEuYnVmZmVyLnB1c2goc3RhY2sxKTsgfQogIGVsc2UgeyBkYXRhLmJ1ZmZlci5wdXNoKCcnKTsgfQogIH0KZnVuY3Rpb24gcHJvZ3JhbTQoZGVwdGgwLGRhdGEpIHsKICAKICB2YXIgaGFzaENvbnRleHRzLCBoYXNoVHlwZXM7CiAgaGFzaENvbnRleHRzID0geydjb250ZW50JzogZGVwdGgwLCdsYWJlbCc6IGRlcHRoMH07CiAgaGFzaFR5cGVzID0geydjb250ZW50JzogIklEIiwnbGFiZWwnOiAiSUQifTsKICBkYXRhLmJ1ZmZlci5wdXNoKGVzY2FwZUV4cHJlc3Npb24oaGVscGVycy52aWV3LmNhbGwoZGVwdGgwLCAidmlldy5ncm91cFZpZXciLCB7aGFzaDp7CiAgICAnY29udGVudCc6ICgiY29udGVudCIpLAogICAgJ2xhYmVsJzogKCJsYWJlbCIpCiAgfSxjb250ZXh0czpbZGVwdGgwXSx0eXBlczpbIklEIl0saGFzaENvbnRleHRzOmhhc2hDb250ZXh0cyxoYXNoVHlwZXM6aGFzaFR5cGVzLGRhdGE6ZGF0YX0pKSk7CiAgfQoKZnVuY3Rpb24gcHJvZ3JhbTYoZGVwdGgwLGRhdGEpIHsKICAKICB2YXIgc3RhY2sxLCBoYXNoVHlwZXMsIGhhc2hDb250ZXh0czsKICBoYXNoVHlwZXMgPSB7fTsKICBoYXNoQ29udGV4dHMgPSB7fTsKICBzdGFjazEgPSBoZWxwZXJzLmVhY2guY2FsbChkZXB0aDAsICJ2aWV3LmNvbnRlbnQiLCB7aGFzaDp7fSxpbnZlcnNlOnNlbGYubm9vcCxmbjpzZWxmLnByb2dyYW0oNywgcHJvZ3JhbTcsIGRhdGEpLGNvbnRleHRzOltkZXB0aDBdLHR5cGVzOlsiSUQiXSxoYXNoQ29udGV4dHM6aGFzaENvbnRleHRzLGhhc2hUeXBlczpoYXNoVHlwZXMsZGF0YTpkYXRhfSk7CiAgaWYoc3RhY2sxIHx8IHN0YWNrMSA9PT0gMCkgeyBkYXRhLmJ1ZmZlci5wdXNoKHN0YWNrMSk7IH0KICBlbHNlIHsgZGF0YS5idWZmZXIucHVzaCgnJyk7IH0KICB9CmZ1bmN0aW9uIHByb2dyYW03KGRlcHRoMCxkYXRhKSB7CiAgCiAgdmFyIGhhc2hDb250ZXh0cywgaGFzaFR5cGVzOwogIGhhc2hDb250ZXh0cyA9IHsnY29udGVudCc6IGRlcHRoMH07CiAgaGFzaFR5cGVzID0geydjb250ZW50JzogIklEIn07CiAgZGF0YS5idWZmZXIucHVzaChlc2NhcGVFeHByZXNzaW9uKGhlbHBlcnMudmlldy5jYWxsKGRlcHRoMCwgInZpZXcub3B0aW9uVmlldyIsIHtoYXNoOnsKICAgICdjb250ZW50JzogKCIiKQogIH0sY29udGV4dHM6W2RlcHRoMF0sdHlwZXM6WyJJRCJdLGhhc2hDb250ZXh0czpoYXNoQ29udGV4dHMsaGFzaFR5cGVzOmhhc2hUeXBlcyxkYXRhOmRhdGF9KSkpOwogIH0KCiAgaGFzaFR5cGVzID0ge307CiAgaGFzaENvbnRleHRzID0ge307CiAgc3RhY2sxID0gaGVscGVyc1snaWYnXS5jYWxsKGRlcHRoMCwgInZpZXcucHJvbXB0Iiwge2hhc2g6e30saW52ZXJzZTpzZWxmLm5vb3AsZm46c2VsZi5wcm9ncmFtKDEsIHByb2dyYW0xLCBkYXRhKSxjb250ZXh0czpbZGVwdGgwXSx0eXBlczpbIklEIl0saGFzaENvbnRleHRzOmhhc2hDb250ZXh0cyxoYXNoVHlwZXM6aGFzaFR5cGVzLGRhdGE6ZGF0YX0pOwogIGlmKHN0YWNrMSB8fCBzdGFjazEgPT09IDApIHsgZGF0YS5idWZmZXIucHVzaChzdGFjazEpOyB9CiAgaGFzaFR5cGVzID0ge307CiAgaGFzaENvbnRleHRzID0ge307CiAgc3RhY2sxID0gaGVscGVyc1snaWYnXS5jYWxsKGRlcHRoMCwgInZpZXcub3B0aW9uR3JvdXBQYXRoIiwge2hhc2g6e30saW52ZXJzZTpzZWxmLnByb2dyYW0oNiwgcHJvZ3JhbTYsIGRhdGEpLGZuOnNlbGYucHJvZ3JhbSgzLCBwcm9ncmFtMywgZGF0YSksY29udGV4dHM6W2RlcHRoMF0sdHlwZXM6WyJJRCJdLGhhc2hDb250ZXh0czpoYXNoQ29udGV4dHMsaGFzaFR5cGVzOmhhc2hUeXBlcyxkYXRhOmRhdGF9KTsKICBpZihzdGFjazEgfHwgc3RhY2sxID09PSAwKSB7IGRhdGEuYnVmZmVyLnB1c2goc3RhY2sxKTsgfQogIHJldHVybiBidWZmZXI7CiAgCn0pLAogIGF0dHJpYnV0ZUJpbmRpbmdzOiBbJ211bHRpcGxlJywgJ2Rpc2FibGVkJywgJ3RhYmluZGV4JywgJ25hbWUnXSwKCiAgLyoqCiAgICBUaGUgYG11bHRpcGxlYCBhdHRyaWJ1dGUgb2YgdGhlIHNlbGVjdCBlbGVtZW50LiBJbmRpY2F0ZXMgd2hldGhlciBtdWx0aXBsZQogICAgb3B0aW9ucyBjYW4gYmUgc2VsZWN0ZWQuCgogICAgQHByb3BlcnR5IG11bHRpcGxlCiAgICBAdHlwZSBCb29sZWFuCiAgICBAZGVmYXVsdCBmYWxzZQogICovCiAgbXVsdGlwbGU6IGZhbHNlLAoKICAvKioKICAgIFRoZSBgZGlzYWJsZWRgIGF0dHJpYnV0ZSBvZiB0aGUgc2VsZWN0IGVsZW1lbnQuIEluZGljYXRlcyB3aGV0aGVyCiAgICB0aGUgZWxlbWVudCBpcyBkaXNhYmxlZCBmcm9tIGludGVyYWN0aW9ucy4KCiAgICBAcHJvcGVydHkgZGlzYWJsZWQKICAgIEB0eXBlIEJvb2xlYW4KICAgIEBkZWZhdWx0IGZhbHNlCiAgKi8KICBkaXNhYmxlZDogZmFsc2UsCgogIC8qKgogICAgVGhlIGxpc3Qgb2Ygb3B0aW9ucy4KCiAgICBJZiBgb3B0aW9uTGFiZWxQYXRoYCBhbmQgYG9wdGlvblZhbHVlUGF0aGAgYXJlIG5vdCBvdmVycmlkZGVuLCB0aGlzIHNob3VsZAogICAgYmUgYSBsaXN0IG9mIHN0cmluZ3MsIHdoaWNoIHdpbGwgc2VydmUgc2ltdWx0YW5lb3VzbHkgYXMgbGFiZWxzIGFuZCB2YWx1ZXMuCgogICAgT3RoZXJ3aXNlLCB0aGlzIHNob3VsZCBiZSBhIGxpc3Qgb2Ygb2JqZWN0cy4gRm9yIGluc3RhbmNlOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIEVtYmVyLlNlbGVjdC5jcmVhdGUoewogICAgICBjb250ZW50OiBFbWJlci5BKFsKICAgICAgICAgIHsgaWQ6IDEsIGZpcnN0TmFtZTogJ1llaHVkYScgfSwKICAgICAgICAgIHsgaWQ6IDIsIGZpcnN0TmFtZTogJ1RvbScgfQogICAgICAgIF0pLAogICAgICBvcHRpb25MYWJlbFBhdGg6ICdjb250ZW50LmZpcnN0TmFtZScsCiAgICAgIG9wdGlvblZhbHVlUGF0aDogJ2NvbnRlbnQuaWQnCiAgICB9KTsKICAgIGBgYAoKICAgIEBwcm9wZXJ0eSBjb250ZW50CiAgICBAdHlwZSBBcnJheQogICAgQGRlZmF1bHQgbnVsbAogICovCiAgY29udGVudDogbnVsbCwKCiAgLyoqCiAgICBXaGVuIGBtdWx0aXBsZWAgaXMgYGZhbHNlYCwgdGhlIGVsZW1lbnQgb2YgYGNvbnRlbnRgIHRoYXQgaXMgY3VycmVudGx5CiAgICBzZWxlY3RlZCwgaWYgYW55LgoKICAgIFdoZW4gYG11bHRpcGxlYCBpcyBgdHJ1ZWAsIGFuIGFycmF5IG9mIHN1Y2ggZWxlbWVudHMuCgogICAgQHByb3BlcnR5IHNlbGVjdGlvbgogICAgQHR5cGUgT2JqZWN0IG9yIEFycmF5CiAgICBAZGVmYXVsdCBudWxsCiAgKi8KICBzZWxlY3Rpb246IG51bGwsCgogIC8qKgogICAgSW4gc2luZ2xlIHNlbGVjdGlvbiBtb2RlICh3aGVuIGBtdWx0aXBsZWAgaXMgYGZhbHNlYCksIHZhbHVlIGNhbiBiZSB1c2VkIHRvCiAgICBnZXQgdGhlIGN1cnJlbnQgc2VsZWN0aW9uJ3MgdmFsdWUgb3Igc2V0IHRoZSBzZWxlY3Rpb24gYnkgaXQncyB2YWx1ZS4KCiAgICBJdCBpcyBub3QgY3VycmVudGx5IHN1cHBvcnRlZCBpbiBtdWx0aXBsZSBzZWxlY3Rpb24gbW9kZS4KCiAgICBAcHJvcGVydHkgdmFsdWUKICAgIEB0eXBlIFN0cmluZwogICAgQGRlZmF1bHQgbnVsbAogICovCiAgdmFsdWU6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7IHJldHVybiB2YWx1ZTsgfQogICAgdmFyIHZhbHVlUGF0aCA9IGdldCh0aGlzLCAnb3B0aW9uVmFsdWVQYXRoJykucmVwbGFjZSgvXmNvbnRlbnRcLj8vLCAnJyk7CiAgICByZXR1cm4gdmFsdWVQYXRoID8gZ2V0KHRoaXMsICdzZWxlY3Rpb24uJyArIHZhbHVlUGF0aCkgOiBnZXQodGhpcywgJ3NlbGVjdGlvbicpOwogIH0pLnByb3BlcnR5KCdzZWxlY3Rpb24nKSwKCiAgLyoqCiAgICBJZiBnaXZlbiwgYSB0b3AtbW9zdCBkdW1teSBvcHRpb24gd2lsbCBiZSByZW5kZXJlZCB0byBzZXJ2ZSBhcyBhIHVzZXIKICAgIHByb21wdC4KCiAgICBAcHJvcGVydHkgcHJvbXB0CiAgICBAdHlwZSBTdHJpbmcKICAgIEBkZWZhdWx0IG51bGwKICAqLwogIHByb21wdDogbnVsbCwKCiAgLyoqCiAgICBUaGUgcGF0aCBvZiB0aGUgb3B0aW9uIGxhYmVscy4gU2VlIFtjb250ZW50XSgvYXBpL2NsYXNzZXMvRW1iZXIuU2VsZWN0Lmh0bWwjcHJvcGVydHlfY29udGVudCkuCgogICAgQHByb3BlcnR5IG9wdGlvbkxhYmVsUGF0aAogICAgQHR5cGUgU3RyaW5nCiAgICBAZGVmYXVsdCAnY29udGVudCcKICAqLwogIG9wdGlvbkxhYmVsUGF0aDogJ2NvbnRlbnQnLAoKICAvKioKICAgIFRoZSBwYXRoIG9mIHRoZSBvcHRpb24gdmFsdWVzLiBTZWUgW2NvbnRlbnRdKC9hcGkvY2xhc3Nlcy9FbWJlci5TZWxlY3QuaHRtbCNwcm9wZXJ0eV9jb250ZW50KS4KCiAgICBAcHJvcGVydHkgb3B0aW9uVmFsdWVQYXRoCiAgICBAdHlwZSBTdHJpbmcKICAgIEBkZWZhdWx0ICdjb250ZW50JwogICovCiAgb3B0aW9uVmFsdWVQYXRoOiAnY29udGVudCcsCgogIC8qKgogICAgVGhlIHBhdGggb2YgdGhlIG9wdGlvbiBncm91cC4KICAgIFdoZW4gdGhpcyBwcm9wZXJ0eSBpcyB1c2VkLCBgY29udGVudGAgc2hvdWxkIGJlIHNvcnRlZCBieSBgb3B0aW9uR3JvdXBQYXRoYC4KCiAgICBAcHJvcGVydHkgb3B0aW9uR3JvdXBQYXRoCiAgICBAdHlwZSBTdHJpbmcKICAgIEBkZWZhdWx0IG51bGwKICAqLwogIG9wdGlvbkdyb3VwUGF0aDogbnVsbCwKCiAgLyoqCiAgICBUaGUgdmlldyBjbGFzcyBmb3Igb3B0Z3JvdXAuCgogICAgQHByb3BlcnR5IGdyb3VwVmlldwogICAgQHR5cGUgRW1iZXIuVmlldwogICAgQGRlZmF1bHQgRW1iZXIuU2VsZWN0T3B0Z3JvdXAKICAqLwogIGdyb3VwVmlldzogRW1iZXIuU2VsZWN0T3B0Z3JvdXAsCgogIGdyb3VwZWRDb250ZW50OiBFbWJlci5jb21wdXRlZChmdW5jdGlvbigpIHsKICAgIHZhciBncm91cFBhdGggPSBnZXQodGhpcywgJ29wdGlvbkdyb3VwUGF0aCcpOwogICAgdmFyIGdyb3VwZWRDb250ZW50ID0gRW1iZXIuQSgpOwogICAgdmFyIGNvbnRlbnQgPSBnZXQodGhpcywgJ2NvbnRlbnQnKSB8fCBbXTsKCiAgICBmb3JFYWNoKGNvbnRlbnQsIGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgdmFyIGxhYmVsID0gZ2V0KGl0ZW0sIGdyb3VwUGF0aCk7CgogICAgICBpZiAoZ2V0KGdyb3VwZWRDb250ZW50LCAnbGFzdE9iamVjdC5sYWJlbCcpICE9PSBsYWJlbCkgewogICAgICAgIGdyb3VwZWRDb250ZW50LnB1c2hPYmplY3QoewogICAgICAgICAgbGFiZWw6IGxhYmVsLAogICAgICAgICAgY29udGVudDogRW1iZXIuQSgpCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGdldChncm91cGVkQ29udGVudCwgJ2xhc3RPYmplY3QuY29udGVudCcpLnB1c2goaXRlbSk7CiAgICB9KTsKCiAgICByZXR1cm4gZ3JvdXBlZENvbnRlbnQ7CiAgfSkucHJvcGVydHkoJ29wdGlvbkdyb3VwUGF0aCcsICdjb250ZW50LkBlYWNoJyksCgogIC8qKgogICAgVGhlIHZpZXcgY2xhc3MgZm9yIG9wdGlvbi4KCiAgICBAcHJvcGVydHkgb3B0aW9uVmlldwogICAgQHR5cGUgRW1iZXIuVmlldwogICAgQGRlZmF1bHQgRW1iZXIuU2VsZWN0T3B0aW9uCiAgKi8KICBvcHRpb25WaWV3OiBFbWJlci5TZWxlY3RPcHRpb24sCgogIF9jaGFuZ2U6IGZ1bmN0aW9uKCkgewogICAgaWYgKGdldCh0aGlzLCAnbXVsdGlwbGUnKSkgewogICAgICB0aGlzLl9jaGFuZ2VNdWx0aXBsZSgpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fY2hhbmdlU2luZ2xlKCk7CiAgICB9CiAgfSwKCiAgc2VsZWN0aW9uRGlkQ2hhbmdlOiBFbWJlci5vYnNlcnZlcignc2VsZWN0aW9uLkBlYWNoJywgZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZWN0aW9uID0gZ2V0KHRoaXMsICdzZWxlY3Rpb24nKTsKICAgIGlmIChnZXQodGhpcywgJ211bHRpcGxlJykpIHsKICAgICAgaWYgKCFpc0FycmF5KHNlbGVjdGlvbikpIHsKICAgICAgICBzZXQodGhpcywgJ3NlbGVjdGlvbicsIEVtYmVyLkEoW3NlbGVjdGlvbl0pKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdGhpcy5fc2VsZWN0aW9uRGlkQ2hhbmdlTXVsdGlwbGUoKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX3NlbGVjdGlvbkRpZENoYW5nZVNpbmdsZSgpOwogICAgfQogIH0pLAoKICB2YWx1ZURpZENoYW5nZTogRW1iZXIub2JzZXJ2ZXIoJ3ZhbHVlJywgZnVuY3Rpb24oKSB7CiAgICB2YXIgY29udGVudCA9IGdldCh0aGlzLCAnY29udGVudCcpLAogICAgICAgIHZhbHVlID0gZ2V0KHRoaXMsICd2YWx1ZScpLAogICAgICAgIHZhbHVlUGF0aCA9IGdldCh0aGlzLCAnb3B0aW9uVmFsdWVQYXRoJykucmVwbGFjZSgvXmNvbnRlbnRcLj8vLCAnJyksCiAgICAgICAgc2VsZWN0ZWRWYWx1ZSA9ICh2YWx1ZVBhdGggPyBnZXQodGhpcywgJ3NlbGVjdGlvbi4nICsgdmFsdWVQYXRoKSA6IGdldCh0aGlzLCAnc2VsZWN0aW9uJykpLAogICAgICAgIHNlbGVjdGlvbjsKCiAgICBpZiAodmFsdWUgIT09IHNlbGVjdGVkVmFsdWUpIHsKICAgICAgc2VsZWN0aW9uID0gY29udGVudCA/IGNvbnRlbnQuZmluZChmdW5jdGlvbihvYmopIHsKICAgICAgICByZXR1cm4gdmFsdWUgPT09ICh2YWx1ZVBhdGggPyBnZXQob2JqLCB2YWx1ZVBhdGgpIDogb2JqKTsKICAgICAgfSkgOiBudWxsOwoKICAgICAgdGhpcy5zZXQoJ3NlbGVjdGlvbicsIHNlbGVjdGlvbik7CiAgICB9CiAgfSksCgoKICBfdHJpZ2dlckNoYW5nZTogZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZWN0aW9uID0gZ2V0KHRoaXMsICdzZWxlY3Rpb24nKTsKICAgIHZhciB2YWx1ZSA9IGdldCh0aGlzLCAndmFsdWUnKTsKCiAgICBpZiAoIUVtYmVyLmlzTm9uZShzZWxlY3Rpb24pKSB7IHRoaXMuc2VsZWN0aW9uRGlkQ2hhbmdlKCk7IH0KICAgIGlmICghRW1iZXIuaXNOb25lKHZhbHVlKSkgeyB0aGlzLnZhbHVlRGlkQ2hhbmdlKCk7IH0KCiAgICB0aGlzLl9jaGFuZ2UoKTsKICB9LAoKICBfY2hhbmdlU2luZ2xlOiBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxlY3RlZEluZGV4ID0gdGhpcy4kKClbMF0uc2VsZWN0ZWRJbmRleCwKICAgICAgICBjb250ZW50ID0gZ2V0KHRoaXMsICdjb250ZW50JyksCiAgICAgICAgcHJvbXB0ID0gZ2V0KHRoaXMsICdwcm9tcHQnKTsKCiAgICBpZiAoIWNvbnRlbnQgfHwgIWdldChjb250ZW50LCAnbGVuZ3RoJykpIHsgcmV0dXJuOyB9CiAgICBpZiAocHJvbXB0ICYmIHNlbGVjdGVkSW5kZXggPT09IDApIHsgc2V0KHRoaXMsICdzZWxlY3Rpb24nLCBudWxsKTsgcmV0dXJuOyB9CgogICAgaWYgKHByb21wdCkgeyBzZWxlY3RlZEluZGV4IC09IDE7IH0KICAgIHNldCh0aGlzLCAnc2VsZWN0aW9uJywgY29udGVudC5vYmplY3RBdChzZWxlY3RlZEluZGV4KSk7CiAgfSwKCgogIF9jaGFuZ2VNdWx0aXBsZTogZnVuY3Rpb24oKSB7CiAgICB2YXIgb3B0aW9ucyA9IHRoaXMuJCgnb3B0aW9uOnNlbGVjdGVkJyksCiAgICAgICAgcHJvbXB0ID0gZ2V0KHRoaXMsICdwcm9tcHQnKSwKICAgICAgICBvZmZzZXQgPSBwcm9tcHQgPyAxIDogMCwKICAgICAgICBjb250ZW50ID0gZ2V0KHRoaXMsICdjb250ZW50JyksCiAgICAgICAgc2VsZWN0aW9uID0gZ2V0KHRoaXMsICdzZWxlY3Rpb24nKTsKCiAgICBpZiAoIWNvbnRlbnQpIHsgcmV0dXJuOyB9CiAgICBpZiAob3B0aW9ucykgewogICAgICB2YXIgc2VsZWN0ZWRJbmRleGVzID0gb3B0aW9ucy5tYXAoZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5kZXggLSBvZmZzZXQ7CiAgICAgIH0pLnRvQXJyYXkoKTsKICAgICAgdmFyIG5ld1NlbGVjdGlvbiA9IGNvbnRlbnQub2JqZWN0c0F0KHNlbGVjdGVkSW5kZXhlcyk7CgogICAgICBpZiAoaXNBcnJheShzZWxlY3Rpb24pKSB7CiAgICAgICAgcmVwbGFjZShzZWxlY3Rpb24sIDAsIGdldChzZWxlY3Rpb24sICdsZW5ndGgnKSwgbmV3U2VsZWN0aW9uKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXQodGhpcywgJ3NlbGVjdGlvbicsIG5ld1NlbGVjdGlvbik7CiAgICAgIH0KICAgIH0KICB9LAoKICBfc2VsZWN0aW9uRGlkQ2hhbmdlU2luZ2xlOiBmdW5jdGlvbigpIHsKICAgIHZhciBlbCA9IHRoaXMuZ2V0KCdlbGVtZW50Jyk7CiAgICBpZiAoIWVsKSB7IHJldHVybjsgfQoKICAgIHZhciBjb250ZW50ID0gZ2V0KHRoaXMsICdjb250ZW50JyksCiAgICAgICAgc2VsZWN0aW9uID0gZ2V0KHRoaXMsICdzZWxlY3Rpb24nKSwKICAgICAgICBzZWxlY3Rpb25JbmRleCA9IGNvbnRlbnQgPyBpbmRleE9mKGNvbnRlbnQsIHNlbGVjdGlvbikgOiAtMSwKICAgICAgICBwcm9tcHQgPSBnZXQodGhpcywgJ3Byb21wdCcpOwoKICAgIGlmIChwcm9tcHQpIHsgc2VsZWN0aW9uSW5kZXggKz0gMTsgfQogICAgaWYgKGVsKSB7IGVsLnNlbGVjdGVkSW5kZXggPSBzZWxlY3Rpb25JbmRleDsgfQogIH0sCgogIF9zZWxlY3Rpb25EaWRDaGFuZ2VNdWx0aXBsZTogZnVuY3Rpb24oKSB7CiAgICB2YXIgY29udGVudCA9IGdldCh0aGlzLCAnY29udGVudCcpLAogICAgICAgIHNlbGVjdGlvbiA9IGdldCh0aGlzLCAnc2VsZWN0aW9uJyksCiAgICAgICAgc2VsZWN0ZWRJbmRleGVzID0gY29udGVudCA/IGluZGV4ZXNPZihjb250ZW50LCBzZWxlY3Rpb24pIDogWy0xXSwKICAgICAgICBwcm9tcHQgPSBnZXQodGhpcywgJ3Byb21wdCcpLAogICAgICAgIG9mZnNldCA9IHByb21wdCA/IDEgOiAwLAogICAgICAgIG9wdGlvbnMgPSB0aGlzLiQoJ29wdGlvbicpLAogICAgICAgIGFkanVzdGVkOwoKICAgIGlmIChvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICBhZGp1c3RlZCA9IHRoaXMuaW5kZXggPiAtMSA/IHRoaXMuaW5kZXggLSBvZmZzZXQgOiAtMTsKICAgICAgICB0aGlzLnNlbGVjdGVkID0gaW5kZXhPZihzZWxlY3RlZEluZGV4ZXMsIGFkanVzdGVkKSA+IC0xOwogICAgICB9KTsKICAgIH0KICB9LAoKICBpbml0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3N1cGVyKCk7CiAgICB0aGlzLm9uKCJkaWRJbnNlcnRFbGVtZW50IiwgdGhpcywgdGhpcy5fdHJpZ2dlckNoYW5nZSk7CiAgICB0aGlzLm9uKCJjaGFuZ2UiLCB0aGlzLCB0aGlzLl9jaGFuZ2UpOwogIH0KfSk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItaGFuZGxlYmFycy1jb21waWxlcgoqLwoKLyoqCgogIFRoZSBge3tpbnB1dH19YCBoZWxwZXIgaW5zZXJ0cyBhbiBIVE1MIGA8aW5wdXQ+YCB0YWcgaW50byB0aGUgdGVtcGxhdGUsCiAgd2l0aCBhIGB0eXBlYCB2YWx1ZSBvZiBlaXRoZXIgYHRleHRgIG9yIGBjaGVja2JveGAuIElmIG5vIGB0eXBlYCBpcyBwcm92aWRlZCwKICBgdGV4dGAgd2lsbCBiZSB0aGUgZGVmYXVsdCB2YWx1ZSBhcHBsaWVkLiBUaGUgYXR0cmlidXRlcyBvZiBge3tpbnB1dH19YAogIG1hdGNoIHRob3NlIG9mIHRoZSBuYXRpdmUgSFRNTCB0YWcgYXMgY2xvc2VseSBhcyBwb3NzaWJsZSBmb3IgdGhlc2UgdHdvIHR5cGVzLgoKICAjIyBVc2UgYXMgdGV4dCBmaWVsZAogIEFuIGB7e2lucHV0fX1gIHdpdGggbm8gYHR5cGVgIG9yIGEgYHR5cGVgIG9mIGB0ZXh0YCB3aWxsIHJlbmRlciBhbiBIVE1MIHRleHQgaW5wdXQuCiAgVGhlIGZvbGxvd2luZyBIVE1MIGF0dHJpYnV0ZXMgY2FuIGJlIHNldCB2aWEgdGhlIGhlbHBlcjoKCiogYHZhbHVlYAoqIGBzaXplYAoqIGBuYW1lYAoqIGBwYXR0ZXJuYAoqIGBwbGFjZWhvbGRlcmAKKiBgZGlzYWJsZWRgCiogYG1heGxlbmd0aGAKKiBgdGFiaW5kZXhgCgoKICBXaGVuIHNldCB0byBhIHF1b3RlZCBzdHJpbmcsIHRoZXNlIHZhbHVlcyB3aWxsIGJlIGRpcmVjdGx5IGFwcGxpZWQgdG8gdGhlIEhUTUwKICBlbGVtZW50LiBXaGVuIGxlZnQgdW5xdW90ZWQsIHRoZXNlIHZhbHVlcyB3aWxsIGJlIGJvdW5kIHRvIGEgcHJvcGVydHkgb24gdGhlCiAgdGVtcGxhdGUncyBjdXJyZW50IHJlbmRlcmluZyBjb250ZXh0IChtb3N0IHR5cGljYWxseSBhIGNvbnRyb2xsZXIgaW5zdGFuY2UpLgoKICAjIyBVbmJvdW5kOgoKICBgYGBoYW5kbGViYXJzCiAge3tpbnB1dCB2YWx1ZT0iaHR0cDovL3d3dy5mYWNlYm9vay5jb20ifX0KICBgYGAKCgogIGBgYGh0bWwKICA8aW5wdXQgdHlwZT0idGV4dCIgdmFsdWU9Imh0dHA6Ly93d3cuZmFjZWJvb2suY29tIi8+CiAgYGBgCgogICMjIEJvdW5kOgoKICBgYGBqYXZhc2NyaXB0CiAgQXBwLkFwcGxpY2F0aW9uQ29udHJvbGxlciA9IEVtYmVyLkNvbnRyb2xsZXIuZXh0ZW5kKHsKICAgIGZpcnN0TmFtZTogIlN0YW5sZXkiLAogICAgZW50cnlOb3RBbGxvd2VkOiB0cnVlCiAgfSk7CiAgYGBgCgoKICBgYGBoYW5kbGViYXJzCiAge3tpbnB1dCB0eXBlPSJ0ZXh0IiB2YWx1ZT1maXJzdE5hbWUgZGlzYWJsZWQ9ZW50cnlOb3RBbGxvd2VkIHNpemU9IjUwIn19CiAgYGBgCgoKICBgYGBodG1sCiAgPGlucHV0IHR5cGU9InRleHQiIHZhbHVlPSJTdGFubGV5IiBkaXNhYmxlZD0iZGlzYWJsZWQiIHNpemU9IjUwIi8+CiAgYGBgCgogICMjIEV4dGVuc2lvbgoKICBJbnRlcm5hbGx5LCBge3tpbnB1dCB0eXBlPSJ0ZXh0In19YCBjcmVhdGVzIGFuIGluc3RhbmNlIG9mIGBFbWJlci5UZXh0RmllbGRgLCBwYXNzaW5nCiAgYXJndW1lbnRzIGZyb20gdGhlIGhlbHBlciB0byBgRW1iZXIuVGV4dEZpZWxkYCdzIGBjcmVhdGVgIG1ldGhvZC4gWW91IGNhbiBleHRlbmQgdGhlCiAgY2FwYWJsaWx0aWVzIG9mIHRleHQgaW5wdXRzIGluIHlvdXIgYXBwbGljYXRpb25zIGJ5IHJlb3BlbmluZyB0aGlzIGNsYXNzLiBGb3IgZXhhbXBsZSwKICBpZiB5b3UgYXJlIGRlcGxveWluZyB0byBicm93c2VycyB3aGVyZSB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgaXMgdXNlZCwgeW91CiAgY2FuIGFkZCB0aGlzIHRvIHRoZSBgVGV4dEZpZWxkYCdzIGBhdHRyaWJ1dGVCaW5kaW5nc2AgcHJvcGVydHk6CgoKICBgYGBqYXZhc2NyaXB0CiAgRW1iZXIuVGV4dEZpZWxkLnJlb3Blbih7CiAgICBhdHRyaWJ1dGVCaW5kaW5nczogWydyZXF1aXJlZCddCiAgfSk7CiAgYGBgCgogIEtlZXAgaW4gbWluZCB3aGVuIHdyaXRpbmcgYEVtYmVyLlRleHRGaWVsZGAgc3ViY2xhc3NlcyB0aGF0IGBFbWJlci5UZXh0RmllbGRgCiAgaXRzZWxmIGV4dGVuZHMgYEVtYmVyLkNvbXBvbmVudGAsIG1lYW5pbmcgdGhhdCBpdCBkb2VzIE5PVCBpbmhlcml0CiAgdGhlIGBjb250cm9sbGVyYCBvZiB0aGUgcGFyZW50IHZpZXcuCgogIFNlZSBtb3JlIGFib3V0IFtFbWJlciBjb21wb25lbnRzXShhcGkvY2xhc3Nlcy9FbWJlci5Db21wb25lbnQuaHRtbCkKCgogICMjIFVzZSBhcyBjaGVja2JveAoKICBBbiBge3tpbnB1dH19YCB3aXRoIGEgYHR5cGVgIG9mIGBjaGVja2JveGAgd2lsbCByZW5kZXIgYW4gSFRNTCBjaGVja2JveCBpbnB1dC4KICBUaGUgZm9sbG93aW5nIEhUTUwgYXR0cmlidXRlcyBjYW4gYmUgc2V0IHZpYSB0aGUgaGVscGVyOgoKKiBgY2hlY2tlZGAKKiBgZGlzYWJsZWRgCiogYHRhYmluZGV4YAoqIGBpbmRldGVybWluYXRlYAoqIGBuYW1lYAoKCiAgV2hlbiBzZXQgdG8gYSBxdW90ZWQgc3RyaW5nLCB0aGVzZSB2YWx1ZXMgd2lsbCBiZSBkaXJlY3RseSBhcHBsaWVkIHRvIHRoZSBIVE1MCiAgZWxlbWVudC4gV2hlbiBsZWZ0IHVucXVvdGVkLCB0aGVzZSB2YWx1ZXMgd2lsbCBiZSBib3VuZCB0byBhIHByb3BlcnR5IG9uIHRoZQogIHRlbXBsYXRlJ3MgY3VycmVudCByZW5kZXJpbmcgY29udGV4dCAobW9zdCB0eXBpY2FsbHkgYSBjb250cm9sbGVyIGluc3RhbmNlKS4KCiAgIyMgVW5ib3VuZDoKCiAgYGBgaGFuZGxlYmFycwogIHt7aW5wdXQgdHlwZT0iY2hlY2tib3giIG5hbWU9ImlzQWRtaW4ifX0KICBgYGAKCiAgYGBgaHRtbAogIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmFtZT0iaXNBZG1pbiIgLz4KICBgYGAKCiAgIyMgQm91bmQ6CgogIGBgYGphdmFzY3JpcHQKICBBcHAuQXBwbGljYXRpb25Db250cm9sbGVyID0gRW1iZXIuQ29udHJvbGxlci5leHRlbmQoewogICAgaXNBZG1pbjogdHJ1ZQogIH0pOwogIGBgYAoKCiAgYGBgaGFuZGxlYmFycwogIHt7aW5wdXQgdHlwZT0iY2hlY2tib3giIGNoZWNrZWQ9aXNBZG1pbiB9fQogIGBgYAoKCiAgYGBgaHRtbAogIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgY2hlY2tlZD0iY2hlY2tlZCIgLz4KICBgYGAKCiAgIyMgRXh0ZW5zaW9uCgogIEludGVybmFsbHksIGB7e2lucHV0IHR5cGU9ImNoZWNrYm94In19YCBjcmVhdGVzIGFuIGluc3RhbmNlIG9mIGBFbWJlci5DaGVja2JveGAsIHBhc3NpbmcKICBhcmd1bWVudHMgZnJvbSB0aGUgaGVscGVyIHRvIGBFbWJlci5DaGVja2JveGAncyBgY3JlYXRlYCBtZXRob2QuIFlvdSBjYW4gZXh0ZW5kIHRoZQogIGNhcGFibGlsdGllcyBvZiBjaGVja2JveCBpbnB1dHMgaW4geW91ciBhcHBsaWNhdGlvbnMgYnkgcmVvcGVuaW5nIHRoaXMgY2xhc3MuIEZvciBleGFtcGxlLAogIGlmIHlvdSB3YW50ZWQgdG8gYWRkIGEgY3NzIGNsYXNzIHRvIGFsbCBjaGVja2JveGVzIGluIHlvdXIgYXBwbGljYXRpb246CgoKICBgYGBqYXZhc2NyaXB0CiAgRW1iZXIuQ2hlY2tib3gucmVvcGVuKHsKICAgIGNsYXNzTmFtZXM6IFsnbXktYXBwLWNoZWNrYm94J10KICB9KTsKICBgYGAKCgogIEBtZXRob2QgaW5wdXQKICBAZm9yIEVtYmVyLkhhbmRsZWJhcnMuaGVscGVycwogIEBwYXJhbSB7SGFzaH0gb3B0aW9ucwoqLwpFbWJlci5IYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpbnB1dCcsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICBFbWJlci5hc3NlcnQoJ1lvdSBjYW4gb25seSBwYXNzIGF0dHJpYnV0ZXMgdG8gdGhlIGBpbnB1dGAgaGVscGVyLCBub3QgYXJndW1lbnRzJywgYXJndW1lbnRzLmxlbmd0aCA8IDIpOwoKICB2YXIgaGFzaCA9IG9wdGlvbnMuaGFzaCwKICAgICAgdHlwZXMgPSBvcHRpb25zLmhhc2hUeXBlcywKICAgICAgaW5wdXRUeXBlID0gaGFzaC50eXBlLAogICAgICBvbkV2ZW50ID0gaGFzaC5vbjsKCiAgZGVsZXRlIGhhc2gudHlwZTsKICBkZWxldGUgaGFzaC5vbjsKCiAgaWYgKGlucHV0VHlwZSA9PT0gJ2NoZWNrYm94JykgewogICAgcmV0dXJuIEVtYmVyLkhhbmRsZWJhcnMuaGVscGVycy52aWV3LmNhbGwodGhpcywgRW1iZXIuQ2hlY2tib3gsIG9wdGlvbnMpOwogIH0gZWxzZSB7CiAgICBpZiAoaW5wdXRUeXBlKSB7IGhhc2gudHlwZSA9IGlucHV0VHlwZTsgfQogICAgaGFzaC5vbkV2ZW50ID0gb25FdmVudCB8fCAnZW50ZXInOwogICAgcmV0dXJuIEVtYmVyLkhhbmRsZWJhcnMuaGVscGVycy52aWV3LmNhbGwodGhpcywgRW1iZXIuVGV4dEZpZWxkLCBvcHRpb25zKTsKICB9Cn0pOwoKLyoqCiAgYHt7dGV4dGFyZWF9fWAgaW5zZXJ0cyBhIG5ldyBpbnN0YW5jZSBvZiBgPHRleHRhcmVhPmAgdGFnIGludG8gdGhlIHRlbXBsYXRlLgogIFRoZSBhdHRyaWJ1dGVzIG9mIGB7e3RleHRhcmVhfX1gIG1hdGNoIHRob3NlIG9mIHRoZSBuYXRpdmUgSFRNTCB0YWdzIGFzCiAgY2xvc2VseSBhcyBwb3NzaWJsZS4KCiAgVGhlIGZvbGxvd2luZyBIVE1MIGF0dHJpYnV0ZXMgY2FuIGJlIHNldDoKCiAgICAqIGB2YWx1ZWAKICAgICogYG5hbWVgCiAgICAqIGByb3dzYAogICAgKiBgY29sc2AKICAgICogYHBsYWNlaG9sZGVyYAogICAgKiBgZGlzYWJsZWRgCiAgICAqIGBtYXhsZW5ndGhgCiAgICAqIGB0YWJpbmRleGAKCiAgV2hlbiBzZXQgdG8gYSBxdW90ZWQgc3RyaW5nLCB0aGVzZSB2YWx1ZSB3aWxsIGJlIGRpcmVjdGx5IGFwcGxpZWQgdG8gdGhlIEhUTUwKICBlbGVtZW50LiBXaGVuIGxlZnQgdW5xdW90ZWQsIHRoZXNlIHZhbHVlcyB3aWxsIGJlIGJvdW5kIHRvIGEgcHJvcGVydHkgb24gdGhlCiAgdGVtcGxhdGUncyBjdXJyZW50IHJlbmRlcmluZyBjb250ZXh0IChtb3N0IHR5cGljYWxseSBhIGNvbnRyb2xsZXIgaW5zdGFuY2UpLgoKICBVbmJvdW5kOgoKICBgYGBoYW5kbGViYXJzCiAge3t0ZXh0YXJlYSB2YWx1ZT0iTG90cyBvZiBzdGF0aWMgdGV4dCB0aGF0IElTTidUIGJvdW5kIn19CiAgYGBgCgogIFdvdWxkIHJlc3VsdCBpbiB0aGUgZm9sbG93aW5nIEhUTUw6CgogIGBgYGh0bWwKICA8dGV4dGFyZWEgY2xhc3M9ImVtYmVyLXRleHQtYXJlYSI+CiAgICBMb3RzIG9mIHN0YXRpYyB0ZXh0IHRoYXQgSVNOJ1QgYm91bmQKICA8L3RleHRhcmVhPgogIGBgYAoKICBCb3VuZDoKCiAgSW4gdGhlIGZvbGxvd2luZyBleGFtcGxlLCB0aGUgYHdyaXR0ZW5Xb3Jkc2AgcHJvcGVydHkgb24gYEFwcC5BcHBsaWNhdGlvbkNvbnRyb2xsZXJgCiAgd2lsbCBiZSB1cGRhdGVkIGxpdmUgYXMgdGhlIHVzZXIgdHlwZXMgJ0xvdHMgb2YgdGV4dCB0aGF0IElTIGJvdW5kJyBpbnRvCiAgdGhlIHRleHQgYXJlYSBvZiB0aGVpciBicm93c2VyJ3Mgd2luZG93LgoKICBgYGBqYXZhc2NyaXB0CiAgQXBwLkFwcGxpY2F0aW9uQ29udHJvbGxlciA9IEVtYmVyLkNvbnRyb2xsZXIuZXh0ZW5kKHsKICAgIHdyaXR0ZW5Xb3JkczogIkxvdHMgb2YgdGV4dCB0aGF0IElTIGJvdW5kIgogIH0pOwogIGBgYAoKICBgYGBoYW5kbGViYXJzCiAge3t0ZXh0YXJlYSB2YWx1ZT13cml0dGVuV29yZHN9fQogIGBgYAoKICAgV291bGQgcmVzdWx0IGluIHRoZSBmb2xsb3dpbmcgSFRNTDoKCiAgYGBgaHRtbAogIDx0ZXh0YXJlYSBjbGFzcz0iZW1iZXItdGV4dC1hcmVhIj4KICAgIExvdHMgb2YgdGV4dCB0aGF0IElTIGJvdW5kCiAgPC90ZXh0YXJlYT4KICBgYGAKCiAgSWYgeW91IHdhbnRlZCBhIG9uZSB3YXkgYmluZGluZyBiZXR3ZWVuIHRoZSB0ZXh0IGFyZWEgYW5kIGEgZGl2IHRhZwogIHNvbWV3aGVyZSBlbHNlIG9uIHlvdXIgc2NyZWVuLCB5b3UgY291bGQgdXNlIGBFbWJlci5jb21wdXRlZC5vbmVXYXlgOgoKICBgYGBqYXZhc2NyaXB0CiAgQXBwLkFwcGxpY2F0aW9uQ29udHJvbGxlciA9IEVtYmVyLkNvbnRyb2xsZXIuZXh0ZW5kKHsKICAgIHdyaXR0ZW5Xb3JkczogIkxvdHMgb2YgdGV4dCB0aGF0IElTIGJvdW5kIiwKICAgIG91dHB1dFdyaXR0ZW5Xb3JkczogRW1iZXIuY29tcHV0ZWQub25lV2F5KCJ3cml0dGVuV29yZHMiKQogIH0pOwogIGBgYAoKICBgYGBoYW5kbGViYXJzCiAge3t0ZXh0YXJlYSB2YWx1ZT13cml0dGVuV29yZHN9fQoKICA8ZGl2PgogICAge3tvdXRwdXRXcml0dGVuV29yZHN9fQogIDwvZGl2PgogIGBgYAoKICBXb3VsZCByZXN1bHQgaW4gdGhlIGZvbGxvd2luZyBIVE1MOgoKICBgYGBodG1sCiAgPHRleHRhcmVhIGNsYXNzPSJlbWJlci10ZXh0LWFyZWEiPgogICAgTG90cyBvZiB0ZXh0IHRoYXQgSVMgYm91bmQKICA8L3RleHRhcmVhPgoKICA8LS0gdGhlIGZvbGxvd2luZyBkaXYgd2lsbCBiZSB1cGRhdGVkIGluIHJlYWwgdGltZSBhcyB5b3UgdHlwZSAtLT4KCiAgPGRpdj4KICAgIExvdHMgb2YgdGV4dCB0aGF0IElTIGJvdW5kCiAgPC9kaXY+CiAgYGBgCgogIEZpbmFsbHksIHRoaXMgZXhhbXBsZSByZWFsbHkgc2hvd3MgdGhlIHBvd2VyIGFuZCBlYXNlIG9mIEVtYmVyIHdoZW4gdHdvCiAgcHJvcGVydGllcyBhcmUgYm91bmQgdG8gZWFjaG90aGVyIHZpYSBgRW1iZXIuY29tcHV0ZWQuYWxpYXNgLiBUeXBlIGludG8KICBlaXRoZXIgdGV4dCBhcmVhIGJveCBhbmQgdGhleSdsbCBib3RoIHN0YXkgaW4gc3luYy4gTm90ZSB0aGF0CiAgYEVtYmVyLmNvbXB1dGVkLmFsaWFzYCBjb3N0cyBtb3JlIGluIHRlcm1zIG9mIHBlcmZvcm1hbmNlLCBzbyBvbmx5IHVzZSBpdCB3aGVuCiAgeW91ciByZWFsbHkgYmluZGluZyBpbiBib3RoIGRpcmVjdGlvbnM6CgogIGBgYGphdmFzY3JpcHQKICBBcHAuQXBwbGljYXRpb25Db250cm9sbGVyID0gRW1iZXIuQ29udHJvbGxlci5leHRlbmQoewogICAgd3JpdHRlbldvcmRzOiAiTG90cyBvZiB0ZXh0IHRoYXQgSVMgYm91bmQiLAogICAgdHdvV2F5V3JpdHRlbldvcmRzOiBFbWJlci5jb21wdXRlZC5hbGlhcygid3JpdHRlbldvcmRzIikKICB9KTsKICBgYGAKCiAgYGBgaGFuZGxlYmFycwogIHt7dGV4dGFyZWEgdmFsdWU9d3JpdHRlbldvcmRzfX0KICB7e3RleHRhcmVhIHZhbHVlPXR3b1dheVdyaXR0ZW5Xb3Jkc319CiAgYGBgCgogIGBgYGh0bWwKICA8dGV4dGFyZWEgaWQ9ImVtYmVyMSIgY2xhc3M9ImVtYmVyLXRleHQtYXJlYSI+CiAgICBMb3RzIG9mIHRleHQgdGhhdCBJUyBib3VuZAogIDwvdGV4dGFyZWE+CgogIDwtLSBib3RoIHVwZGF0ZWQgaW4gcmVhbCB0aW1lIC0tPgoKICA8dGV4dGFyZWEgaWQ9ImVtYmVyMiIgY2xhc3M9ImVtYmVyLXRleHQtYXJlYSI+CiAgICBMb3RzIG9mIHRleHQgdGhhdCBJUyBib3VuZAogIDwvdGV4dGFyZWE+CiAgYGBgCgogICMjIEV4dGVuc2lvbgoKICBJbnRlcm5hbGx5LCBge3t0ZXh0YXJlYX19YCBjcmVhdGVzIGFuIGluc3RhbmNlIG9mIGBFbWJlci5UZXh0QXJlYWAsIHBhc3NpbmcKICBhcmd1bWVudHMgZnJvbSB0aGUgaGVscGVyIHRvIGBFbWJlci5UZXh0QXJlYWAncyBgY3JlYXRlYCBtZXRob2QuIFlvdSBjYW4KICBleHRlbmQgdGhlIGNhcGFiaWxpdGllcyBvZiB0ZXh0IGFyZWFzIGluIHlvdXIgYXBwbGljYXRpb24gYnkgcmVvcGVuaW5nIHRoaXMKICBjbGFzcy4gRm9yIGV4YW1wbGUsIGlmIHlvdSBhcmUgZGVwbG95aW5nIHRvIGJyb3dzZXJzIHdoZXJlIHRoZSBgcmVxdWlyZWRgCiAgYXR0cmlidXRlIGlzIHVzZWQsIHlvdSBjYW4gZ2xvYmFsbHkgYWRkIHN1cHBvcnQgZm9yIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZQogIG9uIGFsbCBge3t0ZXh0YXJlYX19YHMnIGluIHlvdXIgYXBwIGJ5IHJlb3BlbmluZyBgRW1iZXIuVGV4dEFyZWFgIG9yCiAgYEVtYmVyLlRleHRTdXBwb3J0YCBhbmQgYWRkaW5nIGl0IHRvIHRoZSBgYXR0cmlidXRlQmluZGluZ3NgIGNvbmNhdGVuYXRlZAogIHByb3BlcnR5OgoKICBgYGBqYXZhc2NyaXB0CiAgRW1iZXIuVGV4dEFyZWEucmVvcGVuKHsKICAgIGF0dHJpYnV0ZUJpbmRpbmdzOiBbJ3JlcXVpcmVkJ10KICB9KTsKICBgYGAKCiAgS2VlcCBpbiBtaW5kIHdoZW4gd3JpdGluZyBgRW1iZXIuVGV4dEFyZWFgIHN1YmNsYXNzZXMgdGhhdCBgRW1iZXIuVGV4dEFyZWFgCiAgaXRzZWxmIGV4dGVuZHMgYEVtYmVyLkNvbXBvbmVudGAsIG1lYW5pbmcgdGhhdCBpdCBkb2VzIE5PVCBpbmhlcml0CiAgdGhlIGBjb250cm9sbGVyYCBvZiB0aGUgcGFyZW50IHZpZXcuCgogIFNlZSBtb3JlIGFib3V0IFtFbWJlciBjb21wb25lbnRzXShhcGkvY2xhc3Nlcy9FbWJlci5Db21wb25lbnQuaHRtbCkKCiAgQG1ldGhvZCB0ZXh0YXJlYQogIEBmb3IgRW1iZXIuSGFuZGxlYmFycy5oZWxwZXJzCiAgQHBhcmFtIHtIYXNofSBvcHRpb25zCiovCkVtYmVyLkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3RleHRhcmVhJywgZnVuY3Rpb24ob3B0aW9ucykgewogIEVtYmVyLmFzc2VydCgnWW91IGNhbiBvbmx5IHBhc3MgYXR0cmlidXRlcyB0byB0aGUgYHRleHRhcmVhYCBoZWxwZXIsIG5vdCBhcmd1bWVudHMnLCBhcmd1bWVudHMubGVuZ3RoIDwgMik7CgogIHZhciBoYXNoID0gb3B0aW9ucy5oYXNoLAogICAgICB0eXBlcyA9IG9wdGlvbnMuaGFzaFR5cGVzOwoKICByZXR1cm4gRW1iZXIuSGFuZGxlYmFycy5oZWxwZXJzLnZpZXcuY2FsbCh0aGlzLCBFbWJlci5UZXh0QXJlYSwgb3B0aW9ucyk7Cn0pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewpFbWJlci5Db21wb25lbnRMb29rdXAgPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICBsb29rdXBGYWN0b3J5OiBmdW5jdGlvbihuYW1lLCBjb250YWluZXIpIHsKCiAgICBjb250YWluZXIgPSBjb250YWluZXIgfHwgdGhpcy5jb250YWluZXI7CgogICAgdmFyIGZ1bGxOYW1lID0gJ2NvbXBvbmVudDonICsgbmFtZSwKICAgICAgICB0ZW1wbGF0ZUZ1bGxOYW1lID0gJ3RlbXBsYXRlOmNvbXBvbmVudHMvJyArIG5hbWUsCiAgICAgICAgdGVtcGxhdGVSZWdpc3RlcmVkID0gY29udGFpbmVyICYmIGNvbnRhaW5lci5oYXModGVtcGxhdGVGdWxsTmFtZSk7CgogICAgaWYgKHRlbXBsYXRlUmVnaXN0ZXJlZCkgewogICAgICBjb250YWluZXIuaW5qZWN0aW9uKGZ1bGxOYW1lLCAnbGF5b3V0JywgdGVtcGxhdGVGdWxsTmFtZSk7CiAgICB9CgogICAgdmFyIENvbXBvbmVudCA9IGNvbnRhaW5lci5sb29rdXBGYWN0b3J5KGZ1bGxOYW1lKTsKCiAgICAvLyBPbmx5IHRyZWF0IGFzIGEgY29tcG9uZW50IGlmIGVpdGhlciB0aGUgY29tcG9uZW50CiAgICAvLyBvciBhIHRlbXBsYXRlIGhhcyBiZWVuIHJlZ2lzdGVyZWQuCiAgICBpZiAodGVtcGxhdGVSZWdpc3RlcmVkIHx8IENvbXBvbmVudCkgewogICAgICBpZiAoIUNvbXBvbmVudCkgewogICAgICAgIGNvbnRhaW5lci5yZWdpc3RlcihmdWxsTmFtZSwgRW1iZXIuQ29tcG9uZW50KTsKICAgICAgICBDb21wb25lbnQgPSBjb250YWluZXIubG9va3VwRmFjdG9yeShmdWxsTmFtZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIENvbXBvbmVudDsKICAgIH0KICB9Cn0pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKmdsb2JhbHMgSGFuZGxlYmFycyAqLwovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLWhhbmRsZWJhcnMKKi8KCi8qKgogIEZpbmQgdGVtcGxhdGVzIHN0b3JlZCBpbiB0aGUgaGVhZCB0YWcgYXMgc2NyaXB0IHRhZ3MgYW5kIG1ha2UgdGhlbSBhdmFpbGFibGUKICB0byBgRW1iZXIuQ29yZVZpZXdgIGluIHRoZSBnbG9iYWwgYEVtYmVyLlRFTVBMQVRFU2Agb2JqZWN0LiBUaGlzIHdpbGwgYmUgcnVuCiAgYXMgYXMgalF1ZXJ5IERPTS1yZWFkeSBjYWxsYmFjay4KCiAgU2NyaXB0IHRhZ3Mgd2l0aCBgdGV4dC94LWhhbmRsZWJhcnNgIHdpbGwgYmUgY29tcGlsZWQKICB3aXRoIEVtYmVyJ3MgSGFuZGxlYmFycyBhbmQgYXJlIHN1aXRhYmxlIGZvciB1c2UgYXMgYSB2aWV3J3MgdGVtcGxhdGUuCiAgVGhvc2Ugd2l0aCB0eXBlIGB0ZXh0L3gtcmF3LWhhbmRsZWJhcnNgIHdpbGwgYmUgY29tcGlsZWQgd2l0aCByZWd1bGFyCiAgSGFuZGxlYmFycyBhbmQgYXJlIHN1aXRhYmxlIGZvciB1c2UgaW4gdmlld3MnIGNvbXB1dGVkIHByb3BlcnRpZXMuCgogIEBwcml2YXRlCiAgQG1ldGhvZCBib290c3RyYXAKICBAZm9yIEVtYmVyLkhhbmRsZWJhcnMKICBAc3RhdGljCiAgQHBhcmFtIGN0eAoqLwpFbWJlci5IYW5kbGViYXJzLmJvb3RzdHJhcCA9IGZ1bmN0aW9uKGN0eCkgewogIHZhciBzZWxlY3RvcnMgPSAnc2NyaXB0W3R5cGU9InRleHQveC1oYW5kbGViYXJzIl0sIHNjcmlwdFt0eXBlPSJ0ZXh0L3gtcmF3LWhhbmRsZWJhcnMiXSc7CgogIEVtYmVyLiQoc2VsZWN0b3JzLCBjdHgpCiAgICAuZWFjaChmdW5jdGlvbigpIHsKICAgIC8vIEdldCBhIHJlZmVyZW5jZSB0byB0aGUgc2NyaXB0IHRhZwogICAgdmFyIHNjcmlwdCA9IEVtYmVyLiQodGhpcyk7CgogICAgdmFyIGNvbXBpbGUgPSAoc2NyaXB0LmF0dHIoJ3R5cGUnKSA9PT0gJ3RleHQveC1yYXctaGFuZGxlYmFycycpID8KICAgICAgICAgICAgICAgICAgRW1iZXIuJC5wcm94eShIYW5kbGViYXJzLmNvbXBpbGUsIEhhbmRsZWJhcnMpIDoKICAgICAgICAgICAgICAgICAgRW1iZXIuJC5wcm94eShFbWJlci5IYW5kbGViYXJzLmNvbXBpbGUsIEVtYmVyLkhhbmRsZWJhcnMpLAogICAgICAvLyBHZXQgdGhlIG5hbWUgb2YgdGhlIHNjcmlwdCwgdXNlZCBieSBFbWJlci5WaWV3J3MgdGVtcGxhdGVOYW1lIHByb3BlcnR5LgogICAgICAvLyBGaXJzdCBsb29rIGZvciBkYXRhLXRlbXBsYXRlLW5hbWUgYXR0cmlidXRlLCB0aGVuIGZhbGwgYmFjayB0byBpdHMKICAgICAgLy8gaWQgaWYgbm8gbmFtZSBpcyBmb3VuZC4KICAgICAgdGVtcGxhdGVOYW1lID0gc2NyaXB0LmF0dHIoJ2RhdGEtdGVtcGxhdGUtbmFtZScpIHx8IHNjcmlwdC5hdHRyKCdpZCcpIHx8ICdhcHBsaWNhdGlvbicsCiAgICAgIHRlbXBsYXRlID0gY29tcGlsZShzY3JpcHQuaHRtbCgpKTsKCiAgICAvLyBDaGVjayBpZiB0ZW1wbGF0ZSBvZiBzYW1lIG5hbWUgYWxyZWFkeSBleGlzdHMKICAgIGlmIChFbWJlci5URU1QTEFURVNbdGVtcGxhdGVOYW1lXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHRocm93IG5ldyBFbWJlci5FcnJvcignVGVtcGxhdGUgbmFtZWQgIicgKyB0ZW1wbGF0ZU5hbWUgICsgJyIgYWxyZWFkeSBleGlzdHMuJyk7CiAgICB9CgogICAgLy8gRm9yIHRlbXBsYXRlcyB3aGljaCBoYXZlIGEgbmFtZSwgd2Ugc2F2ZSB0aGVtIGFuZCB0aGVuIHJlbW92ZSB0aGVtIGZyb20gdGhlIERPTQogICAgRW1iZXIuVEVNUExBVEVTW3RlbXBsYXRlTmFtZV0gPSB0ZW1wbGF0ZTsKCiAgICAvLyBSZW1vdmUgc2NyaXB0IHRhZyBmcm9tIERPTQogICAgc2NyaXB0LnJlbW92ZSgpOwogIH0pOwp9OwoKZnVuY3Rpb24gYm9vdHN0cmFwKCkgewogIEVtYmVyLkhhbmRsZWJhcnMuYm9vdHN0cmFwKCBFbWJlci4kKGRvY3VtZW50KSApOwp9CgpmdW5jdGlvbiByZWdpc3RlckNvbXBvbmVudExvb2t1cChjb250YWluZXIpIHsKICBjb250YWluZXIucmVnaXN0ZXIoJ2NvbXBvbmVudC1sb29rdXA6bWFpbicsIEVtYmVyLkNvbXBvbmVudExvb2t1cCk7Cn0KCi8qCiAgV2UgdGllIHRoaXMgdG8gYXBwbGljYXRpb24ubG9hZCB0byBlbnN1cmUgdGhhdCB3ZSd2ZSBhdCBsZWFzdAogIGF0dGVtcHRlZCB0byBib290c3RyYXAgYXQgdGhlIHBvaW50IHRoYXQgdGhlIGFwcGxpY2F0aW9uIGlzIGxvYWRlZC4KCiAgV2UgYWxzbyB0aWUgdGhpcyB0byBkb2N1bWVudCByZWFkeSBzaW5jZSB3ZSdyZSBndWFyYW50ZWVkIHRoYXQgYWxsCiAgdGhlIGlubGluZSB0ZW1wbGF0ZXMgYXJlIHByZXNlbnQgYXQgdGhpcyBwb2ludC4KCiAgVGhlcmUncyBubyBoYXJtIHRvIHJ1bm5pbmcgdGhpcyB0d2ljZSwgc2luY2Ugd2UgcmVtb3ZlIHRoZSB0ZW1wbGF0ZXMKICBmcm9tIHRoZSBET00gYWZ0ZXIgcHJvY2Vzc2luZy4KKi8KCkVtYmVyLm9uTG9hZCgnRW1iZXIuQXBwbGljYXRpb24nLCBmdW5jdGlvbihBcHBsaWNhdGlvbikgewogIEFwcGxpY2F0aW9uLmluaXRpYWxpemVyKHsKICAgIG5hbWU6ICdkb21UZW1wbGF0ZXMnLAogICAgaW5pdGlhbGl6ZTogYm9vdHN0cmFwCiAgfSk7CgogIEFwcGxpY2F0aW9uLmluaXRpYWxpemVyKHsKICAgIG5hbWU6ICdyZWdpc3RlckNvbXBvbmVudExvb2t1cCcsCiAgICBhZnRlcjogJ2RvbVRlbXBsYXRlcycsCiAgICBpbml0aWFsaXplOiByZWdpc3RlckNvbXBvbmVudExvb2t1cAogIH0pOwp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkVtYmVyIEhhbmRsZWJhcnMKCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1oYW5kbGViYXJzCkByZXF1aXJlcyBlbWJlci12aWV3cwoqLwoKRW1iZXIucnVuTG9hZEhvb2tzKCdFbWJlci5IYW5kbGViYXJzJywgRW1iZXIuSGFuZGxlYmFycyk7Cgp9KSgpOwoKKGZ1bmN0aW9uKCkgewpkZWZpbmUoInJvdXRlLXJlY29nbml6ZXIiLAogIFtdLAogIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIHNwZWNpYWxzID0gWwogICAgICAnLycsICcuJywgJyonLCAnKycsICc/JywgJ3wnLAogICAgICAnKCcsICcpJywgJ1snLCAnXScsICd7JywgJ30nLCAnXFwnCiAgICBdOwoKICAgIHZhciBlc2NhcGVSZWdleCA9IG5ldyBSZWdFeHAoJyhcXCcgKyBzcGVjaWFscy5qb2luKCd8XFwnKSArICcpJywgJ2cnKTsKCiAgICAvLyBBIFNlZ21lbnQgcmVwcmVzZW50cyBhIHNlZ21lbnQgaW4gdGhlIG9yaWdpbmFsIHJvdXRlIGRlc2NyaXB0aW9uLgogICAgLy8gRWFjaCBTZWdtZW50IHR5cGUgcHJvdmlkZXMgYW4gYGVhY2hDaGFyYCBhbmQgYHJlZ2V4YCBtZXRob2QuCiAgICAvLwogICAgLy8gVGhlIGBlYWNoQ2hhcmAgbWV0aG9kIGludm9rZXMgdGhlIGNhbGxiYWNrIHdpdGggb25lIG9yIG1vcmUgY2hhcmFjdGVyCiAgICAvLyBzcGVjaWZpY2F0aW9ucy4gQSBjaGFyYWN0ZXIgc3BlY2lmaWNhdGlvbiBjb25zdW1lcyBvbmUgb3IgbW9yZSBpbnB1dAogICAgLy8gY2hhcmFjdGVycy4KICAgIC8vCiAgICAvLyBUaGUgYHJlZ2V4YCBtZXRob2QgcmV0dXJucyBhIHJlZ2V4IGZyYWdtZW50IGZvciB0aGUgc2VnbWVudC4gSWYgdGhlCiAgICAvLyBzZWdtZW50IGlzIGEgZHluYW1pYyBvZiBzdGFyIHNlZ21lbnQsIHRoZSByZWdleCBmcmFnbWVudCBhbHNvIGluY2x1ZGVzCiAgICAvLyBhIGNhcHR1cmUuCiAgICAvLwogICAgLy8gQSBjaGFyYWN0ZXIgc3BlY2lmaWNhdGlvbiBjb250YWluczoKICAgIC8vCiAgICAvLyAqIGB2YWxpZENoYXJzYDogYSBTdHJpbmcgd2l0aCBhIGxpc3Qgb2YgYWxsIHZhbGlkIGNoYXJhY3RlcnMsIG9yCiAgICAvLyAqIGBpbnZhbGlkQ2hhcnNgOiBhIFN0cmluZyB3aXRoIGEgbGlzdCBvZiBhbGwgaW52YWxpZCBjaGFyYWN0ZXJzCiAgICAvLyAqIGByZXBlYXRgOiB0cnVlIGlmIHRoZSBjaGFyYWN0ZXIgc3BlY2lmaWNhdGlvbiBjYW4gcmVwZWF0CgogICAgZnVuY3Rpb24gU3RhdGljU2VnbWVudChzdHJpbmcpIHsgdGhpcy5zdHJpbmcgPSBzdHJpbmc7IH0KICAgIFN0YXRpY1NlZ21lbnQucHJvdG90eXBlID0gewogICAgICBlYWNoQ2hhcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICB2YXIgc3RyaW5nID0gdGhpcy5zdHJpbmcsIGNoYXI7CgogICAgICAgIGZvciAodmFyIGk9MCwgbD1zdHJpbmcubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgICAgY2hhciA9IHN0cmluZy5jaGFyQXQoaSk7CiAgICAgICAgICBjYWxsYmFjayh7IHZhbGlkQ2hhcnM6IGNoYXIgfSk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgcmVnZXg6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnN0cmluZy5yZXBsYWNlKGVzY2FwZVJlZ2V4LCAnXFwkMScpOwogICAgICB9LAoKICAgICAgZ2VuZXJhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnN0cmluZzsKICAgICAgfQogICAgfTsKCiAgICBmdW5jdGlvbiBEeW5hbWljU2VnbWVudChuYW1lKSB7IHRoaXMubmFtZSA9IG5hbWU7IH0KICAgIER5bmFtaWNTZWdtZW50LnByb3RvdHlwZSA9IHsKICAgICAgZWFjaENoYXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgY2FsbGJhY2soeyBpbnZhbGlkQ2hhcnM6ICIvIiwgcmVwZWF0OiB0cnVlIH0pOwogICAgICB9LAoKICAgICAgcmVnZXg6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiAiKFteL10rKSI7CiAgICAgIH0sCgogICAgICBnZW5lcmF0ZTogZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgICAgcmV0dXJuIHBhcmFtc1t0aGlzLm5hbWVdOwogICAgICB9CiAgICB9OwoKICAgIGZ1bmN0aW9uIFN0YXJTZWdtZW50KG5hbWUpIHsgdGhpcy5uYW1lID0gbmFtZTsgfQogICAgU3RhclNlZ21lbnQucHJvdG90eXBlID0gewogICAgICBlYWNoQ2hhcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICBjYWxsYmFjayh7IGludmFsaWRDaGFyczogIiIsIHJlcGVhdDogdHJ1ZSB9KTsKICAgICAgfSwKCiAgICAgIHJlZ2V4OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gIiguKykiOwogICAgICB9LAoKICAgICAgZ2VuZXJhdGU6IGZ1bmN0aW9uKHBhcmFtcykgewogICAgICAgIHJldHVybiBwYXJhbXNbdGhpcy5uYW1lXTsKICAgICAgfQogICAgfTsKCiAgICBmdW5jdGlvbiBFcHNpbG9uU2VnbWVudCgpIHt9CiAgICBFcHNpbG9uU2VnbWVudC5wcm90b3R5cGUgPSB7CiAgICAgIGVhY2hDaGFyOiBmdW5jdGlvbigpIHt9LAogICAgICByZWdleDogZnVuY3Rpb24oKSB7IHJldHVybiAiIjsgfSwKICAgICAgZ2VuZXJhdGU6IGZ1bmN0aW9uKCkgeyByZXR1cm4gIiI7IH0KICAgIH07CgogICAgZnVuY3Rpb24gcGFyc2Uocm91dGUsIG5hbWVzLCB0eXBlcykgewogICAgICAvLyBub3JtYWxpemUgcm91dGUgYXMgbm90IHN0YXJ0aW5nIHdpdGggYSAiLyIuIFJlY29nbml0aW9uIHdpbGwKICAgICAgLy8gYWxzbyBub3JtYWxpemUuCiAgICAgIGlmIChyb3V0ZS5jaGFyQXQoMCkgPT09ICIvIikgeyByb3V0ZSA9IHJvdXRlLnN1YnN0cigxKTsgfQoKICAgICAgdmFyIHNlZ21lbnRzID0gcm91dGUuc3BsaXQoIi8iKSwgcmVzdWx0cyA9IFtdOwoKICAgICAgZm9yICh2YXIgaT0wLCBsPXNlZ21lbnRzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICB2YXIgc2VnbWVudCA9IHNlZ21lbnRzW2ldLCBtYXRjaDsKCiAgICAgICAgaWYgKG1hdGNoID0gc2VnbWVudC5tYXRjaCgvXjooW15cL10rKSQvKSkgewogICAgICAgICAgcmVzdWx0cy5wdXNoKG5ldyBEeW5hbWljU2VnbWVudChtYXRjaFsxXSkpOwogICAgICAgICAgbmFtZXMucHVzaChtYXRjaFsxXSk7CiAgICAgICAgICB0eXBlcy5keW5hbWljcysrOwogICAgICAgIH0gZWxzZSBpZiAobWF0Y2ggPSBzZWdtZW50Lm1hdGNoKC9eXCooW15cL10rKSQvKSkgewogICAgICAgICAgcmVzdWx0cy5wdXNoKG5ldyBTdGFyU2VnbWVudChtYXRjaFsxXSkpOwogICAgICAgICAgbmFtZXMucHVzaChtYXRjaFsxXSk7CiAgICAgICAgICB0eXBlcy5zdGFycysrOwogICAgICAgIH0gZWxzZSBpZihzZWdtZW50ID09PSAiIikgewogICAgICAgICAgcmVzdWx0cy5wdXNoKG5ldyBFcHNpbG9uU2VnbWVudCgpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0cy5wdXNoKG5ldyBTdGF0aWNTZWdtZW50KHNlZ21lbnQpKTsKICAgICAgICAgIHR5cGVzLnN0YXRpY3MrKzsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiByZXN1bHRzOwogICAgfQoKICAgIC8vIEEgU3RhdGUgaGFzIGEgY2hhcmFjdGVyIHNwZWNpZmljYXRpb24gYW5kIChgY2hhclNwZWNgKSBhbmQgYSBsaXN0IG9mIHBvc3NpYmxlCiAgICAvLyBzdWJzZXF1ZW50IHN0YXRlcyAoYG5leHRTdGF0ZXNgKS4KICAgIC8vCiAgICAvLyBJZiBhIFN0YXRlIGlzIGFuIGFjY2VwdGluZyBzdGF0ZSwgaXQgd2lsbCBhbHNvIGhhdmUgc2V2ZXJhbCBhZGRpdGlvbmFsCiAgICAvLyBwcm9wZXJ0aWVzOgogICAgLy8KICAgIC8vICogYHJlZ2V4YDogQSByZWd1bGFyIGV4cHJlc3Npb24gdGhhdCBpcyB1c2VkIHRvIGV4dHJhY3QgcGFyYW1ldGVycyBmcm9tIHBhdGhzCiAgICAvLyAgIHRoYXQgcmVhY2hlZCB0aGlzIGFjY2VwdGluZyBzdGF0ZS4KICAgIC8vICogYGhhbmRsZXJzYDogSW5mb3JtYXRpb24gb24gaG93IHRvIGNvbnZlcnQgdGhlIGxpc3Qgb2YgY2FwdHVyZXMgaW50byBjYWxscwogICAgLy8gICB0byByZWdpc3RlcmVkIGhhbmRsZXJzIHdpdGggdGhlIHNwZWNpZmllZCBwYXJhbWV0ZXJzCiAgICAvLyAqIGB0eXBlc2A6IEhvdyBtYW55IHN0YXRpYywgZHluYW1pYyBvciBzdGFyIHNlZ21lbnRzIGluIHRoaXMgcm91dGUuIFVzZWQgdG8KICAgIC8vICAgZGVjaWRlIHdoaWNoIHJvdXRlIHRvIHVzZSBpZiBtdWx0aXBsZSByZWdpc3RlcmVkIHJvdXRlcyBtYXRjaCBhIHBhdGguCiAgICAvLwogICAgLy8gQ3VycmVudGx5LCBTdGF0ZSBpcyBpbXBsZW1lbnRlZCBuYWl2ZWx5IGJ5IGxvb3Bpbmcgb3ZlciBgbmV4dFN0YXRlc2AgYW5kCiAgICAvLyBjb21wYXJpbmcgYSBjaGFyYWN0ZXIgc3BlY2lmaWNhdGlvbiBhZ2FpbnN0IGEgY2hhcmFjdGVyLiBBIG1vcmUgZWZmaWNpZW50CiAgICAvLyBpbXBsZW1lbnRhdGlvbiB3b3VsZCB1c2UgYSBoYXNoIG9mIGtleXMgcG9pbnRpbmcgYXQgb25lIG9yIG1vcmUgbmV4dCBzdGF0ZXMuCgogICAgZnVuY3Rpb24gU3RhdGUoY2hhclNwZWMpIHsKICAgICAgdGhpcy5jaGFyU3BlYyA9IGNoYXJTcGVjOwogICAgICB0aGlzLm5leHRTdGF0ZXMgPSBbXTsKICAgIH0KCiAgICBTdGF0ZS5wcm90b3R5cGUgPSB7CiAgICAgIGdldDogZnVuY3Rpb24oY2hhclNwZWMpIHsKICAgICAgICB2YXIgbmV4dFN0YXRlcyA9IHRoaXMubmV4dFN0YXRlczsKCiAgICAgICAgZm9yICh2YXIgaT0wLCBsPW5leHRTdGF0ZXMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgICAgdmFyIGNoaWxkID0gbmV4dFN0YXRlc1tpXTsKCiAgICAgICAgICB2YXIgaXNFcXVhbCA9IGNoaWxkLmNoYXJTcGVjLnZhbGlkQ2hhcnMgPT09IGNoYXJTcGVjLnZhbGlkQ2hhcnM7CiAgICAgICAgICBpc0VxdWFsID0gaXNFcXVhbCAmJiBjaGlsZC5jaGFyU3BlYy5pbnZhbGlkQ2hhcnMgPT09IGNoYXJTcGVjLmludmFsaWRDaGFyczsKCiAgICAgICAgICBpZiAoaXNFcXVhbCkgeyByZXR1cm4gY2hpbGQ7IH0KICAgICAgICB9CiAgICAgIH0sCgogICAgICBwdXQ6IGZ1bmN0aW9uKGNoYXJTcGVjKSB7CiAgICAgICAgdmFyIHN0YXRlOwoKICAgICAgICAvLyBJZiB0aGUgY2hhcmFjdGVyIHNwZWNpZmljYXRpb24gYWxyZWFkeSBleGlzdHMgaW4gYSBjaGlsZCBvZiB0aGUgY3VycmVudAogICAgICAgIC8vIHN0YXRlLCBqdXN0IHJldHVybiB0aGF0IHN0YXRlLgogICAgICAgIGlmIChzdGF0ZSA9IHRoaXMuZ2V0KGNoYXJTcGVjKSkgeyByZXR1cm4gc3RhdGU7IH0KCiAgICAgICAgLy8gTWFrZSBhIG5ldyBzdGF0ZSBmb3IgdGhlIGNoYXJhY3RlciBzcGVjCiAgICAgICAgc3RhdGUgPSBuZXcgU3RhdGUoY2hhclNwZWMpOwoKICAgICAgICAvLyBJbnNlcnQgdGhlIG5ldyBzdGF0ZSBhcyBhIGNoaWxkIG9mIHRoZSBjdXJyZW50IHN0YXRlCiAgICAgICAgdGhpcy5uZXh0U3RhdGVzLnB1c2goc3RhdGUpOwoKICAgICAgICAvLyBJZiB0aGlzIGNoYXJhY3RlciBzcGVjaWZpY2F0aW9uIHJlcGVhdHMsIGluc2VydCB0aGUgbmV3IHN0YXRlIGFzIGEgY2hpbGQKICAgICAgICAvLyBvZiBpdHNlbGYuIE5vdGUgdGhhdCB0aGlzIHdpbGwgbm90IHRyaWdnZXIgYW4gaW5maW5pdGUgbG9vcCBiZWNhdXNlIGVhY2gKICAgICAgICAvLyB0cmFuc2l0aW9uIGR1cmluZyByZWNvZ25pdGlvbiBjb25zdW1lcyBhIGNoYXJhY3Rlci4KICAgICAgICBpZiAoY2hhclNwZWMucmVwZWF0KSB7CiAgICAgICAgICBzdGF0ZS5uZXh0U3RhdGVzLnB1c2goc3RhdGUpOwogICAgICAgIH0KCiAgICAgICAgLy8gUmV0dXJuIHRoZSBuZXcgc3RhdGUKICAgICAgICByZXR1cm4gc3RhdGU7CiAgICAgIH0sCgogICAgICAvLyBGaW5kIGEgbGlzdCBvZiBjaGlsZCBzdGF0ZXMgbWF0Y2hpbmcgdGhlIG5leHQgY2hhcmFjdGVyCiAgICAgIG1hdGNoOiBmdW5jdGlvbihjaGFyKSB7CiAgICAgICAgLy8gREVCVUcgIlByb2Nlc3NpbmcgYCIgKyBjaGFyICsgImA6IgogICAgICAgIHZhciBuZXh0U3RhdGVzID0gdGhpcy5uZXh0U3RhdGVzLAogICAgICAgICAgICBjaGlsZCwgY2hhclNwZWMsIGNoYXJzOwoKICAgICAgICAvLyBERUJVRyAiICAiICsgZGVidWdTdGF0ZSh0aGlzKQogICAgICAgIHZhciByZXR1cm5lZCA9IFtdOwoKICAgICAgICBmb3IgKHZhciBpPTAsIGw9bmV4dFN0YXRlcy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgICBjaGlsZCA9IG5leHRTdGF0ZXNbaV07CgogICAgICAgICAgY2hhclNwZWMgPSBjaGlsZC5jaGFyU3BlYzsKCiAgICAgICAgICBpZiAodHlwZW9mIChjaGFycyA9IGNoYXJTcGVjLnZhbGlkQ2hhcnMpICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICBpZiAoY2hhcnMuaW5kZXhPZihjaGFyKSAhPT0gLTEpIHsgcmV0dXJuZWQucHVzaChjaGlsZCk7IH0KICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIChjaGFycyA9IGNoYXJTcGVjLmludmFsaWRDaGFycykgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIGlmIChjaGFycy5pbmRleE9mKGNoYXIpID09PSAtMSkgeyByZXR1cm5lZC5wdXNoKGNoaWxkKTsgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJldHVybmVkOwogICAgICB9CgogICAgICAvKiogSUYgREVCVUcKICAgICAgLCBkZWJ1ZzogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGNoYXJTcGVjID0gdGhpcy5jaGFyU3BlYywKICAgICAgICAgICAgZGVidWcgPSAiWyIsCiAgICAgICAgICAgIGNoYXJzID0gY2hhclNwZWMudmFsaWRDaGFycyB8fCBjaGFyU3BlYy5pbnZhbGlkQ2hhcnM7CgogICAgICAgIGlmIChjaGFyU3BlYy5pbnZhbGlkQ2hhcnMpIHsgZGVidWcgKz0gIl4iOyB9CiAgICAgICAgZGVidWcgKz0gY2hhcnM7CiAgICAgICAgZGVidWcgKz0gIl0iOwoKICAgICAgICBpZiAoY2hhclNwZWMucmVwZWF0KSB7IGRlYnVnICs9ICIrIjsgfQoKICAgICAgICByZXR1cm4gZGVidWc7CiAgICAgIH0KICAgICAgRU5EIElGICoqLwogICAgfTsKCiAgICAvKiogSUYgREVCVUcKICAgIGZ1bmN0aW9uIGRlYnVnKGxvZykgewogICAgICBjb25zb2xlLmxvZyhsb2cpOwogICAgfQoKICAgIGZ1bmN0aW9uIGRlYnVnU3RhdGUoc3RhdGUpIHsKICAgICAgcmV0dXJuIHN0YXRlLm5leHRTdGF0ZXMubWFwKGZ1bmN0aW9uKG4pIHsKICAgICAgICBpZiAobi5uZXh0U3RhdGVzLmxlbmd0aCA9PT0gMCkgeyByZXR1cm4gIiggIiArIG4uZGVidWcoKSArICIgW2FjY2VwdGluZ10gKSI7IH0KICAgICAgICByZXR1cm4gIiggIiArIG4uZGVidWcoKSArICIgPHRoZW4+ICIgKyBuLm5leHRTdGF0ZXMubWFwKGZ1bmN0aW9uKHMpIHsgcmV0dXJuIHMuZGVidWcoKSB9KS5qb2luKCIgb3IgIikgKyAiICkiOwogICAgICB9KS5qb2luKCIsICIpCiAgICB9CiAgICBFTkQgSUYgKiovCgogICAgLy8gVGhpcyBpcyBhIHNvbWV3aGF0IG5haXZlIHN0cmF0ZWd5LCBidXQgc2hvdWxkIHdvcmsgaW4gYSBsb3Qgb2YgY2FzZXMKICAgIC8vIEEgYmV0dGVyIHN0cmF0ZWd5IHdvdWxkIHByb3Blcmx5IHJlc29sdmUgL3Bvc3RzLzppZC9uZXcgYW5kIC9wb3N0cy9lZGl0LzppZAogICAgZnVuY3Rpb24gc29ydFNvbHV0aW9ucyhzdGF0ZXMpIHsKICAgICAgcmV0dXJuIHN0YXRlcy5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICBpZiAoYS50eXBlcy5zdGFycyAhPT0gYi50eXBlcy5zdGFycykgeyByZXR1cm4gYS50eXBlcy5zdGFycyAtIGIudHlwZXMuc3RhcnM7IH0KICAgICAgICBpZiAoYS50eXBlcy5keW5hbWljcyAhPT0gYi50eXBlcy5keW5hbWljcykgeyByZXR1cm4gYS50eXBlcy5keW5hbWljcyAtIGIudHlwZXMuZHluYW1pY3M7IH0KICAgICAgICBpZiAoYS50eXBlcy5zdGF0aWNzICE9PSBiLnR5cGVzLnN0YXRpY3MpIHsgcmV0dXJuIGIudHlwZXMuc3RhdGljcyAtIGEudHlwZXMuc3RhdGljczsgfQoKICAgICAgICByZXR1cm4gMDsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gcmVjb2duaXplQ2hhcihzdGF0ZXMsIGNoYXIpIHsKICAgICAgdmFyIG5leHRTdGF0ZXMgPSBbXTsKCiAgICAgIGZvciAodmFyIGk9MCwgbD1zdGF0ZXMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIHZhciBzdGF0ZSA9IHN0YXRlc1tpXTsKCiAgICAgICAgbmV4dFN0YXRlcyA9IG5leHRTdGF0ZXMuY29uY2F0KHN0YXRlLm1hdGNoKGNoYXIpKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG5leHRTdGF0ZXM7CiAgICB9CgogICAgZnVuY3Rpb24gZmluZEhhbmRsZXIoc3RhdGUsIHBhdGgsIHF1ZXJ5UGFyYW1zKSB7CiAgICAgIHZhciBoYW5kbGVycyA9IHN0YXRlLmhhbmRsZXJzLCByZWdleCA9IHN0YXRlLnJlZ2V4OwogICAgICB2YXIgY2FwdHVyZXMgPSBwYXRoLm1hdGNoKHJlZ2V4KSwgY3VycmVudENhcHR1cmUgPSAxOwogICAgICB2YXIgcmVzdWx0ID0gW107CgogICAgICBmb3IgKHZhciBpPTAsIGw9aGFuZGxlcnMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIHZhciBoYW5kbGVyID0gaGFuZGxlcnNbaV0sIG5hbWVzID0gaGFuZGxlci5uYW1lcywgcGFyYW1zID0ge30sCiAgICAgICAgICB3YXRjaGVkUXVlcnlQYXJhbXMgPSBoYW5kbGVyLnF1ZXJ5UGFyYW1zIHx8IFtdLAogICAgICAgICAgYWN0aXZlUXVlcnlQYXJhbXMgPSB7fSwKICAgICAgICAgIGosIG07CgogICAgICAgIGZvciAoaj0wLCBtPW5hbWVzLmxlbmd0aDsgajxtOyBqKyspIHsKICAgICAgICAgIHBhcmFtc1tuYW1lc1tqXV0gPSBjYXB0dXJlc1tjdXJyZW50Q2FwdHVyZSsrXTsKICAgICAgICB9CiAgICAgICAgZm9yIChqPTAsIG09d2F0Y2hlZFF1ZXJ5UGFyYW1zLmxlbmd0aDsgaiA8IG07IGorKykgewogICAgICAgICAgdmFyIGtleSA9IHdhdGNoZWRRdWVyeVBhcmFtc1tqXTsKICAgICAgICAgIGlmKHF1ZXJ5UGFyYW1zW2tleV0pewogICAgICAgICAgICBhY3RpdmVRdWVyeVBhcmFtc1trZXldID0gcXVlcnlQYXJhbXNba2V5XTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGN1cnJlbnRSZXN1bHQgPSB7IGhhbmRsZXI6IGhhbmRsZXIuaGFuZGxlciwgcGFyYW1zOiBwYXJhbXMsIGlzRHluYW1pYzogISFuYW1lcy5sZW5ndGggfTsKICAgICAgICBpZih3YXRjaGVkUXVlcnlQYXJhbXMgJiYgd2F0Y2hlZFF1ZXJ5UGFyYW1zLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGN1cnJlbnRSZXN1bHQucXVlcnlQYXJhbXMgPSBhY3RpdmVRdWVyeVBhcmFtczsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnB1c2goY3VycmVudFJlc3VsdCk7CiAgICAgIH0KCiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgZnVuY3Rpb24gYWRkU2VnbWVudChjdXJyZW50U3RhdGUsIHNlZ21lbnQpIHsKICAgICAgc2VnbWVudC5lYWNoQ2hhcihmdW5jdGlvbihjaGFyKSB7CiAgICAgICAgdmFyIHN0YXRlOwoKICAgICAgICBjdXJyZW50U3RhdGUgPSBjdXJyZW50U3RhdGUucHV0KGNoYXIpOwogICAgICB9KTsKCiAgICAgIHJldHVybiBjdXJyZW50U3RhdGU7CiAgICB9CgogICAgLy8gVGhlIG1haW4gaW50ZXJmYWNlCgogICAgdmFyIFJvdXRlUmVjb2duaXplciA9IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnJvb3RTdGF0ZSA9IG5ldyBTdGF0ZSgpOwogICAgICB0aGlzLm5hbWVzID0ge307CiAgICB9OwoKCiAgICBSb3V0ZVJlY29nbml6ZXIucHJvdG90eXBlID0gewogICAgICBhZGQ6IGZ1bmN0aW9uKHJvdXRlcywgb3B0aW9ucykgewogICAgICAgIHZhciBjdXJyZW50U3RhdGUgPSB0aGlzLnJvb3RTdGF0ZSwgcmVnZXggPSAiXiIsCiAgICAgICAgICAgIHR5cGVzID0geyBzdGF0aWNzOiAwLCBkeW5hbWljczogMCwgc3RhcnM6IDAgfSwKICAgICAgICAgICAgaGFuZGxlcnMgPSBbXSwgYWxsU2VnbWVudHMgPSBbXSwgbmFtZTsKCiAgICAgICAgdmFyIGlzRW1wdHkgPSB0cnVlOwoKICAgICAgICBmb3IgKHZhciBpPTAsIGw9cm91dGVzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICAgIHZhciByb3V0ZSA9IHJvdXRlc1tpXSwgbmFtZXMgPSBbXTsKCiAgICAgICAgICB2YXIgc2VnbWVudHMgPSBwYXJzZShyb3V0ZS5wYXRoLCBuYW1lcywgdHlwZXMpOwoKICAgICAgICAgIGFsbFNlZ21lbnRzID0gYWxsU2VnbWVudHMuY29uY2F0KHNlZ21lbnRzKTsKCiAgICAgICAgICBmb3IgKHZhciBqPTAsIG09c2VnbWVudHMubGVuZ3RoOyBqPG07IGorKykgewogICAgICAgICAgICB2YXIgc2VnbWVudCA9IHNlZ21lbnRzW2pdOwoKICAgICAgICAgICAgaWYgKHNlZ21lbnQgaW5zdGFuY2VvZiBFcHNpbG9uU2VnbWVudCkgeyBjb250aW51ZTsgfQoKICAgICAgICAgICAgaXNFbXB0eSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gQWRkIGEgIi8iIGZvciB0aGUgbmV3IHNlZ21lbnQKICAgICAgICAgICAgY3VycmVudFN0YXRlID0gY3VycmVudFN0YXRlLnB1dCh7IHZhbGlkQ2hhcnM6ICIvIiB9KTsKICAgICAgICAgICAgcmVnZXggKz0gIi8iOwoKICAgICAgICAgICAgLy8gQWRkIGEgcmVwcmVzZW50YXRpb24gb2YgdGhlIHNlZ21lbnQgdG8gdGhlIE5GQSBhbmQgcmVnZXgKICAgICAgICAgICAgY3VycmVudFN0YXRlID0gYWRkU2VnbWVudChjdXJyZW50U3RhdGUsIHNlZ21lbnQpOwogICAgICAgICAgICByZWdleCArPSBzZWdtZW50LnJlZ2V4KCk7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGhhbmRsZXIgPSB7IGhhbmRsZXI6IHJvdXRlLmhhbmRsZXIsIG5hbWVzOiBuYW1lcyB9OwogICAgICAgICAgaWYocm91dGUucXVlcnlQYXJhbXMpIHsKICAgICAgICAgICAgaGFuZGxlci5xdWVyeVBhcmFtcyA9IHJvdXRlLnF1ZXJ5UGFyYW1zOwogICAgICAgICAgfQogICAgICAgICAgaGFuZGxlcnMucHVzaChoYW5kbGVyKTsKICAgICAgICB9CgogICAgICAgIGlmIChpc0VtcHR5KSB7CiAgICAgICAgICBjdXJyZW50U3RhdGUgPSBjdXJyZW50U3RhdGUucHV0KHsgdmFsaWRDaGFyczogIi8iIH0pOwogICAgICAgICAgcmVnZXggKz0gIi8iOwogICAgICAgIH0KCiAgICAgICAgY3VycmVudFN0YXRlLmhhbmRsZXJzID0gaGFuZGxlcnM7CiAgICAgICAgY3VycmVudFN0YXRlLnJlZ2V4ID0gbmV3IFJlZ0V4cChyZWdleCArICIkIik7CiAgICAgICAgY3VycmVudFN0YXRlLnR5cGVzID0gdHlwZXM7CgogICAgICAgIGlmIChuYW1lID0gb3B0aW9ucyAmJiBvcHRpb25zLmFzKSB7CiAgICAgICAgICB0aGlzLm5hbWVzW25hbWVdID0gewogICAgICAgICAgICBzZWdtZW50czogYWxsU2VnbWVudHMsCiAgICAgICAgICAgIGhhbmRsZXJzOiBoYW5kbGVycwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICBoYW5kbGVyc0ZvcjogZnVuY3Rpb24obmFtZSkgewogICAgICAgIHZhciByb3V0ZSA9IHRoaXMubmFtZXNbbmFtZV0sIHJlc3VsdCA9IFtdOwogICAgICAgIGlmICghcm91dGUpIHsgdGhyb3cgbmV3IEVycm9yKCJUaGVyZSBpcyBubyByb3V0ZSBuYW1lZCAiICsgbmFtZSk7IH0KCiAgICAgICAgZm9yICh2YXIgaT0wLCBsPXJvdXRlLmhhbmRsZXJzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICAgIHJlc3VsdC5wdXNoKHJvdXRlLmhhbmRsZXJzW2ldKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0sCgogICAgICBoYXNSb3V0ZTogZnVuY3Rpb24obmFtZSkgewogICAgICAgIHJldHVybiAhIXRoaXMubmFtZXNbbmFtZV07CiAgICAgIH0sCgogICAgICBnZW5lcmF0ZTogZnVuY3Rpb24obmFtZSwgcGFyYW1zKSB7CiAgICAgICAgdmFyIHJvdXRlID0gdGhpcy5uYW1lc1tuYW1lXSwgb3V0cHV0ID0gIiI7CiAgICAgICAgaWYgKCFyb3V0ZSkgeyB0aHJvdyBuZXcgRXJyb3IoIlRoZXJlIGlzIG5vIHJvdXRlIG5hbWVkICIgKyBuYW1lKTsgfQoKICAgICAgICB2YXIgc2VnbWVudHMgPSByb3V0ZS5zZWdtZW50czsKCiAgICAgICAgZm9yICh2YXIgaT0wLCBsPXNlZ21lbnRzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICAgIHZhciBzZWdtZW50ID0gc2VnbWVudHNbaV07CgogICAgICAgICAgaWYgKHNlZ21lbnQgaW5zdGFuY2VvZiBFcHNpbG9uU2VnbWVudCkgeyBjb250aW51ZTsgfQoKICAgICAgICAgIG91dHB1dCArPSAiLyI7CiAgICAgICAgICBvdXRwdXQgKz0gc2VnbWVudC5nZW5lcmF0ZShwYXJhbXMpOwogICAgICAgIH0KCiAgICAgICAgaWYgKG91dHB1dC5jaGFyQXQoMCkgIT09ICcvJykgeyBvdXRwdXQgPSAnLycgKyBvdXRwdXQ7IH0KCiAgICAgICAgaWYgKHBhcmFtcyAmJiBwYXJhbXMucXVlcnlQYXJhbXMpIHsKICAgICAgICAgIG91dHB1dCArPSB0aGlzLmdlbmVyYXRlUXVlcnlTdHJpbmcocGFyYW1zLnF1ZXJ5UGFyYW1zLCByb3V0ZS5oYW5kbGVycyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICB9LAoKICAgICAgZ2VuZXJhdGVRdWVyeVN0cmluZzogZnVuY3Rpb24ocGFyYW1zLCBoYW5kbGVycykgewogICAgICAgIHZhciBwYWlycyA9IFtdLCBhbGxvd2VkUGFyYW1zID0gW107CiAgICAgICAgZm9yKHZhciBpPTA7IGkgPCBoYW5kbGVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIGN1cnJlbnRQYXJhbUxpc3QgPSBoYW5kbGVyc1tpXS5xdWVyeVBhcmFtczsKICAgICAgICAgIGlmKGN1cnJlbnRQYXJhbUxpc3QpIHsKICAgICAgICAgICAgYWxsb3dlZFBhcmFtcy5wdXNoLmFwcGx5KGFsbG93ZWRQYXJhbXMsIGN1cnJlbnRQYXJhbUxpc3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IodmFyIGtleSBpbiBwYXJhbXMpIHsKICAgICAgICAgIGlmIChwYXJhbXMuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICBpZihhbGxvd2VkUGFyYW1zLmluZGV4T2Yoa2V5KSA9PT0gLTEpIHsKICAgICAgICAgICAgICB0aHJvdyAnUXVlcnkgcGFyYW0gIicgKyBrZXkgKyAnIiBpcyBub3Qgc3BlY2lmaWVkIGFzIGEgdmFsaWQgcGFyYW0gZm9yIHRoaXMgcm91dGUnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHBhcmFtc1trZXldOwogICAgICAgICAgICB2YXIgcGFpciA9IGVuY29kZVVSSUNvbXBvbmVudChrZXkpOwogICAgICAgICAgICBpZih2YWx1ZSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIHBhaXIgKz0gIj0iICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYWlycy5wdXNoKHBhaXIpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHBhaXJzLmxlbmd0aCA9PT0gMCkgeyByZXR1cm4gJyc7IH0KCiAgICAgICAgcmV0dXJuICI/IiArIHBhaXJzLmpvaW4oIiYiKTsKICAgICAgfSwKCiAgICAgIHBhcnNlUXVlcnlTdHJpbmc6IGZ1bmN0aW9uKHF1ZXJ5U3RyaW5nKSB7CiAgICAgICAgdmFyIHBhaXJzID0gcXVlcnlTdHJpbmcuc3BsaXQoIiYiKSwgcXVlcnlQYXJhbXMgPSB7fTsKICAgICAgICBmb3IodmFyIGk9MDsgaSA8IHBhaXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgcGFpciAgICAgID0gcGFpcnNbaV0uc3BsaXQoJz0nKSwKICAgICAgICAgICAgICBrZXkgICAgICAgPSBkZWNvZGVVUklDb21wb25lbnQocGFpclswXSksCiAgICAgICAgICAgICAgdmFsdWUgICAgID0gcGFpclsxXSA/IGRlY29kZVVSSUNvbXBvbmVudChwYWlyWzFdKSA6IHRydWU7CiAgICAgICAgICBxdWVyeVBhcmFtc1trZXldID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBxdWVyeVBhcmFtczsKICAgICAgfSwKCiAgICAgIHJlY29nbml6ZTogZnVuY3Rpb24ocGF0aCkgewogICAgICAgIHZhciBzdGF0ZXMgPSBbIHRoaXMucm9vdFN0YXRlIF0sCiAgICAgICAgICAgIHBhdGhMZW4sIGksIGwsIHF1ZXJ5U3RhcnQsIHF1ZXJ5UGFyYW1zID0ge307CgogICAgICAgIHF1ZXJ5U3RhcnQgPSBwYXRoLmluZGV4T2YoJz8nKTsKICAgICAgICBpZiAocXVlcnlTdGFydCAhPT0gLTEpIHsKICAgICAgICAgIHZhciBxdWVyeVN0cmluZyA9IHBhdGguc3Vic3RyKHF1ZXJ5U3RhcnQgKyAxLCBwYXRoLmxlbmd0aCk7CiAgICAgICAgICBwYXRoID0gcGF0aC5zdWJzdHIoMCwgcXVlcnlTdGFydCk7CiAgICAgICAgICBxdWVyeVBhcmFtcyA9IHRoaXMucGFyc2VRdWVyeVN0cmluZyhxdWVyeVN0cmluZyk7CiAgICAgICAgfQoKICAgICAgICAvLyBERUJVRyBHUk9VUCBwYXRoCgogICAgICAgIGlmIChwYXRoLmNoYXJBdCgwKSAhPT0gIi8iKSB7IHBhdGggPSAiLyIgKyBwYXRoOyB9CgogICAgICAgIHBhdGhMZW4gPSBwYXRoLmxlbmd0aDsKICAgICAgICBpZiAocGF0aExlbiA+IDEgJiYgcGF0aC5jaGFyQXQocGF0aExlbiAtIDEpID09PSAiLyIpIHsKICAgICAgICAgIHBhdGggPSBwYXRoLnN1YnN0cigwLCBwYXRoTGVuIC0gMSk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKGk9MCwgbD1wYXRoLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICAgIHN0YXRlcyA9IHJlY29nbml6ZUNoYXIoc3RhdGVzLCBwYXRoLmNoYXJBdChpKSk7CiAgICAgICAgICBpZiAoIXN0YXRlcy5sZW5ndGgpIHsgYnJlYWs7IH0KICAgICAgICB9CgogICAgICAgIC8vIEVORCBERUJVRyBHUk9VUAoKICAgICAgICB2YXIgc29sdXRpb25zID0gW107CiAgICAgICAgZm9yIChpPTAsIGw9c3RhdGVzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICAgIGlmIChzdGF0ZXNbaV0uaGFuZGxlcnMpIHsgc29sdXRpb25zLnB1c2goc3RhdGVzW2ldKTsgfQogICAgICAgIH0KCiAgICAgICAgc3RhdGVzID0gc29ydFNvbHV0aW9ucyhzb2x1dGlvbnMpOwoKICAgICAgICB2YXIgc3RhdGUgPSBzb2x1dGlvbnNbMF07CgogICAgICAgIGlmIChzdGF0ZSAmJiBzdGF0ZS5oYW5kbGVycykgewogICAgICAgICAgcmV0dXJuIGZpbmRIYW5kbGVyKHN0YXRlLCBwYXRoLCBxdWVyeVBhcmFtcyk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIGZ1bmN0aW9uIFRhcmdldChwYXRoLCBtYXRjaGVyLCBkZWxlZ2F0ZSkgewogICAgICB0aGlzLnBhdGggPSBwYXRoOwogICAgICB0aGlzLm1hdGNoZXIgPSBtYXRjaGVyOwogICAgICB0aGlzLmRlbGVnYXRlID0gZGVsZWdhdGU7CiAgICB9CgogICAgVGFyZ2V0LnByb3RvdHlwZSA9IHsKICAgICAgdG86IGZ1bmN0aW9uKHRhcmdldCwgY2FsbGJhY2spIHsKICAgICAgICB2YXIgZGVsZWdhdGUgPSB0aGlzLmRlbGVnYXRlOwoKICAgICAgICBpZiAoZGVsZWdhdGUgJiYgZGVsZWdhdGUud2lsbEFkZFJvdXRlKSB7CiAgICAgICAgICB0YXJnZXQgPSBkZWxlZ2F0ZS53aWxsQWRkUm91dGUodGhpcy5tYXRjaGVyLnRhcmdldCwgdGFyZ2V0KTsKICAgICAgICB9CgogICAgICAgIHRoaXMubWF0Y2hlci5hZGQodGhpcy5wYXRoLCB0YXJnZXQpOwoKICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgIGlmIChjYWxsYmFjay5sZW5ndGggPT09IDApIHsgdGhyb3cgbmV3IEVycm9yKCJZb3UgbXVzdCBoYXZlIGFuIGFyZ3VtZW50IGluIHRoZSBmdW5jdGlvbiBwYXNzZWQgdG8gYHRvYCIpOyB9CiAgICAgICAgICB0aGlzLm1hdGNoZXIuYWRkQ2hpbGQodGhpcy5wYXRoLCB0YXJnZXQsIGNhbGxiYWNrLCB0aGlzLmRlbGVnYXRlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0sCgogICAgICB3aXRoUXVlcnlQYXJhbXM6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSB7IHRocm93IG5ldyBFcnJvcigieW91IG11c3QgcHJvdmlkZSBhcmd1bWVudHMgdG8gdGhlIHdpdGhRdWVyeVBhcmFtcyBtZXRob2QiKTsgfQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1tpXSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCd5b3Ugc2hvdWxkIGNhbGwgd2l0aFF1ZXJ5UGFyYW1zIHdpdGggYSBsaXN0IG9mIHN0cmluZ3MsIGUuZy4gd2l0aFF1ZXJ5UGFyYW1zKCJmb28iLCAiYmFyIiknKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHF1ZXJ5UGFyYW1zID0gW10uc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgIHRoaXMubWF0Y2hlci5hZGRRdWVyeVBhcmFtcyh0aGlzLnBhdGgsIHF1ZXJ5UGFyYW1zKTsKICAgICAgfQogICAgfTsKCiAgICBmdW5jdGlvbiBNYXRjaGVyKHRhcmdldCkgewogICAgICB0aGlzLnJvdXRlcyA9IHt9OwogICAgICB0aGlzLmNoaWxkcmVuID0ge307CiAgICAgIHRoaXMucXVlcnlQYXJhbXMgPSB7fTsKICAgICAgdGhpcy50YXJnZXQgPSB0YXJnZXQ7CiAgICB9CgogICAgTWF0Y2hlci5wcm90b3R5cGUgPSB7CiAgICAgIGFkZDogZnVuY3Rpb24ocGF0aCwgaGFuZGxlcikgewogICAgICAgIHRoaXMucm91dGVzW3BhdGhdID0gaGFuZGxlcjsKICAgICAgfSwKCiAgICAgIGFkZFF1ZXJ5UGFyYW1zOiBmdW5jdGlvbihwYXRoLCBwYXJhbXMpIHsKICAgICAgICB0aGlzLnF1ZXJ5UGFyYW1zW3BhdGhdID0gcGFyYW1zOwogICAgICB9LAoKICAgICAgYWRkQ2hpbGQ6IGZ1bmN0aW9uKHBhdGgsIHRhcmdldCwgY2FsbGJhY2ssIGRlbGVnYXRlKSB7CiAgICAgICAgdmFyIG1hdGNoZXIgPSBuZXcgTWF0Y2hlcih0YXJnZXQpOwogICAgICAgIHRoaXMuY2hpbGRyZW5bcGF0aF0gPSBtYXRjaGVyOwoKICAgICAgICB2YXIgbWF0Y2ggPSBnZW5lcmF0ZU1hdGNoKHBhdGgsIG1hdGNoZXIsIGRlbGVnYXRlKTsKCiAgICAgICAgaWYgKGRlbGVnYXRlICYmIGRlbGVnYXRlLmNvbnRleHRFbnRlcmVkKSB7CiAgICAgICAgICBkZWxlZ2F0ZS5jb250ZXh0RW50ZXJlZCh0YXJnZXQsIG1hdGNoKTsKICAgICAgICB9CgogICAgICAgIGNhbGxiYWNrKG1hdGNoKTsKICAgICAgfQogICAgfTsKCiAgICBmdW5jdGlvbiBnZW5lcmF0ZU1hdGNoKHN0YXJ0aW5nUGF0aCwgbWF0Y2hlciwgZGVsZWdhdGUpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHBhdGgsIG5lc3RlZENhbGxiYWNrKSB7CiAgICAgICAgdmFyIGZ1bGxQYXRoID0gc3RhcnRpbmdQYXRoICsgcGF0aDsKCiAgICAgICAgaWYgKG5lc3RlZENhbGxiYWNrKSB7CiAgICAgICAgICBuZXN0ZWRDYWxsYmFjayhnZW5lcmF0ZU1hdGNoKGZ1bGxQYXRoLCBtYXRjaGVyLCBkZWxlZ2F0ZSkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gbmV3IFRhcmdldChzdGFydGluZ1BhdGggKyBwYXRoLCBtYXRjaGVyLCBkZWxlZ2F0ZSk7CiAgICAgICAgfQogICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGFkZFJvdXRlKHJvdXRlQXJyYXksIHBhdGgsIGhhbmRsZXIsIHF1ZXJ5UGFyYW1zKSB7CiAgICAgIHZhciBsZW4gPSAwOwogICAgICBmb3IgKHZhciBpPTAsIGw9cm91dGVBcnJheS5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgbGVuICs9IHJvdXRlQXJyYXlbaV0ucGF0aC5sZW5ndGg7CiAgICAgIH0KCiAgICAgIHBhdGggPSBwYXRoLnN1YnN0cihsZW4pOwogICAgICB2YXIgcm91dGUgPSB7IHBhdGg6IHBhdGgsIGhhbmRsZXI6IGhhbmRsZXIgfTsKICAgICAgaWYocXVlcnlQYXJhbXMpIHsgcm91dGUucXVlcnlQYXJhbXMgPSBxdWVyeVBhcmFtczsgfQogICAgICByb3V0ZUFycmF5LnB1c2gocm91dGUpOwogICAgfQoKICAgIGZ1bmN0aW9uIGVhY2hSb3V0ZShiYXNlUm91dGUsIG1hdGNoZXIsIGNhbGxiYWNrLCBiaW5kaW5nKSB7CiAgICAgIHZhciByb3V0ZXMgPSBtYXRjaGVyLnJvdXRlczsKICAgICAgdmFyIHF1ZXJ5UGFyYW1zID0gbWF0Y2hlci5xdWVyeVBhcmFtczsKCiAgICAgIGZvciAodmFyIHBhdGggaW4gcm91dGVzKSB7CiAgICAgICAgaWYgKHJvdXRlcy5oYXNPd25Qcm9wZXJ0eShwYXRoKSkgewogICAgICAgICAgdmFyIHJvdXRlQXJyYXkgPSBiYXNlUm91dGUuc2xpY2UoKTsKICAgICAgICAgIGFkZFJvdXRlKHJvdXRlQXJyYXksIHBhdGgsIHJvdXRlc1twYXRoXSwgcXVlcnlQYXJhbXNbcGF0aF0pOwoKICAgICAgICAgIGlmIChtYXRjaGVyLmNoaWxkcmVuW3BhdGhdKSB7CiAgICAgICAgICAgIGVhY2hSb3V0ZShyb3V0ZUFycmF5LCBtYXRjaGVyLmNoaWxkcmVuW3BhdGhdLCBjYWxsYmFjaywgYmluZGluZyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjYWxsYmFjay5jYWxsKGJpbmRpbmcsIHJvdXRlQXJyYXkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIFJvdXRlUmVjb2duaXplci5wcm90b3R5cGUubWFwID0gZnVuY3Rpb24oY2FsbGJhY2ssIGFkZFJvdXRlQ2FsbGJhY2spIHsKICAgICAgdmFyIG1hdGNoZXIgPSBuZXcgTWF0Y2hlcigpOwoKICAgICAgY2FsbGJhY2soZ2VuZXJhdGVNYXRjaCgiIiwgbWF0Y2hlciwgdGhpcy5kZWxlZ2F0ZSkpOwoKICAgICAgZWFjaFJvdXRlKFtdLCBtYXRjaGVyLCBmdW5jdGlvbihyb3V0ZSkgewogICAgICAgIGlmIChhZGRSb3V0ZUNhbGxiYWNrKSB7IGFkZFJvdXRlQ2FsbGJhY2sodGhpcywgcm91dGUpOyB9CiAgICAgICAgZWxzZSB7IHRoaXMuYWRkKHJvdXRlKTsgfQogICAgICB9LCB0aGlzKTsKICAgIH07CiAgICByZXR1cm4gUm91dGVSZWNvZ25pemVyOwogIH0pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewpkZWZpbmUoInJvdXRlciIsCiAgWyJyb3V0ZS1yZWNvZ25pemVyIiwicnN2cCIsImV4cG9ydHMiXSwKICBmdW5jdGlvbihfX2RlcGVuZGVuY3kxX18sIF9fZGVwZW5kZW5jeTJfXywgX19leHBvcnRzX18pIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIC8qKgogICAgICBAcHJpdmF0ZQoKICAgICAgVGhpcyBmaWxlIHJlZmVyZW5jZXMgc2V2ZXJhbCBpbnRlcm5hbCBzdHJ1Y3R1cmVzOgoKICAgICAgIyMgYFJlY29nbml6ZWRIYW5kbGVyYAoKICAgICAgKiBge1N0cmluZ30gaGFuZGxlcmA6IEEgaGFuZGxlciBuYW1lCiAgICAgICogYHtPYmplY3R9IHBhcmFtc2A6IEEgaGFzaCBvZiByZWNvZ25pemVkIHBhcmFtZXRlcnMKCiAgICAgICMjIGBIYW5kbGVySW5mb2AKCiAgICAgICogYHtCb29sZWFufSBpc0R5bmFtaWNgOiB3aGV0aGVyIGEgaGFuZGxlciBoYXMgYW55IGR5bmFtaWMgc2VnbWVudHMKICAgICAgKiBge1N0cmluZ30gbmFtZWA6IHRoZSBuYW1lIG9mIGEgaGFuZGxlcgogICAgICAqIGB7T2JqZWN0fSBoYW5kbGVyYDogYSBoYW5kbGVyIG9iamVjdAogICAgICAqIGB7T2JqZWN0fSBjb250ZXh0YDogdGhlIGFjdGl2ZSBjb250ZXh0IGZvciB0aGUgaGFuZGxlcgogICAgKi8KCiAgICB2YXIgUm91dGVSZWNvZ25pemVyID0gX19kZXBlbmRlbmN5MV9fOwogICAgdmFyIFJTVlAgPSBfX2RlcGVuZGVuY3kyX187CgogICAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKCgogICAgLyoqCiAgICAgIEBwcml2YXRlCgogICAgICBBIFRyYW5zaXRpb24gaXMgYSB0aGVubmFibGUgKGEgcHJvbWlzZS1saWtlIG9iamVjdCkgdGhhdCByZXByZXNlbnRzCiAgICAgIGFuIGF0dGVtcHQgdG8gdHJhbnNpdGlvbiB0byBhbm90aGVyIHJvdXRlLiBJdCBjYW4gYmUgYWJvcnRlZCwgZWl0aGVyCiAgICAgIGV4cGxpY2l0bHkgdmlhIGBhYm9ydGAgb3IgYnkgYXR0ZW1wdGluZyBhbm90aGVyIHRyYW5zaXRpb24gd2hpbGUgYQogICAgICBwcmV2aW91cyBvbmUgaXMgc3RpbGwgdW5kZXJ3YXkuIEFuIGFib3J0ZWQgdHJhbnNpdGlvbiBjYW4gYWxzbwogICAgICBiZSBgcmV0cnkoKWBkIGxhdGVyLgogICAgICovCgogICAgZnVuY3Rpb24gVHJhbnNpdGlvbihyb3V0ZXIsIHByb21pc2UpIHsKICAgICAgdGhpcy5yb3V0ZXIgPSByb3V0ZXI7CiAgICAgIHRoaXMucHJvbWlzZSA9IHByb21pc2U7CiAgICAgIHRoaXMuZGF0YSA9IHt9OwogICAgICB0aGlzLnJlc29sdmVkTW9kZWxzID0ge307CiAgICAgIHRoaXMucHJvdmlkZWRNb2RlbHMgPSB7fTsKICAgICAgdGhpcy5wcm92aWRlZE1vZGVsc0FycmF5ID0gW107CiAgICAgIHRoaXMuc2VxdWVuY2UgPSArK1RyYW5zaXRpb24uY3VycmVudFNlcXVlbmNlOwogICAgICB0aGlzLnBhcmFtcyA9IHt9OwogICAgfQoKICAgIFRyYW5zaXRpb24uY3VycmVudFNlcXVlbmNlID0gMDsKCiAgICBUcmFuc2l0aW9uLnByb3RvdHlwZSA9IHsKICAgICAgdGFyZ2V0TmFtZTogbnVsbCwKICAgICAgdXJsTWV0aG9kOiAndXBkYXRlJywKICAgICAgcHJvdmlkZWRNb2RlbHM6IG51bGwsCiAgICAgIHJlc29sdmVkTW9kZWxzOiBudWxsLAogICAgICBwYXJhbXM6IG51bGwsCiAgICAgIHBpdm90SGFuZGxlcjogbnVsbCwKICAgICAgcmVzb2x2ZUluZGV4OiAwLAogICAgICBoYW5kbGVySW5mb3M6IG51bGwsCgogICAgICBpc0FjdGl2ZTogdHJ1ZSwKCiAgICAgIC8qKgogICAgICAgIFRoZSBUcmFuc2l0aW9uJ3MgaW50ZXJuYWwgcHJvbWlzZS4gQ2FsbGluZyBgLnRoZW5gIG9uIHRoaXMgcHJvcGVydHkKICAgICAgICBpcyB0aGF0IHNhbWUgYXMgY2FsbGluZyBgLnRoZW5gIG9uIHRoZSBUcmFuc2l0aW9uIG9iamVjdCBpdHNlbGYsIGJ1dAogICAgICAgIHRoaXMgcHJvcGVydHkgaXMgZXhwb3NlZCBmb3Igd2hlbiB5b3Ugd2FudCB0byBwYXNzIGFyb3VuZCBhCiAgICAgICAgVHJhbnNpdGlvbidzIHByb21pc2UsIGJ1dCBub3QgdGhlIFRyYW5zaXRpb24gb2JqZWN0IGl0c2VsZiwgc2luY2UKICAgICAgICBUcmFuc2l0aW9uIG9iamVjdCBjYW4gYmUgZXh0ZXJuYWxseSBgYWJvcnRgZWQsIHdoaWxlIHRoZSBwcm9taXNlCiAgICAgICAgY2Fubm90LgogICAgICAgKi8KICAgICAgcHJvbWlzZTogbnVsbCwKCiAgICAgIC8qKgogICAgICAgIEN1c3RvbSBzdGF0ZSBjYW4gYmUgc3RvcmVkIG9uIGEgVHJhbnNpdGlvbidzIGBkYXRhYCBvYmplY3QuCiAgICAgICAgVGhpcyBjYW4gYmUgdXNlZnVsIGZvciBkZWNvcmF0aW5nIGEgVHJhbnNpdGlvbiB3aXRoaW4gYW4gZWFybGllcgogICAgICAgIGhvb2sgYW5kIHNoYXJlZCB3aXRoIGEgbGF0ZXIgaG9vay4gUHJvcGVydGllcyBzZXQgb24gYGRhdGFgIHdpbGwKICAgICAgICBiZSBjb3BpZWQgdG8gbmV3IHRyYW5zaXRpb25zIGdlbmVyYXRlZCBieSBjYWxsaW5nIGByZXRyeWAgb24gdGhpcwogICAgICAgIHRyYW5zaXRpb24uCiAgICAgICAqLwogICAgICBkYXRhOiBudWxsLAoKICAgICAgLyoqCiAgICAgICAgQSBzdGFuZGFyZCBwcm9taXNlIGhvb2sgdGhhdCByZXNvbHZlcyBpZiB0aGUgdHJhbnNpdGlvbgogICAgICAgIHN1Y2NlZWRzIGFuZCByZWplY3RzIGlmIGl0IGZhaWxzL3JlZGlyZWN0cy9hYm9ydHMuCgogICAgICAgIEZvcndhcmRzIHRvIHRoZSBpbnRlcm5hbCBgcHJvbWlzZWAgcHJvcGVydHkgd2hpY2ggeW91IGNhbgogICAgICAgIHVzZSBpbiBzaXR1YXRpb25zIHdoZXJlIHlvdSB3YW50IHRvIHBhc3MgYXJvdW5kIGEgdGhlbm5hYmxlLAogICAgICAgIGJ1dCBub3QgdGhlIFRyYW5zaXRpb24gaXRzZWxmLgoKICAgICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBzdWNjZXNzCiAgICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gZmFpbHVyZQogICAgICAgKi8KICAgICAgdGhlbjogZnVuY3Rpb24oc3VjY2VzcywgZmFpbHVyZSkgewogICAgICAgIHJldHVybiB0aGlzLnByb21pc2UudGhlbihzdWNjZXNzLCBmYWlsdXJlKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgIEFib3J0cyB0aGUgVHJhbnNpdGlvbi4gTm90ZSB5b3UgY2FuIGFsc28gaW1wbGljaXRseSBhYm9ydCBhIHRyYW5zaXRpb24KICAgICAgICBieSBpbml0aWF0aW5nIGFub3RoZXIgdHJhbnNpdGlvbiB3aGlsZSBhIHByZXZpb3VzIG9uZSBpcyB1bmRlcndheS4KICAgICAgICovCiAgICAgIGFib3J0OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5pc0Fib3J0ZWQpIHsgcmV0dXJuIHRoaXM7IH0KICAgICAgICBsb2codGhpcy5yb3V0ZXIsIHRoaXMuc2VxdWVuY2UsIHRoaXMudGFyZ2V0TmFtZSArICI6IHRyYW5zaXRpb24gd2FzIGFib3J0ZWQiKTsKICAgICAgICB0aGlzLmlzQWJvcnRlZCA9IHRydWU7CiAgICAgICAgdGhpcy5pc0FjdGl2ZSA9IGZhbHNlOwogICAgICAgIHRoaXMucm91dGVyLmFjdGl2ZVRyYW5zaXRpb24gPSBudWxsOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAgUmV0cmllcyBhIHByZXZpb3VzbHktYWJvcnRlZCB0cmFuc2l0aW9uIChtYWtpbmcgc3VyZSB0byBhYm9ydCB0aGUKICAgICAgICB0cmFuc2l0aW9uIGlmIGl0J3Mgc3RpbGwgYWN0aXZlKS4gUmV0dXJucyBhIG5ldyB0cmFuc2l0aW9uIHRoYXQKICAgICAgICByZXByZXNlbnRzIHRoZSBuZXcgYXR0ZW1wdCB0byB0cmFuc2l0aW9uLgogICAgICAgKi8KICAgICAgcmV0cnk6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuYWJvcnQoKTsKICAgICAgICB2YXIgcmVjb2dIYW5kbGVycyA9IHRoaXMucm91dGVyLnJlY29nbml6ZXIuaGFuZGxlcnNGb3IodGhpcy50YXJnZXROYW1lKSwKICAgICAgICAgICAgaGFuZGxlckluZm9zICA9IGdlbmVyYXRlSGFuZGxlckluZm9zV2l0aFF1ZXJ5UGFyYW1zKHRoaXMucm91dGVyLCByZWNvZ0hhbmRsZXJzLCB0aGlzLnF1ZXJ5UGFyYW1zKSwKICAgICAgICAgICAgbmV3VHJhbnNpdGlvbiA9IHBlcmZvcm1UcmFuc2l0aW9uKHRoaXMucm91dGVyLCBoYW5kbGVySW5mb3MsIHRoaXMucHJvdmlkZWRNb2RlbHNBcnJheSwgdGhpcy5wYXJhbXMsIHRoaXMucXVlcnlQYXJhbXMsIHRoaXMuZGF0YSk7CgogICAgICAgIHJldHVybiBuZXdUcmFuc2l0aW9uOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAgU2V0cyB0aGUgVVJMLWNoYW5naW5nIG1ldGhvZCB0byBiZSBlbXBsb3llZCBhdCB0aGUgZW5kIG9mIGEKICAgICAgICBzdWNjZXNzZnVsIHRyYW5zaXRpb24uIEJ5IGRlZmF1bHQsIGEgbmV3IFRyYW5zaXRpb24gd2lsbCBqdXN0CiAgICAgICAgdXNlIGB1cGRhdGVVUkxgLCBidXQgcGFzc2luZyAncmVwbGFjZScgdG8gdGhpcyBtZXRob2Qgd2lsbAogICAgICAgIGNhdXNlIHRoZSBVUkwgdG8gdXBkYXRlIHVzaW5nICdyZXBsYWNlV2l0aCcgaW5zdGVhZC4gT21pdHRpbmcKICAgICAgICBhIHBhcmFtZXRlciB3aWxsIGRpc2FibGUgdGhlIFVSTCBjaGFuZ2UsIGFsbG93aW5nIGZvciB0cmFuc2l0aW9ucwogICAgICAgIHRoYXQgZG9uJ3QgdXBkYXRlIHRoZSBVUkwgYXQgY29tcGxldGlvbiAodGhpcyBpcyBhbHNvIHVzZWQgZm9yCiAgICAgICAgaGFuZGxlVVJMLCBzaW5jZSB0aGUgVVJMIGhhcyBhbHJlYWR5IGNoYW5nZWQgYmVmb3JlIHRoZQogICAgICAgIHRyYW5zaXRpb24gdG9vayBwbGFjZSkuCgogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBtZXRob2QgdGhlIHR5cGUgb2YgVVJMLWNoYW5naW5nIG1ldGhvZCB0byB1c2UKICAgICAgICAgIGF0IHRoZSBlbmQgb2YgYSB0cmFuc2l0aW9uLiBBY2NlcHRlZCB2YWx1ZXMgYXJlICdyZXBsYWNlJywKICAgICAgICAgIGZhbHN5IHZhbHVlcywgb3IgYW55IG90aGVyIG5vbi1mYWxzeSB2YWx1ZSAod2hpY2ggaXMKICAgICAgICAgIGludGVycHJldGVkIGFzIGFuIHVwZGF0ZVVSTCB0cmFuc2l0aW9uKS4KCiAgICAgICAgQHJldHVybiB7VHJhbnNpdGlvbn0gdGhpcyB0cmFuc2l0aW9uCiAgICAgICAqLwogICAgICBtZXRob2Q6IGZ1bmN0aW9uKG1ldGhvZCkgewogICAgICAgIHRoaXMudXJsTWV0aG9kID0gbWV0aG9kOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAgRmlyZXMgYW4gZXZlbnQgb24gdGhlIGN1cnJlbnQgbGlzdCBvZiByZXNvbHZlZC9yZXNvbHZpbmcKICAgICAgICBoYW5kbGVycyB3aXRoaW4gdGhpcyB0cmFuc2l0aW9uLiBVc2VmdWwgZm9yIGZpcmluZyBldmVudHMKICAgICAgICBvbiByb3V0ZSBoaWVyYXJjaGllcyB0aGF0IGhhdmVuJ3QgZnVsbHkgYmVlbiBlbnRlcmVkIHlldC4KCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBpZ25vcmVGYWlsdXJlIHRoZSBuYW1lIG9mIHRoZSBldmVudCB0byBmaXJlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgdGhlIG5hbWUgb2YgdGhlIGV2ZW50IHRvIGZpcmUKICAgICAgICovCiAgICAgIHRyaWdnZXI6IGZ1bmN0aW9uKGlnbm9yZUZhaWx1cmUpIHsKICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICBpZiAodHlwZW9mIGlnbm9yZUZhaWx1cmUgPT09ICdib29sZWFuJykgewogICAgICAgICAgYXJncy5zaGlmdCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBUaHJvdyBlcnJvcnMgb24gdW5oYW5kbGVkIHRyaWdnZXIgZXZlbnRzIGJ5IGRlZmF1bHQKICAgICAgICAgIGlnbm9yZUZhaWx1cmUgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdHJpZ2dlcih0aGlzLnJvdXRlciwgdGhpcy5oYW5kbGVySW5mb3Muc2xpY2UoMCwgdGhpcy5yZXNvbHZlSW5kZXggKyAxKSwgaWdub3JlRmFpbHVyZSwgYXJncyk7CiAgICAgIH0sCgogICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICJUcmFuc2l0aW9uIChzZXF1ZW5jZSAiICsgdGhpcy5zZXF1ZW5jZSArICIpIjsKICAgICAgfQogICAgfTsKCiAgICBmdW5jdGlvbiBSb3V0ZXIoKSB7CiAgICAgIHRoaXMucmVjb2duaXplciA9IG5ldyBSb3V0ZVJlY29nbml6ZXIoKTsKICAgIH0KCiAgICAvLyBUT0RPOiBzZXBhcmF0ZSBpbnRvIG1vZHVsZT8KICAgIFJvdXRlci5UcmFuc2l0aW9uID0gVHJhbnNpdGlvbjsKCiAgICBfX2V4cG9ydHNfX1siZGVmYXVsdCJdID0gUm91dGVyOwoKCiAgICAvKioKICAgICAgUHJvbWlzZSByZWplY3QgcmVhc29ucyBwYXNzZWQgdG8gcHJvbWlzZSByZWplY3Rpb24KICAgICAgaGFuZGxlcnMgZm9yIGZhaWxlZCB0cmFuc2l0aW9ucy4KICAgICAqLwogICAgUm91dGVyLlVucmVjb2duaXplZFVSTEVycm9yID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICB0aGlzLm1lc3NhZ2UgPSAobWVzc2FnZSB8fCAiVW5yZWNvZ25pemVkVVJMRXJyb3IiKTsKICAgICAgdGhpcy5uYW1lID0gIlVucmVjb2duaXplZFVSTEVycm9yIjsKICAgIH07CgogICAgUm91dGVyLlRyYW5zaXRpb25BYm9ydGVkID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICB0aGlzLm1lc3NhZ2UgPSAobWVzc2FnZSB8fCAiVHJhbnNpdGlvbkFib3J0ZWQiKTsKICAgICAgdGhpcy5uYW1lID0gIlRyYW5zaXRpb25BYm9ydGVkIjsKICAgIH07CgogICAgZnVuY3Rpb24gZXJyb3JUcmFuc2l0aW9uKHJvdXRlciwgcmVhc29uKSB7CiAgICAgIHJldHVybiBuZXcgVHJhbnNpdGlvbihyb3V0ZXIsIFJTVlAucmVqZWN0KHJlYXNvbikpOwogICAgfQoKCiAgICBSb3V0ZXIucHJvdG90eXBlID0gewogICAgICAvKioKICAgICAgICBUaGUgbWFpbiBlbnRyeSBwb2ludCBpbnRvIHRoZSByb3V0ZXIuIFRoZSBBUEkgaXMgZXNzZW50aWFsbHkKICAgICAgICB0aGUgc2FtZSBhcyB0aGUgYG1hcGAgbWV0aG9kIGluIGByb3V0ZS1yZWNvZ25pemVyYC4KCiAgICAgICAgVGhpcyBtZXRob2QgZXh0cmFjdHMgdGhlIFN0cmluZyBoYW5kbGVyIGF0IHRoZSBsYXN0IGAudG8oKWAKICAgICAgICBjYWxsIGFuZCB1c2VzIGl0IGFzIHRoZSBuYW1lIG9mIHRoZSB3aG9sZSByb3V0ZS4KCiAgICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sKICAgICAgKi8KICAgICAgbWFwOiBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgIHRoaXMucmVjb2duaXplci5kZWxlZ2F0ZSA9IHRoaXMuZGVsZWdhdGU7CgogICAgICAgIHRoaXMucmVjb2duaXplci5tYXAoY2FsbGJhY2ssIGZ1bmN0aW9uKHJlY29nbml6ZXIsIHJvdXRlKSB7CiAgICAgICAgICB2YXIgbGFzdEhhbmRsZXIgPSByb3V0ZVtyb3V0ZS5sZW5ndGggLSAxXS5oYW5kbGVyOwogICAgICAgICAgdmFyIGFyZ3MgPSBbcm91dGUsIHsgYXM6IGxhc3RIYW5kbGVyIH1dOwogICAgICAgICAgcmVjb2duaXplci5hZGQuYXBwbHkocmVjb2duaXplciwgYXJncyk7CiAgICAgICAgfSk7CiAgICAgIH0sCgogICAgICBoYXNSb3V0ZTogZnVuY3Rpb24ocm91dGUpIHsKICAgICAgICByZXR1cm4gdGhpcy5yZWNvZ25pemVyLmhhc1JvdXRlKHJvdXRlKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgIENsZWFycyB0aGUgY3VycmVudCBhbmQgdGFyZ2V0IHJvdXRlIGhhbmRsZXJzIGFuZCB0cmlnZ2VycyBleGl0CiAgICAgICAgb24gZWFjaCBvZiB0aGVtIHN0YXJ0aW5nIGF0IHRoZSBsZWFmIGFuZCB0cmF2ZXJzaW5nIHVwIHRocm91Z2gKICAgICAgICBpdHMgYW5jZXN0b3JzLgogICAgICAqLwogICAgICByZXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgZWFjaEhhbmRsZXIodGhpcy5jdXJyZW50SGFuZGxlckluZm9zIHx8IFtdLCBmdW5jdGlvbihoYW5kbGVySW5mbykgewogICAgICAgICAgdmFyIGhhbmRsZXIgPSBoYW5kbGVySW5mby5oYW5kbGVyOwogICAgICAgICAgaWYgKGhhbmRsZXIuZXhpdCkgewogICAgICAgICAgICBoYW5kbGVyLmV4aXQoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB0aGlzLmN1cnJlbnRIYW5kbGVySW5mb3MgPSBudWxsOwogICAgICAgIHRoaXMudGFyZ2V0SGFuZGxlckluZm9zID0gbnVsbDsKICAgICAgfSwKCiAgICAgIGFjdGl2ZVRyYW5zaXRpb246IG51bGwsCgogICAgICAvKioKICAgICAgICB2YXIgaGFuZGxlciA9IGhhbmRsZXJJbmZvLmhhbmRsZXI7CiAgICAgICAgVGhlIGVudHJ5IHBvaW50IGZvciBoYW5kbGluZyBhIGNoYW5nZSB0byB0aGUgVVJMICh1c3VhbGx5CiAgICAgICAgdmlhIHRoZSBiYWNrIGFuZCBmb3J3YXJkIGJ1dHRvbikuCgogICAgICAgIFJldHVybnMgYW4gQXJyYXkgb2YgaGFuZGxlcnMgYW5kIHRoZSBwYXJhbWV0ZXJzIGFzc29jaWF0ZWQKICAgICAgICB3aXRoIHRob3NlIHBhcmFtZXRlcnMuCgogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgYSBVUkwgdG8gcHJvY2VzcwoKICAgICAgICBAcmV0dXJuIHtBcnJheX0gYW4gQXJyYXkgb2YgYFtoYW5kbGVyLCBwYXJhbWV0ZXJdYCB0dXBsZXMKICAgICAgKi8KICAgICAgaGFuZGxlVVJMOiBmdW5jdGlvbih1cmwpIHsKICAgICAgICAvLyBQZXJmb3JtIGEgVVJMLWJhc2VkIHRyYW5zaXRpb24sIGJ1dCBkb24ndCBjaGFuZ2UKICAgICAgICAvLyB0aGUgVVJMIGFmdGVyd2FyZCwgc2luY2UgaXQgYWxyZWFkeSBoYXBwZW5lZC4KICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICBpZiAodXJsLmNoYXJBdCgwKSAhPT0gJy8nKSB7IGFyZ3NbMF0gPSAnLycgKyB1cmw7IH0KICAgICAgICByZXR1cm4gZG9UcmFuc2l0aW9uKHRoaXMsIGFyZ3MpLm1ldGhvZChudWxsKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgIEhvb2sgcG9pbnQgZm9yIHVwZGF0aW5nIHRoZSBVUkwuCgogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgYSBVUkwgdG8gdXBkYXRlIHRvCiAgICAgICovCiAgICAgIHVwZGF0ZVVSTDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ1cGRhdGVVUkwgaXMgbm90IGltcGxlbWVudGVkIik7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICBIb29rIHBvaW50IGZvciByZXBsYWNpbmcgdGhlIGN1cnJlbnQgVVJMLCBpLmUuIHdpdGggcmVwbGFjZVN0YXRlCgogICAgICAgIEJ5IGRlZmF1bHQgdGhpcyBiZWhhdmVzIHRoZSBzYW1lIGFzIGB1cGRhdGVVUkxgCgogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgYSBVUkwgdG8gdXBkYXRlIHRvCiAgICAgICovCiAgICAgIHJlcGxhY2VVUkw6IGZ1bmN0aW9uKHVybCkgewogICAgICAgIHRoaXMudXBkYXRlVVJMKHVybCk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICBUcmFuc2l0aW9uIGludG8gdGhlIHNwZWNpZmllZCBuYW1lZCByb3V0ZS4KCiAgICAgICAgSWYgbmVjZXNzYXJ5LCB0cmlnZ2VyIHRoZSBleGl0IGNhbGxiYWNrIG9uIGFueSBoYW5kbGVycwogICAgICAgIHRoYXQgYXJlIG5vIGxvbmdlciByZXByZXNlbnRlZCBieSB0aGUgdGFyZ2V0IHJvdXRlLgoKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSB0aGUgbmFtZSBvZiB0aGUgcm91dGUKICAgICAgKi8KICAgICAgdHJhbnNpdGlvblRvOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgcmV0dXJuIGRvVHJhbnNpdGlvbih0aGlzLCBhcmd1bWVudHMpOwogICAgICB9LAoKICAgICAgaW50ZXJtZWRpYXRlVHJhbnNpdGlvblRvOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgZG9UcmFuc2l0aW9uKHRoaXMsIGFyZ3VtZW50cywgdHJ1ZSk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICBJZGVudGljYWwgdG8gYHRyYW5zaXRpb25Ub2AgZXhjZXB0IHRoYXQgdGhlIGN1cnJlbnQgVVJMIHdpbGwgYmUgcmVwbGFjZWQKICAgICAgICBpZiBwb3NzaWJsZS4KCiAgICAgICAgVGhpcyBtZXRob2QgaXMgaW50ZW5kZWQgcHJpbWFyaWx5IGZvciB1c2Ugd2l0aCBgcmVwbGFjZVN0YXRlYC4KCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgdGhlIG5hbWUgb2YgdGhlIHJvdXRlCiAgICAgICovCiAgICAgIHJlcGxhY2VXaXRoOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgcmV0dXJuIGRvVHJhbnNpdGlvbih0aGlzLCBhcmd1bWVudHMpLm1ldGhvZCgncmVwbGFjZScpOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAgQHByaXZhdGUKCiAgICAgICAgVGhpcyBtZXRob2QgdGFrZXMgYSBoYW5kbGVyIG5hbWUgYW5kIGEgbGlzdCBvZiBjb250ZXh0cyBhbmQgcmV0dXJucwogICAgICAgIGEgc2VyaWFsaXplZCBwYXJhbWV0ZXIgaGFzaCBzdWl0YWJsZSB0byBwYXNzIHRvIGByZWNvZ25pemVyLmdlbmVyYXRlKClgLgoKICAgICAgICBAcGFyYW0ge1N0cmluZ30gaGFuZGxlck5hbWUKICAgICAgICBAcGFyYW0ge0FycmF5W09iamVjdF19IGNvbnRleHRzCiAgICAgICAgQHJldHVybiB7T2JqZWN0fSBhIHNlcmlhbGl6ZWQgcGFyYW1ldGVyIGhhc2gKICAgICAgKi8KCiAgICAgIHBhcmFtc0ZvckhhbmRsZXI6IGZ1bmN0aW9uKGhhbmRsZXJOYW1lLCBjb250ZXh0cykgewogICAgICAgIHZhciBwYXJ0aXRpb25lZEFyZ3MgPSBleHRyYWN0UXVlcnlQYXJhbXMoc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgICAgICByZXR1cm4gcGFyYW1zRm9ySGFuZGxlcih0aGlzLCBoYW5kbGVyTmFtZSwgcGFydGl0aW9uZWRBcmdzWzBdLCBwYXJ0aXRpb25lZEFyZ3NbMV0pOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAgVGhpcyBtZXRob2QgdGFrZXMgYSBoYW5kbGVyIG5hbWUgYW5kIHJldHVybnMgYSBsaXN0IG9mIHF1ZXJ5IHBhcmFtcwogICAgICAgIHRoYXQgYXJlIHZhbGlkIHRvIHBhc3MgdG8gdGhlIGhhbmRsZXIgb3IgaXRzIHBhcmVudHMKCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGhhbmRsZXJOYW1lCiAgICAgICAgQHJldHVybiB7QXJyYXlbU3RyaW5nXX0gYSBsaXN0IG9mIHF1ZXJ5IHBhcmFtZXRlcnMKICAgICAgKi8KICAgICAgcXVlcnlQYXJhbXNGb3JIYW5kbGVyOiBmdW5jdGlvbiAoaGFuZGxlck5hbWUpIHsKICAgICAgICByZXR1cm4gcXVlcnlQYXJhbXNGb3JIYW5kbGVyKHRoaXMsIGhhbmRsZXJOYW1lKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgIFRha2UgYSBuYW1lZCByb3V0ZSBhbmQgY29udGV4dCBvYmplY3RzIGFuZCBnZW5lcmF0ZSBhCiAgICAgICAgVVJMLgoKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSB0aGUgbmFtZSBvZiB0aGUgcm91dGUgdG8gZ2VuZXJhdGUKICAgICAgICAgIGEgVVJMIGZvcgogICAgICAgIEBwYXJhbSB7Li4uT2JqZWN0fSBvYmplY3RzIGEgbGlzdCBvZiBvYmplY3RzIHRvIHNlcmlhbGl6ZQoKICAgICAgICBAcmV0dXJuIHtTdHJpbmd9IGEgVVJMCiAgICAgICovCiAgICAgIGdlbmVyYXRlOiBmdW5jdGlvbihoYW5kbGVyTmFtZSkgewogICAgICAgIHZhciBwYXJ0aXRpb25lZEFyZ3MgPSBleHRyYWN0UXVlcnlQYXJhbXMoc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKSwKICAgICAgICAgIHN1cHBsaWVkUGFyYW1zID0gcGFydGl0aW9uZWRBcmdzWzBdLAogICAgICAgICAgcXVlcnlQYXJhbXMgPSBwYXJ0aXRpb25lZEFyZ3NbMV07CgogICAgICAgIHZhciBwYXJhbXMgPSBwYXJhbXNGb3JIYW5kbGVyKHRoaXMsIGhhbmRsZXJOYW1lLCBzdXBwbGllZFBhcmFtcywgcXVlcnlQYXJhbXMpLAogICAgICAgICAgdmFsaWRRdWVyeVBhcmFtcyA9IHF1ZXJ5UGFyYW1zRm9ySGFuZGxlcih0aGlzLCBoYW5kbGVyTmFtZSk7CgogICAgICAgIHZhciBtaXNzaW5nUGFyYW1zID0gW107CgogICAgICAgIGZvciAodmFyIGtleSBpbiBxdWVyeVBhcmFtcykgewogICAgICAgICAgaWYgKHF1ZXJ5UGFyYW1zLmhhc093blByb3BlcnR5KGtleSkgJiYgIX52YWxpZFF1ZXJ5UGFyYW1zLmluZGV4T2Yoa2V5KSkgewogICAgICAgICAgICBtaXNzaW5nUGFyYW1zLnB1c2goa2V5KTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChtaXNzaW5nUGFyYW1zLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHZhciBlcnIgPSAnWW91IHN1cHBsaWVkIHRoZSBwYXJhbXMgJzsKICAgICAgICAgIGVyciArPSBtaXNzaW5nUGFyYW1zLm1hcChmdW5jdGlvbihwYXJhbSkgewogICAgICAgICAgICByZXR1cm4gJyInICsgcGFyYW0gKyAiPSIgKyBxdWVyeVBhcmFtc1twYXJhbV0gKyAnIic7CiAgICAgICAgICB9KS5qb2luKCcgYW5kICcpOwoKICAgICAgICAgIGVyciArPSAnIHdoaWNoIGFyZSBub3QgdmFsaWQgZm9yIHRoZSAiJyArIGhhbmRsZXJOYW1lICsgJyIgaGFuZGxlciBvciBpdHMgcGFyZW50cyc7CgogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycik7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy5yZWNvZ25pemVyLmdlbmVyYXRlKGhhbmRsZXJOYW1lLCBwYXJhbXMpOwogICAgICB9LAoKICAgICAgaXNBY3RpdmU6IGZ1bmN0aW9uKGhhbmRsZXJOYW1lKSB7CiAgICAgICAgdmFyIHBhcnRpdGlvbmVkQXJncyAgID0gZXh0cmFjdFF1ZXJ5UGFyYW1zKHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSksCiAgICAgICAgICAgIGNvbnRleHRzICAgICAgICAgID0gcGFydGl0aW9uZWRBcmdzWzBdLAogICAgICAgICAgICBxdWVyeVBhcmFtcyAgICAgICA9IHBhcnRpdGlvbmVkQXJnc1sxXSwKICAgICAgICAgICAgYWN0aXZlUXVlcnlQYXJhbXMgID0ge30sCiAgICAgICAgICAgIGVmZmVjdGl2ZVF1ZXJ5UGFyYW1zID0ge307CgogICAgICAgIHZhciB0YXJnZXRIYW5kbGVySW5mb3MgPSB0aGlzLnRhcmdldEhhbmRsZXJJbmZvcywKICAgICAgICAgICAgZm91bmQgPSBmYWxzZSwgbmFtZXMsIG9iamVjdCwgaGFuZGxlckluZm8sIGhhbmRsZXJPYmo7CgogICAgICAgIGlmICghdGFyZ2V0SGFuZGxlckluZm9zKSB7IHJldHVybiBmYWxzZTsgfQoKICAgICAgICB2YXIgcmVjb2dIYW5kbGVycyA9IHRoaXMucmVjb2duaXplci5oYW5kbGVyc0Zvcih0YXJnZXRIYW5kbGVySW5mb3NbdGFyZ2V0SGFuZGxlckluZm9zLmxlbmd0aCAtIDFdLm5hbWUpOwogICAgICAgIGZvciAodmFyIGk9dGFyZ2V0SGFuZGxlckluZm9zLmxlbmd0aC0xOyBpPj0wOyBpLS0pIHsKICAgICAgICAgIGhhbmRsZXJJbmZvID0gdGFyZ2V0SGFuZGxlckluZm9zW2ldOwogICAgICAgICAgaWYgKGhhbmRsZXJJbmZvLm5hbWUgPT09IGhhbmRsZXJOYW1lKSB7IGZvdW5kID0gdHJ1ZTsgfQoKICAgICAgICAgIGlmIChmb3VuZCkgewogICAgICAgICAgICB2YXIgcmVjb2dIYW5kbGVyID0gcmVjb2dIYW5kbGVyc1tpXTsKCiAgICAgICAgICAgIG1lcmdlKGFjdGl2ZVF1ZXJ5UGFyYW1zLCBoYW5kbGVySW5mby5xdWVyeVBhcmFtcyk7CiAgICAgICAgICAgIGlmIChxdWVyeVBhcmFtcyAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICBtZXJnZShlZmZlY3RpdmVRdWVyeVBhcmFtcywgaGFuZGxlckluZm8ucXVlcnlQYXJhbXMpOwogICAgICAgICAgICAgIG1lcmdlU29tZUtleXMoZWZmZWN0aXZlUXVlcnlQYXJhbXMsIHF1ZXJ5UGFyYW1zLCByZWNvZ0hhbmRsZXIucXVlcnlQYXJhbXMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaGFuZGxlckluZm8uaXNEeW5hbWljICYmIGNvbnRleHRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBvYmplY3QgPSBjb250ZXh0cy5wb3AoKTsKCiAgICAgICAgICAgICAgaWYgKGlzUGFyYW0ob2JqZWN0KSkgewogICAgICAgICAgICAgICAgdmFyIG5hbWUgPSByZWNvZ0hhbmRsZXIubmFtZXNbMF07CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY3VycmVudFBhcmFtcyB8fCAiIiArIG9iamVjdCAhPT0gdGhpcy5jdXJyZW50UGFyYW1zW25hbWVdKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFuZGxlckluZm8uY29udGV4dCAhPT0gb2JqZWN0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKCiAgICAgICAgcmV0dXJuIGNvbnRleHRzLmxlbmd0aCA9PT0gMCAmJiBmb3VuZCAmJiBxdWVyeVBhcmFtc0VxdWFsKGFjdGl2ZVF1ZXJ5UGFyYW1zLCBlZmZlY3RpdmVRdWVyeVBhcmFtcyk7CiAgICAgIH0sCgogICAgICB0cmlnZ2VyOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgdHJpZ2dlcih0aGlzLCB0aGlzLmN1cnJlbnRIYW5kbGVySW5mb3MsIGZhbHNlLCBhcmdzKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgIEhvb2sgcG9pbnQgZm9yIGxvZ2dpbmcgdHJhbnNpdGlvbiBzdGF0dXMgdXBkYXRlcy4KCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2UgVGhlIG1lc3NhZ2UgdG8gbG9nLgogICAgICAqLwogICAgICBsb2c6IG51bGwKICAgIH07CgogICAgLyoqCiAgICAgIEBwcml2YXRlCgogICAgICBVc2VkIGludGVybmFsbHkgZm9yIGJvdGggVVJMIGFuZCBuYW1lZCB0cmFuc2l0aW9uIHRvIGRldGVybWluZQogICAgICBhIHNoYXJlZCBwaXZvdCBwYXJlbnQgcm91dGUgYW5kIG90aGVyIGRhdGEgbmVjZXNzYXJ5IHRvIHBlcmZvcm0KICAgICAgYSB0cmFuc2l0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBnZXRNYXRjaFBvaW50KHJvdXRlciwgaGFuZGxlcnMsIG9iamVjdHMsIGlucHV0UGFyYW1zLCBxdWVyeVBhcmFtcykgewoKICAgICAgdmFyIG1hdGNoUG9pbnQgPSBoYW5kbGVycy5sZW5ndGgsCiAgICAgICAgICBwcm92aWRlZE1vZGVscyA9IHt9LCBpLAogICAgICAgICAgY3VycmVudEhhbmRsZXJJbmZvcyA9IHJvdXRlci5jdXJyZW50SGFuZGxlckluZm9zIHx8IFtdLAogICAgICAgICAgcGFyYW1zID0ge30sCiAgICAgICAgICBvbGRQYXJhbXMgPSByb3V0ZXIuY3VycmVudFBhcmFtcyB8fCB7fSwKICAgICAgICAgIGFjdGl2ZVRyYW5zaXRpb24gPSByb3V0ZXIuYWN0aXZlVHJhbnNpdGlvbiwKICAgICAgICAgIGhhbmRsZXJQYXJhbXMgPSB7fSwKICAgICAgICAgIG9iajsKCiAgICAgIG9iamVjdHMgPSBzbGljZS5jYWxsKG9iamVjdHMpOwogICAgICBtZXJnZShwYXJhbXMsIGlucHV0UGFyYW1zKTsKCiAgICAgIGZvciAoaSA9IGhhbmRsZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgdmFyIGhhbmRsZXJPYmogPSBoYW5kbGVyc1tpXSwKICAgICAgICAgICAgaGFuZGxlck5hbWUgPSBoYW5kbGVyT2JqLmhhbmRsZXIsCiAgICAgICAgICAgIG9sZEhhbmRsZXJJbmZvID0gY3VycmVudEhhbmRsZXJJbmZvc1tpXSwKICAgICAgICAgICAgaGFzQ2hhbmdlZCA9IGZhbHNlOwoKICAgICAgICAvLyBDaGVjayBpZiBoYW5kbGVyIG5hbWVzIGhhdmUgY2hhbmdlZC4KICAgICAgICBpZiAoIW9sZEhhbmRsZXJJbmZvIHx8IG9sZEhhbmRsZXJJbmZvLm5hbWUgIT09IGhhbmRsZXJPYmouaGFuZGxlcikgeyBoYXNDaGFuZ2VkID0gdHJ1ZTsgfQoKICAgICAgICBpZiAoaGFuZGxlck9iai5pc0R5bmFtaWMpIHsKICAgICAgICAgIC8vIFVSTCB0cmFuc2l0aW9uLgoKICAgICAgICAgIGlmIChvYmogPSBnZXRNYXRjaFBvaW50T2JqZWN0KG9iamVjdHMsIGhhbmRsZXJOYW1lLCBhY3RpdmVUcmFuc2l0aW9uLCB0cnVlLCBwYXJhbXMpKSB7CiAgICAgICAgICAgIGhhc0NoYW5nZWQgPSB0cnVlOwogICAgICAgICAgICBwcm92aWRlZE1vZGVsc1toYW5kbGVyTmFtZV0gPSBvYmo7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBoYW5kbGVyUGFyYW1zW2hhbmRsZXJOYW1lXSA9IHt9OwogICAgICAgICAgICBmb3IgKHZhciBwcm9wIGluIGhhbmRsZXJPYmoucGFyYW1zKSB7CiAgICAgICAgICAgICAgaWYgKCFoYW5kbGVyT2JqLnBhcmFtcy5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgeyBjb250aW51ZTsgfQogICAgICAgICAgICAgIHZhciBuZXdQYXJhbSA9IGhhbmRsZXJPYmoucGFyYW1zW3Byb3BdOwogICAgICAgICAgICAgIGlmIChvbGRQYXJhbXNbcHJvcF0gIT09IG5ld1BhcmFtKSB7IGhhc0NoYW5nZWQgPSB0cnVlOyB9CiAgICAgICAgICAgICAgaGFuZGxlclBhcmFtc1toYW5kbGVyTmFtZV1bcHJvcF0gPSBwYXJhbXNbcHJvcF0gPSBuZXdQYXJhbTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoaGFuZGxlck9iai5oYXNPd25Qcm9wZXJ0eSgnbmFtZXMnKSkgewogICAgICAgICAgLy8gTmFtZWQgdHJhbnNpdGlvbi4KCiAgICAgICAgICBpZiAob2JqZWN0cy5sZW5ndGgpIHsgaGFzQ2hhbmdlZCA9IHRydWU7IH0KCiAgICAgICAgICBpZiAob2JqID0gZ2V0TWF0Y2hQb2ludE9iamVjdChvYmplY3RzLCBoYW5kbGVyTmFtZSwgYWN0aXZlVHJhbnNpdGlvbiwgaGFuZGxlck9iai5uYW1lc1swXSwgcGFyYW1zKSkgewogICAgICAgICAgICBwcm92aWRlZE1vZGVsc1toYW5kbGVyTmFtZV0gPSBvYmo7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbmFtZXMgPSBoYW5kbGVyT2JqLm5hbWVzOwogICAgICAgICAgICBoYW5kbGVyUGFyYW1zW2hhbmRsZXJOYW1lXSA9IHt9OwogICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgbGVuID0gbmFtZXMubGVuZ3RoOyBqIDwgbGVuOyArK2opIHsKICAgICAgICAgICAgICB2YXIgbmFtZSA9IG5hbWVzW2pdOwogICAgICAgICAgICAgIGhhbmRsZXJQYXJhbXNbaGFuZGxlck5hbWVdW25hbWVdID0gcGFyYW1zW25hbWVdID0gcGFyYW1zW25hbWVdIHx8IG9sZFBhcmFtc1tuYW1lXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gSWYgdGhlcmUgaXMgYW4gb2xkIGhhbmRsZXIsIHNlZSBpZiBxdWVyeSBwYXJhbXMgYXJlIHRoZSBzYW1lLiBJZiB0aGVyZSBpc24ndCBhbiBvbGQgaGFuZGxlciwKICAgICAgICAvLyBoYXNDaGFuZ2VkIHdpbGwgYWxyZWFkeSBiZSB0cnVlIGhlcmUKICAgICAgICBpZihvbGRIYW5kbGVySW5mbyAmJiAhcXVlcnlQYXJhbXNFcXVhbChvbGRIYW5kbGVySW5mby5xdWVyeVBhcmFtcywgaGFuZGxlck9iai5xdWVyeVBhcmFtcykpIHsKICAgICAgICAgICAgaGFzQ2hhbmdlZCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiAoaGFzQ2hhbmdlZCkgeyBtYXRjaFBvaW50ID0gaTsgfQogICAgICB9CgogICAgICBpZiAob2JqZWN0cy5sZW5ndGggPiAwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJNb3JlIGNvbnRleHQgb2JqZWN0cyB3ZXJlIHBhc3NlZCB0aGFuIHRoZXJlIGFyZSBkeW5hbWljIHNlZ21lbnRzIGZvciB0aGUgcm91dGU6ICIgKyBoYW5kbGVyc1toYW5kbGVycy5sZW5ndGggLSAxXS5oYW5kbGVyKTsKICAgICAgfQoKICAgICAgdmFyIHBpdm90SGFuZGxlckluZm8gPSBjdXJyZW50SGFuZGxlckluZm9zW21hdGNoUG9pbnQgLSAxXSwKICAgICAgICAgIHBpdm90SGFuZGxlciA9IHBpdm90SGFuZGxlckluZm8gJiYgcGl2b3RIYW5kbGVySW5mby5oYW5kbGVyOwoKICAgICAgcmV0dXJuIHsgbWF0Y2hQb2ludDogbWF0Y2hQb2ludCwgcHJvdmlkZWRNb2RlbHM6IHByb3ZpZGVkTW9kZWxzLCBwYXJhbXM6IHBhcmFtcywgaGFuZGxlclBhcmFtczogaGFuZGxlclBhcmFtcywgcGl2b3RIYW5kbGVyOiBwaXZvdEhhbmRsZXIgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRNYXRjaFBvaW50T2JqZWN0KG9iamVjdHMsIGhhbmRsZXJOYW1lLCBhY3RpdmVUcmFuc2l0aW9uLCBwYXJhbU5hbWUsIHBhcmFtcykgewoKICAgICAgaWYgKG9iamVjdHMubGVuZ3RoICYmIHBhcmFtTmFtZSkgewoKICAgICAgICB2YXIgb2JqZWN0ID0gb2JqZWN0cy5wb3AoKTsKCiAgICAgICAgLy8gSWYgcHJvdmlkZWQgb2JqZWN0IGlzIHN0cmluZyBvciBudW1iZXIsIHRyZWF0IGFzIHBhcmFtLgogICAgICAgIGlmIChpc1BhcmFtKG9iamVjdCkpIHsKICAgICAgICAgIHBhcmFtc1twYXJhbU5hbWVdID0gb2JqZWN0LnRvU3RyaW5nKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGFjdGl2ZVRyYW5zaXRpb24pIHsKICAgICAgICAvLyBVc2UgbW9kZWwgZnJvbSBwcmV2aW91cyB0cmFuc2l0aW9uIGF0dGVtcHQsIHByZWZlcmFibHkgdGhlIHJlc29sdmVkIG9uZS4KICAgICAgICByZXR1cm4gYWN0aXZlVHJhbnNpdGlvbi5yZXNvbHZlZE1vZGVsc1toYW5kbGVyTmFtZV0gfHwKICAgICAgICAgICAgICAgKHBhcmFtTmFtZSAmJiBhY3RpdmVUcmFuc2l0aW9uLnByb3ZpZGVkTW9kZWxzW2hhbmRsZXJOYW1lXSk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpc1BhcmFtKG9iamVjdCkgewogICAgICByZXR1cm4gKHR5cGVvZiBvYmplY3QgPT09ICJzdHJpbmciIHx8IG9iamVjdCBpbnN0YW5jZW9mIFN0cmluZyB8fCB0eXBlb2Ygb2JqZWN0ID09PSAibnVtYmVyIiB8fCBvYmplY3QgaW5zdGFuY2VvZiBOdW1iZXIpOwogICAgfQoKCgogICAgLyoqCiAgICAgIEBwcml2YXRlCgogICAgICBUaGlzIG1ldGhvZCB0YWtlcyBhIGhhbmRsZXIgbmFtZSBhbmQgcmV0dXJucyBhIGxpc3Qgb2YgcXVlcnkgcGFyYW1zCiAgICAgIHRoYXQgYXJlIHZhbGlkIHRvIHBhc3MgdG8gdGhlIGhhbmRsZXIgb3IgaXRzIHBhcmVudHMKCiAgICAgIEBwYXJhbSB7Um91dGVyfSByb3V0ZXIKICAgICAgQHBhcmFtIHtTdHJpbmd9IGhhbmRsZXJOYW1lCiAgICAgIEByZXR1cm4ge0FycmF5W1N0cmluZ119IGEgbGlzdCBvZiBxdWVyeSBwYXJhbWV0ZXJzCiAgICAqLwogICAgZnVuY3Rpb24gcXVlcnlQYXJhbXNGb3JIYW5kbGVyKHJvdXRlciwgaGFuZGxlck5hbWUpIHsKICAgICAgdmFyIGhhbmRsZXJzID0gcm91dGVyLnJlY29nbml6ZXIuaGFuZGxlcnNGb3IoaGFuZGxlck5hbWUpLAogICAgICAgIHF1ZXJ5UGFyYW1zID0gW107CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhhbmRsZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcXVlcnlQYXJhbXMucHVzaC5hcHBseShxdWVyeVBhcmFtcywgaGFuZGxlcnNbaV0ucXVlcnlQYXJhbXMgfHwgW10pOwogICAgICB9CgogICAgICByZXR1cm4gcXVlcnlQYXJhbXM7CiAgICB9CiAgICAvKioKICAgICAgQHByaXZhdGUKCiAgICAgIFRoaXMgbWV0aG9kIHRha2VzIGEgaGFuZGxlciBuYW1lIGFuZCBhIGxpc3Qgb2YgY29udGV4dHMgYW5kIHJldHVybnMKICAgICAgYSBzZXJpYWxpemVkIHBhcmFtZXRlciBoYXNoIHN1aXRhYmxlIHRvIHBhc3MgdG8gYHJlY29nbml6ZXIuZ2VuZXJhdGUoKWAuCgogICAgICBAcGFyYW0ge1JvdXRlcn0gcm91dGVyCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBoYW5kbGVyTmFtZQogICAgICBAcGFyYW0ge0FycmF5W09iamVjdF19IG9iamVjdHMKICAgICAgQHJldHVybiB7T2JqZWN0fSBhIHNlcmlhbGl6ZWQgcGFyYW1ldGVyIGhhc2gKICAgICovCiAgICBmdW5jdGlvbiBwYXJhbXNGb3JIYW5kbGVyKHJvdXRlciwgaGFuZGxlck5hbWUsIG9iamVjdHMsIHF1ZXJ5UGFyYW1zKSB7CgogICAgICB2YXIgaGFuZGxlcnMgPSByb3V0ZXIucmVjb2duaXplci5oYW5kbGVyc0ZvcihoYW5kbGVyTmFtZSksCiAgICAgICAgICBwYXJhbXMgPSB7fSwKICAgICAgICAgIGhhbmRsZXJJbmZvcyA9IGdlbmVyYXRlSGFuZGxlckluZm9zV2l0aFF1ZXJ5UGFyYW1zKHJvdXRlciwgaGFuZGxlcnMsIHF1ZXJ5UGFyYW1zKSwKICAgICAgICAgIG1hdGNoUG9pbnQgPSBnZXRNYXRjaFBvaW50KHJvdXRlciwgaGFuZGxlckluZm9zLCBvYmplY3RzKS5tYXRjaFBvaW50LAogICAgICAgICAgbWVyZ2VkUXVlcnlQYXJhbXMgPSB7fSwKICAgICAgICAgIG9iamVjdCwgaGFuZGxlck9iaiwgaGFuZGxlciwgbmFtZXMsIGk7CgogICAgICBwYXJhbXMucXVlcnlQYXJhbXMgPSB7fTsKCiAgICAgIGZvciAoaT0wOyBpPGhhbmRsZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaGFuZGxlck9iaiA9IGhhbmRsZXJzW2ldOwogICAgICAgIGhhbmRsZXIgPSByb3V0ZXIuZ2V0SGFuZGxlcihoYW5kbGVyT2JqLmhhbmRsZXIpOwogICAgICAgIG5hbWVzID0gaGFuZGxlck9iai5uYW1lczsKCiAgICAgICAgLy8gSWYgaXQncyBhIGR5bmFtaWMgc2VnbWVudAogICAgICAgIGlmIChuYW1lcy5sZW5ndGgpIHsKICAgICAgICAgIC8vIElmIHdlIGhhdmUgb2JqZWN0cywgdXNlIHRoZW0KICAgICAgICAgIGlmIChpID49IG1hdGNoUG9pbnQpIHsKICAgICAgICAgICAgb2JqZWN0ID0gb2JqZWN0cy5zaGlmdCgpOwogICAgICAgICAgLy8gT3RoZXJ3aXNlIHVzZSBleGlzdGluZyBjb250ZXh0CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBvYmplY3QgPSBoYW5kbGVyLmNvbnRleHQ7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gU2VyaWFsaXplIHRvIGdlbmVyYXRlIHBhcmFtcwogICAgICAgICAgbWVyZ2UocGFyYW1zLCBzZXJpYWxpemUoaGFuZGxlciwgb2JqZWN0LCBuYW1lcykpOwogICAgICAgIH0KICAgICAgICBpZiAocXVlcnlQYXJhbXMgIT09IGZhbHNlKSB7CiAgICAgICAgICBtZXJnZVNvbWVLZXlzKHBhcmFtcy5xdWVyeVBhcmFtcywgcm91dGVyLmN1cnJlbnRRdWVyeVBhcmFtcywgaGFuZGxlck9iai5xdWVyeVBhcmFtcyk7CiAgICAgICAgICBtZXJnZVNvbWVLZXlzKHBhcmFtcy5xdWVyeVBhcmFtcywgcXVlcnlQYXJhbXMsIGhhbmRsZXJPYmoucXVlcnlQYXJhbXMpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHF1ZXJ5UGFyYW1zRXF1YWwocGFyYW1zLnF1ZXJ5UGFyYW1zLCB7fSkpIHsgZGVsZXRlIHBhcmFtcy5xdWVyeVBhcmFtczsgfQogICAgICByZXR1cm4gcGFyYW1zOwogICAgfQoKICAgIGZ1bmN0aW9uIG1lcmdlKGhhc2gsIG90aGVyKSB7CiAgICAgIGZvciAodmFyIHByb3AgaW4gb3RoZXIpIHsKICAgICAgICBpZiAob3RoZXIuaGFzT3duUHJvcGVydHkocHJvcCkpIHsgaGFzaFtwcm9wXSA9IG90aGVyW3Byb3BdOyB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBtZXJnZVNvbWVLZXlzKGhhc2gsIG90aGVyLCBrZXlzKSB7CiAgICAgIGlmICghb3RoZXIgfHwgIWtleXMpIHsgcmV0dXJuOyB9CiAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGtleSA9IGtleXNbaV0sIHZhbHVlOwogICAgICAgIGlmKG90aGVyLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgIHZhbHVlID0gb3RoZXJba2V5XTsKICAgICAgICAgIGlmKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSBmYWxzZSB8fCB0eXBlb2YgdmFsdWUgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIGRlbGV0ZSBoYXNoW2tleV07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBoYXNoW2tleV0gPSBvdGhlcltrZXldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICBAcHJpdmF0ZQogICAgKi8KCiAgICBmdW5jdGlvbiBnZW5lcmF0ZUhhbmRsZXJJbmZvc1dpdGhRdWVyeVBhcmFtcyhyb3V0ZXIsIGhhbmRsZXJzLCBxdWVyeVBhcmFtcykgewogICAgICB2YXIgaGFuZGxlckluZm9zID0gW107CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhhbmRsZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGhhbmRsZXIgPSBoYW5kbGVyc1tpXSwKICAgICAgICAgIGhhbmRsZXJJbmZvID0geyBoYW5kbGVyOiBoYW5kbGVyLmhhbmRsZXIsIG5hbWVzOiBoYW5kbGVyLm5hbWVzLCBjb250ZXh0OiBoYW5kbGVyLmNvbnRleHQsIGlzRHluYW1pYzogaGFuZGxlci5pc0R5bmFtaWMgfSwKICAgICAgICAgIGFjdGl2ZVF1ZXJ5UGFyYW1zID0ge307CgogICAgICAgIGlmIChxdWVyeVBhcmFtcyAhPT0gZmFsc2UpIHsKICAgICAgICAgIG1lcmdlU29tZUtleXMoYWN0aXZlUXVlcnlQYXJhbXMsIHJvdXRlci5jdXJyZW50UXVlcnlQYXJhbXMsIGhhbmRsZXIucXVlcnlQYXJhbXMpOwogICAgICAgICAgbWVyZ2VTb21lS2V5cyhhY3RpdmVRdWVyeVBhcmFtcywgcXVlcnlQYXJhbXMsIGhhbmRsZXIucXVlcnlQYXJhbXMpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGhhbmRsZXIucXVlcnlQYXJhbXMgJiYgaGFuZGxlci5xdWVyeVBhcmFtcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICBoYW5kbGVySW5mby5xdWVyeVBhcmFtcyA9IGFjdGl2ZVF1ZXJ5UGFyYW1zOwogICAgICAgIH0KCiAgICAgICAgaGFuZGxlckluZm9zLnB1c2goaGFuZGxlckluZm8pOwogICAgICB9CgogICAgICByZXR1cm4gaGFuZGxlckluZm9zOwogICAgfQoKICAgIC8qKgogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZVF1ZXJ5UGFyYW1UcmFuc2l0aW9uKHJvdXRlciwgcXVlcnlQYXJhbXMsIGlzSW50ZXJtZWRpYXRlKSB7CiAgICAgIHZhciBjdXJyZW50SGFuZGxlcnMgPSByb3V0ZXIuY3VycmVudEhhbmRsZXJJbmZvcywKICAgICAgICAgIGN1cnJlbnRIYW5kbGVyID0gY3VycmVudEhhbmRsZXJzW2N1cnJlbnRIYW5kbGVycy5sZW5ndGggLSAxXSwKICAgICAgICAgIG5hbWUgPSBjdXJyZW50SGFuZGxlci5uYW1lOwoKICAgICAgbG9nKHJvdXRlciwgIkF0dGVtcHRpbmcgcXVlcnkgcGFyYW0gdHJhbnNpdGlvbiIpOwoKICAgICAgcmV0dXJuIGNyZWF0ZU5hbWVkVHJhbnNpdGlvbihyb3V0ZXIsIFtuYW1lLCBxdWVyeVBhcmFtc10sIGlzSW50ZXJtZWRpYXRlKTsKICAgIH0KCiAgICAvKioKICAgICAgQHByaXZhdGUKICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVOYW1lZFRyYW5zaXRpb24ocm91dGVyLCBhcmdzLCBpc0ludGVybWVkaWF0ZSkgewogICAgICB2YXIgcGFydGl0aW9uZWRBcmdzICAgICA9IGV4dHJhY3RRdWVyeVBhcmFtcyhhcmdzKSwKICAgICAgICBwdXJlQXJncyAgICAgICAgICAgICAgPSBwYXJ0aXRpb25lZEFyZ3NbMF0sCiAgICAgICAgcXVlcnlQYXJhbXMgICAgICAgICAgID0gcGFydGl0aW9uZWRBcmdzWzFdLAogICAgICAgIGhhbmRsZXJzICAgICAgICAgICAgICA9IHJvdXRlci5yZWNvZ25pemVyLmhhbmRsZXJzRm9yKHB1cmVBcmdzWzBdKSwKICAgICAgICBoYW5kbGVySW5mb3MgICAgICAgICAgPSBnZW5lcmF0ZUhhbmRsZXJJbmZvc1dpdGhRdWVyeVBhcmFtcyhyb3V0ZXIsIGhhbmRsZXJzLCBxdWVyeVBhcmFtcyk7CgoKICAgICAgbG9nKHJvdXRlciwgIkF0dGVtcHRpbmcgdHJhbnNpdGlvbiB0byAiICsgcHVyZUFyZ3NbMF0pOwoKICAgICAgcmV0dXJuIHBlcmZvcm1UcmFuc2l0aW9uKHJvdXRlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXJJbmZvcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNsaWNlLmNhbGwocHVyZUFyZ3MsIDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcm91dGVyLmN1cnJlbnRQYXJhbXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBxdWVyeVBhcmFtcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0ludGVybWVkaWF0ZSk7CiAgICB9CgogICAgLyoqCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlVVJMVHJhbnNpdGlvbihyb3V0ZXIsIHVybCwgaXNJbnRlcm1lZGlhdGUpIHsKICAgICAgdmFyIHJlc3VsdHMgPSByb3V0ZXIucmVjb2duaXplci5yZWNvZ25pemUodXJsKSwKICAgICAgICAgIGN1cnJlbnRIYW5kbGVySW5mb3MgPSByb3V0ZXIuY3VycmVudEhhbmRsZXJJbmZvcywKICAgICAgICAgIHF1ZXJ5UGFyYW1zID0ge30sCiAgICAgICAgICBpLCBsZW47CgogICAgICBsb2cocm91dGVyLCAiQXR0ZW1wdGluZyBVUkwgdHJhbnNpdGlvbiB0byAiICsgdXJsKTsKCiAgICAgIGlmIChyZXN1bHRzKSB7CiAgICAgICAgLy8gTWFrZSBzdXJlIHRoaXMgcm91dGUgaXMgYWN0dWFsbHkgYWNjZXNzaWJsZSBieSBVUkwuCiAgICAgICAgZm9yIChpID0gMCwgbGVuID0gcmVzdWx0cy5sZW5ndGg7IGkgPCBsZW47ICsraSkgewoKICAgICAgICAgIGlmIChyb3V0ZXIuZ2V0SGFuZGxlcihyZXN1bHRzW2ldLmhhbmRsZXIpLmluYWNjZXNzaWJsZUJ5VVJMKSB7CiAgICAgICAgICAgIHJlc3VsdHMgPSBudWxsOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICghcmVzdWx0cykgewogICAgICAgIHJldHVybiBlcnJvclRyYW5zaXRpb24ocm91dGVyLCBuZXcgUm91dGVyLlVucmVjb2duaXplZFVSTEVycm9yKHVybCkpOwogICAgICB9CgogICAgICBmb3IoaSA9IDAsIGxlbiA9IHJlc3VsdHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBtZXJnZShxdWVyeVBhcmFtcywgcmVzdWx0c1tpXS5xdWVyeVBhcmFtcyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBwZXJmb3JtVHJhbnNpdGlvbihyb3V0ZXIsIHJlc3VsdHMsIFtdLCB7fSwgcXVlcnlQYXJhbXMsIG51bGwsIGlzSW50ZXJtZWRpYXRlKTsKICAgIH0KCgogICAgLyoqCiAgICAgIEBwcml2YXRlCgogICAgICBUYWtlcyBhbiBBcnJheSBvZiBgSGFuZGxlckluZm9gcywgZmlndXJlcyBvdXQgd2hpY2ggb25lcyBhcmUKICAgICAgZXhpdGluZywgZW50ZXJpbmcsIG9yIGNoYW5naW5nIGNvbnRleHRzLCBhbmQgY2FsbHMgdGhlCiAgICAgIHByb3BlciBoYW5kbGVyIGhvb2tzLgoKICAgICAgRm9yIGV4YW1wbGUsIGNvbnNpZGVyIHRoZSBmb2xsb3dpbmcgdHJlZSBvZiBoYW5kbGVycy4gRWFjaCBoYW5kbGVyIGlzCiAgICAgIGZvbGxvd2VkIGJ5IHRoZSBVUkwgc2VnbWVudCBpdCBoYW5kbGVzLgoKICAgICAgYGBgCiAgICAgIHx+aW5kZXggKCIvIikKICAgICAgfCB8fnBvc3RzICgiL3Bvc3RzIikKICAgICAgfCB8IHwtc2hvd1Bvc3QgKCIvOmlkIikKICAgICAgfCB8IHwtbmV3UG9zdCAoIi9uZXciKQogICAgICB8IHwgfC1lZGl0UG9zdCAoIi9lZGl0IikKICAgICAgfCB8fmFib3V0ICgiL2Fib3V0LzppZCIpCiAgICAgIGBgYAoKICAgICAgQ29uc2lkZXIgdGhlIGZvbGxvd2luZyB0cmFuc2l0aW9uczoKCiAgICAgIDEuIEEgVVJMIHRyYW5zaXRpb24gdG8gYC9wb3N0cy8xYC4KICAgICAgICAgMS4gVHJpZ2dlcnMgdGhlIGAqbW9kZWxgIGNhbGxiYWNrcyBvbiB0aGUKICAgICAgICAgICAgYGluZGV4YCwgYHBvc3RzYCwgYW5kIGBzaG93UG9zdGAgaGFuZGxlcnMKICAgICAgICAgMi4gVHJpZ2dlcnMgdGhlIGBlbnRlcmAgY2FsbGJhY2sgb24gdGhlIHNhbWUKICAgICAgICAgMy4gVHJpZ2dlcnMgdGhlIGBzZXR1cGAgY2FsbGJhY2sgb24gdGhlIHNhbWUKICAgICAgMi4gQSBkaXJlY3QgdHJhbnNpdGlvbiB0byBgbmV3UG9zdGAKICAgICAgICAgMS4gVHJpZ2dlcnMgdGhlIGBleGl0YCBjYWxsYmFjayBvbiBgc2hvd1Bvc3RgCiAgICAgICAgIDIuIFRyaWdnZXJzIHRoZSBgZW50ZXJgIGNhbGxiYWNrIG9uIGBuZXdQb3N0YAogICAgICAgICAzLiBUcmlnZ2VycyB0aGUgYHNldHVwYCBjYWxsYmFjayBvbiBgbmV3UG9zdGAKICAgICAgMy4gQSBkaXJlY3QgdHJhbnNpdGlvbiB0byBgYWJvdXRgIHdpdGggYSBzcGVjaWZpZWQKICAgICAgICAgY29udGV4dCBvYmplY3QKICAgICAgICAgMS4gVHJpZ2dlcnMgdGhlIGBleGl0YCBjYWxsYmFjayBvbiBgbmV3UG9zdGAKICAgICAgICAgICAgYW5kIGBwb3N0c2AKICAgICAgICAgMi4gVHJpZ2dlcnMgdGhlIGBzZXJpYWxpemVgIGNhbGxiYWNrIG9uIGBhYm91dGAKICAgICAgICAgMy4gVHJpZ2dlcnMgdGhlIGBlbnRlcmAgY2FsbGJhY2sgb24gYGFib3V0YAogICAgICAgICA0LiBUcmlnZ2VycyB0aGUgYHNldHVwYCBjYWxsYmFjayBvbiBgYWJvdXRgCgogICAgICBAcGFyYW0ge1RyYW5zaXRpb259IHRyYW5zaXRpb24KICAgICAgQHBhcmFtIHtBcnJheVtIYW5kbGVySW5mb119IGhhbmRsZXJJbmZvcwogICAgKi8KICAgIGZ1bmN0aW9uIHNldHVwQ29udGV4dHModHJhbnNpdGlvbiwgaGFuZGxlckluZm9zKSB7CiAgICAgIHZhciByb3V0ZXIgPSB0cmFuc2l0aW9uLnJvdXRlciwKICAgICAgICAgIHBhcnRpdGlvbiA9IHBhcnRpdGlvbkhhbmRsZXJzKHJvdXRlci5jdXJyZW50SGFuZGxlckluZm9zIHx8IFtdLCBoYW5kbGVySW5mb3MpOwoKICAgICAgcm91dGVyLnRhcmdldEhhbmRsZXJJbmZvcyA9IGhhbmRsZXJJbmZvczsKCiAgICAgIGVhY2hIYW5kbGVyKHBhcnRpdGlvbi5leGl0ZWQsIGZ1bmN0aW9uKGhhbmRsZXJJbmZvKSB7CiAgICAgICAgdmFyIGhhbmRsZXIgPSBoYW5kbGVySW5mby5oYW5kbGVyOwogICAgICAgIGRlbGV0ZSBoYW5kbGVyLmNvbnRleHQ7CiAgICAgICAgaWYgKGhhbmRsZXIuZXhpdCkgeyBoYW5kbGVyLmV4aXQoKTsgfQogICAgICB9KTsKCiAgICAgIHZhciBjdXJyZW50SGFuZGxlckluZm9zID0gcGFydGl0aW9uLnVuY2hhbmdlZC5zbGljZSgpOwogICAgICByb3V0ZXIuY3VycmVudEhhbmRsZXJJbmZvcyA9IGN1cnJlbnRIYW5kbGVySW5mb3M7CgogICAgICBlYWNoSGFuZGxlcihwYXJ0aXRpb24udXBkYXRlZENvbnRleHQsIGZ1bmN0aW9uKGhhbmRsZXJJbmZvKSB7CiAgICAgICAgaGFuZGxlckVudGVyZWRPclVwZGF0ZWQodHJhbnNpdGlvbiwgY3VycmVudEhhbmRsZXJJbmZvcywgaGFuZGxlckluZm8sIGZhbHNlKTsKICAgICAgfSk7CgogICAgICBlYWNoSGFuZGxlcihwYXJ0aXRpb24uZW50ZXJlZCwgZnVuY3Rpb24oaGFuZGxlckluZm8pIHsKICAgICAgICBoYW5kbGVyRW50ZXJlZE9yVXBkYXRlZCh0cmFuc2l0aW9uLCBjdXJyZW50SGFuZGxlckluZm9zLCBoYW5kbGVySW5mbywgdHJ1ZSk7CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICBAcHJpdmF0ZQoKICAgICAgSGVscGVyIG1ldGhvZCB1c2VkIGJ5IHNldHVwQ29udGV4dHMuIEhhbmRsZXMgZXJyb3JzIG9yIHJlZGlyZWN0cwogICAgICB0aGF0IG1heSBoYXBwZW4gaW4gZW50ZXIvc2V0dXAuCiAgICAqLwogICAgZnVuY3Rpb24gaGFuZGxlckVudGVyZWRPclVwZGF0ZWQodHJhbnNpdGlvbiwgY3VycmVudEhhbmRsZXJJbmZvcywgaGFuZGxlckluZm8sIGVudGVyKSB7CiAgICAgIHZhciBoYW5kbGVyID0gaGFuZGxlckluZm8uaGFuZGxlciwKICAgICAgICAgIGNvbnRleHQgPSBoYW5kbGVySW5mby5jb250ZXh0OwoKICAgICAgdHJ5IHsKICAgICAgICBpZiAoZW50ZXIgJiYgaGFuZGxlci5lbnRlcikgeyBoYW5kbGVyLmVudGVyKCk7IH0KICAgICAgICBjaGVja0Fib3J0KHRyYW5zaXRpb24pOwoKICAgICAgICBzZXRDb250ZXh0KGhhbmRsZXIsIGNvbnRleHQpOwogICAgICAgIHNldFF1ZXJ5UGFyYW1zKGhhbmRsZXIsIGhhbmRsZXJJbmZvLnF1ZXJ5UGFyYW1zKTsKCiAgICAgICAgaWYgKGhhbmRsZXIuc2V0dXApIHsgaGFuZGxlci5zZXR1cChjb250ZXh0LCBoYW5kbGVySW5mby5xdWVyeVBhcmFtcyk7IH0KICAgICAgICBjaGVja0Fib3J0KHRyYW5zaXRpb24pOwogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICBpZiAoIShlIGluc3RhbmNlb2YgUm91dGVyLlRyYW5zaXRpb25BYm9ydGVkKSkgewogICAgICAgICAgLy8gVHJpZ2dlciB0aGUgYGVycm9yYCBldmVudCBzdGFydGluZyBmcm9tIHRoaXMgZmFpbGVkIGhhbmRsZXIuCiAgICAgICAgICB0cmFuc2l0aW9uLnRyaWdnZXIodHJ1ZSwgJ2Vycm9yJywgZSwgdHJhbnNpdGlvbiwgaGFuZGxlcik7CiAgICAgICAgfQoKICAgICAgICAvLyBQcm9wYWdhdGUgdGhlIGVycm9yIHNvIHRoYXQgdGhlIHRyYW5zaXRpb24gcHJvbWlzZSB3aWxsIHJlamVjdC4KICAgICAgICB0aHJvdyBlOwogICAgICB9CgogICAgICBjdXJyZW50SGFuZGxlckluZm9zLnB1c2goaGFuZGxlckluZm8pOwogICAgfQoKCiAgICAvKioKICAgICAgQHByaXZhdGUKCiAgICAgIEl0ZXJhdGVzIG92ZXIgYW4gYXJyYXkgb2YgYEhhbmRsZXJJbmZvYHMsIHBhc3NpbmcgdGhlIGhhbmRsZXIKICAgICAgYW5kIGNvbnRleHQgaW50byB0aGUgY2FsbGJhY2suCgogICAgICBAcGFyYW0ge0FycmF5W0hhbmRsZXJJbmZvXX0gaGFuZGxlckluZm9zCiAgICAgIEBwYXJhbSB7RnVuY3Rpb24oT2JqZWN0LCBPYmplY3QpfSBjYWxsYmFjawogICAgKi8KICAgIGZ1bmN0aW9uIGVhY2hIYW5kbGVyKGhhbmRsZXJJbmZvcywgY2FsbGJhY2spIHsKICAgICAgZm9yICh2YXIgaT0wLCBsPWhhbmRsZXJJbmZvcy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgY2FsbGJhY2soaGFuZGxlckluZm9zW2ldKTsKICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICBAcHJpdmF0ZQoKICAgICAgZGV0ZXJtaW5lcyBpZiB0d28gcXVlcnlwYXJhbSBvYmplY3RzIGFyZSB0aGUgc2FtZSBvciBub3QKICAgICoqLwogICAgZnVuY3Rpb24gcXVlcnlQYXJhbXNFcXVhbChhLCBiKSB7CiAgICAgIGEgPSBhIHx8IHt9OwogICAgICBiID0gYiB8fCB7fTsKICAgICAgdmFyIGNoZWNrZWRLZXlzID0gW10sIGtleTsKICAgICAgZm9yKGtleSBpbiBhKSB7CiAgICAgICAgaWYgKCFhLmhhc093blByb3BlcnR5KGtleSkpIHsgY29udGludWU7IH0KICAgICAgICBpZihiW2tleV0gIT09IGFba2V5XSkgeyByZXR1cm4gZmFsc2U7IH0KICAgICAgICBjaGVja2VkS2V5cy5wdXNoKGtleSk7CiAgICAgIH0KICAgICAgZm9yKGtleSBpbiBiKSB7CiAgICAgICAgaWYgKCFiLmhhc093blByb3BlcnR5KGtleSkpIHsgY29udGludWU7IH0KICAgICAgICBpZiAofmNoZWNrZWRLZXlzLmluZGV4T2Yoa2V5KSkgeyBjb250aW51ZTsgfQogICAgICAgIC8vIGIgaGFzIGEga2V5IG5vdCBpbiBhCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qKgogICAgICBAcHJpdmF0ZQoKICAgICAgVGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQgd2hlbiB0cmFuc2l0aW9uaW5nIGZyb20gb25lIFVSTCB0bwogICAgICBhbm90aGVyIHRvIGRldGVybWluZSB3aGljaCBoYW5kbGVycyBhcmUgbm8gbG9uZ2VyIGFjdGl2ZSwKICAgICAgd2hpY2ggaGFuZGxlcnMgYXJlIG5ld2x5IGFjdGl2ZSwgYW5kIHdoaWNoIGhhbmRsZXJzIHJlbWFpbgogICAgICBhY3RpdmUgYnV0IGhhdmUgdGhlaXIgY29udGV4dCBjaGFuZ2VkLgoKICAgICAgVGFrZSBhIGxpc3Qgb2Ygb2xkIGhhbmRsZXJzIGFuZCBuZXcgaGFuZGxlcnMgYW5kIHBhcnRpdGlvbgogICAgICB0aGVtIGludG8gZm91ciBidWNrZXRzOgoKICAgICAgKiB1bmNoYW5nZWQ6IHRoZSBoYW5kbGVyIHdhcyBhY3RpdmUgaW4gYm90aCB0aGUgb2xkIGFuZAogICAgICAgIG5ldyBVUkwsIGFuZCBpdHMgY29udGV4dCByZW1haW5zIHRoZSBzYW1lCiAgICAgICogdXBkYXRlZCBjb250ZXh0OiB0aGUgaGFuZGxlciB3YXMgYWN0aXZlIGluIGJvdGggdGhlCiAgICAgICAgb2xkIGFuZCBuZXcgVVJMLCBidXQgaXRzIGNvbnRleHQgY2hhbmdlZC4gVGhlIGhhbmRsZXIncwogICAgICAgIGBzZXR1cGAgbWV0aG9kLCBpZiBhbnksIHdpbGwgYmUgY2FsbGVkIHdpdGggdGhlIG5ldwogICAgICAgIGNvbnRleHQuCiAgICAgICogZXhpdGVkOiB0aGUgaGFuZGxlciB3YXMgYWN0aXZlIGluIHRoZSBvbGQgVVJMLCBidXQgaXMKICAgICAgICBubyBsb25nZXIgYWN0aXZlLgogICAgICAqIGVudGVyZWQ6IHRoZSBoYW5kbGVyIHdhcyBub3QgYWN0aXZlIGluIHRoZSBvbGQgVVJMLCBidXQKICAgICAgICBpcyBub3cgYWN0aXZlLgoKICAgICAgVGhlIFBhcnRpdGlvbmVkSGFuZGxlcnMgc3RydWN0dXJlIGhhcyBmb3VyIGZpZWxkczoKCiAgICAgICogYHVwZGF0ZWRDb250ZXh0YDogYSBsaXN0IG9mIGBIYW5kbGVySW5mb2Agb2JqZWN0cyB0aGF0CiAgICAgICAgcmVwcmVzZW50IGhhbmRsZXJzIHRoYXQgcmVtYWluIGFjdGl2ZSBidXQgaGF2ZSBhIGNoYW5nZWQKICAgICAgICBjb250ZXh0CiAgICAgICogYGVudGVyZWRgOiBhIGxpc3Qgb2YgYEhhbmRsZXJJbmZvYCBvYmplY3RzIHRoYXQgcmVwcmVzZW50CiAgICAgICAgaGFuZGxlcnMgdGhhdCBhcmUgbmV3bHkgYWN0aXZlCiAgICAgICogYGV4aXRlZGA6IGEgbGlzdCBvZiBgSGFuZGxlckluZm9gIG9iamVjdHMgdGhhdCBhcmUgbm8KICAgICAgICBsb25nZXIgYWN0aXZlLgogICAgICAqIGB1bmNoYW5nZWRgOiBhIGxpc3Qgb2YgYEhhbmRlckluZm9gIG9iamVjdHMgdGhhdCByZW1haW4gYWN0aXZlLgoKICAgICAgQHBhcmFtIHtBcnJheVtIYW5kbGVySW5mb119IG9sZEhhbmRsZXJzIGEgbGlzdCBvZiB0aGUgaGFuZGxlcgogICAgICAgIGluZm9ybWF0aW9uIGZvciB0aGUgcHJldmlvdXMgVVJMIChvciBgW11gIGlmIHRoaXMgaXMgdGhlCiAgICAgICAgZmlyc3QgaGFuZGxlZCB0cmFuc2l0aW9uKQogICAgICBAcGFyYW0ge0FycmF5W0hhbmRsZXJJbmZvXX0gbmV3SGFuZGxlcnMgYSBsaXN0IG9mIHRoZSBoYW5kbGVyCiAgICAgICAgaW5mb3JtYXRpb24gZm9yIHRoZSBuZXcgVVJMCgogICAgICBAcmV0dXJuIHtQYXJ0aXRpb259CiAgICAqLwogICAgZnVuY3Rpb24gcGFydGl0aW9uSGFuZGxlcnMob2xkSGFuZGxlcnMsIG5ld0hhbmRsZXJzKSB7CiAgICAgIHZhciBoYW5kbGVycyA9IHsKICAgICAgICAgICAgdXBkYXRlZENvbnRleHQ6IFtdLAogICAgICAgICAgICBleGl0ZWQ6IFtdLAogICAgICAgICAgICBlbnRlcmVkOiBbXSwKICAgICAgICAgICAgdW5jaGFuZ2VkOiBbXQogICAgICAgICAgfTsKCiAgICAgIHZhciBoYW5kbGVyQ2hhbmdlZCwgY29udGV4dENoYW5nZWQsIHF1ZXJ5UGFyYW1zQ2hhbmdlZCwgaSwgbDsKCiAgICAgIGZvciAoaT0wLCBsPW5ld0hhbmRsZXJzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICB2YXIgb2xkSGFuZGxlciA9IG9sZEhhbmRsZXJzW2ldLCBuZXdIYW5kbGVyID0gbmV3SGFuZGxlcnNbaV07CgogICAgICAgIGlmICghb2xkSGFuZGxlciB8fCBvbGRIYW5kbGVyLmhhbmRsZXIgIT09IG5ld0hhbmRsZXIuaGFuZGxlcikgewogICAgICAgICAgaGFuZGxlckNoYW5nZWQgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAoIXF1ZXJ5UGFyYW1zRXF1YWwob2xkSGFuZGxlci5xdWVyeVBhcmFtcywgbmV3SGFuZGxlci5xdWVyeVBhcmFtcykpIHsKICAgICAgICAgIHF1ZXJ5UGFyYW1zQ2hhbmdlZCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiAoaGFuZGxlckNoYW5nZWQpIHsKICAgICAgICAgIGhhbmRsZXJzLmVudGVyZWQucHVzaChuZXdIYW5kbGVyKTsKICAgICAgICAgIGlmIChvbGRIYW5kbGVyKSB7IGhhbmRsZXJzLmV4aXRlZC51bnNoaWZ0KG9sZEhhbmRsZXIpOyB9CiAgICAgICAgfSBlbHNlIGlmIChjb250ZXh0Q2hhbmdlZCB8fCBvbGRIYW5kbGVyLmNvbnRleHQgIT09IG5ld0hhbmRsZXIuY29udGV4dCB8fCBxdWVyeVBhcmFtc0NoYW5nZWQpIHsKICAgICAgICAgIGNvbnRleHRDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgIGhhbmRsZXJzLnVwZGF0ZWRDb250ZXh0LnB1c2gobmV3SGFuZGxlcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGhhbmRsZXJzLnVuY2hhbmdlZC5wdXNoKG9sZEhhbmRsZXIpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZm9yIChpPW5ld0hhbmRsZXJzLmxlbmd0aCwgbD1vbGRIYW5kbGVycy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgaGFuZGxlcnMuZXhpdGVkLnVuc2hpZnQob2xkSGFuZGxlcnNbaV0pOwogICAgICB9CgogICAgICByZXR1cm4gaGFuZGxlcnM7CiAgICB9CgogICAgZnVuY3Rpb24gdHJpZ2dlcihyb3V0ZXIsIGhhbmRsZXJJbmZvcywgaWdub3JlRmFpbHVyZSwgYXJncykgewogICAgICBpZiAocm91dGVyLnRyaWdnZXJFdmVudCkgewogICAgICAgIHJvdXRlci50cmlnZ2VyRXZlbnQoaGFuZGxlckluZm9zLCBpZ25vcmVGYWlsdXJlLCBhcmdzKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBuYW1lID0gYXJncy5zaGlmdCgpOwoKICAgICAgaWYgKCFoYW5kbGVySW5mb3MpIHsKICAgICAgICBpZiAoaWdub3JlRmFpbHVyZSkgeyByZXR1cm47IH0KICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNvdWxkIG5vdCB0cmlnZ2VyIGV2ZW50ICciICsgbmFtZSArICInLiBUaGVyZSBhcmUgbm8gYWN0aXZlIGhhbmRsZXJzIik7CiAgICAgIH0KCiAgICAgIHZhciBldmVudFdhc0hhbmRsZWQgPSBmYWxzZTsKCiAgICAgIGZvciAodmFyIGk9aGFuZGxlckluZm9zLmxlbmd0aC0xOyBpPj0wOyBpLS0pIHsKICAgICAgICB2YXIgaGFuZGxlckluZm8gPSBoYW5kbGVySW5mb3NbaV0sCiAgICAgICAgICAgIGhhbmRsZXIgPSBoYW5kbGVySW5mby5oYW5kbGVyOwoKICAgICAgICBpZiAoaGFuZGxlci5ldmVudHMgJiYgaGFuZGxlci5ldmVudHNbbmFtZV0pIHsKICAgICAgICAgIGlmIChoYW5kbGVyLmV2ZW50c1tuYW1lXS5hcHBseShoYW5kbGVyLCBhcmdzKSA9PT0gdHJ1ZSkgewogICAgICAgICAgICBldmVudFdhc0hhbmRsZWQgPSB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKCFldmVudFdhc0hhbmRsZWQgJiYgIWlnbm9yZUZhaWx1cmUpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk5vdGhpbmcgaGFuZGxlZCB0aGUgZXZlbnQgJyIgKyBuYW1lICsgIicuIik7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBzZXRDb250ZXh0KGhhbmRsZXIsIGNvbnRleHQpIHsKICAgICAgaGFuZGxlci5jb250ZXh0ID0gY29udGV4dDsKICAgICAgaWYgKGhhbmRsZXIuY29udGV4dERpZENoYW5nZSkgeyBoYW5kbGVyLmNvbnRleHREaWRDaGFuZ2UoKTsgfQogICAgfQoKICAgIGZ1bmN0aW9uIHNldFF1ZXJ5UGFyYW1zKGhhbmRsZXIsIHF1ZXJ5UGFyYW1zKSB7CiAgICAgIGhhbmRsZXIucXVlcnlQYXJhbXMgPSBxdWVyeVBhcmFtczsKICAgICAgaWYgKGhhbmRsZXIucXVlcnlQYXJhbXNEaWRDaGFuZ2UpIHsgaGFuZGxlci5xdWVyeVBhcmFtc0RpZENoYW5nZSgpOyB9CiAgICB9CgoKICAgIC8qKgogICAgICBAcHJpdmF0ZQoKICAgICAgRXh0cmFjdHMgcXVlcnkgcGFyYW1zIGZyb20gdGhlIGVuZCBvZiBhbiBhcnJheQogICAgKiovCgogICAgZnVuY3Rpb24gZXh0cmFjdFF1ZXJ5UGFyYW1zKGFycmF5KSB7CiAgICAgIHZhciBsZW4gPSAoYXJyYXkgJiYgYXJyYXkubGVuZ3RoKSwgaGVhZCwgcXVlcnlQYXJhbXM7CgogICAgICBpZihsZW4gJiYgbGVuID4gMCAmJiBhcnJheVtsZW4gLSAxXSAmJiBhcnJheVtsZW4gLSAxXS5oYXNPd25Qcm9wZXJ0eSgncXVlcnlQYXJhbXMnKSkgewogICAgICAgIHF1ZXJ5UGFyYW1zID0gYXJyYXlbbGVuIC0gMV0ucXVlcnlQYXJhbXM7CiAgICAgICAgaGVhZCA9IHNsaWNlLmNhbGwoYXJyYXksIDAsIGxlbiAtIDEpOwogICAgICAgIHJldHVybiBbaGVhZCwgcXVlcnlQYXJhbXNdOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBbYXJyYXksIG51bGxdOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gcGVyZm9ybUludGVybWVkaWF0ZVRyYW5zaXRpb24ocm91dGVyLCByZWNvZ0hhbmRsZXJzLCBtYXRjaFBvaW50UmVzdWx0cykgewoKICAgICAgdmFyIGhhbmRsZXJJbmZvcyA9IGdlbmVyYXRlSGFuZGxlckluZm9zKHJvdXRlciwgcmVjb2dIYW5kbGVycyk7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaGFuZGxlckluZm9zLmxlbmd0aDsgKytpKSB7CiAgICAgICAgdmFyIGhhbmRsZXJJbmZvID0gaGFuZGxlckluZm9zW2ldOwogICAgICAgIGhhbmRsZXJJbmZvLmNvbnRleHQgPSBtYXRjaFBvaW50UmVzdWx0cy5wcm92aWRlZE1vZGVsc1toYW5kbGVySW5mby5uYW1lXTsKICAgICAgfQoKICAgICAgdmFyIHN0dWJiZWRUcmFuc2l0aW9uID0gewogICAgICAgIHJvdXRlcjogcm91dGVyLAogICAgICAgIGlzQWJvcnRlZDogZmFsc2UKICAgICAgfTsKCiAgICAgIHNldHVwQ29udGV4dHMoc3R1YmJlZFRyYW5zaXRpb24sIGhhbmRsZXJJbmZvcyk7CiAgICB9CgogICAgLyoqCiAgICAgIEBwcml2YXRlCgogICAgICBDcmVhdGVzLCBiZWdpbnMsIGFuZCByZXR1cm5zIGEgVHJhbnNpdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gcGVyZm9ybVRyYW5zaXRpb24ocm91dGVyLCByZWNvZ0hhbmRsZXJzLCBwcm92aWRlZE1vZGVsc0FycmF5LCBwYXJhbXMsIHF1ZXJ5UGFyYW1zLCBkYXRhLCBpc0ludGVybWVkaWF0ZSkgewoKICAgICAgdmFyIG1hdGNoUG9pbnRSZXN1bHRzID0gZ2V0TWF0Y2hQb2ludChyb3V0ZXIsIHJlY29nSGFuZGxlcnMsIHByb3ZpZGVkTW9kZWxzQXJyYXksIHBhcmFtcywgcXVlcnlQYXJhbXMpLAogICAgICAgICAgdGFyZ2V0TmFtZSA9IHJlY29nSGFuZGxlcnNbcmVjb2dIYW5kbGVycy5sZW5ndGggLSAxXS5oYW5kbGVyLAogICAgICAgICAgd2FzVHJhbnNpdGlvbmluZyA9IGZhbHNlLAogICAgICAgICAgY3VycmVudEhhbmRsZXJJbmZvcyA9IHJvdXRlci5jdXJyZW50SGFuZGxlckluZm9zOwoKICAgICAgaWYgKGlzSW50ZXJtZWRpYXRlKSB7CiAgICAgICAgcmV0dXJuIHBlcmZvcm1JbnRlcm1lZGlhdGVUcmFuc2l0aW9uKHJvdXRlciwgcmVjb2dIYW5kbGVycywgbWF0Y2hQb2ludFJlc3VsdHMpOwogICAgICB9CgogICAgICAvLyBDaGVjayBpZiB0aGVyZSdzIGFscmVhZHkgYSB0cmFuc2l0aW9uIHVuZGVyd2F5LgogICAgICBpZiAocm91dGVyLmFjdGl2ZVRyYW5zaXRpb24pIHsKICAgICAgICBpZiAodHJhbnNpdGlvbnNJZGVudGljYWwocm91dGVyLmFjdGl2ZVRyYW5zaXRpb24sIHRhcmdldE5hbWUsIHByb3ZpZGVkTW9kZWxzQXJyYXksIHF1ZXJ5UGFyYW1zKSkgewogICAgICAgICAgcmV0dXJuIHJvdXRlci5hY3RpdmVUcmFuc2l0aW9uOwogICAgICAgIH0KICAgICAgICByb3V0ZXIuYWN0aXZlVHJhbnNpdGlvbi5hYm9ydCgpOwogICAgICAgIHdhc1RyYW5zaXRpb25pbmcgPSB0cnVlOwogICAgICB9CgogICAgICB2YXIgZGVmZXJyZWQgPSBSU1ZQLmRlZmVyKCksCiAgICAgICAgICB0cmFuc2l0aW9uID0gbmV3IFRyYW5zaXRpb24ocm91dGVyLCBkZWZlcnJlZC5wcm9taXNlKTsKCiAgICAgIHRyYW5zaXRpb24udGFyZ2V0TmFtZSA9IHRhcmdldE5hbWU7CiAgICAgIHRyYW5zaXRpb24ucHJvdmlkZWRNb2RlbHMgPSBtYXRjaFBvaW50UmVzdWx0cy5wcm92aWRlZE1vZGVsczsKICAgICAgdHJhbnNpdGlvbi5wcm92aWRlZE1vZGVsc0FycmF5ID0gcHJvdmlkZWRNb2RlbHNBcnJheTsKICAgICAgdHJhbnNpdGlvbi5wYXJhbXMgPSBtYXRjaFBvaW50UmVzdWx0cy5wYXJhbXM7CiAgICAgIHRyYW5zaXRpb24uZGF0YSA9IGRhdGEgfHwge307CiAgICAgIHRyYW5zaXRpb24ucXVlcnlQYXJhbXMgPSBxdWVyeVBhcmFtczsKICAgICAgdHJhbnNpdGlvbi5waXZvdEhhbmRsZXIgPSBtYXRjaFBvaW50UmVzdWx0cy5waXZvdEhhbmRsZXI7CiAgICAgIHJvdXRlci5hY3RpdmVUcmFuc2l0aW9uID0gdHJhbnNpdGlvbjsKCiAgICAgIHZhciBoYW5kbGVySW5mb3MgPSBnZW5lcmF0ZUhhbmRsZXJJbmZvcyhyb3V0ZXIsIHJlY29nSGFuZGxlcnMpOwogICAgICB0cmFuc2l0aW9uLmhhbmRsZXJJbmZvcyA9IGhhbmRsZXJJbmZvczsKCiAgICAgIC8vIEZpcmUgJ3dpbGxUcmFuc2l0aW9uJyBldmVudCBvbiBjdXJyZW50IGhhbmRsZXJzLCBidXQgZG9uJ3QgZmlyZSBpdAogICAgICAvLyBpZiBhIHRyYW5zaXRpb24gd2FzIGFscmVhZHkgdW5kZXJ3YXkuCiAgICAgIGlmICghd2FzVHJhbnNpdGlvbmluZykgewogICAgICAgIHRyaWdnZXIocm91dGVyLCBjdXJyZW50SGFuZGxlckluZm9zLCB0cnVlLCBbJ3dpbGxUcmFuc2l0aW9uJywgdHJhbnNpdGlvbl0pOwogICAgICB9CgogICAgICBsb2cocm91dGVyLCB0cmFuc2l0aW9uLnNlcXVlbmNlLCAiQmVnaW5uaW5nIHZhbGlkYXRpb24gZm9yIHRyYW5zaXRpb24gdG8gIiArIHRyYW5zaXRpb24udGFyZ2V0TmFtZSk7CiAgICAgIHZhbGlkYXRlRW50cnkodHJhbnNpdGlvbiwgbWF0Y2hQb2ludFJlc3VsdHMubWF0Y2hQb2ludCwgbWF0Y2hQb2ludFJlc3VsdHMuaGFuZGxlclBhcmFtcykKICAgICAgICAgICAgICAgICAgIC50aGVuKHRyYW5zaXRpb25TdWNjZXNzLCB0cmFuc2l0aW9uRmFpbHVyZSk7CgogICAgICByZXR1cm4gdHJhbnNpdGlvbjsKCiAgICAgIGZ1bmN0aW9uIHRyYW5zaXRpb25TdWNjZXNzKCkgewogICAgICAgIGNoZWNrQWJvcnQodHJhbnNpdGlvbik7CgogICAgICAgIHRyeSB7CiAgICAgICAgICBmaW5hbGl6ZVRyYW5zaXRpb24odHJhbnNpdGlvbiwgaGFuZGxlckluZm9zKTsKCiAgICAgICAgICAvLyBjdXJyZW50SGFuZGxlckluZm9zIHdhcyB1cGRhdGVkIGluIGZpbmFsaXplVHJhbnNpdGlvbgogICAgICAgICAgdHJpZ2dlcihyb3V0ZXIsIHJvdXRlci5jdXJyZW50SGFuZGxlckluZm9zLCB0cnVlLCBbJ2RpZFRyYW5zaXRpb24nXSk7CgogICAgICAgICAgaWYgKHJvdXRlci5kaWRUcmFuc2l0aW9uKSB7CiAgICAgICAgICAgIHJvdXRlci5kaWRUcmFuc2l0aW9uKGhhbmRsZXJJbmZvcyk7CiAgICAgICAgICB9CgogICAgICAgICAgbG9nKHJvdXRlciwgdHJhbnNpdGlvbi5zZXF1ZW5jZSwgIlRSQU5TSVRJT04gQ09NUExFVEUuIik7CgogICAgICAgICAgLy8gUmVzb2x2ZSB3aXRoIHRoZSBmaW5hbCBoYW5kbGVyLgogICAgICAgICAgdHJhbnNpdGlvbi5pc0FjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShoYW5kbGVySW5mb3NbaGFuZGxlckluZm9zLmxlbmd0aCAtIDFdLmhhbmRsZXIpOwogICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgZGVmZXJyZWQucmVqZWN0KGUpOwogICAgICAgIH0KCiAgICAgICAgLy8gRG9uJ3QgbnVsbGlmeSBpZiBhbm90aGVyIHRyYW5zaXRpb24gaXMgdW5kZXJ3YXkgKG1lYW5pbmcKICAgICAgICAvLyB0aGVyZSB3YXMgYSB0cmFuc2l0aW9uIGluaXRpYXRlZCB3aXRoIGVudGVyL3NldHVwKS4KICAgICAgICBpZiAoIXRyYW5zaXRpb24uaXNBYm9ydGVkKSB7CiAgICAgICAgICByb3V0ZXIuYWN0aXZlVHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiB0cmFuc2l0aW9uRmFpbHVyZShyZWFzb24pIHsKICAgICAgICBkZWZlcnJlZC5yZWplY3QocmVhc29uKTsKICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICBAcHJpdmF0ZQoKICAgICAgQWNjZXB0cyBoYW5kbGVycyBpbiBSZWNvZ25pemVyIGZvcm1hdCwgZWl0aGVyIHJldHVybmVkIGZyb20KICAgICAgcmVjb2duaXplKCkgb3IgaGFuZGxlcnNGb3IoKSwgYW5kIHJldHVybnMgdW5pZmllZAogICAgICBgSGFuZGxlckluZm9gcy4KICAgICAqLwogICAgZnVuY3Rpb24gZ2VuZXJhdGVIYW5kbGVySW5mb3Mocm91dGVyLCByZWNvZ0hhbmRsZXJzKSB7CiAgICAgIHZhciBoYW5kbGVySW5mb3MgPSBbXTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHJlY29nSGFuZGxlcnMubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgICAgICB2YXIgaGFuZGxlck9iaiA9IHJlY29nSGFuZGxlcnNbaV0sCiAgICAgICAgICAgIGlzRHluYW1pYyA9IGhhbmRsZXJPYmouaXNEeW5hbWljIHx8IChoYW5kbGVyT2JqLm5hbWVzICYmIGhhbmRsZXJPYmoubmFtZXMubGVuZ3RoKTsKCiAgICAgICAgdmFyIGhhbmRsZXJJbmZvID0gewogICAgICAgICAgaXNEeW5hbWljOiAhIWlzRHluYW1pYywKICAgICAgICAgIG5hbWU6IGhhbmRsZXJPYmouaGFuZGxlciwKICAgICAgICAgIGhhbmRsZXI6IHJvdXRlci5nZXRIYW5kbGVyKGhhbmRsZXJPYmouaGFuZGxlcikKICAgICAgICB9OwogICAgICAgIGlmKGhhbmRsZXJPYmoucXVlcnlQYXJhbXMpIHsKICAgICAgICAgIGhhbmRsZXJJbmZvLnF1ZXJ5UGFyYW1zID0gaGFuZGxlck9iai5xdWVyeVBhcmFtczsKICAgICAgICB9CiAgICAgICAgaGFuZGxlckluZm9zLnB1c2goaGFuZGxlckluZm8pOwogICAgICB9CiAgICAgIHJldHVybiBoYW5kbGVySW5mb3M7CiAgICB9CgogICAgLyoqCiAgICAgIEBwcml2YXRlCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRyYW5zaXRpb25zSWRlbnRpY2FsKG9sZFRyYW5zaXRpb24sIHRhcmdldE5hbWUsIHByb3ZpZGVkTW9kZWxzQXJyYXksIHF1ZXJ5UGFyYW1zKSB7CgogICAgICBpZiAob2xkVHJhbnNpdGlvbi50YXJnZXROYW1lICE9PSB0YXJnZXROYW1lKSB7IHJldHVybiBmYWxzZTsgfQoKICAgICAgdmFyIG9sZE1vZGVscyA9IG9sZFRyYW5zaXRpb24ucHJvdmlkZWRNb2RlbHNBcnJheTsKICAgICAgaWYgKG9sZE1vZGVscy5sZW5ndGggIT09IHByb3ZpZGVkTW9kZWxzQXJyYXkubGVuZ3RoKSB7IHJldHVybiBmYWxzZTsgfQoKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IG9sZE1vZGVscy5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICAgIGlmIChvbGRNb2RlbHNbaV0gIT09IHByb3ZpZGVkTW9kZWxzQXJyYXlbaV0pIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIH0KCiAgICAgIGlmKCFxdWVyeVBhcmFtc0VxdWFsKG9sZFRyYW5zaXRpb24ucXVlcnlQYXJhbXMsIHF1ZXJ5UGFyYW1zKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgIEBwcml2YXRlCgogICAgICBVcGRhdGVzIHRoZSBVUkwgKGlmIG5lY2Vzc2FyeSkgYW5kIGNhbGxzIGBzZXR1cENvbnRleHRzYAogICAgICB0byB1cGRhdGUgdGhlIHJvdXRlcidzIGFycmF5IG9mIGBjdXJyZW50SGFuZGxlckluZm9zYC4KICAgICAqLwogICAgZnVuY3Rpb24gZmluYWxpemVUcmFuc2l0aW9uKHRyYW5zaXRpb24sIGhhbmRsZXJJbmZvcykgewoKICAgICAgbG9nKHRyYW5zaXRpb24ucm91dGVyLCB0cmFuc2l0aW9uLnNlcXVlbmNlLCAiVmFsaWRhdGlvbiBzdWNjZWVkZWQsIGZpbmFsaXppbmcgdHJhbnNpdGlvbjsiKTsKCiAgICAgIHZhciByb3V0ZXIgPSB0cmFuc2l0aW9uLnJvdXRlciwKICAgICAgICAgIHNlcSA9IHRyYW5zaXRpb24uc2VxdWVuY2UsCiAgICAgICAgICBoYW5kbGVyTmFtZSA9IGhhbmRsZXJJbmZvc1toYW5kbGVySW5mb3MubGVuZ3RoIC0gMV0ubmFtZSwKICAgICAgICAgIHVybE1ldGhvZCA9IHRyYW5zaXRpb24udXJsTWV0aG9kLAogICAgICAgICAgaTsKCiAgICAgIC8vIENvbGxlY3QgcGFyYW1zIGZvciBVUkwuCiAgICAgIHZhciBvYmplY3RzID0gW10sIHByb3ZpZGVkTW9kZWxzID0gdHJhbnNpdGlvbi5wcm92aWRlZE1vZGVsc0FycmF5LnNsaWNlKCk7CiAgICAgIGZvciAoaSA9IGhhbmRsZXJJbmZvcy5sZW5ndGggLSAxOyBpPj0wOyAtLWkpIHsKICAgICAgICB2YXIgaGFuZGxlckluZm8gPSBoYW5kbGVySW5mb3NbaV07CiAgICAgICAgaWYgKGhhbmRsZXJJbmZvLmlzRHluYW1pYykgewogICAgICAgICAgdmFyIHByb3ZpZGVkTW9kZWwgPSBwcm92aWRlZE1vZGVscy5wb3AoKTsKICAgICAgICAgIG9iamVjdHMudW5zaGlmdChpc1BhcmFtKHByb3ZpZGVkTW9kZWwpID8gcHJvdmlkZWRNb2RlbC50b1N0cmluZygpIDogaGFuZGxlckluZm8uY29udGV4dCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoaGFuZGxlckluZm8uaGFuZGxlci5pbmFjY2Vzc2libGVCeVVSTCkgewogICAgICAgICAgdXJsTWV0aG9kID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBuZXdRdWVyeVBhcmFtcyA9IHt9OwogICAgICBmb3IgKGkgPSBoYW5kbGVySW5mb3MubGVuZ3RoIC0gMTsgaT49MDsgLS1pKSB7CiAgICAgICAgbWVyZ2UobmV3UXVlcnlQYXJhbXMsIGhhbmRsZXJJbmZvc1tpXS5xdWVyeVBhcmFtcyk7CiAgICAgIH0KICAgICAgcm91dGVyLmN1cnJlbnRRdWVyeVBhcmFtcyA9IG5ld1F1ZXJ5UGFyYW1zOwoKCiAgICAgIHZhciBwYXJhbXMgPSBwYXJhbXNGb3JIYW5kbGVyKHJvdXRlciwgaGFuZGxlck5hbWUsIG9iamVjdHMsIHRyYW5zaXRpb24ucXVlcnlQYXJhbXMpOwoKICAgICAgcm91dGVyLmN1cnJlbnRQYXJhbXMgPSBwYXJhbXM7CgogICAgICBpZiAodXJsTWV0aG9kKSB7CiAgICAgICAgdmFyIHVybCA9IHJvdXRlci5yZWNvZ25pemVyLmdlbmVyYXRlKGhhbmRsZXJOYW1lLCBwYXJhbXMpOwoKICAgICAgICBpZiAodXJsTWV0aG9kID09PSAncmVwbGFjZScpIHsKICAgICAgICAgIHJvdXRlci5yZXBsYWNlVVJMKHVybCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIEFzc3VtZSBldmVyeXRoaW5nIGVsc2UgaXMganVzdCBhIFVSTCB1cGRhdGUgZm9yIG5vdy4KICAgICAgICAgIHJvdXRlci51cGRhdGVVUkwodXJsKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHNldHVwQ29udGV4dHModHJhbnNpdGlvbiwgaGFuZGxlckluZm9zKTsKICAgIH0KCiAgICAvKioKICAgICAgQHByaXZhdGUKCiAgICAgIEludGVybmFsIGZ1bmN0aW9uIHVzZWQgdG8gY29uc3RydWN0IHRoZSBjaGFpbiBvZiBwcm9taXNlcyB1c2VkCiAgICAgIHRvIHZhbGlkYXRlIGEgdHJhbnNpdGlvbi4gV3JhcHMgY2FsbHMgdG8gYGJlZm9yZU1vZGVsYCwgYG1vZGVsYCwKICAgICAgYW5kIGBhZnRlck1vZGVsYCBpbiBwcm9taXNlcywgYW5kIGNoZWNrcyBmb3IgcmVkaXJlY3RzL2Fib3J0cwogICAgICBiZXR3ZWVuIGVhY2guCiAgICAgKi8KICAgIGZ1bmN0aW9uIHZhbGlkYXRlRW50cnkodHJhbnNpdGlvbiwgbWF0Y2hQb2ludCwgaGFuZGxlclBhcmFtcykgewoKICAgICAgdmFyIGhhbmRsZXJJbmZvcyA9IHRyYW5zaXRpb24uaGFuZGxlckluZm9zLAogICAgICAgICAgaW5kZXggPSB0cmFuc2l0aW9uLnJlc29sdmVJbmRleDsKCiAgICAgIGlmIChpbmRleCA9PT0gaGFuZGxlckluZm9zLmxlbmd0aCkgewogICAgICAgIC8vIE5vIG1vcmUgY29udGV4dHMgdG8gcmVzb2x2ZS4KICAgICAgICByZXR1cm4gUlNWUC5yZXNvbHZlKHRyYW5zaXRpb24ucmVzb2x2ZWRNb2RlbHMpOwogICAgICB9CgogICAgICB2YXIgcm91dGVyID0gdHJhbnNpdGlvbi5yb3V0ZXIsCiAgICAgICAgICBoYW5kbGVySW5mbyA9IGhhbmRsZXJJbmZvc1tpbmRleF0sCiAgICAgICAgICBoYW5kbGVyID0gaGFuZGxlckluZm8uaGFuZGxlciwKICAgICAgICAgIGhhbmRsZXJOYW1lID0gaGFuZGxlckluZm8ubmFtZSwKICAgICAgICAgIHNlcSA9IHRyYW5zaXRpb24uc2VxdWVuY2U7CgogICAgICBpZiAoaW5kZXggPCBtYXRjaFBvaW50KSB7CiAgICAgICAgbG9nKHJvdXRlciwgc2VxLCBoYW5kbGVyTmFtZSArICI6IHVzaW5nIGNvbnRleHQgZnJvbSBhbHJlYWR5LWFjdGl2ZSBoYW5kbGVyIik7CgogICAgICAgIC8vIFdlJ3JlIGJlZm9yZSB0aGUgbWF0Y2ggcG9pbnQsIHNvIGRvbid0IHJ1biBhbnkgaG9va3MsCiAgICAgICAgLy8ganVzdCB1c2UgdGhlIGFscmVhZHkgcmVzb2x2ZWQgY29udGV4dCBmcm9tIHRoZSBoYW5kbGVyLgogICAgICAgIHRyYW5zaXRpb24ucmVzb2x2ZWRNb2RlbHNbaGFuZGxlckluZm8ubmFtZV0gPQogICAgICAgICAgdHJhbnNpdGlvbi5wcm92aWRlZE1vZGVsc1toYW5kbGVySW5mby5uYW1lXSB8fAogICAgICAgICAgaGFuZGxlckluZm8uaGFuZGxlci5jb250ZXh0OwogICAgICAgIHJldHVybiBwcm9jZWVkKCk7CiAgICAgIH0KCiAgICAgIHRyYW5zaXRpb24udHJpZ2dlcih0cnVlLCAnd2lsbFJlc29sdmVNb2RlbCcsIHRyYW5zaXRpb24sIGhhbmRsZXIpOwoKICAgICAgcmV0dXJuIFJTVlAucmVzb2x2ZSgpLnRoZW4oaGFuZGxlQWJvcnQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKGJlZm9yZU1vZGVsKQogICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbihoYW5kbGVBYm9ydCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4obW9kZWwpCiAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKGhhbmRsZUFib3J0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbihhZnRlck1vZGVsKQogICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbihoYW5kbGVBYm9ydCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4obnVsbCwgaGFuZGxlRXJyb3IpCiAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKHByb2NlZWQpOwoKICAgICAgZnVuY3Rpb24gaGFuZGxlQWJvcnQocmVzdWx0KSB7CiAgICAgICAgaWYgKHRyYW5zaXRpb24uaXNBYm9ydGVkKSB7CiAgICAgICAgICBsb2codHJhbnNpdGlvbi5yb3V0ZXIsIHRyYW5zaXRpb24uc2VxdWVuY2UsICJkZXRlY3RlZCBhYm9ydC4iKTsKICAgICAgICAgIHJldHVybiBSU1ZQLnJlamVjdChuZXcgUm91dGVyLlRyYW5zaXRpb25BYm9ydGVkKCkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gaGFuZGxlRXJyb3IocmVhc29uKSB7CiAgICAgICAgaWYgKHJlYXNvbiBpbnN0YW5jZW9mIFJvdXRlci5UcmFuc2l0aW9uQWJvcnRlZCB8fCB0cmFuc2l0aW9uLmlzQWJvcnRlZCkgewogICAgICAgICAgLy8gaWYgdGhlIHRyYW5zaXRpb24gd2FzIGFib3J0ZWQgYW5kICpubyBhZGRpdGlvbmFsKiBlcnJvciB3YXMgdGhyb3duLAogICAgICAgICAgLy8gcmVqZWN0IHdpdGggdGhlIFJvdXRlci5UcmFuc2l0aW9uQWJvcnRlZCBpbnN0YW5jZQogICAgICAgICAgcmV0dXJuIFJTVlAucmVqZWN0KHJlYXNvbik7CiAgICAgICAgfQoKICAgICAgICAvLyBvdGhlcndpc2UsIHdlJ3JlIGhlcmUgYmVjYXVzZSBvZiBhIGRpZmZlcmVudCBlcnJvcgogICAgICAgIHRyYW5zaXRpb24uYWJvcnQoKTsKCiAgICAgICAgbG9nKHJvdXRlciwgc2VxLCBoYW5kbGVyTmFtZSArICI6IGhhbmRsaW5nIGVycm9yOiAiICsgcmVhc29uKTsKCiAgICAgICAgLy8gQW4gZXJyb3Igd2FzIHRocm93biAvIHByb21pc2UgcmVqZWN0ZWQsIHNvIGZpcmUgYW4KICAgICAgICAvLyBgZXJyb3JgIGV2ZW50IGZyb20gdGhpcyBoYW5kbGVyIGluZm8gdXAgdG8gcm9vdC4KICAgICAgICB0cmFuc2l0aW9uLnRyaWdnZXIodHJ1ZSwgJ2Vycm9yJywgcmVhc29uLCB0cmFuc2l0aW9uLCBoYW5kbGVySW5mby5oYW5kbGVyKTsKCiAgICAgICAgLy8gUHJvcGFnYXRlIHRoZSBvcmlnaW5hbCBlcnJvci4KICAgICAgICByZXR1cm4gUlNWUC5yZWplY3QocmVhc29uKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gYmVmb3JlTW9kZWwoKSB7CgogICAgICAgIGxvZyhyb3V0ZXIsIHNlcSwgaGFuZGxlck5hbWUgKyAiOiBjYWxsaW5nIGJlZm9yZU1vZGVsIGhvb2siKTsKCiAgICAgICAgdmFyIGFyZ3M7CgogICAgICAgIGlmIChoYW5kbGVySW5mby5xdWVyeVBhcmFtcykgewogICAgICAgICAgYXJncyA9IFtoYW5kbGVySW5mby5xdWVyeVBhcmFtcywgdHJhbnNpdGlvbl07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFyZ3MgPSBbdHJhbnNpdGlvbl07CiAgICAgICAgfQoKICAgICAgICB2YXIgcCA9IGhhbmRsZXIuYmVmb3JlTW9kZWwgJiYgaGFuZGxlci5iZWZvcmVNb2RlbC5hcHBseShoYW5kbGVyLCBhcmdzKTsKICAgICAgICByZXR1cm4gKHAgaW5zdGFuY2VvZiBUcmFuc2l0aW9uKSA/IG51bGwgOiBwOwogICAgICB9CgogICAgICBmdW5jdGlvbiBtb2RlbCgpIHsKICAgICAgICBsb2cocm91dGVyLCBzZXEsIGhhbmRsZXJOYW1lICsgIjogcmVzb2x2aW5nIG1vZGVsIik7CiAgICAgICAgdmFyIHAgPSBnZXRNb2RlbChoYW5kbGVySW5mbywgdHJhbnNpdGlvbiwgaGFuZGxlclBhcmFtc1toYW5kbGVyTmFtZV0sIGluZGV4ID49IG1hdGNoUG9pbnQpOwogICAgICAgIHJldHVybiAocCBpbnN0YW5jZW9mIFRyYW5zaXRpb24pID8gbnVsbCA6IHA7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGFmdGVyTW9kZWwoY29udGV4dCkgewoKICAgICAgICBsb2cocm91dGVyLCBzZXEsIGhhbmRsZXJOYW1lICsgIjogY2FsbGluZyBhZnRlck1vZGVsIGhvb2siKTsKCiAgICAgICAgLy8gUGFzcyB0aGUgY29udGV4dCBhbmQgcmVzb2x2ZWQgcGFyZW50IGNvbnRleHRzIHRvIGFmdGVyTW9kZWwsIGJ1dCB3ZSBkb24ndAogICAgICAgIC8vIHdhbnQgdG8gdXNlIHRoZSB2YWx1ZSByZXR1cm5lZCBmcm9tIGBhZnRlck1vZGVsYCBpbiBhbnkgd2F5LCBidXQgcmF0aGVyCiAgICAgICAgLy8gYWx3YXlzIHJlc29sdmUgd2l0aCB0aGUgb3JpZ2luYWwgYGNvbnRleHRgIG9iamVjdC4KCiAgICAgICAgdHJhbnNpdGlvbi5yZXNvbHZlZE1vZGVsc1toYW5kbGVySW5mby5uYW1lXSA9IGNvbnRleHQ7CgogICAgICAgIHZhciBhcmdzOwoKICAgICAgICBpZiAoaGFuZGxlckluZm8ucXVlcnlQYXJhbXMpIHsKICAgICAgICAgIGFyZ3MgPSBbY29udGV4dCwgaGFuZGxlckluZm8ucXVlcnlQYXJhbXMsIHRyYW5zaXRpb25dOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhcmdzID0gW2NvbnRleHQsIHRyYW5zaXRpb25dOwogICAgICAgIH0KCiAgICAgICAgdmFyIHAgPSBoYW5kbGVyLmFmdGVyTW9kZWwgJiYgaGFuZGxlci5hZnRlck1vZGVsLmFwcGx5KGhhbmRsZXIsIGFyZ3MpOwogICAgICAgIHJldHVybiAocCBpbnN0YW5jZW9mIFRyYW5zaXRpb24pID8gbnVsbCA6IHA7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHByb2NlZWQoKSB7CiAgICAgICAgbG9nKHJvdXRlciwgc2VxLCBoYW5kbGVyTmFtZSArICI6IHZhbGlkYXRpb24gc3VjY2VlZGVkLCBwcm9jZWVkaW5nIik7CgogICAgICAgIGhhbmRsZXJJbmZvLmNvbnRleHQgPSB0cmFuc2l0aW9uLnJlc29sdmVkTW9kZWxzW2hhbmRsZXJJbmZvLm5hbWVdOwogICAgICAgIHRyYW5zaXRpb24ucmVzb2x2ZUluZGV4Kys7CiAgICAgICAgcmV0dXJuIHZhbGlkYXRlRW50cnkodHJhbnNpdGlvbiwgbWF0Y2hQb2ludCwgaGFuZGxlclBhcmFtcyk7CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAgQHByaXZhdGUKCiAgICAgIFRocm93cyBhIFRyYW5zaXRpb25BYm9ydGVkIGlmIHRoZSBwcm92aWRlZCB0cmFuc2l0aW9uIGhhcyBiZWVuIGFib3J0ZWQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNoZWNrQWJvcnQodHJhbnNpdGlvbikgewogICAgICBpZiAodHJhbnNpdGlvbi5pc0Fib3J0ZWQpIHsKICAgICAgICBsb2codHJhbnNpdGlvbi5yb3V0ZXIsIHRyYW5zaXRpb24uc2VxdWVuY2UsICJkZXRlY3RlZCBhYm9ydC4iKTsKICAgICAgICB0aHJvdyBuZXcgUm91dGVyLlRyYW5zaXRpb25BYm9ydGVkKCk7CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAgQHByaXZhdGUKCiAgICAgIEVuY2Fwc3VsYXRlcyB0aGUgbG9naWMgZm9yIHdoZXRoZXIgdG8gY2FsbCBgbW9kZWxgIG9uIGEgcm91dGUsCiAgICAgIG9yIHVzZSBvbmUgb2YgdGhlIG1vZGVscyBwcm92aWRlZCB0byBgdHJhbnNpdGlvblRvYC4KICAgICAqLwogICAgZnVuY3Rpb24gZ2V0TW9kZWwoaGFuZGxlckluZm8sIHRyYW5zaXRpb24sIGhhbmRsZXJQYXJhbXMsIG5lZWRzVXBkYXRlKSB7CiAgICAgIHZhciBoYW5kbGVyID0gaGFuZGxlckluZm8uaGFuZGxlciwKICAgICAgICAgIGhhbmRsZXJOYW1lID0gaGFuZGxlckluZm8ubmFtZSwgYXJnczsKCiAgICAgIGlmICghbmVlZHNVcGRhdGUgJiYgaGFuZGxlci5oYXNPd25Qcm9wZXJ0eSgnY29udGV4dCcpKSB7CiAgICAgICAgcmV0dXJuIGhhbmRsZXIuY29udGV4dDsKICAgICAgfQoKICAgICAgaWYgKHRyYW5zaXRpb24ucHJvdmlkZWRNb2RlbHMuaGFzT3duUHJvcGVydHkoaGFuZGxlck5hbWUpKSB7CiAgICAgICAgdmFyIHByb3ZpZGVkTW9kZWwgPSB0cmFuc2l0aW9uLnByb3ZpZGVkTW9kZWxzW2hhbmRsZXJOYW1lXTsKICAgICAgICByZXR1cm4gdHlwZW9mIHByb3ZpZGVkTW9kZWwgPT09ICdmdW5jdGlvbicgPyBwcm92aWRlZE1vZGVsKCkgOiBwcm92aWRlZE1vZGVsOwogICAgICB9CgogICAgICBpZiAoaGFuZGxlckluZm8ucXVlcnlQYXJhbXMpIHsKICAgICAgICBhcmdzID0gW2hhbmRsZXJQYXJhbXMgfHwge30sIGhhbmRsZXJJbmZvLnF1ZXJ5UGFyYW1zLCB0cmFuc2l0aW9uXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBhcmdzID0gW2hhbmRsZXJQYXJhbXMgfHwge30sIHRyYW5zaXRpb24sIGhhbmRsZXJJbmZvLnF1ZXJ5UGFyYW1zXTsKICAgICAgfQoKICAgICAgcmV0dXJuIGhhbmRsZXIubW9kZWwgJiYgaGFuZGxlci5tb2RlbC5hcHBseShoYW5kbGVyLCBhcmdzKTsKICAgIH0KCiAgICAvKioKICAgICAgQHByaXZhdGUKICAgICAqLwogICAgZnVuY3Rpb24gbG9nKHJvdXRlciwgc2VxdWVuY2UsIG1zZykgewoKICAgICAgaWYgKCFyb3V0ZXIubG9nKSB7IHJldHVybjsgfQoKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDMpIHsKICAgICAgICByb3V0ZXIubG9nKCJUcmFuc2l0aW9uICMiICsgc2VxdWVuY2UgKyAiOiAiICsgbXNnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtc2cgPSBzZXF1ZW5jZTsKICAgICAgICByb3V0ZXIubG9nKG1zZyk7CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAgQHByaXZhdGUKCiAgICAgIEJlZ2lucyBhbmQgcmV0dXJucyBhIFRyYW5zaXRpb24gYmFzZWQgb24gdGhlIHByb3ZpZGVkCiAgICAgIGFyZ3VtZW50cy4gQWNjZXB0cyBhcmd1bWVudHMgaW4gdGhlIGZvcm0gb2YgYm90aCBVUkwKICAgICAgdHJhbnNpdGlvbnMgYW5kIG5hbWVkIHRyYW5zaXRpb25zLgoKICAgICAgQHBhcmFtIHtSb3V0ZXJ9IHJvdXRlcgogICAgICBAcGFyYW0ge0FycmF5W09iamVjdF19IGFyZ3MgYXJndW1lbnRzIHBhc3NlZCB0byB0cmFuc2l0aW9uVG8sCiAgICAgICAgcmVwbGFjZVdpdGgsIG9yIGhhbmRsZVVSTAogICAgKi8KICAgIGZ1bmN0aW9uIGRvVHJhbnNpdGlvbihyb3V0ZXIsIGFyZ3MsIGlzSW50ZXJtZWRpYXRlKSB7CiAgICAgIC8vIE5vcm1hbGl6ZSBibGFuayB0cmFuc2l0aW9ucyB0byByb290IFVSTCB0cmFuc2l0aW9ucy4KICAgICAgdmFyIG5hbWUgPSBhcmdzWzBdIHx8ICcvJzsKCiAgICAgIGlmKGFyZ3MubGVuZ3RoID09PSAxICYmIGFyZ3NbMF0uaGFzT3duUHJvcGVydHkoJ3F1ZXJ5UGFyYW1zJykpIHsKICAgICAgICByZXR1cm4gY3JlYXRlUXVlcnlQYXJhbVRyYW5zaXRpb24ocm91dGVyLCBhcmdzWzBdLCBpc0ludGVybWVkaWF0ZSk7CiAgICAgIH0gZWxzZSBpZiAobmFtZS5jaGFyQXQoMCkgPT09ICcvJykgewogICAgICAgIHJldHVybiBjcmVhdGVVUkxUcmFuc2l0aW9uKHJvdXRlciwgbmFtZSwgaXNJbnRlcm1lZGlhdGUpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBjcmVhdGVOYW1lZFRyYW5zaXRpb24ocm91dGVyLCBzbGljZS5jYWxsKGFyZ3MpLCBpc0ludGVybWVkaWF0ZSk7CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAgQHByaXZhdGUKCiAgICAgIFNlcmlhbGl6ZXMgYSBoYW5kbGVyIHVzaW5nIGl0cyBjdXN0b20gYHNlcmlhbGl6ZWAgbWV0aG9kIG9yCiAgICAgIGJ5IGEgZGVmYXVsdCB0aGF0IGxvb2tzIHVwIHRoZSBleHBlY3RlZCBwcm9wZXJ0eSBuYW1lIGZyb20KICAgICAgdGhlIGR5bmFtaWMgc2VnbWVudC4KCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBoYW5kbGVyIGEgcm91dGVyIGhhbmRsZXIKICAgICAgQHBhcmFtIHtPYmplY3R9IG1vZGVsIHRoZSBtb2RlbCB0byBiZSBzZXJpYWxpemVkIGZvciB0aGlzIGhhbmRsZXIKICAgICAgQHBhcmFtIHtBcnJheVtPYmplY3RdfSBuYW1lcyB0aGUgbmFtZXMgYXJyYXkgYXR0YWNoZWQgdG8gYW4KICAgICAgICBoYW5kbGVyIG9iamVjdCByZXR1cm5lZCBmcm9tIHJvdXRlci5yZWNvZ25pemVyLmhhbmRsZXJzRm9yKCkKICAgICovCiAgICBmdW5jdGlvbiBzZXJpYWxpemUoaGFuZGxlciwgbW9kZWwsIG5hbWVzKSB7CgogICAgICB2YXIgb2JqZWN0ID0ge307CiAgICAgIGlmIChpc1BhcmFtKG1vZGVsKSkgewogICAgICAgIG9iamVjdFtuYW1lc1swXV0gPSBtb2RlbDsKICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICB9CgogICAgICAvLyBVc2UgY3VzdG9tIHNlcmlhbGl6ZSBpZiBpdCBleGlzdHMuCiAgICAgIGlmIChoYW5kbGVyLnNlcmlhbGl6ZSkgewogICAgICAgIHJldHVybiBoYW5kbGVyLnNlcmlhbGl6ZShtb2RlbCwgbmFtZXMpOwogICAgICB9CgogICAgICBpZiAobmFtZXMubGVuZ3RoICE9PSAxKSB7IHJldHVybjsgfQoKICAgICAgdmFyIG5hbWUgPSBuYW1lc1swXTsKCiAgICAgIGlmICgvX2lkJC8udGVzdChuYW1lKSkgewogICAgICAgIG9iamVjdFtuYW1lXSA9IG1vZGVsLmlkOwogICAgICB9IGVsc2UgewogICAgICAgIG9iamVjdFtuYW1lXSA9IG1vZGVsOwogICAgICB9CiAgICAgIHJldHVybiBvYmplY3Q7CiAgICB9CiAgfSk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItcm91dGluZwoqLwoKZnVuY3Rpb24gRFNMKG5hbWUpIHsKICB0aGlzLnBhcmVudCA9IG5hbWU7CiAgdGhpcy5tYXRjaGVzID0gW107Cn0KCkRTTC5wcm90b3R5cGUgPSB7CiAgcmVzb3VyY2U6IGZ1bmN0aW9uKG5hbWUsIG9wdGlvbnMsIGNhbGxiYWNrKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMiAmJiB0eXBlb2Ygb3B0aW9ucyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYWxsYmFjayA9IG9wdGlvbnM7CiAgICAgIG9wdGlvbnMgPSB7fTsKICAgIH0KCiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgICBvcHRpb25zID0ge307CiAgICB9CgogICAgaWYgKHR5cGVvZiBvcHRpb25zLnBhdGggIT09ICdzdHJpbmcnKSB7CiAgICAgIG9wdGlvbnMucGF0aCA9ICIvIiArIG5hbWU7CiAgICB9CgogICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgIHZhciBkc2wgPSBuZXcgRFNMKG5hbWUpOwogICAgICByb3V0ZShkc2wsICdsb2FkaW5nJyk7CiAgICAgIHJvdXRlKGRzbCwgJ2Vycm9yJywgeyBwYXRoOiAiL191bnVzZWRfZHVtbXlfZXJyb3JfcGF0aF9yb3V0ZV8iICsgbmFtZSArICIvOmVycm9yIiB9KTsKICAgICAgY2FsbGJhY2suY2FsbChkc2wpOwogICAgICB0aGlzLnB1c2gob3B0aW9ucy5wYXRoLCBuYW1lLCBkc2wuZ2VuZXJhdGUoKSwgb3B0aW9ucy5xdWVyeVBhcmFtcyk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLnB1c2gob3B0aW9ucy5wYXRoLCBuYW1lLCBudWxsLCBvcHRpb25zLnF1ZXJ5UGFyYW1zKTsKICAgIH0KCgogICAgICB9LAoKICBwdXNoOiBmdW5jdGlvbih1cmwsIG5hbWUsIGNhbGxiYWNrLCBxdWVyeVBhcmFtcykgewogICAgdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgnLicpOwogICAgaWYgKHVybCA9PT0gIiIgfHwgdXJsID09PSAiLyIgfHwgcGFydHNbcGFydHMubGVuZ3RoLTFdID09PSAiaW5kZXgiKSB7IHRoaXMuZXhwbGljaXRJbmRleCA9IHRydWU7IH0KCiAgICB0aGlzLm1hdGNoZXMucHVzaChbdXJsLCBuYW1lLCBjYWxsYmFjaywgcXVlcnlQYXJhbXNdKTsKICB9LAoKICByb3V0ZTogZnVuY3Rpb24obmFtZSwgb3B0aW9ucykgewogICAgcm91dGUodGhpcywgbmFtZSwgb3B0aW9ucyk7CiAgICAgIH0sCgogIGdlbmVyYXRlOiBmdW5jdGlvbigpIHsKICAgIHZhciBkc2xNYXRjaGVzID0gdGhpcy5tYXRjaGVzOwoKICAgIGlmICghdGhpcy5leHBsaWNpdEluZGV4KSB7CiAgICAgIHRoaXMucm91dGUoImluZGV4IiwgeyBwYXRoOiAiLyIgfSk7CiAgICB9CgogICAgcmV0dXJuIGZ1bmN0aW9uKG1hdGNoKSB7CiAgICAgIGZvciAodmFyIGk9MCwgbD1kc2xNYXRjaGVzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICB2YXIgZHNsTWF0Y2ggPSBkc2xNYXRjaGVzW2ldOwogICAgICAgIHZhciBtYXRjaE9iaiA9IG1hdGNoKGRzbE1hdGNoWzBdKS50byhkc2xNYXRjaFsxXSwgZHNsTWF0Y2hbMl0pOwogICAgICAgICAgICAgIH0KICAgIH07CiAgfQp9OwoKZnVuY3Rpb24gcm91dGUoZHNsLCBuYW1lLCBvcHRpb25zKSB7CiAgRW1iZXIuYXNzZXJ0KCJZb3UgbXVzdCB1c2UgYHRoaXMucmVzb3VyY2VgIHRvIG5lc3QiLCB0eXBlb2Ygb3B0aW9ucyAhPT0gJ2Z1bmN0aW9uJyk7CgogIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICBpZiAodHlwZW9mIG9wdGlvbnMucGF0aCAhPT0gJ3N0cmluZycpIHsKICAgIG9wdGlvbnMucGF0aCA9ICIvIiArIG5hbWU7CiAgfQoKICBpZiAoZHNsLnBhcmVudCAmJiBkc2wucGFyZW50ICE9PSAnYXBwbGljYXRpb24nKSB7CiAgICBuYW1lID0gZHNsLnBhcmVudCArICIuIiArIG5hbWU7CiAgfQoKICBkc2wucHVzaChvcHRpb25zLnBhdGgsIG5hbWUsIG51bGwsIG9wdGlvbnMucXVlcnlQYXJhbXMpOwp9CgpEU0wubWFwID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICB2YXIgZHNsID0gbmV3IERTTCgpOwogIGNhbGxiYWNrLmNhbGwoZHNsKTsKICByZXR1cm4gZHNsOwp9OwoKRW1iZXIuUm91dGVyRFNMID0gRFNMOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewp2YXIgZ2V0ID0gRW1iZXIuZ2V0OwoKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1yb3V0aW5nCiovCgovKioKCiAgRmluZHMgYSBjb250cm9sbGVyIGluc3RhbmNlLgoKICBAZm9yIEVtYmVyCiAgQG1ldGhvZCBjb250cm9sbGVyRm9yCiAgQHByaXZhdGUKKi8KRW1iZXIuY29udHJvbGxlckZvciA9IGZ1bmN0aW9uKGNvbnRhaW5lciwgY29udHJvbGxlck5hbWUsIGxvb2t1cE9wdGlvbnMpIHsKICByZXR1cm4gY29udGFpbmVyLmxvb2t1cCgnY29udHJvbGxlcjonICsgY29udHJvbGxlck5hbWUsIGxvb2t1cE9wdGlvbnMpOwp9OwoKLyoqCiAgR2VuZXJhdGVzIGEgY29udHJvbGxlciBmYWN0b3J5CgogIFRoZSB0eXBlIG9mIHRoZSBnZW5lcmF0ZWQgY29udHJvbGxlciBmYWN0b3J5IGlzIGRlcml2ZWQKICBmcm9tIHRoZSBjb250ZXh0LiBJZiB0aGUgY29udGV4dCBpcyBhbiBhcnJheSBhbiBhcnJheSBjb250cm9sbGVyCiAgaXMgZ2VuZXJhdGVkLCBpZiBhbiBvYmplY3QsIGFuIG9iamVjdCBjb250cm9sbGVyIG90aGVyd2lzZSwgYSBiYXNpYwogIGNvbnRyb2xsZXIgaXMgZ2VuZXJhdGVkLgoKICBZb3UgY2FuIGN1c3RvbWl6ZSB5b3VyIGdlbmVyYXRlZCBjb250cm9sbGVycyBieSBkZWZpbmluZwogIGBBcHAuT2JqZWN0Q29udHJvbGxlcmAgb3IgYEFwcC5BcnJheUNvbnRyb2xsZXJgLgoKICBAZm9yIEVtYmVyCiAgQG1ldGhvZCBnZW5lcmF0ZUNvbnRyb2xsZXJGYWN0b3J5CiAgQHByaXZhdGUKKi8KRW1iZXIuZ2VuZXJhdGVDb250cm9sbGVyRmFjdG9yeSA9IGZ1bmN0aW9uKGNvbnRhaW5lciwgY29udHJvbGxlck5hbWUsIGNvbnRleHQpIHsKICB2YXIgRmFjdG9yeSwgZnVsbE5hbWUsIGluc3RhbmNlLCBuYW1lLCBmYWN0b3J5TmFtZSwgY29udHJvbGxlclR5cGU7CgogIGlmIChjb250ZXh0ICYmIEVtYmVyLmlzQXJyYXkoY29udGV4dCkpIHsKICAgIGNvbnRyb2xsZXJUeXBlID0gJ2FycmF5JzsKICB9IGVsc2UgaWYgKGNvbnRleHQpIHsKICAgIGNvbnRyb2xsZXJUeXBlID0gJ29iamVjdCc7CiAgfSBlbHNlIHsKICAgIGNvbnRyb2xsZXJUeXBlID0gJ2Jhc2ljJzsKICB9CgogIGZhY3RvcnlOYW1lID0gJ2NvbnRyb2xsZXI6JyArIGNvbnRyb2xsZXJUeXBlOwoKICBGYWN0b3J5ID0gY29udGFpbmVyLmxvb2t1cEZhY3RvcnkoZmFjdG9yeU5hbWUpLmV4dGVuZCh7CiAgICBpc0dlbmVyYXRlZDogdHJ1ZSwKICAgIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICIoZ2VuZXJhdGVkICIgKyBjb250cm9sbGVyTmFtZSArICIgY29udHJvbGxlcikiOwogICAgfQogIH0pOwoKICBmdWxsTmFtZSA9ICdjb250cm9sbGVyOicgKyBjb250cm9sbGVyTmFtZTsKCiAgY29udGFpbmVyLnJlZ2lzdGVyKGZ1bGxOYW1lLCAgRmFjdG9yeSk7CgogIHJldHVybiBGYWN0b3J5Owp9OwoKLyoqCiAgR2VuZXJhdGVzIGFuZCBpbnN0YW50aWF0ZXMgYSBjb250cm9sbGVyLgoKICBUaGUgdHlwZSBvZiB0aGUgZ2VuZXJhdGVkIGNvbnRyb2xsZXIgZmFjdG9yeSBpcyBkZXJpdmVkCiAgZnJvbSB0aGUgY29udGV4dC4gSWYgdGhlIGNvbnRleHQgaXMgYW4gYXJyYXkgYW4gYXJyYXkgY29udHJvbGxlcgogIGlzIGdlbmVyYXRlZCwgaWYgYW4gb2JqZWN0LCBhbiBvYmplY3QgY29udHJvbGxlciBvdGhlcndpc2UsIGEgYmFzaWMKICBjb250cm9sbGVyIGlzIGdlbmVyYXRlZC4KCiAgQGZvciBFbWJlcgogIEBtZXRob2QgZ2VuZXJhdGVDb250cm9sbGVyCiAgQHByaXZhdGUKKi8KRW1iZXIuZ2VuZXJhdGVDb250cm9sbGVyID0gZnVuY3Rpb24oY29udGFpbmVyLCBjb250cm9sbGVyTmFtZSwgY29udGV4dCkgewogIEVtYmVyLmdlbmVyYXRlQ29udHJvbGxlckZhY3RvcnkoY29udGFpbmVyLCBjb250cm9sbGVyTmFtZSwgY29udGV4dCk7CiAgdmFyIGZ1bGxOYW1lID0gJ2NvbnRyb2xsZXI6JyArIGNvbnRyb2xsZXJOYW1lOwogIHZhciBpbnN0YW5jZSA9IGNvbnRhaW5lci5sb29rdXAoZnVsbE5hbWUpOwoKICBpZiAoZ2V0KGluc3RhbmNlLCAnbmFtZXNwYWNlLkxPR19BQ1RJVkVfR0VORVJBVElPTicpKSB7CiAgICBFbWJlci5Mb2dnZXIuaW5mbygiZ2VuZXJhdGVkIC0+ICIgKyBmdWxsTmFtZSwgeyBmdWxsTmFtZTogZnVsbE5hbWUgfSk7CiAgfQoKICByZXR1cm4gaW5zdGFuY2U7Cn07Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItcm91dGluZwoqLwoKdmFyIFJvdXRlciA9IHJlcXVpcmVNb2R1bGUoInJvdXRlciIpWydkZWZhdWx0J107CnZhciBnZXQgPSBFbWJlci5nZXQsIHNldCA9IEVtYmVyLnNldDsKdmFyIGRlZmluZVByb3BlcnR5ID0gRW1iZXIuZGVmaW5lUHJvcGVydHk7CnZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKCnZhciBEZWZhdWx0VmlldyA9IEVtYmVyLl9NZXRhbW9ycGhWaWV3OwovKioKICBUaGUgYEVtYmVyLlJvdXRlcmAgY2xhc3MgbWFuYWdlcyB0aGUgYXBwbGljYXRpb24gc3RhdGUgYW5kIFVSTHMuIFJlZmVyIHRvCiAgdGhlIFtyb3V0aW5nIGd1aWRlXShodHRwOi8vZW1iZXJqcy5jb20vZ3VpZGVzL3JvdXRpbmcvKSBmb3IgZG9jdW1lbnRhdGlvbi4KCiAgQGNsYXNzIFJvdXRlcgogIEBuYW1lc3BhY2UgRW1iZXIKICBAZXh0ZW5kcyBFbWJlci5PYmplY3QKKi8KRW1iZXIuUm91dGVyID0gRW1iZXIuT2JqZWN0LmV4dGVuZChFbWJlci5FdmVudGVkLCB7CiAgLyoqCiAgICBUaGUgYGxvY2F0aW9uYCBwcm9wZXJ0eSBkZXRlcm1pbmVzIHRoZSB0eXBlIG9mIFVSTCdzIHRoYXQgeW91cgogICAgYXBwbGljYXRpb24gd2lsbCB1c2UuCgogICAgVGhlIGZvbGxvd2luZyBsb2NhdGlvbiB0eXBlcyBhcmUgY3VycmVudGx5IGF2YWlsYWJsZToKCiAgICAqIGBoYXNoYAogICAgKiBgaGlzdG9yeWAKICAgICogYG5vbmVgCgogICAgQHByb3BlcnR5IGxvY2F0aW9uCiAgICBAZGVmYXVsdCAnaGFzaCcKICAgIEBzZWUge0VtYmVyLkxvY2F0aW9ufQogICovCiAgbG9jYXRpb246ICdoYXNoJywKCiAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLnJvdXRlciA9IHRoaXMuY29uc3RydWN0b3Iucm91dGVyIHx8IHRoaXMuY29uc3RydWN0b3IubWFwKEVtYmVyLkspOwogICAgdGhpcy5fYWN0aXZlVmlld3MgPSB7fTsKICAgIHRoaXMuX3NldHVwTG9jYXRpb24oKTsKCiAgICBpZiAoZ2V0KHRoaXMsICduYW1lc3BhY2UuTE9HX1RSQU5TSVRJT05TX0lOVEVSTkFMJykpIHsKICAgICAgdGhpcy5yb3V0ZXIubG9nID0gRW1iZXIuTG9nZ2VyLmRlYnVnOwogICAgfQogIH0sCgogIC8qKgogICAgUmVwcmVzZW50cyB0aGUgY3VycmVudCBVUkwuCgogICAgQG1ldGhvZCB1cmwKICAgIEByZXR1cm5zIHtTdHJpbmd9IFRoZSBjdXJyZW50IFVSTC4KICAqLwogIHVybDogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gZ2V0KHRoaXMsICdsb2NhdGlvbicpLmdldFVSTCgpOwogIH0pLAoKICAvKioKICAgIEluaXRpYWxpemVzIHRoZSBjdXJyZW50IHJvdXRlciBpbnN0YW5jZSBhbmQgc2V0cyB1cCB0aGUgY2hhbmdlIGhhbmRsaW5nCiAgICBldmVudCBsaXN0ZW5lcnMgdXNlZCBieSB0aGUgaW5zdGFuY2VzIGBsb2NhdGlvbmAgaW1wbGVtZW50YXRpb24uCgogICAgQG1ldGhvZCBzdGFydFJvdXRpbmcKICAgIEBwcml2YXRlCiAgKi8KICBzdGFydFJvdXRpbmc6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5yb3V0ZXIgPSB0aGlzLnJvdXRlciB8fCB0aGlzLmNvbnN0cnVjdG9yLm1hcChFbWJlci5LKTsKCiAgICB2YXIgcm91dGVyID0gdGhpcy5yb3V0ZXIsCiAgICAgICAgbG9jYXRpb24gPSBnZXQodGhpcywgJ2xvY2F0aW9uJyksCiAgICAgICAgY29udGFpbmVyID0gdGhpcy5jb250YWluZXIsCiAgICAgICAgc2VsZiA9IHRoaXM7CgogICAgdGhpcy5fc2V0dXBSb3V0ZXIocm91dGVyLCBsb2NhdGlvbik7CgogICAgY29udGFpbmVyLnJlZ2lzdGVyKCd2aWV3OmRlZmF1bHQnLCBEZWZhdWx0Vmlldyk7CiAgICBjb250YWluZXIucmVnaXN0ZXIoJ3ZpZXc6dG9wbGV2ZWwnLCBFbWJlci5WaWV3LmV4dGVuZCgpKTsKCiAgICBsb2NhdGlvbi5vblVwZGF0ZVVSTChmdW5jdGlvbih1cmwpIHsKICAgICAgc2VsZi5oYW5kbGVVUkwodXJsKTsKICAgIH0pOwoKICAgIHRoaXMuaGFuZGxlVVJMKGxvY2F0aW9uLmdldFVSTCgpKTsKICB9LAoKICAvKioKICAgIEhhbmRsZXMgdXBkYXRpbmcgdGhlIHBhdGhzIGFuZCBub3RpZnlpbmcgYW55IGxpc3RlbmVycyBvZiB0aGUgVVJMCiAgICBjaGFuZ2UuCgogICAgVHJpZ2dlcnMgdGhlIHJvdXRlciBsZXZlbCBgZGlkVHJhbnNpdGlvbmAgaG9vay4KCiAgICBAbWV0aG9kIGRpZFRyYW5zaXRpb24KICAgIEBwcml2YXRlCiAgKi8KICBkaWRUcmFuc2l0aW9uOiBmdW5jdGlvbihpbmZvcykgewogICAgdXBkYXRlUGF0aHModGhpcyk7CgogICAgdGhpcy5fY2FuY2VsTG9hZGluZ0V2ZW50KCk7CgogICAgdGhpcy5ub3RpZnlQcm9wZXJ0eUNoYW5nZSgndXJsJyk7CgogICAgLy8gUHV0IHRoaXMgaW4gdGhlIHJ1bmxvb3Agc28gdXJsIHdpbGwgYmUgYWNjdXJhdGUuIFNlZW1zCiAgICAvLyBsZXNzIHN1cnByaXNpbmcgdGhhbiBkaWRUcmFuc2l0aW9uIGJlaW5nIG91dCBvZiBzeW5jLgogICAgRW1iZXIucnVuLm9uY2UodGhpcywgdGhpcy50cmlnZ2VyLCAnZGlkVHJhbnNpdGlvbicpOwoKICAgIGlmIChnZXQodGhpcywgJ25hbWVzcGFjZScpLkxPR19UUkFOU0lUSU9OUykgewogICAgICBFbWJlci5Mb2dnZXIubG9nKCJUcmFuc2l0aW9uZWQgaW50byAnIiArIEVtYmVyLlJvdXRlci5fcm91dGVQYXRoKGluZm9zKSArICInIik7CiAgICB9CiAgfSwKCiAgaGFuZGxlVVJMOiBmdW5jdGlvbih1cmwpIHsKICAgIHJldHVybiB0aGlzLl9kb1RyYW5zaXRpb24oJ2hhbmRsZVVSTCcsIFt1cmxdKTsKICB9LAoKICB0cmFuc2l0aW9uVG86IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX2RvVHJhbnNpdGlvbigndHJhbnNpdGlvblRvJywgYXJndW1lbnRzKTsKICB9LAoKICBpbnRlcm1lZGlhdGVUcmFuc2l0aW9uVG86IGZ1bmN0aW9uKCkgewogICAgdGhpcy5yb3V0ZXIuaW50ZXJtZWRpYXRlVHJhbnNpdGlvblRvLmFwcGx5KHRoaXMucm91dGVyLCBhcmd1bWVudHMpOwoKICAgIHVwZGF0ZVBhdGhzKHRoaXMpOwoKICAgIHZhciBpbmZvcyA9IHRoaXMucm91dGVyLmN1cnJlbnRIYW5kbGVySW5mb3M7CiAgICBpZiAoZ2V0KHRoaXMsICduYW1lc3BhY2UnKS5MT0dfVFJBTlNJVElPTlMpIHsKICAgICAgRW1iZXIuTG9nZ2VyLmxvZygiSW50ZXJtZWRpYXRlLXRyYW5zaXRpb25lZCBpbnRvICciICsgRW1iZXIuUm91dGVyLl9yb3V0ZVBhdGgoaW5mb3MpICsgIiciKTsKICAgIH0KICB9LAoKICByZXBsYWNlV2l0aDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fZG9UcmFuc2l0aW9uKCdyZXBsYWNlV2l0aCcsIGFyZ3VtZW50cyk7CiAgfSwKCiAgZ2VuZXJhdGU6IGZ1bmN0aW9uKCkgewogICAgdmFyIHVybCA9IHRoaXMucm91dGVyLmdlbmVyYXRlLmFwcGx5KHRoaXMucm91dGVyLCBhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMubG9jYXRpb24uZm9ybWF0VVJMKHVybCk7CiAgfSwKCiAgLyoqCiAgICBEZXRlcm1pbmVzIGlmIHRoZSBzdXBwbGllZCByb3V0ZSBpcyBjdXJyZW50bHkgYWN0aXZlLgoKICAgIEBtZXRob2QgaXNBY3RpdmUKICAgIEBwYXJhbSByb3V0ZU5hbWUKICAgIEByZXR1cm5zIHtCb29sZWFufQogICAgQHByaXZhdGUKICAqLwogIGlzQWN0aXZlOiBmdW5jdGlvbihyb3V0ZU5hbWUpIHsKICAgIHZhciByb3V0ZXIgPSB0aGlzLnJvdXRlcjsKICAgIHJldHVybiByb3V0ZXIuaXNBY3RpdmUuYXBwbHkocm91dGVyLCBhcmd1bWVudHMpOwogIH0sCgogIHNlbmQ6IGZ1bmN0aW9uKG5hbWUsIGNvbnRleHQpIHsKICAgIHRoaXMucm91dGVyLnRyaWdnZXIuYXBwbHkodGhpcy5yb3V0ZXIsIGFyZ3VtZW50cyk7CiAgfSwKCiAgLyoqCiAgICBEb2VzIHRoaXMgcm91dGVyIGluc3RhbmNlIGhhdmUgdGhlIGdpdmVuIHJvdXRlLgoKICAgIEBtZXRob2QgaGFzUm91dGUKICAgIEByZXR1cm5zIHtCb29sZWFufQogICAgQHByaXZhdGUKICAqLwogIGhhc1JvdXRlOiBmdW5jdGlvbihyb3V0ZSkgewogICAgcmV0dXJuIHRoaXMucm91dGVyLmhhc1JvdXRlKHJvdXRlKTsKICB9LAoKICAvKioKICAgIFJlc2V0cyB0aGUgc3RhdGUgb2YgdGhlIHJvdXRlciBieSBjbGVhcmluZyB0aGUgY3VycmVudCByb3V0ZQogICAgaGFuZGxlcnMgYW5kIGRlYWN0aXZhdGluZyB0aGVtLgoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIHJlc2V0CiAgICovCiAgcmVzZXQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5yb3V0ZXIucmVzZXQoKTsKICB9LAoKICB3aWxsRGVzdHJveTogZnVuY3Rpb24oKXsKICAgIHZhciBsb2NhdGlvbiA9IGdldCh0aGlzLCAnbG9jYXRpb24nKTsKICAgIGxvY2F0aW9uLmRlc3Ryb3koKTsKCiAgICB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0sCgogIF9sb29rdXBBY3RpdmVWaWV3OiBmdW5jdGlvbih0ZW1wbGF0ZU5hbWUpIHsKICAgIHZhciBhY3RpdmUgPSB0aGlzLl9hY3RpdmVWaWV3c1t0ZW1wbGF0ZU5hbWVdOwogICAgcmV0dXJuIGFjdGl2ZSAmJiBhY3RpdmVbMF07CiAgfSwKCiAgX2Nvbm5lY3RBY3RpdmVWaWV3OiBmdW5jdGlvbih0ZW1wbGF0ZU5hbWUsIHZpZXcpIHsKICAgIHZhciBleGlzdGluZyA9IHRoaXMuX2FjdGl2ZVZpZXdzW3RlbXBsYXRlTmFtZV07CgogICAgaWYgKGV4aXN0aW5nKSB7CiAgICAgIGV4aXN0aW5nWzBdLm9mZignd2lsbERlc3Ryb3lFbGVtZW50JywgdGhpcywgZXhpc3RpbmdbMV0pOwogICAgfQoKICAgIHZhciBkaXNjb25uZWN0ID0gZnVuY3Rpb24oKSB7CiAgICAgIGRlbGV0ZSB0aGlzLl9hY3RpdmVWaWV3c1t0ZW1wbGF0ZU5hbWVdOwogICAgfTsKCiAgICB0aGlzLl9hY3RpdmVWaWV3c1t0ZW1wbGF0ZU5hbWVdID0gW3ZpZXcsIGRpc2Nvbm5lY3RdOwogICAgdmlldy5vbmUoJ3dpbGxEZXN0cm95RWxlbWVudCcsIHRoaXMsIGRpc2Nvbm5lY3QpOwogIH0sCgogIF9zZXR1cExvY2F0aW9uOiBmdW5jdGlvbigpIHsKICAgIHZhciBsb2NhdGlvbiA9IGdldCh0aGlzLCAnbG9jYXRpb24nKSwKICAgICAgICByb290VVJMID0gZ2V0KHRoaXMsICdyb290VVJMJyksCiAgICAgICAgb3B0aW9ucyA9IHt9OwoKICAgIGlmICh0eXBlb2Ygcm9vdFVSTCA9PT0gJ3N0cmluZycpIHsKICAgICAgb3B0aW9ucy5yb290VVJMID0gcm9vdFVSTDsKICAgIH0KCiAgICBpZiAoJ3N0cmluZycgPT09IHR5cGVvZiBsb2NhdGlvbikgewogICAgICBvcHRpb25zLmltcGxlbWVudGF0aW9uID0gbG9jYXRpb247CiAgICAgIGxvY2F0aW9uID0gc2V0KHRoaXMsICdsb2NhdGlvbicsIEVtYmVyLkxvY2F0aW9uLmNyZWF0ZShvcHRpb25zKSk7CiAgICB9CgogICAgLy8gZW5zdXJlIHRoYXQgaW5pdFN0YXRlIGlzIGNhbGxlZCBBRlRFUiB0aGUgcm9vdFVSTCBpcyBzZXQgb24KICAgIC8vIHRoZSBsb2NhdGlvbiBpbnN0YW5jZQogICAgaWYgKHR5cGVvZiBsb2NhdGlvbi5pbml0U3RhdGUgPT09ICdmdW5jdGlvbicpIHsgbG9jYXRpb24uaW5pdFN0YXRlKCk7IH0KICB9LAoKICBfZ2V0SGFuZGxlckZ1bmN0aW9uOiBmdW5jdGlvbigpIHsKICAgIHZhciBzZWVuID0ge30sIGNvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyLAogICAgICAgIERlZmF1bHRSb3V0ZSA9IGNvbnRhaW5lci5sb29rdXBGYWN0b3J5KCdyb3V0ZTpiYXNpYycpLAogICAgICAgIHNlbGYgPSB0aGlzOwoKICAgIHJldHVybiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHZhciByb3V0ZU5hbWUgPSAncm91dGU6JyArIG5hbWUsCiAgICAgICAgICBoYW5kbGVyID0gY29udGFpbmVyLmxvb2t1cChyb3V0ZU5hbWUpOwoKICAgICAgaWYgKHNlZW5bbmFtZV0pIHsgcmV0dXJuIGhhbmRsZXI7IH0KCiAgICAgIHNlZW5bbmFtZV0gPSB0cnVlOwoKICAgICAgaWYgKCFoYW5kbGVyKSB7CiAgICAgICAgY29udGFpbmVyLnJlZ2lzdGVyKHJvdXRlTmFtZSwgRGVmYXVsdFJvdXRlLmV4dGVuZCgpKTsKICAgICAgICBoYW5kbGVyID0gY29udGFpbmVyLmxvb2t1cChyb3V0ZU5hbWUpOwoKICAgICAgICBpZiAoZ2V0KHNlbGYsICduYW1lc3BhY2UuTE9HX0FDVElWRV9HRU5FUkFUSU9OJykpIHsKICAgICAgICAgIEVtYmVyLkxvZ2dlci5pbmZvKCJnZW5lcmF0ZWQgLT4gIiArIHJvdXRlTmFtZSwgeyBmdWxsTmFtZTogcm91dGVOYW1lIH0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaGFuZGxlci5yb3V0ZU5hbWUgPSBuYW1lOwogICAgICByZXR1cm4gaGFuZGxlcjsKICAgIH07CiAgfSwKCiAgX3NldHVwUm91dGVyOiBmdW5jdGlvbihyb3V0ZXIsIGxvY2F0aW9uKSB7CiAgICB2YXIgbGFzdFVSTCwgZW1iZXJSb3V0ZXIgPSB0aGlzOwoKICAgIHJvdXRlci5nZXRIYW5kbGVyID0gdGhpcy5fZ2V0SGFuZGxlckZ1bmN0aW9uKCk7CgogICAgdmFyIGRvVXBkYXRlVVJMID0gZnVuY3Rpb24oKSB7CiAgICAgIGxvY2F0aW9uLnNldFVSTChsYXN0VVJMKTsKICAgIH07CgogICAgcm91dGVyLnVwZGF0ZVVSTCA9IGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgbGFzdFVSTCA9IHBhdGg7CiAgICAgIEVtYmVyLnJ1bi5vbmNlKGRvVXBkYXRlVVJMKTsKICAgIH07CgogICAgaWYgKGxvY2F0aW9uLnJlcGxhY2VVUkwpIHsKICAgICAgdmFyIGRvUmVwbGFjZVVSTCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGxvY2F0aW9uLnJlcGxhY2VVUkwobGFzdFVSTCk7CiAgICAgIH07CgogICAgICByb3V0ZXIucmVwbGFjZVVSTCA9IGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgICBsYXN0VVJMID0gcGF0aDsKICAgICAgICBFbWJlci5ydW4ub25jZShkb1JlcGxhY2VVUkwpOwogICAgICB9OwogICAgfQoKICAgIHJvdXRlci5kaWRUcmFuc2l0aW9uID0gZnVuY3Rpb24oaW5mb3MpIHsKICAgICAgZW1iZXJSb3V0ZXIuZGlkVHJhbnNpdGlvbihpbmZvcyk7CiAgICB9OwogIH0sCgogIF9kb1RyYW5zaXRpb246IGZ1bmN0aW9uKG1ldGhvZCwgYXJncykgewogICAgLy8gTm9ybWFsaXplIGJsYW5rIHJvdXRlIHRvIHJvb3QgVVJMLgogICAgYXJncyA9IHNsaWNlLmNhbGwoYXJncyk7CiAgICBhcmdzWzBdID0gYXJnc1swXSB8fCAnLyc7CgogICAgdmFyIHBhc3NlZE5hbWUgPSBhcmdzWzBdLCBuYW1lLCBzZWxmID0gdGhpcywKICAgICAgaXNRdWVyeVBhcmFtc09ubHkgPSBmYWxzZTsKCiAgICAKICAgIGlmICghaXNRdWVyeVBhcmFtc09ubHkgJiYgcGFzc2VkTmFtZS5jaGFyQXQoMCkgPT09ICcvJykgewogICAgICBuYW1lID0gcGFzc2VkTmFtZTsKICAgIH0gZWxzZSBpZiAoIWlzUXVlcnlQYXJhbXNPbmx5KSB7CiAgICAgIGlmICghdGhpcy5yb3V0ZXIuaGFzUm91dGUocGFzc2VkTmFtZSkpIHsKICAgICAgICBuYW1lID0gYXJnc1swXSA9IHBhc3NlZE5hbWUgKyAnLmluZGV4JzsKICAgICAgfSBlbHNlIHsKICAgICAgICBuYW1lID0gcGFzc2VkTmFtZTsKICAgICAgfQoKICAgICAgRW1iZXIuYXNzZXJ0KCJUaGUgcm91dGUgIiArIHBhc3NlZE5hbWUgKyAiIHdhcyBub3QgZm91bmQiLCB0aGlzLnJvdXRlci5oYXNSb3V0ZShuYW1lKSk7CiAgICB9CgogICAgdmFyIHRyYW5zaXRpb25Qcm9taXNlID0gdGhpcy5yb3V0ZXJbbWV0aG9kXS5hcHBseSh0aGlzLnJvdXRlciwgYXJncyk7CgogICAgdHJhbnNpdGlvblByb21pc2UudGhlbihudWxsLCBmdW5jdGlvbihlcnJvcikgewogICAgICBpZiAoZXJyb3IubmFtZSA9PT0gIlVucmVjb2duaXplZFVSTEVycm9yIikgewogICAgICAgIEVtYmVyLmFzc2VydCgiVGhlIFVSTCAnIiArIGVycm9yLm1lc3NhZ2UgKyAiJyBkaWQgbm90IG1hdGNoIGFueSByb3V0ZXMgaW4geW91ciBhcHBsaWNhdGlvbiIpOwogICAgICB9CiAgICB9LCAnRW1iZXI6IENoZWNrIGZvciBSb3V0ZXIgdW5yZWNvZ25pemVkIFVSTCBlcnJvcicpOwoKICAgIC8vIFdlIHdhbnQgdG8gcmV0dXJuIHRoZSBjb25maWd1cmFibGUgcHJvbWlzZSBvYmplY3QKICAgIC8vIHNvIHRoYXQgY2FsbGVycyBvZiB0aGlzIGZ1bmN0aW9uIGNhbiB1c2UgYC5tZXRob2QoKWAgb24gaXQsCiAgICAvLyB3aGljaCBvYnZpb3VzbHkgZG9lc24ndCBleGlzdCBmb3Igbm9ybWFsIFJTVlAgcHJvbWlzZXMuCiAgICByZXR1cm4gdHJhbnNpdGlvblByb21pc2U7CiAgfSwKCiAgX3NjaGVkdWxlTG9hZGluZ0V2ZW50OiBmdW5jdGlvbih0cmFuc2l0aW9uLCBvcmlnaW5Sb3V0ZSkgewogICAgdGhpcy5fY2FuY2VsTG9hZGluZ0V2ZW50KCk7CiAgICB0aGlzLl9sb2FkaW5nU3RhdGVUaW1lciA9IEVtYmVyLnJ1bi5zY2hlZHVsZU9uY2UoJ3JvdXRlclRyYW5zaXRpb25zJywgdGhpcywgJ19maXJlTG9hZGluZ0V2ZW50JywgdHJhbnNpdGlvbiwgb3JpZ2luUm91dGUpOwogIH0sCgogIF9maXJlTG9hZGluZ0V2ZW50OiBmdW5jdGlvbih0cmFuc2l0aW9uLCBvcmlnaW5Sb3V0ZSkgewogICAgaWYgKCF0aGlzLnJvdXRlci5hY3RpdmVUcmFuc2l0aW9uKSB7CiAgICAgIC8vIERvbid0IGZpcmUgYW4gZXZlbnQgaWYgd2UndmUgc2luY2UgbW92ZWQgb24gZnJvbQogICAgICAvLyB0aGUgdHJhbnNpdGlvbiB0aGF0IHB1dCB1cyBpbiBhIGxvYWRpbmcgc3RhdGUuCiAgICAgIHJldHVybjsKICAgIH0KCiAgICB0cmFuc2l0aW9uLnRyaWdnZXIodHJ1ZSwgJ2xvYWRpbmcnLCB0cmFuc2l0aW9uLCBvcmlnaW5Sb3V0ZSk7CiAgfSwKCiAgX2NhbmNlbExvYWRpbmdFdmVudDogZnVuY3Rpb24gKCkgewogICAgaWYgKHRoaXMuX2xvYWRpbmdTdGF0ZVRpbWVyKSB7CiAgICAgIEVtYmVyLnJ1bi5jYW5jZWwodGhpcy5fbG9hZGluZ1N0YXRlVGltZXIpOwogICAgfQogICAgdGhpcy5fbG9hZGluZ1N0YXRlVGltZXIgPSBudWxsOwogIH0KfSk7CgovKioKICBIZWxwZXIgZnVuY3Rpb24gZm9yIGl0ZXJhdGluZyByb290LXdhcmQsIHN0YXJ0aW5nCiAgZnJvbSAoYnV0IG5vdCBpbmNsdWRpbmcpIHRoZSBwcm92aWRlZCBgb3JpZ2luUm91dGVgLgoKICBSZXR1cm5zIHRydWUgaWYgdGhlIGxhc3QgY2FsbGJhY2sgZmlyZWQgcmVxdWVzdGVkCiAgdG8gYnViYmxlIHVwd2FyZC4KCiAgQHByaXZhdGUKICovCmZ1bmN0aW9uIGZvckVhY2hSb3V0ZUFib3ZlKG9yaWdpblJvdXRlLCB0cmFuc2l0aW9uLCBjYWxsYmFjaykgewogIHZhciBoYW5kbGVySW5mb3MgPSB0cmFuc2l0aW9uLmhhbmRsZXJJbmZvcywKICAgICAgb3JpZ2luUm91dGVGb3VuZCA9IGZhbHNlOwoKICBmb3IgKHZhciBpID0gaGFuZGxlckluZm9zLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICB2YXIgaGFuZGxlckluZm8gPSBoYW5kbGVySW5mb3NbaV0sCiAgICAgICAgcm91dGUgPSBoYW5kbGVySW5mby5oYW5kbGVyOwoKICAgIGlmICghb3JpZ2luUm91dGVGb3VuZCkgewogICAgICBpZiAob3JpZ2luUm91dGUgPT09IHJvdXRlKSB7CiAgICAgICAgb3JpZ2luUm91dGVGb3VuZCA9IHRydWU7CiAgICAgIH0KICAgICAgY29udGludWU7CiAgICB9CgogICAgaWYgKGNhbGxiYWNrKHJvdXRlLCBoYW5kbGVySW5mb3NbaSArIDFdLmhhbmRsZXIpICE9PSB0cnVlKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CiAgcmV0dXJuIHRydWU7Cn0KCi8vIFRoZXNlIGdldCBpbnZva2VkIHdoZW4gYW4gYWN0aW9uIGJ1YmJsZXMgYWJvdmUgQXBwbGljYXRpb25Sb3V0ZQovLyBhbmQgYXJlIG5vdCBtZWFudCB0byBiZSBvdmVycmlkYWJsZS4KdmFyIGRlZmF1bHRBY3Rpb25IYW5kbGVycyA9IHsKCiAgd2lsbFJlc29sdmVNb2RlbDogZnVuY3Rpb24odHJhbnNpdGlvbiwgb3JpZ2luUm91dGUpIHsKICAgIG9yaWdpblJvdXRlLnJvdXRlci5fc2NoZWR1bGVMb2FkaW5nRXZlbnQodHJhbnNpdGlvbiwgb3JpZ2luUm91dGUpOwogIH0sCgogIGVycm9yOiBmdW5jdGlvbihlcnJvciwgdHJhbnNpdGlvbiwgb3JpZ2luUm91dGUpIHsKICAgIC8vIEF0dGVtcHQgdG8gZmluZCBhbiBhcHByb3ByaWF0ZSBlcnJvciBzdWJzdGF0ZSB0byBlbnRlci4KICAgIHZhciByb3V0ZXIgPSBvcmlnaW5Sb3V0ZS5yb3V0ZXI7CgogICAgdmFyIHRyeVRvcExldmVsID0gZm9yRWFjaFJvdXRlQWJvdmUob3JpZ2luUm91dGUsIHRyYW5zaXRpb24sIGZ1bmN0aW9uKHJvdXRlLCBjaGlsZFJvdXRlKSB7CiAgICAgIHZhciBjaGlsZEVycm9yUm91dGVOYW1lID0gZmluZENoaWxkUm91dGVOYW1lKHJvdXRlLCBjaGlsZFJvdXRlLCAnZXJyb3InKTsKICAgICAgaWYgKGNoaWxkRXJyb3JSb3V0ZU5hbWUpIHsKICAgICAgICByb3V0ZXIuaW50ZXJtZWRpYXRlVHJhbnNpdGlvblRvKGNoaWxkRXJyb3JSb3V0ZU5hbWUsIGVycm9yKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9KTsKCiAgICBpZiAodHJ5VG9wTGV2ZWwpIHsKICAgICAgLy8gQ2hlY2sgZm9yIHRvcC1sZXZlbCBlcnJvciBzdGF0ZSB0byBlbnRlci4KICAgICAgaWYgKHJvdXRlSGFzQmVlbkRlZmluZWQob3JpZ2luUm91dGUucm91dGVyLCAnYXBwbGljYXRpb25fZXJyb3InKSkgewogICAgICAgIHJvdXRlci5pbnRlcm1lZGlhdGVUcmFuc2l0aW9uVG8oJ2FwcGxpY2F0aW9uX2Vycm9yJywgZXJyb3IpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gRG9uJ3QgZmlyZSBhbiBhc3NlcnRpb24gaWYgd2UgZm91bmQgYW4gZXJyb3Igc3Vic3RhdGUuCiAgICAgIHJldHVybjsKICAgIH0KCiAgICBFbWJlci5Mb2dnZXIuZXJyb3IoJ0Vycm9yIHdoaWxlIGxvYWRpbmcgcm91dGU6ICcgKyBlcnJvci5zdGFjayk7CiAgfSwKCiAgbG9hZGluZzogZnVuY3Rpb24odHJhbnNpdGlvbiwgb3JpZ2luUm91dGUpIHsKICAgIC8vIEF0dGVtcHQgdG8gZmluZCBhbiBhcHByb3ByaWF0ZSBsb2FkaW5nIHN1YnN0YXRlIHRvIGVudGVyLgogICAgdmFyIHJvdXRlciA9IG9yaWdpblJvdXRlLnJvdXRlcjsKCiAgICB2YXIgdHJ5VG9wTGV2ZWwgPSBmb3JFYWNoUm91dGVBYm92ZShvcmlnaW5Sb3V0ZSwgdHJhbnNpdGlvbiwgZnVuY3Rpb24ocm91dGUsIGNoaWxkUm91dGUpIHsKICAgICAgdmFyIGNoaWxkTG9hZGluZ1JvdXRlTmFtZSA9IGZpbmRDaGlsZFJvdXRlTmFtZShyb3V0ZSwgY2hpbGRSb3V0ZSwgJ2xvYWRpbmcnKTsKCiAgICAgIGlmIChjaGlsZExvYWRpbmdSb3V0ZU5hbWUpIHsKICAgICAgICByb3V0ZXIuaW50ZXJtZWRpYXRlVHJhbnNpdGlvblRvKGNoaWxkTG9hZGluZ1JvdXRlTmFtZSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBEb24ndCBidWJibGUgYWJvdmUgcGl2b3Qgcm91dGUuCiAgICAgIGlmICh0cmFuc2l0aW9uLnBpdm90SGFuZGxlciAhPT0gcm91dGUpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfSk7CgogICAgaWYgKHRyeVRvcExldmVsKSB7CiAgICAgIC8vIENoZWNrIGZvciB0b3AtbGV2ZWwgbG9hZGluZyBzdGF0ZSB0byBlbnRlci4KICAgICAgaWYgKHJvdXRlSGFzQmVlbkRlZmluZWQob3JpZ2luUm91dGUucm91dGVyLCAnYXBwbGljYXRpb25fbG9hZGluZycpKSB7CiAgICAgICAgcm91dGVyLmludGVybWVkaWF0ZVRyYW5zaXRpb25UbygnYXBwbGljYXRpb25fbG9hZGluZycpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogIH0KfTsKCmZ1bmN0aW9uIGZpbmRDaGlsZFJvdXRlTmFtZShwYXJlbnRSb3V0ZSwgb3JpZ2luYXRpbmdDaGlsZFJvdXRlLCBuYW1lKSB7CiAgdmFyIHJvdXRlciA9IHBhcmVudFJvdXRlLnJvdXRlciwKICAgICAgY2hpbGROYW1lLAogICAgICB0YXJnZXRDaGlsZFJvdXRlTmFtZSA9IG9yaWdpbmF0aW5nQ2hpbGRSb3V0ZS5yb3V0ZU5hbWUuc3BsaXQoJy4nKS5wb3AoKSwKICAgICAgbmFtZXNwYWNlID0gcGFyZW50Um91dGUucm91dGVOYW1lID09PSAnYXBwbGljYXRpb24nID8gJycgOiBwYXJlbnRSb3V0ZS5yb3V0ZU5hbWUgKyAnLic7CgogIAogIC8vIFNlY29uZCwgdHJ5IGdlbmVyYWwgbG9hZGluZyBzdGF0ZSwgZS5nLiAnbG9hZGluZycKICBjaGlsZE5hbWUgPSBuYW1lc3BhY2UgKyBuYW1lOwogIGlmIChyb3V0ZUhhc0JlZW5EZWZpbmVkKHJvdXRlciwgY2hpbGROYW1lKSkgewogICAgcmV0dXJuIGNoaWxkTmFtZTsKICB9Cn0KCmZ1bmN0aW9uIHJvdXRlSGFzQmVlbkRlZmluZWQocm91dGVyLCBuYW1lKSB7CiAgdmFyIGNvbnRhaW5lciA9IHJvdXRlci5jb250YWluZXI7CiAgcmV0dXJuIHJvdXRlci5oYXNSb3V0ZShuYW1lKSAmJgogICAgICAgICAoY29udGFpbmVyLmhhcygndGVtcGxhdGU6JyArIG5hbWUpIHx8IGNvbnRhaW5lci5oYXMoJ3JvdXRlOicgKyBuYW1lKSk7Cn0KCmZ1bmN0aW9uIHRyaWdnZXJFdmVudChoYW5kbGVySW5mb3MsIGlnbm9yZUZhaWx1cmUsIGFyZ3MpIHsKICB2YXIgbmFtZSA9IGFyZ3Muc2hpZnQoKTsKCiAgaWYgKCFoYW5kbGVySW5mb3MpIHsKICAgIGlmIChpZ25vcmVGYWlsdXJlKSB7IHJldHVybjsgfQogICAgdGhyb3cgbmV3IEVtYmVyLkVycm9yKCJDYW4ndCB0cmlnZ2VyIGFjdGlvbiAnIiArIG5hbWUgKyAiJyBiZWNhdXNlIHlvdXIgYXBwIGhhc24ndCBmaW5pc2hlZCB0cmFuc2l0aW9uaW5nIGludG8gaXRzIGZpcnN0IHJvdXRlLiBUbyB0cmlnZ2VyIGFuIGFjdGlvbiBvbiBkZXN0aW5hdGlvbiByb3V0ZXMgZHVyaW5nIGEgdHJhbnNpdGlvbiwgeW91IGNhbiBjYWxsIGAuc2VuZCgpYCBvbiB0aGUgYFRyYW5zaXRpb25gIG9iamVjdCBwYXNzZWQgdG8gdGhlIGBtb2RlbC9iZWZvcmVNb2RlbC9hZnRlck1vZGVsYCBob29rcy4iKTsKICB9CgogIHZhciBldmVudFdhc0hhbmRsZWQgPSBmYWxzZTsKCiAgZm9yICh2YXIgaSA9IGhhbmRsZXJJbmZvcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgdmFyIGhhbmRsZXJJbmZvID0gaGFuZGxlckluZm9zW2ldLAogICAgICAgIGhhbmRsZXIgPSBoYW5kbGVySW5mby5oYW5kbGVyOwoKICAgIGlmIChoYW5kbGVyLl9hY3Rpb25zICYmIGhhbmRsZXIuX2FjdGlvbnNbbmFtZV0pIHsKICAgICAgaWYgKGhhbmRsZXIuX2FjdGlvbnNbbmFtZV0uYXBwbHkoaGFuZGxlciwgYXJncykgPT09IHRydWUpIHsKICAgICAgICBldmVudFdhc0hhbmRsZWQgPSB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogIH0KCiAgaWYgKGRlZmF1bHRBY3Rpb25IYW5kbGVyc1tuYW1lXSkgewogICAgZGVmYXVsdEFjdGlvbkhhbmRsZXJzW25hbWVdLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgcmV0dXJuOwogIH0KCiAgaWYgKCFldmVudFdhc0hhbmRsZWQgJiYgIWlnbm9yZUZhaWx1cmUpIHsKICAgIHRocm93IG5ldyBFbWJlci5FcnJvcigiTm90aGluZyBoYW5kbGVkIHRoZSBhY3Rpb24gJyIgKyBuYW1lICsgIicuIElmIHlvdSBkaWQgaGFuZGxlIHRoZSBhY3Rpb24sIHRoaXMgZXJyb3IgY2FuIGJlIGNhdXNlZCBieSByZXR1cm5pbmcgdHJ1ZSBmcm9tIGFuIGFjdGlvbiBoYW5kbGVyIGluIGEgY29udHJvbGxlciwgY2F1c2luZyB0aGUgYWN0aW9uIHRvIGJ1YmJsZS4iKTsKICB9Cn0KCmZ1bmN0aW9uIHVwZGF0ZVBhdGhzKHJvdXRlcikgewogIHZhciBhcHBDb250cm9sbGVyID0gcm91dGVyLmNvbnRhaW5lci5sb29rdXAoJ2NvbnRyb2xsZXI6YXBwbGljYXRpb24nKTsKCiAgaWYgKCFhcHBDb250cm9sbGVyKSB7CiAgICAvLyBhcHBDb250cm9sbGVyIG1pZ2h0IG5vdCBleGlzdCB3aGVuIHRvcC1sZXZlbCBsb2FkaW5nL2Vycm9yCiAgICAvLyBzdWJzdGF0ZXMgaGF2ZSBiZWVuIGVudGVyZWQgc2luY2UgQXBwbGljYXRpb25Sb3V0ZSBoYXNuJ3QKICAgIC8vIGFjdHVhbGx5IGJlZW4gZW50ZXJlZCBhdCB0aGF0IHBvaW50LgogICAgcmV0dXJuOwogIH0KCiAgdmFyIGluZm9zID0gcm91dGVyLnJvdXRlci5jdXJyZW50SGFuZGxlckluZm9zLAogICAgICBwYXRoID0gRW1iZXIuUm91dGVyLl9yb3V0ZVBhdGgoaW5mb3MpOwoKICBpZiAoISgnY3VycmVudFBhdGgnIGluIGFwcENvbnRyb2xsZXIpKSB7CiAgICBkZWZpbmVQcm9wZXJ0eShhcHBDb250cm9sbGVyLCAnY3VycmVudFBhdGgnKTsKICB9CgogIHNldChhcHBDb250cm9sbGVyLCAnY3VycmVudFBhdGgnLCBwYXRoKTsKCiAgaWYgKCEoJ2N1cnJlbnRSb3V0ZU5hbWUnIGluIGFwcENvbnRyb2xsZXIpKSB7CiAgICBkZWZpbmVQcm9wZXJ0eShhcHBDb250cm9sbGVyLCAnY3VycmVudFJvdXRlTmFtZScpOwogIH0KCiAgc2V0KGFwcENvbnRyb2xsZXIsICdjdXJyZW50Um91dGVOYW1lJywgaW5mb3NbaW5mb3MubGVuZ3RoIC0gMV0ubmFtZSk7Cn0KCkVtYmVyLlJvdXRlci5yZW9wZW5DbGFzcyh7CiAgcm91dGVyOiBudWxsLAogIG1hcDogZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgIHZhciByb3V0ZXIgPSB0aGlzLnJvdXRlcjsKICAgIGlmICghcm91dGVyKSB7CiAgICAgIHJvdXRlciA9IG5ldyBSb3V0ZXIoKTsKICAgICAgcm91dGVyLmNhbGxiYWNrcyA9IFtdOwogICAgICByb3V0ZXIudHJpZ2dlckV2ZW50ID0gdHJpZ2dlckV2ZW50OwogICAgICB0aGlzLnJlb3BlbkNsYXNzKHsgcm91dGVyOiByb3V0ZXIgfSk7CiAgICB9CgogICAgdmFyIGRzbCA9IEVtYmVyLlJvdXRlckRTTC5tYXAoZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucmVzb3VyY2UoJ2FwcGxpY2F0aW9uJywgeyBwYXRoOiAiLyIgfSwgZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgaT0wOyBpIDwgcm91dGVyLmNhbGxiYWNrcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgcm91dGVyLmNhbGxiYWNrc1tpXS5jYWxsKHRoaXMpOwogICAgICAgIH0KICAgICAgICBjYWxsYmFjay5jYWxsKHRoaXMpOwogICAgICB9KTsKICAgIH0pOwoKICAgIHJvdXRlci5jYWxsYmFja3MucHVzaChjYWxsYmFjayk7CiAgICByb3V0ZXIubWFwKGRzbC5nZW5lcmF0ZSgpKTsKICAgIHJldHVybiByb3V0ZXI7CiAgfSwKCiAgX3JvdXRlUGF0aDogZnVuY3Rpb24oaGFuZGxlckluZm9zKSB7CiAgICB2YXIgcGF0aCA9IFtdOwoKICAgIC8vIFdlIGhhdmUgdG8gaGFuZGxlIGNvYWxlc2NpbmcgcmVzb3VyY2UgbmFtZXMgdGhhdAogICAgLy8gYXJlIHByZWZpeGVkIHdpdGggdGhlaXIgcGFyZW50J3MgbmFtZXMsIGUuZy4KICAgIC8vIFsnZm9vJywgJ2Zvby5iYXIuYmF6J10gPT4gJ2Zvby5iYXIuYmF6Jywgbm90ICdmb28uZm9vLmJhci5iYXonCgogICAgZnVuY3Rpb24gaW50ZXJzZWN0aW9uTWF0Y2hlcyhhMSwgYTIpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGExLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgaWYgKGExW2ldICE9PSBhMltpXSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBmb3IgKHZhciBpPTEsIGw9aGFuZGxlckluZm9zLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgdmFyIG5hbWUgPSBoYW5kbGVySW5mb3NbaV0ubmFtZSwKICAgICAgICAgIG5hbWVQYXJ0cyA9IG5hbWUuc3BsaXQoIi4iKSwKICAgICAgICAgIG9sZE5hbWVQYXJ0cyA9IHNsaWNlLmNhbGwocGF0aCk7CgogICAgICB3aGlsZSAob2xkTmFtZVBhcnRzLmxlbmd0aCkgewogICAgICAgIGlmIChpbnRlcnNlY3Rpb25NYXRjaGVzKG9sZE5hbWVQYXJ0cywgbmFtZVBhcnRzKSkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIG9sZE5hbWVQYXJ0cy5zaGlmdCgpOwogICAgICB9CgogICAgICBwYXRoLnB1c2guYXBwbHkocGF0aCwgbmFtZVBhcnRzLnNsaWNlKG9sZE5hbWVQYXJ0cy5sZW5ndGgpKTsKICAgIH0KCiAgICByZXR1cm4gcGF0aC5qb2luKCIuIik7CiAgfQp9KTsKClJvdXRlci5UcmFuc2l0aW9uLnByb3RvdHlwZS5zZW5kID0gUm91dGVyLlRyYW5zaXRpb24ucHJvdG90eXBlLnRyaWdnZXI7CgoKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1yb3V0aW5nCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQsCiAgICBnZXRQcm9wZXJ0aWVzID0gRW1iZXIuZ2V0UHJvcGVydGllcywKICAgIGNsYXNzaWZ5ID0gRW1iZXIuU3RyaW5nLmNsYXNzaWZ5LAogICAgZm10ID0gRW1iZXIuU3RyaW5nLmZtdCwKICAgIGFfZm9yRWFjaCA9IEVtYmVyLkVudW1lcmFibGVVdGlscy5mb3JFYWNoLAogICAgYV9yZXBsYWNlID0gRW1iZXIuRW51bWVyYWJsZVV0aWxzLnJlcGxhY2U7CgoKLyoqCiAgVGhlIGBFbWJlci5Sb3V0ZWAgY2xhc3MgaXMgdXNlZCB0byBkZWZpbmUgaW5kaXZpZHVhbCByb3V0ZXMuIFJlZmVyIHRvCiAgdGhlIFtyb3V0aW5nIGd1aWRlXShodHRwOi8vZW1iZXJqcy5jb20vZ3VpZGVzL3JvdXRpbmcvKSBmb3IgZG9jdW1lbnRhdGlvbi4KCiAgQGNsYXNzIFJvdXRlCiAgQG5hbWVzcGFjZSBFbWJlcgogIEBleHRlbmRzIEVtYmVyLk9iamVjdAogIEB1c2VzIEVtYmVyLkFjdGlvbkhhbmRsZXIKKi8KRW1iZXIuUm91dGUgPSBFbWJlci5PYmplY3QuZXh0ZW5kKEVtYmVyLkFjdGlvbkhhbmRsZXIsIHsKCiAgLyoqCiAgICBAcHJpdmF0ZQoKICAgIEBtZXRob2QgZXhpdAogICovCiAgZXhpdDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLmRlYWN0aXZhdGUoKTsKICAgIHRoaXMudGVhcmRvd25WaWV3cygpOwogIH0sCgogIC8qKgogICAgQHByaXZhdGUKCiAgICBAbWV0aG9kIGVudGVyCiAgKi8KICBlbnRlcjogZnVuY3Rpb24oKSB7CiAgICB0aGlzLmFjdGl2YXRlKCk7CiAgfSwKCiAgLyoqCiAgICBUaGUgY29sbGVjdGlvbiBvZiBmdW5jdGlvbnMsIGtleWVkIGJ5IG5hbWUsIGF2YWlsYWJsZSBvbiB0aGlzIHJvdXRlIGFzCiAgICBhY3Rpb24gdGFyZ2V0cy4KCiAgICBUaGVzZSBmdW5jdGlvbnMgd2lsbCBiZSBpbnZva2VkIHdoZW4gYSBtYXRjaGluZyBge3thY3Rpb259fWAgaXMgdHJpZ2dlcmVkCiAgICBmcm9tIHdpdGhpbiBhIHRlbXBsYXRlIGFuZCB0aGUgYXBwbGljYXRpb24ncyBjdXJyZW50IHJvdXRlIGlzIHRoaXMgcm91dGUuCgogICAgQWN0aW9ucyBjYW4gYWxzbyBiZSBpbnZva2VkIGZyb20gb3RoZXIgcGFydHMgb2YgeW91ciBhcHBsaWNhdGlvbiB2aWEgYFJvdXRlI3NlbmRgCiAgICBvciBgQ29udHJvbGxlciNzZW5kYC4KCiAgICBUaGUgYGFjdGlvbnNgIGhhc2ggd2lsbCBpbmhlcml0IGFjdGlvbiBoYW5kbGVycyBmcm9tCiAgICB0aGUgYGFjdGlvbnNgIGhhc2ggZGVmaW5lZCBvbiBleHRlbmRlZCBSb3V0ZSBwYXJlbnQgY2xhc3NlcwogICAgb3IgbWl4aW5zIHJhdGhlciB0aGFuIGp1c3QgcmVwbGFjZSB0aGUgZW50aXJlIGhhc2gsIGUuZy46CgogICAgYGBganMKICAgIEFwcC5DYW5EaXNwbGF5QmFubmVyID0gRW1iZXIuTWl4aW4uY3JlYXRlKHsKICAgICAgYWN0aW9uczogewogICAgICAgIGRpc3BsYXlCYW5uZXI6IGZ1bmN0aW9uKG1zZykgewogICAgICAgICAgLy8gLi4uCiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCiAgICBBcHAuV2VsY29tZVJvdXRlID0gRW1iZXIuUm91dGUuZXh0ZW5kKEFwcC5DYW5EaXNwbGF5QmFubmVyLCB7CiAgICAgIGFjdGlvbnM6IHsKICAgICAgICBwbGF5TXVzaWM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgLy8gLi4uCiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCiAgICAvLyBgV2VsY29tZVJvdXRlYCwgd2hlbiBhY3RpdmUsIHdpbGwgYmUgYWJsZSB0byByZXNwb25kCiAgICAvLyB0byBib3RoIGFjdGlvbnMsIHNpbmNlIHRoZSBhY3Rpb25zIGhhc2ggaXMgbWVyZ2VkIHJhdGhlcgogICAgLy8gdGhlbiByZXBsYWNlZCB3aGVuIGV4dGVuZGluZyBtaXhpbnMgLyBwYXJlbnQgY2xhc3Nlcy4KICAgIHRoaXMuc2VuZCgnZGlzcGxheUJhbm5lcicpOwogICAgdGhpcy5zZW5kKCdwbGF5TXVzaWMnKTsKICAgIGBgYAoKICAgIFdpdGhpbiBhIHJvdXRlJ3MgYWN0aW9uIGhhbmRsZXIsIHRoZSB2YWx1ZSBvZiB0aGUgYHRoaXNgIGNvbnRleHQKICAgIGlzIHRoZSBSb3V0ZSBvYmplY3Q6CgogICAgYGBganMKICAgIEFwcC5Tb25nUm91dGUgPSBFbWJlci5Sb3V0ZS5leHRlbmQoewogICAgICBhY3Rpb25zOiB7CiAgICAgICAgbXlBY3Rpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgdGhpcy5jb250cm9sbGVyRm9yKCJzb25nIik7CiAgICAgICAgICB0aGlzLnRyYW5zaXRpb25Ubygib3RoZXIucm91dGUiKTsKICAgICAgICAgIC4uLgogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBgYGAKCiAgICBJdCBpcyBhbHNvIHBvc3NpYmxlIHRvIGNhbGwgYHRoaXMuX3N1cGVyKClgIGZyb20gd2l0aGluIGFuCiAgICBhY3Rpb24gaGFuZGxlciBpZiBpdCBvdmVycmlkZXMgYSBoYW5kbGVyIGRlZmluZWQgb24gYSBwYXJlbnQKICAgIGNsYXNzIG9yIG1peGluOgoKICAgIFRha2UgZm9yIGV4YW1wbGUgdGhlIGZvbGxvd2luZyByb3V0ZXM6CgogICAgYGBganMKICAgIEFwcC5EZWJ1Z1JvdXRlID0gRW1iZXIuTWl4aW4uY3JlYXRlKHsKICAgICAgYWN0aW9uczogewogICAgICAgIGRlYnVnUm91dGVJbmZvcm1hdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICBjb25zb2xlLmRlYnVnKCJ0cm9sb2xvIik7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCiAgICBBcHAuQW5ub3lpbmdEZWJ1Z1JvdXRlID0gRW1iZXIuUm91dGUuZXh0ZW5kKEFwcC5EZWJ1Z1JvdXRlLCB7CiAgICAgIGFjdGlvbnM6IHsKICAgICAgICBkZWJ1Z1JvdXRlSW5mb3JtYXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgLy8gYWxzbyBjYWxsIHRoZSBkZWJ1Z1JvdXRlSW5mb3JtYXRpb24gb2YgbWl4ZWQgaW4gQXBwLkRlYnVnUm91dGUKICAgICAgICAgIHRoaXMuX3N1cGVyKCk7CgogICAgICAgICAgLy8gc2hvdyBhZGRpdGlvbmFsIGFubm95YW5jZQogICAgICAgICAgd2luZG93LmFsZXJ0KC4uLik7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgICMjIEJ1YmJsaW5nCgogICAgQnkgZGVmYXVsdCwgYW4gYWN0aW9uIHdpbGwgc3RvcCBidWJibGluZyBvbmNlIGEgaGFuZGxlciBkZWZpbmVkCiAgICBvbiB0aGUgYGFjdGlvbnNgIGhhc2ggaGFuZGxlcyBpdC4gVG8gY29udGludWUgYnViYmxpbmcgdGhlIGFjdGlvbiwKICAgIHlvdSBtdXN0IHJldHVybiBgdHJ1ZWAgZnJvbSB0aGUgaGFuZGxlcjoKCiAgICBgYGBqcwogICAgQXBwLlJvdXRlci5tYXAoZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucmVzb3VyY2UoImFsYnVtIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yb3V0ZSgic29uZyIpOwogICAgICB9KTsKICAgIH0pOwoKICAgIEFwcC5BbGJ1bVJvdXRlID0gRW1iZXIuUm91dGUuZXh0ZW5kKHsKICAgICAgYWN0aW9uczogewogICAgICAgIHN0YXJ0UGxheWluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCiAgICBBcHAuQWxidW1Tb25nUm91dGUgPSBFbWJlci5Sb3V0ZS5leHRlbmQoewogICAgICBhY3Rpb25zOiB7CiAgICAgICAgc3RhcnRQbGF5aW5nOiBmdW5jdGlvbigpIHsKICAgICAgICAgIC8vIC4uLgoKICAgICAgICAgIGlmIChhY3Rpb25TaG91bGRBbHNvQmVUcmlnZ2VyZWRPblBhcmVudFJvdXRlKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBgYGAKCiAgICAjIyBCdWlsdC1pbiBhY3Rpb25zCgogICAgVGhlcmUgYXJlIGEgZmV3IGJ1aWx0LWluIGFjdGlvbnMgcGVydGFpbmluZyB0byB0cmFuc2l0aW9ucyB0aGF0IHlvdQogICAgY2FuIHVzZSB0byBjdXN0b21pemUgdHJhbnNpdGlvbiBiZWhhdmlvcjogYHdpbGxUcmFuc2l0aW9uYCBhbmQKICAgIGBlcnJvcmAuCgogICAgIyMjIGB3aWxsVHJhbnNpdGlvbmAKCiAgICBUaGUgYHdpbGxUcmFuc2l0aW9uYCBhY3Rpb24gaXMgZmlyZWQgYXQgdGhlIGJlZ2lubmluZyBvZiBhbnkKICAgIGF0dGVtcHRlZCB0cmFuc2l0aW9uIHdpdGggYSBgVHJhbnNpdGlvbmAgb2JqZWN0IGFzIHRoZSBzb2xlCiAgICBhcmd1bWVudC4gVGhpcyBhY3Rpb24gY2FuIGJlIHVzZWQgZm9yIGFib3J0aW5nLCByZWRpcmVjdGluZywKICAgIG9yIGRlY29yYXRpbmcgdGhlIHRyYW5zaXRpb24gZnJvbSB0aGUgY3VycmVudGx5IGFjdGl2ZSByb3V0ZXMuCgogICAgQSBnb29kIGV4YW1wbGUgaXMgcHJldmVudGluZyBuYXZpZ2F0aW9uIHdoZW4gYSBmb3JtIGlzCiAgICBoYWxmLWZpbGxlZCBvdXQ6CgogICAgYGBganMKICAgIEFwcC5Db250YWN0Rm9ybVJvdXRlID0gRW1iZXIuUm91dGUuZXh0ZW5kKHsKICAgICAgYWN0aW9uczogewogICAgICAgIHdpbGxUcmFuc2l0aW9uOiBmdW5jdGlvbih0cmFuc2l0aW9uKSB7CiAgICAgICAgICBpZiAodGhpcy5jb250cm9sbGVyLmdldCgndXNlckhhc0VudGVyZWREYXRhJykpIHsKICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmRpc3BsYXlOYXZpZ2F0aW9uQ29uZmlybSgpOwogICAgICAgICAgICB0cmFuc2l0aW9uLmFib3J0KCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgIFlvdSBjYW4gYWxzbyByZWRpcmVjdCBlbHNld2hlcmUgYnkgY2FsbGluZwogICAgYHRoaXMudHJhbnNpdGlvblRvKCdlbHNld2hlcmUnKWAgZnJvbSB3aXRoaW4gYHdpbGxUcmFuc2l0aW9uYC4KICAgIE5vdGUgdGhhdCBgd2lsbFRyYW5zaXRpb25gIHdpbGwgbm90IGJlIGZpcmVkIGZvciB0aGUKICAgIHJlZGlyZWN0aW5nIGB0cmFuc2l0aW9uVG9gLCBzaW5jZSBgd2lsbFRyYW5zaXRpb25gIGRvZXNuJ3QKICAgIGZpcmUgd2hlbiB0aGVyZSBpcyBhbHJlYWR5IGEgdHJhbnNpdGlvbiB1bmRlcndheS4gSWYgeW91IHdhbnQKICAgIHN1YnNlcXVlbnQgYHdpbGxUcmFuc2l0aW9uYCBhY3Rpb25zIHRvIGZpcmUgZm9yIHRoZSByZWRpcmVjdGluZwogICAgdHJhbnNpdGlvbiwgeW91IG11c3QgZmlyc3QgZXhwbGljaXRseSBjYWxsCiAgICBgdHJhbnNpdGlvbi5hYm9ydCgpYC4KCiAgICAjIyMgYGVycm9yYAoKICAgIFdoZW4gYXR0ZW1wdGluZyB0byB0cmFuc2l0aW9uIGludG8gYSByb3V0ZSwgYW55IG9mIHRoZSBob29rcwogICAgbWF5IHJldHVybiBhIHByb21pc2UgdGhhdCByZWplY3RzLCBhdCB3aGljaCBwb2ludCBhbiBgZXJyb3JgCiAgICBhY3Rpb24gd2lsbCBiZSBmaXJlZCBvbiB0aGUgcGFydGlhbGx5LWVudGVyZWQgcm91dGVzLCBhbGxvd2luZwogICAgZm9yIHBlci1yb3V0ZSBlcnJvciBoYW5kbGluZyBsb2dpYywgb3Igc2hhcmVkIGVycm9yIGhhbmRsaW5nCiAgICBsb2dpYyBkZWZpbmVkIG9uIGEgcGFyZW50IHJvdXRlLgoKICAgIEhlcmUgaXMgYW4gZXhhbXBsZSBvZiBhbiBlcnJvciBoYW5kbGVyIHRoYXQgd2lsbCBiZSBpbnZva2VkCiAgICBmb3IgcmVqZWN0ZWQgcHJvbWlzZXMgZnJvbSB0aGUgdmFyaW91cyBob29rcyBvbiB0aGUgcm91dGUsCiAgICBhcyB3ZWxsIGFzIGFueSB1bmhhbmRsZWQgZXJyb3JzIGZyb20gY2hpbGQgcm91dGVzOgoKICAgIGBgYGpzCiAgICBBcHAuQWRtaW5Sb3V0ZSA9IEVtYmVyLlJvdXRlLmV4dGVuZCh7CiAgICAgIGJlZm9yZU1vZGVsOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gRW1iZXIuUlNWUC5yZWplY3QoImJhZCB0aGluZ3MhIik7CiAgICAgIH0sCgogICAgICBhY3Rpb25zOiB7CiAgICAgICAgZXJyb3I6IGZ1bmN0aW9uKGVycm9yLCB0cmFuc2l0aW9uKSB7CiAgICAgICAgICAvLyBBc3N1bWluZyB3ZSBnb3QgaGVyZSBkdWUgdG8gdGhlIGVycm9yIGluIGBiZWZvcmVNb2RlbGAsCiAgICAgICAgICAvLyB3ZSBjYW4gZXhwZWN0IHRoYXQgZXJyb3IgPT09ICJiYWQgdGhpbmdzISIsCiAgICAgICAgICAvLyBidXQgYSBwcm9taXNlIG1vZGVsIHJlamVjdGluZyB3b3VsZCBhbHNvCiAgICAgICAgICAvLyBjYWxsIHRoaXMgaG9vaywgYXMgd291bGQgYW55IGVycm9ycyBlbmNvdW50ZXJlZAogICAgICAgICAgLy8gaW4gYGFmdGVyTW9kZWxgLgoKICAgICAgICAgIC8vIFRoZSBgZXJyb3JgIGhvb2sgaXMgYWxzbyBwcm92aWRlZCB0aGUgZmFpbGVkCiAgICAgICAgICAvLyBgdHJhbnNpdGlvbmAsIHdoaWNoIGNhbiBiZSBzdG9yZWQgYW5kIGxhdGVyCiAgICAgICAgICAvLyBgLnJldHJ5KClgZCBpZiBkZXNpcmVkLgoKICAgICAgICAgIHRoaXMudHJhbnNpdGlvblRvKCdsb2dpbicpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBgYGAKCiAgICBgZXJyb3JgIGFjdGlvbnMgdGhhdCBidWJibGUgdXAgYWxsIHRoZSB3YXkgdG8gYEFwcGxpY2F0aW9uUm91dGVgCiAgICB3aWxsIGZpcmUgYSBkZWZhdWx0IGVycm9yIGhhbmRsZXIgdGhhdCBsb2dzIHRoZSBlcnJvci4gWW91IGNhbgogICAgc3BlY2lmeSB5b3VyIG93biBnbG9iYWwgZGVmYXVsdCBlcnJvciBoYW5kbGVyIGJ5IG92ZXJyaWRpbmcgdGhlCiAgICBgZXJyb3JgIGhhbmRsZXIgb24gYEFwcGxpY2F0aW9uUm91dGVgOgoKICAgIGBgYGpzCiAgICBBcHAuQXBwbGljYXRpb25Sb3V0ZSA9IEVtYmVyLlJvdXRlLmV4dGVuZCh7CiAgICAgIGFjdGlvbnM6IHsKICAgICAgICBlcnJvcjogZnVuY3Rpb24oZXJyb3IsIHRyYW5zaXRpb24pIHsKICAgICAgICAgIHRoaXMuY29udHJvbGxlckZvcignYmFubmVyJykuZGlzcGxheUVycm9yKGVycm9yLm1lc3NhZ2UpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBgYGAKCiAgICBAcHJvcGVydHkgYWN0aW9ucwogICAgQHR5cGUgSGFzaAogICAgQGRlZmF1bHQgbnVsbAogICovCiAgX2FjdGlvbnM6IHsKICAgIGZpbmFsaXplUXVlcnlQYXJhbUNoYW5nZTogZnVuY3Rpb24ocGFyYW1zLCBmaW5hbFBhcmFtcykgewogICAgICAgICAgfQogIH0sCgogIC8qKgogICAgQGRlcHJlY2F0ZWQKCiAgICBQbGVhc2UgdXNlIGBhY3Rpb25zYCBpbnN0ZWFkLgogICAgQG1ldGhvZCBldmVudHMKICAqLwogIGV2ZW50czogbnVsbCwKCiAgbWVyZ2VkUHJvcGVydGllczogWydldmVudHMnXSwKCiAgLyoqCiAgICBUaGlzIGhvb2sgaXMgZXhlY3V0ZWQgd2hlbiB0aGUgcm91dGVyIGNvbXBsZXRlbHkgZXhpdHMgdGhpcyByb3V0ZS4gSXQgaXMKICAgIG5vdCBleGVjdXRlZCB3aGVuIHRoZSBtb2RlbCBmb3IgdGhlIHJvdXRlIGNoYW5nZXMuCgogICAgQG1ldGhvZCBkZWFjdGl2YXRlCiAgKi8KICBkZWFjdGl2YXRlOiBFbWJlci5LLAoKICAvKioKICAgIFRoaXMgaG9vayBpcyBleGVjdXRlZCB3aGVuIHRoZSByb3V0ZXIgZW50ZXJzIHRoZSByb3V0ZS4gSXQgaXMgbm90IGV4ZWN1dGVkCiAgICB3aGVuIHRoZSBtb2RlbCBmb3IgdGhlIHJvdXRlIGNoYW5nZXMuCgogICAgQG1ldGhvZCBhY3RpdmF0ZQogICovCiAgYWN0aXZhdGU6IEVtYmVyLkssCgogIC8qKgogICAgVHJhbnNpdGlvbiBpbnRvIGFub3RoZXIgcm91dGUuIE9wdGlvbmFsbHkgc3VwcGx5IG1vZGVsKHMpIGZvciB0aGUKICAgIHJvdXRlIGluIHF1ZXN0aW9uLiBJZiBtdWx0aXBsZSBtb2RlbHMgYXJlIHN1cHBsaWVkIHRoZXkgd2lsbCBiZSBhcHBsaWVkCiAgICBsYXN0IHRvIGZpcnN0IHJlY3Vyc2l2ZWx5IHVwIHRoZSByZXNvdXJjZSB0cmVlIChzZWUgTXVsdGlwbGUgTW9kZWxzIEV4YW1wbGUKICAgIGJlbG93KS4gVGhlIG1vZGVsKHMpIHdpbGwgYmUgc2VyaWFsaXplZCBpbnRvIHRoZSBVUkwgdXNpbmcgdGhlIGFwcHJvcHJpYXRlCiAgICByb3V0ZSdzIGBzZXJpYWxpemVgIGhvb2suIFNlZSBhbHNvICdyZXBsYWNlV2l0aCcuCgogICAgU2ltcGxlIFRyYW5zaXRpb24gRXhhbXBsZQoKICAgIGBgYGphdmFzY3JpcHQKICAgIEFwcC5Sb3V0ZXIubWFwKGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnJvdXRlKCJpbmRleCIpOwogICAgICB0aGlzLnJvdXRlKCJzZWNyZXQiKTsKICAgICAgdGhpcy5yb3V0ZSgiZm91ck9oRm91ciIsIHsgcGF0aDogIio6In0pOwogICAgfSk7CgogICAgQXBwLkluZGV4Um91dGUgPSBFbWJlci5Sb3V0ZS5leHRlbmQoewogICAgICBhY3Rpb25zOiB7CiAgICAgICAgbW92ZVRvU2VjcmV0OiBmdW5jdGlvbihjb250ZXh0KXsKICAgICAgICAgIGlmIChhdXRob3JpemVkKCkpewogICAgICAgICAgICB0aGlzLnRyYW5zaXRpb25Ubygnc2VjcmV0JywgY29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudHJhbnNpdGlvblRvKCdmb3VyT2hGb3VyJyk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgVHJhbnNpdGlvbiB0byBhIG5lc3RlZCByb3V0ZQoKICAgYGBgamF2YXNjcmlwdAogICBBcHAuUm91dGVyLm1hcChmdW5jdGlvbigpIHsKICAgICB0aGlzLnJlc291cmNlKCdhcnRpY2xlcycsIHsgcGF0aDogJy9hcnRpY2xlcycgfSwgZnVuY3Rpb24oKSB7CiAgICAgICB0aGlzLnJvdXRlKCduZXcnKTsKICAgICB9KTsKICAgfSk7CgogICBBcHAuSW5kZXhSb3V0ZSA9IEVtYmVyLlJvdXRlLmV4dGVuZCh7CiAgICAgYWN0aW9uczogewogICAgICAgdHJhbnNpdGlvblRvTmV3QXJ0aWNsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgIHRoaXMudHJhbnNpdGlvblRvKCdhcnRpY2xlcy5uZXcnKTsKICAgICAgIH0KICAgICB9CiAgIH0pOwogICBgYGAKCiAgICBNdWx0aXBsZSBNb2RlbHMgRXhhbXBsZQoKICAgIGBgYGphdmFzY3JpcHQKICAgIEFwcC5Sb3V0ZXIubWFwKGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnJvdXRlKCJpbmRleCIpOwogICAgICB0aGlzLnJlc291cmNlKCdicmVha2Zhc3QnLCB7cGF0aDonOmJyZWFrZmFzdElkJ30sIGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5yZXNvdXJjZSgnY2VyZWFsJywge3BhdGg6ICc6Y2VyZWFsSWQnfSk7CiAgICAgIH0pOwogICAgfSk7CgogICAgQXBwLkluZGV4Um91dGUgPSBFbWJlci5Sb3V0ZS5leHRlbmQoewogICAgICBhY3Rpb25zOiB7CiAgICAgICAgbW92ZVRvQ2hvY29sYXRlQ2VyZWFsOiBmdW5jdGlvbigpewogICAgICAgICAgdmFyIGNlcmVhbCA9IHsgY2VyZWFsSWQ6ICJDaG9jb2xhdGVZdW1taW5lc3MifSwKICAgICAgICAgICAgICBicmVha2Zhc3QgPSB7YnJlYWtmYXN0SWQ6ICJDZXJlYWxBbmRNaWxrIn07CgogICAgICAgICAgdGhpcy50cmFuc2l0aW9uVG8oJ2NlcmVhbCcsIGJyZWFrZmFzdCwgY2VyZWFsKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwoKICAgIEBtZXRob2QgdHJhbnNpdGlvblRvCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSB0aGUgbmFtZSBvZiB0aGUgcm91dGUKICAgIEBwYXJhbSB7Li4uT2JqZWN0fSBtb2RlbHMgdGhlIG1vZGVsKHMpIHRvIGJlIHVzZWQgd2hpbGUgdHJhbnNpdGlvbmluZwogICAgdG8gdGhlIHJvdXRlLgogICovCiAgdHJhbnNpdGlvblRvOiBmdW5jdGlvbihuYW1lLCBjb250ZXh0KSB7CiAgICB2YXIgcm91dGVyID0gdGhpcy5yb3V0ZXI7CiAgICByZXR1cm4gcm91dGVyLnRyYW5zaXRpb25Uby5hcHBseShyb3V0ZXIsIGFyZ3VtZW50cyk7CiAgfSwKCiAgLyoqCiAgICBQZXJmb3JtIGEgc3luY2hyb25vdXMgdHJhbnNpdGlvbiBpbnRvIGFub3RoZXIgcm91dGUgd2l0aCBvdXQgYXR0ZW1wdGluZwogICAgdG8gcmVzb2x2ZSBwcm9taXNlcywgdXBkYXRlIHRoZSBVUkwsIG9yIGFib3J0IGFueSBjdXJyZW50bHkgYWN0aXZlCiAgICBhc3luY2hyb25vdXMgdHJhbnNpdGlvbnMgKGkuZS4gcmVndWxhciB0cmFuc2l0aW9ucyBjYXVzZWQgYnkKICAgIGB0cmFuc2l0aW9uVG9gIG9yIFVSTCBjaGFuZ2VzKS4KCiAgICBUaGlzIG1ldGhvZCBpcyBoYW5keSBmb3IgcGVyZm9ybWluZyBpbnRlcm1lZGlhdGUgdHJhbnNpdGlvbnMgb24gdGhlCiAgICB3YXkgdG8gYSBmaW5hbCBkZXN0aW5hdGlvbiByb3V0ZSwgYW5kIGlzIGNhbGxlZCBpbnRlcm5hbGx5IGJ5IHRoZQogICAgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbnMgb2YgdGhlIGBlcnJvcmAgYW5kIGBsb2FkaW5nYCBoYW5kbGVycy4KCiAgICBAbWV0aG9kIGludGVybWVkaWF0ZVRyYW5zaXRpb25UbwogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgdGhlIG5hbWUgb2YgdGhlIHJvdXRlCiAgICBAcGFyYW0gey4uLk9iamVjdH0gbW9kZWxzIHRoZSBtb2RlbChzKSB0byBiZSB1c2VkIHdoaWxlIHRyYW5zaXRpb25pbmcKICAgIHRvIHRoZSByb3V0ZS4KICAgKi8KICBpbnRlcm1lZGlhdGVUcmFuc2l0aW9uVG86IGZ1bmN0aW9uKCkgewogICAgdmFyIHJvdXRlciA9IHRoaXMucm91dGVyOwogICAgcm91dGVyLmludGVybWVkaWF0ZVRyYW5zaXRpb25Uby5hcHBseShyb3V0ZXIsIGFyZ3VtZW50cyk7CiAgfSwKCiAgLyoqCiAgICBUcmFuc2l0aW9uIGludG8gYW5vdGhlciByb3V0ZSB3aGlsZSByZXBsYWNpbmcgdGhlIGN1cnJlbnQgVVJMLCBpZiBwb3NzaWJsZS4KICAgIFRoaXMgd2lsbCByZXBsYWNlIHRoZSBjdXJyZW50IGhpc3RvcnkgZW50cnkgaW5zdGVhZCBvZiBhZGRpbmcgYSBuZXcgb25lLgogICAgQmVzaWRlIHRoYXQsIGl0IGlzIGlkZW50aWNhbCB0byBgdHJhbnNpdGlvblRvYCBpbiBhbGwgb3RoZXIgcmVzcGVjdHMuIFNlZQogICAgJ3RyYW5zaXRpb25UbycgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24gcmVnYXJkaW5nIG11bHRpcGxlIG1vZGVscy4KCiAgICBFeGFtcGxlCgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLlJvdXRlci5tYXAoZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucm91dGUoImluZGV4Iik7CiAgICAgIHRoaXMucm91dGUoInNlY3JldCIpOwogICAgfSk7CgogICAgQXBwLlNlY3JldFJvdXRlID0gRW1iZXIuUm91dGUuZXh0ZW5kKHsKICAgICAgYWZ0ZXJNb2RlbDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCFhdXRob3JpemVkKCkpewogICAgICAgICAgdGhpcy5yZXBsYWNlV2l0aCgnaW5kZXgnKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgQG1ldGhvZCByZXBsYWNlV2l0aAogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgdGhlIG5hbWUgb2YgdGhlIHJvdXRlCiAgICBAcGFyYW0gey4uLk9iamVjdH0gbW9kZWxzIHRoZSBtb2RlbChzKSB0byBiZSB1c2VkIHdoaWxlIHRyYW5zaXRpb25pbmcKICAgIHRvIHRoZSByb3V0ZS4KICAqLwogIHJlcGxhY2VXaXRoOiBmdW5jdGlvbigpIHsKICAgIHZhciByb3V0ZXIgPSB0aGlzLnJvdXRlcjsKICAgIHJldHVybiByb3V0ZXIucmVwbGFjZVdpdGguYXBwbHkocm91dGVyLCBhcmd1bWVudHMpOwogIH0sCgogIC8qKgogICAgU2VuZHMgYW4gYWN0aW9uIHRvIHRoZSByb3V0ZXIsIHdoaWNoIHdpbGwgZGVsZWdhdGUgaXQgdG8gdGhlIGN1cnJlbnRseQogICAgYWN0aXZlIHJvdXRlIGhpZXJhcmNoeSBwZXIgdGhlIGJ1YmJsaW5nIHJ1bGVzIGV4cGxhaW5lZCB1bmRlciBgYWN0aW9uc2AuCgogICAgRXhhbXBsZQoKICAgIGBgYGphdmFzY3JpcHQKICAgIEFwcC5Sb3V0ZXIubWFwKGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnJvdXRlKCJpbmRleCIpOwogICAgfSk7CgogICAgQXBwLkFwcGxpY2F0aW9uUm91dGUgPSBFbWJlci5Sb3V0ZS5leHRlbmQoewogICAgICBhY3Rpb25zOiB7CiAgICAgICAgdHJhY2s6IGZ1bmN0aW9uKGFyZykgewogICAgICAgICAgY29uc29sZS5sb2coYXJnLCAnd2FzIGNsaWNrZWQnKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwoKICAgIEFwcC5JbmRleFJvdXRlID0gRW1iZXIuUm91dGUuZXh0ZW5kKHsKICAgICAgYWN0aW9uczogewogICAgICAgIHRyYWNrSWZEZWJ1ZzogZnVuY3Rpb24oYXJnKSB7CiAgICAgICAgICBpZiAoZGVidWcpIHsKICAgICAgICAgICAgdGhpcy5zZW5kKCd0cmFjaycsIGFyZyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgIEBtZXRob2Qgc2VuZAogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgdGhlIG5hbWUgb2YgdGhlIGFjdGlvbiB0byB0cmlnZ2VyCiAgICBAcGFyYW0gey4uLip9IGFyZ3MKICAqLwogIHNlbmQ6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMucm91dGVyLnNlbmQuYXBwbHkodGhpcy5yb3V0ZXIsIGFyZ3VtZW50cyk7CiAgfSwKCiAgLyoqCiAgICBUaGlzIGhvb2sgaXMgdGhlIGVudHJ5IHBvaW50IGZvciByb3V0ZXIuanMKCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBzZXR1cAogICovCiAgc2V0dXA6IGZ1bmN0aW9uKGNvbnRleHQsIHF1ZXJ5UGFyYW1zKSB7CiAgICB2YXIgY29udHJvbGxlck5hbWUgPSB0aGlzLmNvbnRyb2xsZXJOYW1lIHx8IHRoaXMucm91dGVOYW1lLAogICAgICAgIGNvbnRyb2xsZXIgPSB0aGlzLmNvbnRyb2xsZXJGb3IoY29udHJvbGxlck5hbWUsIHRydWUpOwogICAgaWYgKCFjb250cm9sbGVyKSB7CiAgICAgIGNvbnRyb2xsZXIgPSAgdGhpcy5nZW5lcmF0ZUNvbnRyb2xsZXIoY29udHJvbGxlck5hbWUsIGNvbnRleHQpOwogICAgfQoKICAgIC8vIEFzc2lnbiB0aGUgcm91dGUncyBjb250cm9sbGVyIHNvIHRoYXQgaXQgY2FuIG1vcmUgZWFzaWx5IGJlCiAgICAvLyByZWZlcmVuY2VkIGluIGFjdGlvbiBoYW5kbGVycwogICAgdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjsKCiAgICB2YXIgYXJncyA9IFtjb250cm9sbGVyLCBjb250ZXh0XTsKCiAgICAKICAgIGlmICh0aGlzLnNldHVwQ29udHJvbGxlcnMpIHsKICAgICAgRW1iZXIuZGVwcmVjYXRlKCJFbWJlci5Sb3V0ZS5zZXR1cENvbnRyb2xsZXJzIGlzIGRlcHJlY2F0ZWQuIFBsZWFzZSB1c2UgRW1iZXIuUm91dGUuc2V0dXBDb250cm9sbGVyKGNvbnRyb2xsZXIsIG1vZGVsKSBpbnN0ZWFkLiIpOwogICAgICB0aGlzLnNldHVwQ29udHJvbGxlcnMoY29udHJvbGxlciwgY29udGV4dCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLnNldHVwQ29udHJvbGxlci5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0KCiAgICBpZiAodGhpcy5yZW5kZXJUZW1wbGF0ZXMpIHsKICAgICAgRW1iZXIuZGVwcmVjYXRlKCJFbWJlci5Sb3V0ZS5yZW5kZXJUZW1wbGF0ZXMgaXMgZGVwcmVjYXRlZC4gUGxlYXNlIHVzZSBFbWJlci5Sb3V0ZS5yZW5kZXJUZW1wbGF0ZShjb250cm9sbGVyLCBtb2RlbCkgaW5zdGVhZC4iKTsKICAgICAgdGhpcy5yZW5kZXJUZW1wbGF0ZXMoY29udGV4dCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLnJlbmRlclRlbXBsYXRlLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfQogIH0sCgogIC8qKgogICAgQSBob29rIHlvdSBjYW4gaW1wbGVtZW50IHRvIG9wdGlvbmFsbHkgcmVkaXJlY3QgdG8gYW5vdGhlciByb3V0ZS4KCiAgICBJZiB5b3UgY2FsbCBgdGhpcy50cmFuc2l0aW9uVG9gIGZyb20gaW5zaWRlIG9mIHRoaXMgaG9vaywgdGhpcyByb3V0ZQogICAgd2lsbCBub3QgYmUgZW50ZXJlZCBpbiBmYXZvciBvZiB0aGUgb3RoZXIgaG9vay4KCiAgICBOb3RlIHRoYXQgdGhpcyBob29rIGlzIGNhbGxlZCBieSB0aGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZgogICAgYGFmdGVyTW9kZWxgLCBzbyBpZiB5b3Ugb3ZlcnJpZGUgYGFmdGVyTW9kZWxgLCB5b3UgbXVzdCBlaXRoZXIKICAgIGV4cGxpY2l0bHkgY2FsbCBgcmVkaXJlY3RgIG9yIGp1c3QgcHV0IHlvdXIgcmVkaXJlY3RpbmcKICAgIGB0aGlzLnRyYW5zaXRpb25UbygpYCBjYWxsIHdpdGhpbiBgYWZ0ZXJNb2RlbGAuCgogICAgQG1ldGhvZCByZWRpcmVjdAogICAgQHBhcmFtIHtPYmplY3R9IG1vZGVsIHRoZSBtb2RlbCBmb3IgdGhpcyByb3V0ZQogICovCiAgcmVkaXJlY3Q6IEVtYmVyLkssCgogIC8qKgogICAgVGhpcyBob29rIGlzIHRoZSBmaXJzdCBvZiB0aGUgcm91dGUgZW50cnkgdmFsaWRhdGlvbiBob29rcwogICAgY2FsbGVkIHdoZW4gYW4gYXR0ZW1wdCBpcyBtYWRlIHRvIHRyYW5zaXRpb24gaW50byBhIHJvdXRlCiAgICBvciBvbmUgb2YgaXRzIGNoaWxkcmVuLiBJdCBpcyBjYWxsZWQgYmVmb3JlIGBtb2RlbGAgYW5kCiAgICBgYWZ0ZXJNb2RlbGAsIGFuZCBpcyBhcHByb3ByaWF0ZSBmb3IgY2FzZXMgd2hlbjoKCiAgICAxKSBBIGRlY2lzaW9uIGNhbiBiZSBtYWRlIHRvIHJlZGlyZWN0IGVsc2V3aGVyZSB3aXRob3V0CiAgICAgICBuZWVkaW5nIHRvIHJlc29sdmUgdGhlIG1vZGVsIGZpcnN0LgogICAgMikgQW55IGFzeW5jIG9wZXJhdGlvbnMgbmVlZCB0byBvY2N1ciBmaXJzdCBiZWZvcmUgdGhlCiAgICAgICBtb2RlbCBpcyBhdHRlbXB0ZWQgdG8gYmUgcmVzb2x2ZWQuCgogICAgVGhpcyBob29rIGlzIHByb3ZpZGVkIHRoZSBjdXJyZW50IGB0cmFuc2l0aW9uYCBhdHRlbXB0CiAgICBhcyBhIHBhcmFtZXRlciwgd2hpY2ggY2FuIGJlIHVzZWQgdG8gYC5hYm9ydCgpYCB0aGUgdHJhbnNpdGlvbiwKICAgIHNhdmUgaXQgZm9yIGEgbGF0ZXIgYC5yZXRyeSgpYCwgb3IgcmV0cmlldmUgdmFsdWVzIHNldAogICAgb24gaXQgZnJvbSBhIHByZXZpb3VzIGhvb2suIFlvdSBjYW4gYWxzbyBqdXN0IGNhbGwKICAgIGB0aGlzLnRyYW5zaXRpb25Ub2AgdG8gYW5vdGhlciByb3V0ZSB0byBpbXBsaWNpdGx5CiAgICBhYm9ydCB0aGUgYHRyYW5zaXRpb25gLgoKICAgIFlvdSBjYW4gcmV0dXJuIGEgcHJvbWlzZSBmcm9tIHRoaXMgaG9vayB0byBwYXVzZSB0aGUKICAgIHRyYW5zaXRpb24gdW50aWwgdGhlIHByb21pc2UgcmVzb2x2ZXMgKG9yIHJlamVjdHMpLiBUaGlzIGNvdWxkCiAgICBiZSB1c2VmdWwsIGZvciBpbnN0YW5jZSwgZm9yIHJldHJpZXZpbmcgYXN5bmMgY29kZSBmcm9tCiAgICB0aGUgc2VydmVyIHRoYXQgaXMgcmVxdWlyZWQgdG8gZW50ZXIgYSByb3V0ZS4KCiAgICBgYGBqcwogICAgQXBwLlBvc3RSb3V0ZSA9IEVtYmVyLlJvdXRlLmV4dGVuZCh7CiAgICAgIGJlZm9yZU1vZGVsOiBmdW5jdGlvbih0cmFuc2l0aW9uKSB7CiAgICAgICAgaWYgKCFBcHAuUG9zdCkgewogICAgICAgICAgcmV0dXJuIEVtYmVyLiQuZ2V0U2NyaXB0KCcvbW9kZWxzL3Bvc3QuanMnKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgSWYgYEFwcC5Qb3N0YCBkb2Vzbid0IGV4aXN0IGluIHRoZSBhYm92ZSBleGFtcGxlLAogICAgYGJlZm9yZU1vZGVsYCB3aWxsIHVzZSBqUXVlcnkncyBgZ2V0U2NyaXB0YCwgd2hpY2gKICAgIHJldHVybnMgYSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgYWZ0ZXIgdGhlIHNlcnZlciBoYXMKICAgIHN1Y2Nlc3NmdWxseSByZXRyaWV2ZWQgYW5kIGV4ZWN1dGVkIHRoZSBjb2RlIGZyb20gdGhlCiAgICBzZXJ2ZXIuIE5vdGUgdGhhdCBpZiBhbiBlcnJvciB3ZXJlIHRvIG9jY3VyLCBpdCB3b3VsZAogICAgYmUgcGFzc2VkIHRvIHRoZSBgZXJyb3JgIGhvb2sgb24gYEVtYmVyLlJvdXRlYCwgYnV0CiAgICBpdCdzIGFsc28gcG9zc2libGUgdG8gaGFuZGxlIGVycm9ycyBzcGVjaWZpYyB0bwogICAgYGJlZm9yZU1vZGVsYCByaWdodCBmcm9tIHdpdGhpbiB0aGUgaG9vayAodG8gZGlzdGluZ3Vpc2gKICAgIGZyb20gdGhlIHNoYXJlZCBlcnJvciBoYW5kbGluZyBiZWhhdmlvciBvZiB0aGUgYGVycm9yYAogICAgaG9vayk6CgogICAgYGBganMKICAgIEFwcC5Qb3N0Um91dGUgPSBFbWJlci5Sb3V0ZS5leHRlbmQoewogICAgICBiZWZvcmVNb2RlbDogZnVuY3Rpb24odHJhbnNpdGlvbikgewogICAgICAgIGlmICghQXBwLlBvc3QpIHsKICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgIHJldHVybiBFbWJlci4kLmdldFNjcmlwdCgncG9zdC5qcycpLnRoZW4obnVsbCwgZnVuY3Rpb24oZSkgewogICAgICAgICAgICBzZWxmLnRyYW5zaXRpb25UbygnaGVscCcpOwoKICAgICAgICAgICAgLy8gTm90ZSB0aGF0IHRoZSBhYm92ZSB0cmFuc2l0aW9uVG8gd2lsbCBpbXBsaWNpdGx5CiAgICAgICAgICAgIC8vIGhhbHQgdGhlIHRyYW5zaXRpb24uIElmIHlvdSB3ZXJlIHRvIHJldHVybgogICAgICAgICAgICAvLyBub3RoaW5nIGZyb20gdGhpcyBwcm9taXNlIHJlamVjdCBoYW5kbGVyLAogICAgICAgICAgICAvLyBhY2NvcmRpbmcgdG8gcHJvbWlzZSBzZW1hbnRpY3MsIHRoYXQgd291bGQKICAgICAgICAgICAgLy8gY29udmVydCB0aGUgcmVqZWN0IGludG8gYSByZXNvbHZlIGFuZCB0aGUKICAgICAgICAgICAgLy8gdHJhbnNpdGlvbiB3b3VsZCBjb250aW51ZS4gVG8gcHJvcGFnYXRlIHRoZQogICAgICAgICAgICAvLyBlcnJvciBzbyB0aGF0IGl0J2QgYmUgaGFuZGxlZCBieSB0aGUgYGVycm9yYAogICAgICAgICAgICAvLyBob29rLCB5b3Ugd291bGQgaGF2ZSB0byBlaXRoZXIKICAgICAgICAgICAgcmV0dXJuIEVtYmVyLlJTVlAucmVqZWN0KGUpOwogICAgICAgICAgICAvLyBvcgogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgIEBtZXRob2QgYmVmb3JlTW9kZWwKICAgIEBwYXJhbSB7VHJhbnNpdGlvbn0gdHJhbnNpdGlvbgogICAgQHBhcmFtIHtPYmplY3R9IHF1ZXJ5UGFyYW1zIHRoZSBhY3RpdmUgcXVlcnkgcGFyYW1zIGZvciB0aGlzIHJvdXRlCiAgICBAcmV0dXJuIHtQcm9taXNlfSBpZiB0aGUgdmFsdWUgcmV0dXJuZWQgZnJvbSB0aGlzIGhvb2sgaXMKICAgICAgYSBwcm9taXNlLCB0aGUgdHJhbnNpdGlvbiB3aWxsIHBhdXNlIHVudGlsIHRoZSB0cmFuc2l0aW9uCiAgICAgIHJlc29sdmVzLiBPdGhlcndpc2UsIG5vbi1wcm9taXNlIHJldHVybiB2YWx1ZXMgYXJlIG5vdAogICAgICB1dGlsaXplZCBpbiBhbnkgd2F5LgogICovCiAgYmVmb3JlTW9kZWw6IEVtYmVyLkssCgogIC8qKgogICAgVGhpcyBob29rIGlzIGNhbGxlZCBhZnRlciB0aGlzIHJvdXRlJ3MgbW9kZWwgaGFzIHJlc29sdmVkLgogICAgSXQgZm9sbG93cyBpZGVudGljYWwgYXN5bmMvcHJvbWlzZSBzZW1hbnRpY3MgdG8gYGJlZm9yZU1vZGVsYAogICAgYnV0IGlzIHByb3ZpZGVkIHRoZSByb3V0ZSdzIHJlc29sdmVkIG1vZGVsIGluIGFkZGl0aW9uIHRvCiAgICB0aGUgYHRyYW5zaXRpb25gLCBhbmQgaXMgdGhlcmVmb3JlIHN1aXRlZCB0byBwZXJmb3JtaW5nCiAgICBsb2dpYyB0aGF0IGNhbiBvbmx5IHRha2UgcGxhY2UgYWZ0ZXIgdGhlIG1vZGVsIGhhcyBhbHJlYWR5CiAgICByZXNvbHZlZC4KCiAgICBgYGBqcwogICAgQXBwLlBvc3RzUm91dGUgPSBFbWJlci5Sb3V0ZS5leHRlbmQoewogICAgICBhZnRlck1vZGVsOiBmdW5jdGlvbihwb3N0cywgdHJhbnNpdGlvbikgewogICAgICAgIGlmIChwb3N0cy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgIHRoaXMudHJhbnNpdGlvblRvKCdwb3N0LnNob3cnLCBwb3N0c1swXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgIFJlZmVyIHRvIGRvY3VtZW50YXRpb24gZm9yIGBiZWZvcmVNb2RlbGAgZm9yIGEgZGVzY3JpcHRpb24KICAgIG9mIHRyYW5zaXRpb24tcGF1c2luZyBzZW1hbnRpY3Mgd2hlbiBhIHByb21pc2UgaXMgcmV0dXJuZWQKICAgIGZyb20gdGhpcyBob29rLgoKICAgIEBtZXRob2QgYWZ0ZXJNb2RlbAogICAgQHBhcmFtIHtPYmplY3R9IHJlc29sdmVkTW9kZWwgdGhlIHZhbHVlIHJldHVybmVkIGZyb20gYG1vZGVsYCwKICAgICAgb3IgaXRzIHJlc29sdmVkIHZhbHVlIGlmIGl0IHdhcyBhIHByb21pc2UKICAgIEBwYXJhbSB7VHJhbnNpdGlvbn0gdHJhbnNpdGlvbgogICAgQHBhcmFtIHtPYmplY3R9IHF1ZXJ5UGFyYW1zIHRoZSBhY3RpdmUgcXVlcnkgcGFyYW1zIGZvciB0aGlzIGhhbmRsZXIKICAgIEByZXR1cm4ge1Byb21pc2V9IGlmIHRoZSB2YWx1ZSByZXR1cm5lZCBmcm9tIHRoaXMgaG9vayBpcwogICAgICBhIHByb21pc2UsIHRoZSB0cmFuc2l0aW9uIHdpbGwgcGF1c2UgdW50aWwgdGhlIHRyYW5zaXRpb24KICAgICAgcmVzb2x2ZXMuIE90aGVyd2lzZSwgbm9uLXByb21pc2UgcmV0dXJuIHZhbHVlcyBhcmUgbm90CiAgICAgIHV0aWxpemVkIGluIGFueSB3YXkuCiAgICovCiAgYWZ0ZXJNb2RlbDogZnVuY3Rpb24ocmVzb2x2ZWRNb2RlbCwgdHJhbnNpdGlvbiwgcXVlcnlQYXJhbXMpIHsKICAgIHRoaXMucmVkaXJlY3QocmVzb2x2ZWRNb2RlbCwgdHJhbnNpdGlvbik7CiAgfSwKCgogIC8qKgogICAgQ2FsbGVkIHdoZW4gdGhlIGNvbnRleHQgaXMgY2hhbmdlZCBieSByb3V0ZXIuanMuCgogICAgQHByaXZhdGUKICAgIEBtZXRob2QgY29udGV4dERpZENoYW5nZQogICovCiAgY29udGV4dERpZENoYW5nZTogZnVuY3Rpb24oKSB7CiAgICB0aGlzLmN1cnJlbnRNb2RlbCA9IHRoaXMuY29udGV4dDsKICB9LAoKICAvKioKICAgIEEgaG9vayB5b3UgY2FuIGltcGxlbWVudCB0byBjb252ZXJ0IHRoZSBVUkwgaW50byB0aGUgbW9kZWwgZm9yCiAgICB0aGlzIHJvdXRlLgoKICAgIGBgYGpzCiAgICBBcHAuUm91dGVyLm1hcChmdW5jdGlvbigpIHsKICAgICAgdGhpcy5yZXNvdXJjZSgncG9zdCcsIHtwYXRoOiAnL3Bvc3RzLzpwb3N0X2lkJ30pOwogICAgfSk7CiAgICBgYGAKCiAgICBUaGUgbW9kZWwgZm9yIHRoZSBgcG9zdGAgcm91dGUgaXMgYEFwcC5Qb3N0LmZpbmQocGFyYW1zLnBvc3RfaWQpYC4KCiAgICBCeSBkZWZhdWx0LCBpZiB5b3VyIHJvdXRlIGhhcyBhIGR5bmFtaWMgc2VnbWVudCBlbmRpbmcgaW4gYF9pZGA6CgogICAgKiBUaGUgbW9kZWwgY2xhc3MgaXMgZGV0ZXJtaW5lZCBmcm9tIHRoZSBzZWdtZW50IChgcG9zdF9pZGAncwogICAgICBjbGFzcyBpcyBgQXBwLlBvc3RgKQogICAgKiBUaGUgZmluZCBtZXRob2QgaXMgY2FsbGVkIG9uIHRoZSBtb2RlbCBjbGFzcyB3aXRoIHRoZSB2YWx1ZSBvZgogICAgICB0aGUgZHluYW1pYyBzZWdtZW50LgoKICAgIE5vdGUgdGhhdCBmb3Igcm91dGVzIHdpdGggZHluYW1pYyBzZWdtZW50cywgdGhpcyBob29rIGlzIG9ubHkKICAgIGV4ZWN1dGVkIHdoZW4gZW50ZXJlZCB2aWEgdGhlIFVSTC4gSWYgdGhlIHJvdXRlIGlzIGVudGVyZWQKICAgIHRocm91Z2ggYSB0cmFuc2l0aW9uIChlLmcuIHdoZW4gdXNpbmcgdGhlIGBsaW5rLXRvYCBIYW5kbGViYXJzCiAgICBoZWxwZXIpLCB0aGVuIGEgbW9kZWwgY29udGV4dCBpcyBhbHJlYWR5IHByb3ZpZGVkIGFuZCB0aGlzIGhvb2sKICAgIGlzIG5vdCBjYWxsZWQuIFJvdXRlcyB3aXRob3V0IGR5bmFtaWMgc2VnbWVudHMgd2lsbCBhbHdheXMKICAgIGV4ZWN1dGUgdGhlIG1vZGVsIGhvb2suCgogICAgVGhpcyBob29rIGZvbGxvd3MgdGhlIGFzeW5jaHJvbm91cy9wcm9taXNlIHNlbWFudGljcwogICAgZGVzY3JpYmVkIGluIHRoZSBkb2N1bWVudGF0aW9uIGZvciBgYmVmb3JlTW9kZWxgLiBJbiBwYXJ0aWN1bGFyLAogICAgaWYgYSBwcm9taXNlIHJldHVybmVkIGZyb20gYG1vZGVsYCBmYWlscywgdGhlIGVycm9yIHdpbGwgYmUKICAgIGhhbmRsZWQgYnkgdGhlIGBlcnJvcmAgaG9vayBvbiBgRW1iZXIuUm91dGVgLgoKICAgIEV4YW1wbGUKCiAgICBgYGBqcwogICAgQXBwLlBvc3RSb3V0ZSA9IEVtYmVyLlJvdXRlLmV4dGVuZCh7CiAgICAgIG1vZGVsOiBmdW5jdGlvbihwYXJhbXMpIHsKICAgICAgICByZXR1cm4gQXBwLlBvc3QuZmluZChwYXJhbXMucG9zdF9pZCk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgQG1ldGhvZCBtb2RlbAogICAgQHBhcmFtIHtPYmplY3R9IHBhcmFtcyB0aGUgcGFyYW1ldGVycyBleHRyYWN0ZWQgZnJvbSB0aGUgVVJMCiAgICBAcGFyYW0ge1RyYW5zaXRpb259IHRyYW5zaXRpb24KICAgIEBwYXJhbSB7T2JqZWN0fSBxdWVyeVBhcmFtcyB0aGUgcXVlcnkgcGFyYW1zIGZvciB0aGlzIHJvdXRlCiAgICBAcmV0dXJuIHtPYmplY3R8UHJvbWlzZX0gdGhlIG1vZGVsIGZvciB0aGlzIHJvdXRlLiBJZgogICAgICBhIHByb21pc2UgaXMgcmV0dXJuZWQsIHRoZSB0cmFuc2l0aW9uIHdpbGwgcGF1c2UgdW50aWwKICAgICAgdGhlIHByb21pc2UgcmVzb2x2ZXMsIGFuZCB0aGUgcmVzb2x2ZWQgdmFsdWUgb2YgdGhlIHByb21pc2UKICAgICAgd2lsbCBiZSB1c2VkIGFzIHRoZSBtb2RlbCBmb3IgdGhpcyByb3V0ZS4KICAqLwogIG1vZGVsOiBmdW5jdGlvbihwYXJhbXMsIHRyYW5zaXRpb24pIHsKICAgIHZhciBtYXRjaCwgbmFtZSwgc2F3UGFyYW1zLCB2YWx1ZTsKCiAgICBmb3IgKHZhciBwcm9wIGluIHBhcmFtcykgewogICAgICBpZiAobWF0Y2ggPSBwcm9wLm1hdGNoKC9eKC4qKV9pZCQvKSkgewogICAgICAgIG5hbWUgPSBtYXRjaFsxXTsKICAgICAgICB2YWx1ZSA9IHBhcmFtc1twcm9wXTsKICAgICAgfQogICAgICBzYXdQYXJhbXMgPSB0cnVlOwogICAgfQoKICAgIGlmICghbmFtZSAmJiBzYXdQYXJhbXMpIHsgcmV0dXJuIHBhcmFtczsgfQogICAgZWxzZSBpZiAoIW5hbWUpIHsgcmV0dXJuOyB9CgogICAgcmV0dXJuIHRoaXMuZmluZE1vZGVsKG5hbWUsIHZhbHVlKTsKICB9LAoKICAvKioKCiAgICBAbWV0aG9kIGZpbmRNb2RlbAogICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgdGhlIG1vZGVsIHR5cGUKICAgIEBwYXJhbSB7T2JqZWN0fSB2YWx1ZSB0aGUgdmFsdWUgcGFzc2VkIHRvIGZpbmQKICAqLwogIGZpbmRNb2RlbDogZnVuY3Rpb24oKXsKICAgIHZhciBzdG9yZSA9IGdldCh0aGlzLCAnc3RvcmUnKTsKICAgIHJldHVybiBzdG9yZS5maW5kLmFwcGx5KHN0b3JlLCBhcmd1bWVudHMpOwogIH0sCgogIC8qKgogICAgU3RvcmUgcHJvcGVydHkgcHJvdmlkZXMgYSBob29rIGZvciBkYXRhIHBlcnNpc3RlbmNlIGxpYnJhcmllcyB0byBpbmplY3QgdGhlbXNlbHZlcy4KCiAgICBCeSBkZWZhdWx0LCB0aGlzIHN0b3JlIHByb3BlcnR5IHByb3ZpZGVzIHRoZSBleGFjdCBzYW1lIGZ1bmN0aW9uYWxpdHkgcHJldmlvdXNseQogICAgaW4gdGhlIG1vZGVsIGhvb2suCgogICAgQ3VycmVudGx5LCB0aGUgcmVxdWlyZWQgaW50ZXJmYWNlIGlzOgoKICAgIGBzdG9yZS5maW5kKG1vZGVsTmFtZSwgZmluZEFyZ3VtZW50cylgCgogICAgQG1ldGhvZCBzdG9yZQogICAgQHBhcmFtIHtPYmplY3R9IHN0b3JlCiAgKi8KICBzdG9yZTogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oKXsKICAgIHZhciBjb250YWluZXIgPSB0aGlzLmNvbnRhaW5lcjsKICAgIHZhciByb3V0ZU5hbWUgPSB0aGlzLnJvdXRlTmFtZTsKICAgIHZhciBuYW1lc3BhY2UgPSBnZXQodGhpcywgJ3JvdXRlci5uYW1lc3BhY2UnKTsKCiAgICByZXR1cm4gewogICAgICBmaW5kOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgIHZhciBtb2RlbENsYXNzID0gY29udGFpbmVyLmxvb2t1cEZhY3RvcnkoJ21vZGVsOicgKyBuYW1lKTsKCiAgICAgICAgRW1iZXIuYXNzZXJ0KCJZb3UgdXNlZCB0aGUgZHluYW1pYyBzZWdtZW50ICIgKyBuYW1lICsgIl9pZCBpbiB5b3VyIHJvdXRlICIgKwogICAgICAgICAgICAgICAgICAgICByb3V0ZU5hbWUgKyAiLCBidXQgIiArIG5hbWVzcGFjZSArICIuIiArIGNsYXNzaWZ5KG5hbWUpICsKICAgICAgICAgICAgICAgICAgICAgIiBkaWQgbm90IGV4aXN0IGFuZCB5b3UgZGlkIG5vdCBvdmVycmlkZSB5b3VyIHJvdXRlJ3MgYG1vZGVsYCAiICsKICAgICAgICAgICAgICAgICAgICAgImhvb2suIiwgbW9kZWxDbGFzcyk7CgogICAgICAgIHJldHVybiBtb2RlbENsYXNzLmZpbmQodmFsdWUpOwogICAgICB9CiAgICB9OwogIH0pLAoKICAvKioKICAgIEEgaG9vayB5b3UgY2FuIGltcGxlbWVudCB0byBjb252ZXJ0IHRoZSByb3V0ZSdzIG1vZGVsIGludG8gcGFyYW1ldGVycwogICAgZm9yIHRoZSBVUkwuCgogICAgYGBganMKICAgIEFwcC5Sb3V0ZXIubWFwKGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnJlc291cmNlKCdwb3N0Jywge3BhdGg6ICcvcG9zdHMvOnBvc3RfaWQnfSk7CiAgICB9KTsKCiAgICBBcHAuUG9zdFJvdXRlID0gRW1iZXIuUm91dGUuZXh0ZW5kKHsKICAgICAgbW9kZWw6IGZ1bmN0aW9uKHBhcmFtcykgewogICAgICAgIC8vIHRoZSBzZXJ2ZXIgcmV0dXJucyBgeyBpZDogMTIgfWAKICAgICAgICByZXR1cm4galF1ZXJ5LmdldEpTT04oIi9wb3N0cy8iICsgcGFyYW1zLnBvc3RfaWQpOwogICAgICB9LAoKICAgICAgc2VyaWFsaXplOiBmdW5jdGlvbihtb2RlbCkgewogICAgICAgIC8vIHRoaXMgd2lsbCBtYWtlIHRoZSBVUkwgYC9wb3N0cy8xMmAKICAgICAgICByZXR1cm4geyBwb3N0X2lkOiBtb2RlbC5pZCB9OwogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgIFRoZSBkZWZhdWx0IGBzZXJpYWxpemVgIG1ldGhvZCB3aWxsIGluc2VydCB0aGUgbW9kZWwncyBgaWRgIGludG8gdGhlCiAgICByb3V0ZSdzIGR5bmFtaWMgc2VnbWVudCAoaW4gdGhpcyBjYXNlLCBgOnBvc3RfaWRgKSBpZiB0aGUgc2VnbWVudCBjb250YWlucyAnX2lkJy4KICAgIElmIHRoZSByb3V0ZSBoYXMgbXVsdGlwbGUgZHluYW1pYyBzZWdtZW50cyBvciBkb2VzIG5vdCBjb250YWluICdfaWQnLCBgc2VyaWFsaXplYAogICAgd2lsbCByZXR1cm4gYEVtYmVyLmdldFByb3BlcnRpZXMobW9kZWwsIHBhcmFtcylgCgogICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIHdoZW4gYHRyYW5zaXRpb25Ub2AgaXMgY2FsbGVkIHdpdGggYSBjb250ZXh0CiAgICBpbiBvcmRlciB0byBwb3B1bGF0ZSB0aGUgVVJMLgoKICAgIEBtZXRob2Qgc2VyaWFsaXplCiAgICBAcGFyYW0ge09iamVjdH0gbW9kZWwgdGhlIHJvdXRlJ3MgbW9kZWwKICAgIEBwYXJhbSB7QXJyYXl9IHBhcmFtcyBhbiBBcnJheSBvZiBwYXJhbWV0ZXIgbmFtZXMgZm9yIHRoZSBjdXJyZW50CiAgICAgIHJvdXRlIChpbiB0aGUgZXhhbXBsZSwgYFsncG9zdF9pZCddYC4KICAgIEByZXR1cm4ge09iamVjdH0gdGhlIHNlcmlhbGl6ZWQgcGFyYW1ldGVycwogICovCiAgc2VyaWFsaXplOiBmdW5jdGlvbihtb2RlbCwgcGFyYW1zKSB7CiAgICBpZiAocGFyYW1zLmxlbmd0aCA8IDEpIHsgcmV0dXJuOyB9CiAgICBpZiAoIW1vZGVsKSB7IHJldHVybjsgfQoKICAgIHZhciBuYW1lID0gcGFyYW1zWzBdLCBvYmplY3QgPSB7fTsKCiAgICBpZiAoL19pZCQvLnRlc3QobmFtZSkgJiYgcGFyYW1zLmxlbmd0aCA9PT0gMSkgewogICAgICBvYmplY3RbbmFtZV0gPSBnZXQobW9kZWwsICJpZCIpOwogICAgfSBlbHNlIHsKICAgICAgb2JqZWN0ID0gZ2V0UHJvcGVydGllcyhtb2RlbCwgcGFyYW1zKTsKICAgIH0KCiAgICByZXR1cm4gb2JqZWN0OwogIH0sCgogIC8qKgogICAgQSBob29rIHlvdSBjYW4gdXNlIHRvIHNldHVwIHRoZSBjb250cm9sbGVyIGZvciB0aGUgY3VycmVudCByb3V0ZS4KCiAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgd2l0aCB0aGUgY29udHJvbGxlciBmb3IgdGhlIGN1cnJlbnQgcm91dGUgYW5kIHRoZQogICAgbW9kZWwgc3VwcGxpZWQgYnkgdGhlIGBtb2RlbGAgaG9vay4KCiAgICBCeSBkZWZhdWx0LCB0aGUgYHNldHVwQ29udHJvbGxlcmAgaG9vayBzZXRzIHRoZSBgY29udGVudGAgcHJvcGVydHkgb2YKICAgIHRoZSBjb250cm9sbGVyIHRvIHRoZSBgbW9kZWxgLgoKICAgIFRoaXMgbWVhbnMgdGhhdCB5b3VyIHRlbXBsYXRlIHdpbGwgZ2V0IGEgcHJveHkgZm9yIHRoZSBtb2RlbCBhcyBpdHMKICAgIGNvbnRleHQsIGFuZCB5b3UgY2FuIGFjdCBhcyB0aG91Z2ggdGhlIG1vZGVsIGl0c2VsZiB3YXMgdGhlIGNvbnRleHQuCgogICAgVGhlIHByb3ZpZGVkIGNvbnRyb2xsZXIgd2lsbCBiZSBvbmUgcmVzb2x2ZWQgYmFzZWQgb24gdGhlIG5hbWUKICAgIG9mIHRoaXMgcm91dGUuCgogICAgSWYgbm8gZXhwbGljaXQgY29udHJvbGxlciBpcyBkZWZpbmVkLCBFbWJlciB3aWxsIGF1dG9tYXRpY2FsbHkgY3JlYXRlCiAgICBhbiBhcHByb3ByaWF0ZSBjb250cm9sbGVyIGZvciB0aGUgbW9kZWwuCgogICAgKiBpZiB0aGUgbW9kZWwgaXMgYW4gYEVtYmVyLkFycmF5YCAoaW5jbHVkaW5nIHJlY29yZCBhcnJheXMgZnJvbSBFbWJlcgogICAgICBEYXRhKSwgdGhlIGNvbnRyb2xsZXIgaXMgYW4gYEVtYmVyLkFycmF5Q29udHJvbGxlcmAuCiAgICAqIG90aGVyd2lzZSwgdGhlIGNvbnRyb2xsZXIgaXMgYW4gYEVtYmVyLk9iamVjdENvbnRyb2xsZXJgLgoKICAgIEFzIGFuIGV4YW1wbGUsIGNvbnNpZGVyIHRoZSByb3V0ZXI6CgogICAgYGBganMKICAgIEFwcC5Sb3V0ZXIubWFwKGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnJlc291cmNlKCdwb3N0Jywge3BhdGg6ICcvcG9zdHMvOnBvc3RfaWQnfSk7CiAgICB9KTsKICAgIGBgYAoKICAgIEZvciB0aGUgYHBvc3RgIHJvdXRlLCBhIGNvbnRyb2xsZXIgbmFtZWQgYEFwcC5Qb3N0Q29udHJvbGxlcmAgd291bGQKICAgIGJlIHVzZWQgaWYgaXQgaXMgZGVmaW5lZC4gSWYgaXQgaXMgbm90IGRlZmluZWQsIGFuIGBFbWJlci5PYmplY3RDb250cm9sbGVyYAogICAgaW5zdGFuY2Ugd291bGQgYmUgdXNlZC4KCiAgICBFeGFtcGxlCgogICAgYGBganMKICAgIEFwcC5Qb3N0Um91dGUgPSBFbWJlci5Sb3V0ZS5leHRlbmQoewogICAgICBzZXR1cENvbnRyb2xsZXI6IGZ1bmN0aW9uKGNvbnRyb2xsZXIsIG1vZGVsKSB7CiAgICAgICAgY29udHJvbGxlci5zZXQoJ21vZGVsJywgbW9kZWwpOwogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgIEBtZXRob2Qgc2V0dXBDb250cm9sbGVyCiAgICBAcGFyYW0ge0NvbnRyb2xsZXJ9IGNvbnRyb2xsZXIgaW5zdGFuY2UKICAgIEBwYXJhbSB7T2JqZWN0fSBtb2RlbAogICovCiAgc2V0dXBDb250cm9sbGVyOiBmdW5jdGlvbihjb250cm9sbGVyLCBjb250ZXh0KSB7CiAgICBpZiAoY29udHJvbGxlciAmJiAoY29udGV4dCAhPT0gdW5kZWZpbmVkKSkgewogICAgICBzZXQoY29udHJvbGxlciwgJ21vZGVsJywgY29udGV4dCk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICBSZXR1cm5zIHRoZSBjb250cm9sbGVyIGZvciBhIHBhcnRpY3VsYXIgcm91dGUgb3IgbmFtZS4KCiAgICBUaGUgY29udHJvbGxlciBpbnN0YW5jZSBtdXN0IGFscmVhZHkgaGF2ZSBiZWVuIGNyZWF0ZWQsIGVpdGhlciB0aHJvdWdoIGVudGVyaW5nIHRoZQogICAgYXNzb2NpYXRlZCByb3V0ZSBvciB1c2luZyBgZ2VuZXJhdGVDb250cm9sbGVyYC4KCiAgICBgYGBqcwogICAgQXBwLlBvc3RSb3V0ZSA9IEVtYmVyLlJvdXRlLmV4dGVuZCh7CiAgICAgIHNldHVwQ29udHJvbGxlcjogZnVuY3Rpb24oY29udHJvbGxlciwgcG9zdCkgewogICAgICAgIHRoaXMuX3N1cGVyKGNvbnRyb2xsZXIsIHBvc3QpOwogICAgICAgIHRoaXMuY29udHJvbGxlckZvcigncG9zdHMnKS5zZXQoJ2N1cnJlbnRQb3N0JywgcG9zdCk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgQG1ldGhvZCBjb250cm9sbGVyRm9yCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSB0aGUgbmFtZSBvZiB0aGUgcm91dGUgb3IgY29udHJvbGxlcgogICAgQHJldHVybiB7RW1iZXIuQ29udHJvbGxlcn0KICAqLwogIGNvbnRyb2xsZXJGb3I6IGZ1bmN0aW9uKG5hbWUsIF9za2lwQXNzZXJ0KSB7CiAgICB2YXIgY29udGFpbmVyID0gdGhpcy5jb250YWluZXIsCiAgICAgICAgcm91dGUgPSBjb250YWluZXIubG9va3VwKCdyb3V0ZTonK25hbWUpLAogICAgICAgIGNvbnRyb2xsZXI7CgogICAgaWYgKHJvdXRlICYmIHJvdXRlLmNvbnRyb2xsZXJOYW1lKSB7CiAgICAgIG5hbWUgPSByb3V0ZS5jb250cm9sbGVyTmFtZTsKICAgIH0KCiAgICBjb250cm9sbGVyID0gY29udGFpbmVyLmxvb2t1cCgnY29udHJvbGxlcjonICsgbmFtZSk7CgogICAgLy8gTk9URTogV2UncmUgc3BlY2lmaWNhbGx5IGNoZWNraW5nIHRoYXQgc2tpcEFzc2VydCBpcyB0cnVlLCBiZWNhdXNlIGFjY29yZGluZwogICAgLy8gICB0byB0aGUgb2xkIEFQSSB0aGUgc2Vjb25kIHBhcmFtZXRlciB3YXMgbW9kZWwuIFdlIGRvIG5vdCB3YW50IHBlb3BsZSB3aG8KICAgIC8vICAgcGFzc2VkIGEgbW9kZWwgdG8gc2tpcCB0aGUgYXNzZXJ0aW9uLgogICAgRW1iZXIuYXNzZXJ0KCJUaGUgY29udHJvbGxlciBuYW1lZCAnIituYW1lKyInIGNvdWxkIG5vdCBiZSBmb3VuZC4gTWFrZSBzdXJlICIgKwogICAgICAgICAgICAgICAgICJ0aGF0IHRoaXMgcm91dGUgZXhpc3RzIGFuZCBoYXMgYWxyZWFkeSBiZWVuIGVudGVyZWQgYXQgbGVhc3QgIiArCiAgICAgICAgICAgICAgICAgIm9uY2UuIElmIHlvdSBhcmUgYWNjZXNzaW5nIGEgY29udHJvbGxlciBub3QgYXNzb2NpYXRlZCB3aXRoIGEgIiArCiAgICAgICAgICAgICAgICAgInJvdXRlLCBtYWtlIHN1cmUgdGhlIGNvbnRyb2xsZXIgY2xhc3MgaXMgZXhwbGljaXRseSBkZWZpbmVkLiIsCiAgICAgICAgICAgICAgICAgY29udHJvbGxlciB8fCBfc2tpcEFzc2VydCA9PT0gdHJ1ZSk7CgogICAgcmV0dXJuIGNvbnRyb2xsZXI7CiAgfSwKCiAgLyoqCiAgICBHZW5lcmF0ZXMgYSBjb250cm9sbGVyIGZvciBhIHJvdXRlLgoKICAgIElmIHRoZSBvcHRpb25hbCBtb2RlbCBpcyBwYXNzZWQgdGhlbiB0aGUgY29udHJvbGxlciB0eXBlIGlzIGRldGVybWluZWQgYXV0b21hdGljYWxseSwKICAgIGUuZy4sIGFuIEFycmF5Q29udHJvbGxlciBmb3IgYXJyYXlzLgoKICAgIEV4YW1wbGUKCiAgICBgYGBqcwogICAgQXBwLlBvc3RSb3V0ZSA9IEVtYmVyLlJvdXRlLmV4dGVuZCh7CiAgICAgIHNldHVwQ29udHJvbGxlcjogZnVuY3Rpb24oY29udHJvbGxlciwgcG9zdCkgewogICAgICAgIHRoaXMuX3N1cGVyKGNvbnRyb2xsZXIsIHBvc3QpOwogICAgICAgIHRoaXMuZ2VuZXJhdGVDb250cm9sbGVyKCdwb3N0cycsIHBvc3QpOwogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgIEBtZXRob2QgZ2VuZXJhdGVDb250cm9sbGVyCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSB0aGUgbmFtZSBvZiB0aGUgY29udHJvbGxlcgogICAgQHBhcmFtIHtPYmplY3R9IG1vZGVsIHRoZSBtb2RlbCB0byBpbmZlciB0aGUgdHlwZSBvZiB0aGUgY29udHJvbGxlciAob3B0aW9uYWwpCiAgKi8KICBnZW5lcmF0ZUNvbnRyb2xsZXI6IGZ1bmN0aW9uKG5hbWUsIG1vZGVsKSB7CiAgICB2YXIgY29udGFpbmVyID0gdGhpcy5jb250YWluZXI7CgogICAgbW9kZWwgPSBtb2RlbCB8fCB0aGlzLm1vZGVsRm9yKG5hbWUpOwoKICAgIHJldHVybiBFbWJlci5nZW5lcmF0ZUNvbnRyb2xsZXIoY29udGFpbmVyLCBuYW1lLCBtb2RlbCk7CiAgfSwKCiAgLyoqCiAgICBSZXR1cm5zIHRoZSBtb2RlbCBvZiBhIHBhcmVudCAob3IgYW55IGFuY2VzdG9yKSByb3V0ZQogICAgaW4gYSByb3V0ZSBoaWVyYXJjaHkuICBEdXJpbmcgYSB0cmFuc2l0aW9uLCBhbGwgcm91dGVzCiAgICBtdXN0IHJlc29sdmUgYSBtb2RlbCBvYmplY3QsIGFuZCBpZiBhIHJvdXRlCiAgICBuZWVkcyBhY2Nlc3MgdG8gYSBwYXJlbnQgcm91dGUncyBtb2RlbCBpbiBvcmRlciB0bwogICAgcmVzb2x2ZSBhIG1vZGVsIChvciBqdXN0IHJldXNlIHRoZSBtb2RlbCBmcm9tIGEgcGFyZW50KSwKICAgIGl0IGNhbiBjYWxsIGB0aGlzLm1vZGVsRm9yKHRoZU5hbWVPZlBhcmVudFJvdXRlKWAgdG8KICAgIHJldHJpZXZlIGl0LgoKICAgIEV4YW1wbGUKCiAgICBgYGBqcwogICAgQXBwLlJvdXRlci5tYXAoZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yZXNvdXJjZSgncG9zdCcsIHsgcGF0aDogJy9wb3N0Lzpwb3N0X2lkJyB9LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5yZXNvdXJjZSgnY29tbWVudHMnKTsKICAgICAgICB9KTsKICAgIH0pOwoKICAgIEFwcC5Db21tZW50c1JvdXRlID0gRW1iZXIuUm91dGUuZXh0ZW5kKHsKICAgICAgICBhZnRlck1vZGVsOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5zZXQoJ3Bvc3QnLCB0aGlzLm1vZGVsRm9yKCdwb3N0JykpOwogICAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgQG1ldGhvZCBtb2RlbEZvcgogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgdGhlIG5hbWUgb2YgdGhlIHJvdXRlCiAgICBAcmV0dXJuIHtPYmplY3R9IHRoZSBtb2RlbCBvYmplY3QKICAqLwogIG1vZGVsRm9yOiBmdW5jdGlvbihuYW1lKSB7CgogICAgdmFyIHJvdXRlID0gdGhpcy5jb250YWluZXIubG9va3VwKCdyb3V0ZTonICsgbmFtZSksCiAgICAgICAgdHJhbnNpdGlvbiA9IHRoaXMucm91dGVyLnJvdXRlci5hY3RpdmVUcmFuc2l0aW9uOwoKICAgIC8vIElmIHdlIGFyZSBtaWQtdHJhbnNpdGlvbiwgd2Ugd2FudCB0byB0cnkgYW5kIGxvb2sgdXAKICAgIC8vIHJlc29sdmVkIHBhcmVudCBjb250ZXh0cyBvbiB0aGUgY3VycmVudCB0cmFuc2l0aW9uRXZlbnQuCiAgICBpZiAodHJhbnNpdGlvbikgewogICAgICB2YXIgbW9kZWxMb29rdXBOYW1lID0gKHJvdXRlICYmIHJvdXRlLnJvdXRlTmFtZSkgfHwgbmFtZTsKICAgICAgaWYgKHRyYW5zaXRpb24ucmVzb2x2ZWRNb2RlbHMuaGFzT3duUHJvcGVydHkobW9kZWxMb29rdXBOYW1lKSkgewogICAgICAgIHJldHVybiB0cmFuc2l0aW9uLnJlc29sdmVkTW9kZWxzW21vZGVsTG9va3VwTmFtZV07CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcm91dGUgJiYgcm91dGUuY3VycmVudE1vZGVsOwogIH0sCgogIC8qKgogICAgQSBob29rIHlvdSBjYW4gdXNlIHRvIHJlbmRlciB0aGUgdGVtcGxhdGUgZm9yIHRoZSBjdXJyZW50IHJvdXRlLgoKICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCB3aXRoIHRoZSBjb250cm9sbGVyIGZvciB0aGUgY3VycmVudCByb3V0ZSBhbmQgdGhlCiAgICBtb2RlbCBzdXBwbGllZCBieSB0aGUgYG1vZGVsYCBob29rLiBCeSBkZWZhdWx0LCBpdCByZW5kZXJzIHRoZSByb3V0ZSdzCiAgICB0ZW1wbGF0ZSwgY29uZmlndXJlZCB3aXRoIHRoZSBjb250cm9sbGVyIGZvciB0aGUgcm91dGUuCgogICAgVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRkZW4gdG8gc2V0IHVwIGFuZCByZW5kZXIgYWRkaXRpb25hbCBvcgogICAgYWx0ZXJuYXRpdmUgdGVtcGxhdGVzLgoKICAgIGBgYGpzCiAgICBBcHAuUG9zdHNSb3V0ZSA9IEVtYmVyLlJvdXRlLmV4dGVuZCh7CiAgICAgIHJlbmRlclRlbXBsYXRlOiBmdW5jdGlvbihjb250cm9sbGVyLCBtb2RlbCkgewogICAgICAgIHZhciBmYXZDb250cm9sbGVyID0gdGhpcy5jb250cm9sbGVyRm9yKCdmYXZvcml0ZVBvc3QnKTsKCiAgICAgICAgLy8gUmVuZGVyIHRoZSBgZmF2b3JpdGVQb3N0YCB0ZW1wbGF0ZSBpbnRvCiAgICAgICAgLy8gdGhlIG91dGxldCBgcG9zdHNgLCBhbmQgZGlzcGxheSB0aGUgYGZhdm9yaXRlUG9zdGAKICAgICAgICAvLyBjb250cm9sbGVyLgogICAgICAgIHRoaXMucmVuZGVyKCdmYXZvcml0ZVBvc3QnLCB7CiAgICAgICAgICBvdXRsZXQ6ICdwb3N0cycsCiAgICAgICAgICBjb250cm9sbGVyOiBmYXZDb250cm9sbGVyCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgQG1ldGhvZCByZW5kZXJUZW1wbGF0ZQogICAgQHBhcmFtIHtPYmplY3R9IGNvbnRyb2xsZXIgdGhlIHJvdXRlJ3MgY29udHJvbGxlcgogICAgQHBhcmFtIHtPYmplY3R9IG1vZGVsIHRoZSByb3V0ZSdzIG1vZGVsCiAgKi8KICByZW5kZXJUZW1wbGF0ZTogZnVuY3Rpb24oY29udHJvbGxlciwgbW9kZWwpIHsKICAgIHRoaXMucmVuZGVyKCk7CiAgfSwKCiAgLyoqCiAgICBSZW5kZXJzIGEgdGVtcGxhdGUgaW50byBhbiBvdXRsZXQuCgogICAgVGhpcyBtZXRob2QgaGFzIGEgbnVtYmVyIG9mIGRlZmF1bHRzLCBiYXNlZCBvbiB0aGUgbmFtZSBvZiB0aGUKICAgIHJvdXRlIHNwZWNpZmllZCBpbiB0aGUgcm91dGVyLgoKICAgIEZvciBleGFtcGxlOgoKICAgIGBgYGpzCiAgICBBcHAuUm91dGVyLm1hcChmdW5jdGlvbigpIHsKICAgICAgdGhpcy5yb3V0ZSgnaW5kZXgnKTsKICAgICAgdGhpcy5yZXNvdXJjZSgncG9zdCcsIHtwYXRoOiAnL3Bvc3RzLzpwb3N0X2lkJ30pOwogICAgfSk7CgogICAgQXBwLlBvc3RSb3V0ZSA9IEFwcC5Sb3V0ZS5leHRlbmQoewogICAgICByZW5kZXJUZW1wbGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yZW5kZXIoKTsKICAgICAgfQogICAgfSk7CiAgICBgYGAKCiAgICBUaGUgbmFtZSBvZiB0aGUgYFBvc3RSb3V0ZWAsIGFzIGRlZmluZWQgYnkgdGhlIHJvdXRlciwgaXMgYHBvc3RgLgoKICAgIEJ5IGRlZmF1bHQsIHJlbmRlciB3aWxsOgoKICAgICogcmVuZGVyIHRoZSBgcG9zdGAgdGVtcGxhdGUKICAgICogd2l0aCB0aGUgYHBvc3RgIHZpZXcgKGBQb3N0Vmlld2ApIGZvciBldmVudCBoYW5kbGluZywgaWYgb25lIGV4aXN0cwogICAgKiBhbmQgdGhlIGBwb3N0YCBjb250cm9sbGVyIChgUG9zdENvbnRyb2xsZXJgKSwgaWYgb25lIGV4aXN0cwogICAgKiBpbnRvIHRoZSBgbWFpbmAgb3V0bGV0IG9mIHRoZSBgYXBwbGljYXRpb25gIHRlbXBsYXRlCgogICAgWW91IGNhbiBvdmVycmlkZSB0aGlzIGJlaGF2aW9yOgoKICAgIGBgYGpzCiAgICBBcHAuUG9zdFJvdXRlID0gQXBwLlJvdXRlLmV4dGVuZCh7CiAgICAgIHJlbmRlclRlbXBsYXRlOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnJlbmRlcignbXlQb3N0JywgeyAgIC8vIHRoZSB0ZW1wbGF0ZSB0byByZW5kZXIKICAgICAgICAgIGludG86ICdpbmRleCcsICAgICAgICAgIC8vIHRoZSB0ZW1wbGF0ZSB0byByZW5kZXIgaW50bwogICAgICAgICAgb3V0bGV0OiAnZGV0YWlsJywgICAgICAgLy8gdGhlIG5hbWUgb2YgdGhlIG91dGxldCBpbiB0aGF0IHRlbXBsYXRlCiAgICAgICAgICBjb250cm9sbGVyOiAnYmxvZ1Bvc3QnICAvLyB0aGUgY29udHJvbGxlciB0byB1c2UgZm9yIHRoZSB0ZW1wbGF0ZQogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgIFJlbWVtYmVyIHRoYXQgdGhlIGNvbnRyb2xsZXIncyBgY29udGVudGAgd2lsbCBiZSB0aGUgcm91dGUncyBtb2RlbC4gSW4KICAgIHRoaXMgY2FzZSwgdGhlIGRlZmF1bHQgbW9kZWwgd2lsbCBiZSBgQXBwLlBvc3QuZmluZChwYXJhbXMucG9zdF9pZClgLgoKICAgIEBtZXRob2QgcmVuZGVyCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSB0aGUgbmFtZSBvZiB0aGUgdGVtcGxhdGUgdG8gcmVuZGVyCiAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyB0aGUgb3B0aW9ucwogICovCiAgcmVuZGVyOiBmdW5jdGlvbihuYW1lLCBvcHRpb25zKSB7CiAgICBFbWJlci5hc3NlcnQoIlRoZSBuYW1lIGluIHRoZSBnaXZlbiBhcmd1bWVudHMgaXMgdW5kZWZpbmVkIiwgYXJndW1lbnRzLmxlbmd0aCA+IDAgPyAhRW1iZXIuaXNOb25lKGFyZ3VtZW50c1swXSkgOiB0cnVlKTsKCiAgICB2YXIgbmFtZVBhc3NlZCA9ICEhbmFtZTsKCiAgICBpZiAodHlwZW9mIG5hbWUgPT09ICdvYmplY3QnICYmICFvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBuYW1lOwogICAgICBuYW1lID0gdGhpcy5yb3V0ZU5hbWU7CiAgICB9CgogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgdmFyIHRlbXBsYXRlTmFtZTsKCiAgICBpZiAobmFtZSkgewogICAgICBuYW1lID0gbmFtZS5yZXBsYWNlKC9cLy9nLCAnLicpOwogICAgICB0ZW1wbGF0ZU5hbWUgPSBuYW1lOwogICAgfSBlbHNlIHsKICAgICAgbmFtZSA9IHRoaXMucm91dGVOYW1lOwogICAgICB0ZW1wbGF0ZU5hbWUgPSB0aGlzLnRlbXBsYXRlTmFtZSB8fCBuYW1lOwogICAgfQoKICAgIHZhciB2aWV3TmFtZSA9IG9wdGlvbnMudmlldyB8fCB0aGlzLnZpZXdOYW1lIHx8IG5hbWU7CgogICAgdmFyIGNvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyLAogICAgICAgIHZpZXcgPSBjb250YWluZXIubG9va3VwKCd2aWV3OicgKyB2aWV3TmFtZSksCiAgICAgICAgdGVtcGxhdGUgPSB2aWV3ID8gdmlldy5nZXQoJ3RlbXBsYXRlJykgOiBudWxsOwoKICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgdGVtcGxhdGUgPSBjb250YWluZXIubG9va3VwKCd0ZW1wbGF0ZTonICsgdGVtcGxhdGVOYW1lKTsKICAgIH0KCiAgICBpZiAoIXZpZXcgJiYgIXRlbXBsYXRlKSB7CiAgICAgIEVtYmVyLmFzc2VydCgiQ291bGQgbm90IGZpbmQgXCIiICsgbmFtZSArICJcIiB0ZW1wbGF0ZSBvciB2aWV3LiIsICFuYW1lUGFzc2VkKTsKICAgICAgaWYgKGdldCh0aGlzLnJvdXRlciwgJ25hbWVzcGFjZS5MT0dfVklFV19MT09LVVBTJykpIHsKICAgICAgICBFbWJlci5Mb2dnZXIuaW5mbygiQ291bGQgbm90IGZpbmQgXCIiICsgbmFtZSArICJcIiB0ZW1wbGF0ZSBvciB2aWV3LiBOb3RoaW5nIHdpbGwgYmUgcmVuZGVyZWQiLCB7IGZ1bGxOYW1lOiAndGVtcGxhdGU6JyArIG5hbWUgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQoKICAgIG9wdGlvbnMgPSBub3JtYWxpemVPcHRpb25zKHRoaXMsIG5hbWUsIHRlbXBsYXRlLCBvcHRpb25zKTsKICAgIHZpZXcgPSBzZXR1cFZpZXcodmlldywgY29udGFpbmVyLCBvcHRpb25zKTsKCiAgICBpZiAob3B0aW9ucy5vdXRsZXQgPT09ICdtYWluJykgeyB0aGlzLmxhc3RSZW5kZXJlZFRlbXBsYXRlID0gbmFtZTsgfQoKICAgIGFwcGVuZFZpZXcodGhpcywgdmlldywgb3B0aW9ucyk7CiAgfSwKCiAgLyoqCiAgICBEaXNjb25uZWN0cyBhIHZpZXcgdGhhdCBoYXMgYmVlbiByZW5kZXJlZCBpbnRvIGFuIG91dGxldC4KCiAgICBZb3UgbWF5IHBhc3MgYW55IG9yIGFsbCBvZiB0aGUgZm9sbG93aW5nIG9wdGlvbnMgdG8gYGRpc2Nvbm5lY3RPdXRsZXRgOgoKICAgICogYG91dGxldGA6IHRoZSBuYW1lIG9mIHRoZSBvdXRsZXQgdG8gY2xlYXIgKGRlZmF1bHQ6ICdtYWluJykKICAgICogYHBhcmVudFZpZXdgOiB0aGUgbmFtZSBvZiB0aGUgdmlldyBjb250YWluaW5nIHRoZSBvdXRsZXQgdG8gY2xlYXIKICAgICAgIChkZWZhdWx0OiB0aGUgdmlldyByZW5kZXJlZCBieSB0aGUgcGFyZW50IHJvdXRlKQoKICAgIEV4YW1wbGU6CgogICAgYGBganMKICAgIEFwcC5BcHBsaWNhdGlvblJvdXRlID0gQXBwLlJvdXRlLmV4dGVuZCh7CiAgICAgIGFjdGlvbnM6IHsKICAgICAgICBzaG93TW9kYWw6IGZ1bmN0aW9uKGV2dCkgewogICAgICAgICAgdGhpcy5yZW5kZXIoZXZ0Lm1vZGFsTmFtZSwgewogICAgICAgICAgICBvdXRsZXQ6ICdtb2RhbCcsCiAgICAgICAgICAgIGludG86ICdhcHBsaWNhdGlvbicKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgaGlkZU1vZGFsOiBmdW5jdGlvbihldnQpIHsKICAgICAgICAgIHRoaXMuZGlzY29ubmVjdE91dGxldCh7CiAgICAgICAgICAgIG91dGxldDogJ21vZGFsJywKICAgICAgICAgICAgcGFyZW50VmlldzogJ2FwcGxpY2F0aW9uJwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIGBgYAoKICAgIEBtZXRob2QgZGlzY29ubmVjdE91dGxldAogICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgdGhlIG9wdGlvbnMKICAqLwogIGRpc2Nvbm5lY3RPdXRsZXQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgb3B0aW9ucy5wYXJlbnRWaWV3ID0gb3B0aW9ucy5wYXJlbnRWaWV3ID8gb3B0aW9ucy5wYXJlbnRWaWV3LnJlcGxhY2UoL1wvL2csICcuJykgOiBwYXJlbnRUZW1wbGF0ZSh0aGlzKTsKICAgIG9wdGlvbnMub3V0bGV0ID0gb3B0aW9ucy5vdXRsZXQgfHwgJ21haW4nOwoKICAgIHZhciBwYXJlbnRWaWV3ID0gdGhpcy5yb3V0ZXIuX2xvb2t1cEFjdGl2ZVZpZXcob3B0aW9ucy5wYXJlbnRWaWV3KTsKICAgIHBhcmVudFZpZXcuZGlzY29ubmVjdE91dGxldChvcHRpb25zLm91dGxldCk7CiAgfSwKCiAgd2lsbERlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgdGhpcy50ZWFyZG93blZpZXdzKCk7CiAgfSwKCiAgLyoqCiAgICBAcHJpdmF0ZQoKICAgIEBtZXRob2QgdGVhcmRvd25WaWV3cwogICovCiAgdGVhcmRvd25WaWV3czogZnVuY3Rpb24oKSB7CiAgICAvLyBUZWFyIGRvd24gdGhlIHRvcCBsZXZlbCB2aWV3CiAgICBpZiAodGhpcy50ZWFyZG93blRvcExldmVsVmlldykgeyB0aGlzLnRlYXJkb3duVG9wTGV2ZWxWaWV3KCk7IH0KCiAgICAvLyBUZWFyIGRvd24gYW55IG91dGxldHMgcmVuZGVyZWQgd2l0aCAnaW50bycKICAgIHZhciB0ZWFyZG93bk91dGxldFZpZXdzID0gdGhpcy50ZWFyZG93bk91dGxldFZpZXdzIHx8IFtdOwogICAgYV9mb3JFYWNoKHRlYXJkb3duT3V0bGV0Vmlld3MsIGZ1bmN0aW9uKHRlYXJkb3duT3V0bGV0VmlldykgewogICAgICB0ZWFyZG93bk91dGxldFZpZXcoKTsKICAgIH0pOwoKICAgIGRlbGV0ZSB0aGlzLnRlYXJkb3duVG9wTGV2ZWxWaWV3OwogICAgZGVsZXRlIHRoaXMudGVhcmRvd25PdXRsZXRWaWV3czsKICAgIGRlbGV0ZSB0aGlzLmxhc3RSZW5kZXJlZFRlbXBsYXRlOwogIH0KfSk7CgpmdW5jdGlvbiBwYXJlbnRSb3V0ZShyb3V0ZSkgewogIHZhciBoYW5kbGVySW5mb3MgPSByb3V0ZS5yb3V0ZXIucm91dGVyLnRhcmdldEhhbmRsZXJJbmZvczsKCiAgaWYgKCFoYW5kbGVySW5mb3MpIHsgcmV0dXJuOyB9CgogIHZhciBwYXJlbnQsIGN1cnJlbnQ7CgogIGZvciAodmFyIGk9MCwgbD1oYW5kbGVySW5mb3MubGVuZ3RoOyBpPGw7IGkrKykgewogICAgY3VycmVudCA9IGhhbmRsZXJJbmZvc1tpXS5oYW5kbGVyOwogICAgaWYgKGN1cnJlbnQgPT09IHJvdXRlKSB7IHJldHVybiBwYXJlbnQ7IH0KICAgIHBhcmVudCA9IGN1cnJlbnQ7CiAgfQp9CgpmdW5jdGlvbiBwYXJlbnRUZW1wbGF0ZShyb3V0ZSkgewogIHZhciBwYXJlbnQgPSBwYXJlbnRSb3V0ZShyb3V0ZSksIHRlbXBsYXRlOwoKICBpZiAoIXBhcmVudCkgeyByZXR1cm47IH0KCiAgaWYgKHRlbXBsYXRlID0gcGFyZW50Lmxhc3RSZW5kZXJlZFRlbXBsYXRlKSB7CiAgICByZXR1cm4gdGVtcGxhdGU7CiAgfSBlbHNlIHsKICAgIHJldHVybiBwYXJlbnRUZW1wbGF0ZShwYXJlbnQpOwogIH0KfQoKZnVuY3Rpb24gbm9ybWFsaXplT3B0aW9ucyhyb3V0ZSwgbmFtZSwgdGVtcGxhdGUsIG9wdGlvbnMpIHsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICBvcHRpb25zLmludG8gPSBvcHRpb25zLmludG8gPyBvcHRpb25zLmludG8ucmVwbGFjZSgvXC8vZywgJy4nKSA6IHBhcmVudFRlbXBsYXRlKHJvdXRlKTsKICBvcHRpb25zLm91dGxldCA9IG9wdGlvbnMub3V0bGV0IHx8ICdtYWluJzsKICBvcHRpb25zLm5hbWUgPSBuYW1lOwogIG9wdGlvbnMudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKICBvcHRpb25zLkxPR19WSUVXX0xPT0tVUFMgPSBnZXQocm91dGUucm91dGVyLCAnbmFtZXNwYWNlLkxPR19WSUVXX0xPT0tVUFMnKTsKCiAgRW1iZXIuYXNzZXJ0KCJBbiBvdXRsZXQgKCIrb3B0aW9ucy5vdXRsZXQrIikgd2FzIHNwZWNpZmllZCBidXQgd2FzIG5vdCBmb3VuZC4iLCBvcHRpb25zLm91dGxldCA9PT0gJ21haW4nIHx8IG9wdGlvbnMuaW50byk7CgogIHZhciBjb250cm9sbGVyID0gb3B0aW9ucy5jb250cm9sbGVyLCBuYW1lZENvbnRyb2xsZXI7CgogIGlmIChvcHRpb25zLmNvbnRyb2xsZXIpIHsKICAgIGNvbnRyb2xsZXIgPSBvcHRpb25zLmNvbnRyb2xsZXI7CiAgfSBlbHNlIGlmIChuYW1lZENvbnRyb2xsZXIgPSByb3V0ZS5jb250YWluZXIubG9va3VwKCdjb250cm9sbGVyOicgKyBuYW1lKSkgewogICAgY29udHJvbGxlciA9IG5hbWVkQ29udHJvbGxlcjsKICB9IGVsc2UgewogICAgY29udHJvbGxlciA9IHJvdXRlLmNvbnRyb2xsZXJOYW1lIHx8IHJvdXRlLnJvdXRlTmFtZTsKICB9CgogIGlmICh0eXBlb2YgY29udHJvbGxlciA9PT0gJ3N0cmluZycpIHsKICAgIGNvbnRyb2xsZXIgPSByb3V0ZS5jb250YWluZXIubG9va3VwKCdjb250cm9sbGVyOicgKyBjb250cm9sbGVyKTsKICB9CgogIG9wdGlvbnMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7CgogIHJldHVybiBvcHRpb25zOwp9CgpmdW5jdGlvbiBzZXR1cFZpZXcodmlldywgY29udGFpbmVyLCBvcHRpb25zKSB7CiAgaWYgKHZpZXcpIHsKICAgIGlmIChvcHRpb25zLkxPR19WSUVXX0xPT0tVUFMpIHsKICAgICAgRW1iZXIuTG9nZ2VyLmluZm8oIlJlbmRlcmluZyAiICsgb3B0aW9ucy5uYW1lICsgIiB3aXRoICIgKyB2aWV3LCB7IGZ1bGxOYW1lOiAndmlldzonICsgb3B0aW9ucy5uYW1lIH0pOwogICAgfQogIH0gZWxzZSB7CiAgICB2YXIgZGVmYXVsdFZpZXcgPSBvcHRpb25zLmludG8gPyAndmlldzpkZWZhdWx0JyA6ICd2aWV3OnRvcGxldmVsJzsKICAgIHZpZXcgPSBjb250YWluZXIubG9va3VwKGRlZmF1bHRWaWV3KTsKICAgIGlmIChvcHRpb25zLkxPR19WSUVXX0xPT0tVUFMpIHsKICAgICAgRW1iZXIuTG9nZ2VyLmluZm8oIlJlbmRlcmluZyAiICsgb3B0aW9ucy5uYW1lICsgIiB3aXRoIGRlZmF1bHQgdmlldyAiICsgdmlldywgeyBmdWxsTmFtZTogJ3ZpZXc6JyArIG9wdGlvbnMubmFtZSB9KTsKICAgIH0KICB9CgogIGlmICghZ2V0KHZpZXcsICd0ZW1wbGF0ZU5hbWUnKSkgewogICAgc2V0KHZpZXcsICd0ZW1wbGF0ZScsIG9wdGlvbnMudGVtcGxhdGUpOwoKICAgIHNldCh2aWV3LCAnX2RlYnVnVGVtcGxhdGVOYW1lJywgb3B0aW9ucy5uYW1lKTsKICB9CgogIHNldCh2aWV3LCAncmVuZGVyZWROYW1lJywgb3B0aW9ucy5uYW1lKTsKICBzZXQodmlldywgJ2NvbnRyb2xsZXInLCBvcHRpb25zLmNvbnRyb2xsZXIpOwoKICByZXR1cm4gdmlldzsKfQoKZnVuY3Rpb24gYXBwZW5kVmlldyhyb3V0ZSwgdmlldywgb3B0aW9ucykgewogIGlmIChvcHRpb25zLmludG8pIHsKICAgIHZhciBwYXJlbnRWaWV3ID0gcm91dGUucm91dGVyLl9sb29rdXBBY3RpdmVWaWV3KG9wdGlvbnMuaW50byk7CiAgICB2YXIgdGVhcmRvd25PdXRsZXRWaWV3ID0gZ2VuZXJhdGVPdXRsZXRUZWFyZG93bihwYXJlbnRWaWV3LCBvcHRpb25zLm91dGxldCk7CiAgICBpZiAoIXJvdXRlLnRlYXJkb3duT3V0bGV0Vmlld3MpIHsgcm91dGUudGVhcmRvd25PdXRsZXRWaWV3cyA9IFtdOyB9CiAgICBhX3JlcGxhY2Uocm91dGUudGVhcmRvd25PdXRsZXRWaWV3cywgMCwgMCwgW3RlYXJkb3duT3V0bGV0Vmlld10pOwogICAgcGFyZW50Vmlldy5jb25uZWN0T3V0bGV0KG9wdGlvbnMub3V0bGV0LCB2aWV3KTsKICB9IGVsc2UgewogICAgdmFyIHJvb3RFbGVtZW50ID0gZ2V0KHJvdXRlLCAncm91dGVyLm5hbWVzcGFjZS5yb290RWxlbWVudCcpOwogICAgLy8gdGVhciBkb3duIHZpZXcgaWYgb25lIGlzIGFscmVhZHkgcmVuZGVyZWQKICAgIGlmIChyb3V0ZS50ZWFyZG93blRvcExldmVsVmlldykgewogICAgICByb3V0ZS50ZWFyZG93blRvcExldmVsVmlldygpOwogICAgfQogICAgcm91dGUucm91dGVyLl9jb25uZWN0QWN0aXZlVmlldyhvcHRpb25zLm5hbWUsIHZpZXcpOwogICAgcm91dGUudGVhcmRvd25Ub3BMZXZlbFZpZXcgPSBnZW5lcmF0ZVRvcExldmVsVGVhcmRvd24odmlldyk7CiAgICB2aWV3LmFwcGVuZFRvKHJvb3RFbGVtZW50KTsKICB9Cn0KCmZ1bmN0aW9uIGdlbmVyYXRlVG9wTGV2ZWxUZWFyZG93bih2aWV3KSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgeyB2aWV3LmRlc3Ryb3koKTsgfTsKfQoKZnVuY3Rpb24gZ2VuZXJhdGVPdXRsZXRUZWFyZG93bihwYXJlbnRWaWV3LCBvdXRsZXQpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7IHBhcmVudFZpZXcuZGlzY29ubmVjdE91dGxldChvdXRsZXQpOyB9Owp9Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7CkVtYmVyLm9uTG9hZCgnRW1iZXIuSGFuZGxlYmFycycsIGZ1bmN0aW9uKCkgewogIHZhciBoYW5kbGViYXJzUmVzb2x2ZSA9IEVtYmVyLkhhbmRsZWJhcnMucmVzb2x2ZVBhcmFtcywKICAgICAgbWFwID0gRW1iZXIuQXJyYXlQb2x5ZmlsbHMubWFwLAogICAgICBnZXQgPSBFbWJlci5nZXQsCiAgICAgIGhhbmRsZWJhcnNHZXQgPSBFbWJlci5IYW5kbGViYXJzLmdldDsKCiAgZnVuY3Rpb24gcmVzb2x2ZVBhcmFtcyhjb250ZXh0LCBwYXJhbXMsIG9wdGlvbnMpIHsKICAgIHJldHVybiBtYXAuY2FsbChyZXNvbHZlUGF0aHMoY29udGV4dCwgcGFyYW1zLCBvcHRpb25zKSwgZnVuY3Rpb24ocGF0aCwgaSkgewogICAgICBpZiAobnVsbCA9PT0gcGF0aCkgewogICAgICAgIC8vIFBhcmFtIHdhcyBzdHJpbmcvbnVtYmVyLCBub3QgYSBwYXRoLCBzbyBqdXN0IHJldHVybiByYXcgc3RyaW5nL251bWJlci4KICAgICAgICByZXR1cm4gcGFyYW1zW2ldOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBoYW5kbGViYXJzR2V0KGNvbnRleHQsIHBhdGgsIG9wdGlvbnMpOwogICAgICB9CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIHJlc29sdmVQYXRocyhjb250ZXh0LCBwYXJhbXMsIG9wdGlvbnMpIHsKICAgIHZhciByZXNvbHZlZCA9IGhhbmRsZWJhcnNSZXNvbHZlKGNvbnRleHQsIHBhcmFtcywgb3B0aW9ucyksCiAgICAgICAgdHlwZXMgPSBvcHRpb25zLnR5cGVzOwoKICAgIHJldHVybiBtYXAuY2FsbChyZXNvbHZlZCwgZnVuY3Rpb24ob2JqZWN0LCBpKSB7CiAgICAgIGlmICh0eXBlc1tpXSA9PT0gJ0lEJykgewogICAgICAgIHJldHVybiB1bndyYXAob2JqZWN0LCBwYXJhbXNbaV0pOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICB9KTsKCiAgICBmdW5jdGlvbiB1bndyYXAob2JqZWN0LCBwYXRoKSB7CiAgICAgIGlmIChwYXRoID09PSAnY29udHJvbGxlcicpIHsgcmV0dXJuIHBhdGg7IH0KCiAgICAgIGlmIChFbWJlci5Db250cm9sbGVyTWl4aW4uZGV0ZWN0KG9iamVjdCkpIHsKICAgICAgICByZXR1cm4gdW53cmFwKGdldChvYmplY3QsICdtb2RlbCcpLCBwYXRoID8gcGF0aCArICcubW9kZWwnIDogJ21vZGVsJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHBhdGg7CiAgICAgIH0KICAgIH0KICB9CgogIEVtYmVyLlJvdXRlci5yZXNvbHZlUGFyYW1zID0gcmVzb2x2ZVBhcmFtczsKICBFbWJlci5Sb3V0ZXIucmVzb2x2ZVBhdGhzID0gcmVzb2x2ZVBhdGhzOwp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1yb3V0aW5nCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQsIGZtdCA9IEVtYmVyLlN0cmluZy5mbXQ7CkVtYmVyLm9uTG9hZCgnRW1iZXIuSGFuZGxlYmFycycsIGZ1bmN0aW9uKEhhbmRsZWJhcnMpIHsKCiAgdmFyIHJlc29sdmVQYXJhbXMgPSBFbWJlci5Sb3V0ZXIucmVzb2x2ZVBhcmFtcywKICAgICAgcmVzb2x2ZVBhdGhzICA9IEVtYmVyLlJvdXRlci5yZXNvbHZlUGF0aHMsCiAgICAgIGlzU2ltcGxlQ2xpY2sgPSBFbWJlci5WaWV3VXRpbHMuaXNTaW1wbGVDbGljazsKCiAgZnVuY3Rpb24gZnVsbFJvdXRlTmFtZShyb3V0ZXIsIG5hbWUpIHsKICAgIHZhciBuYW1lV2l0aEluZGV4OwogICAgaWYgKCFyb3V0ZXIuaGFzUm91dGUobmFtZSkpIHsKICAgICAgbmFtZVdpdGhJbmRleCA9IG5hbWUgKyAnLmluZGV4JzsKICAgICAgRW1iZXIuYXNzZXJ0KGZtdCgiVGhlIGF0dGVtcHQgdG8gbGluay10byByb3V0ZSAnJUAnIGZhaWxlZCAoYWxzbyB0cmllZCAnJUAnKS4gIiArCiAgICAgICAgICAgICAgICAgICAgICAgIlRoZSByb3V0ZXIgZGlkIG5vdCBmaW5kICclQCcgaW4gaXRzIHBvc3NpYmxlIHJvdXRlczogJyVAJyIsCiAgICAgICAgICAgICAgICAgICAgICAgW25hbWUsIG5hbWVXaXRoSW5kZXgsIG5hbWUsIEVtYmVyLmtleXMocm91dGVyLnJvdXRlci5yZWNvZ25pemVyLm5hbWVzKS5qb2luKCInLCAnIildKSwKICAgICAgICAgICAgICAgICAgICAgICByb3V0ZXIuaGFzUm91dGUobmFtZVdpdGhJbmRleCkpOwogICAgICBuYW1lID0gbmFtZVdpdGhJbmRleDsKICAgIH0KCiAgICByZXR1cm4gbmFtZTsKICB9CgogIGZ1bmN0aW9uIGdldFJlc29sdmVkUGF0aHMob3B0aW9ucykgewoKICAgIHZhciB0eXBlcyA9IG9wdGlvbnMub3B0aW9ucy50eXBlcywKICAgICAgICBkYXRhID0gb3B0aW9ucy5vcHRpb25zLmRhdGE7CgogICAgcmV0dXJuIHJlc29sdmVQYXRocyhvcHRpb25zLmNvbnRleHQsIG9wdGlvbnMucGFyYW1zLCB7IHR5cGVzOiB0eXBlcywgZGF0YTogZGF0YSB9KTsKICB9CgogIC8qKgogICAgYEVtYmVyLkxpbmtWaWV3YCByZW5kZXJzIGFuIGVsZW1lbnQgd2hvc2UgYGNsaWNrYCBldmVudCB0cmlnZ2VycyBhCiAgICB0cmFuc2l0aW9uIG9mIHRoZSBhcHBsaWNhdGlvbidzIGluc3RhbmNlIG9mIGBFbWJlci5Sb3V0ZXJgIHRvCiAgICBhIHN1cHBsaWVkIHJvdXRlIGJ5IG5hbWUuCgogICAgSW5zdGFuY2VzIG9mIGBMaW5rVmlld2Agd2lsbCBtb3N0IGxpa2VseSBiZSBjcmVhdGVkIHRocm91Z2gKICAgIHRoZSBgbGluay10b2AgSGFuZGxlYmFycyBoZWxwZXIsIGJ1dCBwcm9wZXJ0aWVzIG9mIHRoaXMgY2xhc3MKICAgIGNhbiBiZSBvdmVycmlkZGVuIHRvIGN1c3RvbWl6ZSBhcHBsaWNhdGlvbi13aWRlIGJlaGF2aW9yLgoKICAgIEBjbGFzcyBMaW5rVmlldwogICAgQG5hbWVzcGFjZSBFbWJlcgogICAgQGV4dGVuZHMgRW1iZXIuVmlldwogICAgQHNlZSB7SGFuZGxlYmFycy5oZWxwZXJzLmxpbmstdG99CiAgKiovCiAgdmFyIExpbmtWaWV3ID0gRW1iZXIuTGlua1ZpZXcgPSBFbWJlci5WaWV3LmV4dGVuZCh7CiAgICB0YWdOYW1lOiAnYScsCiAgICBjdXJyZW50V2hlbjogbnVsbCwKCiAgICAvKioKICAgICAgU2V0cyB0aGUgYHRpdGxlYCBhdHRyaWJ1dGUgb2YgdGhlIGBMaW5rVmlld2AncyBIVE1MIGVsZW1lbnQuCgogICAgICBAcHJvcGVydHkgdGl0bGUKICAgICAgQGRlZmF1bHQgbnVsbAogICAgKiovCiAgICB0aXRsZTogbnVsbCwKCiAgICAvKioKICAgICAgU2V0cyB0aGUgYHJlbGAgYXR0cmlidXRlIG9mIHRoZSBgTGlua1ZpZXdgJ3MgSFRNTCBlbGVtZW50LgoKICAgICAgQHByb3BlcnR5IHJlbAogICAgICBAZGVmYXVsdCBudWxsCiAgICAqKi8KICAgIHJlbDogbnVsbCwKCiAgICAvKioKICAgICAgVGhlIENTUyBjbGFzcyB0byBhcHBseSB0byBgTGlua1ZpZXdgJ3MgZWxlbWVudCB3aGVuIGl0cyBgYWN0aXZlYAogICAgICBwcm9wZXJ0eSBpcyBgdHJ1ZWAuCgogICAgICBAcHJvcGVydHkgYWN0aXZlQ2xhc3MKICAgICAgQHR5cGUgU3RyaW5nCiAgICAgIEBkZWZhdWx0IGFjdGl2ZQogICAgKiovCiAgICBhY3RpdmVDbGFzczogJ2FjdGl2ZScsCgogICAgLyoqCiAgICAgIFRoZSBDU1MgY2xhc3MgdG8gYXBwbHkgdG8gYExpbmtWaWV3YCdzIGVsZW1lbnQgd2hlbiBpdHMgYGxvYWRpbmdgCiAgICAgIHByb3BlcnR5IGlzIGB0cnVlYC4KCiAgICAgIEBwcm9wZXJ0eSBsb2FkaW5nQ2xhc3MKICAgICAgQHR5cGUgU3RyaW5nCiAgICAgIEBkZWZhdWx0IGxvYWRpbmcKICAgICoqLwogICAgbG9hZGluZ0NsYXNzOiAnbG9hZGluZycsCgogICAgLyoqCiAgICAgIFRoZSBDU1MgY2xhc3MgdG8gYXBwbHkgdG8gYSBgTGlua1ZpZXdgJ3MgZWxlbWVudCB3aGVuIGl0cyBgZGlzYWJsZWRgCiAgICAgIHByb3BlcnR5IGlzIGB0cnVlYC4KCiAgICAgIEBwcm9wZXJ0eSBkaXNhYmxlZENsYXNzCiAgICAgIEB0eXBlIFN0cmluZwogICAgICBAZGVmYXVsdCBkaXNhYmxlZAogICAgKiovCiAgICBkaXNhYmxlZENsYXNzOiAnZGlzYWJsZWQnLAogICAgX2lzRGlzYWJsZWQ6IGZhbHNlLAoKICAgIC8qKgogICAgICBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIGBMaW5rVmlld2Agd2lsbCB0cmlnZ2VyIHJvdXRpbmcgdmlhCiAgICAgIHRoZSBgcmVwbGFjZVdpdGhgIHJvdXRpbmcgc3RyYXRlZ3kuCgogICAgICBAcHJvcGVydHkgcmVwbGFjZQogICAgICBAdHlwZSBCb29sZWFuCiAgICAgIEBkZWZhdWx0IGZhbHNlCiAgICAqKi8KICAgIHJlcGxhY2U6IGZhbHNlLAoKICAgIC8qKgogICAgICBCeSBkZWZhdWx0IHRoZSBge3tsaW5rLXRvfX1gIGhlbHBlciB3aWxsIGJpbmQgdG8gdGhlIGBocmVmYCBhbmQKICAgICAgYHRpdGxlYCBhdHRyaWJ1dGVzLiBJdCdzIGRpc2NvdXJhZ2UgdGhhdCB5b3Ugb3ZlcnJpZGUgdGhlc2UgZGVmYXVsdHMsCiAgICAgIGhvd2V2ZXIgeW91IGNhbiBwdXNoIG9udG8gdGhlIGFycmF5IGlmIG5lZWRlZC4KCiAgICAgIEBwcm9wZXJ0eSBhdHRyaWJ1dGVCaW5kaW5ncwogICAgICBAdHlwZSBBcnJheSB8IFN0cmluZwogICAgICBAZGVmYXVsdCBbJ2hyZWYnLCAndGl0bGUnLCAncmVsJ10KICAgICAqKi8KICAgIGF0dHJpYnV0ZUJpbmRpbmdzOiBbJ2hyZWYnLCAndGl0bGUnLCAncmVsJ10sCgogICAgLyoqCiAgICAgIEJ5IGRlZmF1bHQgdGhlIGB7e2xpbmstdG99fWAgaGVscGVyIHdpbGwgYmluZCB0byB0aGUgYGFjdGl2ZWAsIGBsb2FkaW5nYCwgYW5kCiAgICAgIGBkaXNhYmxlZGAgY2xhc3Nlcy4gSXQgaXMgZGlzY291cmFnZWQgdG8gb3ZlcnJpZGUgdGhlc2UgZGlyZWN0bHkuCgogICAgICBAcHJvcGVydHkgY2xhc3NOYW1lQmluZGluZ3MKICAgICAgQHR5cGUgQXJyYXkKICAgICAgQGRlZmF1bHQgWydhY3RpdmUnLCAnbG9hZGluZycsICdkaXNhYmxlZCddCiAgICAgKiovCiAgICBjbGFzc05hbWVCaW5kaW5nczogWydhY3RpdmUnLCAnbG9hZGluZycsICdkaXNhYmxlZCddLAoKICAgIC8qKgogICAgICBCeSBkZWZhdWx0IHRoZSBge3tsaW5rLXRvfX1gIGhlbHBlciByZXNwb25kcyB0byB0aGUgYGNsaWNrYCBldmVudC4gWW91CiAgICAgIGNhbiBvdmVycmlkZSB0aGlzIGdsb2JhbGx5IGJ5IHNldHRpbmcgdGhpcyBwcm9wZXJ0eSB0byB5b3VyIGN1c3RvbQogICAgICBldmVudCBuYW1lLgoKICAgICAgVGhpcyBpcyBwYXJ0aWN1bGFybHkgdXNlZnVsIG9uIG1vYmlsZSB3aGVuIG9uZSB3YW50cyB0byBhdm9pZCB0aGUgMzAwbXMKICAgICAgY2xpY2sgZGVsYXkgdXNpbmcgc29tZSBzb3J0IG9mIGN1c3RvbSBgdGFwYCBldmVudC4KCiAgICAgIEBwcm9wZXJ0eSBldmVudE5hbWUKICAgICAgQHR5cGUgU3RyaW5nCiAgICAgIEBkZWZhdWx0IGNsaWNrCiAgICAqLwogICAgZXZlbnROYW1lOiAnY2xpY2snLAoKICAgIC8vIHRoaXMgaXMgZG9jJ2VkIGhlcmUgc28gaXQgc2hvd3MgdXAgaW4gdGhlIGV2ZW50cwogICAgLy8gc2VjdGlvbiBvZiB0aGUgQVBJIGRvY3VtZW50YXRpb24sIHdoaWNoIGlzIHdoZXJlCiAgICAvLyBwZW9wbGUgd2lsbCBsaWtlbHkgZ28gbG9va2luZyBmb3IgaXQuCiAgICAvKioKICAgICAgVHJpZ2dlcnMgdGhlIGBMaW5rVmlld2AncyByb3V0aW5nIGJlaGF2aW9yLiBJZgogICAgICBgZXZlbnROYW1lYCBpcyBjaGFuZ2VkIHRvIGEgdmFsdWUgb3RoZXIgdGhhbiBgY2xpY2tgCiAgICAgIHRoZSByb3V0aW5nIGJlaGF2aW9yIHdpbGwgdHJpZ2dlciBvbiB0aGF0IGN1c3RvbSBldmVudAogICAgICBpbnN0ZWFkLgoKICAgICAgQGV2ZW50IGNsaWNrCiAgICAqKi8KCiAgICAvKioKICAgICAgQW4gb3ZlcnJpZGFibGUgbWV0aG9kIGNhbGxlZCB3aGVuIExpbmtWaWV3IG9iamVjdHMgYXJlIGluc3RhbnRpYXRlZC4KCiAgICAgIEV4YW1wbGU6CgogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIEFwcC5NeUxpbmtWaWV3ID0gRW1iZXIuTGlua1ZpZXcuZXh0ZW5kKHsKICAgICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICAgIHRoaXMuX3N1cGVyKCk7CiAgICAgICAgICBFbWJlci5Mb2dnZXIubG9nKCdFdmVudCBpcyAnICsgdGhpcy5nZXQoJ2V2ZW50TmFtZScpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKCiAgICAgIE5PVEU6IElmIHlvdSBkbyBvdmVycmlkZSBgaW5pdGAgZm9yIGEgZnJhbWV3b3JrIGNsYXNzIGxpa2UgYEVtYmVyLlZpZXdgIG9yCiAgICAgIGBFbWJlci5BcnJheUNvbnRyb2xsZXJgLCBiZSBzdXJlIHRvIGNhbGwgYHRoaXMuX3N1cGVyKClgIGluIHlvdXIKICAgICAgYGluaXRgIGRlY2xhcmF0aW9uISBJZiB5b3UgZG9uJ3QsIEVtYmVyIG1heSBub3QgaGF2ZSBhbiBvcHBvcnR1bml0eSB0bwogICAgICBkbyBpbXBvcnRhbnQgc2V0dXAgd29yaywgYW5kIHlvdSdsbCBzZWUgc3RyYW5nZSBiZWhhdmlvciBpbiB5b3VyCiAgICAgIGFwcGxpY2F0aW9uLgoKICAgICAgQG1ldGhvZCBpbml0CiAgICAqLwogICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAvLyBNYXAgZGVzaXJlZCBldmVudCBuYW1lIHRvIGludm9rZSBmdW5jdGlvbgogICAgICB2YXIgZXZlbnROYW1lID0gZ2V0KHRoaXMsICdldmVudE5hbWUnKSwgaTsKICAgICAgdGhpcy5vbihldmVudE5hbWUsIHRoaXMsIHRoaXMuX2ludm9rZSk7CgogICAgICAgICAgfSwKCiAgICAvKioKICAgICAgVGhpcyBtZXRob2QgaXMgaW52b2tlZCBieSBvYnNlcnZlcnMgaW5zdGFsbGVkIGR1cmluZyBgaW5pdGAgdGhhdCBmaXJlCiAgICAgIHdoZW5ldmVyIHRoZSBwYXJhbXMgY2hhbmdlCgogICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIF9wYXJhbXNDaGFuZ2VkCiAgICAgKi8KICAgIF9wYXJhbXNDaGFuZ2VkOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5ub3RpZnlQcm9wZXJ0eUNoYW5nZSgncmVzb2x2ZWRQYXJhbXMnKTsKICAgIH0sCgogICAgLyoqCiAgICAgVGhpcyBpcyBjYWxsZWQgdG8gc2V0dXAgb2JzZXJ2ZXJzIHRoYXQgd2lsbCB0cmlnZ2VyIGEgcmVyZW5kZXIuCgogICAgIEBwcml2YXRlCiAgICAgQG1ldGhvZCBfc2V0dXBQYXRoT2JzZXJ2ZXJzCiAgICAqKi8KICAgIF9zZXR1cFBhdGhPYnNlcnZlcnM6IGZ1bmN0aW9uKCl7CiAgICAgIHZhciBoZWxwZXJQYXJhbWV0ZXJzID0gdGhpcy5wYXJhbWV0ZXJzLAogICAgICAgICAgbGlua1RleHRQYXRoICAgICA9IGhlbHBlclBhcmFtZXRlcnMub3B0aW9ucy5saW5rVGV4dFBhdGgsCiAgICAgICAgICBwYXRocyA9IGdldFJlc29sdmVkUGF0aHMoaGVscGVyUGFyYW1ldGVycyksCiAgICAgICAgICBsZW5ndGggPSBwYXRocy5sZW5ndGgsCiAgICAgICAgICBwYXRoLCBpLCBub3JtYWxpemVkUGF0aDsKCiAgICAgIGlmIChsaW5rVGV4dFBhdGgpIHsKICAgICAgICBub3JtYWxpemVkUGF0aCA9IEVtYmVyLkhhbmRsZWJhcnMubm9ybWFsaXplUGF0aChoZWxwZXJQYXJhbWV0ZXJzLmNvbnRleHQsIGxpbmtUZXh0UGF0aCwgaGVscGVyUGFyYW1ldGVycy5vcHRpb25zLmRhdGEpOwogICAgICAgIHRoaXMucmVnaXN0ZXJPYnNlcnZlcihub3JtYWxpemVkUGF0aC5yb290LCBub3JtYWxpemVkUGF0aC5wYXRoLCB0aGlzLCB0aGlzLnJlcmVuZGVyKTsKICAgICAgfQoKICAgICAgZm9yKGk9MDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgcGF0aCA9IHBhdGhzW2ldOwogICAgICAgIGlmIChudWxsID09PSBwYXRoKSB7CiAgICAgICAgICAvLyBBIGxpdGVyYWwgdmFsdWUgd2FzIHByb3ZpZGVkLCBub3QgYSBwYXRoLCBzbyBub3RoaW5nIHRvIG9ic2VydmUuCiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIG5vcm1hbGl6ZWRQYXRoID0gRW1iZXIuSGFuZGxlYmFycy5ub3JtYWxpemVQYXRoKGhlbHBlclBhcmFtZXRlcnMuY29udGV4dCwgcGF0aCwgaGVscGVyUGFyYW1ldGVycy5vcHRpb25zLmRhdGEpOwogICAgICAgIHRoaXMucmVnaXN0ZXJPYnNlcnZlcihub3JtYWxpemVkUGF0aC5yb290LCBub3JtYWxpemVkUGF0aC5wYXRoLCB0aGlzLCB0aGlzLl9wYXJhbXNDaGFuZ2VkKTsKICAgICAgfQogICAgfSwKCiAgICBhZnRlclJlbmRlcjogZnVuY3Rpb24oKXsKICAgICAgdGhpcy5fc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgdGhpcy5fc2V0dXBQYXRoT2JzZXJ2ZXJzKCk7CiAgICB9LAoKICAgIC8qKgogICAgICBUaGlzIG1ldGhvZCBpcyBpbnZva2VkIGJ5IG9ic2VydmVycyBpbnN0YWxsZWQgZHVyaW5nIGBpbml0YCB0aGF0IGZpcmUKICAgICAgd2hlbmV2ZXIgdGhlIHF1ZXJ5IHBhcmFtcyBjaGFuZ2UKICAgICAgQHByaXZhdGUKICAgICAqLwogICAgX3F1ZXJ5UGFyYW1zQ2hhbmdlZDogZnVuY3Rpb24gKG9iamVjdCwgcGF0aCkgewogICAgICB0aGlzLm5vdGlmeVByb3BlcnR5Q2hhbmdlKCdxdWVyeVBhcmFtcycpOwogICAgfSwKCgogICAgLyoqCiAgICAgIEV2ZW4gdGhvdWdoIHRoaXMgaXNuJ3QgYSB2aXJ0dWFsIHZpZXcsIHdlIHdhbnQgdG8gdHJlYXQgaXQgYXMgaWYgaXQgaXMKICAgICAgc28gdGhhdCB5b3UgY2FuIGFjY2VzcyB0aGUgcGFyZW50IHdpdGgge3t2aWV3LnByb3B9fQoKICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBjb25jcmV0ZVZpZXcKICAgICoqLwogICAgY29uY3JldGVWaWV3OiBFbWJlci5jb21wdXRlZChmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGdldCh0aGlzLCAncGFyZW50VmlldycpOwogICAgfSkucHJvcGVydHkoJ3BhcmVudFZpZXcnKSwKCiAgICAvKioKCiAgICAgIEFjY2Vzc2VkIGFzIGEgY2xhc3NuYW1lIGJpbmRpbmcgdG8gYXBwbHkgdGhlIGBMaW5rVmlld2AncyBgZGlzYWJsZWRDbGFzc2AKICAgICAgQ1NTIGBjbGFzc2AgdG8gdGhlIGVsZW1lbnQgd2hlbiB0aGUgbGluayBpcyBkaXNhYmxlZC4KCiAgICAgIFdoZW4gYHRydWVgIGludGVyYWN0aW9ucyB3aXRoIHRoZSBlbGVtZW50IHdpbGwgbm90IHRyaWdnZXIgcm91dGUgY2hhbmdlcy4KICAgICAgQHByb3BlcnR5IGRpc2FibGVkCiAgICAqLwogICAgZGlzYWJsZWQ6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uIGNvbXB1dGVMaW5rVmlld0Rpc2FibGVkKGtleSwgdmFsdWUpIHsKICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsgdGhpcy5zZXQoJ19pc0Rpc2FibGVkJywgdmFsdWUpOyB9CgogICAgICByZXR1cm4gdmFsdWUgPyBnZXQodGhpcywgJ2Rpc2FibGVkQ2xhc3MnKSA6IGZhbHNlOwogICAgfSksCgogICAgLyoqCiAgICAgIEFjY2Vzc2VkIGFzIGEgY2xhc3NuYW1lIGJpbmRpbmcgdG8gYXBwbHkgdGhlIGBMaW5rVmlld2AncyBgYWN0aXZlQ2xhc3NgCiAgICAgIENTUyBgY2xhc3NgIHRvIHRoZSBlbGVtZW50IHdoZW4gdGhlIGxpbmsgaXMgYWN0aXZlLgoKICAgICAgQSBgTGlua1ZpZXdgIGlzIGNvbnNpZGVyZWQgYWN0aXZlIHdoZW4gaXRzIGBjdXJyZW50V2hlbmAgcHJvcGVydHkgaXMgYHRydWVgCiAgICAgIG9yIHRoZSBhcHBsaWNhdGlvbidzIGN1cnJlbnQgcm91dGUgaXMgdGhlIHJvdXRlIHRoZSBgTGlua1ZpZXdgIHdvdWxkIHRyaWdnZXIKICAgICAgdHJhbnNpdGlvbnMgaW50by4KCiAgICAgIEBwcm9wZXJ0eSBhY3RpdmUKICAgICoqLwogICAgYWN0aXZlOiBFbWJlci5jb21wdXRlZChmdW5jdGlvbiBjb21wdXRlTGlua1ZpZXdBY3RpdmUoKSB7CiAgICAgIGlmIChnZXQodGhpcywgJ2xvYWRpbmcnKSkgeyByZXR1cm4gZmFsc2U7IH0KCiAgICAgIHZhciByb3V0ZXIgPSBnZXQodGhpcywgJ3JvdXRlcicpLAogICAgICAgICAgcm91dGVBcmdzID0gZ2V0KHRoaXMsICdyb3V0ZUFyZ3MnKSwKICAgICAgICAgIGNvbnRleHRzID0gcm91dGVBcmdzLnNsaWNlKDEpLAogICAgICAgICAgcmVzb2x2ZWRQYXJhbXMgPSBnZXQodGhpcywgJ3Jlc29sdmVkUGFyYW1zJyksCiAgICAgICAgICBjdXJyZW50V2hlbiA9IHRoaXMuY3VycmVudFdoZW4gfHwgcmVzb2x2ZWRQYXJhbXNbMF0sCiAgICAgICAgICBjdXJyZW50V2l0aEluZGV4ID0gY3VycmVudFdoZW4gKyAnLmluZGV4JywKICAgICAgICAgIGlzQWN0aXZlID0gcm91dGVyLmlzQWN0aXZlLmFwcGx5KHJvdXRlciwgW2N1cnJlbnRXaGVuXS5jb25jYXQoY29udGV4dHMpKSB8fAogICAgICAgICAgICAgICAgICAgICByb3V0ZXIuaXNBY3RpdmUuYXBwbHkocm91dGVyLCBbY3VycmVudFdpdGhJbmRleF0uY29uY2F0KGNvbnRleHRzKSk7CgogICAgICBpZiAoaXNBY3RpdmUpIHsgcmV0dXJuIGdldCh0aGlzLCAnYWN0aXZlQ2xhc3MnKTsgfQogICAgfSkucHJvcGVydHkoJ3Jlc29sdmVkUGFyYW1zJywgJ3JvdXRlQXJncycsICdyb3V0ZXIudXJsJyksCgogICAgLyoqCiAgICAgIEFjY2Vzc2VkIGFzIGEgY2xhc3NuYW1lIGJpbmRpbmcgdG8gYXBwbHkgdGhlIGBMaW5rVmlld2AncyBgbG9hZGluZ0NsYXNzYAogICAgICBDU1MgYGNsYXNzYCB0byB0aGUgZWxlbWVudCB3aGVuIHRoZSBsaW5rIGlzIGxvYWRpbmcuCgogICAgICBBIGBMaW5rVmlld2AgaXMgY29uc2lkZXJlZCBsb2FkaW5nIHdoZW4gaXQgaGFzIGF0IGxlYXN0IG9uZQogICAgICBwYXJhbWV0ZXIgd2hvc2UgdmFsdWUgaXMgY3VycmVudGx5IG51bGwgb3IgdW5kZWZpbmVkLiBEdXJpbmcKICAgICAgdGhpcyB0aW1lLCBjbGlja2luZyB0aGUgbGluayB3aWxsIHBlcmZvcm0gbm8gdHJhbnNpdGlvbiBhbmQKICAgICAgZW1pdCBhIHdhcm5pbmcgdGhhdCB0aGUgbGluayBpcyBzdGlsbCBpbiBhIGxvYWRpbmcgc3RhdGUuCgogICAgICBAcHJvcGVydHkgbG9hZGluZwogICAgKiovCiAgICBsb2FkaW5nOiBFbWJlci5jb21wdXRlZChmdW5jdGlvbiBjb21wdXRlTGlua1ZpZXdMb2FkaW5nKCkgewogICAgICBpZiAoIWdldCh0aGlzLCAncm91dGVBcmdzJykpIHsgcmV0dXJuIGdldCh0aGlzLCAnbG9hZGluZ0NsYXNzJyk7IH0KICAgIH0pLnByb3BlcnR5KCdyb3V0ZUFyZ3MnKSwKCiAgICAvKioKICAgICAgUmV0dXJucyB0aGUgYXBwbGljYXRpb24ncyBtYWluIHJvdXRlciBmcm9tIHRoZSBjb250YWluZXIuCgogICAgICBAcHJpdmF0ZQogICAgICBAcHJvcGVydHkgcm91dGVyCiAgICAqKi8KICAgIHJvdXRlcjogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBnZXQodGhpcywgJ2NvbnRyb2xsZXInKS5jb250YWluZXIubG9va3VwKCdyb3V0ZXI6bWFpbicpOwogICAgfSksCgogICAgLyoqCiAgICAgIEV2ZW50IGhhbmRsZXIgdGhhdCBpbnZva2VzIHRoZSBsaW5rLCBhY3RpdmF0aW5nIHRoZSBhc3NvY2lhdGVkIHJvdXRlLgoKICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBfaW52b2tlCiAgICAgIEBwYXJhbSB7RXZlbnR9IGV2ZW50CiAgICAqLwogICAgX2ludm9rZTogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgaWYgKCFpc1NpbXBsZUNsaWNrKGV2ZW50KSkgeyByZXR1cm4gdHJ1ZTsgfQoKICAgICAgaWYgKHRoaXMucHJldmVudERlZmF1bHQgIT09IGZhbHNlKSB7IGV2ZW50LnByZXZlbnREZWZhdWx0KCk7IH0KICAgICAgaWYgKHRoaXMuYnViYmxlcyA9PT0gZmFsc2UpIHsgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7IH0KCiAgICAgIGlmIChnZXQodGhpcywgJ19pc0Rpc2FibGVkJykpIHsgcmV0dXJuIGZhbHNlOyB9CgogICAgICBpZiAoZ2V0KHRoaXMsICdsb2FkaW5nJykpIHsKICAgICAgICBFbWJlci5Mb2dnZXIud2FybigiVGhpcyBsaW5rLXRvIGlzIGluIGFuIGluYWN0aXZlIGxvYWRpbmcgc3RhdGUgYmVjYXVzZSBhdCBsZWFzdCBvbmUgb2YgaXRzIHBhcmFtZXRlcnMgcHJlc2VudGx5IGhhcyBhIG51bGwvdW5kZWZpbmVkIHZhbHVlLCBvciB0aGUgcHJvdmlkZWQgcm91dGUgbmFtZSBpcyBpbnZhbGlkLiIpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgdmFyIHJvdXRlciA9IGdldCh0aGlzLCAncm91dGVyJyksCiAgICAgICAgICByb3V0ZUFyZ3MgPSBnZXQodGhpcywgJ3JvdXRlQXJncycpOwoKICAgICAgaWYgKGdldCh0aGlzLCAncmVwbGFjZScpKSB7CiAgICAgICAgcm91dGVyLnJlcGxhY2VXaXRoLmFwcGx5KHJvdXRlciwgcm91dGVBcmdzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByb3V0ZXIudHJhbnNpdGlvblRvLmFwcGx5KHJvdXRlciwgcm91dGVBcmdzKTsKICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAgQ29tcHV0ZWQgcHJvcGVydHkgdGhhdCByZXR1cm5zIHRoZSByZXNvbHZlZCBwYXJhbWV0ZXJzLgoKICAgICAgQHByaXZhdGUKICAgICAgQHByb3BlcnR5CiAgICAgIEByZXR1cm4ge0FycmF5fQogICAgICovCiAgICByZXNvbHZlZFBhcmFtczogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24oKSB7CiAgICAgIHZhciBwYXJhbWV0ZXJzID0gdGhpcy5wYXJhbWV0ZXJzLAogICAgICAgICAgb3B0aW9ucyA9IHBhcmFtZXRlcnMub3B0aW9ucywKICAgICAgICAgIHR5cGVzID0gb3B0aW9ucy50eXBlcywKICAgICAgICAgIGRhdGEgPSBvcHRpb25zLmRhdGE7CgogICAgICAKICAgICAgLy8gT3JpZ2luYWwgaW1wbGVtZW50YXRpb24gaWYgcXVlcnkgcGFyYW1zIG5vdCBlbmFibGVkCiAgICAgIHJldHVybiByZXNvbHZlUGFyYW1zKHBhcmFtZXRlcnMuY29udGV4dCwgcGFyYW1ldGVycy5wYXJhbXMsIHsgdHlwZXM6IHR5cGVzLCBkYXRhOiBkYXRhIH0pOwogICAgfSkucHJvcGVydHkoKSwKCiAgICAvKioKICAgICAgQ29tcHV0ZWQgcHJvcGVydHkgdGhhdCByZXR1cm5zIHRoZSBjdXJyZW50IHJvdXRlIG5hbWUgYW5kCiAgICAgIGFueSBkeW5hbWljIHNlZ21lbnRzLgoKICAgICAgQHByaXZhdGUKICAgICAgQHByb3BlcnR5CiAgICAgIEByZXR1cm4ge0FycmF5fSBBbiBhcnJheSB3aXRoIHRoZSByb3V0ZSBuYW1lIGFuZCBhbnkgZHluYW1pYyBzZWdtZW50cwogICAgICovCiAgICByb3V0ZUFyZ3M6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uIGNvbXB1dGVMaW5rVmlld1JvdXRlQXJncygpIHsKICAgICAgdmFyIHJlc29sdmVkUGFyYW1zID0gZ2V0KHRoaXMsICdyZXNvbHZlZFBhcmFtcycpLnNsaWNlKDApLAogICAgICAgICAgcm91dGVyID0gZ2V0KHRoaXMsICdyb3V0ZXInKSwKICAgICAgICAgIG5hbWVkUm91dGUgPSByZXNvbHZlZFBhcmFtc1swXTsKCiAgICAgIGlmICghbmFtZWRSb3V0ZSkgeyByZXR1cm47IH0KCiAgICAgIG5hbWVkUm91dGUgPSBmdWxsUm91dGVOYW1lKHJvdXRlciwgbmFtZWRSb3V0ZSk7CiAgICAgIHJlc29sdmVkUGFyYW1zWzBdID0gbmFtZWRSb3V0ZTsKCiAgICAgIGZvciAodmFyIGkgPSAxLCBsZW4gPSByZXNvbHZlZFBhcmFtcy5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICAgIHZhciBwYXJhbSA9IHJlc29sdmVkUGFyYW1zW2ldOwogICAgICAgIGlmIChwYXJhbSA9PT0gbnVsbCB8fCB0eXBlb2YgcGFyYW0gPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAvLyBJZiBjb250ZXh0cyBhcmVuJ3QgcHJlc2VudCwgY29uc2lkZXIgdGhlIGxpbmtWaWV3IHVubG9hZGVkLgogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQoKICAgICAgCiAgICAgIHJldHVybiByZXNvbHZlZFBhcmFtczsKICAgIH0pLnByb3BlcnR5KCdyZXNvbHZlZFBhcmFtcycsICdxdWVyeVBhcmFtcycsICdyb3V0ZXIudXJsJyksCgoKICAgIF9wb3RlbnRpYWxRdWVyeVBhcmFtczogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24gKCkgewogICAgICB2YXIgbmFtZWRSb3V0ZSA9IGdldCh0aGlzLCAncmVzb2x2ZWRQYXJhbXMnKVswXTsKICAgICAgaWYgKCFuYW1lZFJvdXRlKSB7IHJldHVybiBudWxsOyB9CiAgICAgIHZhciByb3V0ZXIgICAgICAgICAgPSBnZXQodGhpcywgJ3JvdXRlcicpOwoKICAgICAgbmFtZWRSb3V0ZSA9IGZ1bGxSb3V0ZU5hbWUocm91dGVyLCBuYW1lZFJvdXRlKTsKCiAgICAgIHJldHVybiByb3V0ZXIucm91dGVyLnF1ZXJ5UGFyYW1zRm9ySGFuZGxlcihuYW1lZFJvdXRlKTsKICAgIH0pLnByb3BlcnR5KCdyZXNvbHZlZFBhcmFtcycpLAoKICAgIHF1ZXJ5UGFyYW1zOiBFbWJlci5jb21wdXRlZChmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBzZWxmICAgICAgICAgICAgICA9IHRoaXMsCiAgICAgICAgcXVlcnlQYXJhbXMgICAgICAgICA9IG51bGwsCiAgICAgICAgYWxsb3dlZFF1ZXJ5UGFyYW1zICA9IGdldCh0aGlzLCAnX3BvdGVudGlhbFF1ZXJ5UGFyYW1zJyk7CgogICAgICBpZiAoIWFsbG93ZWRRdWVyeVBhcmFtcykgeyByZXR1cm4gbnVsbDsgfQogICAgICBhbGxvd2VkUXVlcnlQYXJhbXMuZm9yRWFjaChmdW5jdGlvbiAocGFyYW0pIHsKICAgICAgICB2YXIgdmFsdWUgPSBnZXQoc2VsZiwgcGFyYW0pOwogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICBxdWVyeVBhcmFtcyA9IHF1ZXJ5UGFyYW1zIHx8IHt9OwogICAgICAgICAgcXVlcnlQYXJhbXNbcGFyYW1dID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9KTsKCgogICAgICByZXR1cm4gcXVlcnlQYXJhbXM7CiAgICB9KS5wcm9wZXJ0eSgnX3BvdGVudGlhbFF1ZXJ5UGFyYW1zLltdJyksCgogICAgLyoqCiAgICAgIFNldHMgdGhlIGVsZW1lbnQncyBgaHJlZmAgYXR0cmlidXRlIHRvIHRoZSB1cmwgZm9yCiAgICAgIHRoZSBgTGlua1ZpZXdgJ3MgdGFyZ2V0ZWQgcm91dGUuCgogICAgICBJZiB0aGUgYExpbmtWaWV3YCdzIGB0YWdOYW1lYCBpcyBjaGFuZ2VkIHRvIGEgdmFsdWUgb3RoZXIKICAgICAgdGhhbiBgYWAsIHRoaXMgcHJvcGVydHkgd2lsbCBiZSBpZ25vcmVkLgoKICAgICAgQHByb3BlcnR5IGhyZWYKICAgICoqLwogICAgaHJlZjogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24gY29tcHV0ZUxpbmtWaWV3SHJlZigpIHsKICAgICAgaWYgKGdldCh0aGlzLCAndGFnTmFtZScpICE9PSAnYScpIHsgcmV0dXJuOyB9CgogICAgICB2YXIgcm91dGVyID0gZ2V0KHRoaXMsICdyb3V0ZXInKSwKICAgICAgICAgIHJvdXRlQXJncyA9IGdldCh0aGlzLCAncm91dGVBcmdzJyk7CgogICAgICByZXR1cm4gcm91dGVBcmdzID8gcm91dGVyLmdlbmVyYXRlLmFwcGx5KHJvdXRlciwgcm91dGVBcmdzKSA6IGdldCh0aGlzLCAnbG9hZGluZ0hyZWYnKTsKICAgIH0pLnByb3BlcnR5KCdyb3V0ZUFyZ3MnKSwKCiAgICAvKioKICAgICAgVGhlIGRlZmF1bHQgaHJlZiB2YWx1ZSB0byB1c2Ugd2hpbGUgYSBsaW5rLXRvIGlzIGxvYWRpbmcuCiAgICAgIE9ubHkgYXBwbGllcyB3aGVuIHRhZ05hbWUgaXMgJ2EnCgogICAgICBAcHJvcGVydHkgbG9hZGluZ0hyZWYKICAgICAgQHR5cGUgU3RyaW5nCiAgICAgIEBkZWZhdWx0ICMKICAgICovCiAgICBsb2FkaW5nSHJlZjogJyMnCiAgfSk7CgogIExpbmtWaWV3LnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7IHJldHVybiAiTGlua1ZpZXciOyB9OwoKICAvKioKICAgIFRoZSBge3tsaW5rLXRvfX1gIGhlbHBlciByZW5kZXJzIGEgbGluayB0byB0aGUgc3VwcGxpZWQKICAgIGByb3V0ZU5hbWVgIHBhc3NpbmcgYW4gb3B0aW9uYWxseSBzdXBwbGllZCBtb2RlbCB0byB0aGUKICAgIHJvdXRlIGFzIGl0cyBgbW9kZWxgIGNvbnRleHQgb2YgdGhlIHJvdXRlLiBUaGUgYmxvY2sKICAgIGZvciBge3tsaW5rLXRvfX1gIGJlY29tZXMgdGhlIGlubmVySFRNTCBvZiB0aGUgcmVuZGVyZWQKICAgIGVsZW1lbnQ6CgogICAgYGBgaGFuZGxlYmFycwogICAge3sjbGluay10byAncGhvdG9HYWxsZXJ5J319CiAgICAgIEdyZWF0IEhhbXN0ZXIgUGhvdG9zCiAgICB7ey9saW5rLXRvfX0KICAgIGBgYAoKICAgIGBgYGh0bWwKICAgIDxhIGhyZWY9Ii9oYW1zdGVyLXBob3RvcyI+CiAgICAgIEdyZWF0IEhhbXN0ZXIgUGhvdG9zCiAgICA8L2E+CiAgICBgYGAKCiAgICAjIyMgU3VwcGx5aW5nIGEgdGFnTmFtZQogICAgQnkgZGVmYXVsdCBge3tsaW5rLXRvfX1gIHJlbmRlcnMgYW4gYDxhPmAgZWxlbWVudC4gVGhpcyBjYW4KICAgIGJlIG92ZXJyaWRkZW4gZm9yIGEgc2luZ2xlIHVzZSBvZiBge3tsaW5rLXRvfX1gIGJ5IHN1cHBseWluZwogICAgYSBgdGFnTmFtZWAgb3B0aW9uOgoKICAgIGBgYGhhbmRsZWJhcnMKICAgIHt7I2xpbmstdG8gJ3Bob3RvR2FsbGVyeScgdGFnTmFtZT0ibGkifX0KICAgICAgR3JlYXQgSGFtc3RlciBQaG90b3MKICAgIHt7L2xpbmstdG99fQogICAgYGBgCgogICAgYGBgaHRtbAogICAgPGxpPgogICAgICBHcmVhdCBIYW1zdGVyIFBob3RvcwogICAgPC9saT4KICAgIGBgYAoKICAgIFRvIG92ZXJyaWRlIHRoaXMgb3B0aW9uIGZvciB5b3VyIGVudGlyZSBhcHBsaWNhdGlvbiwgc2VlCiAgICAiT3ZlcnJpZGluZyBBcHBsaWNhdGlvbi13aWRlIERlZmF1bHRzIi4KCiAgICAjIyMgRGlzYWJsaW5nIHRoZSBgbGluay10b2AgaGVscGVyCiAgICBCeSBkZWZhdWx0IGB7e2xpbmstdG99fWAgaXMgZW5hYmxlZC4KICAgIGFueSBwYXNzZWQgdmFsdWUgdG8gYGRpc2FibGVkYCBoZWxwZXIgcHJvcGVydHkgd2lsbCBkaXNhYmxlIHRoZSBgbGluay10b2AgaGVscGVyLgoKICAgIHN0YXRpYyB1c2U6IHRoZSBgZGlzYWJsZWRgIG9wdGlvbjoKCiAgICBgYGBoYW5kbGViYXJzCiAgICB7eyNsaW5rLXRvICdwaG90b0dhbGxlcnknIGRpc2FibGVkPXRydWV9fQogICAgICBHcmVhdCBIYW1zdGVyIFBob3RvcwogICAge3svbGluay10b319CiAgICBgYGAKCiAgICBkeW5hbWljIHVzZTogdGhlIGBkaXNhYmxlZFdoZW5gIG9wdGlvbjoKCiAgICBgYGBoYW5kbGViYXJzCiAgICB7eyNsaW5rLXRvICdwaG90b0dhbGxlcnknIGRpc2FibGVkV2hlbj1jb250cm9sbGVyLnNvbWVQcm9wZXJ0eX19CiAgICAgIEdyZWF0IEhhbXN0ZXIgUGhvdG9zCiAgICB7ey9saW5rLXRvfX0KICAgIGBgYAoKICAgIGFueSBwYXNzZWQgdmFsdWUgdG8gYGRpc2FibGVkYCB3aWxsIGRpc2FibGUgaXQgZXhjZXB0IGB1bmRlZmluZWRgLgogICAgdG8gZW5zdXJlIHRoYXQgb25seSBgdHJ1ZWAgZGlzYWJsZSB0aGUgYGxpbmstdG9gIGhlbHBlciB5b3UgY2FuCiAgICBvdmVycmlkZSB0aGUgZ2xvYmFsIGJlaGF2aW91ciBvZiBgRW1iZXIuTGlua1ZpZXdgLgoKICAgIGBgYGphdmFzY3JpcHQKICAgIEVtYmVyLkxpbmtWaWV3LnJlb3Blbih7CiAgICAgIGRpc2FibGVkOiBFbWJlci5jb21wdXRlZChmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHRoaXMuc2V0KCdfaXNEaXNhYmxlZCcsIHZhbHVlID09PSB0cnVlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlID09PSB0cnVlID8gZ2V0KHRoaXMsICdkaXNhYmxlZENsYXNzJykgOiBmYWxzZTsKICAgICAgfSkKICAgIH0pOwogICAgYGBgCgogICAgc2VlICJPdmVycmlkaW5nIEFwcGxpY2F0aW9uLXdpZGUgRGVmYXVsdHMiIGZvciBtb3JlLgoKICAgICMjIyBIYW5kbGluZyBgaHJlZmAKICAgIGB7e2xpbmstdG99fWAgd2lsbCB1c2UgeW91ciBhcHBsaWNhdGlvbidzIFJvdXRlciB0bwogICAgZmlsbCB0aGUgZWxlbWVudCdzIGBocmVmYCBwcm9wZXJ0eSB3aXRoIGEgdXJsIHRoYXQKICAgIG1hdGNoZXMgdGhlIHBhdGggdG8gdGhlIHN1cHBsaWVkIGByb3V0ZU5hbWVgIGZvciB5b3VyCiAgICByb3V0ZXJzJ3MgY29uZmlndXJlZCBgTG9jYXRpb25gIHNjaGVtZSwgd2hpY2ggZGVmYXVsdHMKICAgIHRvIEVtYmVyLkhhc2hMb2NhdGlvbi4KCiAgICAjIyMgSGFuZGxpbmcgY3VycmVudCByb3V0ZQogICAgYHt7bGluay10b319YCB3aWxsIGFwcGx5IGEgQ1NTIGNsYXNzIG5hbWUgb2YgJ2FjdGl2ZScKICAgIHdoZW4gdGhlIGFwcGxpY2F0aW9uJ3MgY3VycmVudCByb3V0ZSBtYXRjaGVzCiAgICB0aGUgc3VwcGxpZWQgcm91dGVOYW1lLiBGb3IgZXhhbXBsZSwgaWYgdGhlIGFwcGxpY2F0aW9uJ3MKICAgIGN1cnJlbnQgcm91dGUgaXMgJ3Bob3RvR2FsbGVyeS5yZWNlbnQnIHRoZSBmb2xsb3dpbmcKICAgIHVzZSBvZiBge3tsaW5rLXRvfX1gOgoKICAgIGBgYGhhbmRsZWJhcnMKICAgIHt7I2xpbmstdG8gJ3Bob3RvR2FsbGVyeS5yZWNlbnQnfX0KICAgICAgR3JlYXQgSGFtc3RlciBQaG90b3MgZnJvbSB0aGUgbGFzdCB3ZWVrCiAgICB7ey9saW5rLXRvfX0KICAgIGBgYAoKICAgIHdpbGwgcmVzdWx0IGluCgogICAgYGBgaHRtbAogICAgPGEgaHJlZj0iL2hhbXN0ZXItcGhvdG9zL3RoaXMtd2VlayIgY2xhc3M9ImFjdGl2ZSI+CiAgICAgIEdyZWF0IEhhbXN0ZXIgUGhvdG9zCiAgICA8L2E+CiAgICBgYGAKCiAgICBUaGUgQ1NTIGNsYXNzIG5hbWUgdXNlZCBmb3IgYWN0aXZlIGNsYXNzZXMgY2FuIGJlIGN1c3RvbWl6ZWQKICAgIGZvciBhIHNpbmdsZSB1c2Ugb2YgYHt7bGluay10b319YCBieSBwYXNzaW5nIGFuIGBhY3RpdmVDbGFzc2AKICAgIG9wdGlvbjoKCiAgICBgYGBoYW5kbGViYXJzCiAgICB7eyNsaW5rLXRvICdwaG90b0dhbGxlcnkucmVjZW50JyBhY3RpdmVDbGFzcz0iY3VycmVudC11cmwifX0KICAgICAgR3JlYXQgSGFtc3RlciBQaG90b3MgZnJvbSB0aGUgbGFzdCB3ZWVrCiAgICB7ey9saW5rLXRvfX0KICAgIGBgYAoKICAgIGBgYGh0bWwKICAgIDxhIGhyZWY9Ii9oYW1zdGVyLXBob3Rvcy90aGlzLXdlZWsiIGNsYXNzPSJjdXJyZW50LXVybCI+CiAgICAgIEdyZWF0IEhhbXN0ZXIgUGhvdG9zCiAgICA8L2E+CiAgICBgYGAKCiAgICBUbyBvdmVycmlkZSB0aGlzIG9wdGlvbiBmb3IgeW91ciBlbnRpcmUgYXBwbGljYXRpb24sIHNlZQogICAgIk92ZXJyaWRpbmcgQXBwbGljYXRpb24td2lkZSBEZWZhdWx0cyIuCgogICAgIyMjIFN1cHBseWluZyBhIG1vZGVsCiAgICBBbiBvcHRpb25hbCBtb2RlbCBhcmd1bWVudCBjYW4gYmUgdXNlZCBmb3Igcm91dGVzIHdob3NlCiAgICBwYXRocyBjb250YWluIGR5bmFtaWMgc2VnbWVudHMuIFRoaXMgYXJndW1lbnQgd2lsbCBiZWNvbWUKICAgIHRoZSBtb2RlbCBjb250ZXh0IG9mIHRoZSBsaW5rZWQgcm91dGU6CgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLlJvdXRlci5tYXAoZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucmVzb3VyY2UoInBob3RvR2FsbGVyeSIsIHtwYXRoOiAiaGFtc3Rlci1waG90b3MvOnBob3RvX2lkIn0pOwogICAgfSk7CiAgICBgYGAKCiAgICBgYGBoYW5kbGViYXJzCiAgICB7eyNsaW5rLXRvICdwaG90b0dhbGxlcnknIGFQaG90b319CiAgICAgIHt7YVBob3RvLnRpdGxlfX0KICAgIHt7L2xpbmstdG99fQogICAgYGBgCgogICAgYGBgaHRtbAogICAgPGEgaHJlZj0iL2hhbXN0ZXItcGhvdG9zLzQyIj4KICAgICAgVG9tc3RlcgogICAgPC9hPgogICAgYGBgCgogICAgIyMjIFN1cHBseWluZyBtdWx0aXBsZSBtb2RlbHMKICAgIEZvciBkZWVwLWxpbmtpbmcgdG8gcm91dGUgcGF0aHMgdGhhdCBjb250YWluIG11bHRpcGxlCiAgICBkeW5hbWljIHNlZ21lbnRzLCBtdWx0aXBsZSBtb2RlbCBhcmd1bWVudHMgY2FuIGJlIHVzZWQuCiAgICBBcyB0aGUgcm91dGVyIHRyYW5zaXRpb25zIHRocm91Z2ggdGhlIHJvdXRlIHBhdGgsIGVhY2gKICAgIHN1cHBsaWVkIG1vZGVsIGFyZ3VtZW50IHdpbGwgYmVjb21lIHRoZSBjb250ZXh0IGZvciB0aGUKICAgIHJvdXRlIHdpdGggdGhlIGR5bmFtaWMgc2VnbWVudHM6CgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLlJvdXRlci5tYXAoZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucmVzb3VyY2UoInBob3RvR2FsbGVyeSIsIHtwYXRoOiAiaGFtc3Rlci1waG90b3MvOnBob3RvX2lkIn0sIGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMucm91dGUoImNvbW1lbnQiLCB7cGF0aDogImNvbW1lbnRzLzpjb21tZW50X2lkIn0pOwogICAgICB9KTsKICAgIH0pOwogICAgYGBgCiAgICBUaGlzIGFyZ3VtZW50IHdpbGwgYmVjb21lIHRoZSBtb2RlbCBjb250ZXh0IG9mIHRoZSBsaW5rZWQgcm91dGU6CgogICAgYGBgaGFuZGxlYmFycwogICAge3sjbGluay10byAncGhvdG9HYWxsZXJ5LmNvbW1lbnQnIGFQaG90byBjb21tZW50fX0KICAgICAge3tjb21tZW50LmJvZHl9fQogICAge3svbGluay10b319CiAgICBgYGAKCiAgICBgYGBodG1sCiAgICA8YSBocmVmPSIvaGFtc3Rlci1waG90b3MvNDIvY29tbWVudC83MTgiPgogICAgICBBKysrIHdvdWxkIHNudWdnbGUgYWdhaW4uCiAgICA8L2E+CiAgICBgYGAKCiAgICAjIyMgU3VwcGx5aW5nIGFuIGV4cGxpY2l0IGR5bmFtaWMgc2VnbWVudCB2YWx1ZQogICAgSWYgeW91IGRvbid0IGhhdmUgYSBtb2RlbCBvYmplY3QgYXZhaWxhYmxlIHRvIHBhc3MgdG8gYHt7bGluay10b319YCwKICAgIGFuIG9wdGlvbmFsIHN0cmluZyBvciBpbnRlZ2VyIGFyZ3VtZW50IGNhbiBiZSBwYXNzZWQgZm9yIHJvdXRlcyB3aG9zZQogICAgcGF0aHMgY29udGFpbiBkeW5hbWljIHNlZ21lbnRzLiBUaGlzIGFyZ3VtZW50IHdpbGwgYmVjb21lIHRoZSB2YWx1ZQogICAgb2YgdGhlIGR5bmFtaWMgc2VnbWVudDoKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuUm91dGVyLm1hcChmdW5jdGlvbigpIHsKICAgICAgdGhpcy5yZXNvdXJjZSgicGhvdG9HYWxsZXJ5Iiwge3BhdGg6ICJoYW1zdGVyLXBob3Rvcy86cGhvdG9faWQifSk7CiAgICB9KTsKICAgIGBgYAoKICAgIGBgYGhhbmRsZWJhcnMKICAgIHt7I2xpbmstdG8gJ3Bob3RvR2FsbGVyeScgYVBob3RvSWR9fQogICAgICB7e2FQaG90by50aXRsZX19CiAgICB7ey9saW5rLXRvfX0KICAgIGBgYAoKICAgIGBgYGh0bWwKICAgIDxhIGhyZWY9Ii9oYW1zdGVyLXBob3Rvcy80MiI+CiAgICAgIFRvbXN0ZXIKICAgIDwvYT4KICAgIGBgYAoKICAgIFdoZW4gdHJhbnNpdGlvbmluZyBpbnRvIHRoZSBsaW5rZWQgcm91dGUsIHRoZSBgbW9kZWxgIGhvb2sgd2lsbAogICAgYmUgdHJpZ2dlcmVkIHdpdGggcGFyYW1ldGVycyBpbmNsdWRpbmcgdGhpcyBwYXNzZWQgaWRlbnRpZmllci4KCiAgICAjIyMgQWxsb3dpbmcgRGVmYXVsdCBBY3Rpb24KCiAgIEJ5IGRlZmF1bHQgdGhlIGB7e2xpbmstdG99fWAgaGVscGVyIHByZXZlbnRzIHRoZSBkZWZhdWx0IGJyb3dzZXIgYWN0aW9uCiAgIGJ5IGNhbGxpbmcgYHByZXZlbnREZWZhdWx0KClgIGFzIHRoaXMgc29ydCBvZiBhY3Rpb24gYnViYmxpbmcgaXMgbm9ybWFsbHkKICAgaGFuZGxlZCBpbnRlcm5hbGx5IGFuZCB3ZSBkbyBub3Qgd2FudCB0byB0YWtlIHRoZSBicm93c2VyIHRvIGEgbmV3IFVSTCAoZm9yCiAgIGV4YW1wbGUpLgoKICAgSWYgeW91IG5lZWQgdG8gb3ZlcnJpZGUgdGhpcyBiZWhhdmlvciBzcGVjaWZ5IGBwcmV2ZW50RGVmYXVsdD1mYWxzZWAgaW4KICAgeW91ciB0ZW1wbGF0ZToKCiAgICBgYGBoYW5kbGViYXJzCiAgICB7eyNsaW5rLXRvICdwaG90b0dhbGxlcnknIGFQaG90b0lkIHByZXZlbnREZWZhdWx0PWZhbHNlfX0KICAgICAge3thUGhvdG9JZC50aXRsZX19CiAgICB7ey9saW5rLXRvfX0KICAgIGBgYAoKICAgICMjIyBPdmVycmlkaW5nIGF0dHJpYnV0ZXMKICAgIFlvdSBjYW4gb3ZlcnJpZGUgYW55IGdpdmVuIHByb3BlcnR5IG9mIHRoZSBFbWJlci5MaW5rVmlldwogICAgdGhhdCBpcyBnZW5lcmF0ZWQgYnkgdGhlIGB7e2xpbmstdG99fWAgaGVscGVyIGJ5IHBhc3NpbmcKICAgIGtleS92YWx1ZSBwYWlycywgbGlrZSBzbzoKCiAgICBgYGBoYW5kbGViYXJzCiAgICB7eyNsaW5rLXRvICBhUGhvdG8gdGFnTmFtZT0nbGknIHRpdGxlPSdGb2xsb3dpbmcgdGhpcyBsaW5rIHdpbGwgY2hhbmdlIHlvdXIgbGlmZScgY2xhc3NOYW1lcz0ncGljIHN3ZWV0J319CiAgICAgIFVoLW1hemluZyEKICAgIHt7L2xpbmstdG99fQogICAgYGBgCgogICAgU2VlIFtFbWJlci5MaW5rVmlld10oL2FwaS9jbGFzc2VzL0VtYmVyLkxpbmtWaWV3Lmh0bWwpIGZvciBhCiAgICBjb21wbGV0ZSBsaXN0IG9mIG92ZXJyaWRlYWJsZSBwcm9wZXJ0aWVzLiBCZSBzdXJlIHRvIGFsc28KICAgIGNoZWNrIG91dCBpbmhlcml0ZWQgcHJvcGVydGllcyBvZiBgTGlua1ZpZXdgLgoKICAgICMjIyBPdmVycmlkaW5nIEFwcGxpY2F0aW9uLXdpZGUgRGVmYXVsdHMKICAgIGBge3tsaW5rLXRvfX1gYCBjcmVhdGVzIGFuIGluc3RhbmNlIG9mIEVtYmVyLkxpbmtWaWV3CiAgICBmb3IgcmVuZGVyaW5nLiBUbyBvdmVycmlkZSBvcHRpb25zIGZvciB5b3VyIGVudGlyZQogICAgYXBwbGljYXRpb24sIHJlb3BlbiBFbWJlci5MaW5rVmlldyBhbmQgc3VwcGx5IHRoZQogICAgZGVzaXJlZCB2YWx1ZXM6CgogICAgYGBgIGphdmFzY3JpcHQKICAgIEVtYmVyLkxpbmtWaWV3LnJlb3Blbih7CiAgICAgIGFjdGl2ZUNsYXNzOiAiaXMtYWN0aXZlIiwKICAgICAgdGFnTmFtZTogJ2xpJwogICAgfSkKICAgIGBgYAoKICAgIEl0IGlzIGFsc28gcG9zc2libGUgdG8gb3ZlcnJpZGUgdGhlIGRlZmF1bHQgZXZlbnQgaW4KICAgIHRoaXMgbWFubmVyOgoKICAgIGBgYCBqYXZhc2NyaXB0CiAgICBFbWJlci5MaW5rVmlldy5yZW9wZW4oewogICAgICBldmVudE5hbWU6ICdjdXN0b21FdmVudE5hbWUnCiAgICB9KTsKICAgIGBgYAoKICAgIEBtZXRob2QgbGluay10bwogICAgQGZvciBFbWJlci5IYW5kbGViYXJzLmhlbHBlcnMKICAgIEBwYXJhbSB7U3RyaW5nfSByb3V0ZU5hbWUKICAgIEBwYXJhbSB7T2JqZWN0fSBbY29udGV4dF0qCiAgICBAcGFyYW0gW29wdGlvbnNdIHtPYmplY3R9IEhhbmRsZWJhcnMga2V5L3ZhbHVlIHBhaXJzIG9mIG9wdGlvbnMsIHlvdSBjYW4gb3ZlcnJpZGUgYW55IHByb3BlcnR5IG9mIEVtYmVyLkxpbmtWaWV3CiAgICBAcmV0dXJuIHtTdHJpbmd9IEhUTUwgc3RyaW5nCiAgICBAc2VlIHtFbWJlci5MaW5rVmlld30KICAqLwogIEVtYmVyLkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2xpbmstdG8nLCBmdW5jdGlvbiBsaW5rVG9IZWxwZXIobmFtZSkgewogICAgdmFyIG9wdGlvbnMgPSBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgLTEpWzBdLAogICAgICAgIHBhcmFtcyA9IFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwLCAtMSksCiAgICAgICAgaGFzaCA9IG9wdGlvbnMuaGFzaDsKCiAgICBoYXNoLmRpc2FibGVkQmluZGluZyA9IGhhc2guZGlzYWJsZWRXaGVuOwoKICAgIGlmICghb3B0aW9ucy5mbikgewogICAgICB2YXIgbGlua1RpdGxlID0gcGFyYW1zLnNoaWZ0KCk7CiAgICAgIHZhciBsaW5rVHlwZSA9IG9wdGlvbnMudHlwZXMuc2hpZnQoKTsKICAgICAgdmFyIGNvbnRleHQgPSB0aGlzOwogICAgICBpZiAobGlua1R5cGUgPT09ICdJRCcpIHsKICAgICAgICBvcHRpb25zLmxpbmtUZXh0UGF0aCA9IGxpbmtUaXRsZTsKICAgICAgICBvcHRpb25zLmZuID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gRW1iZXIuSGFuZGxlYmFycy5nZXQoY29udGV4dCwgbGlua1RpdGxlLCBvcHRpb25zKTsKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIG9wdGlvbnMuZm4gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBsaW5rVGl0bGU7CiAgICAgICAgfTsKICAgICAgfQogICAgfQoKICAgIGhhc2gucGFyYW1ldGVycyA9IHsKICAgICAgY29udGV4dDogdGhpcywKICAgICAgb3B0aW9uczogb3B0aW9ucywKICAgICAgcGFyYW1zOiBwYXJhbXMKICAgIH07CgogICAgcmV0dXJuIEVtYmVyLkhhbmRsZWJhcnMuaGVscGVycy52aWV3LmNhbGwodGhpcywgTGlua1ZpZXcsIG9wdGlvbnMpOwogIH0pOwoKICAvKioKICAgIFNlZSBbbGluay10b10oL2FwaS9jbGFzc2VzL0VtYmVyLkhhbmRsZWJhcnMuaGVscGVycy5odG1sI21ldGhvZF9saW5rLXRvKQoKICAgIEBtZXRob2QgbGlua1RvCiAgICBAZm9yIEVtYmVyLkhhbmRsZWJhcnMuaGVscGVycwogICAgQGRlcHJlY2F0ZWQKICAgIEBwYXJhbSB7U3RyaW5nfSByb3V0ZU5hbWUKICAgIEBwYXJhbSB7T2JqZWN0fSBbY29udGV4dF0qCiAgICBAcmV0dXJuIHtTdHJpbmd9IEhUTUwgc3RyaW5nCiAgKi8KICBFbWJlci5IYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdsaW5rVG8nLCBmdW5jdGlvbiBsaW5rVG9IZWxwZXIoKSB7CiAgICBFbWJlci53YXJuKCJUaGUgJ2xpbmtUbycgdmlldyBoZWxwZXIgaXMgZGVwcmVjYXRlZCBpbiBmYXZvciBvZiAnbGluay10byciKTsKICAgIHJldHVybiBFbWJlci5IYW5kbGViYXJzLmhlbHBlcnNbJ2xpbmstdG8nXS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0pOwp9KTsKCgoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLXJvdXRpbmcKKi8KCnZhciBnZXQgPSBFbWJlci5nZXQsIHNldCA9IEVtYmVyLnNldDsKRW1iZXIub25Mb2FkKCdFbWJlci5IYW5kbGViYXJzJywgZnVuY3Rpb24oSGFuZGxlYmFycykgewogIC8qKgogIEBtb2R1bGUgZW1iZXIKICBAc3VibW9kdWxlIGVtYmVyLXJvdXRpbmcKICAqLwoKICBIYW5kbGViYXJzLk91dGxldFZpZXcgPSBFbWJlci5Db250YWluZXJWaWV3LmV4dGVuZChFbWJlci5fTWV0YW1vcnBoKTsKCiAgLyoqCiAgICBUaGUgYG91dGxldGAgaGVscGVyIGlzIGEgcGxhY2Vob2xkZXIgdGhhdCB0aGUgcm91dGVyIHdpbGwgZmlsbCBpbiB3aXRoCiAgICB0aGUgYXBwcm9wcmlhdGUgdGVtcGxhdGUgYmFzZWQgb24gdGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhlIGFwcGxpY2F0aW9uLgoKICAgIGBgYCBoYW5kbGViYXJzCiAgICB7e291dGxldH19CiAgICBgYGAKCiAgICBCeSBkZWZhdWx0LCBhIHRlbXBsYXRlIGJhc2VkIG9uIEVtYmVyJ3MgbmFtaW5nIGNvbnZlbnRpb25zIHdpbGwgYmUgcmVuZGVyZWQKICAgIGludG8gdGhlIGBvdXRsZXRgIChlLmcuIGBBcHAuUG9zdHNSb3V0ZWAgd2lsbCByZW5kZXIgdGhlIGBwb3N0c2AgdGVtcGxhdGUpLgoKICAgIFlvdSBjYW4gcmVuZGVyIGEgZGlmZmVyZW50IHRlbXBsYXRlIGJ5IHVzaW5nIHRoZSBgcmVuZGVyKClgIG1ldGhvZCBpbiB0aGUKICAgIHJvdXRlJ3MgYHJlbmRlclRlbXBsYXRlYCBob29rLiBUaGUgZm9sbG93aW5nIHdpbGwgcmVuZGVyIHRoZSBgZmF2b3JpdGVQb3N0YAogICAgdGVtcGxhdGUgaW50byB0aGUgYG91dGxldGAuCgogICAgYGBgIGphdmFzY3JpcHQKICAgIEFwcC5Qb3N0c1JvdXRlID0gRW1iZXIuUm91dGUuZXh0ZW5kKHsKICAgICAgcmVuZGVyVGVtcGxhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMucmVuZGVyKCdmYXZvcml0ZVBvc3QnKTsKICAgICAgfQogICAgfSk7CiAgICBgYGAKCiAgICBZb3UgY2FuIGNyZWF0ZSBjdXN0b20gbmFtZWQgb3V0bGV0cyBmb3IgbW9yZSBjb250cm9sLgoKICAgIGBgYCBoYW5kbGViYXJzCiAgICB7e291dGxldCAnZmF2b3JpdGVQb3N0J319CiAgICB7e291dGxldCAncG9zdHMnfX0KICAgIGBgYAoKICAgIFRoZW4geW91IGNhbiBkZWZpbmUgd2hhdCB0ZW1wbGF0ZSBpcyByZW5kZXJlZCBpbnRvIGVhY2ggb3V0bGV0IGluIHlvdXIKICAgIHJvdXRlLgoKCiAgICBgYGAgamF2YXNjcmlwdAogICAgQXBwLlBvc3RzUm91dGUgPSBFbWJlci5Sb3V0ZS5leHRlbmQoewogICAgICByZW5kZXJUZW1wbGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yZW5kZXIoJ2Zhdm9yaXRlUG9zdCcsIHsgb3V0bGV0OiAnZmF2b3JpdGVQb3N0JyB9KTsKICAgICAgICB0aGlzLnJlbmRlcigncG9zdHMnLCB7IG91dGxldDogJ3Bvc3RzJyB9KTsKICAgICAgfQogICAgfSk7CiAgICBgYGAKCiAgICBZb3UgY2FuIHNwZWNpZnkgdGhlIHZpZXcgdGhhdCB0aGUgb3V0bGV0IHVzZXMgdG8gY29udGFpbiBhbmQgbWFuYWdlIHRoZQogICAgdGVtcGxhdGVzIHJlbmRlcmVkIGludG8gaXQuCgogICAgYGBgIGhhbmRsZWJhcnMKICAgIHt7b3V0bGV0IHZpZXc9J3NlY3Rpb25Db250YWluZXInfX0KICAgIGBgYAoKICAgIGBgYCBqYXZhc2NyaXB0CiAgICBBcHAuU2VjdGlvbkNvbnRhaW5lciA9IEVtYmVyLkNvbnRhaW5lclZpZXcuZXh0ZW5kKHsKICAgICAgdGFnTmFtZTogJ3NlY3Rpb24nLAogICAgICBjbGFzc05hbWVzOiBbJ3NwZWNpYWwnXQogICAgfSk7CiAgICBgYGAKCiAgICBAbWV0aG9kIG91dGxldAogICAgQGZvciBFbWJlci5IYW5kbGViYXJzLmhlbHBlcnMKICAgIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eSB0aGUgcHJvcGVydHkgb24gdGhlIGNvbnRyb2xsZXIKICAgICAgdGhhdCBob2xkcyB0aGUgdmlldyBmb3IgdGhpcyBvdXRsZXQKICAgIEByZXR1cm4ge1N0cmluZ30gSFRNTCBzdHJpbmcKICAqLwogIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ291dGxldCcsIGZ1bmN0aW9uIG91dGxldEhlbHBlcihwcm9wZXJ0eSwgb3B0aW9ucykgewogICAKICAgIHZhciBvdXRsZXRTb3VyY2UsCiAgICAgICAgY29udGFpbmVyLAogICAgICAgIHZpZXdOYW1lLAogICAgICAgIHZpZXdDbGFzcywKICAgICAgICB2aWV3RnVsbE5hbWU7CgogICAgaWYgKHByb3BlcnR5ICYmIHByb3BlcnR5LmRhdGEgJiYgcHJvcGVydHkuZGF0YS5pc1JlbmRlckRhdGEpIHsKICAgICAgb3B0aW9ucyA9IHByb3BlcnR5OwogICAgICBwcm9wZXJ0eSA9ICdtYWluJzsKICAgIH0KCiAgICBjb250YWluZXIgPSBvcHRpb25zLmRhdGEudmlldy5jb250YWluZXI7CgogICAgb3V0bGV0U291cmNlID0gb3B0aW9ucy5kYXRhLnZpZXc7CiAgICB3aGlsZSAoIW91dGxldFNvdXJjZS5nZXQoJ3RlbXBsYXRlLmlzVG9wJykpIHsKICAgICAgb3V0bGV0U291cmNlID0gb3V0bGV0U291cmNlLmdldCgnX3BhcmVudFZpZXcnKTsKICAgIH0KCiAgICAvLyBwcm92aWRlIGNvbnRyb2xsZXIgb3ZlcnJpZGUKICAgIHZpZXdOYW1lID0gb3B0aW9ucy5oYXNoLnZpZXc7CgogICAgaWYgKHZpZXdOYW1lKSB7CiAgICAgIHZpZXdGdWxsTmFtZSA9ICd2aWV3OicgKyB2aWV3TmFtZTsKICAgICAgRW1iZXIuYXNzZXJ0KCJVc2luZyBhIHF1b3RlbGVzcyB2aWV3IHBhcmFtZXRlciB3aXRoIHt7b3V0bGV0fX0gaXMgbm90IHN1cHBvcnRlZC4gUGxlYXNlIHVwZGF0ZSB0byBxdW90ZWQgdXNhZ2UgJ3t7b3V0bGV0IFwiIiArIHZpZXdOYW1lICsgIlwifX0uIiwgb3B0aW9ucy5oYXNoVHlwZXMudmlldyAhPT0gJ0lEJyk7CiAgICAgIEVtYmVyLmFzc2VydCgiVGhlIHZpZXcgbmFtZSB5b3Ugc3VwcGxpZWQgJyIgKyB2aWV3TmFtZSArICInIGRpZCBub3QgcmVzb2x2ZSB0byBhIHZpZXcuIiwgY29udGFpbmVyLmhhcyh2aWV3RnVsbE5hbWUpKTsKICAgIH0KCiAgICB2aWV3Q2xhc3MgPSB2aWV3TmFtZSA/IGNvbnRhaW5lci5sb29rdXBGYWN0b3J5KHZpZXdGdWxsTmFtZSkgOiBvcHRpb25zLmhhc2gudmlld0NsYXNzIHx8IEhhbmRsZWJhcnMuT3V0bGV0VmlldzsKCiAgICBvcHRpb25zLmRhdGEudmlldy5zZXQoJ291dGxldFNvdXJjZScsIG91dGxldFNvdXJjZSk7CiAgICBvcHRpb25zLmhhc2guY3VycmVudFZpZXdCaW5kaW5nID0gJ192aWV3Lm91dGxldFNvdXJjZS5fb3V0bGV0cy4nICsgcHJvcGVydHk7CgogICAgcmV0dXJuIEhhbmRsZWJhcnMuaGVscGVycy52aWV3LmNhbGwodGhpcywgdmlld0NsYXNzLCBvcHRpb25zKTsKICB9KTsKfSk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItcm91dGluZwoqLwoKdmFyIGdldCA9IEVtYmVyLmdldCwgc2V0ID0gRW1iZXIuc2V0OwpFbWJlci5vbkxvYWQoJ0VtYmVyLkhhbmRsZWJhcnMnLCBmdW5jdGlvbihIYW5kbGViYXJzKSB7CgogIC8qKgogICAgQ2FsbGluZyBgYHt7cmVuZGVyfX1gYCBmcm9tIHdpdGhpbiBhIHRlbXBsYXRlIHdpbGwgaW5zZXJ0IGFub3RoZXIKICAgIHRlbXBsYXRlIHRoYXQgbWF0Y2hlcyB0aGUgcHJvdmlkZWQgbmFtZS4gVGhlIGluc2VydGVkIHRlbXBsYXRlIHdpbGwKICAgIGFjY2VzcyBpdHMgcHJvcGVydGllcyBvbiBpdHMgb3duIGNvbnRyb2xsZXIgKHJhdGhlciB0aGFuIHRoZSBjb250cm9sbGVyCiAgICBvZiB0aGUgcGFyZW50IHRlbXBsYXRlKS4KCiAgICBJZiBhIHZpZXcgY2xhc3Mgd2l0aCB0aGUgc2FtZSBuYW1lIGV4aXN0cywgdGhlIHZpZXcgY2xhc3MgYWxzbyB3aWxsIGJlIHVzZWQuCgogICAgTm90ZTogQSBnaXZlbiBjb250cm9sbGVyIG1heSBvbmx5IGJlIHVzZWQgKm9uY2UqIGluIHlvdXIgYXBwIGluIHRoaXMgbWFubmVyLgogICAgQSBzaW5nbGV0b24gaW5zdGFuY2Ugb2YgdGhlIGNvbnRyb2xsZXIgd2lsbCBiZSBjcmVhdGVkIGZvciB5b3UuCgogICAgRXhhbXBsZToKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuTmF2aWdhdGlvbkNvbnRyb2xsZXIgPSBFbWJlci5Db250cm9sbGVyLmV4dGVuZCh7CiAgICAgIHdobzogIndvcmxkIgogICAgfSk7CiAgICBgYGAKCiAgICBgYGBoYW5kbGViYXJzCiAgICA8IS0tIG5hdmlnYXRpb24uaGJzIC0tPgogICAgSGVsbG8sIHt7d2hvfX0uCiAgICBgYGAKCiAgICBgYGBoYW5kZWxiYXJzCiAgICA8IS0tIGFwcGxpY2F0aW9uLmhicyAtLT4KICAgIDxoMT5NeSBncmVhdCBhcHA8L2gxPgogICAge3tyZW5kZXIgbmF2aWdhdGlvbn19CiAgICBgYGAKCiAgICBgYGBodG1sCiAgICA8aDE+TXkgZ3JlYXQgYXBwPC9oMT4KICAgIDxkaXYgY2xhc3M9J2VtYmVyLXZpZXcnPgogICAgICBIZWxsbywgd29ybGQuCiAgICA8L2Rpdj4KICAgIGBgYAoKICAgIE9wdGlvbmFsbHkgeW91IG1heSBwcm92aWRlIGEgc2Vjb25kIGFyZ3VtZW50OiBhIHByb3BlcnR5IHBhdGgKICAgIHRoYXQgd2lsbCBiZSBib3VuZCB0byB0aGUgYG1vZGVsYCBwcm9wZXJ0eSBvZiB0aGUgY29udHJvbGxlci4KCiAgICBJZiBhIGBtb2RlbGAgcHJvcGVydHkgcGF0aCBpcyBzcGVjaWZpZWQsIHRoZW4gYSBuZXcgaW5zdGFuY2Ugb2YgdGhlCiAgICBjb250cm9sbGVyIHdpbGwgYmUgY3JlYXRlZCBhbmQgYHt7cmVuZGVyfX1gIGNhbiBiZSB1c2VkIG11bHRpcGxlIHRpbWVzCiAgICB3aXRoIHRoZSBzYW1lIG5hbWUuCgogICBGb3IgZXhhbXBsZSBpZiB5b3UgaGFkIHRoaXMgYGF1dGhvcmAgdGVtcGxhdGUuCgogICBgYGBoYW5kbGViYXJzCjxkaXYgY2xhc3M9ImF1dGhvciI+CiAgV3JpdHRlbiBieSB7e2ZpcnN0TmFtZX19IHt7bGFzdE5hbWV9fS4KICBUb3RhbCBQb3N0czoge3twb3N0Q291bnR9fQo8L2Rpdj4KICBgYGAKCiAgWW91IGNvdWxkIHJlbmRlciBpdCBpbnNpZGUgdGhlIGBwb3N0YCB0ZW1wbGF0ZSB1c2luZyB0aGUgYHJlbmRlcmAgaGVscGVyLgoKICBgYGBoYW5kbGViYXJzCjxkaXYgY2xhc3M9InBvc3QiPgogIDxoMT57e3RpdGxlfX08L2gxPgogIDxkaXY+e3tib2R5fX08L2Rpdj4KICB7e3JlbmRlciAiYXV0aG9yIiBhdXRob3J9fQo8L2Rpdj4KICAgYGBgCgogICAgQG1ldGhvZCByZW5kZXIKICAgIEBmb3IgRW1iZXIuSGFuZGxlYmFycy5oZWxwZXJzCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZQogICAgQHBhcmFtIHtPYmplY3Q/fSBjb250ZXh0U3RyaW5nCiAgICBAcGFyYW0ge0hhc2h9IG9wdGlvbnMKICAgIEByZXR1cm4ge1N0cmluZ30gSFRNTCBzdHJpbmcKICAqLwogIEVtYmVyLkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3JlbmRlcicsIGZ1bmN0aW9uIHJlbmRlckhlbHBlcihuYW1lLCBjb250ZXh0U3RyaW5nLCBvcHRpb25zKSB7CiAgICB2YXIgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aDsKICAgIEVtYmVyLmFzc2VydCgiWW91IG11c3QgcGFzcyBhIHRlbXBsYXRlIHRvIHJlbmRlciIsIGxlbmd0aCA+PSAyKTsKICAgIHZhciBjb250ZXh0UHJvdmlkZWQgPSBsZW5ndGggPT09IDMsCiAgICAgICAgY29udGFpbmVyLCByb3V0ZXIsIGNvbnRyb2xsZXIsIHZpZXcsIGNvbnRleHQsIGxvb2t1cE9wdGlvbnM7CgogICAgY29udGFpbmVyID0gKG9wdGlvbnMgfHwgY29udGV4dFN0cmluZykuZGF0YS5rZXl3b3Jkcy5jb250cm9sbGVyLmNvbnRhaW5lcjsKICAgIHJvdXRlciA9IGNvbnRhaW5lci5sb29rdXAoJ3JvdXRlcjptYWluJyk7CgogICAgaWYgKGxlbmd0aCA9PT0gMikgewogICAgICAvLyB1c2UgdGhlIHNpbmdsZXRvbiBjb250cm9sbGVyCiAgICAgIG9wdGlvbnMgPSBjb250ZXh0U3RyaW5nOwogICAgICBjb250ZXh0U3RyaW5nID0gdW5kZWZpbmVkOwogICAgICBFbWJlci5hc3NlcnQoIllvdSBjYW4gb25seSB1c2UgdGhlIHt7cmVuZGVyfX0gaGVscGVyIG9uY2Ugd2l0aG91dCBhIG1vZGVsIG9iamVjdCBhcyBpdHMgc2Vjb25kIGFyZ3VtZW50LCBhcyBpbiB7e3JlbmRlciBcInBvc3RcIiBwb3N0fX0uIiwgIXJvdXRlciB8fCAhcm91dGVyLl9sb29rdXBBY3RpdmVWaWV3KG5hbWUpKTsKICAgIH0gZWxzZSBpZiAobGVuZ3RoID09PSAzKSB7CiAgICAgIC8vIGNyZWF0ZSBhIG5ldyBjb250cm9sbGVyCiAgICAgIGNvbnRleHQgPSBFbWJlci5IYW5kbGViYXJzLmdldChvcHRpb25zLmNvbnRleHRzWzFdLCBjb250ZXh0U3RyaW5nLCBvcHRpb25zKTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IEVtYmVyLkVycm9yKCJZb3UgbXVzdCBwYXNzIGEgdGVtcGxhdGVOYW1lIHRvIHJlbmRlciIpOwogICAgfQoKICAgIC8vICMgbGVnYWN5IG5hbWVzcGFjZQogICAgbmFtZSA9IG5hbWUucmVwbGFjZSgvXC8vZywgJy4nKTsKICAgIC8vIFwgbGVnYWN5IHNsYXNoIGFzIG5hbWVzcGFjZSBzdXBwb3J0CgoKICAgIHZpZXcgPSBjb250YWluZXIubG9va3VwKCd2aWV3OicgKyBuYW1lKSB8fCBjb250YWluZXIubG9va3VwKCd2aWV3OmRlZmF1bHQnKTsKCiAgICAvLyBwcm92aWRlIGNvbnRyb2xsZXIgb3ZlcnJpZGUKICAgIHZhciBjb250cm9sbGVyTmFtZSA9IG9wdGlvbnMuaGFzaC5jb250cm9sbGVyIHx8IG5hbWU7CiAgICB2YXIgY29udHJvbGxlckZ1bGxOYW1lID0gJ2NvbnRyb2xsZXI6JyArIGNvbnRyb2xsZXJOYW1lOwoKICAgIGlmIChvcHRpb25zLmhhc2guY29udHJvbGxlcikgewogICAgICBFbWJlci5hc3NlcnQoIlRoZSBjb250cm9sbGVyIG5hbWUgeW91IHN1cHBsaWVkICciICsgY29udHJvbGxlck5hbWUgKyAiJyBkaWQgbm90IHJlc29sdmUgdG8gYSBjb250cm9sbGVyLiIsIGNvbnRhaW5lci5oYXMoY29udHJvbGxlckZ1bGxOYW1lKSk7CiAgICB9CgogICAgdmFyIHBhcmVudENvbnRyb2xsZXIgPSBvcHRpb25zLmRhdGEua2V5d29yZHMuY29udHJvbGxlcjsKCiAgICAvLyBjaG9vc2UgbmFtZQogICAgaWYgKGxlbmd0aCA+IDIpIHsKICAgICAgdmFyIGZhY3RvcnkgPSBjb250YWluZXIubG9va3VwRmFjdG9yeShjb250cm9sbGVyRnVsbE5hbWUpIHx8CiAgICAgICAgICAgICAgICAgICAgRW1iZXIuZ2VuZXJhdGVDb250cm9sbGVyRmFjdG9yeShjb250YWluZXIsIGNvbnRyb2xsZXJOYW1lLCBjb250ZXh0KTsKCiAgICAgIGNvbnRyb2xsZXIgPSBmYWN0b3J5LmNyZWF0ZSh7CiAgICAgICAgbW9kZWw6IGNvbnRleHQsCiAgICAgICAgcGFyZW50Q29udHJvbGxlcjogcGFyZW50Q29udHJvbGxlciwKICAgICAgICB0YXJnZXQ6IHBhcmVudENvbnRyb2xsZXIKICAgICAgfSk7CgogICAgfSBlbHNlIHsKICAgICAgY29udHJvbGxlciA9IGNvbnRhaW5lci5sb29rdXAoY29udHJvbGxlckZ1bGxOYW1lKSB8fAogICAgICAgICAgICAgICAgICAgRW1iZXIuZ2VuZXJhdGVDb250cm9sbGVyKGNvbnRhaW5lciwgY29udHJvbGxlck5hbWUpOwoKICAgICAgY29udHJvbGxlci5zZXRQcm9wZXJ0aWVzKHsKICAgICAgICB0YXJnZXQ6IHBhcmVudENvbnRyb2xsZXIsCiAgICAgICAgcGFyZW50Q29udHJvbGxlcjogcGFyZW50Q29udHJvbGxlcgogICAgICB9KTsKICAgIH0KCiAgICB2YXIgcm9vdCA9IG9wdGlvbnMuY29udGV4dHNbMV07CgogICAgaWYgKHJvb3QpIHsKICAgICAgdmlldy5yZWdpc3Rlck9ic2VydmVyKHJvb3QsIGNvbnRleHRTdHJpbmcsIGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnRyb2xsZXIuc2V0KCdtb2RlbCcsIEVtYmVyLkhhbmRsZWJhcnMuZ2V0KHJvb3QsIGNvbnRleHRTdHJpbmcsIG9wdGlvbnMpKTsKICAgICAgfSk7CiAgICB9CgogICAgb3B0aW9ucy5oYXNoLnZpZXdOYW1lID0gRW1iZXIuU3RyaW5nLmNhbWVsaXplKG5hbWUpOwoKICAgIHZhciB0ZW1wbGF0ZU5hbWUgPSAndGVtcGxhdGU6JyArIG5hbWU7CiAgICBFbWJlci5hc3NlcnQoIllvdSB1c2VkIGB7e3JlbmRlciAnIiArIG5hbWUgKyAiJ319YCwgYnV0ICciICsgbmFtZSArICInIGNhbiBub3QgYmUgZm91bmQgYXMgZWl0aGVyIGEgdGVtcGxhdGUgb3IgYSB2aWV3LiIsIGNvbnRhaW5lci5oYXMoInZpZXc6IiArIG5hbWUpIHx8IGNvbnRhaW5lci5oYXModGVtcGxhdGVOYW1lKSk7CiAgICBvcHRpb25zLmhhc2gudGVtcGxhdGUgPSBjb250YWluZXIubG9va3VwKHRlbXBsYXRlTmFtZSk7CgogICAgb3B0aW9ucy5oYXNoLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyOwoKICAgIGlmIChyb3V0ZXIgJiYgIWNvbnRleHQpIHsKICAgICAgcm91dGVyLl9jb25uZWN0QWN0aXZlVmlldyhuYW1lLCB2aWV3KTsKICAgIH0KCiAgICBFbWJlci5IYW5kbGViYXJzLmhlbHBlcnMudmlldy5jYWxsKHRoaXMsIHZpZXcsIG9wdGlvbnMpOwogIH0pOwp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1yb3V0aW5nCiovCkVtYmVyLm9uTG9hZCgnRW1iZXIuSGFuZGxlYmFycycsIGZ1bmN0aW9uKEhhbmRsZWJhcnMpIHsKCiAgdmFyIHJlc29sdmVQYXJhbXMgPSBFbWJlci5Sb3V0ZXIucmVzb2x2ZVBhcmFtcywKICAgICAgaXNTaW1wbGVDbGljayA9IEVtYmVyLlZpZXdVdGlscy5pc1NpbXBsZUNsaWNrOwoKICB2YXIgRW1iZXJIYW5kbGViYXJzID0gRW1iZXIuSGFuZGxlYmFycywKICAgICAgaGFuZGxlYmFyc0dldCA9IEVtYmVySGFuZGxlYmFycy5nZXQsCiAgICAgIFNhZmVTdHJpbmcgPSBFbWJlckhhbmRsZWJhcnMuU2FmZVN0cmluZywKICAgICAgZm9yRWFjaCA9IEVtYmVyLkFycmF5UG9seWZpbGxzLmZvckVhY2gsCiAgICAgIGdldCA9IEVtYmVyLmdldCwKICAgICAgYV9zbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKCiAgZnVuY3Rpb24gYXJncyhvcHRpb25zLCBhY3Rpb25OYW1lKSB7CiAgICB2YXIgcmV0ID0gW107CiAgICBpZiAoYWN0aW9uTmFtZSkgeyByZXQucHVzaChhY3Rpb25OYW1lKTsgfQoKICAgIHZhciB0eXBlcyA9IG9wdGlvbnMub3B0aW9ucy50eXBlcy5zbGljZSgxKSwKICAgICAgICBkYXRhID0gb3B0aW9ucy5vcHRpb25zLmRhdGE7CgogICAgcmV0dXJuIHJldC5jb25jYXQocmVzb2x2ZVBhcmFtcyhvcHRpb25zLmNvbnRleHQsIG9wdGlvbnMucGFyYW1zLCB7IHR5cGVzOiB0eXBlcywgZGF0YTogZGF0YSB9KSk7CiAgfQoKICB2YXIgQWN0aW9uSGVscGVyID0gRW1iZXJIYW5kbGViYXJzLkFjdGlvbkhlbHBlciA9IHsKICAgIHJlZ2lzdGVyZWRBY3Rpb25zOiB7fQogIH07CgogIHZhciBrZXlzID0gWyJhbHQiLCAic2hpZnQiLCAibWV0YSIsICJjdHJsIl07CgogIHZhciBQT0lOVEVSX0VWRU5UX1RZUEVfUkVHRVggPSAvXmNsaWNrfG1vdXNlfHRvdWNoLzsKCiAgdmFyIGlzQWxsb3dlZEV2ZW50ID0gZnVuY3Rpb24oZXZlbnQsIGFsbG93ZWRLZXlzKSB7CiAgICBpZiAodHlwZW9mIGFsbG93ZWRLZXlzID09PSAidW5kZWZpbmVkIikgewogICAgICBpZiAoUE9JTlRFUl9FVkVOVF9UWVBFX1JFR0VYLnRlc3QoZXZlbnQudHlwZSkpIHsKICAgICAgICByZXR1cm4gaXNTaW1wbGVDbGljayhldmVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYWxsb3dlZEtleXMgPSAnJzsKICAgICAgfQogICAgfQoKICAgIGlmIChhbGxvd2VkS2V5cy5pbmRleE9mKCJhbnkiKSA+PSAwKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIHZhciBhbGxvd2VkID0gdHJ1ZTsKCiAgICBmb3JFYWNoLmNhbGwoa2V5cywgZnVuY3Rpb24oa2V5KSB7CiAgICAgIGlmIChldmVudFtrZXkgKyAiS2V5Il0gJiYgYWxsb3dlZEtleXMuaW5kZXhPZihrZXkpID09PSAtMSkgewogICAgICAgIGFsbG93ZWQgPSBmYWxzZTsKICAgICAgfQogICAgfSk7CgogICAgcmV0dXJuIGFsbG93ZWQ7CiAgfTsKCiAgQWN0aW9uSGVscGVyLnJlZ2lzdGVyQWN0aW9uID0gZnVuY3Rpb24oYWN0aW9uTmFtZSwgb3B0aW9ucywgYWxsb3dlZEtleXMpIHsKICAgIHZhciBhY3Rpb25JZCA9ICgrK0VtYmVyLnV1aWQpLnRvU3RyaW5nKCk7CgogICAgQWN0aW9uSGVscGVyLnJlZ2lzdGVyZWRBY3Rpb25zW2FjdGlvbklkXSA9IHsKICAgICAgZXZlbnROYW1lOiBvcHRpb25zLmV2ZW50TmFtZSwKICAgICAgaGFuZGxlcjogZnVuY3Rpb24gaGFuZGxlUmVnaXN0ZXJlZEFjdGlvbihldmVudCkgewogICAgICAgIGlmICghaXNBbGxvd2VkRXZlbnQoZXZlbnQsIGFsbG93ZWRLZXlzKSkgeyByZXR1cm4gdHJ1ZTsgfQoKICAgICAgICBpZiAob3B0aW9ucy5wcmV2ZW50RGVmYXVsdCAhPT0gZmFsc2UpIHsKICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfQoKICAgICAgICBpZiAob3B0aW9ucy5idWJibGVzID09PSBmYWxzZSkgewogICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgfQoKICAgICAgICB2YXIgdGFyZ2V0ID0gb3B0aW9ucy50YXJnZXQ7CgogICAgICAgIGlmICh0YXJnZXQudGFyZ2V0KSB7CiAgICAgICAgICB0YXJnZXQgPSBoYW5kbGViYXJzR2V0KHRhcmdldC5yb290LCB0YXJnZXQudGFyZ2V0LCB0YXJnZXQub3B0aW9ucyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRhcmdldCA9IHRhcmdldC5yb290OwogICAgICAgIH0KCiAgICAgICAgRW1iZXIucnVuKGZ1bmN0aW9uIHJ1blJlZ2lzdGVyZWRBY3Rpb24oKSB7CiAgICAgICAgICBpZiAodGFyZ2V0LnNlbmQpIHsKICAgICAgICAgICAgdGFyZ2V0LnNlbmQuYXBwbHkodGFyZ2V0LCBhcmdzKG9wdGlvbnMucGFyYW1ldGVycywgYWN0aW9uTmFtZSkpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgRW1iZXIuYXNzZXJ0KCJUaGUgYWN0aW9uICciICsgYWN0aW9uTmFtZSArICInIGRpZCBub3QgZXhpc3Qgb24gIiArIHRhcmdldCwgdHlwZW9mIHRhcmdldFthY3Rpb25OYW1lXSA9PT0gJ2Z1bmN0aW9uJyk7CiAgICAgICAgICAgIHRhcmdldFthY3Rpb25OYW1lXS5hcHBseSh0YXJnZXQsIGFyZ3Mob3B0aW9ucy5wYXJhbWV0ZXJzKSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CgogICAgb3B0aW9ucy52aWV3Lm9uKCd3aWxsQ2xlYXJSZW5kZXInLCBmdW5jdGlvbigpIHsKICAgICAgZGVsZXRlIEFjdGlvbkhlbHBlci5yZWdpc3RlcmVkQWN0aW9uc1thY3Rpb25JZF07CiAgICB9KTsKCiAgICByZXR1cm4gYWN0aW9uSWQ7CiAgfTsKCiAgLyoqCiAgICBUaGUgYHt7YWN0aW9ufX1gIGhlbHBlciByZWdpc3RlcnMgYW4gSFRNTCBlbGVtZW50IHdpdGhpbiBhIHRlbXBsYXRlIGZvciBET00KICAgIGV2ZW50IGhhbmRsaW5nIGFuZCBmb3J3YXJkcyB0aGF0IGludGVyYWN0aW9uIHRvIHRoZSB0ZW1wbGF0ZXMncyBjb250cm9sbGVyCiAgICBvciBzdXBwbGllZCBgdGFyZ2V0YCBvcHRpb24gKHNlZSAnU3BlY2lmeWluZyBhIFRhcmdldCcpLgoKICAgIElmIHRoZSBjb250cm9sbGVyIGRvZXMgbm90IGltcGxlbWVudCB0aGUgZXZlbnQsIHRoZSBldmVudCBpcyBzZW50CiAgICB0byB0aGUgY3VycmVudCByb3V0ZSwgYW5kIGl0IGJ1YmJsZXMgdXAgdGhlIHJvdXRlIGhpZXJhcmNoeSBmcm9tIHRoZXJlLgoKICAgIFVzZXIgaW50ZXJhY3Rpb24gd2l0aCB0aGF0IGVsZW1lbnQgd2lsbCBpbnZva2UgdGhlIHN1cHBsaWVkIGFjdGlvbiBuYW1lIG9uCiAgICB0aGUgYXBwcm9wcmlhdGUgdGFyZ2V0LgoKICAgIEdpdmVuIHRoZSBmb2xsb3dpbmcgYXBwbGljYXRpb24gSGFuZGxlYmFycyB0ZW1wbGF0ZSBvbiB0aGUgcGFnZQoKICAgIGBgYGhhbmRsZWJhcnMKICAgIDxkaXYge3thY3Rpb24gJ2FuQWN0aW9uTmFtZSd9fT4KICAgICAgY2xpY2sgbWUKICAgIDwvZGl2PgogICAgYGBgCgogICAgQW5kIGFwcGxpY2F0aW9uIGNvZGUKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuQXBwbGljYXRpb25Db250cm9sbGVyID0gRW1iZXIuQ29udHJvbGxlci5leHRlbmQoewogICAgICBhY3Rpb25zOiB7CiAgICAgICAgYW5BY3Rpb25OYW1lOiBmdW5jdGlvbigpIHsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgV2lsbCByZXN1bHQgaW4gdGhlIGZvbGxvd2luZyByZW5kZXJlZCBIVE1MCgogICAgYGBgaHRtbAogICAgPGRpdiBjbGFzcz0iZW1iZXItdmlldyI+CiAgICAgIDxkaXYgZGF0YS1lbWJlci1hY3Rpb249IjEiPgogICAgICAgIGNsaWNrIG1lCiAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgICBgYGAKCiAgICBDbGlja2luZyAiY2xpY2sgbWUiIHdpbGwgdHJpZ2dlciB0aGUgYGFuQWN0aW9uTmFtZWAgYWN0aW9uIG9mIHRoZQogICAgYEFwcC5BcHBsaWNhdGlvbkNvbnRyb2xsZXJgLiBJbiB0aGlzIGNhc2UsIG5vIGFkZGl0aW9uYWwgcGFyYW1ldGVycyB3aWxsIGJlIHBhc3NlZC4KCiAgICBJZiB5b3UgcHJvdmlkZSBhZGRpdGlvbmFsIHBhcmFtZXRlcnMgdG8gdGhlIGhlbHBlcjoKCiAgICBgYGBoYW5kbGViYXJzCiAgICA8YnV0dG9uIHt7YWN0aW9uICdlZGl0JyBwb3N0fX0+RWRpdDwvYnV0dG9uPgogICAgYGBgCgogICAgVGhvc2UgcGFyYW1ldGVycyB3aWxsIGJlIHBhc3NlZCBhbG9uZyBhcyBhcmd1bWVudHMgdG8gdGhlIEphdmFTY3JpcHQKICAgIGZ1bmN0aW9uIGltcGxlbWVudGluZyB0aGUgYWN0aW9uLgoKICAgICMjIyBFdmVudCBQcm9wYWdhdGlvbgoKICAgIEV2ZW50cyB0cmlnZ2VyZWQgdGhyb3VnaCB0aGUgYWN0aW9uIGhlbHBlciB3aWxsIGF1dG9tYXRpY2FsbHkgaGF2ZQogICAgYC5wcmV2ZW50RGVmYXVsdCgpYCBjYWxsZWQgb24gdGhlbS4gWW91IGRvIG5vdCBuZWVkIHRvIGRvIHNvIGluIHlvdXIgZXZlbnQKICAgIGhhbmRsZXJzLiBJZiB5b3UgbmVlZCB0byBhbGxvdyBldmVudCBwcm9wYWdhdGlvbiAodG8gaGFuZGxlIGZpbGUgaW5wdXRzIGZvcgogICAgZXhhbXBsZSkgeW91IGNhbiBzdXBwbHkgdGhlIGBwcmV2ZW50RGVmYXVsdD1mYWxzZWAgb3B0aW9uIHRvIHRoZSBge3thY3Rpb259fWAgaGVscGVyOgoKICAgIGBgYGhhbmRsZWJhcnMKICAgIDxkaXYge3thY3Rpb24gInNheUhlbGxvIiBwcmV2ZW50RGVmYXVsdD1mYWxzZX19PgogICAgICA8aW5wdXQgdHlwZT0iZmlsZSIgLz4KICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiAvPgogICAgPC9kaXY+CiAgICBgYGAKCiAgICBUbyBkaXNhYmxlIGJ1YmJsaW5nLCBwYXNzIGBidWJibGVzPWZhbHNlYCB0byB0aGUgaGVscGVyOgoKICAgIGBgYGhhbmRsZWJhcnMKICAgIDxidXR0b24ge3thY3Rpb24gJ2VkaXQnIHBvc3QgYnViYmxlcz1mYWxzZX19PkVkaXQ8L2J1dHRvbj4KICAgIGBgYAoKICAgIElmIHlvdSBuZWVkIHRoZSBkZWZhdWx0IGhhbmRsZXIgdG8gdHJpZ2dlciB5b3Ugc2hvdWxkIGVpdGhlciByZWdpc3RlciB5b3VyCiAgICBvd24gZXZlbnQgaGFuZGxlciwgb3IgdXNlIGV2ZW50IG1ldGhvZHMgb24geW91ciB2aWV3IGNsYXNzLiBTZWUgW0VtYmVyLlZpZXddKC9hcGkvY2xhc3Nlcy9FbWJlci5WaWV3Lmh0bWwpCiAgICAnUmVzcG9uZGluZyB0byBCcm93c2VyIEV2ZW50cycgZm9yIG1vcmUgaW5mb3JtYXRpb24uCgogICAgIyMjIFNwZWNpZnlpbmcgRE9NIGV2ZW50IHR5cGUKCiAgICBCeSBkZWZhdWx0IHRoZSBge3thY3Rpb259fWAgaGVscGVyIHJlZ2lzdGVycyBmb3IgRE9NIGBjbGlja2AgZXZlbnRzLiBZb3UgY2FuCiAgICBzdXBwbHkgYW4gYG9uYCBvcHRpb24gdG8gdGhlIGhlbHBlciB0byBzcGVjaWZ5IGEgZGlmZmVyZW50IERPTSBldmVudCBuYW1lOgoKICAgIGBgYGhhbmRsZWJhcnMKICAgIDxkaXYge3thY3Rpb24gImFuQWN0aW9uTmFtZSIgb249ImRvdWJsZUNsaWNrIn19PgogICAgICBjbGljayBtZQogICAgPC9kaXY+CiAgICBgYGAKCiAgICBTZWUgYEVtYmVyLlZpZXdgICdSZXNwb25kaW5nIHRvIEJyb3dzZXIgRXZlbnRzJyBmb3IgYSBsaXN0IG9mCiAgICBhY2NlcHRhYmxlIERPTSBldmVudCBuYW1lcy4KCiAgICBOT1RFOiBCZWNhdXNlIGB7e2FjdGlvbn19YCBkZXBlbmRzIG9uIEVtYmVyJ3MgZXZlbnQgZGlzcGF0Y2ggc3lzdGVtIGl0IHdpbGwKICAgIG9ubHkgZnVuY3Rpb24gaWYgYW4gYEVtYmVyLkV2ZW50RGlzcGF0Y2hlcmAgaW5zdGFuY2UgaXMgYXZhaWxhYmxlLiBBbgogICAgYEVtYmVyLkV2ZW50RGlzcGF0Y2hlcmAgaW5zdGFuY2Ugd2lsbCBiZSBjcmVhdGVkIHdoZW4gYSBuZXcgYEVtYmVyLkFwcGxpY2F0aW9uYAogICAgaXMgY3JlYXRlZC4gSGF2aW5nIGFuIGluc3RhbmNlIG9mIGBFbWJlci5BcHBsaWNhdGlvbmAgd2lsbCBzYXRpc2Z5IHRoaXMKICAgIHJlcXVpcmVtZW50LgoKICAgICMjIyBTcGVjaWZ5aW5nIHdoaXRlbGlzdGVkIG1vZGlmaWVyIGtleXMKCiAgICBCeSBkZWZhdWx0IHRoZSBge3thY3Rpb259fWAgaGVscGVyIHdpbGwgaWdub3JlIGNsaWNrIGV2ZW50IHdpdGggcHJlc3NlZCBtb2RpZmllcgogICAga2V5cy4gWW91IGNhbiBzdXBwbHkgYW4gYGFsbG93ZWRLZXlzYCBvcHRpb24gdG8gc3BlY2lmeSB3aGljaCBrZXlzIHNob3VsZCBub3QgYmUgaWdub3JlZC4KCiAgICBgYGBoYW5kbGViYXJzCiAgICA8ZGl2IHt7YWN0aW9uICJhbkFjdGlvbk5hbWUiIGFsbG93ZWRLZXlzPSJhbHQifX0+CiAgICAgIGNsaWNrIG1lCiAgICA8L2Rpdj4KICAgIGBgYAoKICAgIFRoaXMgd2F5IHRoZSBge3thY3Rpb259fWAgd2lsbCBmaXJlIHdoZW4gY2xpY2tpbmcgd2l0aCB0aGUgYWx0IGtleSBwcmVzc2VkIGRvd24uCgogICAgQWx0ZXJuYXRpdmVseSwgc3VwcGx5ICJhbnkiIHRvIHRoZSBgYWxsb3dlZEtleXNgIG9wdGlvbiB0byBhY2NlcHQgYW55IGNvbWJpbmF0aW9uIG9mIG1vZGlmaWVyIGtleXMuCgogICAgYGBgaGFuZGxlYmFycwogICAgPGRpdiB7e2FjdGlvbiAiYW5BY3Rpb25OYW1lIiBhbGxvd2VkS2V5cz0iYW55In19PgogICAgICBjbGljayBtZSB3aXRoIGFueSBrZXkgcHJlc3NlZAogICAgPC9kaXY+CiAgICBgYGAKCiAgICAjIyMgU3BlY2lmeWluZyBhIFRhcmdldAoKICAgIFRoZXJlIGFyZSBzZXZlcmFsIHBvc3NpYmxlIHRhcmdldCBvYmplY3RzIGZvciBge3thY3Rpb259fWAgaGVscGVyczoKCiAgICBJbiBhIHR5cGljYWwgRW1iZXIgYXBwbGljYXRpb24sIHdoZXJlIHZpZXdzIGFyZSBtYW5hZ2VkIHRocm91Z2ggdXNlIG9mIHRoZQogICAgYHt7b3V0bGV0fX1gIGhlbHBlciwgYWN0aW9ucyB3aWxsIGJ1YmJsZSB0byB0aGUgY3VycmVudCBjb250cm9sbGVyLCB0aGVuCiAgICB0byB0aGUgY3VycmVudCByb3V0ZSwgYW5kIHRoZW4gdXAgdGhlIHJvdXRlIGhpZXJhcmNoeS4KCiAgICBBbHRlcm5hdGl2ZWx5LCBhIGB0YXJnZXRgIG9wdGlvbiBjYW4gYmUgcHJvdmlkZWQgdG8gdGhlIGhlbHBlciB0byBjaGFuZ2UKICAgIHdoaWNoIG9iamVjdCB3aWxsIHJlY2VpdmUgdGhlIG1ldGhvZCBjYWxsLiBUaGlzIG9wdGlvbiBtdXN0IGJlIGEgcGF0aAogICAgdG8gYW4gb2JqZWN0LCBhY2Nlc3NpYmxlIGluIHRoZSBjdXJyZW50IGNvbnRleHQ6CgogICAgYGBgaGFuZGxlYmFycwogICAge3shIHRoZSBhcHBsaWNhdGlvbiB0ZW1wbGF0ZSB9fQogICAgPGRpdiB7e2FjdGlvbiAiYW5BY3Rpb25OYW1lIiB0YXJnZXQ9dmlld319PgogICAgICBjbGljayBtZQogICAgPC9kaXY+CiAgICBgYGAKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuQXBwbGljYXRpb25WaWV3ID0gRW1iZXIuVmlldy5leHRlbmQoewogICAgICBhY3Rpb25zOiB7CiAgICAgICAgYW5BY3Rpb25OYW1lOiBmdW5jdGlvbigpe30KICAgICAgfQogICAgfSk7CgogICAgYGBgCgogICAgIyMjIEFkZGl0aW9uYWwgUGFyYW1ldGVycwoKICAgIFlvdSBtYXkgc3BlY2lmeSBhZGRpdGlvbmFsIHBhcmFtZXRlcnMgdG8gdGhlIGB7e2FjdGlvbn19YCBoZWxwZXIuIFRoZXNlCiAgICBwYXJhbWV0ZXJzIGFyZSBwYXNzZWQgYWxvbmcgYXMgdGhlIGFyZ3VtZW50cyB0byB0aGUgSmF2YVNjcmlwdCBmdW5jdGlvbgogICAgaW1wbGVtZW50aW5nIHRoZSBhY3Rpb24uCgogICAgYGBgaGFuZGxlYmFycwogICAge3sjZWFjaCBwZXJzb24gaW4gcGVvcGxlfX0KICAgICAgPGRpdiB7e2FjdGlvbiAiZWRpdCIgcGVyc29ufX0+CiAgICAgICAgY2xpY2sgbWUKICAgICAgPC9kaXY+CiAgICB7ey9lYWNofX0KICAgIGBgYAoKICAgIENsaWNraW5nICJjbGljayBtZSIgd2lsbCB0cmlnZ2VyIHRoZSBgZWRpdGAgbWV0aG9kIG9uIHRoZSBjdXJyZW50IGNvbnRyb2xsZXIKICAgIHdpdGggdGhlIHZhbHVlIG9mIGBwZXJzb25gIGFzIGEgcGFyYW1ldGVyLgoKICAgIEBtZXRob2QgYWN0aW9uCiAgICBAZm9yIEVtYmVyLkhhbmRsZWJhcnMuaGVscGVycwogICAgQHBhcmFtIHtTdHJpbmd9IGFjdGlvbk5hbWUKICAgIEBwYXJhbSB7T2JqZWN0fSBbY29udGV4dF0qCiAgICBAcGFyYW0ge0hhc2h9IG9wdGlvbnMKICAqLwogIEVtYmVySGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignYWN0aW9uJywgZnVuY3Rpb24gYWN0aW9uSGVscGVyKGFjdGlvbk5hbWUpIHsKICAgIHZhciBvcHRpb25zID0gYXJndW1lbnRzW2FyZ3VtZW50cy5sZW5ndGggLSAxXSwKICAgICAgICBjb250ZXh0cyA9IGFfc2xpY2UuY2FsbChhcmd1bWVudHMsIDEsIC0xKTsKCiAgICB2YXIgaGFzaCA9IG9wdGlvbnMuaGFzaCwKICAgICAgICBjb250cm9sbGVyOwoKICAgIC8vIGNyZWF0ZSBhIGhhc2ggdG8gcGFzcyBhbG9uZyB0byByZWdpc3RlckFjdGlvbgogICAgdmFyIGFjdGlvbiA9IHsKICAgICAgZXZlbnROYW1lOiBoYXNoLm9uIHx8ICJjbGljayIKICAgIH07CgogICAgYWN0aW9uLnBhcmFtZXRlcnMgPSB7CiAgICAgIGNvbnRleHQ6IHRoaXMsCiAgICAgIG9wdGlvbnM6IG9wdGlvbnMsCiAgICAgIHBhcmFtczogY29udGV4dHMKICAgIH07CgogICAgYWN0aW9uLnZpZXcgPSBvcHRpb25zLmRhdGEudmlldzsKCiAgICB2YXIgcm9vdCwgdGFyZ2V0OwoKICAgIGlmIChoYXNoLnRhcmdldCkgewogICAgICByb290ID0gdGhpczsKICAgICAgdGFyZ2V0ID0gaGFzaC50YXJnZXQ7CiAgICB9IGVsc2UgaWYgKGNvbnRyb2xsZXIgPSBvcHRpb25zLmRhdGEua2V5d29yZHMuY29udHJvbGxlcikgewogICAgICByb290ID0gY29udHJvbGxlcjsKICAgIH0KCiAgICBhY3Rpb24udGFyZ2V0ID0geyByb290OiByb290LCB0YXJnZXQ6IHRhcmdldCwgb3B0aW9uczogb3B0aW9ucyB9OwogICAgYWN0aW9uLmJ1YmJsZXMgPSBoYXNoLmJ1YmJsZXM7CiAgICBhY3Rpb24ucHJldmVudERlZmF1bHQgPSBoYXNoLnByZXZlbnREZWZhdWx0OwoKICAgIHZhciBhY3Rpb25JZCA9IEFjdGlvbkhlbHBlci5yZWdpc3RlckFjdGlvbihhY3Rpb25OYW1lLCBhY3Rpb24sIGhhc2guYWxsb3dlZEtleXMpOwogICAgcmV0dXJuIG5ldyBTYWZlU3RyaW5nKCdkYXRhLWVtYmVyLWFjdGlvbj0iJyArIGFjdGlvbklkICsgJyInKTsKICB9KTsKCn0pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLXJvdXRpbmcKKi8KCnZhciBnZXQgPSBFbWJlci5nZXQsIHNldCA9IEVtYmVyLnNldDsKCkVtYmVyLkNvbnRyb2xsZXJNaXhpbi5yZW9wZW4oewogIC8qKgogICAgVHJhbnNpdGlvbiB0aGUgYXBwbGljYXRpb24gaW50byBhbm90aGVyIHJvdXRlLiBUaGUgcm91dGUgbWF5CiAgICBiZSBlaXRoZXIgYSBzaW5nbGUgcm91dGUgb3Igcm91dGUgcGF0aDoKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBhQ29udHJvbGxlci50cmFuc2l0aW9uVG9Sb3V0ZSgnYmxvZ1Bvc3RzJyk7CiAgICBhQ29udHJvbGxlci50cmFuc2l0aW9uVG9Sb3V0ZSgnYmxvZ1Bvc3RzLnJlY2VudEVudHJpZXMnKTsKICAgIGBgYAoKICAgIE9wdGlvbmFsbHkgc3VwcGx5IGEgbW9kZWwgZm9yIHRoZSByb3V0ZSBpbiBxdWVzdGlvbi4gVGhlIG1vZGVsCiAgICB3aWxsIGJlIHNlcmlhbGl6ZWQgaW50byB0aGUgVVJMIHVzaW5nIHRoZSBgc2VyaWFsaXplYCBob29rIG9mCiAgICB0aGUgcm91dGU6CgogICAgYGBgamF2YXNjcmlwdAogICAgYUNvbnRyb2xsZXIudHJhbnNpdGlvblRvUm91dGUoJ2Jsb2dQb3N0JywgYVBvc3QpOwogICAgYGBgCgogICAgTXVsdGlwbGUgbW9kZWxzIHdpbGwgYmUgYXBwbGllZCBsYXN0IHRvIGZpcnN0IHJlY3Vyc2l2ZWx5IHVwIHRoZQogICAgcmVzb3VyY2UgdHJlZS4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICB0aGlzLnJlc291cmNlKCdibG9nUG9zdCcsIHtwYXRoOic6YmxvZ1Bvc3RJZCd9LCBmdW5jdGlvbigpewogICAgICB0aGlzLnJlc291cmNlKCdibG9nQ29tbWVudCcsIHtwYXRoOiAnOmJsb2dDb21tZW50SWQnfSk7CiAgICB9KTsKCiAgICBhQ29udHJvbGxlci50cmFuc2l0aW9uVG9Sb3V0ZSgnYmxvZ0NvbW1lbnQnLCBhUG9zdCwgYUNvbW1lbnQpOwogICAgYGBgCgogICAgU2VlIGFsc28gJ3JlcGxhY2VSb3V0ZScuCgogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgdGhlIG5hbWUgb2YgdGhlIHJvdXRlCiAgICBAcGFyYW0gey4uLk9iamVjdH0gbW9kZWxzIHRoZSBtb2RlbChzKSB0byBiZSB1c2VkIHdoaWxlIHRyYW5zaXRpb25pbmcKICAgIHRvIHRoZSByb3V0ZS4KICAgIEBmb3IgRW1iZXIuQ29udHJvbGxlck1peGluCiAgICBAbWV0aG9kIHRyYW5zaXRpb25Ub1JvdXRlCiAgKi8KICB0cmFuc2l0aW9uVG9Sb3V0ZTogZnVuY3Rpb24oKSB7CiAgICAvLyB0YXJnZXQgbWF5IGJlIGVpdGhlciBhbm90aGVyIGNvbnRyb2xsZXIgb3IgYSByb3V0ZXIKICAgIHZhciB0YXJnZXQgPSBnZXQodGhpcywgJ3RhcmdldCcpLAogICAgICAgIG1ldGhvZCA9IHRhcmdldC50cmFuc2l0aW9uVG9Sb3V0ZSB8fCB0YXJnZXQudHJhbnNpdGlvblRvOwogICAgcmV0dXJuIG1ldGhvZC5hcHBseSh0YXJnZXQsIGFyZ3VtZW50cyk7CiAgfSwKCiAgLyoqCiAgICBAZGVwcmVjYXRlZAogICAgQGZvciBFbWJlci5Db250cm9sbGVyTWl4aW4KICAgIEBtZXRob2QgdHJhbnNpdGlvblRvCiAgKi8KICB0cmFuc2l0aW9uVG86IGZ1bmN0aW9uKCkgewogICAgRW1iZXIuZGVwcmVjYXRlKCJ0cmFuc2l0aW9uVG8gaXMgZGVwcmVjYXRlZC4gUGxlYXNlIHVzZSB0cmFuc2l0aW9uVG9Sb3V0ZS4iKTsKICAgIHJldHVybiB0aGlzLnRyYW5zaXRpb25Ub1JvdXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfSwKCiAgLyoqCiAgICBUcmFuc2l0aW9uIGludG8gYW5vdGhlciByb3V0ZSB3aGlsZSByZXBsYWNpbmcgdGhlIGN1cnJlbnQgVVJMLCBpZiBwb3NzaWJsZS4KICAgIFRoaXMgd2lsbCByZXBsYWNlIHRoZSBjdXJyZW50IGhpc3RvcnkgZW50cnkgaW5zdGVhZCBvZiBhZGRpbmcgYSBuZXcgb25lLiAKICAgIEJlc2lkZSB0aGF0LCBpdCBpcyBpZGVudGljYWwgdG8gYHRyYW5zaXRpb25Ub1JvdXRlYCBpbiBhbGwgb3RoZXIgcmVzcGVjdHMuCgogICAgYGBgamF2YXNjcmlwdAogICAgYUNvbnRyb2xsZXIucmVwbGFjZVJvdXRlKCdibG9nUG9zdHMnKTsKICAgIGFDb250cm9sbGVyLnJlcGxhY2VSb3V0ZSgnYmxvZ1Bvc3RzLnJlY2VudEVudHJpZXMnKTsKICAgIGBgYAoKICAgIE9wdGlvbmFsbHkgc3VwcGx5IGEgbW9kZWwgZm9yIHRoZSByb3V0ZSBpbiBxdWVzdGlvbi4gVGhlIG1vZGVsCiAgICB3aWxsIGJlIHNlcmlhbGl6ZWQgaW50byB0aGUgVVJMIHVzaW5nIHRoZSBgc2VyaWFsaXplYCBob29rIG9mCiAgICB0aGUgcm91dGU6CgogICAgYGBgamF2YXNjcmlwdAogICAgYUNvbnRyb2xsZXIucmVwbGFjZVJvdXRlKCdibG9nUG9zdCcsIGFQb3N0KTsKICAgIGBgYAoKICAgIE11bHRpcGxlIG1vZGVscyB3aWxsIGJlIGFwcGxpZWQgbGFzdCB0byBmaXJzdCByZWN1cnNpdmVseSB1cCB0aGUKICAgIHJlc291cmNlIHRyZWUuCgogICAgYGBgamF2YXNjcmlwdAogICAgdGhpcy5yZXNvdXJjZSgnYmxvZ1Bvc3QnLCB7cGF0aDonOmJsb2dQb3N0SWQnfSwgZnVuY3Rpb24oKXsKICAgICAgdGhpcy5yZXNvdXJjZSgnYmxvZ0NvbW1lbnQnLCB7cGF0aDogJzpibG9nQ29tbWVudElkJ30pOwogICAgfSk7CgogICAgYUNvbnRyb2xsZXIucmVwbGFjZVJvdXRlKCdibG9nQ29tbWVudCcsIGFQb3N0LCBhQ29tbWVudCk7CiAgICBgYGAKCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSB0aGUgbmFtZSBvZiB0aGUgcm91dGUKICAgIEBwYXJhbSB7Li4uT2JqZWN0fSBtb2RlbHMgdGhlIG1vZGVsKHMpIHRvIGJlIHVzZWQgd2hpbGUgdHJhbnNpdGlvbmluZwogICAgdG8gdGhlIHJvdXRlLgogICAgQGZvciBFbWJlci5Db250cm9sbGVyTWl4aW4KICAgIEBtZXRob2QgcmVwbGFjZVJvdXRlCiAgKi8KICByZXBsYWNlUm91dGU6IGZ1bmN0aW9uKCkgewogICAgLy8gdGFyZ2V0IG1heSBiZSBlaXRoZXIgYW5vdGhlciBjb250cm9sbGVyIG9yIGEgcm91dGVyCiAgICB2YXIgdGFyZ2V0ID0gZ2V0KHRoaXMsICd0YXJnZXQnKSwKICAgICAgICBtZXRob2QgPSB0YXJnZXQucmVwbGFjZVJvdXRlIHx8IHRhcmdldC5yZXBsYWNlV2l0aDsKICAgIHJldHVybiBtZXRob2QuYXBwbHkodGFyZ2V0LCBhcmd1bWVudHMpOwogIH0sCgogIC8qKgogICAgQGRlcHJlY2F0ZWQKICAgIEBmb3IgRW1iZXIuQ29udHJvbGxlck1peGluCiAgICBAbWV0aG9kIHJlcGxhY2VXaXRoCiAgKi8KICByZXBsYWNlV2l0aDogZnVuY3Rpb24oKSB7CiAgICBFbWJlci5kZXByZWNhdGUoInJlcGxhY2VXaXRoIGlzIGRlcHJlY2F0ZWQuIFBsZWFzZSB1c2UgcmVwbGFjZVJvdXRlLiIpOwogICAgcmV0dXJuIHRoaXMucmVwbGFjZVJvdXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfQp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1yb3V0aW5nCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQ7CgpFbWJlci5WaWV3LnJlb3Blbih7CgogIC8qKgogICAgU2V0cyB0aGUgcHJpdmF0ZSBgX291dGxldHNgIG9iamVjdCBvbiB0aGUgdmlldy4KCiAgICBAbWV0aG9kIGluaXQKICAgKi8KICBpbml0OiBmdW5jdGlvbigpIHsKICAgIHNldCh0aGlzLCAnX291dGxldHMnLCB7fSk7CiAgICB0aGlzLl9zdXBlcigpOwogIH0sCgogIC8qKgogICAgTWFudWFsbHkgZmlsbCBhbnkgb2YgYSB2aWV3J3MgYHt7b3V0bGV0fX1gIGFyZWFzIHdpdGggdGhlCiAgICBzdXBwbGllZCB2aWV3LgoKICAgIEV4YW1wbGUKCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgTXlWaWV3ID0gRW1iZXIuVmlldy5leHRlbmQoewogICAgICB0ZW1wbGF0ZTogRW1iZXIuSGFuZGxlYmFycy5jb21waWxlKCdDaGlsZCB2aWV3OiB7e291dGxldCAibWFpbiJ9fSAnKQogICAgfSk7CiAgICB2YXIgbXlWaWV3ID0gTXlWaWV3LmNyZWF0ZSgpOwogICAgbXlWaWV3LmFwcGVuZFRvKCdib2R5Jyk7CiAgICAvLyBUaGUgaHRtbCBmb3IgbXlWaWV3IG5vdyBsb29rcyBsaWtlOgogICAgLy8gPGRpdiBpZD0iZW1iZXIyMjgiIGNsYXNzPSJlbWJlci12aWV3Ij5DaGlsZCB2aWV3OiA8L2Rpdj4KCiAgICB2YXIgRm9vVmlldyA9IEVtYmVyLlZpZXcuZXh0ZW5kKHsKICAgICAgdGVtcGxhdGU6IEVtYmVyLkhhbmRsZWJhcnMuY29tcGlsZSgnPGgxPkZvbzwvaDE+ICcpCiAgICB9KTsKICAgIHZhciBmb29WaWV3ID0gRm9vVmlldy5jcmVhdGUoKTsKICAgIG15Vmlldy5jb25uZWN0T3V0bGV0KCdtYWluJywgZm9vVmlldyk7CiAgICAvLyBUaGUgaHRtbCBmb3IgbXlWaWV3IG5vdyBsb29rcyBsaWtlOgogICAgLy8gPGRpdiBpZD0iZW1iZXIyMjgiIGNsYXNzPSJlbWJlci12aWV3Ij5DaGlsZCB2aWV3OgogICAgLy8gICA8ZGl2IGlkPSJlbWJlcjIzNCIgY2xhc3M9ImVtYmVyLXZpZXciPjxoMT5Gb288L2gxPiA8L2Rpdj4KICAgIC8vIDwvZGl2PgogICAgYGBgCiAgICBAbWV0aG9kIGNvbm5lY3RPdXRsZXQKICAgIEBwYXJhbSAge1N0cmluZ30gb3V0bGV0TmFtZSBBIHVuaXF1ZSBuYW1lIGZvciB0aGUgb3V0bGV0CiAgICBAcGFyYW0gIHtPYmplY3R9IHZpZXcgICAgICAgQW4gRW1iZXIuVmlldwogICAqLwogIGNvbm5lY3RPdXRsZXQ6IGZ1bmN0aW9uKG91dGxldE5hbWUsIHZpZXcpIHsKICAgIGlmICh0aGlzLl9wZW5kaW5nRGlzY29ubmVjdGlvbnMpIHsKICAgICAgZGVsZXRlIHRoaXMuX3BlbmRpbmdEaXNjb25uZWN0aW9uc1tvdXRsZXROYW1lXTsKICAgIH0KCiAgICBpZiAodGhpcy5faGFzRXF1aXZhbGVudFZpZXcob3V0bGV0TmFtZSwgdmlldykpIHsKICAgICAgdmlldy5kZXN0cm95KCk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgb3V0bGV0cyA9IGdldCh0aGlzLCAnX291dGxldHMnKSwKICAgICAgICBjb250YWluZXIgPSBnZXQodGhpcywgJ2NvbnRhaW5lcicpLAogICAgICAgIHJvdXRlciA9IGNvbnRhaW5lciAmJiBjb250YWluZXIubG9va3VwKCdyb3V0ZXI6bWFpbicpLAogICAgICAgIHJlbmRlcmVkTmFtZSA9IGdldCh2aWV3LCAncmVuZGVyZWROYW1lJyk7CgogICAgc2V0KG91dGxldHMsIG91dGxldE5hbWUsIHZpZXcpOwoKICAgIGlmIChyb3V0ZXIgJiYgcmVuZGVyZWROYW1lKSB7CiAgICAgIHJvdXRlci5fY29ubmVjdEFjdGl2ZVZpZXcocmVuZGVyZWROYW1lLCB2aWV3KTsKICAgIH0KICB9LAoKICAvKioKICAgIERldGVybWluZXMgaWYgdGhlIHZpZXcgaGFzIGFscmVhZHkgYmVlbiBjcmVhdGVkIGJ5IGNoZWNraW5nIGlmCiAgICB0aGUgdmlldyBoYXMgdGhlIHNhbWUgY29uc3RydWN0b3IsIHRlbXBsYXRlLCBhbmQgY29udGV4dCBhcyB0aGUKICAgIHZpZXcgaW4gdGhlIGBfb3V0bGV0c2Agb2JqZWN0LgoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIF9oYXNFcXVpdmFsZW50VmlldwogICAgQHBhcmFtICB7U3RyaW5nfSBvdXRsZXROYW1lIFRoZSBuYW1lIG9mIHRoZSBvdXRsZXQgd2UgYXJlIGNoZWNraW5nCiAgICBAcGFyYW0gIHtPYmplY3R9IHZpZXcgICAgICAgQW4gRW1iZXIuVmlldwogICAgQHJldHVybiB7Qm9vbGVhbn0KICAgKi8KICBfaGFzRXF1aXZhbGVudFZpZXc6IGZ1bmN0aW9uKG91dGxldE5hbWUsIHZpZXcpIHsKICAgIHZhciBleGlzdGluZ1ZpZXcgPSBnZXQodGhpcywgJ19vdXRsZXRzLicrb3V0bGV0TmFtZSk7CiAgICByZXR1cm4gZXhpc3RpbmdWaWV3ICYmCiAgICAgIGV4aXN0aW5nVmlldy5jb25zdHJ1Y3RvciA9PT0gdmlldy5jb25zdHJ1Y3RvciAmJgogICAgICBleGlzdGluZ1ZpZXcuZ2V0KCd0ZW1wbGF0ZScpID09PSB2aWV3LmdldCgndGVtcGxhdGUnKSAmJgogICAgICBleGlzdGluZ1ZpZXcuZ2V0KCdjb250ZXh0JykgPT09IHZpZXcuZ2V0KCdjb250ZXh0Jyk7CiAgfSwKCiAgLyoqCiAgICBSZW1vdmVzIGFuIG91dGxldCBmcm9tIHRoZSB2aWV3LgoKICAgIEV4YW1wbGUKCiAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgTXlWaWV3ID0gRW1iZXIuVmlldy5leHRlbmQoewogICAgICB0ZW1wbGF0ZTogRW1iZXIuSGFuZGxlYmFycy5jb21waWxlKCdDaGlsZCB2aWV3OiB7e291dGxldCAibWFpbiJ9fSAnKQogICAgfSk7CiAgICB2YXIgbXlWaWV3ID0gTXlWaWV3LmNyZWF0ZSgpOwogICAgbXlWaWV3LmFwcGVuZFRvKCdib2R5Jyk7CiAgICAvLyBteVZpZXcncyBodG1sOgogICAgLy8gPGRpdiBpZD0iZW1iZXIyMjgiIGNsYXNzPSJlbWJlci12aWV3Ij5DaGlsZCB2aWV3OiA8L2Rpdj4KCiAgICB2YXIgRm9vVmlldyA9IEVtYmVyLlZpZXcuZXh0ZW5kKHsKICAgICAgdGVtcGxhdGU6IEVtYmVyLkhhbmRsZWJhcnMuY29tcGlsZSgnPGgxPkZvbzwvaDE+ICcpCiAgICB9KTsKICAgIHZhciBmb29WaWV3ID0gRm9vVmlldy5jcmVhdGUoKTsKICAgIG15Vmlldy5jb25uZWN0T3V0bGV0KCdtYWluJywgZm9vVmlldyk7CiAgICAvLyBteVZpZXcncyBodG1sOgogICAgLy8gPGRpdiBpZD0iZW1iZXIyMjgiIGNsYXNzPSJlbWJlci12aWV3Ij5DaGlsZCB2aWV3OgogICAgLy8gICA8ZGl2IGlkPSJlbWJlcjIzNCIgY2xhc3M9ImVtYmVyLXZpZXciPjxoMT5Gb288L2gxPiA8L2Rpdj4KICAgIC8vIDwvZGl2PgoKICAgIG15Vmlldy5kaXNjb25uZWN0T3V0bGV0KCdtYWluJyk7CiAgICAvLyBteVZpZXcncyBodG1sOgogICAgLy8gPGRpdiBpZD0iZW1iZXIyMjgiIGNsYXNzPSJlbWJlci12aWV3Ij5DaGlsZCB2aWV3OiA8L2Rpdj4KICAgIGBgYAoKICAgIEBtZXRob2QgZGlzY29ubmVjdE91dGxldAogICAgQHBhcmFtICB7U3RyaW5nfSBvdXRsZXROYW1lIFRoZSBuYW1lIG9mIHRoZSBvdXRsZXQgdG8gYmUgcmVtb3ZlZAogICAqLwogIGRpc2Nvbm5lY3RPdXRsZXQ6IGZ1bmN0aW9uKG91dGxldE5hbWUpIHsKICAgIGlmICghdGhpcy5fcGVuZGluZ0Rpc2Nvbm5lY3Rpb25zKSB7CiAgICAgIHRoaXMuX3BlbmRpbmdEaXNjb25uZWN0aW9ucyA9IHt9OwogICAgfQogICAgdGhpcy5fcGVuZGluZ0Rpc2Nvbm5lY3Rpb25zW291dGxldE5hbWVdID0gdHJ1ZTsKICAgIEVtYmVyLnJ1bi5vbmNlKHRoaXMsICdfZmluaXNoRGlzY29ubmVjdGlvbnMnKTsKICB9LAoKICAvKioKICAgIEdldHMgYW4gb3V0bGV0IHRoYXQgaXMgcGVuZGluZyBkaXNjb25uZWN0aW9uIGFuZCB0aGVuCiAgICBudWxsaWZ5cyB0aGUgb2JqZWN0IG9uIHRoZSBgX291dGxldGAgb2JqZWN0LgoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIF9maW5pc2hEaXNjb25uZWN0aW9ucwogICAqLwogIF9maW5pc2hEaXNjb25uZWN0aW9uczogZnVuY3Rpb24oKSB7CiAgICB2YXIgb3V0bGV0cyA9IGdldCh0aGlzLCAnX291dGxldHMnKTsKICAgIHZhciBwZW5kaW5nRGlzY29ubmVjdGlvbnMgPSB0aGlzLl9wZW5kaW5nRGlzY29ubmVjdGlvbnM7CiAgICB0aGlzLl9wZW5kaW5nRGlzY29ubmVjdGlvbnMgPSBudWxsOwoKICAgIGZvciAodmFyIG91dGxldE5hbWUgaW4gcGVuZGluZ0Rpc2Nvbm5lY3Rpb25zKSB7CiAgICAgIHNldChvdXRsZXRzLCBvdXRsZXROYW1lLCBudWxsKTsKICAgIH0KICB9Cn0pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLXZpZXdzCiovCgovLyBBZGQgYSBuZXcgbmFtZWQgcXVldWUgYWZ0ZXIgdGhlICdhY3Rpb25zJyBxdWV1ZSAod2hlcmUgUlNWUCBwcm9taXNlcwovLyByZXNvbHZlKSwgd2hpY2ggaXMgdXNlZCBpbiByb3V0ZXIgdHJhbnNpdGlvbnMgdG8gcHJldmVudCB1bm5lY2Vzc2FyeQovLyBsb2FkaW5nIHN0YXRlIGVudHJ5IGlmIGFsbCBjb250ZXh0IHByb21pc2VzIHJlc29sdmUgb24gdGhlIAovLyAnYWN0aW9ucycgcXVldWUgZmlyc3QuCgp2YXIgcXVldWVzID0gRW1iZXIucnVuLnF1ZXVlcywKICAgIGluZGV4T2YgPSBFbWJlci5BcnJheVBvbHlmaWxscy5pbmRleE9mOwpxdWV1ZXMuc3BsaWNlKGluZGV4T2YuY2FsbChxdWV1ZXMsICdhY3Rpb25zJykgKyAxLCAwLCAncm91dGVyVHJhbnNpdGlvbnMnKTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1yb3V0aW5nCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQ7CgovKioKICBFbWJlci5Mb2NhdGlvbiByZXR1cm5zIGFuIGluc3RhbmNlIG9mIHRoZSBjb3JyZWN0IGltcGxlbWVudGF0aW9uIG9mCiAgdGhlIGBsb2NhdGlvbmAgQVBJLgoKICAjIyBJbXBsZW1lbnRhdGlvbnMKCiAgWW91IGNhbiBwYXNzIGFuIGltcGxlbWVudGF0aW9uIG5hbWUgKGBoYXNoYCwgYGhpc3RvcnlgLCBgbm9uZWApIHRvIGZvcmNlIGEKICBwYXJ0aWN1bGFyIGltcGxlbWVudGF0aW9uIHRvIGJlIHVzZWQgaW4geW91ciBhcHBsaWNhdGlvbi4KCiAgIyMjIEhhc2hMb2NhdGlvbgoKICBVc2luZyBgSGFzaExvY2F0aW9uYCByZXN1bHRzIGluIFVSTHMgd2l0aCBhIGAjYCAoaGFzaCBzaWduKSBzZXBhcmF0aW5nIHRoZQogIHNlcnZlciBzaWRlIFVSTCBwb3J0aW9uIG9mIHRoZSBVUkwgZnJvbSB0aGUgcG9ydGlvbiB0aGF0IGlzIHVzZWQgYnkgRW1iZXIuCiAgVGhpcyByZWxpZXMgdXBvbiB0aGUgYGhhc2hjaGFuZ2VgIGV2ZW50IGV4aXN0aW5nIGluIHRoZSBicm93c2VyLgoKICBFeGFtcGxlOgoKICBgYGBqYXZhc2NyaXB0CiAgQXBwLlJvdXRlci5tYXAoZnVuY3Rpb24oKSB7CiAgICB0aGlzLnJlc291cmNlKCdwb3N0cycsIGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnJvdXRlKCduZXcnKTsKICAgIH0pOwogIH0pOwoKICBBcHAuUm91dGVyLnJlb3Blbih7CiAgICBsb2NhdGlvbjogJ2hhc2gnCiAgfSk7CiAgYGBgCgogIFRoaXMgd2lsbCByZXN1bHQgaW4gYSBwb3N0cy5uZXcgdXJsIG9mIGAvIy9wb3N0cy9uZXdgLgoKICAjIyMgSGlzdG9yeUxvY2F0aW9uCgogIFVzaW5nIGBIaXN0b3J5TG9jYXRpb25gIHJlc3VsdHMgaW4gVVJMcyB0aGF0IGFyZSBpbmRpc3Rpbmd1aXNoYWJsZSBmcm9tIGEKICBzdGFuZGFyZCBVUkwuIFRoaXMgcmVsaWVzIHVwb24gdGhlIGJyb3dzZXIncyBgaGlzdG9yeWAgQVBJLgoKICBFeGFtcGxlOgoKICBgYGBqYXZhc2NyaXB0CiAgQXBwLlJvdXRlci5tYXAoZnVuY3Rpb24oKSB7CiAgICB0aGlzLnJlc291cmNlKCdwb3N0cycsIGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnJvdXRlKCduZXcnKTsKICAgIH0pOwogIH0pOwoKICBBcHAuUm91dGVyLnJlb3Blbih7CiAgICBsb2NhdGlvbjogJ2hpc3RvcnknCiAgfSk7CiAgYGBgCgogIFRoaXMgd2lsbCByZXN1bHQgaW4gYSBwb3N0cy5uZXcgdXJsIG9mIGAvcG9zdHMvbmV3YC4KCiAgIyMjIE5vbmVMb2NhdGlvbgoKICBVc2luZyBgTm9uZUxvY2F0aW9uYCBjYXVzZXMgRW1iZXIgdG8gbm90IHN0b3JlIHRoZSBhcHBsaWNhdGlvbnMgVVJMIHN0YXRlCiAgaW4gdGhlIGFjdHVhbCBVUkwuIFRoaXMgaXMgZ2VuZXJhbGx5IHVzZWQgZm9yIHRlc3RpbmcgcHVycG9zZXMsIGFuZCBpcyBvbmUKICBvZiB0aGUgY2hhbmdlcyBtYWRlIHdoZW4gY2FsbGluZyBgQXBwLnNldHVwRm9yVGVzdGluZygpYC4KCiAgIyMgTG9jYXRpb24gQVBJCgogIEVhY2ggbG9jYXRpb24gaW1wbGVtZW50YXRpb24gbXVzdCBwcm92aWRlIHRoZSBmb2xsb3dpbmcgbWV0aG9kczoKCiAgKiBpbXBsZW1lbnRhdGlvbjogcmV0dXJucyB0aGUgc3RyaW5nIG5hbWUgdXNlZCB0byByZWZlcmVuY2UgdGhlIGltcGxlbWVudGF0aW9uLgogICogZ2V0VVJMOiByZXR1cm5zIHRoZSBjdXJyZW50IFVSTC4KICAqIHNldFVSTChwYXRoKTogc2V0cyB0aGUgY3VycmVudCBVUkwuCiAgKiByZXBsYWNlVVJMKHBhdGgpOiByZXBsYWNlIHRoZSBjdXJyZW50IFVSTCAob3B0aW9uYWwpLgogICogb25VcGRhdGVVUkwoY2FsbGJhY2spOiB0cmlnZ2VycyB0aGUgY2FsbGJhY2sgd2hlbiB0aGUgVVJMIGNoYW5nZXMuCiAgKiBmb3JtYXRVUkwodXJsKTogZm9ybWF0cyBgdXJsYCB0byBiZSBwbGFjZWQgaW50byBgaHJlZmAgYXR0cmlidXRlLgoKICBDYWxsaW5nIHNldFVSTCBvciByZXBsYWNlVVJMIHdpbGwgbm90IHRyaWdnZXIgb25VcGRhdGVVUkwgY2FsbGJhY2tzLgoKICBAY2xhc3MgTG9jYXRpb24KICBAbmFtZXNwYWNlIEVtYmVyCiAgQHN0YXRpYwoqLwpFbWJlci5Mb2NhdGlvbiA9IHsKICAvKioKICAgVGhpcyBpcyBkZXByZWNhdGVkIGluIGZhdm9yIG9mIHVzaW5nIHRoZSBjb250YWluZXIgdG8gbG9va3VwIHRoZSBsb2NhdGlvbgogICBpbXBsZW1lbnRhdGlvbiBhcyBkZXNpcmVkLgoKICAgRm9yIGV4YW1wbGU6CgogICBgYGBqYXZhc2NyaXB0CiAgIC8vIEdpdmVuIGEgbG9jYXRpb24gcmVnaXN0ZXJlZCBhcyBmb2xsb3dzOgogICBjb250YWluZXIucmVnaXN0ZXIoJ2xvY2F0aW9uOmhpc3RvcnktdGVzdCcsIEhpc3RvcnlUZXN0TG9jYXRpb24pOwoKICAgLy8gWW91IGNvdWxkIGNyZWF0ZSBhIG5ldyBpbnN0YW5jZSB2aWE6CiAgIGNvbnRhaW5lci5sb29rdXAoJ2xvY2F0aW9uOmhpc3RvcnktdGVzdCcpOwogICBgYGAKCiAgICBAbWV0aG9kIGNyZWF0ZQogICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgIEByZXR1cm4ge09iamVjdH0gYW4gaW5zdGFuY2Ugb2YgYW4gaW1wbGVtZW50YXRpb24gb2YgdGhlIGBsb2NhdGlvbmAgQVBJCiAgICBAZGVwcmVjYXRlZCBVc2UgdGhlIGNvbnRhaW5lciB0byBsb29rdXAgdGhlIGxvY2F0aW9uIGltcGxlbWVudGF0aW9uIHRoYXQgeW91CiAgICBuZWVkLgogICovCiAgY3JlYXRlOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB2YXIgaW1wbGVtZW50YXRpb24gPSBvcHRpb25zICYmIG9wdGlvbnMuaW1wbGVtZW50YXRpb247CiAgICBFbWJlci5hc3NlcnQoIkVtYmVyLkxvY2F0aW9uLmNyZWF0ZTogeW91IG11c3Qgc3BlY2lmeSBhICdpbXBsZW1lbnRhdGlvbicgb3B0aW9uIiwgISFpbXBsZW1lbnRhdGlvbik7CgogICAgdmFyIGltcGxlbWVudGF0aW9uQ2xhc3MgPSB0aGlzLmltcGxlbWVudGF0aW9uc1tpbXBsZW1lbnRhdGlvbl07CiAgICBFbWJlci5hc3NlcnQoIkVtYmVyLkxvY2F0aW9uLmNyZWF0ZTogIiArIGltcGxlbWVudGF0aW9uICsgIiBpcyBub3QgYSB2YWxpZCBpbXBsZW1lbnRhdGlvbiIsICEhaW1wbGVtZW50YXRpb25DbGFzcyk7CgogICAgcmV0dXJuIGltcGxlbWVudGF0aW9uQ2xhc3MuY3JlYXRlLmFwcGx5KGltcGxlbWVudGF0aW9uQ2xhc3MsIGFyZ3VtZW50cyk7CiAgfSwKCiAgLyoqCiAgIFRoaXMgaXMgZGVwcmVjYXRlZCBpbiBmYXZvciBvZiB1c2luZyB0aGUgY29udGFpbmVyIHRvIHJlZ2lzdGVyIHRoZQogICBsb2NhdGlvbiBpbXBsZW1lbnRhdGlvbiBhcyBkZXNpcmVkLgoKICAgRXhhbXBsZToKCiAgIGBgYGphdmFzY3JpcHQKICAgQXBwbGljYXRpb24uaW5pdGlhbGl6ZXIoewogICAgbmFtZTogImhpc3RvcnktdGVzdC1sb2NhdGlvbiIsCgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oY29udGFpbmVyLCBhcHBsaWNhdGlvbikgewogICAgICBhcHBsaWNhdGlvbi5yZWdpc3RlcignbG9jYXRpb246aGlzdG9yeS10ZXN0JywgSGlzdG9yeVRlc3RMb2NhdGlvbik7CiAgICB9CiAgIH0pOwogICBgYGAKCiAgIEBtZXRob2QgcmVnaXN0ZXJJbXBsZW1lbnRhdGlvbgogICBAcGFyYW0ge1N0cmluZ30gbmFtZQogICBAcGFyYW0ge09iamVjdH0gaW1wbGVtZW50YXRpb24gb2YgdGhlIGBsb2NhdGlvbmAgQVBJCiAgIEBkZXByZWNhdGVkIFJlZ2lzdGVyIHlvdXIgY3VzdG9tIGxvY2F0aW9uIGltcGxlbWVudGF0aW9uIHdpdGggdGhlCiAgIGNvbnRhaW5lciBkaXJlY3RseS4KICAqLwogIHJlZ2lzdGVySW1wbGVtZW50YXRpb246IGZ1bmN0aW9uKG5hbWUsIGltcGxlbWVudGF0aW9uKSB7CiAgICB0aGlzLmltcGxlbWVudGF0aW9uc1tuYW1lXSA9IGltcGxlbWVudGF0aW9uOwogIH0sCgogIGltcGxlbWVudGF0aW9uczoge30KfTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1yb3V0aW5nCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQ7CgovKioKICBFbWJlci5Ob25lTG9jYXRpb24gZG9lcyBub3QgaW50ZXJhY3Qgd2l0aCB0aGUgYnJvd3Nlci4gSXQgaXMgdXNlZnVsIGZvcgogIHRlc3RpbmcsIG9yIHdoZW4geW91IG5lZWQgdG8gbWFuYWdlIHN0YXRlIHdpdGggeW91ciBSb3V0ZXIsIGJ1dCB0ZW1wb3JhcmlseQogIGRvbid0IHdhbnQgaXQgdG8gbXVjayB3aXRoIHRoZSBVUkwgKGZvciBleGFtcGxlIHdoZW4geW91IGVtYmVkIHlvdXIKICBhcHBsaWNhdGlvbiBpbiBhIGxhcmdlciBwYWdlKS4KCiAgQGNsYXNzIE5vbmVMb2NhdGlvbgogIEBuYW1lc3BhY2UgRW1iZXIKICBAZXh0ZW5kcyBFbWJlci5PYmplY3QKKi8KRW1iZXIuTm9uZUxvY2F0aW9uID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CiAgcGF0aDogJycsCgogIC8qKgogICAgUmV0dXJucyB0aGUgY3VycmVudCBwYXRoLgoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIGdldFVSTAogICAgQHJldHVybiB7U3RyaW5nfSBwYXRoCiAgKi8KICBnZXRVUkw6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGdldCh0aGlzLCAncGF0aCcpOwogIH0sCgogIC8qKgogICAgU2V0IHRoZSBwYXRoIGFuZCByZW1lbWJlcnMgd2hhdCB3YXMgc2V0LiBVc2luZyB0aGlzIG1ldGhvZAogICAgdG8gY2hhbmdlIHRoZSBwYXRoIHdpbGwgbm90IGludm9rZSB0aGUgYHVwZGF0ZVVSTGAgY2FsbGJhY2suCgogICAgQHByaXZhdGUKICAgIEBtZXRob2Qgc2V0VVJMCiAgICBAcGFyYW0gcGF0aCB7U3RyaW5nfQogICovCiAgc2V0VVJMOiBmdW5jdGlvbihwYXRoKSB7CiAgICBzZXQodGhpcywgJ3BhdGgnLCBwYXRoKTsKICB9LAoKICAvKioKICAgIFJlZ2lzdGVyIGEgY2FsbGJhY2sgdG8gYmUgaW52b2tlZCB3aGVuIHRoZSBwYXRoIGNoYW5nZXMuIFRoZXNlCiAgICBjYWxsYmFja3Mgd2lsbCBleGVjdXRlIHdoZW4gdGhlIHVzZXIgcHJlc3NlcyB0aGUgYmFjayBvciBmb3J3YXJkCiAgICBidXR0b24sIGJ1dCBub3QgYWZ0ZXIgYHNldFVSTGAgaXMgaW52b2tlZC4KCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBvblVwZGF0ZVVSTAogICAgQHBhcmFtIGNhbGxiYWNrIHtGdW5jdGlvbn0KICAqLwogIG9uVXBkYXRlVVJMOiBmdW5jdGlvbihjYWxsYmFjaykgewogICAgdGhpcy51cGRhdGVDYWxsYmFjayA9IGNhbGxiYWNrOwogIH0sCgogIC8qKgogICAgU2V0cyB0aGUgcGF0aCBhbmQgY2FsbHMgdGhlIGB1cGRhdGVVUkxgIGNhbGxiYWNrLgoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIGhhbmRsZVVSTAogICAgQHBhcmFtIGNhbGxiYWNrIHtGdW5jdGlvbn0KICAqLwogIGhhbmRsZVVSTDogZnVuY3Rpb24odXJsKSB7CiAgICBzZXQodGhpcywgJ3BhdGgnLCB1cmwpOwogICAgdGhpcy51cGRhdGVDYWxsYmFjayh1cmwpOwogIH0sCgogIC8qKgogICAgR2l2ZW4gYSBVUkwsIGZvcm1hdHMgaXQgdG8gYmUgcGxhY2VkIGludG8gdGhlIHBhZ2UgYXMgcGFydAogICAgb2YgYW4gZWxlbWVudCdzIGBocmVmYCBhdHRyaWJ1dGUuCgogICAgVGhpcyBpcyB1c2VkLCBmb3IgZXhhbXBsZSwgd2hlbiB1c2luZyB0aGUge3thY3Rpb259fSBoZWxwZXIKICAgIHRvIGdlbmVyYXRlIGEgVVJMIGJhc2VkIG9uIGFuIGV2ZW50LgoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIGZvcm1hdFVSTAogICAgQHBhcmFtIHVybCB7U3RyaW5nfQogICAgQHJldHVybiB7U3RyaW5nfSB1cmwKICAqLwogIGZvcm1hdFVSTDogZnVuY3Rpb24odXJsKSB7CiAgICAvLyBUaGUgcmV0dXJuIHZhbHVlIGlzIG5vdCBvdmVybHkgbWVhbmluZ2Z1bCwgYnV0IHdlIGRvIG5vdCB3YW50IHRvIHRocm93CiAgICAvLyBlcnJvcnMgd2hlbiB0ZXN0IGNvZGUgcmVuZGVycyB0ZW1wbGF0ZXMgY29udGFpbmluZyB7e2FjdGlvbiBocmVmPXRydWV9fQogICAgLy8gaGVscGVycy4KICAgIHJldHVybiB1cmw7CiAgfQp9KTsKCkVtYmVyLkxvY2F0aW9uLnJlZ2lzdGVySW1wbGVtZW50YXRpb24oJ25vbmUnLCBFbWJlci5Ob25lTG9jYXRpb24pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLXJvdXRpbmcKKi8KCnZhciBnZXQgPSBFbWJlci5nZXQsIHNldCA9IEVtYmVyLnNldDsKCi8qKgogIGBFbWJlci5IYXNoTG9jYXRpb25gIGltcGxlbWVudHMgdGhlIGxvY2F0aW9uIEFQSSB1c2luZyB0aGUgYnJvd3NlcidzCiAgaGFzaC4gQXQgcHJlc2VudCwgaXQgcmVsaWVzIG9uIGEgYGhhc2hjaGFuZ2VgIGV2ZW50IGV4aXN0aW5nIGluIHRoZQogIGJyb3dzZXIuCgogIEBjbGFzcyBIYXNoTG9jYXRpb24KICBAbmFtZXNwYWNlIEVtYmVyCiAgQGV4dGVuZHMgRW1iZXIuT2JqZWN0CiovCkVtYmVyLkhhc2hMb2NhdGlvbiA9IEVtYmVyLk9iamVjdC5leHRlbmQoewoKICBpbml0OiBmdW5jdGlvbigpIHsKICAgIHNldCh0aGlzLCAnbG9jYXRpb24nLCBnZXQodGhpcywgJ2xvY2F0aW9uJykgfHwgd2luZG93LmxvY2F0aW9uKTsKICB9LAoKICAvKioKICAgIFJldHVybnMgdGhlIGN1cnJlbnQgYGxvY2F0aW9uLmhhc2hgLCBtaW51cyB0aGUgJyMnIGF0IHRoZSBmcm9udC4KCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBnZXRVUkwKICAqLwogIGdldFVSTDogZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gRGVmYXVsdCBpbXBsZW1lbnRhdGlvbiB3aXRob3V0IGZlYXR1cmUgZmxhZyBlbmFibGVkCiAgICByZXR1cm4gZ2V0KHRoaXMsICdsb2NhdGlvbicpLmhhc2guc3Vic3RyKDEpOwogIH0sCgogIC8qKgogICAgU2V0IHRoZSBgbG9jYXRpb24uaGFzaGAgYW5kIHJlbWVtYmVycyB3aGF0IHdhcyBzZXQuIFRoaXMgcHJldmVudHMKICAgIGBvblVwZGF0ZVVSTGAgY2FsbGJhY2tzIGZyb20gdHJpZ2dlcmluZyB3aGVuIHRoZSBoYXNoIHdhcyBzZXQgYnkKICAgIGBIYXNoTG9jYXRpb25gLgoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIHNldFVSTAogICAgQHBhcmFtIHBhdGgge1N0cmluZ30KICAqLwogIHNldFVSTDogZnVuY3Rpb24ocGF0aCkgewogICAgZ2V0KHRoaXMsICdsb2NhdGlvbicpLmhhc2ggPSBwYXRoOwogICAgc2V0KHRoaXMsICdsYXN0U2V0VVJMJywgcGF0aCk7CiAgfSwKCiAgLyoqCiAgICBVc2VzIGxvY2F0aW9uLnJlcGxhY2UgdG8gdXBkYXRlIHRoZSB1cmwgd2l0aG91dCBhIHBhZ2UgcmVsb2FkCiAgICBvciBoaXN0b3J5IG1vZGlmaWNhdGlvbi4KCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCByZXBsYWNlVVJMCiAgICBAcGFyYW0gcGF0aCB7U3RyaW5nfQogICovCiAgcmVwbGFjZVVSTDogZnVuY3Rpb24ocGF0aCkgewogICAgZ2V0KHRoaXMsICdsb2NhdGlvbicpLnJlcGxhY2UoJyMnICsgcGF0aCk7CiAgfSwKCiAgLyoqCiAgICBSZWdpc3RlciBhIGNhbGxiYWNrIHRvIGJlIGludm9rZWQgd2hlbiB0aGUgaGFzaCBjaGFuZ2VzLiBUaGVzZQogICAgY2FsbGJhY2tzIHdpbGwgZXhlY3V0ZSB3aGVuIHRoZSB1c2VyIHByZXNzZXMgdGhlIGJhY2sgb3IgZm9yd2FyZAogICAgYnV0dG9uLCBidXQgbm90IGFmdGVyIGBzZXRVUkxgIGlzIGludm9rZWQuCgogICAgQHByaXZhdGUKICAgIEBtZXRob2Qgb25VcGRhdGVVUkwKICAgIEBwYXJhbSBjYWxsYmFjayB7RnVuY3Rpb259CiAgKi8KICBvblVwZGF0ZVVSTDogZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBndWlkID0gRW1iZXIuZ3VpZEZvcih0aGlzKTsKCiAgICBFbWJlci4kKHdpbmRvdykub24oJ2hhc2hjaGFuZ2UuZW1iZXItbG9jYXRpb24tJytndWlkLCBmdW5jdGlvbigpIHsKICAgICAgRW1iZXIucnVuKGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBwYXRoID0gbG9jYXRpb24uaGFzaC5zdWJzdHIoMSk7CiAgICAgICAgaWYgKGdldChzZWxmLCAnbGFzdFNldFVSTCcpID09PSBwYXRoKSB7IHJldHVybjsgfQoKICAgICAgICBzZXQoc2VsZiwgJ2xhc3RTZXRVUkwnLCBudWxsKTsKCiAgICAgICAgY2FsbGJhY2socGF0aCk7CiAgICAgIH0pOwogICAgfSk7CiAgfSwKCiAgLyoqCiAgICBHaXZlbiBhIFVSTCwgZm9ybWF0cyBpdCB0byBiZSBwbGFjZWQgaW50byB0aGUgcGFnZSBhcyBwYXJ0CiAgICBvZiBhbiBlbGVtZW50J3MgYGhyZWZgIGF0dHJpYnV0ZS4KCiAgICBUaGlzIGlzIHVzZWQsIGZvciBleGFtcGxlLCB3aGVuIHVzaW5nIHRoZSB7e2FjdGlvbn19IGhlbHBlcgogICAgdG8gZ2VuZXJhdGUgYSBVUkwgYmFzZWQgb24gYW4gZXZlbnQuCgogICAgQHByaXZhdGUKICAgIEBtZXRob2QgZm9ybWF0VVJMCiAgICBAcGFyYW0gdXJsIHtTdHJpbmd9CiAgKi8KICBmb3JtYXRVUkw6IGZ1bmN0aW9uKHVybCkgewogICAgcmV0dXJuICcjJyt1cmw7CiAgfSwKCiAgLyoqCiAgICBDbGVhbnMgdXAgdGhlIEhhc2hMb2NhdGlvbiBldmVudCBsaXN0ZW5lci4KCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCB3aWxsRGVzdHJveQogICovCiAgd2lsbERlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgdmFyIGd1aWQgPSBFbWJlci5ndWlkRm9yKHRoaXMpOwoKICAgIEVtYmVyLiQod2luZG93KS5vZmYoJ2hhc2hjaGFuZ2UuZW1iZXItbG9jYXRpb24tJytndWlkKTsKICB9Cn0pOwoKRW1iZXIuTG9jYXRpb24ucmVnaXN0ZXJJbXBsZW1lbnRhdGlvbignaGFzaCcsIEVtYmVyLkhhc2hMb2NhdGlvbik7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItcm91dGluZwoqLwoKdmFyIGdldCA9IEVtYmVyLmdldCwgc2V0ID0gRW1iZXIuc2V0Owp2YXIgcG9wc3RhdGVGaXJlZCA9IGZhbHNlOwp2YXIgc3VwcG9ydHNIaXN0b3J5U3RhdGUgPSB3aW5kb3cuaGlzdG9yeSAmJiAnc3RhdGUnIGluIHdpbmRvdy5oaXN0b3J5OwoKLyoqCiAgRW1iZXIuSGlzdG9yeUxvY2F0aW9uIGltcGxlbWVudHMgdGhlIGxvY2F0aW9uIEFQSSB1c2luZyB0aGUgYnJvd3NlcidzCiAgaGlzdG9yeS5wdXNoU3RhdGUgQVBJLgoKICBAY2xhc3MgSGlzdG9yeUxvY2F0aW9uCiAgQG5hbWVzcGFjZSBFbWJlcgogIEBleHRlbmRzIEVtYmVyLk9iamVjdAoqLwpFbWJlci5IaXN0b3J5TG9jYXRpb24gPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKCiAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICBzZXQodGhpcywgJ2xvY2F0aW9uJywgZ2V0KHRoaXMsICdsb2NhdGlvbicpIHx8IHdpbmRvdy5sb2NhdGlvbik7CiAgfSwKCiAgLyoqCiAgICBVc2VkIHRvIHNldCBzdGF0ZSBvbiBmaXJzdCBjYWxsIHRvIHNldFVSTAoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIGluaXRTdGF0ZQogICovCiAgaW5pdFN0YXRlOiBmdW5jdGlvbigpIHsKICAgIHNldCh0aGlzLCAnaGlzdG9yeScsIGdldCh0aGlzLCAnaGlzdG9yeScpIHx8IHdpbmRvdy5oaXN0b3J5KTsKICAgIHRoaXMucmVwbGFjZVN0YXRlKHRoaXMuZm9ybWF0VVJMKHRoaXMuZ2V0VVJMKCkpKTsKICB9LAoKICAvKioKICAgIFdpbGwgYmUgcHJlLXBlbmRlZCB0byBwYXRoIHVwb24gc3RhdGUgY2hhbmdlCgogICAgQHByb3BlcnR5IHJvb3RVUkwKICAgIEBkZWZhdWx0ICcvJwogICovCiAgcm9vdFVSTDogJy8nLAoKICAvKioKICAgIFJldHVybnMgdGhlIGN1cnJlbnQgYGxvY2F0aW9uLnBhdGhuYW1lYCB3aXRob3V0IGByb290VVJMYC4KCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBnZXRVUkwKICAgIEByZXR1cm4gdXJsIHtTdHJpbmd9CiAgKi8KICBnZXRVUkw6IGZ1bmN0aW9uKCkgewogICAgdmFyIHJvb3RVUkwgPSBnZXQodGhpcywgJ3Jvb3RVUkwnKSwKICAgICAgICBsb2NhdGlvbiA9IGdldCh0aGlzLCAnbG9jYXRpb24nKSwKICAgICAgICBwYXRoID0gbG9jYXRpb24ucGF0aG5hbWU7CgogICAgcm9vdFVSTCA9IHJvb3RVUkwucmVwbGFjZSgvXC8kLywgJycpOwogICAgdmFyIHVybCA9IHBhdGgucmVwbGFjZShyb290VVJMLCAnJyk7CgogICAgCiAgICByZXR1cm4gdXJsOwogIH0sCgogIC8qKgogICAgVXNlcyBgaGlzdG9yeS5wdXNoU3RhdGVgIHRvIHVwZGF0ZSB0aGUgdXJsIHdpdGhvdXQgYSBwYWdlIHJlbG9hZC4KCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBzZXRVUkwKICAgIEBwYXJhbSBwYXRoIHtTdHJpbmd9CiAgKi8KICBzZXRVUkw6IGZ1bmN0aW9uKHBhdGgpIHsKICAgIHZhciBzdGF0ZSA9IHRoaXMuZ2V0U3RhdGUoKTsKICAgIHBhdGggPSB0aGlzLmZvcm1hdFVSTChwYXRoKTsKCiAgICBpZiAoc3RhdGUgJiYgc3RhdGUucGF0aCAhPT0gcGF0aCkgewogICAgICB0aGlzLnB1c2hTdGF0ZShwYXRoKTsKICAgIH0KICB9LAoKICAvKioKICAgIFVzZXMgYGhpc3RvcnkucmVwbGFjZVN0YXRlYCB0byB1cGRhdGUgdGhlIHVybCB3aXRob3V0IGEgcGFnZSByZWxvYWQKICAgIG9yIGhpc3RvcnkgbW9kaWZpY2F0aW9uLgoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIHJlcGxhY2VVUkwKICAgIEBwYXJhbSBwYXRoIHtTdHJpbmd9CiAgKi8KICByZXBsYWNlVVJMOiBmdW5jdGlvbihwYXRoKSB7CiAgICB2YXIgc3RhdGUgPSB0aGlzLmdldFN0YXRlKCk7CiAgICBwYXRoID0gdGhpcy5mb3JtYXRVUkwocGF0aCk7CgogICAgaWYgKHN0YXRlICYmIHN0YXRlLnBhdGggIT09IHBhdGgpIHsKICAgICAgdGhpcy5yZXBsYWNlU3RhdGUocGF0aCk7CiAgICB9CiAgfSwKCiAgLyoqCiAgIEdldCB0aGUgY3VycmVudCBgaGlzdG9yeS5zdGF0ZWAKICAgUG9seWZpbGwgY2hlY2tzIGZvciBuYXRpdmUgYnJvd3NlciBzdXBwb3J0IGFuZCBmYWxscyBiYWNrIHRvIHJldHJpZXZpbmcKICAgZnJvbSBhIHByaXZhdGUgX2hpc3RvcnlTdGF0ZSB2YXJpYWJsZQoKICAgQHByaXZhdGUKICAgQG1ldGhvZCBnZXRTdGF0ZQogICBAcmV0dXJuIHN0YXRlIHtPYmplY3R9CiAgKi8KICBnZXRTdGF0ZTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gc3VwcG9ydHNIaXN0b3J5U3RhdGUgPyBnZXQodGhpcywgJ2hpc3RvcnknKS5zdGF0ZSA6IHRoaXMuX2hpc3RvcnlTdGF0ZTsKICB9LAoKICAvKioKICAgUHVzaGVzIGEgbmV3IHN0YXRlLgoKICAgQHByaXZhdGUKICAgQG1ldGhvZCBwdXNoU3RhdGUKICAgQHBhcmFtIHBhdGgge1N0cmluZ30KICAqLwogIHB1c2hTdGF0ZTogZnVuY3Rpb24ocGF0aCkgewogICAgdmFyIHN0YXRlID0geyBwYXRoOiBwYXRoIH07CgogICAgZ2V0KHRoaXMsICdoaXN0b3J5JykucHVzaFN0YXRlKHN0YXRlLCBudWxsLCBwYXRoKTsKCiAgICAvLyBzdG9yZSBzdGF0ZSBpZiBicm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCBgaGlzdG9yeS5zdGF0ZWAKICAgIGlmICghc3VwcG9ydHNIaXN0b3J5U3RhdGUpIHsKICAgICAgdGhpcy5faGlzdG9yeVN0YXRlID0gc3RhdGU7CiAgICB9CgogICAgLy8gdXNlZCBmb3Igd2Via2l0IHdvcmthcm91bmQKICAgIHRoaXMuX3ByZXZpb3VzVVJMID0gdGhpcy5nZXRVUkwoKTsKICB9LAoKICAvKioKICAgUmVwbGFjZXMgdGhlIGN1cnJlbnQgc3RhdGUuCgogICBAcHJpdmF0ZQogICBAbWV0aG9kIHJlcGxhY2VTdGF0ZQogICBAcGFyYW0gcGF0aCB7U3RyaW5nfQogICovCiAgcmVwbGFjZVN0YXRlOiBmdW5jdGlvbihwYXRoKSB7CiAgICB2YXIgc3RhdGUgPSB7IHBhdGg6IHBhdGggfTsKCiAgICBnZXQodGhpcywgJ2hpc3RvcnknKS5yZXBsYWNlU3RhdGUoc3RhdGUsIG51bGwsIHBhdGgpOwoKICAgIC8vIHN0b3JlIHN0YXRlIGlmIGJyb3dzZXIgZG9lc24ndCBzdXBwb3J0IGBoaXN0b3J5LnN0YXRlYAogICAgaWYgKCFzdXBwb3J0c0hpc3RvcnlTdGF0ZSkgewogICAgICB0aGlzLl9oaXN0b3J5U3RhdGUgPSBzdGF0ZTsKICAgIH0KCiAgICAvLyB1c2VkIGZvciB3ZWJraXQgd29ya2Fyb3VuZAogICAgdGhpcy5fcHJldmlvdXNVUkwgPSB0aGlzLmdldFVSTCgpOwogIH0sCgogIC8qKgogICAgUmVnaXN0ZXIgYSBjYWxsYmFjayB0byBiZSBpbnZva2VkIHdoZW5ldmVyIHRoZSBicm93c2VyCiAgICBoaXN0b3J5IGNoYW5nZXMsIGluY2x1ZGluZyB1c2luZyBmb3J3YXJkIGFuZCBiYWNrIGJ1dHRvbnMuCgogICAgQHByaXZhdGUKICAgIEBtZXRob2Qgb25VcGRhdGVVUkwKICAgIEBwYXJhbSBjYWxsYmFjayB7RnVuY3Rpb259CiAgKi8KICBvblVwZGF0ZVVSTDogZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgIHZhciBndWlkID0gRW1iZXIuZ3VpZEZvcih0aGlzKSwKICAgICAgICBzZWxmID0gdGhpczsKCiAgICBFbWJlci4kKHdpbmRvdykub24oJ3BvcHN0YXRlLmVtYmVyLWxvY2F0aW9uLScrZ3VpZCwgZnVuY3Rpb24oZSkgewogICAgICAvLyBJZ25vcmUgaW5pdGlhbCBwYWdlIGxvYWQgcG9wc3RhdGUgZXZlbnQgaW4gQ2hyb21lCiAgICAgIGlmICghcG9wc3RhdGVGaXJlZCkgewogICAgICAgIHBvcHN0YXRlRmlyZWQgPSB0cnVlOwogICAgICAgIGlmIChzZWxmLmdldFVSTCgpID09PSBzZWxmLl9wcmV2aW91c1VSTCkgeyByZXR1cm47IH0KICAgICAgfQogICAgICBjYWxsYmFjayhzZWxmLmdldFVSTCgpKTsKICAgIH0pOwogIH0sCgogIC8qKgogICAgVXNlZCB3aGVuIHVzaW5nIGB7e2FjdGlvbn19YCBoZWxwZXIuICBUaGUgdXJsIGlzIGFsd2F5cyBhcHBlbmRlZCB0byB0aGUgcm9vdFVSTC4KCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBmb3JtYXRVUkwKICAgIEBwYXJhbSB1cmwge1N0cmluZ30KICAgIEByZXR1cm4gZm9ybWF0dGVkIHVybCB7U3RyaW5nfQogICovCiAgZm9ybWF0VVJMOiBmdW5jdGlvbih1cmwpIHsKICAgIHZhciByb290VVJMID0gZ2V0KHRoaXMsICdyb290VVJMJyk7CgogICAgaWYgKHVybCAhPT0gJycpIHsKICAgICAgcm9vdFVSTCA9IHJvb3RVUkwucmVwbGFjZSgvXC8kLywgJycpOwogICAgfQoKICAgIHJldHVybiByb290VVJMICsgdXJsOwogIH0sCgogIC8qKgogICAgQ2xlYW5zIHVwIHRoZSBIaXN0b3J5TG9jYXRpb24gZXZlbnQgbGlzdGVuZXIuCgogICAgQHByaXZhdGUKICAgIEBtZXRob2Qgd2lsbERlc3Ryb3kKICAqLwogIHdpbGxEZXN0cm95OiBmdW5jdGlvbigpIHsKICAgIHZhciBndWlkID0gRW1iZXIuZ3VpZEZvcih0aGlzKTsKCiAgICBFbWJlci4kKHdpbmRvdykub2ZmKCdwb3BzdGF0ZS5lbWJlci1sb2NhdGlvbi0nK2d1aWQpOwogIH0KfSk7CgpFbWJlci5Mb2NhdGlvbi5yZWdpc3RlckltcGxlbWVudGF0aW9uKCdoaXN0b3J5JywgRW1iZXIuSGlzdG9yeUxvY2F0aW9uKTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkVtYmVyIFJvdXRpbmcKCkBtb2R1bGUgZW1iZXIKQHN1Ym1vZHVsZSBlbWJlci1yb3V0aW5nCkByZXF1aXJlcyBlbWJlci12aWV3cwoqLwoKfSkoKTsKCihmdW5jdGlvbigpIHsKZnVuY3Rpb24gdmlzaXQodmVydGV4LCBmbiwgdmlzaXRlZCwgcGF0aCkgewogIHZhciBuYW1lID0gdmVydGV4Lm5hbWUsCiAgICB2ZXJ0aWNlcyA9IHZlcnRleC5pbmNvbWluZywKICAgIG5hbWVzID0gdmVydGV4LmluY29taW5nTmFtZXMsCiAgICBsZW4gPSBuYW1lcy5sZW5ndGgsCiAgICBpOwogIGlmICghdmlzaXRlZCkgewogICAgdmlzaXRlZCA9IHt9OwogIH0KICBpZiAoIXBhdGgpIHsKICAgIHBhdGggPSBbXTsKICB9CiAgaWYgKHZpc2l0ZWQuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgIHJldHVybjsKICB9CiAgcGF0aC5wdXNoKG5hbWUpOwogIHZpc2l0ZWRbbmFtZV0gPSB0cnVlOwogIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgdmlzaXQodmVydGljZXNbbmFtZXNbaV1dLCBmbiwgdmlzaXRlZCwgcGF0aCk7CiAgfQogIGZuKHZlcnRleCwgcGF0aCk7CiAgcGF0aC5wb3AoKTsKfQoKZnVuY3Rpb24gREFHKCkgewogIHRoaXMubmFtZXMgPSBbXTsKICB0aGlzLnZlcnRpY2VzID0ge307Cn0KCkRBRy5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24obmFtZSkgewogIGlmICghbmFtZSkgeyByZXR1cm47IH0KICBpZiAodGhpcy52ZXJ0aWNlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgcmV0dXJuIHRoaXMudmVydGljZXNbbmFtZV07CiAgfQogIHZhciB2ZXJ0ZXggPSB7CiAgICBuYW1lOiBuYW1lLCBpbmNvbWluZzoge30sIGluY29taW5nTmFtZXM6IFtdLCBoYXNPdXRnb2luZzogZmFsc2UsIHZhbHVlOiBudWxsCiAgfTsKICB0aGlzLnZlcnRpY2VzW25hbWVdID0gdmVydGV4OwogIHRoaXMubmFtZXMucHVzaChuYW1lKTsKICByZXR1cm4gdmVydGV4Owp9OwoKREFHLnByb3RvdHlwZS5tYXAgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogIHRoaXMuYWRkKG5hbWUpLnZhbHVlID0gdmFsdWU7Cn07CgpEQUcucHJvdG90eXBlLmFkZEVkZ2UgPSBmdW5jdGlvbihmcm9tTmFtZSwgdG9OYW1lKSB7CiAgaWYgKCFmcm9tTmFtZSB8fCAhdG9OYW1lIHx8IGZyb21OYW1lID09PSB0b05hbWUpIHsKICAgIHJldHVybjsKICB9CiAgdmFyIGZyb20gPSB0aGlzLmFkZChmcm9tTmFtZSksIHRvID0gdGhpcy5hZGQodG9OYW1lKTsKICBpZiAodG8uaW5jb21pbmcuaGFzT3duUHJvcGVydHkoZnJvbU5hbWUpKSB7CiAgICByZXR1cm47CiAgfQogIGZ1bmN0aW9uIGNoZWNrQ3ljbGUodmVydGV4LCBwYXRoKSB7CiAgICBpZiAodmVydGV4Lm5hbWUgPT09IHRvTmFtZSkgewogICAgICB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoImN5Y2xlIGRldGVjdGVkOiAiICsgdG9OYW1lICsgIiA8LSAiICsgcGF0aC5qb2luKCIgPC0gIikpOwogICAgfQogIH0KICB2aXNpdChmcm9tLCBjaGVja0N5Y2xlKTsKICBmcm9tLmhhc091dGdvaW5nID0gdHJ1ZTsKICB0by5pbmNvbWluZ1tmcm9tTmFtZV0gPSBmcm9tOwogIHRvLmluY29taW5nTmFtZXMucHVzaChmcm9tTmFtZSk7Cn07CgpEQUcucHJvdG90eXBlLnRvcHNvcnQgPSBmdW5jdGlvbihmbikgewogIHZhciB2aXNpdGVkID0ge30sCiAgICB2ZXJ0aWNlcyA9IHRoaXMudmVydGljZXMsCiAgICBuYW1lcyA9IHRoaXMubmFtZXMsCiAgICBsZW4gPSBuYW1lcy5sZW5ndGgsCiAgICBpLCB2ZXJ0ZXg7CiAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICB2ZXJ0ZXggPSB2ZXJ0aWNlc1tuYW1lc1tpXV07CiAgICBpZiAoIXZlcnRleC5oYXNPdXRnb2luZykgewogICAgICB2aXNpdCh2ZXJ0ZXgsIGZuLCB2aXNpdGVkKTsKICAgIH0KICB9Cn07CgpEQUcucHJvdG90eXBlLmFkZEVkZ2VzID0gZnVuY3Rpb24obmFtZSwgdmFsdWUsIGJlZm9yZSwgYWZ0ZXIpIHsKICB2YXIgaTsKICB0aGlzLm1hcChuYW1lLCB2YWx1ZSk7CiAgaWYgKGJlZm9yZSkgewogICAgaWYgKHR5cGVvZiBiZWZvcmUgPT09ICdzdHJpbmcnKSB7CiAgICAgIHRoaXMuYWRkRWRnZShuYW1lLCBiZWZvcmUpOwogICAgfSBlbHNlIHsKICAgICAgZm9yIChpID0gMDsgaSA8IGJlZm9yZS5sZW5ndGg7IGkrKykgewogICAgICAgIHRoaXMuYWRkRWRnZShuYW1lLCBiZWZvcmVbaV0pOwogICAgICB9CiAgICB9CiAgfQogIGlmIChhZnRlcikgewogICAgaWYgKHR5cGVvZiBhZnRlciA9PT0gJ3N0cmluZycpIHsKICAgICAgdGhpcy5hZGRFZGdlKGFmdGVyLCBuYW1lKTsKICAgIH0gZWxzZSB7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBhZnRlci5sZW5ndGg7IGkrKykgewogICAgICAgIHRoaXMuYWRkRWRnZShhZnRlcltpXSwgbmFtZSk7CiAgICAgIH0KICAgIH0KICB9Cn07CgpFbWJlci5EQUcgPSBEQUc7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItYXBwbGljYXRpb24KKi8KCnZhciBnZXQgPSBFbWJlci5nZXQsCiAgICBjbGFzc2lmeSA9IEVtYmVyLlN0cmluZy5jbGFzc2lmeSwKICAgIGNhcGl0YWxpemUgPSBFbWJlci5TdHJpbmcuY2FwaXRhbGl6ZSwKICAgIGRlY2FtZWxpemUgPSBFbWJlci5TdHJpbmcuZGVjYW1lbGl6ZTsKCi8qKgogIFRoZSBEZWZhdWx0UmVzb2x2ZXIgZGVmaW5lcyB0aGUgZGVmYXVsdCBsb29rdXAgcnVsZXMgdG8gcmVzb2x2ZQogIGNvbnRhaW5lciBsb29rdXBzIGJlZm9yZSBjb25zdWx0aW5nIHRoZSBjb250YWluZXIgZm9yIHJlZ2lzdGVyZWQKICBpdGVtczoKCiogdGVtcGxhdGVzIGFyZSBsb29rZWQgdXAgb24gYEVtYmVyLlRFTVBMQVRFU2AKKiBvdGhlciBuYW1lcyBhcmUgbG9va2VkIHVwIG9uIHRoZSBhcHBsaWNhdGlvbiBhZnRlciBjb252ZXJ0aW5nCiAgdGhlIG5hbWUuIEZvciBleGFtcGxlLCBgY29udHJvbGxlcjpwb3N0YCBsb29rcyB1cAogIGBBcHAuUG9zdENvbnRyb2xsZXJgIGJ5IGRlZmF1bHQuCiogdGhlcmUgYXJlIHNvbWUgbnVhbmNlcyAoc2VlIGV4YW1wbGVzIGJlbG93KQoKICAjIyMgSG93IFJlc29sdmluZyBXb3JrcwoKICBUaGUgY29udGFpbmVyIGNhbGxzIHRoaXMgb2JqZWN0J3MgYHJlc29sdmVgIG1ldGhvZCB3aXRoIHRoZQogIGBmdWxsTmFtZWAgYXJndW1lbnQuCgogIEl0IGZpcnN0IHBhcnNlcyB0aGUgZnVsbE5hbWUgaW50byBhbiBvYmplY3QgdXNpbmcgYHBhcnNlTmFtZWAuCgogIFRoZW4gaXQgY2hlY2tzIGZvciB0aGUgcHJlc2VuY2Ugb2YgYSB0eXBlLXNwZWNpZmljIGluc3RhbmNlCiAgbWV0aG9kIG9mIHRoZSBmb3JtIGByZXNvbHZlW1R5cGVdYCBhbmQgY2FsbHMgaXQgaWYgaXQgZXhpc3RzLgogIEZvciBleGFtcGxlIGlmIGl0IHdhcyByZXNvbHZpbmcgJ3RlbXBsYXRlOnBvc3QnLCBpdCB3b3VsZCBjYWxsCiAgdGhlIGByZXNvbHZlVGVtcGxhdGVgIG1ldGhvZC4KCiAgSXRzIGxhc3QgcmVzb3J0IGlzIHRvIGNhbGwgdGhlIGByZXNvbHZlT3RoZXJgIG1ldGhvZC4KCiAgVGhlIG1ldGhvZHMgb2YgdGhpcyBvYmplY3QgYXJlIGRlc2lnbmVkIHRvIGJlIGVhc3kgdG8gb3ZlcnJpZGUKICBpbiBhIHN1YmNsYXNzLiBGb3IgZXhhbXBsZSwgeW91IGNvdWxkIGVuaGFuY2UgaG93IGEgdGVtcGxhdGUKICBpcyByZXNvbHZlZCBsaWtlIHNvOgoKICBgYGBqYXZhc2NyaXB0CiAgQXBwID0gRW1iZXIuQXBwbGljYXRpb24uY3JlYXRlKHsKICAgIFJlc29sdmVyOiBFbWJlci5EZWZhdWx0UmVzb2x2ZXIuZXh0ZW5kKHsKICAgICAgcmVzb2x2ZVRlbXBsYXRlOiBmdW5jdGlvbihwYXJzZWROYW1lKSB7CiAgICAgICAgdmFyIHJlc29sdmVkVGVtcGxhdGUgPSB0aGlzLl9zdXBlcihwYXJzZWROYW1lKTsKICAgICAgICBpZiAocmVzb2x2ZWRUZW1wbGF0ZSkgeyByZXR1cm4gcmVzb2x2ZWRUZW1wbGF0ZTsgfQogICAgICAgIHJldHVybiBFbWJlci5URU1QTEFURVNbJ25vdF9mb3VuZCddOwogICAgICB9CiAgICB9KQogIH0pOwogIGBgYAoKICBTb21lIGV4YW1wbGVzIG9mIGhvdyBuYW1lcyBhcmUgcmVzb2x2ZWQ6CgogIGBgYAogICd0ZW1wbGF0ZTpwb3N0JyAvLz0+IEVtYmVyLlRFTVBMQVRFU1sncG9zdCddCiAgJ3RlbXBsYXRlOnBvc3RzL2J5bGluZScgLy89PiBFbWJlci5URU1QTEFURVNbJ3Bvc3RzL2J5bGluZSddCiAgJ3RlbXBsYXRlOnBvc3RzLmJ5bGluZScgLy89PiBFbWJlci5URU1QTEFURVNbJ3Bvc3RzL2J5bGluZSddCiAgJ3RlbXBsYXRlOmJsb2dQb3N0JyAvLz0+IEVtYmVyLlRFTVBMQVRFU1snYmxvZ1Bvc3QnXQogICAgICAgICAgICAgICAgICAgICAgLy8gICBPUgogICAgICAgICAgICAgICAgICAgICAgLy8gICBFbWJlci5URU1QTEFURVNbJ2Jsb2dfcG9zdCddCiAgJ2NvbnRyb2xsZXI6cG9zdCcgLy89PiBBcHAuUG9zdENvbnRyb2xsZXIKICAnY29udHJvbGxlcjpwb3N0cy5pbmRleCcgLy89PiBBcHAuUG9zdHNJbmRleENvbnRyb2xsZXIKICAnY29udHJvbGxlcjpibG9nL3Bvc3QnIC8vPT4gQmxvZy5Qb3N0Q29udHJvbGxlcgogICdjb250cm9sbGVyOmJhc2ljJyAvLz0+IEVtYmVyLkNvbnRyb2xsZXIKICAncm91dGU6cG9zdCcgLy89PiBBcHAuUG9zdFJvdXRlCiAgJ3JvdXRlOnBvc3RzLmluZGV4JyAvLz0+IEFwcC5Qb3N0c0luZGV4Um91dGUKICAncm91dGU6YmxvZy9wb3N0JyAvLz0+IEJsb2cuUG9zdFJvdXRlCiAgJ3JvdXRlOmJhc2ljJyAvLz0+IEVtYmVyLlJvdXRlCiAgJ3ZpZXc6cG9zdCcgLy89PiBBcHAuUG9zdFZpZXcKICAndmlldzpwb3N0cy5pbmRleCcgLy89PiBBcHAuUG9zdHNJbmRleFZpZXcKICAndmlldzpibG9nL3Bvc3QnIC8vPT4gQmxvZy5Qb3N0VmlldwogICd2aWV3OmJhc2ljJyAvLz0+IEVtYmVyLlZpZXcKICAnZm9vOnBvc3QnIC8vPT4gQXBwLlBvc3RGb28KICAnbW9kZWw6cG9zdCcgLy89PiBBcHAuUG9zdAogIGBgYAoKICBAY2xhc3MgRGVmYXVsdFJlc29sdmVyCiAgQG5hbWVzcGFjZSBFbWJlcgogIEBleHRlbmRzIEVtYmVyLk9iamVjdAoqLwpFbWJlci5EZWZhdWx0UmVzb2x2ZXIgPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICAvKioKICAgIFRoaXMgd2lsbCBiZSBzZXQgdG8gdGhlIEFwcGxpY2F0aW9uIGluc3RhbmNlIHdoZW4gaXQgaXMKICAgIGNyZWF0ZWQuCgogICAgQHByb3BlcnR5IG5hbWVzcGFjZQogICovCiAgbmFtZXNwYWNlOiBudWxsLAoKICBub3JtYWxpemU6IGZ1bmN0aW9uKGZ1bGxOYW1lKSB7CiAgICB2YXIgc3BsaXQgPSBmdWxsTmFtZS5zcGxpdCgnOicsIDIpLAogICAgICAgIHR5cGUgPSBzcGxpdFswXSwKICAgICAgICBuYW1lID0gc3BsaXRbMV07CgogICAgRW1iZXIuYXNzZXJ0KCJUcmllZCB0byBub3JtYWxpemUgYSBjb250YWluZXIgbmFtZSB3aXRob3V0IGEgY29sb24gKDopIGluICIgKwogICAgICAgICAgICAgICAgICJpdC4gWW91IHByb2JhYmx5IHRyaWVkIHRvIGxvb2t1cCBhIG5hbWUgdGhhdCBkaWQgbm90IGNvbnRhaW4gIiArCiAgICAgICAgICAgICAgICAgImEgdHlwZSwgYSBjb2xvbiwgYW5kIGEgbmFtZS4gQSBwcm9wZXIgbG9va3VwIG5hbWUgd291bGQgYmUgIiArCiAgICAgICAgICAgICAgICAgImB2aWV3OnBvc3RgLiIsIHNwbGl0Lmxlbmd0aCA9PT0gMik7CgogICAgaWYgKHR5cGUgIT09ICd0ZW1wbGF0ZScpIHsKICAgICAgdmFyIHJlc3VsdCA9IG5hbWU7CgogICAgICBpZiAocmVzdWx0LmluZGV4T2YoJy4nKSA+IC0xKSB7CiAgICAgICAgcmVzdWx0ID0gcmVzdWx0LnJlcGxhY2UoL1wuKC4pL2csIGZ1bmN0aW9uKG0pIHsgcmV0dXJuIG0uY2hhckF0KDEpLnRvVXBwZXJDYXNlKCk7IH0pOwogICAgICB9CgogICAgICBpZiAobmFtZS5pbmRleE9mKCdfJykgPiAtMSkgewogICAgICAgIHJlc3VsdCA9IHJlc3VsdC5yZXBsYWNlKC9fKC4pL2csIGZ1bmN0aW9uKG0pIHsgcmV0dXJuIG0uY2hhckF0KDEpLnRvVXBwZXJDYXNlKCk7IH0pOwogICAgICB9CgogICAgICByZXR1cm4gdHlwZSArICc6JyArIHJlc3VsdDsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBmdWxsTmFtZTsKICAgIH0KICB9LAoKCiAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgdmlhIHRoZSBjb250YWluZXIncyByZXNvbHZlciBtZXRob2QuCiAgICBJdCBwYXJzZXMgdGhlIHByb3ZpZGVkIGBmdWxsTmFtZWAgYW5kIHRoZW4gbG9va3MgdXAgYW5kCiAgICByZXR1cm5zIHRoZSBhcHByb3ByaWF0ZSB0ZW1wbGF0ZSBvciBjbGFzcy4KCiAgICBAbWV0aG9kIHJlc29sdmUKICAgIEBwYXJhbSB7U3RyaW5nfSBmdWxsTmFtZSB0aGUgbG9va3VwIHN0cmluZwogICAgQHJldHVybiB7T2JqZWN0fSB0aGUgcmVzb2x2ZWQgZmFjdG9yeQogICovCiAgcmVzb2x2ZTogZnVuY3Rpb24oZnVsbE5hbWUpIHsKICAgIHZhciBwYXJzZWROYW1lID0gdGhpcy5wYXJzZU5hbWUoZnVsbE5hbWUpLAogICAgICAgIHR5cGVTcGVjaWZpY1Jlc29sdmVNZXRob2QgPSB0aGlzW3BhcnNlZE5hbWUucmVzb2x2ZU1ldGhvZE5hbWVdOwoKICAgIGlmICghcGFyc2VkTmFtZS5uYW1lIHx8ICFwYXJzZWROYW1lLnR5cGUpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiSW52YWxpZCBmdWxsTmFtZTogYCIgKyBmdWxsTmFtZSArICJgLCBtdXN0IGJlIG9mIHRoZSBmb3JtIGB0eXBlOm5hbWVgICIpOwogICAgfQoKICAgIGlmICh0eXBlU3BlY2lmaWNSZXNvbHZlTWV0aG9kKSB7CiAgICAgIHZhciByZXNvbHZlZCA9IHR5cGVTcGVjaWZpY1Jlc29sdmVNZXRob2QuY2FsbCh0aGlzLCBwYXJzZWROYW1lKTsKICAgICAgaWYgKHJlc29sdmVkKSB7IHJldHVybiByZXNvbHZlZDsgfQogICAgfQogICAgcmV0dXJuIHRoaXMucmVzb2x2ZU90aGVyKHBhcnNlZE5hbWUpOwogIH0sCiAgLyoqCiAgICBDb252ZXJ0IHRoZSBzdHJpbmcgbmFtZSBvZiB0aGUgZm9ybSAidHlwZTpuYW1lIiB0bwogICAgYSBKYXZhc2NyaXB0IG9iamVjdCB3aXRoIHRoZSBwYXJzZWQgYXNwZWN0cyBvZiB0aGUgbmFtZQogICAgYnJva2VuIG91dC4KCiAgICBAcHJvdGVjdGVkCiAgICBAcGFyYW0ge1N0cmluZ30gZnVsbE5hbWUgdGhlIGxvb2t1cCBzdHJpbmcKICAgIEBtZXRob2QgcGFyc2VOYW1lCiAgKi8KICBwYXJzZU5hbWU6IGZ1bmN0aW9uKGZ1bGxOYW1lKSB7CiAgICB2YXIgbmFtZVBhcnRzID0gZnVsbE5hbWUuc3BsaXQoIjoiKSwKICAgICAgICB0eXBlID0gbmFtZVBhcnRzWzBdLCBmdWxsTmFtZVdpdGhvdXRUeXBlID0gbmFtZVBhcnRzWzFdLAogICAgICAgIG5hbWUgPSBmdWxsTmFtZVdpdGhvdXRUeXBlLAogICAgICAgIG5hbWVzcGFjZSA9IGdldCh0aGlzLCAnbmFtZXNwYWNlJyksCiAgICAgICAgcm9vdCA9IG5hbWVzcGFjZTsKCiAgICBpZiAodHlwZSAhPT0gJ3RlbXBsYXRlJyAmJiBuYW1lLmluZGV4T2YoJy8nKSAhPT0gLTEpIHsKICAgICAgdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgnLycpOwogICAgICBuYW1lID0gcGFydHNbcGFydHMubGVuZ3RoIC0gMV07CiAgICAgIHZhciBuYW1lc3BhY2VOYW1lID0gY2FwaXRhbGl6ZShwYXJ0cy5zbGljZSgwLCAtMSkuam9pbignLicpKTsKICAgICAgcm9vdCA9IEVtYmVyLk5hbWVzcGFjZS5ieU5hbWUobmFtZXNwYWNlTmFtZSk7CgogICAgICBFbWJlci5hc3NlcnQoJ1lvdSBhcmUgbG9va2luZyBmb3IgYSAnICsgbmFtZSArICcgJyArIHR5cGUgKyAnIGluIHRoZSAnICsgbmFtZXNwYWNlTmFtZSArICcgbmFtZXNwYWNlLCBidXQgdGhlIG5hbWVzcGFjZSBjb3VsZCBub3QgYmUgZm91bmQnLCByb290KTsKICAgIH0KCiAgICByZXR1cm4gewogICAgICBmdWxsTmFtZTogZnVsbE5hbWUsCiAgICAgIHR5cGU6IHR5cGUsCiAgICAgIGZ1bGxOYW1lV2l0aG91dFR5cGU6IGZ1bGxOYW1lV2l0aG91dFR5cGUsCiAgICAgIG5hbWU6IG5hbWUsCiAgICAgIHJvb3Q6IHJvb3QsCiAgICAgIHJlc29sdmVNZXRob2ROYW1lOiAicmVzb2x2ZSIgKyBjbGFzc2lmeSh0eXBlKQogICAgfTsKICB9LAogIC8qKgogICAgTG9vayB1cCB0aGUgdGVtcGxhdGUgaW4gRW1iZXIuVEVNUExBVEVTCgogICAgQHByb3RlY3RlZAogICAgQHBhcmFtIHtPYmplY3R9IHBhcnNlZE5hbWUgYSBwYXJzZU5hbWUgb2JqZWN0IHdpdGggdGhlIHBhcnNlZAogICAgICBmdWxsTmFtZSBsb29rdXAgc3RyaW5nCiAgICBAbWV0aG9kIHJlc29sdmVUZW1wbGF0ZQogICovCiAgcmVzb2x2ZVRlbXBsYXRlOiBmdW5jdGlvbihwYXJzZWROYW1lKSB7CiAgICB2YXIgdGVtcGxhdGVOYW1lID0gcGFyc2VkTmFtZS5mdWxsTmFtZVdpdGhvdXRUeXBlLnJlcGxhY2UoL1wuL2csICcvJyk7CgogICAgaWYgKEVtYmVyLlRFTVBMQVRFU1t0ZW1wbGF0ZU5hbWVdKSB7CiAgICAgIHJldHVybiBFbWJlci5URU1QTEFURVNbdGVtcGxhdGVOYW1lXTsKICAgIH0KCiAgICB0ZW1wbGF0ZU5hbWUgPSBkZWNhbWVsaXplKHRlbXBsYXRlTmFtZSk7CiAgICBpZiAoRW1iZXIuVEVNUExBVEVTW3RlbXBsYXRlTmFtZV0pIHsKICAgICAgcmV0dXJuIEVtYmVyLlRFTVBMQVRFU1t0ZW1wbGF0ZU5hbWVdOwogICAgfQogIH0sCiAgLyoqCiAgICBHaXZlbiBhIHBhcnNlTmFtZSBvYmplY3QgKG91dHB1dCBmcm9tIGBwYXJzZU5hbWVgKSwgYXBwbHkKICAgIHRoZSBjb252ZW50aW9ucyBleHBlY3RlZCBieSBgRW1iZXIuUm91dGVyYAoKICAgIEBwcm90ZWN0ZWQKICAgIEBwYXJhbSB7T2JqZWN0fSBwYXJzZWROYW1lIGEgcGFyc2VOYW1lIG9iamVjdCB3aXRoIHRoZSBwYXJzZWQKICAgICAgZnVsbE5hbWUgbG9va3VwIHN0cmluZwogICAgQG1ldGhvZCB1c2VSb3V0ZXJOYW1pbmcKICAqLwogIHVzZVJvdXRlck5hbWluZzogZnVuY3Rpb24ocGFyc2VkTmFtZSkgewogICAgcGFyc2VkTmFtZS5uYW1lID0gcGFyc2VkTmFtZS5uYW1lLnJlcGxhY2UoL1wuL2csICdfJyk7CiAgICBpZiAocGFyc2VkTmFtZS5uYW1lID09PSAnYmFzaWMnKSB7CiAgICAgIHBhcnNlZE5hbWUubmFtZSA9ICcnOwogICAgfQogIH0sCiAgLyoqCiAgICBMb29rdXAgdGhlIGNvbnRyb2xsZXIgdXNpbmcgYHJlc29sdmVPdGhlcmAKCiAgICBAcHJvdGVjdGVkCiAgICBAcGFyYW0ge09iamVjdH0gcGFyc2VkTmFtZSBhIHBhcnNlTmFtZSBvYmplY3Qgd2l0aCB0aGUgcGFyc2VkCiAgICAgIGZ1bGxOYW1lIGxvb2t1cCBzdHJpbmcKICAgIEBtZXRob2QgcmVzb2x2ZUNvbnRyb2xsZXIKICAqLwogIHJlc29sdmVDb250cm9sbGVyOiBmdW5jdGlvbihwYXJzZWROYW1lKSB7CiAgICB0aGlzLnVzZVJvdXRlck5hbWluZyhwYXJzZWROYW1lKTsKICAgIHJldHVybiB0aGlzLnJlc29sdmVPdGhlcihwYXJzZWROYW1lKTsKICB9LAogIC8qKgogICAgTG9va3VwIHRoZSByb3V0ZSB1c2luZyBgcmVzb2x2ZU90aGVyYAoKICAgIEBwcm90ZWN0ZWQKICAgIEBwYXJhbSB7T2JqZWN0fSBwYXJzZWROYW1lIGEgcGFyc2VOYW1lIG9iamVjdCB3aXRoIHRoZSBwYXJzZWQKICAgICAgZnVsbE5hbWUgbG9va3VwIHN0cmluZwogICAgQG1ldGhvZCByZXNvbHZlUm91dGUKICAqLwogIHJlc29sdmVSb3V0ZTogZnVuY3Rpb24ocGFyc2VkTmFtZSkgewogICAgdGhpcy51c2VSb3V0ZXJOYW1pbmcocGFyc2VkTmFtZSk7CiAgICByZXR1cm4gdGhpcy5yZXNvbHZlT3RoZXIocGFyc2VkTmFtZSk7CiAgfSwKICAvKioKICAgIExvb2t1cCB0aGUgdmlldyB1c2luZyBgcmVzb2x2ZU90aGVyYAoKICAgIEBwcm90ZWN0ZWQKICAgIEBwYXJhbSB7T2JqZWN0fSBwYXJzZWROYW1lIGEgcGFyc2VOYW1lIG9iamVjdCB3aXRoIHRoZSBwYXJzZWQKICAgICAgZnVsbE5hbWUgbG9va3VwIHN0cmluZwogICAgQG1ldGhvZCByZXNvbHZlVmlldwogICovCiAgcmVzb2x2ZVZpZXc6IGZ1bmN0aW9uKHBhcnNlZE5hbWUpIHsKICAgIHRoaXMudXNlUm91dGVyTmFtaW5nKHBhcnNlZE5hbWUpOwogICAgcmV0dXJuIHRoaXMucmVzb2x2ZU90aGVyKHBhcnNlZE5hbWUpOwogIH0sCgogIHJlc29sdmVIZWxwZXI6IGZ1bmN0aW9uKHBhcnNlZE5hbWUpIHsKICAgIHJldHVybiB0aGlzLnJlc29sdmVPdGhlcihwYXJzZWROYW1lKSB8fCBFbWJlci5IYW5kbGViYXJzLmhlbHBlcnNbcGFyc2VkTmFtZS5mdWxsTmFtZVdpdGhvdXRUeXBlXTsKICB9LAoKICAvKioKICAgIExvb2t1cCB0aGUgbW9kZWwgb24gdGhlIEFwcGxpY2F0aW9uIG5hbWVzcGFjZQoKICAgIEBwcm90ZWN0ZWQKICAgIEBwYXJhbSB7T2JqZWN0fSBwYXJzZWROYW1lIGEgcGFyc2VOYW1lIG9iamVjdCB3aXRoIHRoZSBwYXJzZWQKICAgICAgZnVsbE5hbWUgbG9va3VwIHN0cmluZwogICAgQG1ldGhvZCByZXNvbHZlTW9kZWwKICAqLwogIHJlc29sdmVNb2RlbDogZnVuY3Rpb24ocGFyc2VkTmFtZSkgewogICAgdmFyIGNsYXNzTmFtZSA9IGNsYXNzaWZ5KHBhcnNlZE5hbWUubmFtZSksCiAgICAgICAgZmFjdG9yeSA9IGdldChwYXJzZWROYW1lLnJvb3QsIGNsYXNzTmFtZSk7CgogICAgIGlmIChmYWN0b3J5KSB7IHJldHVybiBmYWN0b3J5OyB9CiAgfSwKICAvKioKICAgIExvb2sgdXAgdGhlIHNwZWNpZmllZCBvYmplY3QgKGZyb20gcGFyc2VkTmFtZSkgb24gdGhlIGFwcHJvcHJpYXRlCiAgICBuYW1lc3BhY2UgKHVzdWFsbHkgb24gdGhlIEFwcGxpY2F0aW9uKQoKICAgIEBwcm90ZWN0ZWQKICAgIEBwYXJhbSB7T2JqZWN0fSBwYXJzZWROYW1lIGEgcGFyc2VOYW1lIG9iamVjdCB3aXRoIHRoZSBwYXJzZWQKICAgICAgZnVsbE5hbWUgbG9va3VwIHN0cmluZwogICAgQG1ldGhvZCByZXNvbHZlT3RoZXIKICAqLwogIHJlc29sdmVPdGhlcjogZnVuY3Rpb24ocGFyc2VkTmFtZSkgewogICAgdmFyIGNsYXNzTmFtZSA9IGNsYXNzaWZ5KHBhcnNlZE5hbWUubmFtZSkgKyBjbGFzc2lmeShwYXJzZWROYW1lLnR5cGUpLAogICAgICAgIGZhY3RvcnkgPSBnZXQocGFyc2VkTmFtZS5yb290LCBjbGFzc05hbWUpOwogICAgaWYgKGZhY3RvcnkpIHsgcmV0dXJuIGZhY3Rvcnk7IH0KICB9LAoKICAvKioKICAgIFJldHVybnMgYSBodW1hbi1yZWFkYWJsZSBkZXNjcmlwdGlvbiBmb3IgYSBmdWxsTmFtZS4gVXNlZCBieSB0aGUKICAgIEFwcGxpY2F0aW9uIG5hbWVzcGFjZSBpbiBhc3NlcnRpb25zIHRvIGRlc2NyaWJlIHRoZQogICAgcHJlY2lzZSBuYW1lIG9mIHRoZSBjbGFzcyB0aGF0IEVtYmVyIGlzIGxvb2tpbmcgZm9yLCByYXRoZXIgdGhhbgogICAgY29udGFpbmVyIGtleXMuCgogICAgQHByb3RlY3RlZAogICAgQHBhcmFtIHtTdHJpbmd9IGZ1bGxOYW1lIHRoZSBsb29rdXAgc3RyaW5nCiAgICBAbWV0aG9kIGxvb2t1cERlc2NyaXB0aW9uCiAgKi8KICBsb29rdXBEZXNjcmlwdGlvbjogZnVuY3Rpb24oZnVsbE5hbWUpIHsKICAgIHZhciBwYXJzZWROYW1lID0gdGhpcy5wYXJzZU5hbWUoZnVsbE5hbWUpOwoKICAgIGlmIChwYXJzZWROYW1lLnR5cGUgPT09ICd0ZW1wbGF0ZScpIHsKICAgICAgcmV0dXJuICJ0ZW1wbGF0ZSBhdCAiICsgcGFyc2VkTmFtZS5mdWxsTmFtZVdpdGhvdXRUeXBlLnJlcGxhY2UoL1wuL2csICcvJyk7CiAgICB9CgogICAgdmFyIGRlc2NyaXB0aW9uID0gcGFyc2VkTmFtZS5yb290ICsgIi4iICsgY2xhc3NpZnkocGFyc2VkTmFtZS5uYW1lKTsKICAgIGlmIChwYXJzZWROYW1lLnR5cGUgIT09ICdtb2RlbCcpIHsgZGVzY3JpcHRpb24gKz0gY2xhc3NpZnkocGFyc2VkTmFtZS50eXBlKTsgfQoKICAgIHJldHVybiBkZXNjcmlwdGlvbjsKICB9LAoKICBtYWtlVG9TdHJpbmc6IGZ1bmN0aW9uKGZhY3RvcnksIGZ1bGxOYW1lKSB7CiAgICByZXR1cm4gZmFjdG9yeS50b1N0cmluZygpOwogIH0KfSk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItYXBwbGljYXRpb24KKi8KCnZhciBnZXQgPSBFbWJlci5nZXQsIHNldCA9IEVtYmVyLnNldDsKCmZ1bmN0aW9uIERlcHJlY2F0ZWRDb250YWluZXIoY29udGFpbmVyKSB7CiAgdGhpcy5fY29udGFpbmVyID0gY29udGFpbmVyOwp9CgpEZXByZWNhdGVkQ29udGFpbmVyLmRlcHJlY2F0ZSA9IGZ1bmN0aW9uKG1ldGhvZCkgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHZhciBjb250YWluZXIgPSB0aGlzLl9jb250YWluZXI7CgogICAgRW1iZXIuZGVwcmVjYXRlKCdVc2luZyB0aGUgZGVmYXVsdENvbnRhaW5lciBpcyBubyBsb25nZXIgc3VwcG9ydGVkLiBbZGVmYXVsdENvbnRhaW5lciMnICsgbWV0aG9kICsgJ10gc2VlOiBodHRwOi8vZ2l0LmlvL0VLUHBuQScsIGZhbHNlKTsKICAgIHJldHVybiBjb250YWluZXJbbWV0aG9kXS5hcHBseShjb250YWluZXIsIGFyZ3VtZW50cyk7CiAgfTsKfTsKCkRlcHJlY2F0ZWRDb250YWluZXIucHJvdG90eXBlID0gewogIF9jb250YWluZXI6IG51bGwsCiAgbG9va3VwOiBEZXByZWNhdGVkQ29udGFpbmVyLmRlcHJlY2F0ZSgnbG9va3VwJyksCiAgcmVzb2x2ZTogRGVwcmVjYXRlZENvbnRhaW5lci5kZXByZWNhdGUoJ3Jlc29sdmUnKSwKICByZWdpc3RlcjogRGVwcmVjYXRlZENvbnRhaW5lci5kZXByZWNhdGUoJ3JlZ2lzdGVyJykKfTsKCi8qKgogIEFuIGluc3RhbmNlIG9mIGBFbWJlci5BcHBsaWNhdGlvbmAgaXMgdGhlIHN0YXJ0aW5nIHBvaW50IGZvciBldmVyeSBFbWJlcgogIGFwcGxpY2F0aW9uLiBJdCBoZWxwcyB0byBpbnN0YW50aWF0ZSwgaW5pdGlhbGl6ZSBhbmQgY29vcmRpbmF0ZSB0aGUgbWFueQogIG9iamVjdHMgdGhhdCBtYWtlIHVwIHlvdXIgYXBwLgoKICBFYWNoIEVtYmVyIGFwcCBoYXMgb25lIGFuZCBvbmx5IG9uZSBgRW1iZXIuQXBwbGljYXRpb25gIG9iamVjdC4gSW4gZmFjdCwgdGhlCiAgdmVyeSBmaXJzdCB0aGluZyB5b3Ugc2hvdWxkIGRvIGluIHlvdXIgYXBwbGljYXRpb24gaXMgY3JlYXRlIHRoZSBpbnN0YW5jZToKCiAgYGBgamF2YXNjcmlwdAogIHdpbmRvdy5BcHAgPSBFbWJlci5BcHBsaWNhdGlvbi5jcmVhdGUoKTsKICBgYGAKCiAgVHlwaWNhbGx5LCB0aGUgYXBwbGljYXRpb24gb2JqZWN0IGlzIHRoZSBvbmx5IGdsb2JhbCB2YXJpYWJsZS4gQWxsIG90aGVyCiAgY2xhc3NlcyBpbiB5b3VyIGFwcCBzaG91bGQgYmUgcHJvcGVydGllcyBvbiB0aGUgYEVtYmVyLkFwcGxpY2F0aW9uYCBpbnN0YW5jZSwKICB3aGljaCBoaWdobGlnaHRzIGl0cyBmaXJzdCByb2xlOiBhIGdsb2JhbCBuYW1lc3BhY2UuCgogIEZvciBleGFtcGxlLCBpZiB5b3UgZGVmaW5lIGEgdmlldyBjbGFzcywgaXQgbWlnaHQgbG9vayBsaWtlIHRoaXM6CgogIGBgYGphdmFzY3JpcHQKICBBcHAuTXlWaWV3ID0gRW1iZXIuVmlldy5leHRlbmQoKTsKICBgYGAKCiAgQnkgZGVmYXVsdCwgY2FsbGluZyBgRW1iZXIuQXBwbGljYXRpb24uY3JlYXRlKClgIHdpbGwgYXV0b21hdGljYWxseSBpbml0aWFsaXplCiAgeW91ciBhcHBsaWNhdGlvbiBieSBjYWxsaW5nIHRoZSBgRW1iZXIuQXBwbGljYXRpb24uaW5pdGlhbGl6ZSgpYCBtZXRob2QuIElmCiAgeW91IG5lZWQgdG8gZGVsYXkgaW5pdGlhbGl6YXRpb24sIHlvdSBjYW4gY2FsbCB5b3VyIGFwcCdzIGBkZWZlclJlYWRpbmVzcygpYAogIG1ldGhvZC4gV2hlbiB5b3UgYXJlIHJlYWR5IGZvciB5b3VyIGFwcCB0byBiZSBpbml0aWFsaXplZCwgY2FsbCBpdHMKICBgYWR2YW5jZVJlYWRpbmVzcygpYCBtZXRob2QuCgogIFlvdSBjYW4gZGVmaW5lIGEgYHJlYWR5YCBtZXRob2Qgb24gdGhlIGBFbWJlci5BcHBsaWNhdGlvbmAgaW5zdGFuY2UsIHdoaWNoCiAgd2lsbCBiZSBydW4gYnkgRW1iZXIgd2hlbiB0aGUgYXBwbGljYXRpb24gaXMgaW5pdGlhbGl6ZWQuCgogIEJlY2F1c2UgYEVtYmVyLkFwcGxpY2F0aW9uYCBpbmhlcml0cyBmcm9tIGBFbWJlci5OYW1lc3BhY2VgLCBhbnkgY2xhc3NlcwogIHlvdSBjcmVhdGUgd2lsbCBoYXZlIHVzZWZ1bCBzdHJpbmcgcmVwcmVzZW50YXRpb25zIHdoZW4gY2FsbGluZyBgdG9TdHJpbmcoKWAuCiAgU2VlIHRoZSBgRW1iZXIuTmFtZXNwYWNlYCBkb2N1bWVudGF0aW9uIGZvciBtb3JlIGluZm9ybWF0aW9uLgoKICBXaGlsZSB5b3UgY2FuIHRoaW5rIG9mIHlvdXIgYEVtYmVyLkFwcGxpY2F0aW9uYCBhcyBhIGNvbnRhaW5lciB0aGF0IGhvbGRzIHRoZQogIG90aGVyIGNsYXNzZXMgaW4geW91ciBhcHBsaWNhdGlvbiwgdGhlcmUgYXJlIHNldmVyYWwgb3RoZXIgcmVzcG9uc2liaWxpdGllcwogIGdvaW5nIG9uIHVuZGVyLXRoZS1ob29kIHRoYXQgeW91IG1heSB3YW50IHRvIHVuZGVyc3RhbmQuCgogICMjIyBFdmVudCBEZWxlZ2F0aW9uCgogIEVtYmVyIHVzZXMgYSB0ZWNobmlxdWUgY2FsbGVkIF9ldmVudCBkZWxlZ2F0aW9uXy4gVGhpcyBhbGxvd3MgdGhlIGZyYW1ld29yawogIHRvIHNldCB1cCBhIGdsb2JhbCwgc2hhcmVkIGV2ZW50IGxpc3RlbmVyIGluc3RlYWQgb2YgcmVxdWlyaW5nIGVhY2ggdmlldyB0bwogIGRvIGl0IG1hbnVhbGx5LiBGb3IgZXhhbXBsZSwgaW5zdGVhZCBvZiBlYWNoIHZpZXcgcmVnaXN0ZXJpbmcgaXRzIG93bgogIGBtb3VzZWRvd25gIGxpc3RlbmVyIG9uIGl0cyBhc3NvY2lhdGVkIGVsZW1lbnQsIEVtYmVyIHNldHMgdXAgYSBgbW91c2Vkb3duYAogIGxpc3RlbmVyIG9uIHRoZSBgYm9keWAuCgogIElmIGEgYG1vdXNlZG93bmAgZXZlbnQgb2NjdXJzLCBFbWJlciB3aWxsIGxvb2sgYXQgdGhlIHRhcmdldCBvZiB0aGUgZXZlbnQgYW5kCiAgc3RhcnQgd2Fsa2luZyB1cCB0aGUgRE9NIG5vZGUgdHJlZSwgZmluZGluZyBjb3JyZXNwb25kaW5nIHZpZXdzIGFuZCBpbnZva2luZwogIHRoZWlyIGBtb3VzZURvd25gIG1ldGhvZCBhcyBpdCBnb2VzLgoKICBgRW1iZXIuQXBwbGljYXRpb25gIGhhcyBhIG51bWJlciBvZiBkZWZhdWx0IGV2ZW50cyB0aGF0IGl0IGxpc3RlbnMgZm9yLCBhcwogIHdlbGwgYXMgYSBtYXBwaW5nIGZyb20gbG93ZXJjYXNlIGV2ZW50cyB0byBjYW1lbC1jYXNlZCB2aWV3IG1ldGhvZCBuYW1lcy4gRm9yCiAgZXhhbXBsZSwgdGhlIGBrZXlwcmVzc2AgZXZlbnQgY2F1c2VzIHRoZSBga2V5UHJlc3NgIG1ldGhvZCBvbiB0aGUgdmlldyB0byBiZQogIGNhbGxlZCwgdGhlIGBkYmxjbGlja2AgZXZlbnQgY2F1c2VzIGBkb3VibGVDbGlja2AgdG8gYmUgY2FsbGVkLCBhbmQgc28gb24uCgogIElmIHRoZXJlIGlzIGEgYnViYmxpbmcgYnJvd3NlciBldmVudCB0aGF0IEVtYmVyIGRvZXMgbm90IGxpc3RlbiBmb3IgYnkKICBkZWZhdWx0LCB5b3UgY2FuIHNwZWNpZnkgY3VzdG9tIGV2ZW50cyBhbmQgdGhlaXIgY29ycmVzcG9uZGluZyB2aWV3IG1ldGhvZAogIG5hbWVzIGJ5IHNldHRpbmcgdGhlIGFwcGxpY2F0aW9uJ3MgYGN1c3RvbUV2ZW50c2AgcHJvcGVydHk6CgogIGBgYGphdmFzY3JpcHQKICBBcHAgPSBFbWJlci5BcHBsaWNhdGlvbi5jcmVhdGUoewogICAgY3VzdG9tRXZlbnRzOiB7CiAgICAgIC8vIGFkZCBzdXBwb3J0IGZvciB0aGUgcGFzdGUgZXZlbnQKICAgICAgcGFzdGU6ICJwYXN0ZSIKICAgIH0KICB9KTsKICBgYGAKCiAgQnkgZGVmYXVsdCwgdGhlIGFwcGxpY2F0aW9uIHNldHMgdXAgdGhlc2UgZXZlbnQgbGlzdGVuZXJzIG9uIHRoZSBkb2N1bWVudAogIGJvZHkuIEhvd2V2ZXIsIGluIGNhc2VzIHdoZXJlIHlvdSBhcmUgZW1iZWRkaW5nIGFuIEVtYmVyIGFwcGxpY2F0aW9uIGluc2lkZQogIGFuIGV4aXN0aW5nIHBhZ2UsIHlvdSBtYXkgd2FudCBpdCB0byBzZXQgdXAgdGhlIGxpc3RlbmVycyBvbiBhbiBlbGVtZW50CiAgaW5zaWRlIHRoZSBib2R5LgoKICBGb3IgZXhhbXBsZSwgaWYgb25seSBldmVudHMgaW5zaWRlIGEgRE9NIGVsZW1lbnQgd2l0aCB0aGUgSUQgb2YgYGVtYmVyLWFwcGAKICBzaG91bGQgYmUgZGVsZWdhdGVkLCBzZXQgeW91ciBhcHBsaWNhdGlvbidzIGByb290RWxlbWVudGAgcHJvcGVydHk6CgogIGBgYGphdmFzY3JpcHQKICB3aW5kb3cuQXBwID0gRW1iZXIuQXBwbGljYXRpb24uY3JlYXRlKHsKICAgIHJvb3RFbGVtZW50OiAnI2VtYmVyLWFwcCcKICB9KTsKICBgYGAKCiAgVGhlIGByb290RWxlbWVudGAgY2FuIGJlIGVpdGhlciBhIERPTSBlbGVtZW50IG9yIGEgalF1ZXJ5LWNvbXBhdGlibGUgc2VsZWN0b3IKICBzdHJpbmcuIE5vdGUgdGhhdCAqdmlld3MgYXBwZW5kZWQgdG8gdGhlIERPTSBvdXRzaWRlIHRoZSByb290IGVsZW1lbnQgd2lsbAogIG5vdCByZWNlaXZlIGV2ZW50cy4qIElmIHlvdSBzcGVjaWZ5IGEgY3VzdG9tIHJvb3QgZWxlbWVudCwgbWFrZSBzdXJlIHlvdSBvbmx5CiAgYXBwZW5kIHZpZXdzIGluc2lkZSBpdCEKCiAgVG8gbGVhcm4gbW9yZSBhYm91dCB0aGUgYWR2YW50YWdlcyBvZiBldmVudCBkZWxlZ2F0aW9uIGFuZCB0aGUgRW1iZXIgdmlldwogIGxheWVyLCBhbmQgYSBsaXN0IG9mIHRoZSBldmVudCBsaXN0ZW5lcnMgdGhhdCBhcmUgc2V0dXAgYnkgZGVmYXVsdCwgdmlzaXQgdGhlCiAgW0VtYmVyIFZpZXcgTGF5ZXIgZ3VpZGVdKGh0dHA6Ly9lbWJlcmpzLmNvbS9ndWlkZXMvdW5kZXJzdGFuZGluZy1lbWJlci90aGUtdmlldy1sYXllci8jdG9jX2V2ZW50LWRlbGVnYXRpb24pLgoKICAjIyMgSW5pdGlhbGl6ZXJzCgogIExpYnJhcmllcyBvbiB0b3Agb2YgRW1iZXIgY2FuIHJlZ2lzdGVyIGFkZGl0aW9uYWwgaW5pdGlhbGl6ZXJzLCBsaWtlIHNvOgoKICBgYGBqYXZhc2NyaXB0CiAgRW1iZXIuQXBwbGljYXRpb24uaW5pdGlhbGl6ZXIoewogICAgbmFtZTogInN0b3JlIiwKCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbihjb250YWluZXIsIGFwcGxpY2F0aW9uKSB7CiAgICAgIGNvbnRhaW5lci5yZWdpc3Rlcignc3RvcmU6bWFpbicsIGFwcGxpY2F0aW9uLlN0b3JlKTsKICAgIH0KICB9KTsKICBgYGAKCiAgIyMjIFJvdXRpbmcKCiAgSW4gYWRkaXRpb24gdG8gY3JlYXRpbmcgeW91ciBhcHBsaWNhdGlvbidzIHJvdXRlciwgYEVtYmVyLkFwcGxpY2F0aW9uYCBpcwogIGFsc28gcmVzcG9uc2libGUgZm9yIHRlbGxpbmcgdGhlIHJvdXRlciB3aGVuIHRvIHN0YXJ0IHJvdXRpbmcuIFRyYW5zaXRpb25zCiAgYmV0d2VlbiByb3V0ZXMgY2FuIGJlIGxvZ2dlZCB3aXRoIHRoZSBgTE9HX1RSQU5TSVRJT05TYCBmbGFnLCBhbmQgbW9yZQogIGRldGFpbGVkIGludHJhLXRyYW5zaXRpb24gbG9nZ2luZyBjYW4gYmUgbG9nZ2VkIHdpdGgKICB0aGUgYExPR19UUkFOU0lUSU9OU19JTlRFUk5BTGAgZmxhZzoKCiAgYGBgamF2YXNjcmlwdAogIHdpbmRvdy5BcHAgPSBFbWJlci5BcHBsaWNhdGlvbi5jcmVhdGUoewogICAgTE9HX1RSQU5TSVRJT05TOiB0cnVlLCAvLyBiYXNpYyBsb2dnaW5nIG9mIHN1Y2Nlc3NmdWwgdHJhbnNpdGlvbnMKICAgIExPR19UUkFOU0lUSU9OU19JTlRFUk5BTDogdHJ1ZSAvLyBkZXRhaWxlZCBsb2dnaW5nIG9mIGFsbCByb3V0aW5nIHN0ZXBzCiAgfSk7CiAgYGBgCgogIEJ5IGRlZmF1bHQsIHRoZSByb3V0ZXIgd2lsbCBiZWdpbiB0cnlpbmcgdG8gdHJhbnNsYXRlIHRoZSBjdXJyZW50IFVSTCBpbnRvCiAgYXBwbGljYXRpb24gc3RhdGUgb25jZSB0aGUgYnJvd3NlciBlbWl0cyB0aGUgYERPTUNvbnRlbnRSZWFkeWAgZXZlbnQuIElmIHlvdQogIG5lZWQgdG8gZGVmZXIgcm91dGluZywgeW91IGNhbiBjYWxsIHRoZSBhcHBsaWNhdGlvbidzIGBkZWZlclJlYWRpbmVzcygpYAogIG1ldGhvZC4gT25jZSByb3V0aW5nIGNhbiBiZWdpbiwgY2FsbCB0aGUgYGFkdmFuY2VSZWFkaW5lc3MoKWAgbWV0aG9kLgoKICBJZiB0aGVyZSBpcyBhbnkgc2V0dXAgcmVxdWlyZWQgYmVmb3JlIHJvdXRpbmcgYmVnaW5zLCB5b3UgY2FuIGltcGxlbWVudCBhCiAgYHJlYWR5KClgIG1ldGhvZCBvbiB5b3VyIGFwcCB0aGF0IHdpbGwgYmUgaW52b2tlZCBpbW1lZGlhdGVseSBiZWZvcmUgcm91dGluZwogIGJlZ2lucy4KICBgYGAKCiAgQGNsYXNzIEFwcGxpY2F0aW9uCiAgQG5hbWVzcGFjZSBFbWJlcgogIEBleHRlbmRzIEVtYmVyLk5hbWVzcGFjZQoqLwoKdmFyIEFwcGxpY2F0aW9uID0gRW1iZXIuQXBwbGljYXRpb24gPSBFbWJlci5OYW1lc3BhY2UuZXh0ZW5kKEVtYmVyLkRlZmVycmVkTWl4aW4sIHsKCiAgLyoqCiAgICBUaGUgcm9vdCBET00gZWxlbWVudCBvZiB0aGUgQXBwbGljYXRpb24uIFRoaXMgY2FuIGJlIHNwZWNpZmllZCBhcyBhbgogICAgZWxlbWVudCBvciBhCiAgICBbalF1ZXJ5LWNvbXBhdGlibGUgc2VsZWN0b3Igc3RyaW5nXShodHRwOi8vYXBpLmpxdWVyeS5jb20vY2F0ZWdvcnkvc2VsZWN0b3JzLykuCgogICAgVGhpcyBpcyB0aGUgZWxlbWVudCB0aGF0IHdpbGwgYmUgcGFzc2VkIHRvIHRoZSBBcHBsaWNhdGlvbidzLAogICAgYGV2ZW50RGlzcGF0Y2hlcmAsIHdoaWNoIHNldHMgdXAgdGhlIGxpc3RlbmVycyBmb3IgZXZlbnQgZGVsZWdhdGlvbi4gRXZlcnkKICAgIHZpZXcgaW4geW91ciBhcHBsaWNhdGlvbiBzaG91bGQgYmUgYSBjaGlsZCBvZiB0aGUgZWxlbWVudCB5b3Ugc3BlY2lmeSBoZXJlLgoKICAgIEBwcm9wZXJ0eSByb290RWxlbWVudAogICAgQHR5cGUgRE9NRWxlbWVudAogICAgQGRlZmF1bHQgJ2JvZHknCiAgKi8KICByb290RWxlbWVudDogJ2JvZHknLAoKICAvKioKICAgIFRoZSBgRW1iZXIuRXZlbnREaXNwYXRjaGVyYCByZXNwb25zaWJsZSBmb3IgZGVsZWdhdGluZyBldmVudHMgdG8gdGhpcwogICAgYXBwbGljYXRpb24ncyB2aWV3cy4KCiAgICBUaGUgZXZlbnQgZGlzcGF0Y2hlciBpcyBjcmVhdGVkIGJ5IHRoZSBhcHBsaWNhdGlvbiBhdCBpbml0aWFsaXphdGlvbiB0aW1lCiAgICBhbmQgc2V0cyB1cCBldmVudCBsaXN0ZW5lcnMgb24gdGhlIERPTSBlbGVtZW50IGRlc2NyaWJlZCBieSB0aGUKICAgIGFwcGxpY2F0aW9uJ3MgYHJvb3RFbGVtZW50YCBwcm9wZXJ0eS4KCiAgICBTZWUgdGhlIGRvY3VtZW50YXRpb24gZm9yIGBFbWJlci5FdmVudERpc3BhdGNoZXJgIGZvciBtb3JlIGluZm9ybWF0aW9uLgoKICAgIEBwcm9wZXJ0eSBldmVudERpc3BhdGNoZXIKICAgIEB0eXBlIEVtYmVyLkV2ZW50RGlzcGF0Y2hlcgogICAgQGRlZmF1bHQgbnVsbAogICovCiAgZXZlbnREaXNwYXRjaGVyOiBudWxsLAoKICAvKioKICAgIFRoZSBET00gZXZlbnRzIGZvciB3aGljaCB0aGUgZXZlbnQgZGlzcGF0Y2hlciBzaG91bGQgbGlzdGVuLgoKICAgIEJ5IGRlZmF1bHQsIHRoZSBhcHBsaWNhdGlvbidzIGBFbWJlci5FdmVudERpc3BhdGNoZXJgIGxpc3RlbnMKICAgIGZvciBhIHNldCBvZiBzdGFuZGFyZCBET00gZXZlbnRzLCBzdWNoIGFzIGBtb3VzZWRvd25gIGFuZAogICAgYGtleXVwYCwgYW5kIGRlbGVnYXRlcyB0aGVtIHRvIHlvdXIgYXBwbGljYXRpb24ncyBgRW1iZXIuVmlld2AKICAgIGluc3RhbmNlcy4KCiAgICBJZiB5b3Ugd291bGQgbGlrZSBhZGRpdGlvbmFsIGJ1YmJsaW5nIGV2ZW50cyB0byBiZSBkZWxlZ2F0ZWQgdG8geW91cgogICAgdmlld3MsIHNldCB5b3VyIGBFbWJlci5BcHBsaWNhdGlvbmAncyBgY3VzdG9tRXZlbnRzYCBwcm9wZXJ0eQogICAgdG8gYSBoYXNoIGNvbnRhaW5pbmcgdGhlIERPTSBldmVudCBuYW1lIGFzIHRoZSBrZXkgYW5kIHRoZQogICAgY29ycmVzcG9uZGluZyB2aWV3IG1ldGhvZCBuYW1lIGFzIHRoZSB2YWx1ZS4gRm9yIGV4YW1wbGU6CgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwID0gRW1iZXIuQXBwbGljYXRpb24uY3JlYXRlKHsKICAgICAgY3VzdG9tRXZlbnRzOiB7CiAgICAgICAgLy8gYWRkIHN1cHBvcnQgZm9yIHRoZSBwYXN0ZSBldmVudAogICAgICAgIHBhc3RlOiAicGFzdGUiCiAgICAgIH0KICAgIH0pOwogICAgYGBgCgogICAgQHByb3BlcnR5IGN1c3RvbUV2ZW50cwogICAgQHR5cGUgT2JqZWN0CiAgICBAZGVmYXVsdCBudWxsCiAgKi8KICBjdXN0b21FdmVudHM6IG51bGwsCgogIC8vIFN0YXJ0IG9mZiB0aGUgbnVtYmVyIG9mIGRlZmVycmFscyBhdCAxLiBUaGlzIHdpbGwgYmUKICAvLyBkZWNyZW1lbnRlZCBieSB0aGUgQXBwbGljYXRpb24ncyBvd24gYGluaXRpYWxpemVgIG1ldGhvZC4KICBfcmVhZGluZXNzRGVmZXJyYWxzOiAxLAoKICBpbml0OiBmdW5jdGlvbigpIHsKICAgIGlmICghdGhpcy4kKSB7IHRoaXMuJCA9IEVtYmVyLiQ7IH0KICAgIHRoaXMuX19jb250YWluZXJfXyA9IHRoaXMuYnVpbGRDb250YWluZXIoKTsKCiAgICB0aGlzLlJvdXRlciA9IHRoaXMuZGVmYXVsdFJvdXRlcigpOwoKICAgIHRoaXMuX3N1cGVyKCk7CgogICAgdGhpcy5zY2hlZHVsZUluaXRpYWxpemUoKTsKCiAgICBFbWJlci5saWJyYXJpZXMucmVnaXN0ZXJDb3JlTGlicmFyeSgnSGFuZGxlYmFycycsIEVtYmVyLkhhbmRsZWJhcnMuVkVSU0lPTik7CiAgICBFbWJlci5saWJyYXJpZXMucmVnaXN0ZXJDb3JlTGlicmFyeSgnalF1ZXJ5JywgRW1iZXIuJCgpLmpxdWVyeSk7CgogICAgaWYgKCBFbWJlci5MT0dfVkVSU0lPTiApIHsKICAgICAgRW1iZXIuTE9HX1ZFUlNJT04gPSBmYWxzZTsgLy8gd2Ugb25seSBuZWVkIHRvIHNlZSB0aGlzIG9uY2UgcGVyIEFwcGxpY2F0aW9uI2luaXQKICAgICAgdmFyIG1heE5hbWVMZW5ndGggPSBNYXRoLm1heC5hcHBseSh0aGlzLCBFbWJlci5BKEVtYmVyLmxpYnJhcmllcykubWFwQnkoIm5hbWUubGVuZ3RoIikpOwoKICAgICAgRW1iZXIuZGVidWcoJy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0nKTsKICAgICAgRW1iZXIubGlicmFyaWVzLmVhY2goZnVuY3Rpb24obmFtZSwgdmVyc2lvbikgewogICAgICAgIHZhciBzcGFjZXMgPSBuZXcgQXJyYXkobWF4TmFtZUxlbmd0aCAtIG5hbWUubGVuZ3RoICsgMSkuam9pbigiICIpOwogICAgICAgIEVtYmVyLmRlYnVnKFtuYW1lLCBzcGFjZXMsICcgOiAnLCB2ZXJzaW9uXS5qb2luKCIiKSk7CiAgICAgIH0pOwogICAgICBFbWJlci5kZWJ1ZygnLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLScpOwogICAgfQogIH0sCgogIC8qKgogICAgQnVpbGQgdGhlIGNvbnRhaW5lciBmb3IgdGhlIGN1cnJlbnQgYXBwbGljYXRpb24uCgogICAgQWxzbyByZWdpc3RlciBhIGRlZmF1bHQgYXBwbGljYXRpb24gdmlldyBpbiBjYXNlIHRoZSBhcHBsaWNhdGlvbgogICAgaXRzZWxmIGRvZXMgbm90LgoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIGJ1aWxkQ29udGFpbmVyCiAgICBAcmV0dXJuIHtFbWJlci5Db250YWluZXJ9IHRoZSBjb25maWd1cmVkIGNvbnRhaW5lcgogICovCiAgYnVpbGRDb250YWluZXI6IGZ1bmN0aW9uKCkgewogICAgdmFyIGNvbnRhaW5lciA9IHRoaXMuX19jb250YWluZXJfXyA9IEFwcGxpY2F0aW9uLmJ1aWxkQ29udGFpbmVyKHRoaXMpOwoKICAgIHJldHVybiBjb250YWluZXI7CiAgfSwKCiAgLyoqCiAgICBJZiB0aGUgYXBwbGljYXRpb24gaGFzIG5vdCBvcHRlZCBvdXQgb2Ygcm91dGluZyBhbmQgaGFzIG5vdCBleHBsaWNpdGx5CiAgICBkZWZpbmVkIGEgcm91dGVyLCBzdXBwbHkgYSBkZWZhdWx0IHJvdXRlciBmb3IgdGhlIGFwcGxpY2F0aW9uIGF1dGhvcgogICAgdG8gY29uZmlndXJlLgoKICAgIFRoaXMgYWxsb3dzIGFwcGxpY2F0aW9uIGRldmVsb3BlcnMgdG8gZG86CgogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIEFwcCA9IEVtYmVyLkFwcGxpY2F0aW9uLmNyZWF0ZSgpOwoKICAgIEFwcC5Sb3V0ZXIubWFwKGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnJlc291cmNlKCdwb3N0cycpOwogICAgfSk7CiAgICBgYGAKCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBkZWZhdWx0Um91dGVyCiAgICBAcmV0dXJuIHtFbWJlci5Sb3V0ZXJ9IHRoZSBkZWZhdWx0IHJvdXRlcgogICovCgogIGRlZmF1bHRSb3V0ZXI6IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuUm91dGVyID09PSBmYWxzZSkgeyByZXR1cm47IH0KICAgIHZhciBjb250YWluZXIgPSB0aGlzLl9fY29udGFpbmVyX187CgogICAgaWYgKHRoaXMuUm91dGVyKSB7CiAgICAgIGNvbnRhaW5lci51bnJlZ2lzdGVyKCdyb3V0ZXI6bWFpbicpOwogICAgICBjb250YWluZXIucmVnaXN0ZXIoJ3JvdXRlcjptYWluJywgdGhpcy5Sb3V0ZXIpOwogICAgfQoKICAgIHJldHVybiBjb250YWluZXIubG9va3VwRmFjdG9yeSgncm91dGVyOm1haW4nKTsKICB9LAoKICAvKioKICAgIEF1dG9tYXRpY2FsbHkgaW5pdGlhbGl6ZSB0aGUgYXBwbGljYXRpb24gb25jZSB0aGUgRE9NIGhhcwogICAgYmVjb21lIHJlYWR5LgoKICAgIFRoZSBpbml0aWFsaXphdGlvbiBpdHNlbGYgaXMgc2NoZWR1bGVkIG9uIHRoZSBhY3Rpb25zIHF1ZXVlCiAgICB3aGljaCBlbnN1cmVzIHRoYXQgYXBwbGljYXRpb24gbG9hZGluZyBmaW5pc2hlcyBiZWZvcmUKICAgIGJvb3RpbmcuCgogICAgSWYgeW91IGFyZSBhc3luY2hyb25vdXNseSBsb2FkaW5nIGNvZGUsIHlvdSBzaG91bGQgY2FsbAogICAgYGRlZmVyUmVhZGluZXNzKClgIHRvIGRlZmVyIGJvb3RpbmcsIGFuZCB0aGVuIGNhbGwKICAgIGBhZHZhbmNlUmVhZGluZXNzKClgIG9uY2UgYWxsIG9mIHlvdXIgY29kZSBoYXMgZmluaXNoZWQKICAgIGxvYWRpbmcuCgogICAgQHByaXZhdGUKICAgIEBtZXRob2Qgc2NoZWR1bGVJbml0aWFsaXplCiAgKi8KICBzY2hlZHVsZUluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIGlmICghdGhpcy4kIHx8IHRoaXMuJC5pc1JlYWR5KSB7CiAgICAgIEVtYmVyLnJ1bi5zY2hlZHVsZSgnYWN0aW9ucycsIHNlbGYsICdfaW5pdGlhbGl6ZScpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy4kKCkucmVhZHkoZnVuY3Rpb24gcnVuSW5pdGlhbGl6ZSgpIHsKICAgICAgICBFbWJlci5ydW4oc2VsZiwgJ19pbml0aWFsaXplJyk7CiAgICAgIH0pOwogICAgfQogIH0sCgogIC8qKgogICAgVXNlIHRoaXMgdG8gZGVmZXIgcmVhZGluZXNzIHVudGlsIHNvbWUgY29uZGl0aW9uIGlzIHRydWUuCgogICAgRXhhbXBsZToKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAgPSBFbWJlci5BcHBsaWNhdGlvbi5jcmVhdGUoKTsKICAgIEFwcC5kZWZlclJlYWRpbmVzcygpOwoKICAgIGpRdWVyeS5nZXRKU09OKCIvYXV0aC10b2tlbiIsIGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgIEFwcC50b2tlbiA9IHRva2VuOwogICAgICBBcHAuYWR2YW5jZVJlYWRpbmVzcygpOwogICAgfSk7CiAgICBgYGAKCiAgICBUaGlzIGFsbG93cyB5b3UgdG8gcGVyZm9ybSBhc3luY2hyb25vdXMgc2V0dXAgbG9naWMgYW5kIGRlZmVyCiAgICBib290aW5nIHlvdXIgYXBwbGljYXRpb24gdW50aWwgdGhlIHNldHVwIGhhcyBmaW5pc2hlZC4KCiAgICBIb3dldmVyLCBpZiB0aGUgc2V0dXAgcmVxdWlyZXMgYSBsb2FkaW5nIFVJLCBpdCBtaWdodCBiZSBiZXR0ZXIKICAgIHRvIHVzZSB0aGUgcm91dGVyIGZvciB0aGlzIHB1cnBvc2UuCgogICAgQG1ldGhvZCBkZWZlclJlYWRpbmVzcwogICovCiAgZGVmZXJSZWFkaW5lc3M6IGZ1bmN0aW9uKCkgewogICAgRW1iZXIuYXNzZXJ0KCJZb3UgbXVzdCBjYWxsIGRlZmVyUmVhZGluZXNzIG9uIGFuIGluc3RhbmNlIG9mIEVtYmVyLkFwcGxpY2F0aW9uIiwgdGhpcyBpbnN0YW5jZW9mIEVtYmVyLkFwcGxpY2F0aW9uKTsKICAgIEVtYmVyLmFzc2VydCgiWW91IGNhbm5vdCBkZWZlciByZWFkaW5lc3Mgc2luY2UgdGhlIGByZWFkeSgpYCBob29rIGhhcyBhbHJlYWR5IGJlZW4gY2FsbGVkLiIsIHRoaXMuX3JlYWRpbmVzc0RlZmVycmFscyA+IDApOwogICAgdGhpcy5fcmVhZGluZXNzRGVmZXJyYWxzKys7CiAgfSwKCiAgLyoqCiAgICBDYWxsIGBhZHZhbmNlUmVhZGluZXNzYCBhZnRlciBhbnkgYXN5bmNocm9ub3VzIHNldHVwIGxvZ2ljIGhhcyBjb21wbGV0ZWQuCiAgICBFYWNoIGNhbGwgdG8gYGRlZmVyUmVhZGluZXNzYCBtdXN0IGJlIG1hdGNoZWQgYnkgYSBjYWxsIHRvIGBhZHZhbmNlUmVhZGluZXNzYAogICAgb3IgdGhlIGFwcGxpY2F0aW9uIHdpbGwgbmV2ZXIgYmVjb21lIHJlYWR5IGFuZCByb3V0aW5nIHdpbGwgbm90IGJlZ2luLgoKICAgIEBtZXRob2QgYWR2YW5jZVJlYWRpbmVzcwogICAgQHNlZSB7RW1iZXIuQXBwbGljYXRpb24jZGVmZXJSZWFkaW5lc3N9CiAgKi8KICBhZHZhbmNlUmVhZGluZXNzOiBmdW5jdGlvbigpIHsKICAgIEVtYmVyLmFzc2VydCgiWW91IG11c3QgY2FsbCBhZHZhbmNlUmVhZGluZXNzIG9uIGFuIGluc3RhbmNlIG9mIEVtYmVyLkFwcGxpY2F0aW9uIiwgdGhpcyBpbnN0YW5jZW9mIEVtYmVyLkFwcGxpY2F0aW9uKTsKICAgIHRoaXMuX3JlYWRpbmVzc0RlZmVycmFscy0tOwoKICAgIGlmICh0aGlzLl9yZWFkaW5lc3NEZWZlcnJhbHMgPT09IDApIHsKICAgICAgRW1iZXIucnVuLm9uY2UodGhpcywgdGhpcy5kaWRCZWNvbWVSZWFkeSk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICByZWdpc3RlcnMgYSBmYWN0b3J5IGZvciBsYXRlciBpbmplY3Rpb24KCiAgICBFeGFtcGxlOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIEFwcCA9IEVtYmVyLkFwcGxpY2F0aW9uLmNyZWF0ZSgpOwoKICAgIEFwcC5QZXJzb24gID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7fSk7CiAgICBBcHAuT3JhbmdlICA9IEVtYmVyLk9iamVjdC5leHRlbmQoe30pOwogICAgQXBwLkVtYWlsICAgPSBFbWJlci5PYmplY3QuZXh0ZW5kKHt9KTsKICAgIEFwcC5zZXNzaW9uID0gRW1iZXIuT2JqZWN0LmNyZWF0ZSh7fSk7CgogICAgQXBwLnJlZ2lzdGVyKCdtb2RlbDp1c2VyJywgQXBwLlBlcnNvbiwge3NpbmdsZXRvbjogZmFsc2UgfSk7CiAgICBBcHAucmVnaXN0ZXIoJ2ZydWl0OmZhdm9yaXRlJywgQXBwLk9yYW5nZSk7CiAgICBBcHAucmVnaXN0ZXIoJ2NvbW11bmljYXRpb246bWFpbicsIEFwcC5FbWFpbCwge3NpbmdsZXRvbjogZmFsc2V9KTsKICAgIEFwcC5yZWdpc3Rlcignc2Vzc2lvbicsIEFwcC5zZXNzaW9uLCB7aW5zdGFudGlhdGU6IGZhbHNlfSk7CiAgICBgYGAKCiAgICBAbWV0aG9kIHJlZ2lzdGVyCiAgICBAcGFyYW0gIGZ1bGxOYW1lIHtTdHJpbmd9IHR5cGU6bmFtZSAoZS5nLiwgJ21vZGVsOnVzZXInKQogICAgQHBhcmFtICBmYWN0b3J5IHtGdW5jdGlvbn0gKGUuZy4sIEFwcC5QZXJzb24pCiAgICBAcGFyYW0gIG9wdGlvbnMge1N0cmluZ30gKG9wdGlvbmFsKQogICoqLwogIHJlZ2lzdGVyOiBmdW5jdGlvbigpIHsKICAgIHZhciBjb250YWluZXIgPSB0aGlzLl9fY29udGFpbmVyX187CiAgICBjb250YWluZXIucmVnaXN0ZXIuYXBwbHkoY29udGFpbmVyLCBhcmd1bWVudHMpOwogIH0sCiAgLyoqCiAgICBkZWZpbmVzIGFuIGluamVjdGlvbiBvciB0eXBlSW5qZWN0aW9uCgogICAgRXhhbXBsZToKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuaW5qZWN0KDxmdWxsX25hbWUgb3IgdHlwZT4sIDxwcm9wZXJ0eSBuYW1lPiwgPGZ1bGxfbmFtZT4pCiAgICBBcHAuaW5qZWN0KCdtb2RlbDp1c2VyJywgJ2VtYWlsJywgJ21vZGVsOmVtYWlsJykKICAgIEFwcC5pbmplY3QoJ21vZGVsJywgJ3NvdXJjZScsICdzb3VyY2U6bWFpbicpCiAgICBgYGAKCiAgICBAbWV0aG9kIGluamVjdAogICAgQHBhcmFtICBmYWN0b3J5TmFtZU9yVHlwZSB7U3RyaW5nfQogICAgQHBhcmFtICBwcm9wZXJ0eSB7U3RyaW5nfQogICAgQHBhcmFtICBpbmplY3Rpb25OYW1lIHtTdHJpbmd9CiAgKiovCiAgaW5qZWN0OiBmdW5jdGlvbigpIHsKICAgIHZhciBjb250YWluZXIgPSB0aGlzLl9fY29udGFpbmVyX187CiAgICBjb250YWluZXIuaW5qZWN0aW9uLmFwcGx5KGNvbnRhaW5lciwgYXJndW1lbnRzKTsKICB9LAoKICAvKioKICAgIENhbGxpbmcgaW5pdGlhbGl6ZSBtYW51YWxseSBpcyBub3Qgc3VwcG9ydGVkLgoKICAgIFBsZWFzZSBzZWUgRW1iZXIuQXBwbGljYXRpb24jYWR2YW5jZVJlYWRpbmVzcyBhbmQKICAgIEVtYmVyLkFwcGxpY2F0aW9uI2RlZmVyUmVhZGluZXNzLgoKICAgIEBwcml2YXRlCiAgICBAZGVwcmVjYXRlZAogICAgQG1ldGhvZCBpbml0aWFsaXplCiAgICoqLwogIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgRW1iZXIuZGVwcmVjYXRlKCdDYWxsaW5nIGluaXRpYWxpemUgbWFudWFsbHkgaXMgbm90IHN1cHBvcnRlZC4gUGxlYXNlIHNlZSBFbWJlci5BcHBsaWNhdGlvbiNhZHZhbmNlUmVhZGluZXNzIGFuZCBFbWJlci5BcHBsaWNhdGlvbiNkZWZlclJlYWRpbmVzcycpOwogIH0sCiAgLyoqCiAgICBJbml0aWFsaXplIHRoZSBhcHBsaWNhdGlvbi4gVGhpcyBoYXBwZW5zIGF1dG9tYXRpY2FsbHkuCgogICAgUnVuIGFueSBpbml0aWFsaXplcnMgYW5kIHJ1biB0aGUgYXBwbGljYXRpb24gbG9hZCBob29rLiBUaGVzZSBob29rcyBtYXkKICAgIGNob29zZSB0byBkZWZlciByZWFkaW5lc3MuIEZvciBleGFtcGxlLCBhbiBhdXRoZW50aWNhdGlvbiBob29rIG1pZ2h0IHdhbnQKICAgIHRvIGRlZmVyIHJlYWRpbmVzcyB1bnRpbCB0aGUgYXV0aCB0b2tlbiBoYXMgYmVlbiByZXRyaWV2ZWQuCgogICAgQHByaXZhdGUKICAgIEBtZXRob2QgX2luaXRpYWxpemUKICAqLwogIF9pbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLmlzRGVzdHJveWVkKSB7IHJldHVybjsgfQoKICAgIC8vIEF0IHRoaXMgcG9pbnQsIHRoZSBBcHAuUm91dGVyIG11c3QgYWxyZWFkeSBiZSBhc3NpZ25lZAogICAgaWYgKHRoaXMuUm91dGVyKSB7CiAgICAgIHZhciBjb250YWluZXIgPSB0aGlzLl9fY29udGFpbmVyX187CiAgICAgIGNvbnRhaW5lci51bnJlZ2lzdGVyKCdyb3V0ZXI6bWFpbicpOwogICAgICBjb250YWluZXIucmVnaXN0ZXIoJ3JvdXRlcjptYWluJywgdGhpcy5Sb3V0ZXIpOwogICAgfQoKICAgIHRoaXMucnVuSW5pdGlhbGl6ZXJzKCk7CiAgICBFbWJlci5ydW5Mb2FkSG9va3MoJ2FwcGxpY2F0aW9uJywgdGhpcyk7CgogICAgLy8gQXQgdGhpcyBwb2ludCwgYW55IGluaXRpYWxpemVycyBvciBsb2FkIGhvb2tzIHRoYXQgd291bGQgaGF2ZSB3YW50ZWQKICAgIC8vIHRvIGRlZmVyIHJlYWRpbmVzcyBoYXZlIGZpcmVkLiBJbiBnZW5lcmFsLCBhZHZhbmNpbmcgcmVhZGluZXNzIGhlcmUKICAgIC8vIHdpbGwgcHJvY2VlZCB0byBkaWRCZWNvbWVSZWFkeS4KICAgIHRoaXMuYWR2YW5jZVJlYWRpbmVzcygpOwoKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAgUmVzZXQgdGhlIGFwcGxpY2F0aW9uLiBUaGlzIGlzIHR5cGljYWxseSB1c2VkIG9ubHkgaW4gdGVzdHMuIEl0IGNsZWFucyB1cAogICAgdGhlIGFwcGxpY2F0aW9uIGluIHRoZSBmb2xsb3dpbmcgb3JkZXI6CgogICAgMS4gRGVhY3RpdmF0ZSBleGlzdGluZyByb3V0ZXMKICAgIDIuIERlc3Ryb3kgYWxsIG9iamVjdHMgaW4gdGhlIGNvbnRhaW5lcgogICAgMy4gQ3JlYXRlIGEgbmV3IGFwcGxpY2F0aW9uIGNvbnRhaW5lcgogICAgNC4gUmUtcm91dGUgdG8gdGhlIGV4aXN0aW5nIHVybAoKICAgIFR5cGljYWwgRXhhbXBsZToKCiAgICBgYGBqYXZhc2NyaXB0CgogICAgdmFyIEFwcDsKCiAgICBFbWJlci5ydW4oZnVuY3Rpb24oKSB7CiAgICAgIEFwcCA9IEVtYmVyLkFwcGxpY2F0aW9uLmNyZWF0ZSgpOwogICAgfSk7CgogICAgbW9kdWxlKCJhY2NlcHRhbmNlIHRlc3QiLCB7CiAgICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgICBBcHAucmVzZXQoKTsKICAgICAgfQogICAgfSk7CgogICAgdGVzdCgiZmlyc3QgdGVzdCIsIGZ1bmN0aW9uKCkgewogICAgICAvLyBBcHAgaXMgZnJlc2hseSByZXNldAogICAgfSk7CgogICAgdGVzdCgiZmlyc3QgdGVzdCIsIGZ1bmN0aW9uKCkgewogICAgICAvLyBBcHAgaXMgYWdhaW4gZnJlc2hseSByZXNldAogICAgfSk7CiAgICBgYGAKCiAgICBBZHZhbmNlZCBFeGFtcGxlOgoKICAgIE9jY2FzaW9uYWxseSB5b3UgbWF5IHdhbnQgdG8gcHJldmVudCB0aGUgYXBwIGZyb20gaW5pdGlhbGl6aW5nIGR1cmluZwogICAgc2V0dXAuIFRoaXMgY291bGQgZW5hYmxlIGV4dHJhIGNvbmZpZ3VyYXRpb24sIG9yIGVuYWJsZSBhc3NlcnRpbmcgcHJpb3IKICAgIHRvIHRoZSBhcHAgYmVjb21pbmcgcmVhZHkuCgogICAgYGBgamF2YXNjcmlwdAoKICAgIHZhciBBcHA7CgogICAgRW1iZXIucnVuKGZ1bmN0aW9uKCkgewogICAgICBBcHAgPSBFbWJlci5BcHBsaWNhdGlvbi5jcmVhdGUoKTsKICAgIH0pOwoKICAgIG1vZHVsZSgiYWNjZXB0YW5jZSB0ZXN0IiwgewogICAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgICAgRW1iZXIucnVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgQXBwLnJlc2V0KCk7CiAgICAgICAgICBBcHAuZGVmZXJSZWFkaW5lc3MoKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CgogICAgdGVzdCgiZmlyc3QgdGVzdCIsIGZ1bmN0aW9uKCkgewogICAgICBvayh0cnVlLCAnc29tZXRoaW5nIGJlZm9yZSBhcHAgaXMgaW5pdGlhbGl6ZWQnKTsKCiAgICAgIEVtYmVyLnJ1bihmdW5jdGlvbigpIHsKICAgICAgICBBcHAuYWR2YW5jZVJlYWRpbmVzcygpOwogICAgICB9KTsKICAgICAgb2sodHJ1ZSwgJ3NvbWV0aGluZyBhZnRlciBhcHAgaXMgaW5pdGlhbGl6ZWQnKTsKICAgIH0pOwogICAgYGBgCgogICAgQG1ldGhvZCByZXNldAogICoqLwogIHJlc2V0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3JlYWRpbmVzc0RlZmVycmFscyA9IDE7CgogICAgZnVuY3Rpb24gaGFuZGxlUmVzZXQoKSB7CiAgICAgIHZhciByb3V0ZXIgPSB0aGlzLl9fY29udGFpbmVyX18ubG9va3VwKCdyb3V0ZXI6bWFpbicpOwogICAgICByb3V0ZXIucmVzZXQoKTsKCiAgICAgIEVtYmVyLnJ1bih0aGlzLl9fY29udGFpbmVyX18sICdkZXN0cm95Jyk7CgogICAgICB0aGlzLmJ1aWxkQ29udGFpbmVyKCk7CgogICAgICBFbWJlci5ydW4uc2NoZWR1bGUoJ2FjdGlvbnMnLCB0aGlzLCBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLl9pbml0aWFsaXplKCk7CiAgICAgIH0pOwogICAgfQoKICAgIEVtYmVyLnJ1bi5qb2luKHRoaXMsIGhhbmRsZVJlc2V0KTsKICB9LAoKICAvKioKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIHJ1bkluaXRpYWxpemVycwogICovCiAgcnVuSW5pdGlhbGl6ZXJzOiBmdW5jdGlvbigpIHsKICAgIHZhciBpbml0aWFsaXplcnMgPSBnZXQodGhpcy5jb25zdHJ1Y3RvciwgJ2luaXRpYWxpemVycycpLAogICAgICAgIGNvbnRhaW5lciA9IHRoaXMuX19jb250YWluZXJfXywKICAgICAgICBncmFwaCA9IG5ldyBFbWJlci5EQUcoKSwKICAgICAgICBuYW1lc3BhY2UgPSB0aGlzLAogICAgICAgIG5hbWUsIGluaXRpYWxpemVyOwoKICAgIGZvciAobmFtZSBpbiBpbml0aWFsaXplcnMpIHsKICAgICAgaW5pdGlhbGl6ZXIgPSBpbml0aWFsaXplcnNbbmFtZV07CiAgICAgIGdyYXBoLmFkZEVkZ2VzKGluaXRpYWxpemVyLm5hbWUsIGluaXRpYWxpemVyLmluaXRpYWxpemUsIGluaXRpYWxpemVyLmJlZm9yZSwgaW5pdGlhbGl6ZXIuYWZ0ZXIpOwogICAgfQoKICAgIGdyYXBoLnRvcHNvcnQoZnVuY3Rpb24gKHZlcnRleCkgewogICAgICB2YXIgaW5pdGlhbGl6ZXIgPSB2ZXJ0ZXgudmFsdWU7CiAgICAgIEVtYmVyLmFzc2VydCgiTm8gYXBwbGljYXRpb24gaW5pdGlhbGl6ZXIgbmFtZWQgJyIrdmVydGV4Lm5hbWUrIiciLCBpbml0aWFsaXplcik7CiAgICAgIGluaXRpYWxpemVyKGNvbnRhaW5lciwgbmFtZXNwYWNlKTsKICAgIH0pOwogIH0sCgogIC8qKgogICAgQHByaXZhdGUKICAgIEBtZXRob2QgZGlkQmVjb21lUmVhZHkKICAqLwogIGRpZEJlY29tZVJlYWR5OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuc2V0dXBFdmVudERpc3BhdGNoZXIoKTsKICAgIHRoaXMucmVhZHkoKTsgLy8gdXNlciBob29rCiAgICB0aGlzLnN0YXJ0Um91dGluZygpOwoKICAgIGlmICghRW1iZXIudGVzdGluZykgewogICAgICAvLyBFYWdlcmx5IG5hbWUgYWxsIGNsYXNzZXMgdGhhdCBhcmUgYWxyZWFkeSBsb2FkZWQKICAgICAgRW1iZXIuTmFtZXNwYWNlLnByb2Nlc3NBbGwoKTsKICAgICAgRW1iZXIuQk9PVEVEID0gdHJ1ZTsKICAgIH0KCiAgICB0aGlzLnJlc29sdmUodGhpcyk7CiAgfSwKCiAgLyoqCiAgICBTZXR1cCB1cCB0aGUgZXZlbnQgZGlzcGF0Y2hlciB0byByZWNlaXZlIGV2ZW50cyBvbiB0aGUKICAgIGFwcGxpY2F0aW9uJ3MgYHJvb3RFbGVtZW50YCB3aXRoIGFueSByZWdpc3RlcmVkCiAgICBgY3VzdG9tRXZlbnRzYC4KCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBzZXR1cEV2ZW50RGlzcGF0Y2hlcgogICovCiAgc2V0dXBFdmVudERpc3BhdGNoZXI6IGZ1bmN0aW9uKCkgewogICAgdmFyIGN1c3RvbUV2ZW50cyA9IGdldCh0aGlzLCAnY3VzdG9tRXZlbnRzJyksCiAgICAgICAgcm9vdEVsZW1lbnQgPSBnZXQodGhpcywgJ3Jvb3RFbGVtZW50JyksCiAgICAgICAgZGlzcGF0Y2hlciA9IHRoaXMuX19jb250YWluZXJfXy5sb29rdXAoJ2V2ZW50X2Rpc3BhdGNoZXI6bWFpbicpOwoKICAgIHNldCh0aGlzLCAnZXZlbnREaXNwYXRjaGVyJywgZGlzcGF0Y2hlcik7CiAgICBkaXNwYXRjaGVyLnNldHVwKGN1c3RvbUV2ZW50cywgcm9vdEVsZW1lbnQpOwogIH0sCgogIC8qKgogICAgdHJpZ2dlciBhIG5ldyBjYWxsIHRvIGByb3V0ZWAgd2hlbmV2ZXIgdGhlIFVSTCBjaGFuZ2VzLgogICAgSWYgdGhlIGFwcGxpY2F0aW9uIGhhcyBhIHJvdXRlciwgdXNlIGl0IHRvIHJvdXRlIHRvIHRoZSBjdXJyZW50IFVSTCwgYW5kCgogICAgQHByaXZhdGUKICAgIEBtZXRob2Qgc3RhcnRSb3V0aW5nCiAgICBAcHJvcGVydHkgcm91dGVyIHtFbWJlci5Sb3V0ZXJ9CiAgKi8KICBzdGFydFJvdXRpbmc6IGZ1bmN0aW9uKCkgewogICAgdmFyIHJvdXRlciA9IHRoaXMuX19jb250YWluZXJfXy5sb29rdXAoJ3JvdXRlcjptYWluJyk7CiAgICBpZiAoIXJvdXRlcikgeyByZXR1cm47IH0KCiAgICByb3V0ZXIuc3RhcnRSb3V0aW5nKCk7CiAgfSwKCiAgaGFuZGxlVVJMOiBmdW5jdGlvbih1cmwpIHsKICAgIHZhciByb3V0ZXIgPSB0aGlzLl9fY29udGFpbmVyX18ubG9va3VwKCdyb3V0ZXI6bWFpbicpOwoKICAgIHJvdXRlci5oYW5kbGVVUkwodXJsKTsKICB9LAoKICAvKioKICAgIENhbGxlZCB3aGVuIHRoZSBBcHBsaWNhdGlvbiBoYXMgYmVjb21lIHJlYWR5LgogICAgVGhlIGNhbGwgd2lsbCBiZSBkZWxheWVkIHVudGlsIHRoZSBET00gaGFzIGJlY29tZSByZWFkeS4KCiAgICBAZXZlbnQgcmVhZHkKICAqLwogIHJlYWR5OiBFbWJlci5LLAoKICAvKioKICAgIEBkZXByZWNhdGVkIFVzZSAnUmVzb2x2ZXInIGluc3RlYWQKICAgIFNldCB0aGlzIHRvIHByb3ZpZGUgYW4gYWx0ZXJuYXRlIGNsYXNzIHRvIGBFbWJlci5EZWZhdWx0UmVzb2x2ZXJgCgoKICAgIEBwcm9wZXJ0eSByZXNvbHZlcgogICovCiAgcmVzb2x2ZXI6IG51bGwsCgogIC8qKgogICAgU2V0IHRoaXMgdG8gcHJvdmlkZSBhbiBhbHRlcm5hdGUgY2xhc3MgdG8gYEVtYmVyLkRlZmF1bHRSZXNvbHZlcmAKCiAgICBAcHJvcGVydHkgcmVzb2x2ZXIKICAqLwogIFJlc29sdmVyOiBudWxsLAoKICB3aWxsRGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICBFbWJlci5CT09URUQgPSBmYWxzZTsKCiAgICB0aGlzLl9fY29udGFpbmVyX18uZGVzdHJveSgpOwogIH0sCgogIGluaXRpYWxpemVyOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB0aGlzLmNvbnN0cnVjdG9yLmluaXRpYWxpemVyKG9wdGlvbnMpOwogIH0KfSk7CgpFbWJlci5BcHBsaWNhdGlvbi5yZW9wZW5DbGFzcyh7CiAgaW5pdGlhbGl6ZXJzOiB7fSwKICBpbml0aWFsaXplcjogZnVuY3Rpb24oaW5pdGlhbGl6ZXIpIHsKICAgIC8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IGluaXRpYWxpemVyIGJlaW5nIGFkZGVkIHRvIGEgc3ViY2xhc3MsIHdlIGFyZSBnb2luZyB0byByZW9wZW4gdGhlIGNsYXNzCiAgICAvLyB0byBtYWtlIHN1cmUgd2UgaGF2ZSBhIG5ldyBgaW5pdGlhbGl6ZXJzYCBvYmplY3QsIHdoaWNoIGV4dGVuZHMgZnJvbSB0aGUgcGFyZW50IGNsYXNzJyB1c2luZwogICAgLy8gcHJvdG90eXBhbCBpbmhlcml0YW5jZS4gV2l0aG91dCB0aGlzLCBhdHRlbXB0aW5nIHRvIGFkZCBpbml0aWFsaXplcnMgdG8gdGhlIHN1YmNsYXNzIHdvdWxkCiAgICAvLyBwb2xsdXRlIHRoZSBwYXJlbnQgY2xhc3MgYXMgd2VsbCBhcyBvdGhlciBzdWJjbGFzc2VzLgogICAgaWYgKHRoaXMuc3VwZXJjbGFzcy5pbml0aWFsaXplcnMgIT09IHVuZGVmaW5lZCAmJiB0aGlzLnN1cGVyY2xhc3MuaW5pdGlhbGl6ZXJzID09PSB0aGlzLmluaXRpYWxpemVycykgewogICAgICB0aGlzLnJlb3BlbkNsYXNzKHsKICAgICAgICBpbml0aWFsaXplcnM6IEVtYmVyLmNyZWF0ZSh0aGlzLmluaXRpYWxpemVycykKICAgICAgfSk7CiAgICB9CgogICAgRW1iZXIuYXNzZXJ0KCJUaGUgaW5pdGlhbGl6ZXIgJyIgKyBpbml0aWFsaXplci5uYW1lICsgIicgaGFzIGFscmVhZHkgYmVlbiByZWdpc3RlcmVkIiwgIXRoaXMuaW5pdGlhbGl6ZXJzW2luaXRpYWxpemVyLm5hbWVdKTsKICAgIEVtYmVyLmFzc2VydCgiQW4gaW5pdGlhbGl6ZXIgY2Fubm90IGJlIHJlZ2lzdGVyZWQgd2l0aCBib3RoIGEgYmVmb3JlIGFuZCBhbiBhZnRlciIsICEoaW5pdGlhbGl6ZXIuYmVmb3JlICYmIGluaXRpYWxpemVyLmFmdGVyKSk7CiAgICBFbWJlci5hc3NlcnQoIkFuIGluaXRpYWxpemVyIGNhbm5vdCBiZSByZWdpc3RlcmVkIHdpdGhvdXQgYW4gaW5pdGlhbGl6ZSBmdW5jdGlvbiIsIEVtYmVyLmNhbkludm9rZShpbml0aWFsaXplciwgJ2luaXRpYWxpemUnKSk7CgogICAgdGhpcy5pbml0aWFsaXplcnNbaW5pdGlhbGl6ZXIubmFtZV0gPSBpbml0aWFsaXplcjsKICB9LAoKICAvKioKICAgIFRoaXMgY3JlYXRlcyBhIGNvbnRhaW5lciB3aXRoIHRoZSBkZWZhdWx0IEVtYmVyIG5hbWluZyBjb252ZW50aW9ucy4KCiAgICBJdCBhbHNvIGNvbmZpZ3VyZXMgdGhlIGNvbnRhaW5lcjoKCiAgICAqIHJlZ2lzdGVyZWQgdmlld3MgYXJlIGNyZWF0ZWQgZXZlcnkgdGltZSB0aGV5IGFyZSBsb29rZWQgdXAgKHRoZXkgYXJlCiAgICAgIG5vdCBzaW5nbGV0b25zKQogICAgKiByZWdpc3RlcmVkIHRlbXBsYXRlcyBhcmUgbm90IGZhY3RvcmllczsgdGhlIHJlZ2lzdGVyZWQgdmFsdWUgaXMKICAgICAgcmV0dXJuZWQgZGlyZWN0bHkuCiAgICAqIHRoZSByb3V0ZXIgcmVjZWl2ZXMgdGhlIGFwcGxpY2F0aW9uIGFzIGl0cyBgbmFtZXNwYWNlYCBwcm9wZXJ0eQogICAgKiBhbGwgY29udHJvbGxlcnMgcmVjZWl2ZSB0aGUgcm91dGVyIGFzIHRoZWlyIGB0YXJnZXRgIGFuZCBgY29udHJvbGxlcnNgCiAgICAgIHByb3BlcnRpZXMKICAgICogYWxsIGNvbnRyb2xsZXJzIHJlY2VpdmUgdGhlIGFwcGxpY2F0aW9uIGFzIHRoZWlyIGBuYW1lc3BhY2VgIHByb3BlcnR5CiAgICAqIHRoZSBhcHBsaWNhdGlvbiB2aWV3IHJlY2VpdmVzIHRoZSBhcHBsaWNhdGlvbiBjb250cm9sbGVyIGFzIGl0cwogICAgICBgY29udHJvbGxlcmAgcHJvcGVydHkKICAgICogdGhlIGFwcGxpY2F0aW9uIHZpZXcgcmVjZWl2ZXMgdGhlIGFwcGxpY2F0aW9uIHRlbXBsYXRlIGFzIGl0cwogICAgICBgZGVmYXVsdFRlbXBsYXRlYCBwcm9wZXJ0eQoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIGJ1aWxkQ29udGFpbmVyCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge0VtYmVyLkFwcGxpY2F0aW9ufSBuYW1lc3BhY2UgdGhlIGFwcGxpY2F0aW9uIHRvIGJ1aWxkIHRoZQogICAgICBjb250YWluZXIgZm9yLgogICAgQHJldHVybiB7RW1iZXIuQ29udGFpbmVyfSB0aGUgYnVpbHQgY29udGFpbmVyCiAgKi8KICBidWlsZENvbnRhaW5lcjogZnVuY3Rpb24obmFtZXNwYWNlKSB7CiAgICB2YXIgY29udGFpbmVyID0gbmV3IEVtYmVyLkNvbnRhaW5lcigpOwoKICAgIEVtYmVyLkNvbnRhaW5lci5kZWZhdWx0Q29udGFpbmVyID0gbmV3IERlcHJlY2F0ZWRDb250YWluZXIoY29udGFpbmVyKTsKCiAgICBjb250YWluZXIuc2V0ID0gRW1iZXIuc2V0OwogICAgY29udGFpbmVyLnJlc29sdmVyICA9IHJlc29sdmVyRm9yKG5hbWVzcGFjZSk7CiAgICBjb250YWluZXIubm9ybWFsaXplID0gY29udGFpbmVyLnJlc29sdmVyLm5vcm1hbGl6ZTsKICAgIGNvbnRhaW5lci5kZXNjcmliZSAgPSBjb250YWluZXIucmVzb2x2ZXIuZGVzY3JpYmU7CiAgICBjb250YWluZXIubWFrZVRvU3RyaW5nID0gY29udGFpbmVyLnJlc29sdmVyLm1ha2VUb1N0cmluZzsKCiAgICBjb250YWluZXIub3B0aW9uc0ZvclR5cGUoJ2NvbXBvbmVudCcsIHsgc2luZ2xldG9uOiBmYWxzZSB9KTsKICAgIGNvbnRhaW5lci5vcHRpb25zRm9yVHlwZSgndmlldycsIHsgc2luZ2xldG9uOiBmYWxzZSB9KTsKICAgIGNvbnRhaW5lci5vcHRpb25zRm9yVHlwZSgndGVtcGxhdGUnLCB7IGluc3RhbnRpYXRlOiBmYWxzZSB9KTsKICAgIGNvbnRhaW5lci5vcHRpb25zRm9yVHlwZSgnaGVscGVyJywgeyBpbnN0YW50aWF0ZTogZmFsc2UgfSk7CgogICAgY29udGFpbmVyLnJlZ2lzdGVyKCdhcHBsaWNhdGlvbjptYWluJywgbmFtZXNwYWNlLCB7IGluc3RhbnRpYXRlOiBmYWxzZSB9KTsKCiAgICBjb250YWluZXIucmVnaXN0ZXIoJ2NvbnRyb2xsZXI6YmFzaWMnLCBFbWJlci5Db250cm9sbGVyLCB7IGluc3RhbnRpYXRlOiBmYWxzZSB9KTsKICAgIGNvbnRhaW5lci5yZWdpc3RlcignY29udHJvbGxlcjpvYmplY3QnLCBFbWJlci5PYmplY3RDb250cm9sbGVyLCB7IGluc3RhbnRpYXRlOiBmYWxzZSB9KTsKICAgIGNvbnRhaW5lci5yZWdpc3RlcignY29udHJvbGxlcjphcnJheScsIEVtYmVyLkFycmF5Q29udHJvbGxlciwgeyBpbnN0YW50aWF0ZTogZmFsc2UgfSk7CiAgICBjb250YWluZXIucmVnaXN0ZXIoJ3JvdXRlOmJhc2ljJywgRW1iZXIuUm91dGUsIHsgaW5zdGFudGlhdGU6IGZhbHNlIH0pOwogICAgY29udGFpbmVyLnJlZ2lzdGVyKCdldmVudF9kaXNwYXRjaGVyOm1haW4nLCBFbWJlci5FdmVudERpc3BhdGNoZXIpOwoKICAgIGNvbnRhaW5lci5yZWdpc3Rlcigncm91dGVyOm1haW4nLCAgRW1iZXIuUm91dGVyKTsKICAgIGNvbnRhaW5lci5pbmplY3Rpb24oJ3JvdXRlcjptYWluJywgJ25hbWVzcGFjZScsICdhcHBsaWNhdGlvbjptYWluJyk7CgogICAgY29udGFpbmVyLmluamVjdGlvbignY29udHJvbGxlcicsICd0YXJnZXQnLCAncm91dGVyOm1haW4nKTsKICAgIGNvbnRhaW5lci5pbmplY3Rpb24oJ2NvbnRyb2xsZXInLCAnbmFtZXNwYWNlJywgJ2FwcGxpY2F0aW9uOm1haW4nKTsKCiAgICBjb250YWluZXIuaW5qZWN0aW9uKCdyb3V0ZScsICdyb3V0ZXInLCAncm91dGVyOm1haW4nKTsKCiAgICByZXR1cm4gY29udGFpbmVyOwogIH0KfSk7CgovKioKICBUaGlzIGZ1bmN0aW9uIGRlZmluZXMgdGhlIGRlZmF1bHQgbG9va3VwIHJ1bGVzIGZvciBjb250YWluZXIgbG9va3VwczoKCiAgKiB0ZW1wbGF0ZXMgYXJlIGxvb2tlZCB1cCBvbiBgRW1iZXIuVEVNUExBVEVTYAogICogb3RoZXIgbmFtZXMgYXJlIGxvb2tlZCB1cCBvbiB0aGUgYXBwbGljYXRpb24gYWZ0ZXIgY2xhc3NpZnlpbmcgdGhlIG5hbWUuCiAgICBGb3IgZXhhbXBsZSwgYGNvbnRyb2xsZXI6cG9zdGAgbG9va3MgdXAgYEFwcC5Qb3N0Q29udHJvbGxlcmAgYnkgZGVmYXVsdC4KICAqIGlmIHRoZSBkZWZhdWx0IGxvb2t1cCBmYWlscywgbG9vayBmb3IgcmVnaXN0ZXJlZCBjbGFzc2VzIG9uIHRoZSBjb250YWluZXIKCiAgVGhpcyBhbGxvd3MgdGhlIGFwcGxpY2F0aW9uIHRvIHJlZ2lzdGVyIGRlZmF1bHQgaW5qZWN0aW9ucyBpbiB0aGUgY29udGFpbmVyCiAgdGhhdCBjb3VsZCBiZSBvdmVycmlkZGVuIGJ5IHRoZSBub3JtYWwgbmFtaW5nIGNvbnZlbnRpb24uCgogIEBwcml2YXRlCiAgQG1ldGhvZCByZXNvbHZlckZvcgogIEBwYXJhbSB7RW1iZXIuTmFtZXNwYWNlfSBuYW1lc3BhY2UgdGhlIG5hbWVzcGFjZSB0byBsb29rIGZvciBjbGFzc2VzCiAgQHJldHVybiB7Kn0gdGhlIHJlc29sdmVkIHZhbHVlIGZvciBhIGdpdmVuIGxvb2t1cAoqLwpmdW5jdGlvbiByZXNvbHZlckZvcihuYW1lc3BhY2UpIHsKICBpZiAobmFtZXNwYWNlLmdldCgncmVzb2x2ZXInKSkgewogICAgRW1iZXIuZGVwcmVjYXRlKCdBcHBsaWNhdGlvbi5yZXNvbHZlciBpcyBkZXByZWNhdGVkIGluIGZhdm9yIG9mIEFwcGxpY2F0aW9uLlJlc29sdmVyJywgZmFsc2UpOwogIH0KCiAgdmFyIFJlc29sdmVyQ2xhc3MgPSBuYW1lc3BhY2UuZ2V0KCdyZXNvbHZlcicpIHx8IG5hbWVzcGFjZS5nZXQoJ1Jlc29sdmVyJykgfHwgRW1iZXIuRGVmYXVsdFJlc29sdmVyOwogIHZhciByZXNvbHZlciA9IFJlc29sdmVyQ2xhc3MuY3JlYXRlKHsKICAgIG5hbWVzcGFjZTogbmFtZXNwYWNlCiAgfSk7CgogIGZ1bmN0aW9uIHJlc29sdmUoZnVsbE5hbWUpIHsKICAgIHJldHVybiByZXNvbHZlci5yZXNvbHZlKGZ1bGxOYW1lKTsKICB9CgogIHJlc29sdmUuZGVzY3JpYmUgPSBmdW5jdGlvbihmdWxsTmFtZSkgewogICAgcmV0dXJuIHJlc29sdmVyLmxvb2t1cERlc2NyaXB0aW9uKGZ1bGxOYW1lKTsKICB9OwoKICByZXNvbHZlLm1ha2VUb1N0cmluZyA9IGZ1bmN0aW9uKGZhY3RvcnksIGZ1bGxOYW1lKSB7CiAgICByZXR1cm4gcmVzb2x2ZXIubWFrZVRvU3RyaW5nKGZhY3RvcnksIGZ1bGxOYW1lKTsKICB9OwoKICByZXNvbHZlLm5vcm1hbGl6ZSA9IGZ1bmN0aW9uKGZ1bGxOYW1lKSB7CiAgICBpZiAocmVzb2x2ZXIubm9ybWFsaXplKSB7CiAgICAgIHJldHVybiByZXNvbHZlci5ub3JtYWxpemUoZnVsbE5hbWUpOwogICAgfSBlbHNlIHsKICAgICAgRW1iZXIuZGVwcmVjYXRlKCdUaGUgUmVzb2x2ZXIgc2hvdWxkIG5vdyBwcm92aWRlIGEgXCdub3JtYWxpemVcJyBmdW5jdGlvbicsIGZhbHNlKTsKICAgICAgcmV0dXJuIGZ1bGxOYW1lOwogICAgfQogIH07CgogIHJldHVybiByZXNvbHZlOwp9CgpFbWJlci5ydW5Mb2FkSG9va3MoJ0VtYmVyLkFwcGxpY2F0aW9uJywgRW1iZXIuQXBwbGljYXRpb24pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLWFwcGxpY2F0aW9uCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LCBzZXQgPSBFbWJlci5zZXQ7CgpmdW5jdGlvbiB2ZXJpZnlOZWVkc0RlcGVuZGVuY2llcyhjb250cm9sbGVyLCBjb250YWluZXIsIG5lZWRzKSB7CiAgdmFyIGRlcGVuZGVuY3ksIGksIGwsIG1pc3NpbmcgPSBbXTsKCiAgZm9yIChpPTAsIGw9bmVlZHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgZGVwZW5kZW5jeSA9IG5lZWRzW2ldOwoKICAgIEVtYmVyLmFzc2VydChFbWJlci5pbnNwZWN0KGNvbnRyb2xsZXIpICsgIiNuZWVkcyBtdXN0IG5vdCBzcGVjaWZ5IGRlcGVuZGVuY2llcyB3aXRoIHBlcmlvZHMgaW4gdGhlaXIgbmFtZXMgKCIgKyBkZXBlbmRlbmN5ICsgIikiLCBkZXBlbmRlbmN5LmluZGV4T2YoJy4nKSA9PT0gLTEpOwoKICAgIGlmIChkZXBlbmRlbmN5LmluZGV4T2YoJzonKSA9PT0gLTEpIHsKICAgICAgZGVwZW5kZW5jeSA9ICJjb250cm9sbGVyOiIgKyBkZXBlbmRlbmN5OwogICAgfQoKICAgIC8vIFN0cnVjdHVyZSBhc3NlcnQgdG8gc3RpbGwgZG8gdmVyaWZpY2F0aW9uIGJ1dCBub3Qgc3RyaW5nIGNvbmNhdCBpbiBwcm9kdWN0aW9uCiAgICBpZiAoIWNvbnRhaW5lci5oYXMoZGVwZW5kZW5jeSkpIHsKICAgICAgbWlzc2luZy5wdXNoKGRlcGVuZGVuY3kpOwogICAgfQogIH0KICBpZiAobWlzc2luZy5sZW5ndGgpIHsKICAgIHRocm93IG5ldyBFbWJlci5FcnJvcihFbWJlci5pbnNwZWN0KGNvbnRyb2xsZXIpICsgIiBuZWVkcyBbICIgKyBtaXNzaW5nLmpvaW4oJywgJykgKyAiIF0gYnV0ICIgKyAobWlzc2luZy5sZW5ndGggPiAxID8gJ3RoZXknIDogJ2l0JykgKyAiIGNvdWxkIG5vdCBiZSBmb3VuZCIpOwogIH0KfQoKdmFyIGRlZmF1bHRDb250cm9sbGVyc0NvbXB1dGVkUHJvcGVydHkgPSBFbWJlci5jb21wdXRlZChmdW5jdGlvbigpIHsKICB2YXIgY29udHJvbGxlciA9IHRoaXM7CgogIHJldHVybiB7CiAgICBuZWVkczogZ2V0KGNvbnRyb2xsZXIsICduZWVkcycpLAogICAgY29udGFpbmVyOiBnZXQoY29udHJvbGxlciwgJ2NvbnRhaW5lcicpLAogICAgdW5rbm93blByb3BlcnR5OiBmdW5jdGlvbihjb250cm9sbGVyTmFtZSkgewogICAgICB2YXIgbmVlZHMgPSB0aGlzLm5lZWRzLAogICAgICAgIGRlcGVuZGVuY3ksIGksIGw7CiAgICAgIGZvciAoaT0wLCBsPW5lZWRzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICBkZXBlbmRlbmN5ID0gbmVlZHNbaV07CiAgICAgICAgaWYgKGRlcGVuZGVuY3kgPT09IGNvbnRyb2xsZXJOYW1lKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5jb250YWluZXIubG9va3VwKCdjb250cm9sbGVyOicgKyBjb250cm9sbGVyTmFtZSk7CiAgICAgICAgfQogICAgICB9CgogICAgICB2YXIgZXJyb3JNZXNzYWdlID0gRW1iZXIuaW5zcGVjdChjb250cm9sbGVyKSArICcjbmVlZHMgZG9lcyBub3QgaW5jbHVkZSBgJyArIGNvbnRyb2xsZXJOYW1lICsgJ2AuIFRvIGFjY2VzcyB0aGUgJyArIGNvbnRyb2xsZXJOYW1lICsgJyBjb250cm9sbGVyIGZyb20gJyArIEVtYmVyLmluc3BlY3QoY29udHJvbGxlcikgKyAnLCAnICsgRW1iZXIuaW5zcGVjdChjb250cm9sbGVyKSArICcgc2hvdWxkIGhhdmUgYSBgbmVlZHNgIHByb3BlcnR5IHRoYXQgaXMgYW4gYXJyYXkgb2YgdGhlIGNvbnRyb2xsZXJzIGl0IGhhcyBhY2Nlc3MgdG8uJzsKICAgICAgdGhyb3cgbmV3IFJlZmVyZW5jZUVycm9yKGVycm9yTWVzc2FnZSk7CiAgICB9LAogICAgc2V0VW5rbm93blByb3BlcnR5OiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIllvdSBjYW5ub3Qgb3ZlcndyaXRlIHRoZSB2YWx1ZSBvZiBgY29udHJvbGxlcnMuIiArIGtleSArICJgIG9mICIgKyBFbWJlci5pbnNwZWN0KGNvbnRyb2xsZXIpKTsKICAgIH0KICB9Owp9KTsKCi8qKgogIEBjbGFzcyBDb250cm9sbGVyTWl4aW4KICBAbmFtZXNwYWNlIEVtYmVyCiovCkVtYmVyLkNvbnRyb2xsZXJNaXhpbi5yZW9wZW4oewogIGNvbmNhdGVuYXRlZFByb3BlcnRpZXM6IFsnbmVlZHMnXSwKCiAgLyoqCiAgICBBbiBhcnJheSBvZiBvdGhlciBjb250cm9sbGVyIG9iamVjdHMgYXZhaWxhYmxlIGluc2lkZQogICAgaW5zdGFuY2VzIG9mIHRoaXMgY29udHJvbGxlciB2aWEgdGhlIGBjb250cm9sbGVyc2AKICAgIHByb3BlcnR5OgoKICAgIEZvciBleGFtcGxlLCB3aGVuIHlvdSBkZWZpbmUgYSBjb250cm9sbGVyOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIEFwcC5Db21tZW50c0NvbnRyb2xsZXIgPSBFbWJlci5BcnJheUNvbnRyb2xsZXIuZXh0ZW5kKHsKICAgICAgbmVlZHM6IFsncG9zdCddCiAgICB9KTsKICAgIGBgYAoKICAgIFRoZSBhcHBsaWNhdGlvbidzIHNpbmdsZSBpbnN0YW5jZSBvZiB0aGVzZSBvdGhlcgogICAgY29udHJvbGxlcnMgYXJlIGFjY2Vzc2libGUgYnkgbmFtZSB0aHJvdWdoIHRoZQogICAgYGNvbnRyb2xsZXJzYCBwcm9wZXJ0eToKCiAgICBgYGBqYXZhc2NyaXB0CiAgICB0aGlzLmdldCgnY29udHJvbGxlcnMucG9zdCcpOyAvLyBpbnN0YW5jZSBvZiBBcHAuUG9zdENvbnRyb2xsZXIKICAgIGBgYAoKICAgIEdpdmVuIHRoYXQgeW91IGhhdmUgYSBuZXN0ZWQgY29udHJvbGxlciAobmVzdGVkIHJlc291cmNlKToKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuQ29tbWVudHNOZXdDb250cm9sbGVyID0gRW1iZXIuT2JqZWN0Q29udHJvbGxlci5leHRlbmQoewogICAgfSk7CiAgICBgYGAKCiAgICBXaGVuIHlvdSBkZWZpbmUgYSBjb250cm9sbGVyIHRoYXQgcmVxdWlyZXMgYWNjZXNzIHRvIGEgbmVzdGVkIG9uZToKCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuSW5kZXhDb250cm9sbGVyID0gRW1iZXIuT2JqZWN0Q29udHJvbGxlci5leHRlbmQoewogICAgICBuZWVkczogWydjb21tZW50c05ldyddCiAgICB9KTsKICAgIGBgYAoKICAgIFlvdSB3aWxsIGJlIGFibGUgdG8gZ2V0IGFjY2VzcyB0byBpdDoKCiAgICBgYGBqYXZhc2NyaXB0CiAgICB0aGlzLmdldCgnY29udHJvbGxlcnMuY29tbWVudHNOZXcnKTsgLy8gaW5zdGFuY2Ugb2YgQXBwLkNvbW1lbnRzTmV3Q29udHJvbGxlcgogICAgYGBgCgogICAgVGhpcyBpcyBvbmx5IGF2YWlsYWJsZSBmb3Igc2luZ2xldG9uIGNvbnRyb2xsZXJzLgoKICAgIEBwcm9wZXJ0eSB7QXJyYXl9IG5lZWRzCiAgICBAZGVmYXVsdCBbXQogICovCiAgbmVlZHM6IFtdLAoKICBpbml0OiBmdW5jdGlvbigpIHsKICAgIHZhciBuZWVkcyA9IGdldCh0aGlzLCAnbmVlZHMnKSwKICAgIGxlbmd0aCA9IGdldChuZWVkcywgJ2xlbmd0aCcpOwoKICAgIGlmIChsZW5ndGggPiAwKSB7CiAgICAgIEVtYmVyLmFzc2VydCgnIGAnICsgRW1iZXIuaW5zcGVjdCh0aGlzKSArICcgc3BlY2lmaWVzIGBuZWVkc2AsIGJ1dCBkb2VzICcgKwogICAgICAgICAgICAgICAgICAgIm5vdCBoYXZlIGEgY29udGFpbmVyLiBQbGVhc2UgZW5zdXJlIHRoaXMgY29udHJvbGxlciB3YXMgIiArCiAgICAgICAgICAgICAgICAgICAiaW5zdGFudGlhdGVkIHdpdGggYSBjb250YWluZXIuIiwKICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyIHx8IEVtYmVyLm1ldGEodGhpcywgZmFsc2UpLmRlc2NzLmNvbnRyb2xsZXJzICE9PSBkZWZhdWx0Q29udHJvbGxlcnNDb21wdXRlZFByb3BlcnR5KTsKCiAgICAgIGlmICh0aGlzLmNvbnRhaW5lcikgewogICAgICAgIHZlcmlmeU5lZWRzRGVwZW5kZW5jaWVzKHRoaXMsIHRoaXMuY29udGFpbmVyLCBuZWVkcyk7CiAgICAgIH0KCiAgICAgIC8vIGlmIG5lZWRzIHRoZW4gaW5pdGlhbGl6ZSBjb250cm9sbGVycyBwcm94eQogICAgICBnZXQodGhpcywgJ2NvbnRyb2xsZXJzJyk7CiAgICB9CgogICAgdGhpcy5fc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9LAoKICAvKioKICAgIEBtZXRob2QgY29udHJvbGxlckZvcgogICAgQHNlZSB7RW1iZXIuUm91dGUjY29udHJvbGxlckZvcn0KICAgIEBkZXByZWNhdGVkIFVzZSBgbmVlZHNgIGluc3RlYWQKICAqLwogIGNvbnRyb2xsZXJGb3I6IGZ1bmN0aW9uKGNvbnRyb2xsZXJOYW1lKSB7CiAgICBFbWJlci5kZXByZWNhdGUoIkNvbnRyb2xsZXIjY29udHJvbGxlckZvciBpcyBkZXByZWNhdGVkLCBwbGVhc2UgdXNlIENvbnRyb2xsZXIjbmVlZHMgaW5zdGVhZCIpOwogICAgcmV0dXJuIEVtYmVyLmNvbnRyb2xsZXJGb3IoZ2V0KHRoaXMsICdjb250YWluZXInKSwgY29udHJvbGxlck5hbWUpOwogIH0sCgogIC8qKgogICAgU3RvcmVzIHRoZSBpbnN0YW5jZXMgb2Ygb3RoZXIgY29udHJvbGxlcnMgYXZhaWxhYmxlIGZyb20gd2l0aGluCiAgICB0aGlzIGNvbnRyb2xsZXIuIEFueSBjb250cm9sbGVyIGxpc3RlZCBieSBuYW1lIGluIHRoZSBgbmVlZHNgCiAgICBwcm9wZXJ0eSB3aWxsIGJlIGFjY2Vzc2libGUgYnkgbmFtZSB0aHJvdWdoIHRoaXMgcHJvcGVydHkuCgogICAgYGBgamF2YXNjcmlwdAogICAgQXBwLkNvbW1lbnRzQ29udHJvbGxlciA9IEVtYmVyLkFycmF5Q29udHJvbGxlci5leHRlbmQoewogICAgICBuZWVkczogWydwb3N0J10sCiAgICAgIHBvc3RUaXRsZTogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgY3VycmVudFBvc3QgPSB0aGlzLmdldCgnY29udHJvbGxlcnMucG9zdCcpOyAvLyBpbnN0YW5jZSBvZiBBcHAuUG9zdENvbnRyb2xsZXIKICAgICAgICByZXR1cm4gY3VycmVudFBvc3QuZ2V0KCd0aXRsZScpOwogICAgICB9LnByb3BlcnR5KCdjb250cm9sbGVycy5wb3N0LnRpdGxlJykKICAgIH0pOwogICAgYGBgCgogICAgQHNlZSB7RW1iZXIuQ29udHJvbGxlck1peGluI25lZWRzfQogICAgQHByb3BlcnR5IHtPYmplY3R9IGNvbnRyb2xsZXJzCiAgICBAZGVmYXVsdCBudWxsCiAgKi8KICBjb250cm9sbGVyczogZGVmYXVsdENvbnRyb2xsZXJzQ29tcHV0ZWRQcm9wZXJ0eQp9KTsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCkVtYmVyIEFwcGxpY2F0aW9uCgpAbW9kdWxlIGVtYmVyCkBzdWJtb2R1bGUgZW1iZXItYXBwbGljYXRpb24KQHJlcXVpcmVzIGVtYmVyLXZpZXdzLCBlbWJlci1yb3V0aW5nCiovCgp9KSgpOwoKKGZ1bmN0aW9uKCkgewovKioKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLWV4dGVuc2lvbi1zdXBwb3J0CiovCi8qKgogIFRoZSBgRGF0YUFkYXB0ZXJgIGhlbHBzIGEgZGF0YSBwZXJzaXN0ZW5jZSBsaWJyYXJ5CiAgaW50ZXJmYWNlIHdpdGggdG9vbHMgdGhhdCBkZWJ1ZyBFbWJlciBzdWNoCiAgYXMgdGhlIFtFbWJlciBFeHRlbnNpb25dKGh0dHBzOi8vZ2l0aHViLmNvbS90aWxkZWlvL2VtYmVyLWV4dGVuc2lvbikKICBmb3IgQ2hyb21lIGFuZCBGaXJlZm94LgoKICBUaGlzIGNsYXNzIHdpbGwgYmUgZXh0ZW5kZWQgYnkgYSBwZXJzaXN0ZW5jZSBsaWJyYXJ5CiAgd2hpY2ggd2lsbCBvdmVycmlkZSBzb21lIG9mIHRoZSBtZXRob2RzIHdpdGgKICBsaWJyYXJ5LXNwZWNpZmljIGNvZGUuCgogIFRoZSBtZXRob2RzIGxpa2VseSB0byBiZSBvdmVycmlkZGVuIGFyZToKCiAgKiBgZ2V0RmlsdGVyc2AKICAqIGBkZXRlY3RgCiAgKiBgY29sdW1uc0ZvclR5cGVgCiAgKiBgZ2V0UmVjb3Jkc2AKICAqIGBnZXRSZWNvcmRDb2x1bW5WYWx1ZXNgCiAgKiBgZ2V0UmVjb3JkS2V5d29yZHNgCiAgKiBgZ2V0UmVjb3JkRmlsdGVyVmFsdWVzYAogICogYGdldFJlY29yZENvbG9yYAogICogYG9ic2VydmVSZWNvcmRgCgogIFRoZSBhZGFwdGVyIHdpbGwgbmVlZCB0byBiZSByZWdpc3RlcmVkCiAgaW4gdGhlIGFwcGxpY2F0aW9uJ3MgY29udGFpbmVyIGFzIGBkYXRhQWRhcHRlcjptYWluYAoKICBFeGFtcGxlOgoKICBgYGBqYXZhc2NyaXB0CiAgQXBwbGljYXRpb24uaW5pdGlhbGl6ZXIoewogICAgbmFtZTogImRhdGFBZGFwdGVyIiwKCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbihjb250YWluZXIsIGFwcGxpY2F0aW9uKSB7CiAgICAgIGFwcGxpY2F0aW9uLnJlZ2lzdGVyKCdkYXRhQWRhcHRlcjptYWluJywgRFMuRGF0YUFkYXB0ZXIpOwogICAgfQogIH0pOwogIGBgYAoKICBAY2xhc3MgRGF0YUFkYXB0ZXIKICBAbmFtZXNwYWNlIEVtYmVyCiAgQGV4dGVuZHMgRW1iZXIuT2JqZWN0CiovCkVtYmVyLkRhdGFBZGFwdGVyID0gRW1iZXIuT2JqZWN0LmV4dGVuZCh7CiAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9zdXBlcigpOwogICAgdGhpcy5yZWxlYXNlTWV0aG9kcyA9IEVtYmVyLkEoKTsKICB9LAoKICAvKioKICAgIFRoZSBjb250YWluZXIgb2YgdGhlIGFwcGxpY2F0aW9uIGJlaW5nIGRlYnVnZ2VkLgogICAgVGhpcyBwcm9wZXJ0eSB3aWxsIGJlIGluamVjdGVkCiAgICBvbiBjcmVhdGlvbi4KCiAgICBAcHJvcGVydHkgY29udGFpbmVyCiAgICBAZGVmYXVsdCBudWxsCiAgKi8KICBjb250YWluZXI6IG51bGwsCgogIC8qKgogICAgTnVtYmVyIG9mIGF0dHJpYnV0ZXMgdG8gc2VuZAogICAgYXMgY29sdW1ucy4gKEVub3VnaCB0byBtYWtlIHRoZSByZWNvcmQKICAgIGlkZW50aWZpYWJsZSkuCgogICAgQHByaXZhdGUKICAgIEBwcm9wZXJ0eSBhdHRyaWJ1dGVMaW1pdAogICAgQGRlZmF1bHQgMwogICovCiAgYXR0cmlidXRlTGltaXQ6IDMsCgogIC8qKgogICAgU3RvcmVzIGFsbCBtZXRob2RzIHRoYXQgY2xlYXIgb2JzZXJ2ZXJzLgogICAgVGhlc2UgbWV0aG9kcyB3aWxsIGJlIGNhbGxlZCBvbiBkZXN0cnVjdGlvbi4KCiAgICBAcHJpdmF0ZQogICAgQHByb3BlcnR5IHJlbGVhc2VNZXRob2RzCiAgKi8KICByZWxlYXNlTWV0aG9kczogRW1iZXIuQSgpLAoKICAvKioKICAgIFNwZWNpZmllcyBob3cgcmVjb3JkcyBjYW4gYmUgZmlsdGVyZWQuCiAgICBSZWNvcmRzIHJldHVybmVkIHdpbGwgbmVlZCB0byBoYXZlIGEgYGZpbHRlclZhbHVlc2AKICAgIHByb3BlcnR5IHdpdGggYSBrZXkgZm9yIGV2ZXJ5IG5hbWUgaW4gdGhlIHJldHVybmVkIGFycmF5LgoKICAgIEBwdWJsaWMKICAgIEBtZXRob2QgZ2V0RmlsdGVycwogICAgQHJldHVybiB7QXJyYXl9IExpc3Qgb2Ygb2JqZWN0cyBkZWZpbmluZyBmaWx0ZXJzLgogICAgIFRoZSBvYmplY3Qgc2hvdWxkIGhhdmUgYSBgbmFtZWAgYW5kIGBkZXNjYCBwcm9wZXJ0eS4KICAqLwogIGdldEZpbHRlcnM6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIEVtYmVyLkEoKTsKICB9LAoKICAvKioKICAgIEZldGNoIHRoZSBtb2RlbCB0eXBlcyBhbmQgb2JzZXJ2ZSB0aGVtIGZvciBjaGFuZ2VzLgoKICAgIEBwdWJsaWMKICAgIEBtZXRob2Qgd2F0Y2hNb2RlbFR5cGVzCgogICAgQHBhcmFtIHtGdW5jdGlvbn0gdHlwZXNBZGRlZCBDYWxsYmFjayB0byBjYWxsIHRvIGFkZCB0eXBlcy4KICAgIFRha2VzIGFuIGFycmF5IG9mIG9iamVjdHMgY29udGFpbmluZyB3cmFwcGVkIHR5cGVzIChyZXR1cm5lZCBmcm9tIGB3cmFwTW9kZWxUeXBlYCkuCgogICAgQHBhcmFtIHtGdW5jdGlvbn0gdHlwZXNVcGRhdGVkIENhbGxiYWNrIHRvIGNhbGwgd2hlbiBhIHR5cGUgaGFzIGNoYW5nZWQuCiAgICBUYWtlcyBhbiBhcnJheSBvZiBvYmplY3RzIGNvbnRhaW5pbmcgd3JhcHBlZCB0eXBlcy4KCiAgICBAcmV0dXJuIHtGdW5jdGlvbn0gTWV0aG9kIHRvIGNhbGwgdG8gcmVtb3ZlIGFsbCBvYnNlcnZlcnMKICAqLwogIHdhdGNoTW9kZWxUeXBlczogZnVuY3Rpb24odHlwZXNBZGRlZCwgdHlwZXNVcGRhdGVkKSB7CiAgICB2YXIgbW9kZWxUeXBlcyA9IHRoaXMuZ2V0TW9kZWxUeXBlcygpLAogICAgICAgIHNlbGYgPSB0aGlzLCB0eXBlc1RvU2VuZCwgcmVsZWFzZU1ldGhvZHMgPSBFbWJlci5BKCk7CgogICAgdHlwZXNUb1NlbmQgPSBtb2RlbFR5cGVzLm1hcChmdW5jdGlvbih0eXBlKSB7CiAgICAgIHZhciB3cmFwcGVkID0gc2VsZi53cmFwTW9kZWxUeXBlKHR5cGUpOwogICAgICByZWxlYXNlTWV0aG9kcy5wdXNoKHNlbGYub2JzZXJ2ZU1vZGVsVHlwZSh0eXBlLCB0eXBlc1VwZGF0ZWQpKTsKICAgICAgcmV0dXJuIHdyYXBwZWQ7CiAgICB9KTsKCiAgICB0eXBlc0FkZGVkKHR5cGVzVG9TZW5kKTsKCiAgICB2YXIgcmVsZWFzZSA9IGZ1bmN0aW9uKCkgewogICAgICByZWxlYXNlTWV0aG9kcy5mb3JFYWNoKGZ1bmN0aW9uKGZuKSB7IGZuKCk7IH0pOwogICAgICBzZWxmLnJlbGVhc2VNZXRob2RzLnJlbW92ZU9iamVjdChyZWxlYXNlKTsKICAgIH07CiAgICB0aGlzLnJlbGVhc2VNZXRob2RzLnB1c2hPYmplY3QocmVsZWFzZSk7CiAgICByZXR1cm4gcmVsZWFzZTsKICB9LAoKICAvKioKICAgIEZldGNoIHRoZSByZWNvcmRzIG9mIGEgZ2l2ZW4gdHlwZSBhbmQgb2JzZXJ2ZSB0aGVtIGZvciBjaGFuZ2VzLgoKICAgIEBwdWJsaWMKICAgIEBtZXRob2Qgd2F0Y2hSZWNvcmRzCgogICAgQHBhcmFtIHtGdW5jdGlvbn0gcmVjb3Jkc0FkZGVkIENhbGxiYWNrIHRvIGNhbGwgdG8gYWRkIHJlY29yZHMuCiAgICBUYWtlcyBhbiBhcnJheSBvZiBvYmplY3RzIGNvbnRhaW5pbmcgd3JhcHBlZCByZWNvcmRzLgogICAgVGhlIG9iamVjdCBzaG91bGQgaGF2ZSB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICAgIGNvbHVtblZhbHVlczoge09iamVjdH0ga2V5IGFuZCB2YWx1ZSBvZiBhIHRhYmxlIGNlbGwKICAgICAgb2JqZWN0OiB7T2JqZWN0fSB0aGUgYWN0dWFsIHJlY29yZCBvYmplY3QKCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSByZWNvcmRzVXBkYXRlZCBDYWxsYmFjayB0byBjYWxsIHdoZW4gYSByZWNvcmQgaGFzIGNoYW5nZWQuCiAgICBUYWtlcyBhbiBhcnJheSBvZiBvYmplY3RzIGNvbnRhaW5pbmcgd3JhcHBlZCByZWNvcmRzLgoKICAgIEBwYXJhbSB7RnVuY3Rpb259IHJlY29yZHNSZW1vdmVkIENhbGxiYWNrIHRvIGNhbGwgd2hlbiBhIHJlY29yZCBoYXMgcmVtb3ZlZC4KICAgIFRha2VzIHRoZSBmb2xsb3dpbmcgcGFyYW1ldGVyczoKICAgICAgaW5kZXg6IHRoZSBhcnJheSBpbmRleCB3aGVyZSB0aGUgcmVjb3JkcyB3ZXJlIHJlbW92ZWQKICAgICAgY291bnQ6IHRoZSBudW1iZXIgb2YgcmVjb3JkcyByZW1vdmVkCgogICAgQHJldHVybiB7RnVuY3Rpb259IE1ldGhvZCB0byBjYWxsIHRvIHJlbW92ZSBhbGwgb2JzZXJ2ZXJzCiAgKi8KICB3YXRjaFJlY29yZHM6IGZ1bmN0aW9uKHR5cGUsIHJlY29yZHNBZGRlZCwgcmVjb3Jkc1VwZGF0ZWQsIHJlY29yZHNSZW1vdmVkKSB7CiAgICB2YXIgc2VsZiA9IHRoaXMsIHJlbGVhc2VNZXRob2RzID0gRW1iZXIuQSgpLCByZWNvcmRzID0gdGhpcy5nZXRSZWNvcmRzKHR5cGUpLCByZWxlYXNlOwoKICAgIHZhciByZWNvcmRVcGRhdGVkID0gZnVuY3Rpb24odXBkYXRlZFJlY29yZCkgewogICAgICByZWNvcmRzVXBkYXRlZChbdXBkYXRlZFJlY29yZF0pOwogICAgfTsKCiAgICB2YXIgcmVjb3Jkc1RvU2VuZCA9IHJlY29yZHMubWFwKGZ1bmN0aW9uKHJlY29yZCkgewogICAgICByZWxlYXNlTWV0aG9kcy5wdXNoKHNlbGYub2JzZXJ2ZVJlY29yZChyZWNvcmQsIHJlY29yZFVwZGF0ZWQpKTsKICAgICAgcmV0dXJuIHNlbGYud3JhcFJlY29yZChyZWNvcmQpOwogICAgfSk7CgoKICAgIHZhciBjb250ZW50RGlkQ2hhbmdlID0gZnVuY3Rpb24oYXJyYXksIGlkeCwgcmVtb3ZlZENvdW50LCBhZGRlZENvdW50KSB7CiAgICAgIGZvciAodmFyIGkgPSBpZHg7IGkgPCBpZHggKyBhZGRlZENvdW50OyBpKyspIHsKICAgICAgICB2YXIgcmVjb3JkID0gYXJyYXkub2JqZWN0QXQoaSk7CiAgICAgICAgdmFyIHdyYXBwZWQgPSBzZWxmLndyYXBSZWNvcmQocmVjb3JkKTsKICAgICAgICByZWxlYXNlTWV0aG9kcy5wdXNoKHNlbGYub2JzZXJ2ZVJlY29yZChyZWNvcmQsIHJlY29yZFVwZGF0ZWQpKTsKICAgICAgICByZWNvcmRzQWRkZWQoW3dyYXBwZWRdKTsKICAgICAgfQoKICAgICAgaWYgKHJlbW92ZWRDb3VudCkgewogICAgICAgIHJlY29yZHNSZW1vdmVkKGlkeCwgcmVtb3ZlZENvdW50KTsKICAgICAgfQogICAgfTsKCiAgICB2YXIgb2JzZXJ2ZXIgPSB7IGRpZENoYW5nZTogY29udGVudERpZENoYW5nZSwgd2lsbENoYW5nZTogRW1iZXIuSyB9OwogICAgcmVjb3Jkcy5hZGRBcnJheU9ic2VydmVyKHNlbGYsIG9ic2VydmVyKTsKCiAgICByZWxlYXNlID0gZnVuY3Rpb24oKSB7CiAgICAgIHJlbGVhc2VNZXRob2RzLmZvckVhY2goZnVuY3Rpb24oZm4pIHsgZm4oKTsgfSk7CiAgICAgIHJlY29yZHMucmVtb3ZlQXJyYXlPYnNlcnZlcihzZWxmLCBvYnNlcnZlcik7CiAgICAgIHNlbGYucmVsZWFzZU1ldGhvZHMucmVtb3ZlT2JqZWN0KHJlbGVhc2UpOwogICAgfTsKCiAgICByZWNvcmRzQWRkZWQocmVjb3Jkc1RvU2VuZCk7CgogICAgdGhpcy5yZWxlYXNlTWV0aG9kcy5wdXNoT2JqZWN0KHJlbGVhc2UpOwogICAgcmV0dXJuIHJlbGVhc2U7CiAgfSwKCiAgLyoqCiAgICBDbGVhciBhbGwgb2JzZXJ2ZXJzIGJlZm9yZSBkZXN0cnVjdGlvbgogICAgQHByaXZhdGUKICAqLwogIHdpbGxEZXN0cm95OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3N1cGVyKCk7CiAgICB0aGlzLnJlbGVhc2VNZXRob2RzLmZvckVhY2goZnVuY3Rpb24oZm4pIHsKICAgICAgZm4oKTsKICAgIH0pOwogIH0sCgogIC8qKgogICAgRGV0ZWN0IHdoZXRoZXIgYSBjbGFzcyBpcyBhIG1vZGVsLgoKICAgIFRlc3QgdGhhdCBhZ2FpbnN0IHRoZSBtb2RlbCBjbGFzcwogICAgb2YgeW91ciBwZXJzaXN0ZW5jZSBsaWJyYXJ5CgogICAgQHByaXZhdGUKICAgIEBtZXRob2QgZGV0ZWN0CiAgICBAcGFyYW0ge0NsYXNzfSBrbGFzcyBUaGUgY2xhc3MgdG8gdGVzdAogICAgQHJldHVybiBib29sZWFuIFdoZXRoZXIgdGhlIGNsYXNzIGlzIGEgbW9kZWwgY2xhc3Mgb3Igbm90CiAgKi8KICBkZXRlY3Q6IGZ1bmN0aW9uKGtsYXNzKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfSwKCiAgLyoqCiAgICBHZXQgdGhlIGNvbHVtbnMgZm9yIGEgZ2l2ZW4gbW9kZWwgdHlwZS4KCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBjb2x1bW5zRm9yVHlwZQogICAgQHBhcmFtIHtDbGFzc30gdHlwZSBUaGUgbW9kZWwgdHlwZQogICAgQHJldHVybiB7QXJyYXl9IEFuIGFycmF5IG9mIGNvbHVtbnMgb2YgdGhlIGZvbGxvd2luZyBmb3JtYXQ6CiAgICAgbmFtZToge1N0cmluZ30gbmFtZSBvZiB0aGUgY29sdW1uCiAgICAgZGVzYzoge1N0cmluZ30gSHVtYW5pemVkIGRlc2NyaXB0aW9uICh3aGF0IHdvdWxkIHNob3cgaW4gYSB0YWJsZSBjb2x1bW4gbmFtZSkKICAqLwogIGNvbHVtbnNGb3JUeXBlOiBmdW5jdGlvbih0eXBlKSB7CiAgICByZXR1cm4gRW1iZXIuQSgpOwogIH0sCgogIC8qKgogICAgQWRkcyBvYnNlcnZlcnMgdG8gYSBtb2RlbCB0eXBlIGNsYXNzLgoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIG9ic2VydmVNb2RlbFR5cGUKICAgIEBwYXJhbSB7Q2xhc3N9IHR5cGUgVGhlIG1vZGVsIHR5cGUgY2xhc3MKICAgIEBwYXJhbSB7RnVuY3Rpb259IHR5cGVzVXBkYXRlZCBDYWxsZWQgd2hlbiBhIHR5cGUgaXMgbW9kaWZpZWQuCiAgICBAcmV0dXJuIHtGdW5jdGlvbn0gVGhlIGZ1bmN0aW9uIHRvIGNhbGwgdG8gcmVtb3ZlIG9ic2VydmVycwogICovCgogIG9ic2VydmVNb2RlbFR5cGU6IGZ1bmN0aW9uKHR5cGUsIHR5cGVzVXBkYXRlZCkgewogICAgdmFyIHNlbGYgPSB0aGlzLCByZWNvcmRzID0gdGhpcy5nZXRSZWNvcmRzKHR5cGUpOwoKICAgIHZhciBvbkNoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgICB0eXBlc1VwZGF0ZWQoW3NlbGYud3JhcE1vZGVsVHlwZSh0eXBlKV0pOwogICAgfTsKICAgIHZhciBvYnNlcnZlciA9IHsKICAgICAgZGlkQ2hhbmdlOiBmdW5jdGlvbigpIHsKICAgICAgICBFbWJlci5ydW4uc2NoZWR1bGVPbmNlKCdhY3Rpb25zJywgdGhpcywgb25DaGFuZ2UpOwogICAgICB9LAogICAgICB3aWxsQ2hhbmdlOiBFbWJlci5LCiAgICB9OwoKICAgIHJlY29yZHMuYWRkQXJyYXlPYnNlcnZlcih0aGlzLCBvYnNlcnZlcik7CgogICAgdmFyIHJlbGVhc2UgPSBmdW5jdGlvbigpIHsKICAgICAgcmVjb3Jkcy5yZW1vdmVBcnJheU9ic2VydmVyKHNlbGYsIG9ic2VydmVyKTsKICAgIH07CgogICAgcmV0dXJuIHJlbGVhc2U7CiAgfSwKCgogIC8qKgogICAgV3JhcHMgYSBnaXZlbiBtb2RlbCB0eXBlIGFuZCBvYnNlcnZlcyBjaGFuZ2VzIHRvIGl0LgoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIHdyYXBNb2RlbFR5cGUKICAgIEBwYXJhbSB7Q2xhc3N9IHR5cGUgQSBtb2RlbCBjbGFzcwogICAgQHBhcmFtIHtGdW5jdGlvbn0gdHlwZXNVcGRhdGVkIGNhbGxiYWNrIHRvIGNhbGwgd2hlbiB0aGUgdHlwZSBjaGFuZ2VzCiAgICBAcmV0dXJuIHtPYmplY3R9IGNvbnRhaW5zIHRoZSB3cmFwcGVkIHR5cGUgYW5kIHRoZSBmdW5jdGlvbiB0byByZW1vdmUgb2JzZXJ2ZXJzCiAgICBGb3JtYXQ6CiAgICAgIHR5cGU6IHtPYmplY3R9IHRoZSB3cmFwcGVkIHR5cGUKICAgICAgICBUaGUgd3JhcHBlZCB0eXBlIGhhcyB0aGUgZm9sbG93aW5nIGZvcm1hdDoKICAgICAgICAgIG5hbWU6IHtTdHJpbmd9IG5hbWUgb2YgdGhlIHR5cGUKICAgICAgICAgIGNvdW50OiB7SW50ZWdlcn0gbnVtYmVyIG9mIHJlY29yZHMgYXZhaWxhYmxlCiAgICAgICAgICBjb2x1bW5zOiB7Q29sdW1uc30gYXJyYXkgb2YgY29sdW1ucyB0byBkZXNjcmliZSB0aGUgcmVjb3JkCiAgICAgICAgICBvYmplY3Q6IHtDbGFzc30gdGhlIGFjdHVhbCBNb2RlbCB0eXBlIGNsYXNzCiAgICAgIHJlbGVhc2U6IHtGdW5jdGlvbn0gVGhlIGZ1bmN0aW9uIHRvIHJlbW92ZSBvYnNlcnZlcnMKICAqLwogIHdyYXBNb2RlbFR5cGU6IGZ1bmN0aW9uKHR5cGUsIHR5cGVzVXBkYXRlZCkgewogICAgdmFyIHJlbGVhc2UsIHJlY29yZHMgPSB0aGlzLmdldFJlY29yZHModHlwZSksCiAgICAgICAgdHlwZVRvU2VuZCwgc2VsZiA9IHRoaXM7CgogICAgdHlwZVRvU2VuZCA9IHsKICAgICAgbmFtZTogdHlwZS50b1N0cmluZygpLAogICAgICBjb3VudDogRW1iZXIuZ2V0KHJlY29yZHMsICdsZW5ndGgnKSwKICAgICAgY29sdW1uczogdGhpcy5jb2x1bW5zRm9yVHlwZSh0eXBlKSwKICAgICAgb2JqZWN0OiB0eXBlCiAgICB9OwoKCiAgICByZXR1cm4gdHlwZVRvU2VuZDsKICB9LAoKCiAgLyoqCiAgICBGZXRjaGVzIGFsbCBtb2RlbHMgZGVmaW5lZCBpbiB0aGUgYXBwbGljYXRpb24uCgogICAgQHByaXZhdGUKICAgIEBtZXRob2QgZ2V0TW9kZWxUeXBlcwogICAgQHJldHVybiB7QXJyYXl9IEFycmF5IG9mIG1vZGVsIHR5cGVzCiAgKi8KCiAvLyBUT0RPOiBVc2UgdGhlIHJlc29sdmVyIGluc3RlYWQgb2YgbG9vcGluZyBvdmVyIG5hbWVzcGFjZXMuCiAgZ2V0TW9kZWxUeXBlczogZnVuY3Rpb24oKSB7CiAgICB2YXIgbmFtZXNwYWNlcyA9IEVtYmVyLkEoRW1iZXIuTmFtZXNwYWNlLk5BTUVTUEFDRVMpLCB0eXBlcyA9IEVtYmVyLkEoKSwgc2VsZiA9IHRoaXM7CgogICAgbmFtZXNwYWNlcy5mb3JFYWNoKGZ1bmN0aW9uKG5hbWVzcGFjZSkgewogICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZXNwYWNlKSB7CiAgICAgICAgaWYgKCFuYW1lc3BhY2UuaGFzT3duUHJvcGVydHkoa2V5KSkgeyBjb250aW51ZTsgfQogICAgICAgIHZhciBrbGFzcyA9IG5hbWVzcGFjZVtrZXldOwogICAgICAgIGlmIChzZWxmLmRldGVjdChrbGFzcykpIHsKICAgICAgICAgIHR5cGVzLnB1c2goa2xhc3MpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gdHlwZXM7CiAgfSwKCiAgLyoqCiAgICBGZXRjaGVzIGFsbCBsb2FkZWQgcmVjb3JkcyBmb3IgYSBnaXZlbiB0eXBlLgoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIGdldFJlY29yZHMKICAgIEByZXR1cm4ge0FycmF5fSBBbiBhcnJheSBvZiByZWNvcmRzLgogICAgIFRoaXMgYXJyYXkgd2lsbCBiZSBvYnNlcnZlZCBmb3IgY2hhbmdlcywKICAgICBzbyBpdCBzaG91bGQgdXBkYXRlIHdoZW4gbmV3IHJlY29yZHMgYXJlIGFkZGVkL3JlbW92ZWQuCiAgKi8KICBnZXRSZWNvcmRzOiBmdW5jdGlvbih0eXBlKSB7CiAgICByZXR1cm4gRW1iZXIuQSgpOwogIH0sCgogIC8qKgogICAgV3JhcHMgYSByZWNvcmQgYW5kIG9ic2VydmVycyBjaGFuZ2VzIHRvIGl0LgoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIHdyYXBSZWNvcmQKICAgIEBwYXJhbSB7T2JqZWN0fSByZWNvcmQgVGhlIHJlY29yZCBpbnN0YW5jZS4KICAgIEByZXR1cm4ge09iamVjdH0gVGhlIHdyYXBwZWQgcmVjb3JkLiBGb3JtYXQ6CiAgICBjb2x1bW5WYWx1ZXM6IHtBcnJheX0KICAgIHNlYXJjaEtleXdvcmRzOiB7QXJyYXl9CiAgKi8KICB3cmFwUmVjb3JkOiBmdW5jdGlvbihyZWNvcmQpIHsKICAgIHZhciByZWNvcmRUb1NlbmQgPSB7IG9iamVjdDogcmVjb3JkIH0sIGNvbHVtblZhbHVlcyA9IHt9LCBzZWxmID0gdGhpczsKCiAgICByZWNvcmRUb1NlbmQuY29sdW1uVmFsdWVzID0gdGhpcy5nZXRSZWNvcmRDb2x1bW5WYWx1ZXMocmVjb3JkKTsKICAgIHJlY29yZFRvU2VuZC5zZWFyY2hLZXl3b3JkcyA9IHRoaXMuZ2V0UmVjb3JkS2V5d29yZHMocmVjb3JkKTsKICAgIHJlY29yZFRvU2VuZC5maWx0ZXJWYWx1ZXMgPSB0aGlzLmdldFJlY29yZEZpbHRlclZhbHVlcyhyZWNvcmQpOwogICAgcmVjb3JkVG9TZW5kLmNvbG9yID0gdGhpcy5nZXRSZWNvcmRDb2xvcihyZWNvcmQpOwoKICAgIHJldHVybiByZWNvcmRUb1NlbmQ7CiAgfSwKCiAgLyoqCiAgICBHZXRzIHRoZSB2YWx1ZXMgZm9yIGVhY2ggY29sdW1uLgoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIGdldFJlY29yZENvbHVtblZhbHVlcwogICAgQHJldHVybiB7T2JqZWN0fSBLZXlzIHNob3VsZCBtYXRjaCBjb2x1bW4gbmFtZXMgZGVmaW5lZAogICAgYnkgdGhlIG1vZGVsIHR5cGUuCiAgKi8KICBnZXRSZWNvcmRDb2x1bW5WYWx1ZXM6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgcmV0dXJuIHt9OwogIH0sCgogIC8qKgogICAgUmV0dXJucyBrZXl3b3JkcyB0byBtYXRjaCB3aGVuIHNlYXJjaGluZyByZWNvcmRzLgoKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIGdldFJlY29yZEtleXdvcmRzCiAgICBAcmV0dXJuIHtBcnJheX0gUmVsZXZhbnQga2V5d29yZHMgZm9yIHNlYXJjaC4KICAqLwogIGdldFJlY29yZEtleXdvcmRzOiBmdW5jdGlvbihyZWNvcmQpIHsKICAgIHJldHVybiBFbWJlci5BKCk7CiAgfSwKCiAgLyoqCiAgICBSZXR1cm5zIHRoZSB2YWx1ZXMgb2YgZmlsdGVycyBkZWZpbmVkIGJ5IGBnZXRGaWx0ZXJzYC4KCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBnZXRSZWNvcmRGaWx0ZXJWYWx1ZXMKICAgIEBwYXJhbSB7T2JqZWN0fSByZWNvcmQgVGhlIHJlY29yZCBpbnN0YW5jZQogICAgQHJldHVybiB7T2JqZWN0fSBUaGUgZmlsdGVyIHZhbHVlcwogICovCiAgZ2V0UmVjb3JkRmlsdGVyVmFsdWVzOiBmdW5jdGlvbihyZWNvcmQpIHsKICAgIHJldHVybiB7fTsKICB9LAoKICAvKioKICAgIEVhY2ggcmVjb3JkIGNhbiBoYXZlIGEgY29sb3IgdGhhdCByZXByZXNlbnRzIGl0cyBzdGF0ZS4KCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBnZXRSZWNvcmRDb2xvcgogICAgQHBhcmFtIHtPYmplY3R9IHJlY29yZCBUaGUgcmVjb3JkIGluc3RhbmNlCiAgICBAcmV0dXJuIHtTdHJpbmd9IFRoZSByZWNvcmQncyBjb2xvcgogICAgICBQb3NzaWJsZSBvcHRpb25zOiBibGFjaywgcmVkLCBibHVlLCBncmVlbgogICovCiAgZ2V0UmVjb3JkQ29sb3I6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgcmV0dXJuIG51bGw7CiAgfSwKCiAgLyoqCiAgICBPYnNlcnZlcyBhbGwgcmVsZXZhbnQgcHJvcGVydGllcyBhbmQgcmUtc2VuZHMgdGhlIHdyYXBwZWQgcmVjb3JkCiAgICB3aGVuIGEgY2hhbmdlIG9jY3Vycy4KCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBvYnNlcnZlclJlY29yZAogICAgQHBhcmFtIHtPYmplY3R9IHJlY29yZCBUaGUgcmVjb3JkIGluc3RhbmNlCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSByZWNvcmRVcGRhdGVkIFRoZSBjYWxsYmFjayB0byBjYWxsIHdoZW4gYSByZWNvcmQgaXMgdXBkYXRlZC4KICAgIEByZXR1cm4ge0Z1bmN0aW9ufSBUaGUgZnVuY3Rpb24gdG8gY2FsbCB0byByZW1vdmUgYWxsIG9ic2VydmVycy4KICAqLwogIG9ic2VydmVSZWNvcmQ6IGZ1bmN0aW9uKHJlY29yZCwgcmVjb3JkVXBkYXRlZCkgewogICAgcmV0dXJuIGZ1bmN0aW9uKCl7fTsKICB9Cgp9KTsKCgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgpFbWJlciBFeHRlbnNpb24gU3VwcG9ydAoKQG1vZHVsZSBlbWJlcgpAc3VibW9kdWxlIGVtYmVyLWV4dGVuc2lvbi1zdXBwb3J0CkByZXF1aXJlcyBlbWJlci1hcHBsaWNhdGlvbgoqLwoKfSkoKTsKCihmdW5jdGlvbigpIHsKLyoqCiAgQG1vZHVsZSBlbWJlcgogIEBzdWJtb2R1bGUgZW1iZXItdGVzdGluZwogKi8KdmFyIHNsaWNlID0gW10uc2xpY2UsCiAgICBoZWxwZXJzID0ge30sCiAgICBpbmplY3RIZWxwZXJzQ2FsbGJhY2tzID0gW107CgovKioKICBUaGlzIGlzIGEgY29udGFpbmVyIGZvciBhbiBhc3NvcnRtZW50IG9mIHRlc3RpbmcgcmVsYXRlZCBmdW5jdGlvbmFsaXR5OgoKICAqIENob29zZSB5b3VyIGRlZmF1bHQgdGVzdCBhZGFwdGVyIChmb3IgeW91ciBmcmFtZXdvcmsgb2YgY2hvaWNlKS4KICAqIFJlZ2lzdGVyL1VucmVnaXN0ZXIgYWRkaXRpb25hbCB0ZXN0IGhlbHBlcnMuCiAgKiBTZXR1cCBjYWxsYmFja3MgdG8gYmUgZmlyZWQgd2hlbiB0aGUgdGVzdCBoZWxwZXJzIGFyZSBpbmplY3RlZCBpbnRvCiAgICB5b3VyIGFwcGxpY2F0aW9uLgoKICBAY2xhc3MgVGVzdAogIEBuYW1lc3BhY2UgRW1iZXIKKi8KRW1iZXIuVGVzdCA9IHsKCiAgLyoqCiAgICBgcmVnaXN0ZXJIZWxwZXJgIGlzIHVzZWQgdG8gcmVnaXN0ZXIgYSB0ZXN0IGhlbHBlciB0aGF0IHdpbGwgYmUgaW5qZWN0ZWQKICAgIHdoZW4gYEFwcC5pbmplY3RUZXN0SGVscGVyc2AgaXMgY2FsbGVkLgoKICAgIFRoZSBoZWxwZXIgbWV0aG9kIHdpbGwgYWx3YXlzIGJlIGNhbGxlZCB3aXRoIHRoZSBjdXJyZW50IEFwcGxpY2F0aW9uIGFzCiAgICB0aGUgZmlyc3QgcGFyYW1ldGVyLgoKICAgIEZvciBleGFtcGxlOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIEVtYmVyLlRlc3QucmVnaXN0ZXJIZWxwZXIoJ2Jvb3QnLCBmdW5jdGlvbihhcHApIHsKICAgICAgRW1iZXIucnVuKGFwcCwgYXBwLmFkdmFuY2VSZWFkaW5lc3MpOwogICAgfSk7CiAgICBgYGAKCiAgICBUaGlzIGhlbHBlciBjYW4gbGF0ZXIgYmUgY2FsbGVkIHdpdGhvdXQgYXJndW1lbnRzIGJlY2F1c2UgaXQgd2lsbCBiZQogICAgY2FsbGVkIHdpdGggYGFwcGAgYXMgdGhlIGZpcnN0IHBhcmFtZXRlci4KCiAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAgPSBFbWJlci5BcHBsaWNhdGlvbi5jcmVhdGUoKTsKICAgIEFwcC5pbmplY3RUZXN0SGVscGVycygpOwogICAgYm9vdCgpOwogICAgYGBgCgogICAgQHB1YmxpYwogICAgQG1ldGhvZCByZWdpc3RlckhlbHBlcgogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGhlbHBlciBtZXRob2QgdG8gYWRkLgogICAgQHBhcmFtIHtGdW5jdGlvbn0gaGVscGVyTWV0aG9kCiAgICBAcGFyYW0gb3B0aW9ucyB7T2JqZWN0fQogICovCiAgcmVnaXN0ZXJIZWxwZXI6IGZ1bmN0aW9uKG5hbWUsIGhlbHBlck1ldGhvZCkgewogICAgaGVscGVyc1tuYW1lXSA9IHsKICAgICAgbWV0aG9kOiBoZWxwZXJNZXRob2QsCiAgICAgIG1ldGE6IHsgd2FpdDogZmFsc2UgfQogICAgfTsKICB9LAoKICAvKioKICAgIGByZWdpc3RlckFzeW5jSGVscGVyYCBpcyB1c2VkIHRvIHJlZ2lzdGVyIGFuIGFzeW5jIHRlc3QgaGVscGVyIHRoYXQgd2lsbCBiZSBpbmplY3RlZAogICAgd2hlbiBgQXBwLmluamVjdFRlc3RIZWxwZXJzYCBpcyBjYWxsZWQuCgogICAgVGhlIGhlbHBlciBtZXRob2Qgd2lsbCBhbHdheXMgYmUgY2FsbGVkIHdpdGggdGhlIGN1cnJlbnQgQXBwbGljYXRpb24gYXMKICAgIHRoZSBmaXJzdCBwYXJhbWV0ZXIuCgogICAgRm9yIGV4YW1wbGU6CgogICAgYGBgamF2YXNjcmlwdAogICAgRW1iZXIuVGVzdC5yZWdpc3RlckFzeW5jSGVscGVyKCdib290JywgZnVuY3Rpb24oYXBwKSB7CiAgICAgIEVtYmVyLnJ1bihhcHAsIGFwcC5hZHZhbmNlUmVhZGluZXNzKTsKICAgIH0pOwogICAgYGBgCgogICAgVGhlIGFkdmFudGFnZSBvZiBhbiBhc3luYyBoZWxwZXIgaXMgdGhhdCBpdCB3aWxsIG5vdCBydW4KICAgIHVudGlsIHRoZSBsYXN0IGFzeW5jIGhlbHBlciBoYXMgY29tcGxldGVkLiAgQWxsIGFzeW5jIGhlbHBlcnMKICAgIGFmdGVyIGl0IHdpbGwgd2FpdCBmb3IgaXQgY29tcGxldGUgYmVmb3JlIHJ1bm5pbmcuCgoKICAgIEZvciBleGFtcGxlOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIEVtYmVyLlRlc3QucmVnaXN0ZXJBc3luY0hlbHBlcignZGVsZXRlUG9zdCcsIGZ1bmN0aW9uKGFwcCwgcG9zdElkKSB7CiAgICAgIGNsaWNrKCcuZGVsZXRlLScgKyBwb3N0SWQpOwogICAgfSk7CgogICAgLy8gLi4uIGluIHlvdXIgdGVzdAogICAgdmlzaXQoJy9wb3N0LzInKTsKICAgIGRlbGV0ZVBvc3QoMik7CiAgICB2aXNpdCgnL3Bvc3QvMycpOwogICAgZGVsZXRlUG9zdCgzKTsKICAgIGBgYAoKICAgIEBwdWJsaWMKICAgIEBtZXRob2QgcmVnaXN0ZXJBc3luY0hlbHBlcgogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGhlbHBlciBtZXRob2QgdG8gYWRkLgogICAgQHBhcmFtIHtGdW5jdGlvbn0gaGVscGVyTWV0aG9kCiAgKi8KICByZWdpc3RlckFzeW5jSGVscGVyOiBmdW5jdGlvbihuYW1lLCBoZWxwZXJNZXRob2QpIHsKICAgIGhlbHBlcnNbbmFtZV0gPSB7CiAgICAgIG1ldGhvZDogaGVscGVyTWV0aG9kLAogICAgICBtZXRhOiB7IHdhaXQ6IHRydWUgfQogICAgfTsKICB9LAoKICAvKioKICAgIFJlbW92ZSBhIHByZXZpb3VzbHkgYWRkZWQgaGVscGVyIG1ldGhvZC4KCiAgICBFeGFtcGxlOgoKICAgIGBgYAogICAgRW1iZXIuVGVzdC51bnJlZ2lzdGVySGVscGVyKCd3YWl0Jyk7CiAgICBgYGAKCiAgICBAcHVibGljCiAgICBAbWV0aG9kIHVucmVnaXN0ZXJIZWxwZXIKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBoZWxwZXIgdG8gcmVtb3ZlLgogICovCiAgdW5yZWdpc3RlckhlbHBlcjogZnVuY3Rpb24obmFtZSkgewogICAgZGVsZXRlIGhlbHBlcnNbbmFtZV07CiAgICBkZWxldGUgRW1iZXIuVGVzdC5Qcm9taXNlLnByb3RvdHlwZVtuYW1lXTsKICB9LAoKICAvKioKICAgIFVzZWQgdG8gcmVnaXN0ZXIgY2FsbGJhY2tzIHRvIGJlIGZpcmVkIHdoZW5ldmVyIGBBcHAuaW5qZWN0VGVzdEhlbHBlcnNgCiAgICBpcyBjYWxsZWQuCgogICAgVGhlIGNhbGxiYWNrIHdpbGwgcmVjZWl2ZSB0aGUgY3VycmVudCBhcHBsaWNhdGlvbiBhcyBhbiBhcmd1bWVudC4KCiAgICBFeGFtcGxlOgogICAgYGBgCiAgICBFbWJlci5UZXN0Lm9uSW5qZWN0SGVscGVycyhmdW5jdGlvbigpIHsKICAgICAgRW1iZXIuJChkb2N1bWVudCkuYWpheFN0YXJ0KGZ1bmN0aW9uKCkgewogICAgICAgIFRlc3QucGVuZGluZ0FqYXhSZXF1ZXN0cysrOwogICAgICB9KTsKCiAgICAgIEVtYmVyLiQoZG9jdW1lbnQpLmFqYXhTdG9wKGZ1bmN0aW9uKCkgewogICAgICAgIFRlc3QucGVuZGluZ0FqYXhSZXF1ZXN0cy0tOwogICAgICB9KTsKICAgIH0pOwogICAgYGBgCgogICAgQHB1YmxpYwogICAgQG1ldGhvZCBvbkluamVjdEhlbHBlcnMKICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiB0byBiZSBjYWxsZWQuCiAgKi8KICBvbkluamVjdEhlbHBlcnM6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICBpbmplY3RIZWxwZXJzQ2FsbGJhY2tzLnB1c2goY2FsbGJhY2spOwogIH0sCgogIC8qKgogICAgVGhpcyByZXR1cm5zIGEgdGhlbmFibGUgdGFpbG9yZWQgZm9yIHRlc3RpbmcuICBJdCBjYXRjaGVzIGZhaWxlZAogICAgYG9uU3VjY2Vzc2AgY2FsbGJhY2tzIGFuZCBpbnZva2VzIHRoZSBgRW1iZXIuVGVzdC5hZGFwdGVyLmV4Y2VwdGlvbmAKICAgIGNhbGxiYWNrIGluIHRoZSBsYXN0IGNoYWluZWQgdGhlbi4KCiAgICBUaGlzIG1ldGhvZCBzaG91bGQgYmUgcmV0dXJuZWQgYnkgYXN5bmMgaGVscGVycyBzdWNoIGFzIGB3YWl0YC4KCiAgICBAcHVibGljCiAgICBAbWV0aG9kIHByb21pc2UKICAgIEBwYXJhbSB7RnVuY3Rpb259IHJlc29sdmVyIFRoZSBmdW5jdGlvbiB1c2VkIHRvIHJlc29sdmUgdGhlIHByb21pc2UuCiAgKi8KICBwcm9taXNlOiBmdW5jdGlvbihyZXNvbHZlcikgewogICAgcmV0dXJuIG5ldyBFbWJlci5UZXN0LlByb21pc2UocmVzb2x2ZXIpOwogIH0sCgogIC8qKgogICBVc2VkIHRvIGFsbG93IGVtYmVyLXRlc3RpbmcgdG8gY29tbXVuaWNhdGUgd2l0aCBhIHNwZWNpZmljIHRlc3RpbmcKICAgZnJhbWV3b3JrLgoKICAgWW91IGNhbiBtYW51YWxseSBzZXQgaXQgYmVmb3JlIGNhbGxpbmcgYEFwcC5zZXR1cEZvclRlc3RpbmcoKWAuCgogICBFeGFtcGxlOgoKICAgYGBgCiAgIEVtYmVyLlRlc3QuYWRhcHRlciA9IE15Q3VzdG9tQWRhcHRlci5jcmVhdGUoKQogICBgYGAKCiAgIElmIHlvdSBkbyBub3Qgc2V0IGl0LCBlbWJlci10ZXN0aW5nIHdpbGwgZGVmYXVsdCB0byBgRW1iZXIuVGVzdC5RVW5pdEFkYXB0ZXJgLgoKICAgQHB1YmxpYwogICBAcHJvcGVydHkgYWRhcHRlcgogICBAdHlwZSB7Q2xhc3N9IFRoZSBhZGFwdGVyIHRvIGJlIHVzZWQuCiAgIEBkZWZhdWx0IEVtYmVyLlRlc3QuUVVuaXRBZGFwdGVyCiAgKi8KICBhZGFwdGVyOiBudWxsLAoKICAvKioKICAgIFJlcGxhY2VtZW50IGZvciBgRW1iZXIuUlNWUC5yZXNvbHZlYAogICAgVGhlIG9ubHkgZGlmZmVyZW5jZSBpcyB0aGlzIHVzZXMKICAgIGFuZCBpbnN0YW5jZSBvZiBgRW1iZXIuVGVzdC5Qcm9taXNlYAoKICAgIEBwdWJsaWMKICAgIEBtZXRob2QgcmVzb2x2ZQogICAgQHBhcmFtIHtNaXhlZH0gVGhlIHZhbHVlIHRvIHJlc29sdmUKICAqLwogIHJlc29sdmU6IGZ1bmN0aW9uKHZhbCkgewogICAgcmV0dXJuIEVtYmVyLlRlc3QucHJvbWlzZShmdW5jdGlvbihyZXNvbHZlKSB7CiAgICAgIHJldHVybiByZXNvbHZlKHZhbCk7CiAgICB9KTsKICB9LAoKICAvKioKICAgICBUaGlzIGFsbG93cyBlbWJlci10ZXN0aW5nIHRvIHBsYXkgbmljZWx5IHdpdGggb3RoZXIgYXN5bmNocm9ub3VzCiAgICAgZXZlbnRzLCBzdWNoIGFzIGFuIGFwcGxpY2F0aW9uIHRoYXQgaXMgd2FpdGluZyBmb3IgYSBDU1MzCiAgICAgdHJhbnNpdGlvbiBvciBhbiBJbmRleERCIHRyYW5zYWN0aW9uLgoKICAgICBGb3IgZXhhbXBsZToKICAgICBgYGBqYXZhc2NyaXB0CiAgICAgRW1iZXIuVGVzdC5yZWdpc3RlcldhaXRlcihmdW5jdGlvbigpIHsKICAgICByZXR1cm4gbXlQZW5kaW5nVHJhbnNhY3Rpb25zKCkgPT0gMDsKICAgICB9KTsKICAgICBgYGAKICAgICBUaGUgYGNvbnRleHRgIGFyZ3VtZW50IGFsbG93cyB5b3UgdG8gb3B0aW9uYWxseSBzcGVjaWZ5IHRoZSBgdGhpc2AKICAgICB3aXRoIHdoaWNoIHlvdXIgY2FsbGJhY2sgd2lsbCBiZSBpbnZva2VkLgoKICAgICBGb3IgZXhhbXBsZToKICAgICBgYGBqYXZhc2NyaXB0CiAgICAgRW1iZXIuVGVzdC5yZWdpc3RlcldhaXRlcihNeURCLCBNeURCLmhhc1BlbmRpbmdUcmFuc2FjdGlvbnMpOwogICAgIGBgYAogICAgIEBwdWJsaWMKICAgICBAbWV0aG9kIHJlZ2lzdGVyV2FpdGVyCiAgICAgQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgKG9wdGlvbmFsKQogICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrCiAgKi8KICByZWdpc3RlcldhaXRlcjogZnVuY3Rpb24oY29udGV4dCwgY2FsbGJhY2spIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICAgIGNhbGxiYWNrID0gY29udGV4dDsKICAgICAgY29udGV4dCA9IG51bGw7CiAgICB9CiAgICBpZiAoIXRoaXMud2FpdGVycykgewogICAgICB0aGlzLndhaXRlcnMgPSBFbWJlci5BKCk7CiAgICB9CiAgICB0aGlzLndhaXRlcnMucHVzaChbY29udGV4dCwgY2FsbGJhY2tdKTsKICB9LAogIC8qKgogICAgIGB1bnJlZ2lzdGVyV2FpdGVyYCBpcyB1c2VkIHRvIHVucmVnaXN0ZXIgYSBjYWxsYmFjayB0aGF0IHdhcwogICAgIHJlZ2lzdGVyZWQgd2l0aCBgcmVnaXN0ZXJXYWl0ZXJgLgoKICAgICBAcHVibGljCiAgICAgQG1ldGhvZCB1bnJlZ2lzdGVyV2FpdGVyCiAgICAgQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgKG9wdGlvbmFsKQogICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrCiAgKi8KICB1bnJlZ2lzdGVyV2FpdGVyOiBmdW5jdGlvbihjb250ZXh0LCBjYWxsYmFjaykgewogICAgdmFyIHBhaXI7CiAgICBpZiAoIXRoaXMud2FpdGVycykgeyByZXR1cm47IH0KICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICAgIGNhbGxiYWNrID0gY29udGV4dDsKICAgICAgY29udGV4dCA9IG51bGw7CiAgICB9CiAgICBwYWlyID0gW2NvbnRleHQsIGNhbGxiYWNrXTsKICAgIHRoaXMud2FpdGVycyA9IEVtYmVyLkEodGhpcy53YWl0ZXJzLmZpbHRlcihmdW5jdGlvbihlbHQpIHsKICAgICAgcmV0dXJuIEVtYmVyLmNvbXBhcmUoZWx0LCBwYWlyKSE9PTA7CiAgICB9KSk7CiAgfQp9OwoKZnVuY3Rpb24gaGVscGVyKGFwcCwgbmFtZSkgewogIHZhciBmbiA9IGhlbHBlcnNbbmFtZV0ubWV0aG9kLAogICAgICBtZXRhID0gaGVscGVyc1tuYW1lXS5tZXRhOwoKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKSwKICAgICAgICBsYXN0UHJvbWlzZSA9IEVtYmVyLlRlc3QubGFzdFByb21pc2U7CgogICAgYXJncy51bnNoaWZ0KGFwcCk7CgogICAgLy8gc29tZSBoZWxwZXJzIGFyZSBub3QgYXN5bmMgYW5kCiAgICAvLyBuZWVkIHRvIHJldHVybiBhIHZhbHVlIGltbWVkaWF0ZWx5LgogICAgLy8gZXhhbXBsZTogYGZpbmRgCiAgICBpZiAoIW1ldGEud2FpdCkgewogICAgICByZXR1cm4gZm4uYXBwbHkoYXBwLCBhcmdzKTsKICAgIH0KCiAgICBpZiAoIWxhc3RQcm9taXNlKSB7CiAgICAgIC8vIEl0J3MgdGhlIGZpcnN0IGFzeW5jIGhlbHBlciBpbiBjdXJyZW50IGNvbnRleHQKICAgICAgbGFzdFByb21pc2UgPSBmbi5hcHBseShhcHAsIGFyZ3MpOwogICAgfSBlbHNlIHsKICAgICAgLy8gd2FpdCBmb3IgbGFzdCBoZWxwZXIncyBwcm9taXNlIHRvIHJlc29sdmUKICAgICAgLy8gYW5kIHRoZW4gZXhlY3V0ZQogICAgICBydW4oZnVuY3Rpb24oKSB7CiAgICAgICAgbGFzdFByb21pc2UgPSBFbWJlci5UZXN0LnJlc29sdmUobGFzdFByb21pc2UpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gZm4uYXBwbHkoYXBwLCBhcmdzKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIGxhc3RQcm9taXNlOwogIH07Cn0KCmZ1bmN0aW9uIHJ1bihmbikgewogIGlmICghRW1iZXIucnVuLmN1cnJlbnRSdW5Mb29wKSB7CiAgICBFbWJlci5ydW4oZm4pOwogIH0gZWxzZSB7CiAgICBmbigpOwogIH0KfQoKRW1iZXIuQXBwbGljYXRpb24ucmVvcGVuKHsKICAvKioKICAgVGhpcyBwcm9wZXJ0eSBjb250YWlucyB0aGUgdGVzdGluZyBoZWxwZXJzIGZvciB0aGUgY3VycmVudCBhcHBsaWNhdGlvbi4gVGhlc2UKICAgYXJlIGNyZWF0ZWQgb25jZSB5b3UgY2FsbCBgaW5qZWN0VGVzdEhlbHBlcnNgIG9uIHlvdXIgYEVtYmVyLkFwcGxpY2F0aW9uYAogICBpbnN0YW5jZS4gVGhlIGluY2x1ZGVkIGhlbHBlcnMgYXJlIGFsc28gYXZhaWxhYmxlIG9uIHRoZSBgd2luZG93YCBvYmplY3QgYnkKICAgZGVmYXVsdCwgYnV0IGNhbiBiZSB1c2VkIGZyb20gdGhpcyBvYmplY3Qgb24gdGhlIGluZGl2aWR1YWwgYXBwbGljYXRpb24gYWxzby4KCiAgICBAcHJvcGVydHkgdGVzdEhlbHBlcnMKICAgIEB0eXBlIHtPYmplY3R9CiAgICBAZGVmYXVsdCB7fQogICovCiAgdGVzdEhlbHBlcnM6IHt9LAoKICAvKioKICAgVGhpcyBwcm9wZXJ0eSB3aWxsIGNvbnRhaW4gdGhlIG9yaWdpbmFsIG1ldGhvZHMgdGhhdCB3ZXJlIHJlZ2lzdGVyZWQKICAgb24gdGhlIGBoZWxwZXJDb250YWluZXJgIGJlZm9yZSBgaW5qZWN0VGVzdEhlbHBlcnNgIGlzIGNhbGxlZC4KCiAgIFdoZW4gYHJlbW92ZVRlc3RIZWxwZXJzYCBpcyBjYWxsZWQsIHRoZXNlIG1ldGhvZHMgYXJlIHJlc3RvcmVkIHRvIHRoZQogICBgaGVscGVyQ29udGFpbmVyYC4KCiAgICBAcHJvcGVydHkgb3JpZ2luYWxNZXRob2RzCiAgICBAdHlwZSB7T2JqZWN0fQogICAgQGRlZmF1bHQge30KICAgIEBwcml2YXRlCiAgKi8KICBvcmlnaW5hbE1ldGhvZHM6IHt9LAoKCiAgLyoqCiAgVGhpcyBwcm9wZXJ0eSBpbmRpY2F0ZXMgd2hldGhlciBvciBub3QgdGhpcyBhcHBsaWNhdGlvbiBpcyBjdXJyZW50bHkgaW4KICB0ZXN0aW5nIG1vZGUuIFRoaXMgaXMgc2V0IHdoZW4gYHNldHVwRm9yVGVzdGluZ2AgaXMgY2FsbGVkIG9uIHRoZSBjdXJyZW50CiAgYXBwbGljYXRpb24uCgogIEBwcm9wZXJ0eSB0ZXN0aW5nCiAgQHR5cGUge0Jvb2xlYW59CiAgQGRlZmF1bHQgZmFsc2UKICAqLwogIHRlc3Rpbmc6IGZhbHNlLAoKICAvKioKICAgVGhpcyBob29rIGRlZmVycyB0aGUgcmVhZGluZXNzIG9mIHRoZSBhcHBsaWNhdGlvbiwgc28gdGhhdCB5b3UgY2FuIHN0YXJ0CiAgIHRoZSBhcHAgd2hlbiB5b3VyIHRlc3RzIGFyZSByZWFkeSB0byBydW4uIEl0IGFsc28gc2V0cyB0aGUgcm91dGVyJ3MKICAgbG9jYXRpb24gdG8gJ25vbmUnLCBzbyB0aGF0IHRoZSB3aW5kb3cncyBsb2NhdGlvbiB3aWxsIG5vdCBiZSBtb2RpZmllZAogICAocHJldmVudGluZyBib3RoIGFjY2lkZW50YWwgbGVha2luZyBvZiBzdGF0ZSBiZXR3ZWVuIHRlc3RzIGFuZCBpbnRlcmZlcmVuY2UKICAgd2l0aCB5b3VyIHRlc3RpbmcgZnJhbWV3b3JrKS4KCiAgIEV4YW1wbGU6CgogIGBgYAogIEFwcC5zZXR1cEZvclRlc3RpbmcoKTsKICBgYGAKCiAgICBAbWV0aG9kIHNldHVwRm9yVGVzdGluZwogICovCiAgc2V0dXBGb3JUZXN0aW5nOiBmdW5jdGlvbigpIHsKICAgIEVtYmVyLnRlc3RpbmcgPSB0cnVlOwoKICAgIHRoaXMudGVzdGluZyA9IHRydWU7CgogICAgdGhpcy5Sb3V0ZXIucmVvcGVuKHsKICAgICAgbG9jYXRpb246ICdub25lJwogICAgfSk7CgogICAgLy8gaWYgYWRhcHRlciBpcyBub3QgbWFudWFsbHkgc2V0IGRlZmF1bHQgdG8gUVVuaXQKICAgIGlmICghRW1iZXIuVGVzdC5hZGFwdGVyKSB7CiAgICAgICBFbWJlci5UZXN0LmFkYXB0ZXIgPSBFbWJlci5UZXN0LlFVbml0QWRhcHRlci5jcmVhdGUoKTsKICAgIH0KCiAgICAgIH0sCgogIC8qKgogICAgVGhpcyB3aWxsIGJlIHVzZWQgYXMgdGhlIGNvbnRhaW5lciB0byBpbmplY3QgdGhlIHRlc3QgaGVscGVycyBpbnRvLiBCeQogICAgZGVmYXVsdCB0aGUgaGVscGVycyBhcmUgaW5qZWN0ZWQgaW50byBgd2luZG93YC4KCiAgICBAcHJvcGVydHkgaGVscGVyQ29udGFpbmVyCiAgIEB0eXBlIHtPYmplY3R9IFRoZSBvYmplY3QgdG8gYmUgdXNlZCBmb3IgdGVzdCBoZWxwZXJzLgogICBAZGVmYXVsdCB3aW5kb3cKICAqLwogIGhlbHBlckNvbnRhaW5lcjogd2luZG93LAoKICAvKioKICAgIFRoaXMgaW5qZWN0cyB0aGUgdGVzdCBoZWxwZXJzIGludG8gdGhlIGBoZWxwZXJDb250YWluZXJgIG9iamVjdC4gSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkCiAgICBpdCB3aWxsIGJlIHVzZWQgYXMgdGhlIGhlbHBlckNvbnRhaW5lci4gSWYgYGhlbHBlckNvbnRhaW5lcmAgaXMgbm90IHNldCBpdCB3aWxsIGRlZmF1bHQKICAgIHRvIGB3aW5kb3dgLiBJZiBhIGZ1bmN0aW9uIG9mIHRoZSBzYW1lIG5hbWUgaGFzIGFscmVhZHkgYmVlbiBkZWZpbmVkIGl0IHdpbGwgYmUgY2FjaGVkCiAgICAoc28gdGhhdCBpdCBjYW4gYmUgcmVzZXQgaWYgdGhlIGhlbHBlciBpcyByZW1vdmVkIHdpdGggYHVucmVnaXN0ZXJIZWxwZXJgIG9yCiAgICBgcmVtb3ZlVGVzdEhlbHBlcnNgKS4KCiAgIEFueSBjYWxsYmFja3MgcmVnaXN0ZXJlZCB3aXRoIGBvbkluamVjdEhlbHBlcnNgIHdpbGwgYmUgY2FsbGVkIG9uY2UgdGhlCiAgIGhlbHBlcnMgaGF2ZSBiZWVuIGluamVjdGVkLgoKICBFeGFtcGxlOgogIGBgYAogIEFwcC5pbmplY3RUZXN0SGVscGVycygpOwogIGBgYAoKICAgIEBtZXRob2QgaW5qZWN0VGVzdEhlbHBlcnMKICAqLwogIGluamVjdFRlc3RIZWxwZXJzOiBmdW5jdGlvbihoZWxwZXJDb250YWluZXIpIHsKICAgIGlmIChoZWxwZXJDb250YWluZXIpIHsgdGhpcy5oZWxwZXJDb250YWluZXIgPSBoZWxwZXJDb250YWluZXI7IH0KCiAgICB0aGlzLnRlc3RIZWxwZXJzID0ge307CiAgICBmb3IgKHZhciBuYW1lIGluIGhlbHBlcnMpIHsKICAgICAgdGhpcy5vcmlnaW5hbE1ldGhvZHNbbmFtZV0gPSB0aGlzLmhlbHBlckNvbnRhaW5lcltuYW1lXTsKICAgICAgdGhpcy50ZXN0SGVscGVyc1tuYW1lXSA9IHRoaXMuaGVscGVyQ29udGFpbmVyW25hbWVdID0gaGVscGVyKHRoaXMsIG5hbWUpOwogICAgICBwcm90b1dyYXAoRW1iZXIuVGVzdC5Qcm9taXNlLnByb3RvdHlwZSwgbmFtZSwgaGVscGVyKHRoaXMsIG5hbWUpLCBoZWxwZXJzW25hbWVdLm1ldGEud2FpdCk7CiAgICB9CgogICAgZm9yKHZhciBpID0gMCwgbCA9IGluamVjdEhlbHBlcnNDYWxsYmFja3MubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIGluamVjdEhlbHBlcnNDYWxsYmFja3NbaV0odGhpcyk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICBUaGlzIHJlbW92ZXMgYWxsIGhlbHBlcnMgdGhhdCBoYXZlIGJlZW4gcmVnaXN0ZXJlZCwgYW5kIHJlc2V0cyBhbmQgZnVuY3Rpb25zCiAgICB0aGF0IHdlcmUgb3ZlcnJpZGRlbiBieSB0aGUgaGVscGVycy4KCiAgICBFeGFtcGxlOgoKICAgIGBgYGphdmFzY3JpcHQKICAgIEFwcC5yZW1vdmVUZXN0SGVscGVycygpOwogICAgYGBgCgogICAgQHB1YmxpYwogICAgQG1ldGhvZCByZW1vdmVUZXN0SGVscGVycwogICovCiAgcmVtb3ZlVGVzdEhlbHBlcnM6IGZ1bmN0aW9uKCkgewogICAgZm9yICh2YXIgbmFtZSBpbiBoZWxwZXJzKSB7CiAgICAgIHRoaXMuaGVscGVyQ29udGFpbmVyW25hbWVdID0gdGhpcy5vcmlnaW5hbE1ldGhvZHNbbmFtZV07CiAgICAgIGRlbGV0ZSB0aGlzLnRlc3RIZWxwZXJzW25hbWVdOwogICAgICBkZWxldGUgdGhpcy5vcmlnaW5hbE1ldGhvZHNbbmFtZV07CiAgICB9CiAgfQp9KTsKCi8vIFRoaXMgbWV0aG9kIGlzIG5vIGxvbmdlciBuZWVkZWQKLy8gQnV0IHN0aWxsIGhlcmUgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5Ci8vIG9mIGhlbHBlciBjaGFpbmluZwpmdW5jdGlvbiBwcm90b1dyYXAocHJvdG8sIG5hbWUsIGNhbGxiYWNrLCBpc0FzeW5jKSB7CiAgcHJvdG9bbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwogICAgaWYgKGlzQXN5bmMpIHsKICAgICAgcmV0dXJuIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRoaXMudGhlbihmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7CiAgICAgIH0pOwogICAgfQogIH07Cn0KCkVtYmVyLlRlc3QuUHJvbWlzZSA9IGZ1bmN0aW9uKCkgewogIEVtYmVyLlJTVlAuUHJvbWlzZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIEVtYmVyLlRlc3QubGFzdFByb21pc2UgPSB0aGlzOwp9OwoKRW1iZXIuVGVzdC5Qcm9taXNlLnByb3RvdHlwZSA9IEVtYmVyLmNyZWF0ZShFbWJlci5SU1ZQLlByb21pc2UucHJvdG90eXBlKTsKRW1iZXIuVGVzdC5Qcm9taXNlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEVtYmVyLlRlc3QuUHJvbWlzZTsKCi8vIFBhdGNoIGB0aGVuYCB0byBpc29sYXRlIGFzeW5jIG1ldGhvZHMKLy8gc3BlY2lmaWNhbGx5IGBFbWJlci5UZXN0Lmxhc3RQcm9taXNlYAp2YXIgb3JpZ2luYWxUaGVuID0gRW1iZXIuUlNWUC5Qcm9taXNlLnByb3RvdHlwZS50aGVuOwpFbWJlci5UZXN0LlByb21pc2UucHJvdG90eXBlLnRoZW4gPSBmdW5jdGlvbihvblN1Y2Nlc3MsIG9uRmFpbHVyZSkgewogIHJldHVybiBvcmlnaW5hbFRoZW4uY2FsbCh0aGlzLCBmdW5jdGlvbih2YWwpIHsKICAgIHJldHVybiBpc29sYXRlKG9uU3VjY2VzcywgdmFsKTsKICB9LCBvbkZhaWx1cmUpOwp9OwoKLy8gVGhpcyBtZXRob2QgaXNvbGF0ZXMgbmVzdGVkIGFzeW5jIG1ldGhvZHMKLy8gc28gdGhhdCB0aGV5IGRvbid0IGNvbmZsaWN0IHdpdGggb3RoZXIgbGFzdCBwcm9taXNlcy4KLy8KLy8gMS4gU2V0IGBFbWJlci5UZXN0Lmxhc3RQcm9taXNlYCB0byBudWxsCi8vIDIuIEludm9rZSBtZXRob2QKLy8gMy4gUmV0dXJuIHRoZSBsYXN0IHByb21pc2UgY3JlYXRlZCBkdXJpbmcgbWV0aG9kCi8vIDQuIFJlc3RvcmUgYEVtYmVyLlRlc3QubGFzdFByb21pc2VgIHRvIG9yaWdpbmFsIHZhbHVlCmZ1bmN0aW9uIGlzb2xhdGUoZm4sIHZhbCkgewogIHZhciB2YWx1ZSwgbGFzdFByb21pc2U7CgogIC8vIFJlc2V0IGxhc3RQcm9taXNlIGZvciBuZXN0ZWQgaGVscGVycwogIEVtYmVyLlRlc3QubGFzdFByb21pc2UgPSBudWxsOwoKICB2YWx1ZSA9IGZuLmNhbGwobnVsbCwgdmFsKTsKCiAgbGFzdFByb21pc2UgPSBFbWJlci5UZXN0Lmxhc3RQcm9taXNlOwoKICAvLyBJZiB0aGUgbWV0aG9kIHJldHVybmVkIGEgcHJvbWlzZQogIC8vIHJldHVybiB0aGF0IHByb21pc2UuIElmIG5vdCwKICAvLyByZXR1cm4gdGhlIGxhc3QgYXN5bmMgaGVscGVyJ3MgcHJvbWlzZQogIGlmICgodmFsdWUgJiYgKHZhbHVlIGluc3RhbmNlb2YgRW1iZXIuVGVzdC5Qcm9taXNlKSkgfHwgIWxhc3RQcm9taXNlKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfSBlbHNlIHsKICAgIHJ1bihmdW5jdGlvbigpIHsKICAgICAgbGFzdFByb21pc2UgPSBFbWJlci5UZXN0LnJlc29sdmUobGFzdFByb21pc2UpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9KTsKICAgIH0pOwogICAgcmV0dXJuIGxhc3RQcm9taXNlOwogIH0KfQoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewpFbWJlci5vbkxvYWQoJ0VtYmVyLkFwcGxpY2F0aW9uJywgZnVuY3Rpb24oQXBwbGljYXRpb24pIHsKICBBcHBsaWNhdGlvbi5pbml0aWFsaXplcih7CiAgICBuYW1lOiAnZGVmZXJSZWFkaW5lc3MgaW4gYHRlc3RpbmdgIG1vZGUnLAoKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKGNvbnRhaW5lciwgYXBwbGljYXRpb24pewogICAgICBpZiAoYXBwbGljYXRpb24udGVzdGluZykgewogICAgICAgIGFwcGxpY2F0aW9uLmRlZmVyUmVhZGluZXNzKCk7CiAgICAgIH0KICAgIH0KICB9KTsKCiAgfSk7Cgp9KSgpOwoKCgooZnVuY3Rpb24oKSB7Ci8qKgogIEBtb2R1bGUgZW1iZXIKICBAc3VibW9kdWxlIGVtYmVyLXRlc3RpbmcKICovCgp2YXIgJCA9IEVtYmVyLiQ7CgovKioKICBUaGlzIG1ldGhvZCBjcmVhdGVzIGEgY2hlY2tib3ggYW5kIHRyaWdnZXJzIHRoZSBjbGljayBldmVudCB0byBmaXJlIHRoZQogIHBhc3NlZCBpbiBoYW5kbGVyLiBJdCBpcyB1c2VkIHRvIGNvcnJlY3QgZm9yIGEgYnVnIGluIG9sZGVyIHZlcnNpb25zCiAgb2YgalF1ZXJ5IChlLmcgMS44LjMpLgoKICBAcHJpdmF0ZQogIEBtZXRob2QgdGVzdENoZWNrYm94Q2xpY2sKKi8KZnVuY3Rpb24gdGVzdENoZWNrYm94Q2xpY2soaGFuZGxlcikgewogICQoJzxpbnB1dCB0eXBlPSJjaGVja2JveCI+JykKICAgIC5jc3MoeyBwb3NpdGlvbjogJ2Fic29sdXRlJywgbGVmdDogJy0xMDAwcHgnLCB0b3A6ICctMTAwMHB4JyB9KQogICAgLmFwcGVuZFRvKCdib2R5JykKICAgIC5vbignY2xpY2snLCBoYW5kbGVyKQogICAgLnRyaWdnZXIoJ2NsaWNrJykKICAgIC5yZW1vdmUoKTsKfQoKJChmdW5jdGlvbigpIHsKICAvKgogICAgRGV0ZXJtaW5lIHdoZXRoZXIgYSBjaGVja2JveCBjaGVja2VkIHVzaW5nIGpRdWVyeSdzICJjbGljayIgbWV0aG9kIHdpbGwgaGF2ZQogICAgdGhlIGNvcnJlY3QgdmFsdWUgZm9yIGl0cyBjaGVja2VkIHByb3BlcnR5LgoKICAgIElmIHdlIGRldGVybWluZSB0aGF0IHRoZSBjdXJyZW50IGpRdWVyeSB2ZXJzaW9uIGV4aGliaXRzIHRoaXMgYmVoYXZpb3IsCiAgICBwYXRjaCBpdCB0byB3b3JrIGNvcnJlY3RseSBhcyBpbiB0aGUgY29tbWl0IGZvciB0aGUgYWN0dWFsIGZpeDoKICAgIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5L2NvbW1pdC8xZmIyZjkyLgogICovCiAgdGVzdENoZWNrYm94Q2xpY2soZnVuY3Rpb24oKSB7CiAgICBpZiAoIXRoaXMuY2hlY2tlZCAmJiAhJC5ldmVudC5zcGVjaWFsLmNsaWNrKSB7CiAgICAgICQuZXZlbnQuc3BlY2lhbC5jbGljayA9IHsKICAgICAgICAvLyBGb3IgY2hlY2tib3gsIGZpcmUgbmF0aXZlIGV2ZW50IHNvIGNoZWNrZWQgc3RhdGUgd2lsbCBiZSByaWdodAogICAgICAgIHRyaWdnZXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKCQubm9kZU5hbWUoIHRoaXMsICJpbnB1dCIgKSAmJiB0aGlzLnR5cGUgPT09ICJjaGVja2JveCIgJiYgdGhpcy5jbGljaykgewogICAgICAgICAgICB0aGlzLmNsaWNrKCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgfSk7CgogIC8vIFRyeSBhZ2FpbiB0byB2ZXJpZnkgdGhhdCB0aGUgcGF0Y2ggdG9vayBlZmZlY3Qgb3IgYmxvdyB1cC4KICB0ZXN0Q2hlY2tib3hDbGljayhmdW5jdGlvbigpIHsKICAgIEVtYmVyLndhcm4oImNsaWNrZWQgY2hlY2tib3hlcyBzaG91bGQgYmUgY2hlY2tlZCEgdGhlIGpRdWVyeSBwYXRjaCBkaWRuJ3Qgd29yayIsIHRoaXMuY2hlY2tlZCk7CiAgfSk7Cn0pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKIEBtb2R1bGUgZW1iZXIKIEBzdWJtb2R1bGUgZW1iZXItdGVzdGluZwoqLwoKdmFyIFRlc3QgPSBFbWJlci5UZXN0OwoKLyoqCiAgVGhlIHByaW1hcnkgcHVycG9zZSBvZiB0aGlzIGNsYXNzIGlzIHRvIGNyZWF0ZSBob29rcyB0aGF0IGNhbiBiZSBpbXBsZW1lbnRlZAogIGJ5IGFuIGFkYXB0ZXIgZm9yIHZhcmlvdXMgdGVzdCBmcmFtZXdvcmtzLgoKICBAY2xhc3MgQWRhcHRlcgogIEBuYW1lc3BhY2UgRW1iZXIuVGVzdAoqLwpUZXN0LkFkYXB0ZXIgPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKICAvKioKICAgIFRoaXMgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgd2hlbmV2ZXIgYW4gYXN5bmMgb3BlcmF0aW9uIGlzIGFib3V0IHRvIHN0YXJ0LgoKICAgIE92ZXJyaWRlIHRoaXMgdG8gY2FsbCB5b3VyIGZyYW1ld29yaydzIG1ldGhvZHMgdGhhdCBoYW5kbGUgYXN5bmMKICAgIG9wZXJhdGlvbnMuCgogICAgQHB1YmxpYwogICAgQG1ldGhvZCBhc3luY1N0YXJ0CiAgKi8KICBhc3luY1N0YXJ0OiBFbWJlci5LLAoKICAvKioKICAgIFRoaXMgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgd2hlbmV2ZXIgYW4gYXN5bmMgb3BlcmF0aW9uIGhhcyBjb21wbGV0ZWQuCgogICAgQHB1YmxpYwogICAgQG1ldGhvZCBhc3luY0VuZAogICovCiAgYXN5bmNFbmQ6IEVtYmVyLkssCgogIC8qKgogICAgT3ZlcnJpZGUgdGhpcyBtZXRob2Qgd2l0aCB5b3VyIHRlc3RpbmcgZnJhbWV3b3JrJ3MgZmFsc2UgYXNzZXJ0aW9uLgogICAgVGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQgd2hlbmV2ZXIgYW4gZXhjZXB0aW9uIG9jY3VycyBjYXVzaW5nIHRoZSB0ZXN0aW5nCiAgICBwcm9taXNlIHRvIGZhaWwuCgogICAgUVVuaXQgZXhhbXBsZToKCiAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGV4Y2VwdGlvbjogZnVuY3Rpb24oZXJyb3IpIHsKICAgICAgICBvayhmYWxzZSwgZXJyb3IpOwogICAgICB9OwogICAgYGBgCgogICAgQHB1YmxpYwogICAgQG1ldGhvZCBleGNlcHRpb24KICAgIEBwYXJhbSB7U3RyaW5nfSBlcnJvciBUaGUgZXhjZXB0aW9uIHRvIGJlIHJhaXNlZC4KICAqLwogIGV4Y2VwdGlvbjogZnVuY3Rpb24oZXJyb3IpIHsKICAgIHRocm93IGVycm9yOwogIH0KfSk7CgovKioKICBUaGlzIGNsYXNzIGltcGxlbWVudHMgdGhlIG1ldGhvZHMgZGVmaW5lZCBieSBFbWJlci5UZXN0LkFkYXB0ZXIgZm9yIHRoZQogIFFVbml0IHRlc3RpbmcgZnJhbWV3b3JrLgoKICBAY2xhc3MgUVVuaXRBZGFwdGVyCiAgQG5hbWVzcGFjZSBFbWJlci5UZXN0CiAgQGV4dGVuZHMgRW1iZXIuVGVzdC5BZGFwdGVyCiovClRlc3QuUVVuaXRBZGFwdGVyID0gVGVzdC5BZGFwdGVyLmV4dGVuZCh7CiAgYXN5bmNTdGFydDogZnVuY3Rpb24oKSB7CiAgICBzdG9wKCk7CiAgfSwKICBhc3luY0VuZDogZnVuY3Rpb24oKSB7CiAgICBzdGFydCgpOwogIH0sCiAgZXhjZXB0aW9uOiBmdW5jdGlvbihlcnJvcikgewogICAgb2soZmFsc2UsIEVtYmVyLmluc3BlY3QoZXJyb3IpKTsKICB9Cn0pOwoKfSkoKTsKCgoKKGZ1bmN0aW9uKCkgewovKioKKiBAbW9kdWxlIGVtYmVyCiogQHN1Ym1vZHVsZSBlbWJlci10ZXN0aW5nCiovCgp2YXIgZ2V0ID0gRW1iZXIuZ2V0LAogICAgVGVzdCA9IEVtYmVyLlRlc3QsCiAgICBoZWxwZXIgPSBUZXN0LnJlZ2lzdGVySGVscGVyLAogICAgYXN5bmNIZWxwZXIgPSBUZXN0LnJlZ2lzdGVyQXN5bmNIZWxwZXIsCiAgICBjb3VudEFzeW5jID0gMDsKClRlc3QucGVuZGluZ0FqYXhSZXF1ZXN0cyA9IDA7CgpUZXN0Lm9uSW5qZWN0SGVscGVycyhmdW5jdGlvbigpIHsKICBFbWJlci4kKGRvY3VtZW50KS5hamF4U3RhcnQoZnVuY3Rpb24oKSB7CiAgICBUZXN0LnBlbmRpbmdBamF4UmVxdWVzdHMrKzsKICB9KTsKCiAgRW1iZXIuJChkb2N1bWVudCkuYWpheFN0b3AoZnVuY3Rpb24oKSB7CiAgICBFbWJlci5hc3NlcnQoIkFuIGFqYXhTdG9wIGV2ZW50IHdoaWNoIHdvdWxkIGNhdXNlIHRoZSBudW1iZXIgb2YgcGVuZGluZyBBSkFYICIgKwogICAgICAgICAgICAgICAgICJyZXF1ZXN0cyB0byBiZSBuZWdhdGl2ZSBoYXMgYmVlbiB0cmlnZ2VyZWQuIFRoaXMgaXMgbW9zdCBsaWtlbHkgIiArCiAgICAgICAgICAgICAgICAgImNhdXNlZCBieSBBSkFYIGV2ZW50cyB0aGF0IHdlcmUgc3RhcnRlZCBiZWZvcmUgY2FsbGluZyAiICsKICAgICAgICAgICAgICAgICAiYGluamVjdFRlc3RIZWxwZXJzKClgLiIsIFRlc3QucGVuZGluZ0FqYXhSZXF1ZXN0cyAhPT0gMCk7CiAgICBUZXN0LnBlbmRpbmdBamF4UmVxdWVzdHMtLTsKICB9KTsKfSk7CgpmdW5jdGlvbiBjdXJyZW50Um91dGVOYW1lKGFwcCl7CiAgdmFyIGFwcENvbnRyb2xsZXIgPSBhcHAuX19jb250YWluZXJfXy5sb29rdXAoJ2NvbnRyb2xsZXI6YXBwbGljYXRpb24nKTsKCiAgcmV0dXJuIGdldChhcHBDb250cm9sbGVyLCAnY3VycmVudFJvdXRlTmFtZScpOwp9CgpmdW5jdGlvbiBjdXJyZW50UGF0aChhcHApewogIHZhciBhcHBDb250cm9sbGVyID0gYXBwLl9fY29udGFpbmVyX18ubG9va3VwKCdjb250cm9sbGVyOmFwcGxpY2F0aW9uJyk7CgogIHJldHVybiBnZXQoYXBwQ29udHJvbGxlciwgJ2N1cnJlbnRQYXRoJyk7Cn0KCmZ1bmN0aW9uIGN1cnJlbnRVUkwoYXBwKXsKICB2YXIgcm91dGVyID0gYXBwLl9fY29udGFpbmVyX18ubG9va3VwKCdyb3V0ZXI6bWFpbicpOwoKICByZXR1cm4gZ2V0KHJvdXRlciwgJ2xvY2F0aW9uJykuZ2V0VVJMKCk7Cn0KCmZ1bmN0aW9uIHZpc2l0KGFwcCwgdXJsKSB7CiAgRW1iZXIucnVuKGFwcCwgJ2FkdmFuY2VSZWFkaW5lc3MnKTsKCiAgYXBwLl9fY29udGFpbmVyX18ubG9va3VwKCdyb3V0ZXI6bWFpbicpLmxvY2F0aW9uLnNldFVSTCh1cmwpOwogIEVtYmVyLnJ1bihhcHAsIGFwcC5oYW5kbGVVUkwsIHVybCk7CiAgcmV0dXJuIHdhaXQoYXBwKTsKfQoKZnVuY3Rpb24gY2xpY2soYXBwLCBzZWxlY3RvciwgY29udGV4dCkgewogIHZhciAkZWwgPSBmaW5kV2l0aEFzc2VydChhcHAsIHNlbGVjdG9yLCBjb250ZXh0KTsKICBFbWJlci5ydW4oJGVsLCAnbW91c2Vkb3duJyk7CgogIGlmICgkZWwuaXMoJzppbnB1dCcpKSB7CiAgICB2YXIgdHlwZSA9ICRlbC5wcm9wKCd0eXBlJyk7CiAgICBpZiAodHlwZSAhPT0gJ2NoZWNrYm94JyAmJiB0eXBlICE9PSAncmFkaW8nICYmIHR5cGUgIT09ICdoaWRkZW4nKSB7CiAgICAgIEVtYmVyLnJ1bigkZWwsIGZ1bmN0aW9uKCl7CiAgICAgICAgLy8gRmlyZWZveCBkb2VzIG5vdCB0cmlnZ2VyIHRoZSBgZm9jdXNpbmAgZXZlbnQgaWYgdGhlIHdpbmRvdwogICAgICAgIC8vIGRvZXMgbm90IGhhdmUgZm9jdXMuIElmIHRoZSBkb2N1bWVudCBkb2Vzbid0IGhhdmUgZm9jdXMganVzdAogICAgICAgIC8vIHVzZSB0cmlnZ2VyKCdmb2N1c2luJykgaW5zdGVhZC4KICAgICAgICBpZiAoIWRvY3VtZW50Lmhhc0ZvY3VzIHx8IGRvY3VtZW50Lmhhc0ZvY3VzKCkpIHsKICAgICAgICAgIHRoaXMuZm9jdXMoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy50cmlnZ2VyKCdmb2N1c2luJyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9CgogIEVtYmVyLnJ1bigkZWwsICdtb3VzZXVwJyk7CiAgRW1iZXIucnVuKCRlbCwgJ2NsaWNrJyk7CgogIHJldHVybiB3YWl0KGFwcCk7Cn0KCmZ1bmN0aW9uIHRyaWdnZXJFdmVudChhcHAsIHNlbGVjdG9yLCBjb250ZXh0LCBldmVudCl7CiAgaWYgKHR5cGVvZiBtZXRob2QgPT09ICd1bmRlZmluZWQnKSB7CiAgICBldmVudCA9IGNvbnRleHQ7CiAgICBjb250ZXh0ID0gbnVsbDsKICB9CgogIHZhciAkZWwgPSBmaW5kV2l0aEFzc2VydChhcHAsIHNlbGVjdG9yLCBjb250ZXh0KTsKCiAgRW1iZXIucnVuKCRlbCwgJ3RyaWdnZXInLCBldmVudCk7CgogIHJldHVybiB3YWl0KGFwcCk7Cn0KCmZ1bmN0aW9uIGtleUV2ZW50KGFwcCwgc2VsZWN0b3IsIGNvbnRleHQsIHR5cGUsIGtleUNvZGUpIHsKICB2YXIgJGVsOwogIGlmICh0eXBlb2Yga2V5Q29kZSA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgIGtleUNvZGUgPSB0eXBlOwogICAgdHlwZSA9IGNvbnRleHQ7CiAgICBjb250ZXh0ID0gbnVsbDsKICB9CiAgJGVsID0gZmluZFdpdGhBc3NlcnQoYXBwLCBzZWxlY3RvciwgY29udGV4dCk7CiAgdmFyIGV2ZW50ID0gRW1iZXIuJC5FdmVudCh0eXBlLCB7IGtleUNvZGU6IGtleUNvZGUgfSk7CiAgRW1iZXIucnVuKCRlbCwgJ3RyaWdnZXInLCBldmVudCk7CiAgcmV0dXJuIHdhaXQoYXBwKTsKfQoKZnVuY3Rpb24gZmlsbEluKGFwcCwgc2VsZWN0b3IsIGNvbnRleHQsIHRleHQpIHsKICB2YXIgJGVsOwogIGlmICh0eXBlb2YgdGV4dCA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgIHRleHQgPSBjb250ZXh0OwogICAgY29udGV4dCA9IG51bGw7CiAgfQogICRlbCA9IGZpbmRXaXRoQXNzZXJ0KGFwcCwgc2VsZWN0b3IsIGNvbnRleHQpOwogIEVtYmVyLnJ1bihmdW5jdGlvbigpIHsKICAgICRlbC52YWwodGV4dCkuY2hhbmdlKCk7CiAgfSk7CiAgcmV0dXJuIHdhaXQoYXBwKTsKfQoKZnVuY3Rpb24gZmluZFdpdGhBc3NlcnQoYXBwLCBzZWxlY3RvciwgY29udGV4dCkgewogIHZhciAkZWwgPSBmaW5kKGFwcCwgc2VsZWN0b3IsIGNvbnRleHQpOwogIGlmICgkZWwubGVuZ3RoID09PSAwKSB7CiAgICB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoIkVsZW1lbnQgIiArIHNlbGVjdG9yICsgIiBub3QgZm91bmQuIik7CiAgfQogIHJldHVybiAkZWw7Cn0KCmZ1bmN0aW9uIGZpbmQoYXBwLCBzZWxlY3RvciwgY29udGV4dCkgewogIHZhciAkZWw7CiAgY29udGV4dCA9IGNvbnRleHQgfHwgZ2V0KGFwcCwgJ3Jvb3RFbGVtZW50Jyk7CiAgJGVsID0gYXBwLiQoc2VsZWN0b3IsIGNvbnRleHQpOwoKICByZXR1cm4gJGVsOwp9CgpmdW5jdGlvbiBhbmRUaGVuKGFwcCwgY2FsbGJhY2spIHsKICByZXR1cm4gd2FpdChhcHAsIGNhbGxiYWNrKGFwcCkpOwp9CgpmdW5jdGlvbiB3YWl0KGFwcCwgdmFsdWUpIHsKICByZXR1cm4gVGVzdC5wcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUpIHsKICAgIC8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IGFzeW5jIHByb21pc2UsIGtpY2sgb2ZmIHRoZSBhc3luYyB0ZXN0CiAgICBpZiAoKytjb3VudEFzeW5jID09PSAxKSB7CiAgICAgIFRlc3QuYWRhcHRlci5hc3luY1N0YXJ0KCk7CiAgICB9CgogICAgLy8gRXZlcnkgMTBtcywgcG9sbCBmb3IgdGhlIGFzeW5jIHRoaW5nIHRvIGhhdmUgZmluaXNoZWQKICAgIHZhciB3YXRjaGVyID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKSB7CiAgICAgIC8vIDEuIElmIHRoZSByb3V0ZXIgaXMgbG9hZGluZywga2VlcCBwb2xsaW5nCiAgICAgIHZhciByb3V0ZXJJc0xvYWRpbmcgPSBhcHAuX19jb250YWluZXJfXy5sb29rdXAoJ3JvdXRlcjptYWluJykucm91dGVyLmlzTG9hZGluZzsKICAgICAgaWYgKHJvdXRlcklzTG9hZGluZykgeyByZXR1cm47IH0KCiAgICAgIC8vIDIuIElmIHRoZXJlIGFyZSBwZW5kaW5nIEFqYXggcmVxdWVzdHMsIGtlZXAgcG9sbGluZwogICAgICBpZiAoVGVzdC5wZW5kaW5nQWpheFJlcXVlc3RzKSB7IHJldHVybjsgfQoKICAgICAgLy8gMy4gSWYgdGhlcmUgYXJlIHNjaGVkdWxlZCB0aW1lcnMgb3Igd2UgYXJlIGluc2lkZSBvZiBhIHJ1biBsb29wLCBrZWVwIHBvbGxpbmcKICAgICAgaWYgKEVtYmVyLnJ1bi5oYXNTY2hlZHVsZWRUaW1lcnMoKSB8fCBFbWJlci5ydW4uY3VycmVudFJ1bkxvb3ApIHsgcmV0dXJuOyB9CiAgICAgIGlmIChUZXN0LndhaXRlcnMgJiYgVGVzdC53YWl0ZXJzLmFueShmdW5jdGlvbih3YWl0ZXIpIHsKICAgICAgICB2YXIgY29udGV4dCA9IHdhaXRlclswXTsKICAgICAgICB2YXIgY2FsbGJhY2sgPSB3YWl0ZXJbMV07CiAgICAgICAgcmV0dXJuICFjYWxsYmFjay5jYWxsKGNvbnRleHQpOwogICAgICB9KSkgeyByZXR1cm47IH0KICAgICAgLy8gU3RvcCBwb2xsaW5nCiAgICAgIGNsZWFySW50ZXJ2YWwod2F0Y2hlcik7CgogICAgICAvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IGFzeW5jIHByb21pc2UsIGVuZCB0aGUgYXN5bmMgdGVzdAogICAgICBpZiAoLS1jb3VudEFzeW5jID09PSAwKSB7CiAgICAgICAgVGVzdC5hZGFwdGVyLmFzeW5jRW5kKCk7CiAgICAgIH0KCiAgICAgIC8vIFN5bmNocm9ub3VzbHkgcmVzb2x2ZSB0aGUgcHJvbWlzZQogICAgICBFbWJlci5ydW4obnVsbCwgcmVzb2x2ZSwgdmFsdWUpOwogICAgfSwgMTApOwogIH0pOwoKfQoKCi8qKgoqIExvYWRzIGEgcm91dGUsIHNldHMgdXAgYW55IGNvbnRyb2xsZXJzLCBhbmQgcmVuZGVycyBhbnkgdGVtcGxhdGVzIGFzc29jaWF0ZWQKKiB3aXRoIHRoZSByb3V0ZSBhcyB0aG91Z2ggYSByZWFsIHVzZXIgaGFkIHRyaWdnZXJlZCB0aGUgcm91dGUgY2hhbmdlIHdoaWxlCiogdXNpbmcgeW91ciBhcHAuCioKKiBFeGFtcGxlOgoqCiogYGBgamF2YXNjcmlwdAoqIHZpc2l0KCdwb3N0cy9pbmRleCcpLnRoZW4oZnVuY3Rpb24oKSB7CiogICAvLyBhc3NlcnQgc29tZXRoaW5nCiogfSk7CiogYGBgCioKKiBAbWV0aG9kIHZpc2l0CiogQHBhcmFtIHtTdHJpbmd9IHVybCB0aGUgbmFtZSBvZiB0aGUgcm91dGUKKiBAcmV0dXJuIHtSU1ZQLlByb21pc2V9CiovCmFzeW5jSGVscGVyKCd2aXNpdCcsIHZpc2l0KTsKCi8qKgoqIENsaWNrcyBhbiBlbGVtZW50IGFuZCB0cmlnZ2VycyBhbnkgYWN0aW9ucyB0cmlnZ2VyZWQgYnkgdGhlIGVsZW1lbnQncyBgY2xpY2tgCiogZXZlbnQuCioKKiBFeGFtcGxlOgoqCiogYGBgamF2YXNjcmlwdAoqIGNsaWNrKCcuc29tZS1qUXVlcnktc2VsZWN0b3InKS50aGVuKGZ1bmN0aW9uKCkgewoqICAvLyBhc3NlcnQgc29tZXRoaW5nCiogfSk7CiogYGBgCioKKiBAbWV0aG9kIGNsaWNrCiogQHBhcmFtIHtTdHJpbmd9IHNlbGVjdG9yIGpRdWVyeSBzZWxlY3RvciBmb3IgZmluZGluZyBlbGVtZW50IG9uIHRoZSBET00KKiBAcmV0dXJuIHtSU1ZQLlByb21pc2V9CiovCmFzeW5jSGVscGVyKCdjbGljaycsIGNsaWNrKTsKCi8qKgoqIFNpbXVsYXRlcyBhIGtleSBldmVudCwgZS5nLiBga2V5cHJlc3NgLCBga2V5ZG93bmAsIGBrZXl1cGAgd2l0aCB0aGUgZGVzaXJlZCBrZXlDb2RlCioKKiBFeGFtcGxlOgoqCiogYGBgamF2YXNjcmlwdAoqIGtleUV2ZW50KCcuc29tZS1qUXVlcnktc2VsZWN0b3InLCAna2V5cHJlc3MnLCAxMykudGhlbihmdW5jdGlvbigpIHsKKiAgLy8gYXNzZXJ0IHNvbWV0aGluZwoqIH0pOwoqIGBgYAoqCiogQG1ldGhvZCBrZXlFdmVudAoqIEBwYXJhbSB7U3RyaW5nfSBzZWxlY3RvciBqUXVlcnkgc2VsZWN0b3IgZm9yIGZpbmRpbmcgZWxlbWVudCBvbiB0aGUgRE9NCiogQHBhcmFtIHtTdHJpbmd9IHRoZSB0eXBlIG9mIGtleSBldmVudCwgZS5nLiBga2V5cHJlc3NgLCBga2V5ZG93bmAsIGBrZXl1cGAKKiBAcGFyYW0ge051bWJlcn0gdGhlIGtleUNvZGUgb2YgdGhlIHNpbXVsYXRlZCBrZXkgZXZlbnQKKiBAcmV0dXJuIHtSU1ZQLlByb21pc2V9CiovCmFzeW5jSGVscGVyKCdrZXlFdmVudCcsIGtleUV2ZW50KTsKCi8qKgoqIEZpbGxzIGluIGFuIGlucHV0IGVsZW1lbnQgd2l0aCBzb21lIHRleHQuCioKKiBFeGFtcGxlOgoqCiogYGBgamF2YXNjcmlwdAoqIGZpbGxJbignI2VtYWlsJywgJ3lvdUBleGFtcGxlLmNvbScpLnRoZW4oZnVuY3Rpb24oKSB7CiogICAvLyBhc3NlcnQgc29tZXRoaW5nCiogfSk7CiogYGBgCioKKiBAbWV0aG9kIGZpbGxJbgoqIEBwYXJhbSB7U3RyaW5nfSBzZWxlY3RvciBqUXVlcnkgc2VsZWN0b3IgZmluZGluZyBhbiBpbnB1dCBlbGVtZW50IG9uIHRoZSBET00KKiB0byBmaWxsIHRleHQgd2l0aAoqIEBwYXJhbSB7U3RyaW5nfSB0ZXh0IHRleHQgdG8gcGxhY2UgaW5zaWRlIHRoZSBpbnB1dCBlbGVtZW50CiogQHJldHVybiB7UlNWUC5Qcm9taXNlfQoqLwphc3luY0hlbHBlcignZmlsbEluJywgZmlsbEluKTsKCi8qKgoqIEZpbmRzIGFuIGVsZW1lbnQgaW4gdGhlIGNvbnRleHQgb2YgdGhlIGFwcCdzIGNvbnRhaW5lciBlbGVtZW50LiBBIHNpbXBsZSBhbGlhcwoqIGZvciBgYXBwLiQoc2VsZWN0b3IpYC4KKgoqIEV4YW1wbGU6CioKKiBgYGBqYXZhc2NyaXB0CiogdmFyICRlbCA9IGZpbmQoJy5teS1zZWxlY3Rvcik7CiogYGBgCioKKiBAbWV0aG9kIGZpbmQKKiBAcGFyYW0ge1N0cmluZ30gc2VsZWN0b3IgalF1ZXJ5IHN0cmluZyBzZWxlY3RvciBmb3IgZWxlbWVudCBsb29rdXAKKiBAcmV0dXJuIHtPYmplY3R9IGpRdWVyeSBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSByZXN1bHRzIG9mIHRoZSBxdWVyeQoqLwpoZWxwZXIoJ2ZpbmQnLCBmaW5kKTsKCi8qKgoqIExpa2UgYGZpbmRgLCBidXQgdGhyb3dzIGFuIGVycm9yIGlmIHRoZSBlbGVtZW50IHNlbGVjdG9yIHJldHVybnMgbm8gcmVzdWx0cy4KKgoqIEV4YW1wbGU6CioKKiBgYGBqYXZhc2NyaXB0CiogdmFyICRlbCA9IGZpbmRXaXRoQXNzZXJ0KCcuZG9lc250LWV4aXN0Jyk7IC8vIHRocm93cyBlcnJvcgoqIGBgYAoqCiogQG1ldGhvZCBmaW5kV2l0aEFzc2VydAoqIEBwYXJhbSB7U3RyaW5nfSBzZWxlY3RvciBqUXVlcnkgc2VsZWN0b3Igc3RyaW5nIGZvciBmaW5kaW5nIGFuIGVsZW1lbnQgd2l0aGluCiogdGhlIERPTQoqIEByZXR1cm4ge09iamVjdH0galF1ZXJ5IG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHJlc3VsdHMgb2YgdGhlIHF1ZXJ5CiogQHRocm93cyB7RXJyb3J9IHRocm93cyBlcnJvciBpZiBqUXVlcnkgb2JqZWN0IHJldHVybmVkIGhhcyBhIGxlbmd0aCBvZiAwCiovCmhlbHBlcignZmluZFdpdGhBc3NlcnQnLCBmaW5kV2l0aEFzc2VydCk7CgovKioKICBDYXVzZXMgdGhlIHJ1biBsb29wIHRvIHByb2Nlc3MgYW55IHBlbmRpbmcgZXZlbnRzLiBUaGlzIGlzIHVzZWQgdG8gZW5zdXJlIHRoYXQKICBhbnkgYXN5bmMgb3BlcmF0aW9ucyBmcm9tIG90aGVyIGhlbHBlcnMgKG9yIHlvdXIgYXNzZXJ0aW9ucykgaGF2ZSBiZWVuIHByb2Nlc3NlZC4KCiAgVGhpcyBpcyBtb3N0IG9mdGVuIHVzZWQgYXMgdGhlIHJldHVybiB2YWx1ZSBmb3IgdGhlIGhlbHBlciBmdW5jdGlvbnMgKHNlZSAnY2xpY2snLAogICdmaWxsSW4nLCd2aXNpdCcsZXRjKS4KCiAgRXhhbXBsZToKCiAgYGBgamF2YXNjcmlwdAogIEVtYmVyLlRlc3QucmVnaXN0ZXJBc3luY0hlbHBlcignbG9naW5Vc2VyJywgZnVuY3Rpb24oYXBwLCB1c2VybmFtZSwgcGFzc3dvcmQpIHsKICAgIHZpc2l0KCdzZWN1cmVkL3BhdGgvaGVyZScpCiAgICAuZmlsbEluKCcjdXNlcm5hbWUnLCB1c2VybmFtZSkKICAgIC5maWxsSW4oJyNwYXNzd29yZCcsIHVzZXJuYW1lKQogICAgLmNsaWNrKCcuc3VibWl0JykKCiAgICByZXR1cm4gd2FpdCgpOwogIH0pOwoKICBAbWV0aG9kIHdhaXQKICBAcGFyYW0ge09iamVjdH0gdmFsdWUgVGhlIHZhbHVlIHRvIGJlIHJldHVybmVkLgogIEByZXR1cm4ge1JTVlAuUHJvbWlzZX0KKi8KYXN5bmNIZWxwZXIoJ3dhaXQnLCB3YWl0KTsKYXN5bmNIZWxwZXIoJ2FuZFRoZW4nLCBhbmRUaGVuKTsKCgoKCn0pKCk7CgoKCihmdW5jdGlvbigpIHsKLyoqCiAgRW1iZXIgVGVzdGluZwoKICBAbW9kdWxlIGVtYmVyCiAgQHN1Ym1vZHVsZSBlbWJlci10ZXN0aW5nCiAgQHJlcXVpcmVzIGVtYmVyLWFwcGxpY2F0aW9uCiovCgp9KSgpOwoKKGZ1bmN0aW9uKCkgewovKioKRW1iZXIKCkBtb2R1bGUgZW1iZXIKKi8KCmZ1bmN0aW9uIHRocm93V2l0aE1lc3NhZ2UobXNnKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgdGhyb3cgbmV3IEVtYmVyLkVycm9yKG1zZyk7CiAgfTsKfQoKZnVuY3Rpb24gZ2VuZXJhdGVSZW1vdmVkQ2xhc3MoY2xhc3NOYW1lKSB7CiAgdmFyIG1zZyA9ICIgaGFzIGJlZW4gbW92ZWQgaW50byBhIHBsdWdpbjogaHR0cHM6Ly9naXRodWIuY29tL2VtYmVyanMvZW1iZXItc3RhdGVzIjsKCiAgcmV0dXJuIHsKICAgIGV4dGVuZDogdGhyb3dXaXRoTWVzc2FnZShjbGFzc05hbWUgKyBtc2cpLAogICAgY3JlYXRlOiB0aHJvd1dpdGhNZXNzYWdlKGNsYXNzTmFtZSArIG1zZykKICB9Owp9CgpFbWJlci5TdGF0ZU1hbmFnZXIgPSBnZW5lcmF0ZVJlbW92ZWRDbGFzcygiRW1iZXIuU3RhdGVNYW5hZ2VyIik7CgovKioKICBUaGlzIHdhcyBleHBvcnRlZCB0byBlbWJlci1zdGF0ZXMgcGx1Z2luIGZvciB2IDEuMC4wIHJlbGVhc2UuIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL2VtYmVyanMvZW1iZXItc3RhdGVzCiAgCiAgQGNsYXNzIFN0YXRlTWFuYWdlcgogIEBuYW1lc3BhY2UgRW1iZXIKKi8KCkVtYmVyLlN0YXRlID0gZ2VuZXJhdGVSZW1vdmVkQ2xhc3MoIkVtYmVyLlN0YXRlIik7CgovKioKICBUaGlzIHdhcyBleHBvcnRlZCB0byBlbWJlci1zdGF0ZXMgcGx1Z2luIGZvciB2IDEuMC4wIHJlbGVhc2UuIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL2VtYmVyanMvZW1iZXItc3RhdGVzCiAgCiAgQGNsYXNzIFN0YXRlCiAgQG5hbWVzcGFjZSBFbWJlcgoqLwoKfSkoKTsKCgp9KSgpOwo=</content>
    <filesize>1149896</filesize>
  </attachment>
  <attachment>
    <filename>handlebars-v1.2.1.js</filename>
    <author>XWiki.Admin</author>
    <date>1498975668000</date>
    <version>1.1</version>
    <comment/>
    <content>LyohCgogaGFuZGxlYmFycyB2MS4yLjEKCkNvcHlyaWdodCAoQykgMjAxMSBieSBZZWh1ZGEgS2F0egoKUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQpvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAppbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCnRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCmZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CgpUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgphbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KClRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCklNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLApGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgpMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLApPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOClRIRSBTT0ZUV0FSRS4KCkBsaWNlbnNlCiovCi8qIGV4cG9ydGVkIEhhbmRsZWJhcnMgKi8KdmFyIEhhbmRsZWJhcnMgPSAoZnVuY3Rpb24oKSB7Ci8vIGhhbmRsZWJhcnMvc2FmZS1zdHJpbmcuanMKdmFyIF9fbW9kdWxlNF9fID0gKGZ1bmN0aW9uKCkgewogICJ1c2Ugc3RyaWN0IjsKICB2YXIgX19leHBvcnRzX187CiAgLy8gQnVpbGQgb3V0IG91ciBiYXNpYyBTYWZlU3RyaW5nIHR5cGUKICBmdW5jdGlvbiBTYWZlU3RyaW5nKHN0cmluZykgewogICAgdGhpcy5zdHJpbmcgPSBzdHJpbmc7CiAgfQoKICBTYWZlU3RyaW5nLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuICIiICsgdGhpcy5zdHJpbmc7CiAgfTsKCiAgX19leHBvcnRzX18gPSBTYWZlU3RyaW5nOwogIHJldHVybiBfX2V4cG9ydHNfXzsKfSkoKTsKCi8vIGhhbmRsZWJhcnMvdXRpbHMuanMKdmFyIF9fbW9kdWxlM19fID0gKGZ1bmN0aW9uKF9fZGVwZW5kZW5jeTFfXykgewogICJ1c2Ugc3RyaWN0IjsKICB2YXIgX19leHBvcnRzX18gPSB7fTsKICAvKmpzaGludCAtVzAwNCAqLwogIHZhciBTYWZlU3RyaW5nID0gX19kZXBlbmRlbmN5MV9fOwoKICB2YXIgZXNjYXBlID0gewogICAgIiYiOiAiJmFtcDsiLAogICAgIjwiOiAiJmx0OyIsCiAgICAiPiI6ICImZ3Q7IiwKICAgICciJzogIiZxdW90OyIsCiAgICAiJyI6ICImI3gyNzsiLAogICAgImAiOiAiJiN4NjA7IgogIH07CgogIHZhciBiYWRDaGFycyA9IC9bJjw+IidgXS9nOwogIHZhciBwb3NzaWJsZSA9IC9bJjw+IidgXS87CgogIGZ1bmN0aW9uIGVzY2FwZUNoYXIoY2hyKSB7CiAgICByZXR1cm4gZXNjYXBlW2Nocl0gfHwgIiZhbXA7IjsKICB9CgogIGZ1bmN0aW9uIGV4dGVuZChvYmosIHZhbHVlKSB7CiAgICBmb3IodmFyIGtleSBpbiB2YWx1ZSkgewogICAgICBpZihPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodmFsdWUsIGtleSkpIHsKICAgICAgICBvYmpba2V5XSA9IHZhbHVlW2tleV07CiAgICAgIH0KICAgIH0KICB9CgogIF9fZXhwb3J0c19fLmV4dGVuZCA9IGV4dGVuZDt2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwogIF9fZXhwb3J0c19fLnRvU3RyaW5nID0gdG9TdHJpbmc7CiAgLy8gU291cmNlZCBmcm9tIGxvZGFzaAogIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9iZXN0aWVqcy9sb2Rhc2gvYmxvYi9tYXN0ZXIvTElDRU5TRS50eHQKICB2YXIgaXNGdW5jdGlvbiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnZnVuY3Rpb24nOwogIH07CiAgLy8gZmFsbGJhY2sgZm9yIG9sZGVyIHZlcnNpb25zIG9mIENocm9tZSBhbmQgU2FmYXJpCiAgaWYgKGlzRnVuY3Rpb24oL3gvKSkgewogICAgaXNGdW5jdGlvbiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicgJiYgdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT09ICdbb2JqZWN0IEZ1bmN0aW9uXSc7CiAgICB9OwogIH0KICB2YXIgaXNGdW5jdGlvbjsKICBfX2V4cG9ydHNfXy5pc0Z1bmN0aW9uID0gaXNGdW5jdGlvbjsKICB2YXIgaXNBcnJheSA9IEFycmF5LmlzQXJyYXkgfHwgZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JykgPyB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PT0gJ1tvYmplY3QgQXJyYXldJyA6IGZhbHNlOwogIH07CiAgX19leHBvcnRzX18uaXNBcnJheSA9IGlzQXJyYXk7CgogIGZ1bmN0aW9uIGVzY2FwZUV4cHJlc3Npb24oc3RyaW5nKSB7CiAgICAvLyBkb24ndCBlc2NhcGUgU2FmZVN0cmluZ3MsIHNpbmNlIHRoZXkncmUgYWxyZWFkeSBzYWZlCiAgICBpZiAoc3RyaW5nIGluc3RhbmNlb2YgU2FmZVN0cmluZykgewogICAgICByZXR1cm4gc3RyaW5nLnRvU3RyaW5nKCk7CiAgICB9IGVsc2UgaWYgKCFzdHJpbmcgJiYgc3RyaW5nICE9PSAwKSB7CiAgICAgIHJldHVybiAiIjsKICAgIH0KCiAgICAvLyBGb3JjZSBhIHN0cmluZyBjb252ZXJzaW9uIGFzIHRoaXMgd2lsbCBiZSBkb25lIGJ5IHRoZSBhcHBlbmQgcmVnYXJkbGVzcyBhbmQKICAgIC8vIHRoZSByZWdleCB0ZXN0IHdpbGwgZG8gdGhpcyB0cmFuc3BhcmVudGx5IGJlaGluZCB0aGUgc2NlbmVzLCBjYXVzaW5nIGlzc3VlcyBpZgogICAgLy8gYW4gb2JqZWN0J3MgdG8gc3RyaW5nIGhhcyBlc2NhcGVkIGNoYXJhY3RlcnMgaW4gaXQuCiAgICBzdHJpbmcgPSAiIiArIHN0cmluZzsKCiAgICBpZighcG9zc2libGUudGVzdChzdHJpbmcpKSB7IHJldHVybiBzdHJpbmc7IH0KICAgIHJldHVybiBzdHJpbmcucmVwbGFjZShiYWRDaGFycywgZXNjYXBlQ2hhcik7CiAgfQoKICBfX2V4cG9ydHNfXy5lc2NhcGVFeHByZXNzaW9uID0gZXNjYXBlRXhwcmVzc2lvbjtmdW5jdGlvbiBpc0VtcHR5KHZhbHVlKSB7CiAgICBpZiAoIXZhbHVlICYmIHZhbHVlICE9PSAwKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIGlmIChpc0FycmF5KHZhbHVlKSAmJiB2YWx1ZS5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQoKICBfX2V4cG9ydHNfXy5pc0VtcHR5ID0gaXNFbXB0eTsKICByZXR1cm4gX19leHBvcnRzX187Cn0pKF9fbW9kdWxlNF9fKTsKCi8vIGhhbmRsZWJhcnMvZXhjZXB0aW9uLmpzCnZhciBfX21vZHVsZTVfXyA9IChmdW5jdGlvbigpIHsKICAidXNlIHN0cmljdCI7CiAgdmFyIF9fZXhwb3J0c19fOwoKICB2YXIgZXJyb3JQcm9wcyA9IFsnZGVzY3JpcHRpb24nLCAnZmlsZU5hbWUnLCAnbGluZU51bWJlcicsICdtZXNzYWdlJywgJ25hbWUnLCAnbnVtYmVyJywgJ3N0YWNrJ107CgogIGZ1bmN0aW9uIEV4Y2VwdGlvbigvKiBtZXNzYWdlICovKSB7CiAgICB2YXIgdG1wID0gRXJyb3IucHJvdG90eXBlLmNvbnN0cnVjdG9yLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgLy8gVW5mb3J0dW5hdGVseSBlcnJvcnMgYXJlIG5vdCBlbnVtZXJhYmxlIGluIENocm9tZSAoYXQgbGVhc3QpLCBzbyBgZm9yIHByb3AgaW4gdG1wYCBkb2Vzbid0IHdvcmsuCiAgICBmb3IgKHZhciBpZHggPSAwOyBpZHggPCBlcnJvclByb3BzLmxlbmd0aDsgaWR4KyspIHsKICAgICAgdGhpc1tlcnJvclByb3BzW2lkeF1dID0gdG1wW2Vycm9yUHJvcHNbaWR4XV07CiAgICB9CiAgfQoKICBFeGNlcHRpb24ucHJvdG90eXBlID0gbmV3IEVycm9yKCk7CgogIF9fZXhwb3J0c19fID0gRXhjZXB0aW9uOwogIHJldHVybiBfX2V4cG9ydHNfXzsKfSkoKTsKCi8vIGhhbmRsZWJhcnMvYmFzZS5qcwp2YXIgX19tb2R1bGUyX18gPSAoZnVuY3Rpb24oX19kZXBlbmRlbmN5MV9fLCBfX2RlcGVuZGVuY3kyX18pIHsKICAidXNlIHN0cmljdCI7CiAgdmFyIF9fZXhwb3J0c19fID0ge307CiAgdmFyIFV0aWxzID0gX19kZXBlbmRlbmN5MV9fOwogIHZhciBFeGNlcHRpb24gPSBfX2RlcGVuZGVuY3kyX187CgogIHZhciBWRVJTSU9OID0gIjEuMi4xIjsKICBfX2V4cG9ydHNfXy5WRVJTSU9OID0gVkVSU0lPTjt2YXIgQ09NUElMRVJfUkVWSVNJT04gPSA0OwogIF9fZXhwb3J0c19fLkNPTVBJTEVSX1JFVklTSU9OID0gQ09NUElMRVJfUkVWSVNJT047CiAgdmFyIFJFVklTSU9OX0NIQU5HRVMgPSB7CiAgICAxOiAnPD0gMS4wLnJjLjInLCAvLyAxLjAucmMuMiBpcyBhY3R1YWxseSByZXYyIGJ1dCBkb2Vzbid0IHJlcG9ydCBpdAogICAgMjogJz09IDEuMC4wLXJjLjMnLAogICAgMzogJz09IDEuMC4wLXJjLjQnLAogICAgNDogJz49IDEuMC4wJwogIH07CiAgX19leHBvcnRzX18uUkVWSVNJT05fQ0hBTkdFUyA9IFJFVklTSU9OX0NIQU5HRVM7CiAgdmFyIGlzQXJyYXkgPSBVdGlscy5pc0FycmF5LAogICAgICBpc0Z1bmN0aW9uID0gVXRpbHMuaXNGdW5jdGlvbiwKICAgICAgdG9TdHJpbmcgPSBVdGlscy50b1N0cmluZywKICAgICAgb2JqZWN0VHlwZSA9ICdbb2JqZWN0IE9iamVjdF0nOwoKICBmdW5jdGlvbiBIYW5kbGViYXJzRW52aXJvbm1lbnQoaGVscGVycywgcGFydGlhbHMpIHsKICAgIHRoaXMuaGVscGVycyA9IGhlbHBlcnMgfHwge307CiAgICB0aGlzLnBhcnRpYWxzID0gcGFydGlhbHMgfHwge307CgogICAgcmVnaXN0ZXJEZWZhdWx0SGVscGVycyh0aGlzKTsKICB9CgogIF9fZXhwb3J0c19fLkhhbmRsZWJhcnNFbnZpcm9ubWVudCA9IEhhbmRsZWJhcnNFbnZpcm9ubWVudDtIYW5kbGViYXJzRW52aXJvbm1lbnQucHJvdG90eXBlID0gewogICAgY29uc3RydWN0b3I6IEhhbmRsZWJhcnNFbnZpcm9ubWVudCwKCiAgICBsb2dnZXI6IGxvZ2dlciwKICAgIGxvZzogbG9nLAoKICAgIHJlZ2lzdGVySGVscGVyOiBmdW5jdGlvbihuYW1lLCBmbiwgaW52ZXJzZSkgewogICAgICBpZiAodG9TdHJpbmcuY2FsbChuYW1lKSA9PT0gb2JqZWN0VHlwZSkgewogICAgICAgIGlmIChpbnZlcnNlIHx8IGZuKSB7IHRocm93IG5ldyBFeGNlcHRpb24oJ0FyZyBub3Qgc3VwcG9ydGVkIHdpdGggbXVsdGlwbGUgaGVscGVycycpOyB9CiAgICAgICAgVXRpbHMuZXh0ZW5kKHRoaXMuaGVscGVycywgbmFtZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGludmVyc2UpIHsgZm4ubm90ID0gaW52ZXJzZTsgfQogICAgICAgIHRoaXMuaGVscGVyc1tuYW1lXSA9IGZuOwogICAgICB9CiAgICB9LAoKICAgIHJlZ2lzdGVyUGFydGlhbDogZnVuY3Rpb24obmFtZSwgc3RyKSB7CiAgICAgIGlmICh0b1N0cmluZy5jYWxsKG5hbWUpID09PSBvYmplY3RUeXBlKSB7CiAgICAgICAgVXRpbHMuZXh0ZW5kKHRoaXMucGFydGlhbHMsICBuYW1lKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnBhcnRpYWxzW25hbWVdID0gc3RyOwogICAgICB9CiAgICB9CiAgfTsKCiAgZnVuY3Rpb24gcmVnaXN0ZXJEZWZhdWx0SGVscGVycyhpbnN0YW5jZSkgewogICAgaW5zdGFuY2UucmVnaXN0ZXJIZWxwZXIoJ2hlbHBlck1pc3NpbmcnLCBmdW5jdGlvbihhcmcpIHsKICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikgewogICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJNaXNzaW5nIGhlbHBlcjogJyIgKyBhcmcgKyAiJyIpOwogICAgICB9CiAgICB9KTsKCiAgICBpbnN0YW5jZS5yZWdpc3RlckhlbHBlcignYmxvY2tIZWxwZXJNaXNzaW5nJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogICAgICB2YXIgaW52ZXJzZSA9IG9wdGlvbnMuaW52ZXJzZSB8fCBmdW5jdGlvbigpIHt9LCBmbiA9IG9wdGlvbnMuZm47CgogICAgICBpZiAoaXNGdW5jdGlvbihjb250ZXh0KSkgeyBjb250ZXh0ID0gY29udGV4dC5jYWxsKHRoaXMpOyB9CgogICAgICBpZihjb250ZXh0ID09PSB0cnVlKSB7CiAgICAgICAgcmV0dXJuIGZuKHRoaXMpOwogICAgICB9IGVsc2UgaWYoY29udGV4dCA9PT0gZmFsc2UgfHwgY29udGV4dCA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGludmVyc2UodGhpcyk7CiAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShjb250ZXh0KSkgewogICAgICAgIGlmKGNvbnRleHQubGVuZ3RoID4gMCkgewogICAgICAgICAgcmV0dXJuIGluc3RhbmNlLmhlbHBlcnMuZWFjaChjb250ZXh0LCBvcHRpb25zKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGludmVyc2UodGhpcyk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmbihjb250ZXh0KTsKICAgICAgfQogICAgfSk7CgogICAgaW5zdGFuY2UucmVnaXN0ZXJIZWxwZXIoJ2VhY2gnLCBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgICAgIHZhciBmbiA9IG9wdGlvbnMuZm4sIGludmVyc2UgPSBvcHRpb25zLmludmVyc2U7CiAgICAgIHZhciBpID0gMCwgcmV0ID0gIiIsIGRhdGE7CgogICAgICBpZiAoaXNGdW5jdGlvbihjb250ZXh0KSkgeyBjb250ZXh0ID0gY29udGV4dC5jYWxsKHRoaXMpOyB9CgogICAgICBpZiAob3B0aW9ucy5kYXRhKSB7CiAgICAgICAgZGF0YSA9IGNyZWF0ZUZyYW1lKG9wdGlvbnMuZGF0YSk7CiAgICAgIH0KCiAgICAgIGlmKGNvbnRleHQgJiYgdHlwZW9mIGNvbnRleHQgPT09ICdvYmplY3QnKSB7CiAgICAgICAgaWYgKGlzQXJyYXkoY29udGV4dCkpIHsKICAgICAgICAgIGZvcih2YXIgaiA9IGNvbnRleHQubGVuZ3RoOyBpPGo7IGkrKykgewogICAgICAgICAgICBpZiAoZGF0YSkgewogICAgICAgICAgICAgIGRhdGEuaW5kZXggPSBpOwogICAgICAgICAgICAgIGRhdGEuZmlyc3QgPSAoaSA9PT0gMCk7CiAgICAgICAgICAgICAgZGF0YS5sYXN0ICA9IChpID09PSAoY29udGV4dC5sZW5ndGgtMSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldCA9IHJldCArIGZuKGNvbnRleHRbaV0sIHsgZGF0YTogZGF0YSB9KTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yKHZhciBrZXkgaW4gY29udGV4dCkgewogICAgICAgICAgICBpZihjb250ZXh0Lmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICBpZihkYXRhKSB7IAogICAgICAgICAgICAgICAgZGF0YS5rZXkgPSBrZXk7IAogICAgICAgICAgICAgICAgZGF0YS5pbmRleCA9IGk7CiAgICAgICAgICAgICAgICBkYXRhLmZpcnN0ID0gKGkgPT09IDApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXQgPSByZXQgKyBmbihjb250ZXh0W2tleV0sIHtkYXRhOiBkYXRhfSk7CiAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZihpID09PSAwKXsKICAgICAgICByZXQgPSBpbnZlcnNlKHRoaXMpOwogICAgICB9CgogICAgICByZXR1cm4gcmV0OwogICAgfSk7CgogICAgaW5zdGFuY2UucmVnaXN0ZXJIZWxwZXIoJ2lmJywgZnVuY3Rpb24oY29uZGl0aW9uYWwsIG9wdGlvbnMpIHsKICAgICAgaWYgKGlzRnVuY3Rpb24oY29uZGl0aW9uYWwpKSB7IGNvbmRpdGlvbmFsID0gY29uZGl0aW9uYWwuY2FsbCh0aGlzKTsgfQoKICAgICAgLy8gRGVmYXVsdCBiZWhhdmlvciBpcyB0byByZW5kZXIgdGhlIHBvc2l0aXZlIHBhdGggaWYgdGhlIHZhbHVlIGlzIHRydXRoeSBhbmQgbm90IGVtcHR5LgogICAgICAvLyBUaGUgYGluY2x1ZGVaZXJvYCBvcHRpb24gbWF5IGJlIHNldCB0byB0cmVhdCB0aGUgY29uZHRpb25hbCBhcyBwdXJlbHkgbm90IGVtcHR5IGJhc2VkIG9uIHRoZQogICAgICAvLyBiZWhhdmlvciBvZiBpc0VtcHR5LiBFZmZlY3RpdmVseSB0aGlzIGRldGVybWluZXMgaWYgMCBpcyBoYW5kbGVkIGJ5IHRoZSBwb3NpdGl2ZSBwYXRoIG9yIG5lZ2F0aXZlLgogICAgICBpZiAoKCFvcHRpb25zLmhhc2guaW5jbHVkZVplcm8gJiYgIWNvbmRpdGlvbmFsKSB8fCBVdGlscy5pc0VtcHR5KGNvbmRpdGlvbmFsKSkgewogICAgICAgIHJldHVybiBvcHRpb25zLmludmVyc2UodGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIG9wdGlvbnMuZm4odGhpcyk7CiAgICAgIH0KICAgIH0pOwoKICAgIGluc3RhbmNlLnJlZ2lzdGVySGVscGVyKCd1bmxlc3MnLCBmdW5jdGlvbihjb25kaXRpb25hbCwgb3B0aW9ucykgewogICAgICByZXR1cm4gaW5zdGFuY2UuaGVscGVyc1snaWYnXS5jYWxsKHRoaXMsIGNvbmRpdGlvbmFsLCB7Zm46IG9wdGlvbnMuaW52ZXJzZSwgaW52ZXJzZTogb3B0aW9ucy5mbiwgaGFzaDogb3B0aW9ucy5oYXNofSk7CiAgICB9KTsKCiAgICBpbnN0YW5jZS5yZWdpc3RlckhlbHBlcignd2l0aCcsIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICAgICAgaWYgKGlzRnVuY3Rpb24oY29udGV4dCkpIHsgY29udGV4dCA9IGNvbnRleHQuY2FsbCh0aGlzKTsgfQoKICAgICAgaWYgKCFVdGlscy5pc0VtcHR5KGNvbnRleHQpKSByZXR1cm4gb3B0aW9ucy5mbihjb250ZXh0KTsKICAgIH0pOwoKICAgIGluc3RhbmNlLnJlZ2lzdGVySGVscGVyKCdsb2cnLCBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgICAgIHZhciBsZXZlbCA9IG9wdGlvbnMuZGF0YSAmJiBvcHRpb25zLmRhdGEubGV2ZWwgIT0gbnVsbCA/IHBhcnNlSW50KG9wdGlvbnMuZGF0YS5sZXZlbCwgMTApIDogMTsKICAgICAgaW5zdGFuY2UubG9nKGxldmVsLCBjb250ZXh0KTsKICAgIH0pOwogIH0KCiAgdmFyIGxvZ2dlciA9IHsKICAgIG1ldGhvZE1hcDogeyAwOiAnZGVidWcnLCAxOiAnaW5mbycsIDI6ICd3YXJuJywgMzogJ2Vycm9yJyB9LAoKICAgIC8vIFN0YXRlIGVudW0KICAgIERFQlVHOiAwLAogICAgSU5GTzogMSwKICAgIFdBUk46IDIsCiAgICBFUlJPUjogMywKICAgIGxldmVsOiAzLAoKICAgIC8vIGNhbiBiZSBvdmVycmlkZGVuIGluIHRoZSBob3N0IGVudmlyb25tZW50CiAgICBsb2c6IGZ1bmN0aW9uKGxldmVsLCBvYmopIHsKICAgICAgaWYgKGxvZ2dlci5sZXZlbCA8PSBsZXZlbCkgewogICAgICAgIHZhciBtZXRob2QgPSBsb2dnZXIubWV0aG9kTWFwW2xldmVsXTsKICAgICAgICBpZiAodHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnICYmIGNvbnNvbGVbbWV0aG9kXSkgewogICAgICAgICAgY29uc29sZVttZXRob2RdLmNhbGwoY29uc29sZSwgb2JqKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwogIF9fZXhwb3J0c19fLmxvZ2dlciA9IGxvZ2dlcjsKICBmdW5jdGlvbiBsb2cobGV2ZWwsIG9iaikgeyBsb2dnZXIubG9nKGxldmVsLCBvYmopOyB9CgogIF9fZXhwb3J0c19fLmxvZyA9IGxvZzt2YXIgY3JlYXRlRnJhbWUgPSBmdW5jdGlvbihvYmplY3QpIHsKICAgIHZhciBvYmogPSB7fTsKICAgIFV0aWxzLmV4dGVuZChvYmosIG9iamVjdCk7CiAgICByZXR1cm4gb2JqOwogIH07CiAgX19leHBvcnRzX18uY3JlYXRlRnJhbWUgPSBjcmVhdGVGcmFtZTsKICByZXR1cm4gX19leHBvcnRzX187Cn0pKF9fbW9kdWxlM19fLCBfX21vZHVsZTVfXyk7CgovLyBoYW5kbGViYXJzL3J1bnRpbWUuanMKdmFyIF9fbW9kdWxlNl9fID0gKGZ1bmN0aW9uKF9fZGVwZW5kZW5jeTFfXywgX19kZXBlbmRlbmN5Ml9fLCBfX2RlcGVuZGVuY3kzX18pIHsKICAidXNlIHN0cmljdCI7CiAgdmFyIF9fZXhwb3J0c19fID0ge307CiAgdmFyIFV0aWxzID0gX19kZXBlbmRlbmN5MV9fOwogIHZhciBFeGNlcHRpb24gPSBfX2RlcGVuZGVuY3kyX187CiAgdmFyIENPTVBJTEVSX1JFVklTSU9OID0gX19kZXBlbmRlbmN5M19fLkNPTVBJTEVSX1JFVklTSU9OOwogIHZhciBSRVZJU0lPTl9DSEFOR0VTID0gX19kZXBlbmRlbmN5M19fLlJFVklTSU9OX0NIQU5HRVM7CgogIGZ1bmN0aW9uIGNoZWNrUmV2aXNpb24oY29tcGlsZXJJbmZvKSB7CiAgICB2YXIgY29tcGlsZXJSZXZpc2lvbiA9IGNvbXBpbGVySW5mbyAmJiBjb21waWxlckluZm9bMF0gfHwgMSwKICAgICAgICBjdXJyZW50UmV2aXNpb24gPSBDT01QSUxFUl9SRVZJU0lPTjsKCiAgICBpZiAoY29tcGlsZXJSZXZpc2lvbiAhPT0gY3VycmVudFJldmlzaW9uKSB7CiAgICAgIGlmIChjb21waWxlclJldmlzaW9uIDwgY3VycmVudFJldmlzaW9uKSB7CiAgICAgICAgdmFyIHJ1bnRpbWVWZXJzaW9ucyA9IFJFVklTSU9OX0NIQU5HRVNbY3VycmVudFJldmlzaW9uXSwKICAgICAgICAgICAgY29tcGlsZXJWZXJzaW9ucyA9IFJFVklTSU9OX0NIQU5HRVNbY29tcGlsZXJSZXZpc2lvbl07CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUZW1wbGF0ZSB3YXMgcHJlY29tcGlsZWQgd2l0aCBhbiBvbGRlciB2ZXJzaW9uIG9mIEhhbmRsZWJhcnMgdGhhbiB0aGUgY3VycmVudCBydW50aW1lLiAiKwogICAgICAgICAgICAgICJQbGVhc2UgdXBkYXRlIHlvdXIgcHJlY29tcGlsZXIgdG8gYSBuZXdlciB2ZXJzaW9uICgiK3J1bnRpbWVWZXJzaW9ucysiKSBvciBkb3duZ3JhZGUgeW91ciBydW50aW1lIHRvIGFuIG9sZGVyIHZlcnNpb24gKCIrY29tcGlsZXJWZXJzaW9ucysiKS4iKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBVc2UgdGhlIGVtYmVkZGVkIHZlcnNpb24gaW5mbyBzaW5jZSB0aGUgcnVudGltZSBkb2Vzbid0IGtub3cgYWJvdXQgdGhpcyByZXZpc2lvbiB5ZXQKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRlbXBsYXRlIHdhcyBwcmVjb21waWxlZCB3aXRoIGEgbmV3ZXIgdmVyc2lvbiBvZiBIYW5kbGViYXJzIHRoYW4gdGhlIGN1cnJlbnQgcnVudGltZS4gIisKICAgICAgICAgICAgICAiUGxlYXNlIHVwZGF0ZSB5b3VyIHJ1bnRpbWUgdG8gYSBuZXdlciB2ZXJzaW9uICgiK2NvbXBpbGVySW5mb1sxXSsiKS4iKTsKICAgICAgfQogICAgfQogIH0KCiAgX19leHBvcnRzX18uY2hlY2tSZXZpc2lvbiA9IGNoZWNrUmV2aXNpb247Ly8gVE9ETzogUmVtb3ZlIHRoaXMgbGluZSBhbmQgYnJlYWsgdXAgY29tcGlsZVBhcnRpYWwKCiAgZnVuY3Rpb24gdGVtcGxhdGUodGVtcGxhdGVTcGVjLCBlbnYpIHsKICAgIGlmICghZW52KSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiTm8gZW52aXJvbm1lbnQgcGFzc2VkIHRvIHRlbXBsYXRlIik7CiAgICB9CgogICAgLy8gTm90ZTogVXNpbmcgZW52LlZNIHJlZmVyZW5jZXMgcmF0aGVyIHRoYW4gbG9jYWwgdmFyIHJlZmVyZW5jZXMgdGhyb3VnaG91dCB0aGlzIHNlY3Rpb24gdG8gYWxsb3cKICAgIC8vIGZvciBleHRlcm5hbCB1c2VycyB0byBvdmVycmlkZSB0aGVzZSBhcyBwc3VlZG8tc3VwcG9ydGVkIEFQSXMuCiAgICB2YXIgaW52b2tlUGFydGlhbFdyYXBwZXIgPSBmdW5jdGlvbihwYXJ0aWFsLCBuYW1lLCBjb250ZXh0LCBoZWxwZXJzLCBwYXJ0aWFscywgZGF0YSkgewogICAgICB2YXIgcmVzdWx0ID0gZW52LlZNLmludm9rZVBhcnRpYWwuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgaWYgKHJlc3VsdCAhPSBudWxsKSB7IHJldHVybiByZXN1bHQ7IH0KCiAgICAgIGlmIChlbnYuY29tcGlsZSkgewogICAgICAgIHZhciBvcHRpb25zID0geyBoZWxwZXJzOiBoZWxwZXJzLCBwYXJ0aWFsczogcGFydGlhbHMsIGRhdGE6IGRhdGEgfTsKICAgICAgICBwYXJ0aWFsc1tuYW1lXSA9IGVudi5jb21waWxlKHBhcnRpYWwsIHsgZGF0YTogZGF0YSAhPT0gdW5kZWZpbmVkIH0sIGVudik7CiAgICAgICAgcmV0dXJuIHBhcnRpYWxzW25hbWVdKGNvbnRleHQsIG9wdGlvbnMpOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFeGNlcHRpb24oIlRoZSBwYXJ0aWFsICIgKyBuYW1lICsgIiBjb3VsZCBub3QgYmUgY29tcGlsZWQgd2hlbiBydW5uaW5nIGluIHJ1bnRpbWUtb25seSBtb2RlIik7CiAgICAgIH0KICAgIH07CgogICAgLy8gSnVzdCBhZGQgd2F0ZXIKICAgIHZhciBjb250YWluZXIgPSB7CiAgICAgIGVzY2FwZUV4cHJlc3Npb246IFV0aWxzLmVzY2FwZUV4cHJlc3Npb24sCiAgICAgIGludm9rZVBhcnRpYWw6IGludm9rZVBhcnRpYWxXcmFwcGVyLAogICAgICBwcm9ncmFtczogW10sCiAgICAgIHByb2dyYW06IGZ1bmN0aW9uKGksIGZuLCBkYXRhKSB7CiAgICAgICAgdmFyIHByb2dyYW1XcmFwcGVyID0gdGhpcy5wcm9ncmFtc1tpXTsKICAgICAgICBpZihkYXRhKSB7CiAgICAgICAgICBwcm9ncmFtV3JhcHBlciA9IHByb2dyYW0oaSwgZm4sIGRhdGEpOwogICAgICAgIH0gZWxzZSBpZiAoIXByb2dyYW1XcmFwcGVyKSB7CiAgICAgICAgICBwcm9ncmFtV3JhcHBlciA9IHRoaXMucHJvZ3JhbXNbaV0gPSBwcm9ncmFtKGksIGZuKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHByb2dyYW1XcmFwcGVyOwogICAgICB9LAogICAgICBtZXJnZTogZnVuY3Rpb24ocGFyYW0sIGNvbW1vbikgewogICAgICAgIHZhciByZXQgPSBwYXJhbSB8fCBjb21tb247CgogICAgICAgIGlmIChwYXJhbSAmJiBjb21tb24gJiYgKHBhcmFtICE9PSBjb21tb24pKSB7CiAgICAgICAgICByZXQgPSB7fTsKICAgICAgICAgIFV0aWxzLmV4dGVuZChyZXQsIGNvbW1vbik7CiAgICAgICAgICBVdGlscy5leHRlbmQocmV0LCBwYXJhbSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXQ7CiAgICAgIH0sCiAgICAgIHByb2dyYW1XaXRoRGVwdGg6IGVudi5WTS5wcm9ncmFtV2l0aERlcHRoLAogICAgICBub29wOiBlbnYuVk0ubm9vcCwKICAgICAgY29tcGlsZXJJbmZvOiBudWxsCiAgICB9OwoKICAgIHJldHVybiBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICB2YXIgbmFtZXNwYWNlID0gb3B0aW9ucy5wYXJ0aWFsID8gb3B0aW9ucyA6IGVudiwKICAgICAgICAgIGhlbHBlcnMsCiAgICAgICAgICBwYXJ0aWFsczsKCiAgICAgIGlmICghb3B0aW9ucy5wYXJ0aWFsKSB7CiAgICAgICAgaGVscGVycyA9IG9wdGlvbnMuaGVscGVyczsKICAgICAgICBwYXJ0aWFscyA9IG9wdGlvbnMucGFydGlhbHM7CiAgICAgIH0KICAgICAgdmFyIHJlc3VsdCA9IHRlbXBsYXRlU3BlYy5jYWxsKAogICAgICAgICAgICBjb250YWluZXIsCiAgICAgICAgICAgIG5hbWVzcGFjZSwgY29udGV4dCwKICAgICAgICAgICAgaGVscGVycywKICAgICAgICAgICAgcGFydGlhbHMsCiAgICAgICAgICAgIG9wdGlvbnMuZGF0YSk7CgogICAgICBpZiAoIW9wdGlvbnMucGFydGlhbCkgewogICAgICAgIGVudi5WTS5jaGVja1JldmlzaW9uKGNvbnRhaW5lci5jb21waWxlckluZm8pOwogICAgICB9CgogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9CgogIF9fZXhwb3J0c19fLnRlbXBsYXRlID0gdGVtcGxhdGU7ZnVuY3Rpb24gcHJvZ3JhbVdpdGhEZXB0aChpLCBmbiwgZGF0YSAvKiwgJGRlcHRoICovKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMyk7CgogICAgdmFyIHByb2cgPSBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIFtjb250ZXh0LCBvcHRpb25zLmRhdGEgfHwgZGF0YV0uY29uY2F0KGFyZ3MpKTsKICAgIH07CiAgICBwcm9nLnByb2dyYW0gPSBpOwogICAgcHJvZy5kZXB0aCA9IGFyZ3MubGVuZ3RoOwogICAgcmV0dXJuIHByb2c7CiAgfQoKICBfX2V4cG9ydHNfXy5wcm9ncmFtV2l0aERlcHRoID0gcHJvZ3JhbVdpdGhEZXB0aDtmdW5jdGlvbiBwcm9ncmFtKGksIGZuLCBkYXRhKSB7CiAgICB2YXIgcHJvZyA9IGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgICByZXR1cm4gZm4oY29udGV4dCwgb3B0aW9ucy5kYXRhIHx8IGRhdGEpOwogICAgfTsKICAgIHByb2cucHJvZ3JhbSA9IGk7CiAgICBwcm9nLmRlcHRoID0gMDsKICAgIHJldHVybiBwcm9nOwogIH0KCiAgX19leHBvcnRzX18ucHJvZ3JhbSA9IHByb2dyYW07ZnVuY3Rpb24gaW52b2tlUGFydGlhbChwYXJ0aWFsLCBuYW1lLCBjb250ZXh0LCBoZWxwZXJzLCBwYXJ0aWFscywgZGF0YSkgewogICAgdmFyIG9wdGlvbnMgPSB7IHBhcnRpYWw6IHRydWUsIGhlbHBlcnM6IGhlbHBlcnMsIHBhcnRpYWxzOiBwYXJ0aWFscywgZGF0YTogZGF0YSB9OwoKICAgIGlmKHBhcnRpYWwgPT09IHVuZGVmaW5lZCkgewogICAgICB0aHJvdyBuZXcgRXhjZXB0aW9uKCJUaGUgcGFydGlhbCAiICsgbmFtZSArICIgY291bGQgbm90IGJlIGZvdW5kIik7CiAgICB9IGVsc2UgaWYocGFydGlhbCBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7CiAgICAgIHJldHVybiBwYXJ0aWFsKGNvbnRleHQsIG9wdGlvbnMpOwogICAgfQogIH0KCiAgX19leHBvcnRzX18uaW52b2tlUGFydGlhbCA9IGludm9rZVBhcnRpYWw7ZnVuY3Rpb24gbm9vcCgpIHsgcmV0dXJuICIiOyB9CgogIF9fZXhwb3J0c19fLm5vb3AgPSBub29wOwogIHJldHVybiBfX2V4cG9ydHNfXzsKfSkoX19tb2R1bGUzX18sIF9fbW9kdWxlNV9fLCBfX21vZHVsZTJfXyk7CgovLyBoYW5kbGViYXJzLnJ1bnRpbWUuanMKdmFyIF9fbW9kdWxlMV9fID0gKGZ1bmN0aW9uKF9fZGVwZW5kZW5jeTFfXywgX19kZXBlbmRlbmN5Ml9fLCBfX2RlcGVuZGVuY3kzX18sIF9fZGVwZW5kZW5jeTRfXywgX19kZXBlbmRlbmN5NV9fKSB7CiAgInVzZSBzdHJpY3QiOwogIHZhciBfX2V4cG9ydHNfXzsKICAvKmdsb2JhbHMgSGFuZGxlYmFyczogdHJ1ZSAqLwogIHZhciBiYXNlID0gX19kZXBlbmRlbmN5MV9fOwoKICAvLyBFYWNoIG9mIHRoZXNlIGF1Z21lbnQgdGhlIEhhbmRsZWJhcnMgb2JqZWN0LiBObyBuZWVkIHRvIHNldHVwIGhlcmUuCiAgLy8gKFRoaXMgaXMgZG9uZSB0byBlYXNpbHkgc2hhcmUgY29kZSBiZXR3ZWVuIGNvbW1vbmpzIGFuZCBicm93c2UgZW52cykKICB2YXIgU2FmZVN0cmluZyA9IF9fZGVwZW5kZW5jeTJfXzsKICB2YXIgRXhjZXB0aW9uID0gX19kZXBlbmRlbmN5M19fOwogIHZhciBVdGlscyA9IF9fZGVwZW5kZW5jeTRfXzsKICB2YXIgcnVudGltZSA9IF9fZGVwZW5kZW5jeTVfXzsKCiAgLy8gRm9yIGNvbXBhdGliaWxpdHkgYW5kIHVzYWdlIG91dHNpZGUgb2YgbW9kdWxlIHN5c3RlbXMsIG1ha2UgdGhlIEhhbmRsZWJhcnMgb2JqZWN0IGEgbmFtZXNwYWNlCiAgdmFyIGNyZWF0ZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGhiID0gbmV3IGJhc2UuSGFuZGxlYmFyc0Vudmlyb25tZW50KCk7CgogICAgVXRpbHMuZXh0ZW5kKGhiLCBiYXNlKTsKICAgIGhiLlNhZmVTdHJpbmcgPSBTYWZlU3RyaW5nOwogICAgaGIuRXhjZXB0aW9uID0gRXhjZXB0aW9uOwogICAgaGIuVXRpbHMgPSBVdGlsczsKCiAgICBoYi5WTSA9IHJ1bnRpbWU7CiAgICBoYi50ZW1wbGF0ZSA9IGZ1bmN0aW9uKHNwZWMpIHsKICAgICAgcmV0dXJuIHJ1bnRpbWUudGVtcGxhdGUoc3BlYywgaGIpOwogICAgfTsKCiAgICByZXR1cm4gaGI7CiAgfTsKCiAgdmFyIEhhbmRsZWJhcnMgPSBjcmVhdGUoKTsKICBIYW5kbGViYXJzLmNyZWF0ZSA9IGNyZWF0ZTsKCiAgX19leHBvcnRzX18gPSBIYW5kbGViYXJzOwogIHJldHVybiBfX2V4cG9ydHNfXzsKfSkoX19tb2R1bGUyX18sIF9fbW9kdWxlNF9fLCBfX21vZHVsZTVfXywgX19tb2R1bGUzX18sIF9fbW9kdWxlNl9fKTsKCi8vIGhhbmRsZWJhcnMvY29tcGlsZXIvYXN0LmpzCnZhciBfX21vZHVsZTdfXyA9IChmdW5jdGlvbihfX2RlcGVuZGVuY3kxX18pIHsKICAidXNlIHN0cmljdCI7CiAgdmFyIF9fZXhwb3J0c19fOwogIHZhciBFeGNlcHRpb24gPSBfX2RlcGVuZGVuY3kxX187CgogIHZhciBBU1QgPSB7CiAgICBQcm9ncmFtTm9kZTogZnVuY3Rpb24oc3RhdGVtZW50cywgaW52ZXJzZVN0cmlwLCBpbnZlcnNlKSB7CiAgICAgIHRoaXMudHlwZSA9ICJwcm9ncmFtIjsKICAgICAgdGhpcy5zdGF0ZW1lbnRzID0gc3RhdGVtZW50czsKICAgICAgdGhpcy5zdHJpcCA9IHt9OwoKICAgICAgaWYoaW52ZXJzZSkgewogICAgICAgIHRoaXMuaW52ZXJzZSA9IG5ldyBBU1QuUHJvZ3JhbU5vZGUoaW52ZXJzZSwgaW52ZXJzZVN0cmlwKTsKICAgICAgICB0aGlzLnN0cmlwLnJpZ2h0ID0gaW52ZXJzZVN0cmlwLmxlZnQ7CiAgICAgIH0gZWxzZSBpZiAoaW52ZXJzZVN0cmlwKSB7CiAgICAgICAgdGhpcy5zdHJpcC5sZWZ0ID0gaW52ZXJzZVN0cmlwLnJpZ2h0OwogICAgICB9CiAgICB9LAoKICAgIE11c3RhY2hlTm9kZTogZnVuY3Rpb24ocmF3UGFyYW1zLCBoYXNoLCBvcGVuLCBzdHJpcCkgewogICAgICB0aGlzLnR5cGUgPSAibXVzdGFjaGUiOwogICAgICB0aGlzLmhhc2ggPSBoYXNoOwogICAgICB0aGlzLnN0cmlwID0gc3RyaXA7CgogICAgICAvLyBPcGVuIG1heSBiZSBhIHN0cmluZyBwYXJzZWQgZnJvbSB0aGUgcGFyc2VyIG9yIGEgcGFzc2VkIGJvb2xlYW4gZmxhZwogICAgICBpZiAob3BlbiAhPSBudWxsICYmIG9wZW4uY2hhckF0KSB7CiAgICAgICAgLy8gTXVzdCB1c2UgY2hhckF0IHRvIHN1cHBvcnQgSUUgcHJlLTEwCiAgICAgICAgdmFyIGVzY2FwZUZsYWcgPSBvcGVuLmNoYXJBdCgzKSB8fCBvcGVuLmNoYXJBdCgyKTsKICAgICAgICB0aGlzLmVzY2FwZWQgPSBlc2NhcGVGbGFnICE9PSAneycgJiYgZXNjYXBlRmxhZyAhPT0gJyYnOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuZXNjYXBlZCA9ICEhb3BlbjsKICAgICAgfQoKICAgICAgdmFyIGlkID0gdGhpcy5pZCA9IHJhd1BhcmFtc1swXTsKICAgICAgdmFyIHBhcmFtcyA9IHRoaXMucGFyYW1zID0gcmF3UGFyYW1zLnNsaWNlKDEpOwoKICAgICAgLy8gYSBtdXN0YWNoZSBpcyBhbiBlbGlnaWJsZSBoZWxwZXIgaWY6CiAgICAgIC8vICogaXRzIGlkIGlzIHNpbXBsZSAoYSBzaW5nbGUgcGFydCwgbm90IGB0aGlzYCBvciBgLi5gKQogICAgICB2YXIgZWxpZ2libGVIZWxwZXIgPSB0aGlzLmVsaWdpYmxlSGVscGVyID0gaWQuaXNTaW1wbGU7CgogICAgICAvLyBhIG11c3RhY2hlIGlzIGRlZmluaXRlbHkgYSBoZWxwZXIgaWY6CiAgICAgIC8vICogaXQgaXMgYW4gZWxpZ2libGUgaGVscGVyLCBhbmQKICAgICAgLy8gKiBpdCBoYXMgYXQgbGVhc3Qgb25lIHBhcmFtZXRlciBvciBoYXNoIHNlZ21lbnQKICAgICAgdGhpcy5pc0hlbHBlciA9IGVsaWdpYmxlSGVscGVyICYmIChwYXJhbXMubGVuZ3RoIHx8IGhhc2gpOwoKICAgICAgLy8gaWYgYSBtdXN0YWNoZSBpcyBhbiBlbGlnaWJsZSBoZWxwZXIgYnV0IG5vdCBhIGRlZmluaXRlCiAgICAgIC8vIGhlbHBlciwgaXQgaXMgYW1iaWd1b3VzLCBhbmQgd2lsbCBiZSByZXNvbHZlZCBpbiBhIGxhdGVyCiAgICAgIC8vIHBhc3Mgb3IgYXQgcnVudGltZS4KICAgIH0sCgogICAgUGFydGlhbE5vZGU6IGZ1bmN0aW9uKHBhcnRpYWxOYW1lLCBjb250ZXh0LCBzdHJpcCkgewogICAgICB0aGlzLnR5cGUgICAgICAgICA9ICJwYXJ0aWFsIjsKICAgICAgdGhpcy5wYXJ0aWFsTmFtZSAgPSBwYXJ0aWFsTmFtZTsKICAgICAgdGhpcy5jb250ZXh0ICAgICAgPSBjb250ZXh0OwogICAgICB0aGlzLnN0cmlwID0gc3RyaXA7CiAgICB9LAoKICAgIEJsb2NrTm9kZTogZnVuY3Rpb24obXVzdGFjaGUsIHByb2dyYW0sIGludmVyc2UsIGNsb3NlKSB7CiAgICAgIGlmKG11c3RhY2hlLmlkLm9yaWdpbmFsICE9PSBjbG9zZS5wYXRoLm9yaWdpbmFsKSB7CiAgICAgICAgdGhyb3cgbmV3IEV4Y2VwdGlvbihtdXN0YWNoZS5pZC5vcmlnaW5hbCArICIgZG9lc24ndCBtYXRjaCAiICsgY2xvc2UucGF0aC5vcmlnaW5hbCk7CiAgICAgIH0KCiAgICAgIHRoaXMudHlwZSA9ICJibG9jayI7CiAgICAgIHRoaXMubXVzdGFjaGUgPSBtdXN0YWNoZTsKICAgICAgdGhpcy5wcm9ncmFtICA9IHByb2dyYW07CiAgICAgIHRoaXMuaW52ZXJzZSAgPSBpbnZlcnNlOwoKICAgICAgdGhpcy5zdHJpcCA9IHsKICAgICAgICBsZWZ0OiBtdXN0YWNoZS5zdHJpcC5sZWZ0LAogICAgICAgIHJpZ2h0OiBjbG9zZS5zdHJpcC5yaWdodAogICAgICB9OwoKICAgICAgKHByb2dyYW0gfHwgaW52ZXJzZSkuc3RyaXAubGVmdCA9IG11c3RhY2hlLnN0cmlwLnJpZ2h0OwogICAgICAoaW52ZXJzZSB8fCBwcm9ncmFtKS5zdHJpcC5yaWdodCA9IGNsb3NlLnN0cmlwLmxlZnQ7CgogICAgICBpZiAoaW52ZXJzZSAmJiAhcHJvZ3JhbSkgewogICAgICAgIHRoaXMuaXNJbnZlcnNlID0gdHJ1ZTsKICAgICAgfQogICAgfSwKCiAgICBDb250ZW50Tm9kZTogZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgIHRoaXMudHlwZSA9ICJjb250ZW50IjsKICAgICAgdGhpcy5zdHJpbmcgPSBzdHJpbmc7CiAgICB9LAoKICAgIEhhc2hOb2RlOiBmdW5jdGlvbihwYWlycykgewogICAgICB0aGlzLnR5cGUgPSAiaGFzaCI7CiAgICAgIHRoaXMucGFpcnMgPSBwYWlyczsKICAgIH0sCgogICAgSWROb2RlOiBmdW5jdGlvbihwYXJ0cykgewogICAgICB0aGlzLnR5cGUgPSAiSUQiOwoKICAgICAgdmFyIG9yaWdpbmFsID0gIiIsCiAgICAgICAgICBkaWcgPSBbXSwKICAgICAgICAgIGRlcHRoID0gMDsKCiAgICAgIGZvcih2YXIgaT0wLGw9cGFydHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIHZhciBwYXJ0ID0gcGFydHNbaV0ucGFydDsKICAgICAgICBvcmlnaW5hbCArPSAocGFydHNbaV0uc2VwYXJhdG9yIHx8ICcnKSArIHBhcnQ7CgogICAgICAgIGlmIChwYXJ0ID09PSAiLi4iIHx8IHBhcnQgPT09ICIuIiB8fCBwYXJ0ID09PSAidGhpcyIpIHsKICAgICAgICAgIGlmIChkaWcubGVuZ3RoID4gMCkgeyB0aHJvdyBuZXcgRXhjZXB0aW9uKCJJbnZhbGlkIHBhdGg6ICIgKyBvcmlnaW5hbCk7IH0KICAgICAgICAgIGVsc2UgaWYgKHBhcnQgPT09ICIuLiIpIHsgZGVwdGgrKzsgfQogICAgICAgICAgZWxzZSB7IHRoaXMuaXNTY29wZWQgPSB0cnVlOyB9CiAgICAgICAgfQogICAgICAgIGVsc2UgeyBkaWcucHVzaChwYXJ0KTsgfQogICAgICB9CgogICAgICB0aGlzLm9yaWdpbmFsID0gb3JpZ2luYWw7CiAgICAgIHRoaXMucGFydHMgICAgPSBkaWc7CiAgICAgIHRoaXMuc3RyaW5nICAgPSBkaWcuam9pbignLicpOwogICAgICB0aGlzLmRlcHRoICAgID0gZGVwdGg7CgogICAgICAvLyBhbiBJRCBpcyBzaW1wbGUgaWYgaXQgb25seSBoYXMgb25lIHBhcnQsIGFuZCB0aGF0IHBhcnQgaXMgbm90CiAgICAgIC8vIGAuLmAgb3IgYHRoaXNgLgogICAgICB0aGlzLmlzU2ltcGxlID0gcGFydHMubGVuZ3RoID09PSAxICYmICF0aGlzLmlzU2NvcGVkICYmIGRlcHRoID09PSAwOwoKICAgICAgdGhpcy5zdHJpbmdNb2RlVmFsdWUgPSB0aGlzLnN0cmluZzsKICAgIH0sCgogICAgUGFydGlhbE5hbWVOb2RlOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHRoaXMudHlwZSA9ICJQQVJUSUFMX05BTUUiOwogICAgICB0aGlzLm5hbWUgPSBuYW1lLm9yaWdpbmFsOwogICAgfSwKCiAgICBEYXRhTm9kZTogZnVuY3Rpb24oaWQpIHsKICAgICAgdGhpcy50eXBlID0gIkRBVEEiOwogICAgICB0aGlzLmlkID0gaWQ7CiAgICB9LAoKICAgIFN0cmluZ05vZGU6IGZ1bmN0aW9uKHN0cmluZykgewogICAgICB0aGlzLnR5cGUgPSAiU1RSSU5HIjsKICAgICAgdGhpcy5vcmlnaW5hbCA9CiAgICAgICAgdGhpcy5zdHJpbmcgPQogICAgICAgIHRoaXMuc3RyaW5nTW9kZVZhbHVlID0gc3RyaW5nOwogICAgfSwKCiAgICBJbnRlZ2VyTm9kZTogZnVuY3Rpb24oaW50ZWdlcikgewogICAgICB0aGlzLnR5cGUgPSAiSU5URUdFUiI7CiAgICAgIHRoaXMub3JpZ2luYWwgPQogICAgICAgIHRoaXMuaW50ZWdlciA9IGludGVnZXI7CiAgICAgIHRoaXMuc3RyaW5nTW9kZVZhbHVlID0gTnVtYmVyKGludGVnZXIpOwogICAgfSwKCiAgICBCb29sZWFuTm9kZTogZnVuY3Rpb24oYm9vbCkgewogICAgICB0aGlzLnR5cGUgPSAiQk9PTEVBTiI7CiAgICAgIHRoaXMuYm9vbCA9IGJvb2w7CiAgICAgIHRoaXMuc3RyaW5nTW9kZVZhbHVlID0gYm9vbCA9PT0gInRydWUiOwogICAgfSwKCiAgICBDb21tZW50Tm9kZTogZnVuY3Rpb24oY29tbWVudCkgewogICAgICB0aGlzLnR5cGUgPSAiY29tbWVudCI7CiAgICAgIHRoaXMuY29tbWVudCA9IGNvbW1lbnQ7CiAgICB9CiAgfTsKCiAgLy8gTXVzdCBiZSBleHBvcnRlZCBhcyBhbiBvYmplY3QgcmF0aGVyIHRoYW4gdGhlIHJvb3Qgb2YgdGhlIG1vZHVsZSBhcyB0aGUgamlzb24gbGV4ZXIKICAvLyBtb3N0IG1vZGlmeSB0aGUgb2JqZWN0IHRvIG9wZXJhdGUgcHJvcGVybHkuCiAgX19leHBvcnRzX18gPSBBU1Q7CiAgcmV0dXJuIF9fZXhwb3J0c19fOwp9KShfX21vZHVsZTVfXyk7CgovLyBoYW5kbGViYXJzL2NvbXBpbGVyL3BhcnNlci5qcwp2YXIgX19tb2R1bGU5X18gPSAoZnVuY3Rpb24oKSB7CiAgInVzZSBzdHJpY3QiOwogIHZhciBfX2V4cG9ydHNfXzsKICAvKiBqc2hpbnQgaWdub3JlOnN0YXJ0ICovCiAgLyogSmlzb24gZ2VuZXJhdGVkIHBhcnNlciAqLwogIHZhciBoYW5kbGViYXJzID0gKGZ1bmN0aW9uKCl7CiAgdmFyIHBhcnNlciA9IHt0cmFjZTogZnVuY3Rpb24gdHJhY2UoKSB7IH0sCiAgeXk6IHt9LAogIHN5bWJvbHNfOiB7ImVycm9yIjoyLCJyb290IjozLCJzdGF0ZW1lbnRzIjo0LCJFT0YiOjUsInByb2dyYW0iOjYsInNpbXBsZUludmVyc2UiOjcsInN0YXRlbWVudCI6OCwib3BlbkludmVyc2UiOjksImNsb3NlQmxvY2siOjEwLCJvcGVuQmxvY2siOjExLCJtdXN0YWNoZSI6MTIsInBhcnRpYWwiOjEzLCJDT05URU5UIjoxNCwiQ09NTUVOVCI6MTUsIk9QRU5fQkxPQ0siOjE2LCJpbk11c3RhY2hlIjoxNywiQ0xPU0UiOjE4LCJPUEVOX0lOVkVSU0UiOjE5LCJPUEVOX0VOREJMT0NLIjoyMCwicGF0aCI6MjEsIk9QRU4iOjIyLCJPUEVOX1VORVNDQVBFRCI6MjMsIkNMT1NFX1VORVNDQVBFRCI6MjQsIk9QRU5fUEFSVElBTCI6MjUsInBhcnRpYWxOYW1lIjoyNiwicGFydGlhbF9vcHRpb24wIjoyNywiaW5NdXN0YWNoZV9yZXBldGl0aW9uMCI6MjgsImluTXVzdGFjaGVfb3B0aW9uMCI6MjksImRhdGFOYW1lIjozMCwicGFyYW0iOjMxLCJTVFJJTkciOjMyLCJJTlRFR0VSIjozMywiQk9PTEVBTiI6MzQsImhhc2giOjM1LCJoYXNoX3JlcGV0aXRpb25fcGx1czAiOjM2LCJoYXNoU2VnbWVudCI6MzcsIklEIjozOCwiRVFVQUxTIjozOSwiREFUQSI6NDAsInBhdGhTZWdtZW50cyI6NDEsIlNFUCI6NDIsIiRhY2NlcHQiOjAsIiRlbmQiOjF9LAogIHRlcm1pbmFsc186IHsyOiJlcnJvciIsNToiRU9GIiwxNDoiQ09OVEVOVCIsMTU6IkNPTU1FTlQiLDE2OiJPUEVOX0JMT0NLIiwxODoiQ0xPU0UiLDE5OiJPUEVOX0lOVkVSU0UiLDIwOiJPUEVOX0VOREJMT0NLIiwyMjoiT1BFTiIsMjM6Ik9QRU5fVU5FU0NBUEVEIiwyNDoiQ0xPU0VfVU5FU0NBUEVEIiwyNToiT1BFTl9QQVJUSUFMIiwzMjoiU1RSSU5HIiwzMzoiSU5URUdFUiIsMzQ6IkJPT0xFQU4iLDM4OiJJRCIsMzk6IkVRVUFMUyIsNDA6IkRBVEEiLDQyOiJTRVAifSwKICBwcm9kdWN0aW9uc186IFswLFszLDJdLFszLDFdLFs2LDJdLFs2LDNdLFs2LDJdLFs2LDFdLFs2LDFdLFs2LDBdLFs0LDFdLFs0LDJdLFs4LDNdLFs4LDNdLFs4LDFdLFs4LDFdLFs4LDFdLFs4LDFdLFsxMSwzXSxbOSwzXSxbMTAsM10sWzEyLDNdLFsxMiwzXSxbMTMsNF0sWzcsMl0sWzE3LDNdLFsxNywxXSxbMzEsMV0sWzMxLDFdLFszMSwxXSxbMzEsMV0sWzMxLDFdLFszNSwxXSxbMzcsM10sWzI2LDFdLFsyNiwxXSxbMjYsMV0sWzMwLDJdLFsyMSwxXSxbNDEsM10sWzQxLDFdLFsyNywwXSxbMjcsMV0sWzI4LDBdLFsyOCwyXSxbMjksMF0sWzI5LDFdLFszNiwxXSxbMzYsMl1dLAogIHBlcmZvcm1BY3Rpb246IGZ1bmN0aW9uIGFub255bW91cyh5eXRleHQseXlsZW5nLHl5bGluZW5vLHl5LHl5c3RhdGUsJCQsXyQpIHsKCiAgdmFyICQwID0gJCQubGVuZ3RoIC0gMTsKICBzd2l0Y2ggKHl5c3RhdGUpIHsKICBjYXNlIDE6IHJldHVybiBuZXcgeXkuUHJvZ3JhbU5vZGUoJCRbJDAtMV0pOyAKICBicmVhazsKICBjYXNlIDI6IHJldHVybiBuZXcgeXkuUHJvZ3JhbU5vZGUoW10pOyAKICBicmVhazsKICBjYXNlIDM6dGhpcy4kID0gbmV3IHl5LlByb2dyYW1Ob2RlKFtdLCAkJFskMC0xXSwgJCRbJDBdKTsKICBicmVhazsKICBjYXNlIDQ6dGhpcy4kID0gbmV3IHl5LlByb2dyYW1Ob2RlKCQkWyQwLTJdLCAkJFskMC0xXSwgJCRbJDBdKTsKICBicmVhazsKICBjYXNlIDU6dGhpcy4kID0gbmV3IHl5LlByb2dyYW1Ob2RlKCQkWyQwLTFdLCAkJFskMF0sIFtdKTsKICBicmVhazsKICBjYXNlIDY6dGhpcy4kID0gbmV3IHl5LlByb2dyYW1Ob2RlKCQkWyQwXSk7CiAgYnJlYWs7CiAgY2FzZSA3OnRoaXMuJCA9IG5ldyB5eS5Qcm9ncmFtTm9kZShbXSk7CiAgYnJlYWs7CiAgY2FzZSA4OnRoaXMuJCA9IG5ldyB5eS5Qcm9ncmFtTm9kZShbXSk7CiAgYnJlYWs7CiAgY2FzZSA5OnRoaXMuJCA9IFskJFskMF1dOwogIGJyZWFrOwogIGNhc2UgMTA6ICQkWyQwLTFdLnB1c2goJCRbJDBdKTsgdGhpcy4kID0gJCRbJDAtMV07IAogIGJyZWFrOwogIGNhc2UgMTE6dGhpcy4kID0gbmV3IHl5LkJsb2NrTm9kZSgkJFskMC0yXSwgJCRbJDAtMV0uaW52ZXJzZSwgJCRbJDAtMV0sICQkWyQwXSk7CiAgYnJlYWs7CiAgY2FzZSAxMjp0aGlzLiQgPSBuZXcgeXkuQmxvY2tOb2RlKCQkWyQwLTJdLCAkJFskMC0xXSwgJCRbJDAtMV0uaW52ZXJzZSwgJCRbJDBdKTsKICBicmVhazsKICBjYXNlIDEzOnRoaXMuJCA9ICQkWyQwXTsKICBicmVhazsKICBjYXNlIDE0OnRoaXMuJCA9ICQkWyQwXTsKICBicmVhazsKICBjYXNlIDE1OnRoaXMuJCA9IG5ldyB5eS5Db250ZW50Tm9kZSgkJFskMF0pOwogIGJyZWFrOwogIGNhc2UgMTY6dGhpcy4kID0gbmV3IHl5LkNvbW1lbnROb2RlKCQkWyQwXSk7CiAgYnJlYWs7CiAgY2FzZSAxNzp0aGlzLiQgPSBuZXcgeXkuTXVzdGFjaGVOb2RlKCQkWyQwLTFdWzBdLCAkJFskMC0xXVsxXSwgJCRbJDAtMl0sIHN0cmlwRmxhZ3MoJCRbJDAtMl0sICQkWyQwXSkpOwogIGJyZWFrOwogIGNhc2UgMTg6dGhpcy4kID0gbmV3IHl5Lk11c3RhY2hlTm9kZSgkJFskMC0xXVswXSwgJCRbJDAtMV1bMV0sICQkWyQwLTJdLCBzdHJpcEZsYWdzKCQkWyQwLTJdLCAkJFskMF0pKTsKICBicmVhazsKICBjYXNlIDE5OnRoaXMuJCA9IHtwYXRoOiAkJFskMC0xXSwgc3RyaXA6IHN0cmlwRmxhZ3MoJCRbJDAtMl0sICQkWyQwXSl9OwogIGJyZWFrOwogIGNhc2UgMjA6dGhpcy4kID0gbmV3IHl5Lk11c3RhY2hlTm9kZSgkJFskMC0xXVswXSwgJCRbJDAtMV1bMV0sICQkWyQwLTJdLCBzdHJpcEZsYWdzKCQkWyQwLTJdLCAkJFskMF0pKTsKICBicmVhazsKICBjYXNlIDIxOnRoaXMuJCA9IG5ldyB5eS5NdXN0YWNoZU5vZGUoJCRbJDAtMV1bMF0sICQkWyQwLTFdWzFdLCAkJFskMC0yXSwgc3RyaXBGbGFncygkJFskMC0yXSwgJCRbJDBdKSk7CiAgYnJlYWs7CiAgY2FzZSAyMjp0aGlzLiQgPSBuZXcgeXkuUGFydGlhbE5vZGUoJCRbJDAtMl0sICQkWyQwLTFdLCBzdHJpcEZsYWdzKCQkWyQwLTNdLCAkJFskMF0pKTsKICBicmVhazsKICBjYXNlIDIzOnRoaXMuJCA9IHN0cmlwRmxhZ3MoJCRbJDAtMV0sICQkWyQwXSk7CiAgYnJlYWs7CiAgY2FzZSAyNDp0aGlzLiQgPSBbWyQkWyQwLTJdXS5jb25jYXQoJCRbJDAtMV0pLCAkJFskMF1dOwogIGJyZWFrOwogIGNhc2UgMjU6dGhpcy4kID0gW1skJFskMF1dLCBudWxsXTsKICBicmVhazsKICBjYXNlIDI2OnRoaXMuJCA9ICQkWyQwXTsKICBicmVhazsKICBjYXNlIDI3OnRoaXMuJCA9IG5ldyB5eS5TdHJpbmdOb2RlKCQkWyQwXSk7CiAgYnJlYWs7CiAgY2FzZSAyODp0aGlzLiQgPSBuZXcgeXkuSW50ZWdlck5vZGUoJCRbJDBdKTsKICBicmVhazsKICBjYXNlIDI5OnRoaXMuJCA9IG5ldyB5eS5Cb29sZWFuTm9kZSgkJFskMF0pOwogIGJyZWFrOwogIGNhc2UgMzA6dGhpcy4kID0gJCRbJDBdOwogIGJyZWFrOwogIGNhc2UgMzE6dGhpcy4kID0gbmV3IHl5Lkhhc2hOb2RlKCQkWyQwXSk7CiAgYnJlYWs7CiAgY2FzZSAzMjp0aGlzLiQgPSBbJCRbJDAtMl0sICQkWyQwXV07CiAgYnJlYWs7CiAgY2FzZSAzMzp0aGlzLiQgPSBuZXcgeXkuUGFydGlhbE5hbWVOb2RlKCQkWyQwXSk7CiAgYnJlYWs7CiAgY2FzZSAzNDp0aGlzLiQgPSBuZXcgeXkuUGFydGlhbE5hbWVOb2RlKG5ldyB5eS5TdHJpbmdOb2RlKCQkWyQwXSkpOwogIGJyZWFrOwogIGNhc2UgMzU6dGhpcy4kID0gbmV3IHl5LlBhcnRpYWxOYW1lTm9kZShuZXcgeXkuSW50ZWdlck5vZGUoJCRbJDBdKSk7CiAgYnJlYWs7CiAgY2FzZSAzNjp0aGlzLiQgPSBuZXcgeXkuRGF0YU5vZGUoJCRbJDBdKTsKICBicmVhazsKICBjYXNlIDM3OnRoaXMuJCA9IG5ldyB5eS5JZE5vZGUoJCRbJDBdKTsKICBicmVhazsKICBjYXNlIDM4OiAkJFskMC0yXS5wdXNoKHtwYXJ0OiAkJFskMF0sIHNlcGFyYXRvcjogJCRbJDAtMV19KTsgdGhpcy4kID0gJCRbJDAtMl07IAogIGJyZWFrOwogIGNhc2UgMzk6dGhpcy4kID0gW3twYXJ0OiAkJFskMF19XTsKICBicmVhazsKICBjYXNlIDQyOnRoaXMuJCA9IFtdOwogIGJyZWFrOwogIGNhc2UgNDM6JCRbJDAtMV0ucHVzaCgkJFskMF0pOwogIGJyZWFrOwogIGNhc2UgNDY6dGhpcy4kID0gWyQkWyQwXV07CiAgYnJlYWs7CiAgY2FzZSA0NzokJFskMC0xXS5wdXNoKCQkWyQwXSk7CiAgYnJlYWs7CiAgfQogIH0sCiAgdGFibGU6IFt7MzoxLDQ6Miw1OlsxLDNdLDg6NCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxMV0sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNTpbMSwxNV19LHsxOlszXX0sezU6WzEsMTZdLDg6MTcsOTo1LDExOjYsMTI6NywxMzo4LDE0OlsxLDldLDE1OlsxLDEwXSwxNjpbMSwxMl0sMTk6WzEsMTFdLDIyOlsxLDEzXSwyMzpbMSwxNF0sMjU6WzEsMTVdfSx7MTpbMiwyXX0sezU6WzIsOV0sMTQ6WzIsOV0sMTU6WzIsOV0sMTY6WzIsOV0sMTk6WzIsOV0sMjA6WzIsOV0sMjI6WzIsOV0sMjM6WzIsOV0sMjU6WzIsOV19LHs0OjIwLDY6MTgsNzoxOSw4OjQsOTo1LDExOjYsMTI6NywxMzo4LDE0OlsxLDldLDE1OlsxLDEwXSwxNjpbMSwxMl0sMTk6WzEsMjFdLDIwOlsyLDhdLDIyOlsxLDEzXSwyMzpbMSwxNF0sMjU6WzEsMTVdfSx7NDoyMCw2OjIyLDc6MTksODo0LDk6NSwxMTo2LDEyOjcsMTM6OCwxNDpbMSw5XSwxNTpbMSwxMF0sMTY6WzEsMTJdLDE5OlsxLDIxXSwyMDpbMiw4XSwyMjpbMSwxM10sMjM6WzEsMTRdLDI1OlsxLDE1XX0sezU6WzIsMTNdLDE0OlsyLDEzXSwxNTpbMiwxM10sMTY6WzIsMTNdLDE5OlsyLDEzXSwyMDpbMiwxM10sMjI6WzIsMTNdLDIzOlsyLDEzXSwyNTpbMiwxM119LHs1OlsyLDE0XSwxNDpbMiwxNF0sMTU6WzIsMTRdLDE2OlsyLDE0XSwxOTpbMiwxNF0sMjA6WzIsMTRdLDIyOlsyLDE0XSwyMzpbMiwxNF0sMjU6WzIsMTRdfSx7NTpbMiwxNV0sMTQ6WzIsMTVdLDE1OlsyLDE1XSwxNjpbMiwxNV0sMTk6WzIsMTVdLDIwOlsyLDE1XSwyMjpbMiwxNV0sMjM6WzIsMTVdLDI1OlsyLDE1XX0sezU6WzIsMTZdLDE0OlsyLDE2XSwxNTpbMiwxNl0sMTY6WzIsMTZdLDE5OlsyLDE2XSwyMDpbMiwxNl0sMjI6WzIsMTZdLDIzOlsyLDE2XSwyNTpbMiwxNl19LHsxNzoyMywyMToyNCwzMDoyNSwzODpbMSwyOF0sNDA6WzEsMjddLDQxOjI2fSx7MTc6MjksMjE6MjQsMzA6MjUsMzg6WzEsMjhdLDQwOlsxLDI3XSw0MToyNn0sezE3OjMwLDIxOjI0LDMwOjI1LDM4OlsxLDI4XSw0MDpbMSwyN10sNDE6MjZ9LHsxNzozMSwyMToyNCwzMDoyNSwzODpbMSwyOF0sNDA6WzEsMjddLDQxOjI2fSx7MjE6MzMsMjY6MzIsMzI6WzEsMzRdLDMzOlsxLDM1XSwzODpbMSwyOF0sNDE6MjZ9LHsxOlsyLDFdfSx7NTpbMiwxMF0sMTQ6WzIsMTBdLDE1OlsyLDEwXSwxNjpbMiwxMF0sMTk6WzIsMTBdLDIwOlsyLDEwXSwyMjpbMiwxMF0sMjM6WzIsMTBdLDI1OlsyLDEwXX0sezEwOjM2LDIwOlsxLDM3XX0sezQ6MzgsODo0LDk6NSwxMTo2LDEyOjcsMTM6OCwxNDpbMSw5XSwxNTpbMSwxMF0sMTY6WzEsMTJdLDE5OlsxLDExXSwyMDpbMiw3XSwyMjpbMSwxM10sMjM6WzEsMTRdLDI1OlsxLDE1XX0sezc6MzksODoxNyw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwyMV0sMjA6WzIsNl0sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNTpbMSwxNV19LHsxNzoyMywxODpbMSw0MF0sMjE6MjQsMzA6MjUsMzg6WzEsMjhdLDQwOlsxLDI3XSw0MToyNn0sezEwOjQxLDIwOlsxLDM3XX0sezE4OlsxLDQyXX0sezE4OlsyLDQyXSwyNDpbMiw0Ml0sMjg6NDMsMzI6WzIsNDJdLDMzOlsyLDQyXSwzNDpbMiw0Ml0sMzg6WzIsNDJdLDQwOlsyLDQyXX0sezE4OlsyLDI1XSwyNDpbMiwyNV19LHsxODpbMiwzN10sMjQ6WzIsMzddLDMyOlsyLDM3XSwzMzpbMiwzN10sMzQ6WzIsMzddLDM4OlsyLDM3XSw0MDpbMiwzN10sNDI6WzEsNDRdfSx7MjE6NDUsMzg6WzEsMjhdLDQxOjI2fSx7MTg6WzIsMzldLDI0OlsyLDM5XSwzMjpbMiwzOV0sMzM6WzIsMzldLDM0OlsyLDM5XSwzODpbMiwzOV0sNDA6WzIsMzldLDQyOlsyLDM5XX0sezE4OlsxLDQ2XX0sezE4OlsxLDQ3XX0sezI0OlsxLDQ4XX0sezE4OlsyLDQwXSwyMTo1MCwyNzo0OSwzODpbMSwyOF0sNDE6MjZ9LHsxODpbMiwzM10sMzg6WzIsMzNdfSx7MTg6WzIsMzRdLDM4OlsyLDM0XX0sezE4OlsyLDM1XSwzODpbMiwzNV19LHs1OlsyLDExXSwxNDpbMiwxMV0sMTU6WzIsMTFdLDE2OlsyLDExXSwxOTpbMiwxMV0sMjA6WzIsMTFdLDIyOlsyLDExXSwyMzpbMiwxMV0sMjU6WzIsMTFdfSx7MjE6NTEsMzg6WzEsMjhdLDQxOjI2fSx7ODoxNyw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxMV0sMjA6WzIsM10sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNTpbMSwxNV19LHs0OjUyLDg6NCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxMV0sMjA6WzIsNV0sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNTpbMSwxNV19LHsxNDpbMiwyM10sMTU6WzIsMjNdLDE2OlsyLDIzXSwxOTpbMiwyM10sMjA6WzIsMjNdLDIyOlsyLDIzXSwyMzpbMiwyM10sMjU6WzIsMjNdfSx7NTpbMiwxMl0sMTQ6WzIsMTJdLDE1OlsyLDEyXSwxNjpbMiwxMl0sMTk6WzIsMTJdLDIwOlsyLDEyXSwyMjpbMiwxMl0sMjM6WzIsMTJdLDI1OlsyLDEyXX0sezE0OlsyLDE4XSwxNTpbMiwxOF0sMTY6WzIsMThdLDE5OlsyLDE4XSwyMDpbMiwxOF0sMjI6WzIsMThdLDIzOlsyLDE4XSwyNTpbMiwxOF19LHsxODpbMiw0NF0sMjE6NTYsMjQ6WzIsNDRdLDI5OjUzLDMwOjYwLDMxOjU0LDMyOlsxLDU3XSwzMzpbMSw1OF0sMzQ6WzEsNTldLDM1OjU1LDM2OjYxLDM3OjYyLDM4OlsxLDYzXSw0MDpbMSwyN10sNDE6MjZ9LHszODpbMSw2NF19LHsxODpbMiwzNl0sMjQ6WzIsMzZdLDMyOlsyLDM2XSwzMzpbMiwzNl0sMzQ6WzIsMzZdLDM4OlsyLDM2XSw0MDpbMiwzNl19LHsxNDpbMiwxN10sMTU6WzIsMTddLDE2OlsyLDE3XSwxOTpbMiwxN10sMjA6WzIsMTddLDIyOlsyLDE3XSwyMzpbMiwxN10sMjU6WzIsMTddfSx7NTpbMiwyMF0sMTQ6WzIsMjBdLDE1OlsyLDIwXSwxNjpbMiwyMF0sMTk6WzIsMjBdLDIwOlsyLDIwXSwyMjpbMiwyMF0sMjM6WzIsMjBdLDI1OlsyLDIwXX0sezU6WzIsMjFdLDE0OlsyLDIxXSwxNTpbMiwyMV0sMTY6WzIsMjFdLDE5OlsyLDIxXSwyMDpbMiwyMV0sMjI6WzIsMjFdLDIzOlsyLDIxXSwyNTpbMiwyMV19LHsxODpbMSw2NV19LHsxODpbMiw0MV19LHsxODpbMSw2Nl19LHs4OjE3LDk6NSwxMTo2LDEyOjcsMTM6OCwxNDpbMSw5XSwxNTpbMSwxMF0sMTY6WzEsMTJdLDE5OlsxLDExXSwyMDpbMiw0XSwyMjpbMSwxM10sMjM6WzEsMTRdLDI1OlsxLDE1XX0sezE4OlsyLDI0XSwyNDpbMiwyNF19LHsxODpbMiw0M10sMjQ6WzIsNDNdLDMyOlsyLDQzXSwzMzpbMiw0M10sMzQ6WzIsNDNdLDM4OlsyLDQzXSw0MDpbMiw0M119LHsxODpbMiw0NV0sMjQ6WzIsNDVdfSx7MTg6WzIsMjZdLDI0OlsyLDI2XSwzMjpbMiwyNl0sMzM6WzIsMjZdLDM0OlsyLDI2XSwzODpbMiwyNl0sNDA6WzIsMjZdfSx7MTg6WzIsMjddLDI0OlsyLDI3XSwzMjpbMiwyN10sMzM6WzIsMjddLDM0OlsyLDI3XSwzODpbMiwyN10sNDA6WzIsMjddfSx7MTg6WzIsMjhdLDI0OlsyLDI4XSwzMjpbMiwyOF0sMzM6WzIsMjhdLDM0OlsyLDI4XSwzODpbMiwyOF0sNDA6WzIsMjhdfSx7MTg6WzIsMjldLDI0OlsyLDI5XSwzMjpbMiwyOV0sMzM6WzIsMjldLDM0OlsyLDI5XSwzODpbMiwyOV0sNDA6WzIsMjldfSx7MTg6WzIsMzBdLDI0OlsyLDMwXSwzMjpbMiwzMF0sMzM6WzIsMzBdLDM0OlsyLDMwXSwzODpbMiwzMF0sNDA6WzIsMzBdfSx7MTg6WzIsMzFdLDI0OlsyLDMxXSwzNzo2NywzODpbMSw2OF19LHsxODpbMiw0Nl0sMjQ6WzIsNDZdLDM4OlsyLDQ2XX0sezE4OlsyLDM5XSwyNDpbMiwzOV0sMzI6WzIsMzldLDMzOlsyLDM5XSwzNDpbMiwzOV0sMzg6WzIsMzldLDM5OlsxLDY5XSw0MDpbMiwzOV0sNDI6WzIsMzldfSx7MTg6WzIsMzhdLDI0OlsyLDM4XSwzMjpbMiwzOF0sMzM6WzIsMzhdLDM0OlsyLDM4XSwzODpbMiwzOF0sNDA6WzIsMzhdLDQyOlsyLDM4XX0sezU6WzIsMjJdLDE0OlsyLDIyXSwxNTpbMiwyMl0sMTY6WzIsMjJdLDE5OlsyLDIyXSwyMDpbMiwyMl0sMjI6WzIsMjJdLDIzOlsyLDIyXSwyNTpbMiwyMl19LHs1OlsyLDE5XSwxNDpbMiwxOV0sMTU6WzIsMTldLDE2OlsyLDE5XSwxOTpbMiwxOV0sMjA6WzIsMTldLDIyOlsyLDE5XSwyMzpbMiwxOV0sMjU6WzIsMTldfSx7MTg6WzIsNDddLDI0OlsyLDQ3XSwzODpbMiw0N119LHszOTpbMSw2OV19LHsyMTo1NiwzMDo2MCwzMTo3MCwzMjpbMSw1N10sMzM6WzEsNThdLDM0OlsxLDU5XSwzODpbMSwyOF0sNDA6WzEsMjddLDQxOjI2fSx7MTg6WzIsMzJdLDI0OlsyLDMyXSwzODpbMiwzMl19XSwKICBkZWZhdWx0QWN0aW9uczogezM6WzIsMl0sMTY6WzIsMV0sNTA6WzIsNDFdfSwKICBwYXJzZUVycm9yOiBmdW5jdGlvbiBwYXJzZUVycm9yKHN0ciwgaGFzaCkgewogICAgICB0aHJvdyBuZXcgRXJyb3Ioc3RyKTsKICB9LAogIHBhcnNlOiBmdW5jdGlvbiBwYXJzZShpbnB1dCkgewogICAgICB2YXIgc2VsZiA9IHRoaXMsIHN0YWNrID0gWzBdLCB2c3RhY2sgPSBbbnVsbF0sIGxzdGFjayA9IFtdLCB0YWJsZSA9IHRoaXMudGFibGUsIHl5dGV4dCA9ICIiLCB5eWxpbmVubyA9IDAsIHl5bGVuZyA9IDAsIHJlY292ZXJpbmcgPSAwLCBURVJST1IgPSAyLCBFT0YgPSAxOwogICAgICB0aGlzLmxleGVyLnNldElucHV0KGlucHV0KTsKICAgICAgdGhpcy5sZXhlci55eSA9IHRoaXMueXk7CiAgICAgIHRoaXMueXkubGV4ZXIgPSB0aGlzLmxleGVyOwogICAgICB0aGlzLnl5LnBhcnNlciA9IHRoaXM7CiAgICAgIGlmICh0eXBlb2YgdGhpcy5sZXhlci55eWxsb2MgPT0gInVuZGVmaW5lZCIpCiAgICAgICAgICB0aGlzLmxleGVyLnl5bGxvYyA9IHt9OwogICAgICB2YXIgeXlsb2MgPSB0aGlzLmxleGVyLnl5bGxvYzsKICAgICAgbHN0YWNrLnB1c2goeXlsb2MpOwogICAgICB2YXIgcmFuZ2VzID0gdGhpcy5sZXhlci5vcHRpb25zICYmIHRoaXMubGV4ZXIub3B0aW9ucy5yYW5nZXM7CiAgICAgIGlmICh0eXBlb2YgdGhpcy55eS5wYXJzZUVycm9yID09PSAiZnVuY3Rpb24iKQogICAgICAgICAgdGhpcy5wYXJzZUVycm9yID0gdGhpcy55eS5wYXJzZUVycm9yOwogICAgICBmdW5jdGlvbiBwb3BTdGFjayhuKSB7CiAgICAgICAgICBzdGFjay5sZW5ndGggPSBzdGFjay5sZW5ndGggLSAyICogbjsKICAgICAgICAgIHZzdGFjay5sZW5ndGggPSB2c3RhY2subGVuZ3RoIC0gbjsKICAgICAgICAgIGxzdGFjay5sZW5ndGggPSBsc3RhY2subGVuZ3RoIC0gbjsKICAgICAgfQogICAgICBmdW5jdGlvbiBsZXgoKSB7CiAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICB0b2tlbiA9IHNlbGYubGV4ZXIubGV4KCkgfHwgMTsKICAgICAgICAgIGlmICh0eXBlb2YgdG9rZW4gIT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgdG9rZW4gPSBzZWxmLnN5bWJvbHNfW3Rva2VuXSB8fCB0b2tlbjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0b2tlbjsKICAgICAgfQogICAgICB2YXIgc3ltYm9sLCBwcmVFcnJvclN5bWJvbCwgc3RhdGUsIGFjdGlvbiwgYSwgciwgeXl2YWwgPSB7fSwgcCwgbGVuLCBuZXdTdGF0ZSwgZXhwZWN0ZWQ7CiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICBzdGF0ZSA9IHN0YWNrW3N0YWNrLmxlbmd0aCAtIDFdOwogICAgICAgICAgaWYgKHRoaXMuZGVmYXVsdEFjdGlvbnNbc3RhdGVdKSB7CiAgICAgICAgICAgICAgYWN0aW9uID0gdGhpcy5kZWZhdWx0QWN0aW9uc1tzdGF0ZV07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChzeW1ib2wgPT09IG51bGwgfHwgdHlwZW9mIHN5bWJvbCA9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgICBzeW1ib2wgPSBsZXgoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYWN0aW9uID0gdGFibGVbc3RhdGVdICYmIHRhYmxlW3N0YXRlXVtzeW1ib2xdOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBhY3Rpb24gPT09ICJ1bmRlZmluZWQiIHx8ICFhY3Rpb24ubGVuZ3RoIHx8ICFhY3Rpb25bMF0pIHsKICAgICAgICAgICAgICB2YXIgZXJyU3RyID0gIiI7CiAgICAgICAgICAgICAgaWYgKCFyZWNvdmVyaW5nKSB7CiAgICAgICAgICAgICAgICAgIGV4cGVjdGVkID0gW107CiAgICAgICAgICAgICAgICAgIGZvciAocCBpbiB0YWJsZVtzdGF0ZV0pCiAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy50ZXJtaW5hbHNfW3BdICYmIHAgPiAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZXhwZWN0ZWQucHVzaCgiJyIgKyB0aGlzLnRlcm1pbmFsc19bcF0gKyAiJyIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodGhpcy5sZXhlci5zaG93UG9zaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgIGVyclN0ciA9ICJQYXJzZSBlcnJvciBvbiBsaW5lICIgKyAoeXlsaW5lbm8gKyAxKSArICI6XG4iICsgdGhpcy5sZXhlci5zaG93UG9zaXRpb24oKSArICJcbkV4cGVjdGluZyAiICsgZXhwZWN0ZWQuam9pbigiLCAiKSArICIsIGdvdCAnIiArICh0aGlzLnRlcm1pbmFsc19bc3ltYm9sXSB8fCBzeW1ib2wpICsgIiciOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgZXJyU3RyID0gIlBhcnNlIGVycm9yIG9uIGxpbmUgIiArICh5eWxpbmVubyArIDEpICsgIjogVW5leHBlY3RlZCAiICsgKHN5bWJvbCA9PSAxPyJlbmQgb2YgaW5wdXQiOiInIiArICh0aGlzLnRlcm1pbmFsc19bc3ltYm9sXSB8fCBzeW1ib2wpICsgIiciKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB0aGlzLnBhcnNlRXJyb3IoZXJyU3RyLCB7dGV4dDogdGhpcy5sZXhlci5tYXRjaCwgdG9rZW46IHRoaXMudGVybWluYWxzX1tzeW1ib2xdIHx8IHN5bWJvbCwgbGluZTogdGhpcy5sZXhlci55eWxpbmVubywgbG9jOiB5eWxvYywgZXhwZWN0ZWQ6IGV4cGVjdGVkfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGFjdGlvblswXSBpbnN0YW5jZW9mIEFycmF5ICYmIGFjdGlvbi5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQYXJzZSBFcnJvcjogbXVsdGlwbGUgYWN0aW9ucyBwb3NzaWJsZSBhdCBzdGF0ZTogIiArIHN0YXRlICsgIiwgdG9rZW46ICIgKyBzeW1ib2wpOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoIChhY3Rpb25bMF0pIHsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICBzdGFjay5wdXNoKHN5bWJvbCk7CiAgICAgICAgICAgICAgdnN0YWNrLnB1c2godGhpcy5sZXhlci55eXRleHQpOwogICAgICAgICAgICAgIGxzdGFjay5wdXNoKHRoaXMubGV4ZXIueXlsbG9jKTsKICAgICAgICAgICAgICBzdGFjay5wdXNoKGFjdGlvblsxXSk7CiAgICAgICAgICAgICAgc3ltYm9sID0gbnVsbDsKICAgICAgICAgICAgICBpZiAoIXByZUVycm9yU3ltYm9sKSB7CiAgICAgICAgICAgICAgICAgIHl5bGVuZyA9IHRoaXMubGV4ZXIueXlsZW5nOwogICAgICAgICAgICAgICAgICB5eXRleHQgPSB0aGlzLmxleGVyLnl5dGV4dDsKICAgICAgICAgICAgICAgICAgeXlsaW5lbm8gPSB0aGlzLmxleGVyLnl5bGluZW5vOwogICAgICAgICAgICAgICAgICB5eWxvYyA9IHRoaXMubGV4ZXIueXlsbG9jOwogICAgICAgICAgICAgICAgICBpZiAocmVjb3ZlcmluZyA+IDApCiAgICAgICAgICAgICAgICAgICAgICByZWNvdmVyaW5nLS07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgc3ltYm9sID0gcHJlRXJyb3JTeW1ib2w7CiAgICAgICAgICAgICAgICAgIHByZUVycm9yU3ltYm9sID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgbGVuID0gdGhpcy5wcm9kdWN0aW9uc19bYWN0aW9uWzFdXVsxXTsKICAgICAgICAgICAgICB5eXZhbC4kID0gdnN0YWNrW3ZzdGFjay5sZW5ndGggLSBsZW5dOwogICAgICAgICAgICAgIHl5dmFsLl8kID0ge2ZpcnN0X2xpbmU6IGxzdGFja1tsc3RhY2subGVuZ3RoIC0gKGxlbiB8fCAxKV0uZmlyc3RfbGluZSwgbGFzdF9saW5lOiBsc3RhY2tbbHN0YWNrLmxlbmd0aCAtIDFdLmxhc3RfbGluZSwgZmlyc3RfY29sdW1uOiBsc3RhY2tbbHN0YWNrLmxlbmd0aCAtIChsZW4gfHwgMSldLmZpcnN0X2NvbHVtbiwgbGFzdF9jb2x1bW46IGxzdGFja1tsc3RhY2subGVuZ3RoIC0gMV0ubGFzdF9jb2x1bW59OwogICAgICAgICAgICAgIGlmIChyYW5nZXMpIHsKICAgICAgICAgICAgICAgICAgeXl2YWwuXyQucmFuZ2UgPSBbbHN0YWNrW2xzdGFjay5sZW5ndGggLSAobGVuIHx8IDEpXS5yYW5nZVswXSwgbHN0YWNrW2xzdGFjay5sZW5ndGggLSAxXS5yYW5nZVsxXV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHIgPSB0aGlzLnBlcmZvcm1BY3Rpb24uY2FsbCh5eXZhbCwgeXl0ZXh0LCB5eWxlbmcsIHl5bGluZW5vLCB0aGlzLnl5LCBhY3Rpb25bMV0sIHZzdGFjaywgbHN0YWNrKTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHIgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiByOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobGVuKSB7CiAgICAgICAgICAgICAgICAgIHN0YWNrID0gc3RhY2suc2xpY2UoMCwgLTEgKiBsZW4gKiAyKTsKICAgICAgICAgICAgICAgICAgdnN0YWNrID0gdnN0YWNrLnNsaWNlKDAsIC0xICogbGVuKTsKICAgICAgICAgICAgICAgICAgbHN0YWNrID0gbHN0YWNrLnNsaWNlKDAsIC0xICogbGVuKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3RhY2sucHVzaCh0aGlzLnByb2R1Y3Rpb25zX1thY3Rpb25bMV1dWzBdKTsKICAgICAgICAgICAgICB2c3RhY2sucHVzaCh5eXZhbC4kKTsKICAgICAgICAgICAgICBsc3RhY2sucHVzaCh5eXZhbC5fJCk7CiAgICAgICAgICAgICAgbmV3U3RhdGUgPSB0YWJsZVtzdGFja1tzdGFjay5sZW5ndGggLSAyXV1bc3RhY2tbc3RhY2subGVuZ3RoIC0gMV1dOwogICAgICAgICAgICAgIHN0YWNrLnB1c2gobmV3U3RhdGUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogIH0KICB9OwoKCiAgZnVuY3Rpb24gc3RyaXBGbGFncyhvcGVuLCBjbG9zZSkgewogICAgcmV0dXJuIHsKICAgICAgbGVmdDogb3Blbi5jaGFyQXQoMikgPT09ICd+JywKICAgICAgcmlnaHQ6IGNsb3NlLmNoYXJBdCgwKSA9PT0gJ34nIHx8IGNsb3NlLmNoYXJBdCgxKSA9PT0gJ34nCiAgICB9OwogIH0KCiAgLyogSmlzb24gZ2VuZXJhdGVkIGxleGVyICovCiAgdmFyIGxleGVyID0gKGZ1bmN0aW9uKCl7CiAgdmFyIGxleGVyID0gKHtFT0Y6MSwKICBwYXJzZUVycm9yOmZ1bmN0aW9uIHBhcnNlRXJyb3Ioc3RyLCBoYXNoKSB7CiAgICAgICAgICBpZiAodGhpcy55eS5wYXJzZXIpIHsKICAgICAgICAgICAgICB0aGlzLnl5LnBhcnNlci5wYXJzZUVycm9yKHN0ciwgaGFzaCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihzdHIpOwogICAgICAgICAgfQogICAgICB9LAogIHNldElucHV0OmZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgICAgdGhpcy5faW5wdXQgPSBpbnB1dDsKICAgICAgICAgIHRoaXMuX21vcmUgPSB0aGlzLl9sZXNzID0gdGhpcy5kb25lID0gZmFsc2U7CiAgICAgICAgICB0aGlzLnl5bGluZW5vID0gdGhpcy55eWxlbmcgPSAwOwogICAgICAgICAgdGhpcy55eXRleHQgPSB0aGlzLm1hdGNoZWQgPSB0aGlzLm1hdGNoID0gJyc7CiAgICAgICAgICB0aGlzLmNvbmRpdGlvblN0YWNrID0gWydJTklUSUFMJ107CiAgICAgICAgICB0aGlzLnl5bGxvYyA9IHtmaXJzdF9saW5lOjEsZmlyc3RfY29sdW1uOjAsbGFzdF9saW5lOjEsbGFzdF9jb2x1bW46MH07CiAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLnJhbmdlcykgdGhpcy55eWxsb2MucmFuZ2UgPSBbMCwwXTsKICAgICAgICAgIHRoaXMub2Zmc2V0ID0gMDsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogIGlucHV0OmZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBjaCA9IHRoaXMuX2lucHV0WzBdOwogICAgICAgICAgdGhpcy55eXRleHQgKz0gY2g7CiAgICAgICAgICB0aGlzLnl5bGVuZysrOwogICAgICAgICAgdGhpcy5vZmZzZXQrKzsKICAgICAgICAgIHRoaXMubWF0Y2ggKz0gY2g7CiAgICAgICAgICB0aGlzLm1hdGNoZWQgKz0gY2g7CiAgICAgICAgICB2YXIgbGluZXMgPSBjaC5tYXRjaCgvKD86XHJcbj98XG4pLiovZyk7CiAgICAgICAgICBpZiAobGluZXMpIHsKICAgICAgICAgICAgICB0aGlzLnl5bGluZW5vKys7CiAgICAgICAgICAgICAgdGhpcy55eWxsb2MubGFzdF9saW5lKys7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMueXlsbG9jLmxhc3RfY29sdW1uKys7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLnJhbmdlcykgdGhpcy55eWxsb2MucmFuZ2VbMV0rKzsKCiAgICAgICAgICB0aGlzLl9pbnB1dCA9IHRoaXMuX2lucHV0LnNsaWNlKDEpOwogICAgICAgICAgcmV0dXJuIGNoOwogICAgICB9LAogIHVucHV0OmZ1bmN0aW9uIChjaCkgewogICAgICAgICAgdmFyIGxlbiA9IGNoLmxlbmd0aDsKICAgICAgICAgIHZhciBsaW5lcyA9IGNoLnNwbGl0KC8oPzpcclxuP3xcbikvZyk7CgogICAgICAgICAgdGhpcy5faW5wdXQgPSBjaCArIHRoaXMuX2lucHV0OwogICAgICAgICAgdGhpcy55eXRleHQgPSB0aGlzLnl5dGV4dC5zdWJzdHIoMCwgdGhpcy55eXRleHQubGVuZ3RoLWxlbi0xKTsKICAgICAgICAgIC8vdGhpcy55eWxlbmcgLT0gbGVuOwogICAgICAgICAgdGhpcy5vZmZzZXQgLT0gbGVuOwogICAgICAgICAgdmFyIG9sZExpbmVzID0gdGhpcy5tYXRjaC5zcGxpdCgvKD86XHJcbj98XG4pL2cpOwogICAgICAgICAgdGhpcy5tYXRjaCA9IHRoaXMubWF0Y2guc3Vic3RyKDAsIHRoaXMubWF0Y2gubGVuZ3RoLTEpOwogICAgICAgICAgdGhpcy5tYXRjaGVkID0gdGhpcy5tYXRjaGVkLnN1YnN0cigwLCB0aGlzLm1hdGNoZWQubGVuZ3RoLTEpOwoKICAgICAgICAgIGlmIChsaW5lcy5sZW5ndGgtMSkgdGhpcy55eWxpbmVubyAtPSBsaW5lcy5sZW5ndGgtMTsKICAgICAgICAgIHZhciByID0gdGhpcy55eWxsb2MucmFuZ2U7CgogICAgICAgICAgdGhpcy55eWxsb2MgPSB7Zmlyc3RfbGluZTogdGhpcy55eWxsb2MuZmlyc3RfbGluZSwKICAgICAgICAgICAgbGFzdF9saW5lOiB0aGlzLnl5bGluZW5vKzEsCiAgICAgICAgICAgIGZpcnN0X2NvbHVtbjogdGhpcy55eWxsb2MuZmlyc3RfY29sdW1uLAogICAgICAgICAgICBsYXN0X2NvbHVtbjogbGluZXMgPwogICAgICAgICAgICAgICAgKGxpbmVzLmxlbmd0aCA9PT0gb2xkTGluZXMubGVuZ3RoID8gdGhpcy55eWxsb2MuZmlyc3RfY29sdW1uIDogMCkgKyBvbGRMaW5lc1tvbGRMaW5lcy5sZW5ndGggLSBsaW5lcy5sZW5ndGhdLmxlbmd0aCAtIGxpbmVzWzBdLmxlbmd0aDoKICAgICAgICAgICAgICAgIHRoaXMueXlsbG9jLmZpcnN0X2NvbHVtbiAtIGxlbgogICAgICAgICAgICB9OwoKICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMucmFuZ2VzKSB7CiAgICAgICAgICAgICAgdGhpcy55eWxsb2MucmFuZ2UgPSBbclswXSwgclswXSArIHRoaXMueXlsZW5nIC0gbGVuXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogIG1vcmU6ZnVuY3Rpb24gKCkgewogICAgICAgICAgdGhpcy5fbW9yZSA9IHRydWU7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICBsZXNzOmZ1bmN0aW9uIChuKSB7CiAgICAgICAgICB0aGlzLnVucHV0KHRoaXMubWF0Y2guc2xpY2UobikpOwogICAgICB9LAogIHBhc3RJbnB1dDpmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgcGFzdCA9IHRoaXMubWF0Y2hlZC5zdWJzdHIoMCwgdGhpcy5tYXRjaGVkLmxlbmd0aCAtIHRoaXMubWF0Y2gubGVuZ3RoKTsKICAgICAgICAgIHJldHVybiAocGFzdC5sZW5ndGggPiAyMCA/ICcuLi4nOicnKSArIHBhc3Quc3Vic3RyKC0yMCkucmVwbGFjZSgvXG4vZywgIiIpOwogICAgICB9LAogIHVwY29taW5nSW5wdXQ6ZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIG5leHQgPSB0aGlzLm1hdGNoOwogICAgICAgICAgaWYgKG5leHQubGVuZ3RoIDwgMjApIHsKICAgICAgICAgICAgICBuZXh0ICs9IHRoaXMuX2lucHV0LnN1YnN0cigwLCAyMC1uZXh0Lmxlbmd0aCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gKG5leHQuc3Vic3RyKDAsMjApKyhuZXh0Lmxlbmd0aCA+IDIwID8gJy4uLic6JycpKS5yZXBsYWNlKC9cbi9nLCAiIik7CiAgICAgIH0sCiAgc2hvd1Bvc2l0aW9uOmZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBwcmUgPSB0aGlzLnBhc3RJbnB1dCgpOwogICAgICAgICAgdmFyIGMgPSBuZXcgQXJyYXkocHJlLmxlbmd0aCArIDEpLmpvaW4oIi0iKTsKICAgICAgICAgIHJldHVybiBwcmUgKyB0aGlzLnVwY29taW5nSW5wdXQoKSArICJcbiIgKyBjKyJeIjsKICAgICAgfSwKICBuZXh0OmZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICh0aGlzLmRvbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5FT0Y7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXRoaXMuX2lucHV0KSB0aGlzLmRvbmUgPSB0cnVlOwoKICAgICAgICAgIHZhciB0b2tlbiwKICAgICAgICAgICAgICBtYXRjaCwKICAgICAgICAgICAgICB0ZW1wTWF0Y2gsCiAgICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgICAgY29sLAogICAgICAgICAgICAgIGxpbmVzOwogICAgICAgICAgaWYgKCF0aGlzLl9tb3JlKSB7CiAgICAgICAgICAgICAgdGhpcy55eXRleHQgPSAnJzsKICAgICAgICAgICAgICB0aGlzLm1hdGNoID0gJyc7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcnVsZXMgPSB0aGlzLl9jdXJyZW50UnVsZXMoKTsKICAgICAgICAgIGZvciAodmFyIGk9MDtpIDwgcnVsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB0ZW1wTWF0Y2ggPSB0aGlzLl9pbnB1dC5tYXRjaCh0aGlzLnJ1bGVzW3J1bGVzW2ldXSk7CiAgICAgICAgICAgICAgaWYgKHRlbXBNYXRjaCAmJiAoIW1hdGNoIHx8IHRlbXBNYXRjaFswXS5sZW5ndGggPiBtYXRjaFswXS5sZW5ndGgpKSB7CiAgICAgICAgICAgICAgICAgIG1hdGNoID0gdGVtcE1hdGNoOwogICAgICAgICAgICAgICAgICBpbmRleCA9IGk7CiAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5vcHRpb25zLmZsZXgpIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgIGxpbmVzID0gbWF0Y2hbMF0ubWF0Y2goLyg/OlxyXG4/fFxuKS4qL2cpOwogICAgICAgICAgICAgIGlmIChsaW5lcykgdGhpcy55eWxpbmVubyArPSBsaW5lcy5sZW5ndGg7CiAgICAgICAgICAgICAgdGhpcy55eWxsb2MgPSB7Zmlyc3RfbGluZTogdGhpcy55eWxsb2MubGFzdF9saW5lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RfbGluZTogdGhpcy55eWxpbmVubysxLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0X2NvbHVtbjogdGhpcy55eWxsb2MubGFzdF9jb2x1bW4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdF9jb2x1bW46IGxpbmVzID8gbGluZXNbbGluZXMubGVuZ3RoLTFdLmxlbmd0aC1saW5lc1tsaW5lcy5sZW5ndGgtMV0ubWF0Y2goL1xyP1xuPy8pWzBdLmxlbmd0aCA6IHRoaXMueXlsbG9jLmxhc3RfY29sdW1uICsgbWF0Y2hbMF0ubGVuZ3RofTsKICAgICAgICAgICAgICB0aGlzLnl5dGV4dCArPSBtYXRjaFswXTsKICAgICAgICAgICAgICB0aGlzLm1hdGNoICs9IG1hdGNoWzBdOwogICAgICAgICAgICAgIHRoaXMubWF0Y2hlcyA9IG1hdGNoOwogICAgICAgICAgICAgIHRoaXMueXlsZW5nID0gdGhpcy55eXRleHQubGVuZ3RoOwogICAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMucmFuZ2VzKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMueXlsbG9jLnJhbmdlID0gW3RoaXMub2Zmc2V0LCB0aGlzLm9mZnNldCArPSB0aGlzLnl5bGVuZ107CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuX21vcmUgPSBmYWxzZTsKICAgICAgICAgICAgICB0aGlzLl9pbnB1dCA9IHRoaXMuX2lucHV0LnNsaWNlKG1hdGNoWzBdLmxlbmd0aCk7CiAgICAgICAgICAgICAgdGhpcy5tYXRjaGVkICs9IG1hdGNoWzBdOwogICAgICAgICAgICAgIHRva2VuID0gdGhpcy5wZXJmb3JtQWN0aW9uLmNhbGwodGhpcywgdGhpcy55eSwgdGhpcywgcnVsZXNbaW5kZXhdLHRoaXMuY29uZGl0aW9uU3RhY2tbdGhpcy5jb25kaXRpb25TdGFjay5sZW5ndGgtMV0pOwogICAgICAgICAgICAgIGlmICh0aGlzLmRvbmUgJiYgdGhpcy5faW5wdXQpIHRoaXMuZG9uZSA9IGZhbHNlOwogICAgICAgICAgICAgIGlmICh0b2tlbikgcmV0dXJuIHRva2VuOwogICAgICAgICAgICAgIGVsc2UgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRoaXMuX2lucHV0ID09PSAiIikgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLkVPRjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucGFyc2VFcnJvcignTGV4aWNhbCBlcnJvciBvbiBsaW5lICcrKHRoaXMueXlsaW5lbm8rMSkrJy4gVW5yZWNvZ25pemVkIHRleHQuXG4nK3RoaXMuc2hvd1Bvc2l0aW9uKCksCiAgICAgICAgICAgICAgICAgICAgICB7dGV4dDogIiIsIHRva2VuOiBudWxsLCBsaW5lOiB0aGlzLnl5bGluZW5vfSk7CiAgICAgICAgICB9CiAgICAgIH0sCiAgbGV4OmZ1bmN0aW9uIGxleCgpIHsKICAgICAgICAgIHZhciByID0gdGhpcy5uZXh0KCk7CiAgICAgICAgICBpZiAodHlwZW9mIHIgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLmxleCgpOwogICAgICAgICAgfQogICAgICB9LAogIGJlZ2luOmZ1bmN0aW9uIGJlZ2luKGNvbmRpdGlvbikgewogICAgICAgICAgdGhpcy5jb25kaXRpb25TdGFjay5wdXNoKGNvbmRpdGlvbik7CiAgICAgIH0sCiAgcG9wU3RhdGU6ZnVuY3Rpb24gcG9wU3RhdGUoKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5jb25kaXRpb25TdGFjay5wb3AoKTsKICAgICAgfSwKICBfY3VycmVudFJ1bGVzOmZ1bmN0aW9uIF9jdXJyZW50UnVsZXMoKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5jb25kaXRpb25zW3RoaXMuY29uZGl0aW9uU3RhY2tbdGhpcy5jb25kaXRpb25TdGFjay5sZW5ndGgtMV1dLnJ1bGVzOwogICAgICB9LAogIHRvcFN0YXRlOmZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiB0aGlzLmNvbmRpdGlvblN0YWNrW3RoaXMuY29uZGl0aW9uU3RhY2subGVuZ3RoLTJdOwogICAgICB9LAogIHB1c2hTdGF0ZTpmdW5jdGlvbiBiZWdpbihjb25kaXRpb24pIHsKICAgICAgICAgIHRoaXMuYmVnaW4oY29uZGl0aW9uKTsKICAgICAgfX0pOwogIGxleGVyLm9wdGlvbnMgPSB7fTsKICBsZXhlci5wZXJmb3JtQWN0aW9uID0gZnVuY3Rpb24gYW5vbnltb3VzKHl5LHl5XywkYXZvaWRpbmdfbmFtZV9jb2xsaXNpb25zLFlZX1NUQVJUKSB7CgoKICBmdW5jdGlvbiBzdHJpcChzdGFydCwgZW5kKSB7CiAgICByZXR1cm4geXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKHN0YXJ0LCB5eV8ueXlsZW5nLWVuZCk7CiAgfQoKCiAgdmFyIFlZU1RBVEU9WVlfU1RBUlQKICBzd2l0Y2goJGF2b2lkaW5nX25hbWVfY29sbGlzaW9ucykgewogIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHl5Xy55eXRleHQuc2xpY2UoLTIpID09PSAiXFxcXCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaXAoMCwxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5iZWdpbigibXUiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZih5eV8ueXl0ZXh0LnNsaWNlKC0xKSA9PT0gIlxcIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpcCgwLDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmJlZ2luKCJlbXUiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYmVnaW4oIm11Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih5eV8ueXl0ZXh0KSByZXR1cm4gMTQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgYnJlYWs7CiAgY2FzZSAxOnJldHVybiAxNDsKICBicmVhazsKICBjYXNlIDI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvcFN0YXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMTQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgYnJlYWs7CiAgY2FzZSAzOnN0cmlwKDAsNCk7IHRoaXMucG9wU3RhdGUoKTsgcmV0dXJuIDE1OwogIGJyZWFrOwogIGNhc2UgNDpyZXR1cm4gMjU7CiAgYnJlYWs7CiAgY2FzZSA1OnJldHVybiAxNjsKICBicmVhazsKICBjYXNlIDY6cmV0dXJuIDIwOwogIGJyZWFrOwogIGNhc2UgNzpyZXR1cm4gMTk7CiAgYnJlYWs7CiAgY2FzZSA4OnJldHVybiAxOTsKICBicmVhazsKICBjYXNlIDk6cmV0dXJuIDIzOwogIGJyZWFrOwogIGNhc2UgMTA6cmV0dXJuIDIyOwogIGJyZWFrOwogIGNhc2UgMTE6dGhpcy5wb3BTdGF0ZSgpOyB0aGlzLmJlZ2luKCdjb20nKTsKICBicmVhazsKICBjYXNlIDEyOnN0cmlwKDMsNSk7IHRoaXMucG9wU3RhdGUoKTsgcmV0dXJuIDE1OwogIGJyZWFrOwogIGNhc2UgMTM6cmV0dXJuIDIyOwogIGJyZWFrOwogIGNhc2UgMTQ6cmV0dXJuIDM5OwogIGJyZWFrOwogIGNhc2UgMTU6cmV0dXJuIDM4OwogIGJyZWFrOwogIGNhc2UgMTY6cmV0dXJuIDM4OwogIGJyZWFrOwogIGNhc2UgMTc6cmV0dXJuIDQyOwogIGJyZWFrOwogIGNhc2UgMTg6Ly8gaWdub3JlIHdoaXRlc3BhY2UKICBicmVhazsKICBjYXNlIDE5OnRoaXMucG9wU3RhdGUoKTsgcmV0dXJuIDI0OwogIGJyZWFrOwogIGNhc2UgMjA6dGhpcy5wb3BTdGF0ZSgpOyByZXR1cm4gMTg7CiAgYnJlYWs7CiAgY2FzZSAyMTp5eV8ueXl0ZXh0ID0gc3RyaXAoMSwyKS5yZXBsYWNlKC9cXCIvZywnIicpOyByZXR1cm4gMzI7CiAgYnJlYWs7CiAgY2FzZSAyMjp5eV8ueXl0ZXh0ID0gc3RyaXAoMSwyKS5yZXBsYWNlKC9cXCcvZywiJyIpOyByZXR1cm4gMzI7CiAgYnJlYWs7CiAgY2FzZSAyMzpyZXR1cm4gNDA7CiAgYnJlYWs7CiAgY2FzZSAyNDpyZXR1cm4gMzQ7CiAgYnJlYWs7CiAgY2FzZSAyNTpyZXR1cm4gMzQ7CiAgYnJlYWs7CiAgY2FzZSAyNjpyZXR1cm4gMzM7CiAgYnJlYWs7CiAgY2FzZSAyNzpyZXR1cm4gMzg7CiAgYnJlYWs7CiAgY2FzZSAyODp5eV8ueXl0ZXh0ID0gc3RyaXAoMSwyKTsgcmV0dXJuIDM4OwogIGJyZWFrOwogIGNhc2UgMjk6cmV0dXJuICdJTlZBTElEJzsKICBicmVhazsKICBjYXNlIDMwOnJldHVybiA1OwogIGJyZWFrOwogIH0KICB9OwogIGxleGVyLnJ1bGVzID0gWy9eKD86W15ceDAwXSo/KD89KFx7XHspKSkvLC9eKD86W15ceDAwXSspLywvXig/OlteXHgwMF17Mix9Pyg/PShce1x7fFxcXHtce3xcXFxcXHtce3wkKSkpLywvXig/Oltcc1xTXSo/LS1cfVx9KS8sL14oPzpce1x7KH4pPz4pLywvXig/Olx7XHsofik/IykvLC9eKD86XHtceyh+KT9cLykvLC9eKD86XHtceyh+KT9cXikvLC9eKD86XHtceyh+KT9ccyplbHNlXGIpLywvXig/Olx7XHsofik/XHspLywvXig/Olx7XHsofik/JikvLC9eKD86XHtceyEtLSkvLC9eKD86XHtceyFbXHNcU10qP1x9XH0pLywvXig/Olx7XHsofik/KS8sL14oPzo9KS8sL14oPzpcLlwuKS8sL14oPzpcLig/PShbPX59XHNcLy5dKSkpLywvXig/OltcLy5dKS8sL14oPzpccyspLywvXig/Olx9KH4pP1x9XH0pLywvXig/Oih+KT9cfVx9KS8sL14oPzoiKFxcWyJdfFteIl0pKiIpLywvXig/OicoXFxbJ118W14nXSkqJykvLC9eKD86QCkvLC9eKD86dHJ1ZSg/PShbfn1cc10pKSkvLC9eKD86ZmFsc2UoPz0oW359XHNdKSkpLywvXig/Oi0/WzAtOV0rKD89KFt+fVxzXSkpKS8sL14oPzooW15ccyEiIyUtLFwuXC87LT5AXFstXF5gXHstfl0rKD89KFs9fn1cc1wvLl0pKSkpLywvXig/OlxbW15cXV0qXF0pLywvXig/Oi4pLywvXig/OiQpL107CiAgbGV4ZXIuY29uZGl0aW9ucyA9IHsibXUiOnsicnVsZXMiOls0LDUsNiw3LDgsOSwxMCwxMSwxMiwxMywxNCwxNSwxNiwxNywxOCwxOSwyMCwyMSwyMiwyMywyNCwyNSwyNiwyNywyOCwyOSwzMF0sImluY2x1c2l2ZSI6ZmFsc2V9LCJlbXUiOnsicnVsZXMiOlsyXSwiaW5jbHVzaXZlIjpmYWxzZX0sImNvbSI6eyJydWxlcyI6WzNdLCJpbmNsdXNpdmUiOmZhbHNlfSwiSU5JVElBTCI6eyJydWxlcyI6WzAsMSwzMF0sImluY2x1c2l2ZSI6dHJ1ZX19OwogIHJldHVybiBsZXhlcjt9KSgpCiAgcGFyc2VyLmxleGVyID0gbGV4ZXI7CiAgZnVuY3Rpb24gUGFyc2VyICgpIHsgdGhpcy55eSA9IHt9OyB9UGFyc2VyLnByb3RvdHlwZSA9IHBhcnNlcjtwYXJzZXIuUGFyc2VyID0gUGFyc2VyOwogIHJldHVybiBuZXcgUGFyc2VyOwogIH0pKCk7X19leHBvcnRzX18gPSBoYW5kbGViYXJzOwogIC8qIGpzaGludCBpZ25vcmU6ZW5kICovCiAgcmV0dXJuIF9fZXhwb3J0c19fOwp9KSgpOwoKLy8gaGFuZGxlYmFycy9jb21waWxlci9iYXNlLmpzCnZhciBfX21vZHVsZThfXyA9IChmdW5jdGlvbihfX2RlcGVuZGVuY3kxX18sIF9fZGVwZW5kZW5jeTJfXykgewogICJ1c2Ugc3RyaWN0IjsKICB2YXIgX19leHBvcnRzX18gPSB7fTsKICB2YXIgcGFyc2VyID0gX19kZXBlbmRlbmN5MV9fOwogIHZhciBBU1QgPSBfX2RlcGVuZGVuY3kyX187CgogIF9fZXhwb3J0c19fLnBhcnNlciA9IHBhcnNlcjsKCiAgZnVuY3Rpb24gcGFyc2UoaW5wdXQpIHsKICAgIC8vIEp1c3QgcmV0dXJuIGlmIGFuIGFscmVhZHktY29tcGlsZSBBU1Qgd2FzIHBhc3NlZCBpbi4KICAgIGlmKGlucHV0LmNvbnN0cnVjdG9yID09PSBBU1QuUHJvZ3JhbU5vZGUpIHsgcmV0dXJuIGlucHV0OyB9CgogICAgcGFyc2VyLnl5ID0gQVNUOwogICAgcmV0dXJuIHBhcnNlci5wYXJzZShpbnB1dCk7CiAgfQoKICBfX2V4cG9ydHNfXy5wYXJzZSA9IHBhcnNlOwogIHJldHVybiBfX2V4cG9ydHNfXzsKfSkoX19tb2R1bGU5X18sIF9fbW9kdWxlN19fKTsKCi8vIGhhbmRsZWJhcnMvY29tcGlsZXIvamF2YXNjcmlwdC1jb21waWxlci5qcwp2YXIgX19tb2R1bGUxMV9fID0gKGZ1bmN0aW9uKF9fZGVwZW5kZW5jeTFfXykgewogICJ1c2Ugc3RyaWN0IjsKICB2YXIgX19leHBvcnRzX187CiAgdmFyIENPTVBJTEVSX1JFVklTSU9OID0gX19kZXBlbmRlbmN5MV9fLkNPTVBJTEVSX1JFVklTSU9OOwogIHZhciBSRVZJU0lPTl9DSEFOR0VTID0gX19kZXBlbmRlbmN5MV9fLlJFVklTSU9OX0NIQU5HRVM7CiAgdmFyIGxvZyA9IF9fZGVwZW5kZW5jeTFfXy5sb2c7CgogIGZ1bmN0aW9uIExpdGVyYWwodmFsdWUpIHsKICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICB9CgogIGZ1bmN0aW9uIEphdmFTY3JpcHRDb21waWxlcigpIHt9CgogIEphdmFTY3JpcHRDb21waWxlci5wcm90b3R5cGUgPSB7CiAgICAvLyBQVUJMSUMgQVBJOiBZb3UgY2FuIG92ZXJyaWRlIHRoZXNlIG1ldGhvZHMgaW4gYSBzdWJjbGFzcyB0byBwcm92aWRlCiAgICAvLyBhbHRlcm5hdGl2ZSBjb21waWxlZCBmb3JtcyBmb3IgbmFtZSBsb29rdXAgYW5kIGJ1ZmZlcmluZyBzZW1hbnRpY3MKICAgIG5hbWVMb29rdXA6IGZ1bmN0aW9uKHBhcmVudCwgbmFtZSAvKiAsIHR5cGUqLykgewogICAgICB2YXIgd3JhcCwKICAgICAgICAgIHJldDsKICAgICAgaWYgKHBhcmVudC5pbmRleE9mKCdkZXB0aCcpID09PSAwKSB7CiAgICAgICAgd3JhcCA9IHRydWU7CiAgICAgIH0KCiAgICAgIGlmICgvXlswLTldKyQvLnRlc3QobmFtZSkpIHsKICAgICAgICByZXQgPSBwYXJlbnQgKyAiWyIgKyBuYW1lICsgIl0iOwogICAgICB9IGVsc2UgaWYgKEphdmFTY3JpcHRDb21waWxlci5pc1ZhbGlkSmF2YVNjcmlwdFZhcmlhYmxlTmFtZShuYW1lKSkgewogICAgICAgIHJldCA9IHBhcmVudCArICIuIiArIG5hbWU7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgcmV0ID0gcGFyZW50ICsgIlsnIiArIG5hbWUgKyAiJ10iOwogICAgICB9CgogICAgICBpZiAod3JhcCkgewogICAgICAgIHJldHVybiAnKCcgKyBwYXJlbnQgKyAnICYmICcgKyByZXQgKyAnKSc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHJldDsKICAgICAgfQogICAgfSwKCiAgICBjb21waWxlckluZm86IGZ1bmN0aW9uKCkgewogICAgICB2YXIgcmV2aXNpb24gPSBDT01QSUxFUl9SRVZJU0lPTiwKICAgICAgICAgIHZlcnNpb25zID0gUkVWSVNJT05fQ0hBTkdFU1tyZXZpc2lvbl07CiAgICAgIHJldHVybiAidGhpcy5jb21waWxlckluZm8gPSBbIityZXZpc2lvbisiLCciK3ZlcnNpb25zKyInXTtcbiI7CiAgICB9LAoKICAgIGFwcGVuZFRvQnVmZmVyOiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgaWYgKHRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICByZXR1cm4gInJldHVybiAiICsgc3RyaW5nICsgIjsiOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBhcHBlbmRUb0J1ZmZlcjogdHJ1ZSwKICAgICAgICAgIGNvbnRlbnQ6IHN0cmluZywKICAgICAgICAgIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsgcmV0dXJuICJidWZmZXIgKz0gIiArIHN0cmluZyArICI7IjsgfQogICAgICAgIH07CiAgICAgIH0KICAgIH0sCgogICAgaW5pdGlhbGl6ZUJ1ZmZlcjogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnF1b3RlZFN0cmluZygiIik7CiAgICB9LAoKICAgIG5hbWVzcGFjZTogIkhhbmRsZWJhcnMiLAogICAgLy8gRU5EIFBVQkxJQyBBUEkKCiAgICBjb21waWxlOiBmdW5jdGlvbihlbnZpcm9ubWVudCwgb3B0aW9ucywgY29udGV4dCwgYXNPYmplY3QpIHsKICAgICAgdGhpcy5lbnZpcm9ubWVudCA9IGVudmlyb25tZW50OwogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgICAgbG9nKCdkZWJ1ZycsIHRoaXMuZW52aXJvbm1lbnQuZGlzYXNzZW1ibGUoKSArICJcblxuIik7CgogICAgICB0aGlzLm5hbWUgPSB0aGlzLmVudmlyb25tZW50Lm5hbWU7CiAgICAgIHRoaXMuaXNDaGlsZCA9ICEhY29udGV4dDsKICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dCB8fCB7CiAgICAgICAgcHJvZ3JhbXM6IFtdLAogICAgICAgIGVudmlyb25tZW50czogW10sCiAgICAgICAgYWxpYXNlczogeyB9CiAgICAgIH07CgogICAgICB0aGlzLnByZWFtYmxlKCk7CgogICAgICB0aGlzLnN0YWNrU2xvdCA9IDA7CiAgICAgIHRoaXMuc3RhY2tWYXJzID0gW107CiAgICAgIHRoaXMucmVnaXN0ZXJzID0geyBsaXN0OiBbXSB9OwogICAgICB0aGlzLmNvbXBpbGVTdGFjayA9IFtdOwogICAgICB0aGlzLmlubGluZVN0YWNrID0gW107CgogICAgICB0aGlzLmNvbXBpbGVDaGlsZHJlbihlbnZpcm9ubWVudCwgb3B0aW9ucyk7CgogICAgICB2YXIgb3Bjb2RlcyA9IGVudmlyb25tZW50Lm9wY29kZXMsIG9wY29kZTsKCiAgICAgIHRoaXMuaSA9IDA7CgogICAgICBmb3IodmFyIGw9b3Bjb2Rlcy5sZW5ndGg7IHRoaXMuaTxsOyB0aGlzLmkrKykgewogICAgICAgIG9wY29kZSA9IG9wY29kZXNbdGhpcy5pXTsKCiAgICAgICAgaWYob3Bjb2RlLm9wY29kZSA9PT0gJ0RFQ0xBUkUnKSB7CiAgICAgICAgICB0aGlzW29wY29kZS5uYW1lXSA9IG9wY29kZS52YWx1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpc1tvcGNvZGUub3Bjb2RlXS5hcHBseSh0aGlzLCBvcGNvZGUuYXJncyk7CiAgICAgICAgfQoKICAgICAgICAvLyBSZXNldCB0aGUgc3RyaXBOZXh0IGZsYWcgaWYgaXQgd2FzIG5vdCBzZXQgYnkgdGhpcyBvcGVyYXRpb24uCiAgICAgICAgaWYgKG9wY29kZS5vcGNvZGUgIT09IHRoaXMuc3RyaXBOZXh0KSB7CiAgICAgICAgICB0aGlzLnN0cmlwTmV4dCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gRmx1c2ggYW55IHRyYWlsaW5nIGNvbnRlbnQgdGhhdCBtaWdodCBiZSBwZW5kaW5nLgogICAgICB0aGlzLnB1c2hTb3VyY2UoJycpOwoKICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlRnVuY3Rpb25Db250ZXh0KGFzT2JqZWN0KTsKICAgIH0sCgogICAgcHJlYW1ibGU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb3V0ID0gW107CgogICAgICBpZiAoIXRoaXMuaXNDaGlsZCkgewogICAgICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLm5hbWVzcGFjZTsKCiAgICAgICAgdmFyIGNvcGllcyA9ICJoZWxwZXJzID0gdGhpcy5tZXJnZShoZWxwZXJzLCAiICsgbmFtZXNwYWNlICsgIi5oZWxwZXJzKTsiOwogICAgICAgIGlmICh0aGlzLmVudmlyb25tZW50LnVzZVBhcnRpYWwpIHsgY29waWVzID0gY29waWVzICsgIiBwYXJ0aWFscyA9IHRoaXMubWVyZ2UocGFydGlhbHMsICIgKyBuYW1lc3BhY2UgKyAiLnBhcnRpYWxzKTsiOyB9CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5kYXRhKSB7IGNvcGllcyA9IGNvcGllcyArICIgZGF0YSA9IGRhdGEgfHwge307IjsgfQogICAgICAgIG91dC5wdXNoKGNvcGllcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3V0LnB1c2goJycpOwogICAgICB9CgogICAgICBpZiAoIXRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICBvdXQucHVzaCgiLCBidWZmZXIgPSAiICsgdGhpcy5pbml0aWFsaXplQnVmZmVyKCkpOwogICAgICB9IGVsc2UgewogICAgICAgIG91dC5wdXNoKCIiKTsKICAgICAgfQoKICAgICAgLy8gdHJhY2sgdGhlIGxhc3QgY29udGV4dCBwdXNoZWQgaW50byBwbGFjZSB0byBhbGxvdyBza2lwcGluZyB0aGUKICAgICAgLy8gZ2V0Q29udGV4dCBvcGNvZGUgd2hlbiBpdCB3b3VsZCBiZSBhIG5vb3AKICAgICAgdGhpcy5sYXN0Q29udGV4dCA9IDA7CiAgICAgIHRoaXMuc291cmNlID0gb3V0OwogICAgfSwKCiAgICBjcmVhdGVGdW5jdGlvbkNvbnRleHQ6IGZ1bmN0aW9uKGFzT2JqZWN0KSB7CiAgICAgIHZhciBsb2NhbHMgPSB0aGlzLnN0YWNrVmFycy5jb25jYXQodGhpcy5yZWdpc3RlcnMubGlzdCk7CgogICAgICBpZihsb2NhbHMubGVuZ3RoID4gMCkgewogICAgICAgIHRoaXMuc291cmNlWzFdID0gdGhpcy5zb3VyY2VbMV0gKyAiLCAiICsgbG9jYWxzLmpvaW4oIiwgIik7CiAgICAgIH0KCiAgICAgIC8vIEdlbmVyYXRlIG1pbmltaXplciBhbGlhcyBtYXBwaW5ncwogICAgICBpZiAoIXRoaXMuaXNDaGlsZCkgewogICAgICAgIGZvciAodmFyIGFsaWFzIGluIHRoaXMuY29udGV4dC5hbGlhc2VzKSB7CiAgICAgICAgICBpZiAodGhpcy5jb250ZXh0LmFsaWFzZXMuaGFzT3duUHJvcGVydHkoYWxpYXMpKSB7CiAgICAgICAgICAgIHRoaXMuc291cmNlWzFdID0gdGhpcy5zb3VyY2VbMV0gKyAnLCAnICsgYWxpYXMgKyAnPScgKyB0aGlzLmNvbnRleHQuYWxpYXNlc1thbGlhc107CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5zb3VyY2VbMV0pIHsKICAgICAgICB0aGlzLnNvdXJjZVsxXSA9ICJ2YXIgIiArIHRoaXMuc291cmNlWzFdLnN1YnN0cmluZygyKSArICI7IjsKICAgICAgfQoKICAgICAgLy8gTWVyZ2UgY2hpbGRyZW4KICAgICAgaWYgKCF0aGlzLmlzQ2hpbGQpIHsKICAgICAgICB0aGlzLnNvdXJjZVsxXSArPSAnXG4nICsgdGhpcy5jb250ZXh0LnByb2dyYW1zLmpvaW4oJ1xuJykgKyAnXG4nOwogICAgICB9CgogICAgICBpZiAoIXRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICB0aGlzLnB1c2hTb3VyY2UoInJldHVybiBidWZmZXI7Iik7CiAgICAgIH0KCiAgICAgIHZhciBwYXJhbXMgPSB0aGlzLmlzQ2hpbGQgPyBbImRlcHRoMCIsICJkYXRhIl0gOiBbIkhhbmRsZWJhcnMiLCAiZGVwdGgwIiwgImhlbHBlcnMiLCAicGFydGlhbHMiLCAiZGF0YSJdOwoKICAgICAgZm9yKHZhciBpPTAsIGw9dGhpcy5lbnZpcm9ubWVudC5kZXB0aHMubGlzdC5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgcGFyYW1zLnB1c2goImRlcHRoIiArIHRoaXMuZW52aXJvbm1lbnQuZGVwdGhzLmxpc3RbaV0pOwogICAgICB9CgogICAgICAvLyBQZXJmb3JtIGEgc2Vjb25kIHBhc3Mgb3ZlciB0aGUgb3V0cHV0IHRvIG1lcmdlIGNvbnRlbnQgd2hlbiBwb3NzaWJsZQogICAgICB2YXIgc291cmNlID0gdGhpcy5tZXJnZVNvdXJjZSgpOwoKICAgICAgaWYgKCF0aGlzLmlzQ2hpbGQpIHsKICAgICAgICBzb3VyY2UgPSB0aGlzLmNvbXBpbGVySW5mbygpK3NvdXJjZTsKICAgICAgfQoKICAgICAgaWYgKGFzT2JqZWN0KSB7CiAgICAgICAgcGFyYW1zLnB1c2goc291cmNlKTsKCiAgICAgICAgcmV0dXJuIEZ1bmN0aW9uLmFwcGx5KHRoaXMsIHBhcmFtcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGZ1bmN0aW9uU291cmNlID0gJ2Z1bmN0aW9uICcgKyAodGhpcy5uYW1lIHx8ICcnKSArICcoJyArIHBhcmFtcy5qb2luKCcsJykgKyAnKSB7XG4gICcgKyBzb3VyY2UgKyAnfSc7CiAgICAgICAgbG9nKCdkZWJ1ZycsIGZ1bmN0aW9uU291cmNlICsgIlxuXG4iKTsKICAgICAgICByZXR1cm4gZnVuY3Rpb25Tb3VyY2U7CiAgICAgIH0KICAgIH0sCiAgICBtZXJnZVNvdXJjZTogZnVuY3Rpb24oKSB7CiAgICAgIC8vIFdBUk46IFdlIGFyZSBub3QgaGFuZGxpbmcgdGhlIGNhc2Ugd2hlcmUgYnVmZmVyIGlzIHN0aWxsIHBvcHVsYXRlZCBhcyB0aGUgc291cmNlIHNob3VsZAogICAgICAvLyBub3QgaGF2ZSBidWZmZXIgYXBwZW5kIG9wZXJhdGlvbnMgYXMgdGhlaXIgZmluYWwgYWN0aW9uLgogICAgICB2YXIgc291cmNlID0gJycsCiAgICAgICAgICBidWZmZXI7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLnNvdXJjZS5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgIHZhciBsaW5lID0gdGhpcy5zb3VyY2VbaV07CiAgICAgICAgaWYgKGxpbmUuYXBwZW5kVG9CdWZmZXIpIHsKICAgICAgICAgIGlmIChidWZmZXIpIHsKICAgICAgICAgICAgYnVmZmVyID0gYnVmZmVyICsgJ1xuICAgICsgJyArIGxpbmUuY29udGVudDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJ1ZmZlciA9IGxpbmUuY29udGVudDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKGJ1ZmZlcikgewogICAgICAgICAgICBzb3VyY2UgKz0gJ2J1ZmZlciArPSAnICsgYnVmZmVyICsgJztcbiAgJzsKICAgICAgICAgICAgYnVmZmVyID0gdW5kZWZpbmVkOwogICAgICAgICAgfQogICAgICAgICAgc291cmNlICs9IGxpbmUgKyAnXG4gICc7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBzb3VyY2U7CiAgICB9LAoKICAgIC8vIFtibG9ja1ZhbHVlXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IGhhc2gsIGludmVyc2UsIHByb2dyYW0sIHZhbHVlCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHJldHVybiB2YWx1ZSBvZiBibG9ja0hlbHBlck1pc3NpbmcKICAgIC8vCiAgICAvLyBUaGUgcHVycG9zZSBvZiB0aGlzIG9wY29kZSBpcyB0byB0YWtlIGEgYmxvY2sgb2YgdGhlIGZvcm0KICAgIC8vIGB7eyNmb299fS4uLnt7L2Zvb319YCwgcmVzb2x2ZSB0aGUgdmFsdWUgb2YgYGZvb2AsIGFuZAogICAgLy8gcmVwbGFjZSBpdCBvbiB0aGUgc3RhY2sgd2l0aCB0aGUgcmVzdWx0IG9mIHByb3Blcmx5CiAgICAvLyBpbnZva2luZyBibG9ja0hlbHBlck1pc3NpbmcuCiAgICBibG9ja1ZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuYmxvY2tIZWxwZXJNaXNzaW5nID0gJ2hlbHBlcnMuYmxvY2tIZWxwZXJNaXNzaW5nJzsKCiAgICAgIHZhciBwYXJhbXMgPSBbImRlcHRoMCJdOwogICAgICB0aGlzLnNldHVwUGFyYW1zKDAsIHBhcmFtcyk7CgogICAgICB0aGlzLnJlcGxhY2VTdGFjayhmdW5jdGlvbihjdXJyZW50KSB7CiAgICAgICAgcGFyYW1zLnNwbGljZSgxLCAwLCBjdXJyZW50KTsKICAgICAgICByZXR1cm4gImJsb2NrSGVscGVyTWlzc2luZy5jYWxsKCIgKyBwYXJhbXMuam9pbigiLCAiKSArICIpIjsKICAgICAgfSk7CiAgICB9LAoKICAgIC8vIFthbWJpZ3VvdXNCbG9ja1ZhbHVlXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IGhhc2gsIGludmVyc2UsIHByb2dyYW0sIHZhbHVlCiAgICAvLyBDb21waWxlciB2YWx1ZSwgYmVmb3JlOiBsYXN0SGVscGVyPXZhbHVlIG9mIGxhc3QgZm91bmQgaGVscGVyLCBpZiBhbnkKICAgIC8vIE9uIHN0YWNrLCBhZnRlciwgaWYgbm8gbGFzdEhlbHBlcjogc2FtZSBhcyBbYmxvY2tWYWx1ZV0KICAgIC8vIE9uIHN0YWNrLCBhZnRlciwgaWYgbGFzdEhlbHBlcjogdmFsdWUKICAgIGFtYmlndW91c0Jsb2NrVmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5ibG9ja0hlbHBlck1pc3NpbmcgPSAnaGVscGVycy5ibG9ja0hlbHBlck1pc3NpbmcnOwoKICAgICAgdmFyIHBhcmFtcyA9IFsiZGVwdGgwIl07CiAgICAgIHRoaXMuc2V0dXBQYXJhbXMoMCwgcGFyYW1zKTsKCiAgICAgIHZhciBjdXJyZW50ID0gdGhpcy50b3BTdGFjaygpOwogICAgICBwYXJhbXMuc3BsaWNlKDEsIDAsIGN1cnJlbnQpOwoKICAgICAgLy8gVXNlIHRoZSBvcHRpb25zIHZhbHVlIGdlbmVyYXRlZCBmcm9tIHRoZSBpbnZvY2F0aW9uCiAgICAgIHBhcmFtc1twYXJhbXMubGVuZ3RoLTFdID0gJ29wdGlvbnMnOwoKICAgICAgdGhpcy5wdXNoU291cmNlKCJpZiAoISIgKyB0aGlzLmxhc3RIZWxwZXIgKyAiKSB7ICIgKyBjdXJyZW50ICsgIiA9IGJsb2NrSGVscGVyTWlzc2luZy5jYWxsKCIgKyBwYXJhbXMuam9pbigiLCAiKSArICIpOyB9Iik7CiAgICB9LAoKICAgIC8vIFthcHBlbmRDb250ZW50XQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiAuLi4KICAgIC8vCiAgICAvLyBBcHBlbmRzIHRoZSBzdHJpbmcgdmFsdWUgb2YgYGNvbnRlbnRgIHRvIHRoZSBjdXJyZW50IGJ1ZmZlcgogICAgYXBwZW5kQ29udGVudDogZnVuY3Rpb24oY29udGVudCkgewogICAgICBpZiAodGhpcy5wZW5kaW5nQ29udGVudCkgewogICAgICAgIGNvbnRlbnQgPSB0aGlzLnBlbmRpbmdDb250ZW50ICsgY29udGVudDsKICAgICAgfQogICAgICBpZiAodGhpcy5zdHJpcE5leHQpIHsKICAgICAgICBjb250ZW50ID0gY29udGVudC5yZXBsYWNlKC9eXHMrLywgJycpOwogICAgICB9CgogICAgICB0aGlzLnBlbmRpbmdDb250ZW50ID0gY29udGVudDsKICAgIH0sCgogICAgLy8gW3N0cmlwXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiAuLi4KICAgIC8vCiAgICAvLyBSZW1vdmVzIGFueSB0cmFpbGluZyB3aGl0ZXNwYWNlIGZyb20gdGhlIHByaW9yIGNvbnRlbnQgbm9kZSBhbmQgZmxhZ3MKICAgIC8vIHRoZSBuZXh0IG9wZXJhdGlvbiBmb3Igc3RyaXBwaW5nIGlmIGl0IGlzIGEgY29udGVudCBub2RlLgogICAgc3RyaXA6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy5wZW5kaW5nQ29udGVudCkgewogICAgICAgIHRoaXMucGVuZGluZ0NvbnRlbnQgPSB0aGlzLnBlbmRpbmdDb250ZW50LnJlcGxhY2UoL1xzKyQvLCAnJyk7CiAgICAgIH0KICAgICAgdGhpcy5zdHJpcE5leHQgPSAnc3RyaXAnOwogICAgfSwKCiAgICAvLyBbYXBwZW5kXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogLi4uCiAgICAvLwogICAgLy8gQ29lcmNlcyBgdmFsdWVgIHRvIGEgU3RyaW5nIGFuZCBhcHBlbmRzIGl0IHRvIHRoZSBjdXJyZW50IGJ1ZmZlci4KICAgIC8vCiAgICAvLyBJZiBgdmFsdWVgIGlzIHRydXRoeSwgb3IgMCwgaXQgaXMgY29lcmNlZCBpbnRvIGEgc3RyaW5nIGFuZCBhcHBlbmRlZAogICAgLy8gT3RoZXJ3aXNlLCB0aGUgZW1wdHkgc3RyaW5nIGlzIGFwcGVuZGVkCiAgICBhcHBlbmQ6IGZ1bmN0aW9uKCkgewogICAgICAvLyBGb3JjZSBhbnl0aGluZyB0aGF0IGlzIGlubGluZWQgb250byB0aGUgc3RhY2sgc28gd2UgZG9uJ3QgaGF2ZSBkdXBsaWNhdGlvbgogICAgICAvLyB3aGVuIHdlIGV4YW1pbmUgbG9jYWwKICAgICAgdGhpcy5mbHVzaElubGluZSgpOwogICAgICB2YXIgbG9jYWwgPSB0aGlzLnBvcFN0YWNrKCk7CiAgICAgIHRoaXMucHVzaFNvdXJjZSgiaWYoIiArIGxvY2FsICsgIiB8fCAiICsgbG9jYWwgKyAiID09PSAwKSB7ICIgKyB0aGlzLmFwcGVuZFRvQnVmZmVyKGxvY2FsKSArICIgfSIpOwogICAgICBpZiAodGhpcy5lbnZpcm9ubWVudC5pc1NpbXBsZSkgewogICAgICAgIHRoaXMucHVzaFNvdXJjZSgiZWxzZSB7ICIgKyB0aGlzLmFwcGVuZFRvQnVmZmVyKCInJyIpICsgIiB9Iik7CiAgICAgIH0KICAgIH0sCgogICAgLy8gW2FwcGVuZEVzY2FwZWRdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogdmFsdWUsIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiAuLi4KICAgIC8vCiAgICAvLyBFc2NhcGUgYHZhbHVlYCBhbmQgYXBwZW5kIGl0IHRvIHRoZSBidWZmZXIKICAgIGFwcGVuZEVzY2FwZWQ6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5lc2NhcGVFeHByZXNzaW9uID0gJ3RoaXMuZXNjYXBlRXhwcmVzc2lvbic7CgogICAgICB0aGlzLnB1c2hTb3VyY2UodGhpcy5hcHBlbmRUb0J1ZmZlcigiZXNjYXBlRXhwcmVzc2lvbigiICsgdGhpcy5wb3BTdGFjaygpICsgIikiKSk7CiAgICB9LAoKICAgIC8vIFtnZXRDb250ZXh0XQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiAuLi4KICAgIC8vIENvbXBpbGVyIHZhbHVlLCBhZnRlcjogbGFzdENvbnRleHQ9ZGVwdGgKICAgIC8vCiAgICAvLyBTZXQgdGhlIHZhbHVlIG9mIHRoZSBgbGFzdENvbnRleHRgIGNvbXBpbGVyIHZhbHVlIHRvIHRoZSBkZXB0aAogICAgZ2V0Q29udGV4dDogZnVuY3Rpb24oZGVwdGgpIHsKICAgICAgaWYodGhpcy5sYXN0Q29udGV4dCAhPT0gZGVwdGgpIHsKICAgICAgICB0aGlzLmxhc3RDb250ZXh0ID0gZGVwdGg7CiAgICAgIH0KICAgIH0sCgogICAgLy8gW2xvb2t1cE9uQ29udGV4dF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogY3VycmVudENvbnRleHRbbmFtZV0sIC4uLgogICAgLy8KICAgIC8vIExvb2tzIHVwIHRoZSB2YWx1ZSBvZiBgbmFtZWAgb24gdGhlIGN1cnJlbnQgY29udGV4dCBhbmQgcHVzaGVzCiAgICAvLyBpdCBvbnRvIHRoZSBzdGFjay4KICAgIGxvb2t1cE9uQ29udGV4dDogZnVuY3Rpb24obmFtZSkgewogICAgICB0aGlzLnB1c2godGhpcy5uYW1lTG9va3VwKCdkZXB0aCcgKyB0aGlzLmxhc3RDb250ZXh0LCBuYW1lLCAnY29udGV4dCcpKTsKICAgIH0sCgogICAgLy8gW3B1c2hDb250ZXh0XQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBjdXJyZW50Q29udGV4dCwgLi4uCiAgICAvLwogICAgLy8gUHVzaGVzIHRoZSB2YWx1ZSBvZiB0aGUgY3VycmVudCBjb250ZXh0IG9udG8gdGhlIHN0YWNrLgogICAgcHVzaENvbnRleHQ6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwoJ2RlcHRoJyArIHRoaXMubGFzdENvbnRleHQpOwogICAgfSwKCiAgICAvLyBbcmVzb2x2ZVBvc3NpYmxlTGFtYmRhXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogcmVzb2x2ZWQgdmFsdWUsIC4uLgogICAgLy8KICAgIC8vIElmIHRoZSBgdmFsdWVgIGlzIGEgbGFtYmRhLCByZXBsYWNlIGl0IG9uIHRoZSBzdGFjayBieQogICAgLy8gdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgbGFtYmRhCiAgICByZXNvbHZlUG9zc2libGVMYW1iZGE6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5mdW5jdGlvblR5cGUgPSAnImZ1bmN0aW9uIic7CgogICAgICB0aGlzLnJlcGxhY2VTdGFjayhmdW5jdGlvbihjdXJyZW50KSB7CiAgICAgICAgcmV0dXJuICJ0eXBlb2YgIiArIGN1cnJlbnQgKyAiID09PSBmdW5jdGlvblR5cGUgPyAiICsgY3VycmVudCArICIuYXBwbHkoZGVwdGgwKSA6ICIgKyBjdXJyZW50OwogICAgICB9KTsKICAgIH0sCgogICAgLy8gW2xvb2t1cF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiB2YWx1ZSwgLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHZhbHVlW25hbWVdLCAuLi4KICAgIC8vCiAgICAvLyBSZXBsYWNlIHRoZSB2YWx1ZSBvbiB0aGUgc3RhY2sgd2l0aCB0aGUgcmVzdWx0IG9mIGxvb2tpbmcKICAgIC8vIHVwIGBuYW1lYCBvbiBgdmFsdWVgCiAgICBsb29rdXA6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgdGhpcy5yZXBsYWNlU3RhY2soZnVuY3Rpb24oY3VycmVudCkgewogICAgICAgIHJldHVybiBjdXJyZW50ICsgIiA9PSBudWxsIHx8ICIgKyBjdXJyZW50ICsgIiA9PT0gZmFsc2UgPyAiICsgY3VycmVudCArICIgOiAiICsgdGhpcy5uYW1lTG9va3VwKGN1cnJlbnQsIG5hbWUsICdjb250ZXh0Jyk7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBbbG9va3VwRGF0YV0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogZGF0YSwgLi4uCiAgICAvLwogICAgLy8gUHVzaCB0aGUgZGF0YSBsb29rdXAgb3BlcmF0b3IKICAgIGxvb2t1cERhdGE6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnB1c2goJ2RhdGEnKTsKICAgIH0sCgogICAgLy8gW3B1c2hTdHJpbmdQYXJhbV0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogc3RyaW5nLCBjdXJyZW50Q29udGV4dCwgLi4uCiAgICAvLwogICAgLy8gVGhpcyBvcGNvZGUgaXMgZGVzaWduZWQgZm9yIHVzZSBpbiBzdHJpbmcgbW9kZSwgd2hpY2gKICAgIC8vIHByb3ZpZGVzIHRoZSBzdHJpbmcgdmFsdWUgb2YgYSBwYXJhbWV0ZXIgYWxvbmcgd2l0aCBpdHMKICAgIC8vIGRlcHRoIHJhdGhlciB0aGFuIHJlc29sdmluZyBpdCBpbW1lZGlhdGVseS4KICAgIHB1c2hTdHJpbmdQYXJhbTogZnVuY3Rpb24oc3RyaW5nLCB0eXBlKSB7CiAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbCgnZGVwdGgnICsgdGhpcy5sYXN0Q29udGV4dCk7CgogICAgICB0aGlzLnB1c2hTdHJpbmcodHlwZSk7CgogICAgICBpZiAodHlwZW9mIHN0cmluZyA9PT0gJ3N0cmluZycpIHsKICAgICAgICB0aGlzLnB1c2hTdHJpbmcoc3RyaW5nKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwoc3RyaW5nKTsKICAgICAgfQogICAgfSwKCiAgICBlbXB0eUhhc2g6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwoJ3t9Jyk7CgogICAgICBpZiAodGhpcy5vcHRpb25zLnN0cmluZ1BhcmFtcykgewogICAgICAgIHRoaXMucmVnaXN0ZXIoJ2hhc2hUeXBlcycsICd7fScpOwogICAgICAgIHRoaXMucmVnaXN0ZXIoJ2hhc2hDb250ZXh0cycsICd7fScpOwogICAgICB9CiAgICB9LAogICAgcHVzaEhhc2g6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmhhc2ggPSB7dmFsdWVzOiBbXSwgdHlwZXM6IFtdLCBjb250ZXh0czogW119OwogICAgfSwKICAgIHBvcEhhc2g6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgaGFzaCA9IHRoaXMuaGFzaDsKICAgICAgdGhpcy5oYXNoID0gdW5kZWZpbmVkOwoKICAgICAgaWYgKHRoaXMub3B0aW9ucy5zdHJpbmdQYXJhbXMpIHsKICAgICAgICB0aGlzLnJlZ2lzdGVyKCdoYXNoQ29udGV4dHMnLCAneycgKyBoYXNoLmNvbnRleHRzLmpvaW4oJywnKSArICd9Jyk7CiAgICAgICAgdGhpcy5yZWdpc3RlcignaGFzaFR5cGVzJywgJ3snICsgaGFzaC50eXBlcy5qb2luKCcsJykgKyAnfScpOwogICAgICB9CiAgICAgIHRoaXMucHVzaCgne1xuICAgICcgKyBoYXNoLnZhbHVlcy5qb2luKCcsXG4gICAgJykgKyAnXG4gIH0nKTsKICAgIH0sCgogICAgLy8gW3B1c2hTdHJpbmddCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHF1b3RlZFN0cmluZyhzdHJpbmcpLCAuLi4KICAgIC8vCiAgICAvLyBQdXNoIGEgcXVvdGVkIHZlcnNpb24gb2YgYHN0cmluZ2Agb250byB0aGUgc3RhY2sKICAgIHB1c2hTdHJpbmc6IGZ1bmN0aW9uKHN0cmluZykgewogICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwodGhpcy5xdW90ZWRTdHJpbmcoc3RyaW5nKSk7CiAgICB9LAoKICAgIC8vIFtwdXNoXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBleHByLCAuLi4KICAgIC8vCiAgICAvLyBQdXNoIGFuIGV4cHJlc3Npb24gb250byB0aGUgc3RhY2sKICAgIHB1c2g6IGZ1bmN0aW9uKGV4cHIpIHsKICAgICAgdGhpcy5pbmxpbmVTdGFjay5wdXNoKGV4cHIpOwogICAgICByZXR1cm4gZXhwcjsKICAgIH0sCgogICAgLy8gW3B1c2hMaXRlcmFsXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiB2YWx1ZSwgLi4uCiAgICAvLwogICAgLy8gUHVzaGVzIGEgdmFsdWUgb250byB0aGUgc3RhY2suIFRoaXMgb3BlcmF0aW9uIHByZXZlbnRzCiAgICAvLyB0aGUgY29tcGlsZXIgZnJvbSBjcmVhdGluZyBhIHRlbXBvcmFyeSB2YXJpYWJsZSB0byBob2xkCiAgICAvLyBpdC4KICAgIHB1c2hMaXRlcmFsOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwodmFsdWUpOwogICAgfSwKCiAgICAvLyBbcHVzaFByb2dyYW1dCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHByb2dyYW0oZ3VpZCksIC4uLgogICAgLy8KICAgIC8vIFB1c2ggYSBwcm9ncmFtIGV4cHJlc3Npb24gb250byB0aGUgc3RhY2suIFRoaXMgdGFrZXMKICAgIC8vIGEgY29tcGlsZS10aW1lIGd1aWQgYW5kIGNvbnZlcnRzIGl0IGludG8gYSBydW50aW1lLWFjY2Vzc2libGUKICAgIC8vIGV4cHJlc3Npb24uCiAgICBwdXNoUHJvZ3JhbTogZnVuY3Rpb24oZ3VpZCkgewogICAgICBpZiAoZ3VpZCAhPSBudWxsKSB7CiAgICAgICAgdGhpcy5wdXNoU3RhY2tMaXRlcmFsKHRoaXMucHJvZ3JhbUV4cHJlc3Npb24oZ3VpZCkpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbChudWxsKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBbaW52b2tlSGVscGVyXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IGhhc2gsIGludmVyc2UsIHByb2dyYW0sIHBhcmFtcy4uLiwgLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHJlc3VsdCBvZiBoZWxwZXIgaW52b2NhdGlvbgogICAgLy8KICAgIC8vIFBvcHMgb2ZmIHRoZSBoZWxwZXIncyBwYXJhbWV0ZXJzLCBpbnZva2VzIHRoZSBoZWxwZXIsCiAgICAvLyBhbmQgcHVzaGVzIHRoZSBoZWxwZXIncyByZXR1cm4gdmFsdWUgb250byB0aGUgc3RhY2suCiAgICAvLwogICAgLy8gSWYgdGhlIGhlbHBlciBpcyBub3QgZm91bmQsIGBoZWxwZXJNaXNzaW5nYCBpcyBjYWxsZWQuCiAgICBpbnZva2VIZWxwZXI6IGZ1bmN0aW9uKHBhcmFtU2l6ZSwgbmFtZSkgewogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5oZWxwZXJNaXNzaW5nID0gJ2hlbHBlcnMuaGVscGVyTWlzc2luZyc7CgogICAgICB2YXIgaGVscGVyID0gdGhpcy5sYXN0SGVscGVyID0gdGhpcy5zZXR1cEhlbHBlcihwYXJhbVNpemUsIG5hbWUsIHRydWUpOwogICAgICB2YXIgbm9uSGVscGVyID0gdGhpcy5uYW1lTG9va3VwKCdkZXB0aCcgKyB0aGlzLmxhc3RDb250ZXh0LCBuYW1lLCAnY29udGV4dCcpOwoKICAgICAgdGhpcy5wdXNoKGhlbHBlci5uYW1lICsgJyB8fCAnICsgbm9uSGVscGVyKTsKICAgICAgdGhpcy5yZXBsYWNlU3RhY2soZnVuY3Rpb24obmFtZSkgewogICAgICAgIHJldHVybiBuYW1lICsgJyA/ICcgKyBuYW1lICsgJy5jYWxsKCcgKwogICAgICAgICAgICBoZWxwZXIuY2FsbFBhcmFtcyArICIpICIgKyAiOiBoZWxwZXJNaXNzaW5nLmNhbGwoIiArCiAgICAgICAgICAgIGhlbHBlci5oZWxwZXJNaXNzaW5nUGFyYW1zICsgIikiOwogICAgICB9KTsKICAgIH0sCgogICAgLy8gW2ludm9rZUtub3duSGVscGVyXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IGhhc2gsIGludmVyc2UsIHByb2dyYW0sIHBhcmFtcy4uLiwgLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHJlc3VsdCBvZiBoZWxwZXIgaW52b2NhdGlvbgogICAgLy8KICAgIC8vIFRoaXMgb3BlcmF0aW9uIGlzIHVzZWQgd2hlbiB0aGUgaGVscGVyIGlzIGtub3duIHRvIGV4aXN0LAogICAgLy8gc28gYSBgaGVscGVyTWlzc2luZ2AgZmFsbGJhY2sgaXMgbm90IHJlcXVpcmVkLgogICAgaW52b2tlS25vd25IZWxwZXI6IGZ1bmN0aW9uKHBhcmFtU2l6ZSwgbmFtZSkgewogICAgICB2YXIgaGVscGVyID0gdGhpcy5zZXR1cEhlbHBlcihwYXJhbVNpemUsIG5hbWUpOwogICAgICB0aGlzLnB1c2goaGVscGVyLm5hbWUgKyAiLmNhbGwoIiArIGhlbHBlci5jYWxsUGFyYW1zICsgIikiKTsKICAgIH0sCgogICAgLy8gW2ludm9rZUFtYmlndW91c10KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBoYXNoLCBpbnZlcnNlLCBwcm9ncmFtLCBwYXJhbXMuLi4sIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXN1bHQgb2YgZGlzYW1iaWd1YXRpb24KICAgIC8vCiAgICAvLyBUaGlzIG9wZXJhdGlvbiBpcyB1c2VkIHdoZW4gYW4gZXhwcmVzc2lvbiBsaWtlIGB7e2Zvb319YAogICAgLy8gaXMgcHJvdmlkZWQsIGJ1dCB3ZSBkb24ndCBrbm93IGF0IGNvbXBpbGUtdGltZSB3aGV0aGVyIGl0CiAgICAvLyBpcyBhIGhlbHBlciBvciBhIHBhdGguCiAgICAvLwogICAgLy8gVGhpcyBvcGVyYXRpb24gZW1pdHMgbW9yZSBjb2RlIHRoYW4gdGhlIG90aGVyIG9wdGlvbnMsCiAgICAvLyBhbmQgY2FuIGJlIGF2b2lkZWQgYnkgcGFzc2luZyB0aGUgYGtub3duSGVscGVyc2AgYW5kCiAgICAvLyBga25vd25IZWxwZXJzT25seWAgZmxhZ3MgYXQgY29tcGlsZS10aW1lLgogICAgaW52b2tlQW1iaWd1b3VzOiBmdW5jdGlvbihuYW1lLCBoZWxwZXJDYWxsKSB7CiAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLmZ1bmN0aW9uVHlwZSA9ICciZnVuY3Rpb24iJzsKCiAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbCgne30nKTsgICAgLy8gSGFzaCB2YWx1ZQogICAgICB2YXIgaGVscGVyID0gdGhpcy5zZXR1cEhlbHBlcigwLCBuYW1lLCBoZWxwZXJDYWxsKTsKCiAgICAgIHZhciBoZWxwZXJOYW1lID0gdGhpcy5sYXN0SGVscGVyID0gdGhpcy5uYW1lTG9va3VwKCdoZWxwZXJzJywgbmFtZSwgJ2hlbHBlcicpOwoKICAgICAgdmFyIG5vbkhlbHBlciA9IHRoaXMubmFtZUxvb2t1cCgnZGVwdGgnICsgdGhpcy5sYXN0Q29udGV4dCwgbmFtZSwgJ2NvbnRleHQnKTsKICAgICAgdmFyIG5leHRTdGFjayA9IHRoaXMubmV4dFN0YWNrKCk7CgogICAgICB0aGlzLnB1c2hTb3VyY2UoJ2lmICgnICsgbmV4dFN0YWNrICsgJyA9ICcgKyBoZWxwZXJOYW1lICsgJykgeyAnICsgbmV4dFN0YWNrICsgJyA9ICcgKyBuZXh0U3RhY2sgKyAnLmNhbGwoJyArIGhlbHBlci5jYWxsUGFyYW1zICsgJyk7IH0nKTsKICAgICAgdGhpcy5wdXNoU291cmNlKCdlbHNlIHsgJyArIG5leHRTdGFjayArICcgPSAnICsgbm9uSGVscGVyICsgJzsgJyArIG5leHRTdGFjayArICcgPSB0eXBlb2YgJyArIG5leHRTdGFjayArICcgPT09IGZ1bmN0aW9uVHlwZSA/ICcgKyBuZXh0U3RhY2sgKyAnLmNhbGwoJyArIGhlbHBlci5jYWxsUGFyYW1zICsgJykgOiAnICsgbmV4dFN0YWNrICsgJzsgfScpOwogICAgfSwKCiAgICAvLyBbaW52b2tlUGFydGlhbF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBjb250ZXh0LCAuLi4KICAgIC8vIE9uIHN0YWNrIGFmdGVyOiByZXN1bHQgb2YgcGFydGlhbCBpbnZvY2F0aW9uCiAgICAvLwogICAgLy8gVGhpcyBvcGVyYXRpb24gcG9wcyBvZmYgYSBjb250ZXh0LCBpbnZva2VzIGEgcGFydGlhbCB3aXRoIHRoYXQgY29udGV4dCwKICAgIC8vIGFuZCBwdXNoZXMgdGhlIHJlc3VsdCBvZiB0aGUgaW52b2NhdGlvbiBiYWNrLgogICAgaW52b2tlUGFydGlhbDogZnVuY3Rpb24obmFtZSkgewogICAgICB2YXIgcGFyYW1zID0gW3RoaXMubmFtZUxvb2t1cCgncGFydGlhbHMnLCBuYW1lLCAncGFydGlhbCcpLCAiJyIgKyBuYW1lICsgIiciLCB0aGlzLnBvcFN0YWNrKCksICJoZWxwZXJzIiwgInBhcnRpYWxzIl07CgogICAgICBpZiAodGhpcy5vcHRpb25zLmRhdGEpIHsKICAgICAgICBwYXJhbXMucHVzaCgiZGF0YSIpOwogICAgICB9CgogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5zZWxmID0gInRoaXMiOwogICAgICB0aGlzLnB1c2goInNlbGYuaW52b2tlUGFydGlhbCgiICsgcGFyYW1zLmpvaW4oIiwgIikgKyAiKSIpOwogICAgfSwKCiAgICAvLyBbYXNzaWduVG9IYXNoXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCBoYXNoLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogaGFzaCwgLi4uCiAgICAvLwogICAgLy8gUG9wcyBhIHZhbHVlIGFuZCBoYXNoIG9mZiB0aGUgc3RhY2ssIGFzc2lnbnMgYGhhc2hba2V5XSA9IHZhbHVlYAogICAgLy8gYW5kIHB1c2hlcyB0aGUgaGFzaCBiYWNrIG9udG8gdGhlIHN0YWNrLgogICAgYXNzaWduVG9IYXNoOiBmdW5jdGlvbihrZXkpIHsKICAgICAgdmFyIHZhbHVlID0gdGhpcy5wb3BTdGFjaygpLAogICAgICAgICAgY29udGV4dCwKICAgICAgICAgIHR5cGU7CgogICAgICBpZiAodGhpcy5vcHRpb25zLnN0cmluZ1BhcmFtcykgewogICAgICAgIHR5cGUgPSB0aGlzLnBvcFN0YWNrKCk7CiAgICAgICAgY29udGV4dCA9IHRoaXMucG9wU3RhY2soKTsKICAgICAgfQoKICAgICAgdmFyIGhhc2ggPSB0aGlzLmhhc2g7CiAgICAgIGlmIChjb250ZXh0KSB7CiAgICAgICAgaGFzaC5jb250ZXh0cy5wdXNoKCInIiArIGtleSArICInOiAiICsgY29udGV4dCk7CiAgICAgIH0KICAgICAgaWYgKHR5cGUpIHsKICAgICAgICBoYXNoLnR5cGVzLnB1c2goIiciICsga2V5ICsgIic6ICIgKyB0eXBlKTsKICAgICAgfQogICAgICBoYXNoLnZhbHVlcy5wdXNoKCInIiArIGtleSArICInOiAoIiArIHZhbHVlICsgIikiKTsKICAgIH0sCgogICAgLy8gSEVMUEVSUwoKICAgIGNvbXBpbGVyOiBKYXZhU2NyaXB0Q29tcGlsZXIsCgogICAgY29tcGlsZUNoaWxkcmVuOiBmdW5jdGlvbihlbnZpcm9ubWVudCwgb3B0aW9ucykgewogICAgICB2YXIgY2hpbGRyZW4gPSBlbnZpcm9ubWVudC5jaGlsZHJlbiwgY2hpbGQsIGNvbXBpbGVyOwoKICAgICAgZm9yKHZhciBpPTAsIGw9Y2hpbGRyZW4ubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIGNoaWxkID0gY2hpbGRyZW5baV07CiAgICAgICAgY29tcGlsZXIgPSBuZXcgdGhpcy5jb21waWxlcigpOwoKICAgICAgICB2YXIgaW5kZXggPSB0aGlzLm1hdGNoRXhpc3RpbmdQcm9ncmFtKGNoaWxkKTsKCiAgICAgICAgaWYgKGluZGV4ID09IG51bGwpIHsKICAgICAgICAgIHRoaXMuY29udGV4dC5wcm9ncmFtcy5wdXNoKCcnKTsgICAgIC8vIFBsYWNlaG9sZGVyIHRvIHByZXZlbnQgbmFtZSBjb25mbGljdHMgZm9yIG5lc3RlZCBjaGlsZHJlbgogICAgICAgICAgaW5kZXggPSB0aGlzLmNvbnRleHQucHJvZ3JhbXMubGVuZ3RoOwogICAgICAgICAgY2hpbGQuaW5kZXggPSBpbmRleDsKICAgICAgICAgIGNoaWxkLm5hbWUgPSAncHJvZ3JhbScgKyBpbmRleDsKICAgICAgICAgIHRoaXMuY29udGV4dC5wcm9ncmFtc1tpbmRleF0gPSBjb21waWxlci5jb21waWxlKGNoaWxkLCBvcHRpb25zLCB0aGlzLmNvbnRleHQpOwogICAgICAgICAgdGhpcy5jb250ZXh0LmVudmlyb25tZW50c1tpbmRleF0gPSBjaGlsZDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2hpbGQuaW5kZXggPSBpbmRleDsKICAgICAgICAgIGNoaWxkLm5hbWUgPSAncHJvZ3JhbScgKyBpbmRleDsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBtYXRjaEV4aXN0aW5nUHJvZ3JhbTogZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMuY29udGV4dC5lbnZpcm9ubWVudHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICB2YXIgZW52aXJvbm1lbnQgPSB0aGlzLmNvbnRleHQuZW52aXJvbm1lbnRzW2ldOwogICAgICAgIGlmIChlbnZpcm9ubWVudCAmJiBlbnZpcm9ubWVudC5lcXVhbHMoY2hpbGQpKSB7CiAgICAgICAgICByZXR1cm4gaTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgcHJvZ3JhbUV4cHJlc3Npb246IGZ1bmN0aW9uKGd1aWQpIHsKICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuc2VsZiA9ICJ0aGlzIjsKCiAgICAgIGlmKGd1aWQgPT0gbnVsbCkgewogICAgICAgIHJldHVybiAic2VsZi5ub29wIjsKICAgICAgfQoKICAgICAgdmFyIGNoaWxkID0gdGhpcy5lbnZpcm9ubWVudC5jaGlsZHJlbltndWlkXSwKICAgICAgICAgIGRlcHRocyA9IGNoaWxkLmRlcHRocy5saXN0LCBkZXB0aDsKCiAgICAgIHZhciBwcm9ncmFtUGFyYW1zID0gW2NoaWxkLmluZGV4LCBjaGlsZC5uYW1lLCAiZGF0YSJdOwoKICAgICAgZm9yKHZhciBpPTAsIGwgPSBkZXB0aHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIGRlcHRoID0gZGVwdGhzW2ldOwoKICAgICAgICBpZihkZXB0aCA9PT0gMSkgeyBwcm9ncmFtUGFyYW1zLnB1c2goImRlcHRoMCIpOyB9CiAgICAgICAgZWxzZSB7IHByb2dyYW1QYXJhbXMucHVzaCgiZGVwdGgiICsgKGRlcHRoIC0gMSkpOyB9CiAgICAgIH0KCiAgICAgIHJldHVybiAoZGVwdGhzLmxlbmd0aCA9PT0gMCA/ICJzZWxmLnByb2dyYW0oIiA6ICJzZWxmLnByb2dyYW1XaXRoRGVwdGgoIikgKyBwcm9ncmFtUGFyYW1zLmpvaW4oIiwgIikgKyAiKSI7CiAgICB9LAoKICAgIHJlZ2lzdGVyOiBmdW5jdGlvbihuYW1lLCB2YWwpIHsKICAgICAgdGhpcy51c2VSZWdpc3RlcihuYW1lKTsKICAgICAgdGhpcy5wdXNoU291cmNlKG5hbWUgKyAiID0gIiArIHZhbCArICI7Iik7CiAgICB9LAoKICAgIHVzZVJlZ2lzdGVyOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIGlmKCF0aGlzLnJlZ2lzdGVyc1tuYW1lXSkgewogICAgICAgIHRoaXMucmVnaXN0ZXJzW25hbWVdID0gdHJ1ZTsKICAgICAgICB0aGlzLnJlZ2lzdGVycy5saXN0LnB1c2gobmFtZSk7CiAgICAgIH0KICAgIH0sCgogICAgcHVzaFN0YWNrTGl0ZXJhbDogZnVuY3Rpb24oaXRlbSkgewogICAgICByZXR1cm4gdGhpcy5wdXNoKG5ldyBMaXRlcmFsKGl0ZW0pKTsKICAgIH0sCgogICAgcHVzaFNvdXJjZTogZnVuY3Rpb24oc291cmNlKSB7CiAgICAgIGlmICh0aGlzLnBlbmRpbmdDb250ZW50KSB7CiAgICAgICAgdGhpcy5zb3VyY2UucHVzaCh0aGlzLmFwcGVuZFRvQnVmZmVyKHRoaXMucXVvdGVkU3RyaW5nKHRoaXMucGVuZGluZ0NvbnRlbnQpKSk7CiAgICAgICAgdGhpcy5wZW5kaW5nQ29udGVudCA9IHVuZGVmaW5lZDsKICAgICAgfQoKICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgIHRoaXMuc291cmNlLnB1c2goc291cmNlKTsKICAgICAgfQogICAgfSwKCiAgICBwdXNoU3RhY2s6IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgdGhpcy5mbHVzaElubGluZSgpOwoKICAgICAgdmFyIHN0YWNrID0gdGhpcy5pbmNyU3RhY2soKTsKICAgICAgaWYgKGl0ZW0pIHsKICAgICAgICB0aGlzLnB1c2hTb3VyY2Uoc3RhY2sgKyAiID0gIiArIGl0ZW0gKyAiOyIpOwogICAgICB9CiAgICAgIHRoaXMuY29tcGlsZVN0YWNrLnB1c2goc3RhY2spOwogICAgICByZXR1cm4gc3RhY2s7CiAgICB9LAoKICAgIHJlcGxhY2VTdGFjazogZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgdmFyIHByZWZpeCA9ICcnLAogICAgICAgICAgaW5saW5lID0gdGhpcy5pc0lubGluZSgpLAogICAgICAgICAgc3RhY2s7CgogICAgICAvLyBJZiB3ZSBhcmUgY3VycmVudGx5IGlubGluZSB0aGVuIHdlIHdhbnQgdG8gbWVyZ2UgdGhlIGlubGluZSBzdGF0ZW1lbnQgaW50byB0aGUKICAgICAgLy8gcmVwbGFjZW1lbnQgc3RhdGVtZW50IHZpYSAnLCcKICAgICAgaWYgKGlubGluZSkgewogICAgICAgIHZhciB0b3AgPSB0aGlzLnBvcFN0YWNrKHRydWUpOwoKICAgICAgICBpZiAodG9wIGluc3RhbmNlb2YgTGl0ZXJhbCkgewogICAgICAgICAgLy8gTGl0ZXJhbHMgZG8gbm90IG5lZWQgdG8gYmUgaW5saW5lZAogICAgICAgICAgc3RhY2sgPSB0b3AudmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIEdldCBvciBjcmVhdGUgdGhlIGN1cnJlbnQgc3RhY2sgbmFtZSBmb3IgdXNlIGJ5IHRoZSBpbmxpbmUKICAgICAgICAgIHZhciBuYW1lID0gdGhpcy5zdGFja1Nsb3QgPyB0aGlzLnRvcFN0YWNrTmFtZSgpIDogdGhpcy5pbmNyU3RhY2soKTsKCiAgICAgICAgICBwcmVmaXggPSAnKCcgKyB0aGlzLnB1c2gobmFtZSkgKyAnID0gJyArIHRvcCArICcpLCc7CiAgICAgICAgICBzdGFjayA9IHRoaXMudG9wU3RhY2soKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RhY2sgPSB0aGlzLnRvcFN0YWNrKCk7CiAgICAgIH0KCiAgICAgIHZhciBpdGVtID0gY2FsbGJhY2suY2FsbCh0aGlzLCBzdGFjayk7CgogICAgICBpZiAoaW5saW5lKSB7CiAgICAgICAgaWYgKHRoaXMuaW5saW5lU3RhY2subGVuZ3RoIHx8IHRoaXMuY29tcGlsZVN0YWNrLmxlbmd0aCkgewogICAgICAgICAgdGhpcy5wb3BTdGFjaygpOwogICAgICAgIH0KICAgICAgICB0aGlzLnB1c2goJygnICsgcHJlZml4ICsgaXRlbSArICcpJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gUHJldmVudCBtb2RpZmljYXRpb24gb2YgdGhlIGNvbnRleHQgZGVwdGggdmFyaWFibGUuIFRocm91Z2ggcmVwbGFjZVN0YWNrCiAgICAgICAgaWYgKCEvXnN0YWNrLy50ZXN0KHN0YWNrKSkgewogICAgICAgICAgc3RhY2sgPSB0aGlzLm5leHRTdGFjaygpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5wdXNoU291cmNlKHN0YWNrICsgIiA9ICgiICsgcHJlZml4ICsgaXRlbSArICIpOyIpOwogICAgICB9CiAgICAgIHJldHVybiBzdGFjazsKICAgIH0sCgogICAgbmV4dFN0YWNrOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKCk7CiAgICB9LAoKICAgIGluY3JTdGFjazogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuc3RhY2tTbG90Kys7CiAgICAgIGlmKHRoaXMuc3RhY2tTbG90ID4gdGhpcy5zdGFja1ZhcnMubGVuZ3RoKSB7IHRoaXMuc3RhY2tWYXJzLnB1c2goInN0YWNrIiArIHRoaXMuc3RhY2tTbG90KTsgfQogICAgICByZXR1cm4gdGhpcy50b3BTdGFja05hbWUoKTsKICAgIH0sCiAgICB0b3BTdGFja05hbWU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gInN0YWNrIiArIHRoaXMuc3RhY2tTbG90OwogICAgfSwKICAgIGZsdXNoSW5saW5lOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGlubGluZVN0YWNrID0gdGhpcy5pbmxpbmVTdGFjazsKICAgICAgaWYgKGlubGluZVN0YWNrLmxlbmd0aCkgewogICAgICAgIHRoaXMuaW5saW5lU3RhY2sgPSBbXTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gaW5saW5lU3RhY2subGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIHZhciBlbnRyeSA9IGlubGluZVN0YWNrW2ldOwogICAgICAgICAgaWYgKGVudHJ5IGluc3RhbmNlb2YgTGl0ZXJhbCkgewogICAgICAgICAgICB0aGlzLmNvbXBpbGVTdGFjay5wdXNoKGVudHJ5KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMucHVzaFN0YWNrKGVudHJ5KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBpc0lubGluZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmlubGluZVN0YWNrLmxlbmd0aDsKICAgIH0sCgogICAgcG9wU3RhY2s6IGZ1bmN0aW9uKHdyYXBwZWQpIHsKICAgICAgdmFyIGlubGluZSA9IHRoaXMuaXNJbmxpbmUoKSwKICAgICAgICAgIGl0ZW0gPSAoaW5saW5lID8gdGhpcy5pbmxpbmVTdGFjayA6IHRoaXMuY29tcGlsZVN0YWNrKS5wb3AoKTsKCiAgICAgIGlmICghd3JhcHBlZCAmJiAoaXRlbSBpbnN0YW5jZW9mIExpdGVyYWwpKSB7CiAgICAgICAgcmV0dXJuIGl0ZW0udmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCFpbmxpbmUpIHsKICAgICAgICAgIHRoaXMuc3RhY2tTbG90LS07CiAgICAgICAgfQogICAgICAgIHJldHVybiBpdGVtOwogICAgICB9CiAgICB9LAoKICAgIHRvcFN0YWNrOiBmdW5jdGlvbih3cmFwcGVkKSB7CiAgICAgIHZhciBzdGFjayA9ICh0aGlzLmlzSW5saW5lKCkgPyB0aGlzLmlubGluZVN0YWNrIDogdGhpcy5jb21waWxlU3RhY2spLAogICAgICAgICAgaXRlbSA9IHN0YWNrW3N0YWNrLmxlbmd0aCAtIDFdOwoKICAgICAgaWYgKCF3cmFwcGVkICYmIChpdGVtIGluc3RhbmNlb2YgTGl0ZXJhbCkpIHsKICAgICAgICByZXR1cm4gaXRlbS52YWx1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gaXRlbTsKICAgICAgfQogICAgfSwKCiAgICBxdW90ZWRTdHJpbmc6IGZ1bmN0aW9uKHN0cikgewogICAgICByZXR1cm4gJyInICsgc3RyCiAgICAgICAgLnJlcGxhY2UoL1xcL2csICdcXFxcJykKICAgICAgICAucmVwbGFjZSgvIi9nLCAnXFwiJykKICAgICAgICAucmVwbGFjZSgvXG4vZywgJ1xcbicpCiAgICAgICAgLnJlcGxhY2UoL1xyL2csICdcXHInKQogICAgICAgIC5yZXBsYWNlKC9cdTIwMjgvZywgJ1xcdTIwMjgnKSAgIC8vIFBlciBFY21hLTI2MiA3LjMgKyA3LjguNAogICAgICAgIC5yZXBsYWNlKC9cdTIwMjkvZywgJ1xcdTIwMjknKSArICciJzsKICAgIH0sCgogICAgc2V0dXBIZWxwZXI6IGZ1bmN0aW9uKHBhcmFtU2l6ZSwgbmFtZSwgbWlzc2luZ1BhcmFtcykgewogICAgICB2YXIgcGFyYW1zID0gW107CiAgICAgIHRoaXMuc2V0dXBQYXJhbXMocGFyYW1TaXplLCBwYXJhbXMsIG1pc3NpbmdQYXJhbXMpOwogICAgICB2YXIgZm91bmRIZWxwZXIgPSB0aGlzLm5hbWVMb29rdXAoJ2hlbHBlcnMnLCBuYW1lLCAnaGVscGVyJyk7CgogICAgICByZXR1cm4gewogICAgICAgIHBhcmFtczogcGFyYW1zLAogICAgICAgIG5hbWU6IGZvdW5kSGVscGVyLAogICAgICAgIGNhbGxQYXJhbXM6IFsiZGVwdGgwIl0uY29uY2F0KHBhcmFtcykuam9pbigiLCAiKSwKICAgICAgICBoZWxwZXJNaXNzaW5nUGFyYW1zOiBtaXNzaW5nUGFyYW1zICYmIFsiZGVwdGgwIiwgdGhpcy5xdW90ZWRTdHJpbmcobmFtZSldLmNvbmNhdChwYXJhbXMpLmpvaW4oIiwgIikKICAgICAgfTsKICAgIH0sCgogICAgLy8gdGhlIHBhcmFtcyBhbmQgY29udGV4dHMgYXJndW1lbnRzIGFyZSBwYXNzZWQgaW4gYXJyYXlzCiAgICAvLyB0byBmaWxsIGluCiAgICBzZXR1cFBhcmFtczogZnVuY3Rpb24ocGFyYW1TaXplLCBwYXJhbXMsIHVzZVJlZ2lzdGVyKSB7CiAgICAgIHZhciBvcHRpb25zID0gW10sIGNvbnRleHRzID0gW10sIHR5cGVzID0gW10sIHBhcmFtLCBpbnZlcnNlLCBwcm9ncmFtOwoKICAgICAgb3B0aW9ucy5wdXNoKCJoYXNoOiIgKyB0aGlzLnBvcFN0YWNrKCkpOwoKICAgICAgaW52ZXJzZSA9IHRoaXMucG9wU3RhY2soKTsKICAgICAgcHJvZ3JhbSA9IHRoaXMucG9wU3RhY2soKTsKCiAgICAgIC8vIEF2b2lkIHNldHRpbmcgZm4gYW5kIGludmVyc2UgaWYgbmVpdGhlciBhcmUgc2V0LiBUaGlzIGFsbG93cwogICAgICAvLyBoZWxwZXJzIHRvIGRvIGEgY2hlY2sgZm9yIGBpZiAob3B0aW9ucy5mbilgCiAgICAgIGlmIChwcm9ncmFtIHx8IGludmVyc2UpIHsKICAgICAgICBpZiAoIXByb2dyYW0pIHsKICAgICAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLnNlbGYgPSAidGhpcyI7CiAgICAgICAgICBwcm9ncmFtID0gInNlbGYubm9vcCI7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWludmVyc2UpIHsKICAgICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuc2VsZiA9ICJ0aGlzIjsKICAgICAgICAgIGludmVyc2UgPSAic2VsZi5ub29wIjsKICAgICAgICB9CgogICAgICAgIG9wdGlvbnMucHVzaCgiaW52ZXJzZToiICsgaW52ZXJzZSk7CiAgICAgICAgb3B0aW9ucy5wdXNoKCJmbjoiICsgcHJvZ3JhbSk7CiAgICAgIH0KCiAgICAgIGZvcih2YXIgaT0wOyBpPHBhcmFtU2l6ZTsgaSsrKSB7CiAgICAgICAgcGFyYW0gPSB0aGlzLnBvcFN0YWNrKCk7CiAgICAgICAgcGFyYW1zLnB1c2gocGFyYW0pOwoKICAgICAgICBpZih0aGlzLm9wdGlvbnMuc3RyaW5nUGFyYW1zKSB7CiAgICAgICAgICB0eXBlcy5wdXNoKHRoaXMucG9wU3RhY2soKSk7CiAgICAgICAgICBjb250ZXh0cy5wdXNoKHRoaXMucG9wU3RhY2soKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5vcHRpb25zLnN0cmluZ1BhcmFtcykgewogICAgICAgIG9wdGlvbnMucHVzaCgiY29udGV4dHM6WyIgKyBjb250ZXh0cy5qb2luKCIsIikgKyAiXSIpOwogICAgICAgIG9wdGlvbnMucHVzaCgidHlwZXM6WyIgKyB0eXBlcy5qb2luKCIsIikgKyAiXSIpOwogICAgICAgIG9wdGlvbnMucHVzaCgiaGFzaENvbnRleHRzOmhhc2hDb250ZXh0cyIpOwogICAgICAgIG9wdGlvbnMucHVzaCgiaGFzaFR5cGVzOmhhc2hUeXBlcyIpOwogICAgICB9CgogICAgICBpZih0aGlzLm9wdGlvbnMuZGF0YSkgewogICAgICAgIG9wdGlvbnMucHVzaCgiZGF0YTpkYXRhIik7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgPSAieyIgKyBvcHRpb25zLmpvaW4oIiwiKSArICJ9IjsKICAgICAgaWYgKHVzZVJlZ2lzdGVyKSB7CiAgICAgICAgdGhpcy5yZWdpc3Rlcignb3B0aW9ucycsIG9wdGlvbnMpOwogICAgICAgIHBhcmFtcy5wdXNoKCdvcHRpb25zJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGFyYW1zLnB1c2gob3B0aW9ucyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHBhcmFtcy5qb2luKCIsICIpOwogICAgfQogIH07CgogIHZhciByZXNlcnZlZFdvcmRzID0gKAogICAgImJyZWFrIGVsc2UgbmV3IHZhciIgKwogICAgIiBjYXNlIGZpbmFsbHkgcmV0dXJuIHZvaWQiICsKICAgICIgY2F0Y2ggZm9yIHN3aXRjaCB3aGlsZSIgKwogICAgIiBjb250aW51ZSBmdW5jdGlvbiB0aGlzIHdpdGgiICsKICAgICIgZGVmYXVsdCBpZiB0aHJvdyIgKwogICAgIiBkZWxldGUgaW4gdHJ5IiArCiAgICAiIGRvIGluc3RhbmNlb2YgdHlwZW9mIiArCiAgICAiIGFic3RyYWN0IGVudW0gaW50IHNob3J0IiArCiAgICAiIGJvb2xlYW4gZXhwb3J0IGludGVyZmFjZSBzdGF0aWMiICsKICAgICIgYnl0ZSBleHRlbmRzIGxvbmcgc3VwZXIiICsKICAgICIgY2hhciBmaW5hbCBuYXRpdmUgc3luY2hyb25pemVkIiArCiAgICAiIGNsYXNzIGZsb2F0IHBhY2thZ2UgdGhyb3dzIiArCiAgICAiIGNvbnN0IGdvdG8gcHJpdmF0ZSB0cmFuc2llbnQiICsKICAgICIgZGVidWdnZXIgaW1wbGVtZW50cyBwcm90ZWN0ZWQgdm9sYXRpbGUiICsKICAgICIgZG91YmxlIGltcG9ydCBwdWJsaWMgbGV0IHlpZWxkIgogICkuc3BsaXQoIiAiKTsKCiAgdmFyIGNvbXBpbGVyV29yZHMgPSBKYXZhU2NyaXB0Q29tcGlsZXIuUkVTRVJWRURfV09SRFMgPSB7fTsKCiAgZm9yKHZhciBpPTAsIGw9cmVzZXJ2ZWRXb3Jkcy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICBjb21waWxlcldvcmRzW3Jlc2VydmVkV29yZHNbaV1dID0gdHJ1ZTsKICB9CgogIEphdmFTY3JpcHRDb21waWxlci5pc1ZhbGlkSmF2YVNjcmlwdFZhcmlhYmxlTmFtZSA9IGZ1bmN0aW9uKG5hbWUpIHsKICAgIGlmKCFKYXZhU2NyaXB0Q29tcGlsZXIuUkVTRVJWRURfV09SRFNbbmFtZV0gJiYgL15bYS16QS1aXyRdWzAtOWEtekEtWl8kXSokLy50ZXN0KG5hbWUpKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH07CgogIF9fZXhwb3J0c19fID0gSmF2YVNjcmlwdENvbXBpbGVyOwogIHJldHVybiBfX2V4cG9ydHNfXzsKfSkoX19tb2R1bGUyX18pOwoKLy8gaGFuZGxlYmFycy9jb21waWxlci9jb21waWxlci5qcwp2YXIgX19tb2R1bGUxMF9fID0gKGZ1bmN0aW9uKF9fZGVwZW5kZW5jeTFfXywgX19kZXBlbmRlbmN5Ml9fLCBfX2RlcGVuZGVuY3kzX18sIF9fZGVwZW5kZW5jeTRfXykgewogICJ1c2Ugc3RyaWN0IjsKICB2YXIgX19leHBvcnRzX18gPSB7fTsKICB2YXIgRXhjZXB0aW9uID0gX19kZXBlbmRlbmN5MV9fOwogIHZhciBwYXJzZSA9IF9fZGVwZW5kZW5jeTJfXy5wYXJzZTsKICB2YXIgSmF2YVNjcmlwdENvbXBpbGVyID0gX19kZXBlbmRlbmN5M19fOwogIHZhciBBU1QgPSBfX2RlcGVuZGVuY3k0X187CgogIGZ1bmN0aW9uIENvbXBpbGVyKCkge30KCiAgX19leHBvcnRzX18uQ29tcGlsZXIgPSBDb21waWxlcjsvLyB0aGUgZm91bmRIZWxwZXIgcmVnaXN0ZXIgd2lsbCBkaXNhbWJpZ3VhdGUgaGVscGVyIGxvb2t1cCBmcm9tIGZpbmRpbmcgYQogIC8vIGZ1bmN0aW9uIGluIGEgY29udGV4dC4gVGhpcyBpcyBuZWNlc3NhcnkgZm9yIG11c3RhY2hlIGNvbXBhdGliaWxpdHksIHdoaWNoCiAgLy8gcmVxdWlyZXMgdGhhdCBjb250ZXh0IGZ1bmN0aW9ucyBpbiBibG9ja3MgYXJlIGV2YWx1YXRlZCBieSBibG9ja0hlbHBlck1pc3NpbmcsCiAgLy8gYW5kIHRoZW4gcHJvY2VlZCBhcyBpZiB0aGUgcmVzdWx0aW5nIHZhbHVlIHdhcyBwcm92aWRlZCB0byBibG9ja0hlbHBlck1pc3NpbmcuCgogIENvbXBpbGVyLnByb3RvdHlwZSA9IHsKICAgIGNvbXBpbGVyOiBDb21waWxlciwKCiAgICBkaXNhc3NlbWJsZTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBvcGNvZGVzID0gdGhpcy5vcGNvZGVzLCBvcGNvZGUsIG91dCA9IFtdLCBwYXJhbXMsIHBhcmFtOwoKICAgICAgZm9yICh2YXIgaT0wLCBsPW9wY29kZXMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIG9wY29kZSA9IG9wY29kZXNbaV07CgogICAgICAgIGlmIChvcGNvZGUub3Bjb2RlID09PSAnREVDTEFSRScpIHsKICAgICAgICAgIG91dC5wdXNoKCJERUNMQVJFICIgKyBvcGNvZGUubmFtZSArICI9IiArIG9wY29kZS52YWx1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHBhcmFtcyA9IFtdOwogICAgICAgICAgZm9yICh2YXIgaj0wOyBqPG9wY29kZS5hcmdzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgIHBhcmFtID0gb3Bjb2RlLmFyZ3Nbal07CiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW0gPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgcGFyYW0gPSAiXCIiICsgcGFyYW0ucmVwbGFjZSgiXG4iLCAiXFxuIikgKyAiXCIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBhcmFtcy5wdXNoKHBhcmFtKTsKICAgICAgICAgIH0KICAgICAgICAgIG91dC5wdXNoKG9wY29kZS5vcGNvZGUgKyAiICIgKyBwYXJhbXMuam9pbigiICIpKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBvdXQuam9pbigiXG4iKTsKICAgIH0sCgogICAgZXF1YWxzOiBmdW5jdGlvbihvdGhlcikgewogICAgICB2YXIgbGVuID0gdGhpcy5vcGNvZGVzLmxlbmd0aDsKICAgICAgaWYgKG90aGVyLm9wY29kZXMubGVuZ3RoICE9PSBsZW4pIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICB2YXIgb3Bjb2RlID0gdGhpcy5vcGNvZGVzW2ldLAogICAgICAgICAgICBvdGhlck9wY29kZSA9IG90aGVyLm9wY29kZXNbaV07CiAgICAgICAgaWYgKG9wY29kZS5vcGNvZGUgIT09IG90aGVyT3Bjb2RlLm9wY29kZSB8fCBvcGNvZGUuYXJncy5sZW5ndGggIT09IG90aGVyT3Bjb2RlLmFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgb3Bjb2RlLmFyZ3MubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGlmIChvcGNvZGUuYXJnc1tqXSAhPT0gb3RoZXJPcGNvZGUuYXJnc1tqXSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBsZW4gPSB0aGlzLmNoaWxkcmVuLmxlbmd0aDsKICAgICAgaWYgKG90aGVyLmNoaWxkcmVuLmxlbmd0aCAhPT0gbGVuKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgIGlmICghdGhpcy5jaGlsZHJlbltpXS5lcXVhbHMob3RoZXIuY2hpbGRyZW5baV0pKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCgogICAgZ3VpZDogMCwKCiAgICBjb21waWxlOiBmdW5jdGlvbihwcm9ncmFtLCBvcHRpb25zKSB7CiAgICAgIHRoaXMub3Bjb2RlcyA9IFtdOwogICAgICB0aGlzLmNoaWxkcmVuID0gW107CiAgICAgIHRoaXMuZGVwdGhzID0ge2xpc3Q6IFtdfTsKICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKCiAgICAgIC8vIFRoZXNlIGNoYW5nZXMgd2lsbCBwcm9wYWdhdGUgdG8gdGhlIG90aGVyIGNvbXBpbGVyIGNvbXBvbmVudHMKICAgICAgdmFyIGtub3duSGVscGVycyA9IHRoaXMub3B0aW9ucy5rbm93bkhlbHBlcnM7CiAgICAgIHRoaXMub3B0aW9ucy5rbm93bkhlbHBlcnMgPSB7CiAgICAgICAgJ2hlbHBlck1pc3NpbmcnOiB0cnVlLAogICAgICAgICdibG9ja0hlbHBlck1pc3NpbmcnOiB0cnVlLAogICAgICAgICdlYWNoJzogdHJ1ZSwKICAgICAgICAnaWYnOiB0cnVlLAogICAgICAgICd1bmxlc3MnOiB0cnVlLAogICAgICAgICd3aXRoJzogdHJ1ZSwKICAgICAgICAnbG9nJzogdHJ1ZQogICAgICB9OwogICAgICBpZiAoa25vd25IZWxwZXJzKSB7CiAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBrbm93bkhlbHBlcnMpIHsKICAgICAgICAgIHRoaXMub3B0aW9ucy5rbm93bkhlbHBlcnNbbmFtZV0gPSBrbm93bkhlbHBlcnNbbmFtZV07CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5hY2NlcHQocHJvZ3JhbSk7CiAgICB9LAoKICAgIGFjY2VwdDogZnVuY3Rpb24obm9kZSkgewogICAgICB2YXIgc3RyaXAgPSBub2RlLnN0cmlwIHx8IHt9LAogICAgICAgICAgcmV0OwogICAgICBpZiAoc3RyaXAubGVmdCkgewogICAgICAgIHRoaXMub3Bjb2RlKCdzdHJpcCcpOwogICAgICB9CgogICAgICByZXQgPSB0aGlzW25vZGUudHlwZV0obm9kZSk7CgogICAgICBpZiAoc3RyaXAucmlnaHQpIHsKICAgICAgICB0aGlzLm9wY29kZSgnc3RyaXAnKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHJldDsKICAgIH0sCgogICAgcHJvZ3JhbTogZnVuY3Rpb24ocHJvZ3JhbSkgewogICAgICB2YXIgc3RhdGVtZW50cyA9IHByb2dyYW0uc3RhdGVtZW50czsKCiAgICAgIGZvcih2YXIgaT0wLCBsPXN0YXRlbWVudHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIHRoaXMuYWNjZXB0KHN0YXRlbWVudHNbaV0pOwogICAgICB9CiAgICAgIHRoaXMuaXNTaW1wbGUgPSBsID09PSAxOwoKICAgICAgdGhpcy5kZXB0aHMubGlzdCA9IHRoaXMuZGVwdGhzLmxpc3Quc29ydChmdW5jdGlvbihhLCBiKSB7CiAgICAgICAgcmV0dXJuIGEgLSBiOwogICAgICB9KTsKCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICBjb21waWxlUHJvZ3JhbTogZnVuY3Rpb24ocHJvZ3JhbSkgewogICAgICB2YXIgcmVzdWx0ID0gbmV3IHRoaXMuY29tcGlsZXIoKS5jb21waWxlKHByb2dyYW0sIHRoaXMub3B0aW9ucyk7CiAgICAgIHZhciBndWlkID0gdGhpcy5ndWlkKyssIGRlcHRoOwoKICAgICAgdGhpcy51c2VQYXJ0aWFsID0gdGhpcy51c2VQYXJ0aWFsIHx8IHJlc3VsdC51c2VQYXJ0aWFsOwoKICAgICAgdGhpcy5jaGlsZHJlbltndWlkXSA9IHJlc3VsdDsKCiAgICAgIGZvcih2YXIgaT0wLCBsPXJlc3VsdC5kZXB0aHMubGlzdC5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgZGVwdGggPSByZXN1bHQuZGVwdGhzLmxpc3RbaV07CgogICAgICAgIGlmKGRlcHRoIDwgMikgeyBjb250aW51ZTsgfQogICAgICAgIGVsc2UgeyB0aGlzLmFkZERlcHRoKGRlcHRoIC0gMSk7IH0KICAgICAgfQoKICAgICAgcmV0dXJuIGd1aWQ7CiAgICB9LAoKICAgIGJsb2NrOiBmdW5jdGlvbihibG9jaykgewogICAgICB2YXIgbXVzdGFjaGUgPSBibG9jay5tdXN0YWNoZSwKICAgICAgICAgIHByb2dyYW0gPSBibG9jay5wcm9ncmFtLAogICAgICAgICAgaW52ZXJzZSA9IGJsb2NrLmludmVyc2U7CgogICAgICBpZiAocHJvZ3JhbSkgewogICAgICAgIHByb2dyYW0gPSB0aGlzLmNvbXBpbGVQcm9ncmFtKHByb2dyYW0pOwogICAgICB9CgogICAgICBpZiAoaW52ZXJzZSkgewogICAgICAgIGludmVyc2UgPSB0aGlzLmNvbXBpbGVQcm9ncmFtKGludmVyc2UpOwogICAgICB9CgogICAgICB2YXIgdHlwZSA9IHRoaXMuY2xhc3NpZnlNdXN0YWNoZShtdXN0YWNoZSk7CgogICAgICBpZiAodHlwZSA9PT0gImhlbHBlciIpIHsKICAgICAgICB0aGlzLmhlbHBlck11c3RhY2hlKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKTsKICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAic2ltcGxlIikgewogICAgICAgIHRoaXMuc2ltcGxlTXVzdGFjaGUobXVzdGFjaGUpOwoKICAgICAgICAvLyBub3cgdGhhdCB0aGUgc2ltcGxlIG11c3RhY2hlIGlzIHJlc29sdmVkLCB3ZSBuZWVkIHRvCiAgICAgICAgLy8gZXZhbHVhdGUgaXQgYnkgZXhlY3V0aW5nIGBibG9ja0hlbHBlck1pc3NpbmdgCiAgICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hQcm9ncmFtJywgcHJvZ3JhbSk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hQcm9ncmFtJywgaW52ZXJzZSk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2VtcHR5SGFzaCcpOwogICAgICAgIHRoaXMub3Bjb2RlKCdibG9ja1ZhbHVlJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5hbWJpZ3VvdXNNdXN0YWNoZShtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSk7CgogICAgICAgIC8vIG5vdyB0aGF0IHRoZSBzaW1wbGUgbXVzdGFjaGUgaXMgcmVzb2x2ZWQsIHdlIG5lZWQgdG8KICAgICAgICAvLyBldmFsdWF0ZSBpdCBieSBleGVjdXRpbmcgYGJsb2NrSGVscGVyTWlzc2luZ2AKICAgICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBwcm9ncmFtKTsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBpbnZlcnNlKTsKICAgICAgICB0aGlzLm9wY29kZSgnZW1wdHlIYXNoJyk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2FtYmlndW91c0Jsb2NrVmFsdWUnKTsKICAgICAgfQoKICAgICAgdGhpcy5vcGNvZGUoJ2FwcGVuZCcpOwogICAgfSwKCiAgICBoYXNoOiBmdW5jdGlvbihoYXNoKSB7CiAgICAgIHZhciBwYWlycyA9IGhhc2gucGFpcnMsIHBhaXIsIHZhbDsKCiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoSGFzaCcpOwoKICAgICAgZm9yKHZhciBpPTAsIGw9cGFpcnMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIHBhaXIgPSBwYWlyc1tpXTsKICAgICAgICB2YWwgID0gcGFpclsxXTsKCiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5zdHJpbmdQYXJhbXMpIHsKICAgICAgICAgIGlmKHZhbC5kZXB0aCkgewogICAgICAgICAgICB0aGlzLmFkZERlcHRoKHZhbC5kZXB0aCk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLm9wY29kZSgnZ2V0Q29udGV4dCcsIHZhbC5kZXB0aCB8fCAwKTsKICAgICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoU3RyaW5nUGFyYW0nLCB2YWwuc3RyaW5nTW9kZVZhbHVlLCB2YWwudHlwZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuYWNjZXB0KHZhbCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLm9wY29kZSgnYXNzaWduVG9IYXNoJywgcGFpclswXSk7CiAgICAgIH0KICAgICAgdGhpcy5vcGNvZGUoJ3BvcEhhc2gnKTsKICAgIH0sCgogICAgcGFydGlhbDogZnVuY3Rpb24ocGFydGlhbCkgewogICAgICB2YXIgcGFydGlhbE5hbWUgPSBwYXJ0aWFsLnBhcnRpYWxOYW1lOwogICAgICB0aGlzLnVzZVBhcnRpYWwgPSB0cnVlOwoKICAgICAgaWYocGFydGlhbC5jb250ZXh0KSB7CiAgICAgICAgdGhpcy5JRChwYXJ0aWFsLmNvbnRleHQpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoJywgJ2RlcHRoMCcpOwogICAgICB9CgogICAgICB0aGlzLm9wY29kZSgnaW52b2tlUGFydGlhbCcsIHBhcnRpYWxOYW1lLm5hbWUpOwogICAgICB0aGlzLm9wY29kZSgnYXBwZW5kJyk7CiAgICB9LAoKICAgIGNvbnRlbnQ6IGZ1bmN0aW9uKGNvbnRlbnQpIHsKICAgICAgdGhpcy5vcGNvZGUoJ2FwcGVuZENvbnRlbnQnLCBjb250ZW50LnN0cmluZyk7CiAgICB9LAoKICAgIG11c3RhY2hlOiBmdW5jdGlvbihtdXN0YWNoZSkgewogICAgICB2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKICAgICAgdmFyIHR5cGUgPSB0aGlzLmNsYXNzaWZ5TXVzdGFjaGUobXVzdGFjaGUpOwoKICAgICAgaWYgKHR5cGUgPT09ICJzaW1wbGUiKSB7CiAgICAgICAgdGhpcy5zaW1wbGVNdXN0YWNoZShtdXN0YWNoZSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gImhlbHBlciIpIHsKICAgICAgICB0aGlzLmhlbHBlck11c3RhY2hlKG11c3RhY2hlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmFtYmlndW91c011c3RhY2hlKG11c3RhY2hlKTsKICAgICAgfQoKICAgICAgaWYobXVzdGFjaGUuZXNjYXBlZCAmJiAhb3B0aW9ucy5ub0VzY2FwZSkgewogICAgICAgIHRoaXMub3Bjb2RlKCdhcHBlbmRFc2NhcGVkJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2FwcGVuZCcpOwogICAgICB9CiAgICB9LAoKICAgIGFtYmlndW91c011c3RhY2hlOiBmdW5jdGlvbihtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSkgewogICAgICB2YXIgaWQgPSBtdXN0YWNoZS5pZCwKICAgICAgICAgIG5hbWUgPSBpZC5wYXJ0c1swXSwKICAgICAgICAgIGlzQmxvY2sgPSBwcm9ncmFtICE9IG51bGwgfHwgaW52ZXJzZSAhPSBudWxsOwoKICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBpZC5kZXB0aCk7CgogICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBwcm9ncmFtKTsKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hQcm9ncmFtJywgaW52ZXJzZSk7CgogICAgICB0aGlzLm9wY29kZSgnaW52b2tlQW1iaWd1b3VzJywgbmFtZSwgaXNCbG9jayk7CiAgICB9LAoKICAgIHNpbXBsZU11c3RhY2hlOiBmdW5jdGlvbihtdXN0YWNoZSkgewogICAgICB2YXIgaWQgPSBtdXN0YWNoZS5pZDsKCiAgICAgIGlmIChpZC50eXBlID09PSAnREFUQScpIHsKICAgICAgICB0aGlzLkRBVEEoaWQpOwogICAgICB9IGVsc2UgaWYgKGlkLnBhcnRzLmxlbmd0aCkgewogICAgICAgIHRoaXMuSUQoaWQpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFNpbXBsaWZpZWQgSUQgZm9yIGB0aGlzYAogICAgICAgIHRoaXMuYWRkRGVwdGgoaWQuZGVwdGgpOwogICAgICAgIHRoaXMub3Bjb2RlKCdnZXRDb250ZXh0JywgaWQuZGVwdGgpOwogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoQ29udGV4dCcpOwogICAgICB9CgogICAgICB0aGlzLm9wY29kZSgncmVzb2x2ZVBvc3NpYmxlTGFtYmRhJyk7CiAgICB9LAoKICAgIGhlbHBlck11c3RhY2hlOiBmdW5jdGlvbihtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSkgewogICAgICB2YXIgcGFyYW1zID0gdGhpcy5zZXR1cEZ1bGxNdXN0YWNoZVBhcmFtcyhtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSksCiAgICAgICAgICBuYW1lID0gbXVzdGFjaGUuaWQucGFydHNbMF07CgogICAgICBpZiAodGhpcy5vcHRpb25zLmtub3duSGVscGVyc1tuYW1lXSkgewogICAgICAgIHRoaXMub3Bjb2RlKCdpbnZva2VLbm93bkhlbHBlcicsIHBhcmFtcy5sZW5ndGgsIG5hbWUpOwogICAgICB9IGVsc2UgaWYgKHRoaXMub3B0aW9ucy5rbm93bkhlbHBlcnNPbmx5KSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3Ugc3BlY2lmaWVkIGtub3duSGVscGVyc09ubHksIGJ1dCB1c2VkIHRoZSB1bmtub3duIGhlbHBlciAiICsgbmFtZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2ludm9rZUhlbHBlcicsIHBhcmFtcy5sZW5ndGgsIG5hbWUpOwogICAgICB9CiAgICB9LAoKICAgIElEOiBmdW5jdGlvbihpZCkgewogICAgICB0aGlzLmFkZERlcHRoKGlkLmRlcHRoKTsKICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBpZC5kZXB0aCk7CgogICAgICB2YXIgbmFtZSA9IGlkLnBhcnRzWzBdOwogICAgICBpZiAoIW5hbWUpIHsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaENvbnRleHQnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgnbG9va3VwT25Db250ZXh0JywgaWQucGFydHNbMF0pOwogICAgICB9CgogICAgICBmb3IodmFyIGk9MSwgbD1pZC5wYXJ0cy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2xvb2t1cCcsIGlkLnBhcnRzW2ldKTsKICAgICAgfQogICAgfSwKCiAgICBEQVRBOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHRoaXMub3B0aW9ucy5kYXRhID0gdHJ1ZTsKICAgICAgaWYgKGRhdGEuaWQuaXNTY29wZWQgfHwgZGF0YS5pZC5kZXB0aCkgewogICAgICAgIHRocm93IG5ldyBFeGNlcHRpb24oJ1Njb3BlZCBkYXRhIHJlZmVyZW5jZXMgYXJlIG5vdCBzdXBwb3J0ZWQ6ICcgKyBkYXRhLm9yaWdpbmFsKTsKICAgICAgfQoKICAgICAgdGhpcy5vcGNvZGUoJ2xvb2t1cERhdGEnKTsKICAgICAgdmFyIHBhcnRzID0gZGF0YS5pZC5wYXJ0czsKICAgICAgZm9yKHZhciBpPTAsIGw9cGFydHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIHRoaXMub3Bjb2RlKCdsb29rdXAnLCBwYXJ0c1tpXSk7CiAgICAgIH0KICAgIH0sCgogICAgU1RSSU5HOiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hTdHJpbmcnLCBzdHJpbmcuc3RyaW5nKTsKICAgIH0sCgogICAgSU5URUdFUjogZnVuY3Rpb24oaW50ZWdlcikgewogICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCBpbnRlZ2VyLmludGVnZXIpOwogICAgfSwKCiAgICBCT09MRUFOOiBmdW5jdGlvbihib29sKSB7CiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoTGl0ZXJhbCcsIGJvb2wuYm9vbCk7CiAgICB9LAoKICAgIGNvbW1lbnQ6IGZ1bmN0aW9uKCkge30sCgogICAgLy8gSEVMUEVSUwogICAgb3Bjb2RlOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHRoaXMub3Bjb2Rlcy5wdXNoKHsgb3Bjb2RlOiBuYW1lLCBhcmdzOiBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSkgfSk7CiAgICB9LAoKICAgIGRlY2xhcmU6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgIHRoaXMub3Bjb2Rlcy5wdXNoKHsgb3Bjb2RlOiAnREVDTEFSRScsIG5hbWU6IG5hbWUsIHZhbHVlOiB2YWx1ZSB9KTsKICAgIH0sCgogICAgYWRkRGVwdGg6IGZ1bmN0aW9uKGRlcHRoKSB7CiAgICAgIGlmKGlzTmFOKGRlcHRoKSkgeyB0aHJvdyBuZXcgRXJyb3IoIkVXT1QiKTsgfQogICAgICBpZihkZXB0aCA9PT0gMCkgeyByZXR1cm47IH0KCiAgICAgIGlmKCF0aGlzLmRlcHRoc1tkZXB0aF0pIHsKICAgICAgICB0aGlzLmRlcHRoc1tkZXB0aF0gPSB0cnVlOwogICAgICAgIHRoaXMuZGVwdGhzLmxpc3QucHVzaChkZXB0aCk7CiAgICAgIH0KICAgIH0sCgogICAgY2xhc3NpZnlNdXN0YWNoZTogZnVuY3Rpb24obXVzdGFjaGUpIHsKICAgICAgdmFyIGlzSGVscGVyICAgPSBtdXN0YWNoZS5pc0hlbHBlcjsKICAgICAgdmFyIGlzRWxpZ2libGUgPSBtdXN0YWNoZS5lbGlnaWJsZUhlbHBlcjsKICAgICAgdmFyIG9wdGlvbnMgICAgPSB0aGlzLm9wdGlvbnM7CgogICAgICAvLyBpZiBhbWJpZ3VvdXMsIHdlIGNhbiBwb3NzaWJseSByZXNvbHZlIHRoZSBhbWJpZ3VpdHkgbm93CiAgICAgIGlmIChpc0VsaWdpYmxlICYmICFpc0hlbHBlcikgewogICAgICAgIHZhciBuYW1lID0gbXVzdGFjaGUuaWQucGFydHNbMF07CgogICAgICAgIGlmIChvcHRpb25zLmtub3duSGVscGVyc1tuYW1lXSkgewogICAgICAgICAgaXNIZWxwZXIgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5rbm93bkhlbHBlcnNPbmx5KSB7CiAgICAgICAgICBpc0VsaWdpYmxlID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoaXNIZWxwZXIpIHsgcmV0dXJuICJoZWxwZXIiOyB9CiAgICAgIGVsc2UgaWYgKGlzRWxpZ2libGUpIHsgcmV0dXJuICJhbWJpZ3VvdXMiOyB9CiAgICAgIGVsc2UgeyByZXR1cm4gInNpbXBsZSI7IH0KICAgIH0sCgogICAgcHVzaFBhcmFtczogZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgIHZhciBpID0gcGFyYW1zLmxlbmd0aCwgcGFyYW07CgogICAgICB3aGlsZShpLS0pIHsKICAgICAgICBwYXJhbSA9IHBhcmFtc1tpXTsKCiAgICAgICAgaWYodGhpcy5vcHRpb25zLnN0cmluZ1BhcmFtcykgewogICAgICAgICAgaWYocGFyYW0uZGVwdGgpIHsKICAgICAgICAgICAgdGhpcy5hZGREZXB0aChwYXJhbS5kZXB0aCk7CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBwYXJhbS5kZXB0aCB8fCAwKTsKICAgICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoU3RyaW5nUGFyYW0nLCBwYXJhbS5zdHJpbmdNb2RlVmFsdWUsIHBhcmFtLnR5cGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzW3BhcmFtLnR5cGVdKHBhcmFtKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgc2V0dXBNdXN0YWNoZVBhcmFtczogZnVuY3Rpb24obXVzdGFjaGUpIHsKICAgICAgdmFyIHBhcmFtcyA9IG11c3RhY2hlLnBhcmFtczsKICAgICAgdGhpcy5wdXNoUGFyYW1zKHBhcmFtcyk7CgogICAgICBpZihtdXN0YWNoZS5oYXNoKSB7CiAgICAgICAgdGhpcy5oYXNoKG11c3RhY2hlLmhhc2gpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMub3Bjb2RlKCdlbXB0eUhhc2gnKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHBhcmFtczsKICAgIH0sCgogICAgLy8gdGhpcyB3aWxsIHJlcGxhY2Ugc2V0dXBNdXN0YWNoZVBhcmFtcyB3aGVuIHdlJ3JlIGRvbmUKICAgIHNldHVwRnVsbE11c3RhY2hlUGFyYW1zOiBmdW5jdGlvbihtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSkgewogICAgICB2YXIgcGFyYW1zID0gbXVzdGFjaGUucGFyYW1zOwogICAgICB0aGlzLnB1c2hQYXJhbXMocGFyYW1zKTsKCiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIHByb2dyYW0pOwogICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBpbnZlcnNlKTsKCiAgICAgIGlmKG11c3RhY2hlLmhhc2gpIHsKICAgICAgICB0aGlzLmhhc2gobXVzdGFjaGUuaGFzaCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2VtcHR5SGFzaCcpOwogICAgICB9CgogICAgICByZXR1cm4gcGFyYW1zOwogICAgfQogIH07CgogIGZ1bmN0aW9uIHByZWNvbXBpbGUoaW5wdXQsIG9wdGlvbnMpIHsKICAgIGlmIChpbnB1dCA9PSBudWxsIHx8ICh0eXBlb2YgaW5wdXQgIT09ICdzdHJpbmcnICYmIGlucHV0LmNvbnN0cnVjdG9yICE9PSBBU1QuUHJvZ3JhbU5vZGUpKSB7CiAgICAgIHRocm93IG5ldyBFeGNlcHRpb24oIllvdSBtdXN0IHBhc3MgYSBzdHJpbmcgb3IgSGFuZGxlYmFycyBBU1QgdG8gSGFuZGxlYmFycy5wcmVjb21waWxlLiBZb3UgcGFzc2VkICIgKyBpbnB1dCk7CiAgICB9CgogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICBpZiAoISgnZGF0YScgaW4gb3B0aW9ucykpIHsKICAgICAgb3B0aW9ucy5kYXRhID0gdHJ1ZTsKICAgIH0KCiAgICB2YXIgYXN0ID0gcGFyc2UoaW5wdXQpOwogICAgdmFyIGVudmlyb25tZW50ID0gbmV3IENvbXBpbGVyKCkuY29tcGlsZShhc3QsIG9wdGlvbnMpOwogICAgcmV0dXJuIG5ldyBKYXZhU2NyaXB0Q29tcGlsZXIoKS5jb21waWxlKGVudmlyb25tZW50LCBvcHRpb25zKTsKICB9CgogIF9fZXhwb3J0c19fLnByZWNvbXBpbGUgPSBwcmVjb21waWxlO2Z1bmN0aW9uIGNvbXBpbGUoaW5wdXQsIG9wdGlvbnMsIGVudikgewogICAgaWYgKGlucHV0ID09IG51bGwgfHwgKHR5cGVvZiBpbnB1dCAhPT0gJ3N0cmluZycgJiYgaW5wdXQuY29uc3RydWN0b3IgIT09IEFTVC5Qcm9ncmFtTm9kZSkpIHsKICAgICAgdGhyb3cgbmV3IEV4Y2VwdGlvbigiWW91IG11c3QgcGFzcyBhIHN0cmluZyBvciBIYW5kbGViYXJzIEFTVCB0byBIYW5kbGViYXJzLmNvbXBpbGUuIFlvdSBwYXNzZWQgIiArIGlucHV0KTsKICAgIH0KCiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICBpZiAoISgnZGF0YScgaW4gb3B0aW9ucykpIHsKICAgICAgb3B0aW9ucy5kYXRhID0gdHJ1ZTsKICAgIH0KCiAgICB2YXIgY29tcGlsZWQ7CgogICAgZnVuY3Rpb24gY29tcGlsZUlucHV0KCkgewogICAgICB2YXIgYXN0ID0gcGFyc2UoaW5wdXQpOwogICAgICB2YXIgZW52aXJvbm1lbnQgPSBuZXcgQ29tcGlsZXIoKS5jb21waWxlKGFzdCwgb3B0aW9ucyk7CiAgICAgIHZhciB0ZW1wbGF0ZVNwZWMgPSBuZXcgSmF2YVNjcmlwdENvbXBpbGVyKCkuY29tcGlsZShlbnZpcm9ubWVudCwgb3B0aW9ucywgdW5kZWZpbmVkLCB0cnVlKTsKICAgICAgcmV0dXJuIGVudi50ZW1wbGF0ZSh0ZW1wbGF0ZVNwZWMpOwogICAgfQoKICAgIC8vIFRlbXBsYXRlIGlzIG9ubHkgY29tcGlsZWQgb24gZmlyc3QgdXNlIGFuZCBjYWNoZWQgYWZ0ZXIgdGhhdCBwb2ludC4KICAgIHJldHVybiBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgICAgIGlmICghY29tcGlsZWQpIHsKICAgICAgICBjb21waWxlZCA9IGNvbXBpbGVJbnB1dCgpOwogICAgICB9CiAgICAgIHJldHVybiBjb21waWxlZC5jYWxsKHRoaXMsIGNvbnRleHQsIG9wdGlvbnMpOwogICAgfTsKICB9CgogIF9fZXhwb3J0c19fLmNvbXBpbGUgPSBjb21waWxlOwogIHJldHVybiBfX2V4cG9ydHNfXzsKfSkoX19tb2R1bGU1X18sIF9fbW9kdWxlOF9fLCBfX21vZHVsZTExX18sIF9fbW9kdWxlN19fKTsKCi8vIGhhbmRsZWJhcnMuanMKdmFyIF9fbW9kdWxlMF9fID0gKGZ1bmN0aW9uKF9fZGVwZW5kZW5jeTFfXywgX19kZXBlbmRlbmN5Ml9fLCBfX2RlcGVuZGVuY3kzX18sIF9fZGVwZW5kZW5jeTRfXywgX19kZXBlbmRlbmN5NV9fKSB7CiAgInVzZSBzdHJpY3QiOwogIHZhciBfX2V4cG9ydHNfXzsKICAvKmdsb2JhbHMgSGFuZGxlYmFyczogdHJ1ZSAqLwogIHZhciBIYW5kbGViYXJzID0gX19kZXBlbmRlbmN5MV9fOwoKICAvLyBDb21waWxlciBpbXBvcnRzCiAgdmFyIEFTVCA9IF9fZGVwZW5kZW5jeTJfXzsKICB2YXIgUGFyc2VyID0gX19kZXBlbmRlbmN5M19fLnBhcnNlcjsKICB2YXIgcGFyc2UgPSBfX2RlcGVuZGVuY3kzX18ucGFyc2U7CiAgdmFyIENvbXBpbGVyID0gX19kZXBlbmRlbmN5NF9fLkNvbXBpbGVyOwogIHZhciBjb21waWxlID0gX19kZXBlbmRlbmN5NF9fLmNvbXBpbGU7CiAgdmFyIHByZWNvbXBpbGUgPSBfX2RlcGVuZGVuY3k0X18ucHJlY29tcGlsZTsKICB2YXIgSmF2YVNjcmlwdENvbXBpbGVyID0gX19kZXBlbmRlbmN5NV9fOwoKICB2YXIgX2NyZWF0ZSA9IEhhbmRsZWJhcnMuY3JlYXRlOwogIHZhciBjcmVhdGUgPSBmdW5jdGlvbigpIHsKICAgIHZhciBoYiA9IF9jcmVhdGUoKTsKCiAgICBoYi5jb21waWxlID0gZnVuY3Rpb24oaW5wdXQsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIGNvbXBpbGUoaW5wdXQsIG9wdGlvbnMsIGhiKTsKICAgIH07CiAgICBoYi5wcmVjb21waWxlID0gcHJlY29tcGlsZTsKCiAgICBoYi5BU1QgPSBBU1Q7CiAgICBoYi5Db21waWxlciA9IENvbXBpbGVyOwogICAgaGIuSmF2YVNjcmlwdENvbXBpbGVyID0gSmF2YVNjcmlwdENvbXBpbGVyOwogICAgaGIuUGFyc2VyID0gUGFyc2VyOwogICAgaGIucGFyc2UgPSBwYXJzZTsKCiAgICByZXR1cm4gaGI7CiAgfTsKCiAgSGFuZGxlYmFycyA9IGNyZWF0ZSgpOwogIEhhbmRsZWJhcnMuY3JlYXRlID0gY3JlYXRlOwoKICBfX2V4cG9ydHNfXyA9IEhhbmRsZWJhcnM7CiAgcmV0dXJuIF9fZXhwb3J0c19fOwp9KShfX21vZHVsZTFfXywgX19tb2R1bGU3X18sIF9fbW9kdWxlOF9fLCBfX21vZHVsZTEwX18sIF9fbW9kdWxlMTFfXyk7CgogIHJldHVybiBfX21vZHVsZTBfXzsKfSkoKTsK</content>
    <filesize>84981</filesize>
  </attachment>
  <object>
    <name>TodoLists.TodoListMacro</name>
    <number>0</number>
    <className>XWiki.JavaScriptExtension</className>
    <guid>744f736f-3e5c-4c3f-9786-19023587257e</guid>
    <class>
      <name>XWiki.JavaScriptExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <contenttype>PureText</contenttype>
        <disabled>0</disabled>
        <editor>PureText</editor>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>requirejs.config({
    //By default load any module IDs from js/lib
    baseUrl: '${xwiki.getDocument("TodoLists.TodoListMacro").getURL("download")}/',
    //except, if the module ID starts with "app",
    //load it from the js/app directory. paths
    //config is relative to the baseUrl, and
    //never includes a ".js" extension since
    //the paths config could be for a directory.
    paths: {
    },
    shim: {
        'ember-data': {
            deps: ['ember', 'jquery']
        },
        'ember': {
            deps: ['jquery']
        }
    }
});
require(['jquery', 'handlebars-v1.2.1', 'ember-data', 'ember' ], function ($) {

// create app
window.Todos = Ember.Application.create({
  rootElement: '#todoappdiv'
});

// define the todolist store that will write to the TodoListsService
Todos.ApplicationAdapter = DS.Adapter.extend({
  createRecord: function(store, type, record) {
    console.log("createRecord");
    var query = { create: "1", content : JSON.stringify(record) };
    return new Ember.RSVP.Promise(function(resolve, reject) {
      jQuery.getJSON("${xwiki.getURL("TodoLists.TodoListsService")}?page=" + XWiki.currentSpace + "." + XWiki.currentPage + "&amp;xpage=plain&amp;outputSyntax=plain", query).then(function(data) {
        Ember.run(null, resolve, data);
      }, function(jqXHR) {
        jqXHR.then = null; // tame jQuery's ill mannered promises
        Ember.run(null, reject, jqXHR);
      });
    });
  },
  deleteRecord: function(store, type, record) {
    console.log("deleteRecord");
    return this.saveAll(store.recordArrayManager.recordArraysForRecord(record).list[0].content);
  },
  find: function(store, type, id) {
    console.log("find");
    return;
  },
  findAll: function(store, type, sinceToken) {
    console.log("findAll");
    var query = { since: sinceToken };
    return new Ember.RSVP.Promise(function(resolve, reject) {
      jQuery.getJSON("${xwiki.getURL("TodoLists.TodoListsService")}?page=" + XWiki.currentSpace + "." + XWiki.currentPage + "&amp;xpage=plain&amp;outputSyntax=plain", query).then(function(data) {
        Ember.run(null, resolve, data);
      }, function(jqXHR) {
        jqXHR.then = null; // tame jQuery's ill mannered promises
        Ember.run(null, reject, jqXHR);
      });
    });
  },
  updateRecord: function(store, type, record) {
    return this.saveAll(store.recordArrayManager.recordArraysForRecord(record).list[0].content);
  },
  saveAll: function(alldata) {
    console.log("updateRecord");
    var query = { save: "1", content : JSON.stringify(alldata) };
    return new Ember.RSVP.Promise(function(resolve, reject) {
      jQuery.getJSON("${xwiki.getURL("TodoLists.TodoListsService")}?page=" + XWiki.currentSpace + "." + XWiki.currentPage + "&amp;xpage=plain&amp;outputSyntax=plain", query).then(function(data) {
        Ember.run(null, resolve, data);
      }, function(jqXHR) {
        jqXHR.then = null; // tame jQuery's ill mannered promises
        Ember.run(null, reject, jqXHR);
      });
    });
  }
});

// use my own store
Todos.store = DS.Store.create({
  adapter: 'ApplicationAdapter'
});

// Todos.ApplicationAdapter = DS.FixtureAdapter.extend();

// routing
Todos.Router.map(function() {
  this.resource('todos', { path: '' }, function() {
     this.route('active');
     this.route('completed');
  });
});

Todos.TodosRoute = Ember.Route.extend({
  model: function() {
    return this.store.find('todo');
  }
});

Todos.TodosIndexRoute = Ember.Route.extend({
  model: function() {
    return this.modelFor('todos');
  }
});

// ... additional lines truncated for brevity ...
Todos.TodosActiveRoute = Ember.Route.extend({
  model: function(){
    return this.store.filter('todo', function(todo) {
      return !todo.get('isCompleted');
    });
  },
  renderTemplate: function(controller) {
    this.render('todos/index', {controller: controller});
  }
});

Todos.TodosCompletedRoute = Ember.Route.extend({
  model: function(){
    return this.store.filter('todo', function (todo) {
      return todo.get('isCompleted');
    });
  },
  renderTemplate: function(controller){
    this.render('todos/index', {controller: controller});
  }
});

// data model
Todos.Todo = DS.Model.extend({
  title: DS.attr('string'),
  priority: DS.attr('string'),
  assignee: DS.attr('string'),
  isCompleted: DS.attr('boolean')
});

// ... additional lines truncated for brevity ...
Todos.Todo.FIXTURES = [
 {
   id: 1,
   title: 'Learn Ember.js X',
   isCompleted: true
 },
 {
   id: 2,
   title: '...',
   isCompleted: false
 },
 {
   id: 3,
   title: 'Profit!',
   isCompleted: false
 }
];

// controler
Todos.TodoController = Ember.ObjectController.extend({
  actions: {
    editTodo: function () {
      this.set('isEditing', true);
    },
    acceptChanges: function() {
    this.set('isEditing', false);

    if (Ember.isEmpty(this.get('model.title'))) {
      this.send('removeTodo');
    } else {
      this.get('model').save();
    }
   },
   removeTodo: function() {
    var todo = this.get('model');
    todo.deleteRecord();
    todo.save();
  }
  },

  isEditing: false,

  isCompleted: function(key, value){
    var model = this.get('model');

    if (value === undefined) {
      // property being used as a getter
      return model.get('isCompleted');
    } else {
      // property being used as  setter
      model.set('isCompleted', value);
      model.save();
      return value;
    }
  }.property('model.isCompleted')
});

Todos.TodosController = Ember.ArrayController.extend({
  actions: {
    createTodo: function () {
      // Get the todo title set by the "New Todo" text field
      var title = this.get('newTitle');
      if (!title.trim()) { return; }

      // Create the new Todo model
      var todo = this.store.createRecord('todo', {
        title: title,
        priority: "P3",
        assignee: "all",
        isCompleted: false
      });

      // Clear the "New Todo" text field
      this.set('newTitle', '');

      // Save the new model
      todo.save();
    },
    clearCompleted: function () {
      var completed = this.filterProperty('isCompleted', true);
      completed.invoke('deleteRecord');
      completed.invoke('save');
    }
  },

  remaining: function () {
    return this.filterProperty('isCompleted', false).get('length');
  }.property('@each.isCompleted'),

  inflection: function () {
    var remaining = this.get('remaining');
    return remaining === 1 ? 'item' : 'items';
  }.property('remaining'),
  hasCompleted: function () {
    return this.get('completed') &gt; 0;
  }.property('completed'),

  completed: function () {
    return this.filterProperty('isCompleted', true).get('length');
  }.property('@each.isCompleted'),

 allAreDone: function(key, value) {
  if (value === undefined) {
    return !!this.get('length') &amp;&amp; this.everyProperty('isCompleted', true);
  } else {
    this.setEach('isCompleted', value);
    this.invoke('save');
    return value;
  }
}.property('@each.isCompleted')
});

// editing
Todos.EditTodoView = Ember.TextField.extend({
  didInsertElement: function() {
    this.$().focus();
  }
});

Ember.Handlebars.helper('edit-todo', Todos.EditTodoView);
});</code>
    </property>
    <property>
      <name>js</name>
    </property>
    <property>
      <parse>1</parse>
    </property>
    <property>
      <use>onDemand</use>
    </property>
  </object>
  <object>
    <name>TodoLists.TodoListMacro</name>
    <number>0</number>
    <className>XWiki.StyleSheetExtension</className>
    <guid>c5c8b484-e711-4c9d-9a54-61133f496596</guid>
    <class>
      <name>XWiki.StyleSheetExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <contenttype>PureText</contenttype>
        <disabled>0</disabled>
        <editor>PureText</editor>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <contentType>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>contentType</name>
        <number>6</number>
        <prettyName>Content Type</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>CSS|LESS</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </contentType>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>#template('colorThemeInit.vm')

button {
	margin: 0;
	padding: 0;
	border: 0;
	background: none;
	font-size: 100%;
	vertical-align: baseline;
	font-family: inherit;
	color: inherit;
	-webkit-appearance: none;
	/*-moz-appearance: none;*/
	-ms-appearance: none;
	-o-appearance: none;
	appearance: none;
}

#todoapp {
	background: #fff;
	background: rgba(255, 255, 255, 0.9);
	border: 1px solid #ccc;
	position: relative;
        margin-bottom: 60px;
	border-top-left-radius: 2px;
	border-top-right-radius: 2px;
	box-shadow: 0 2px 6px 0 rgba(0, 0, 0, 0.2),
				0 25px 50px 0 rgba(0, 0, 0, 0.15);
}

#todoappdiv {
        width: 70%;
}

#todoapp:before {
	content: '';
	border-left: 1px solid $theme.borderColor;
	border-right: 1px solid $theme.borderColor;
	width: 2px;
	position: absolute;
	top: 0;
	left: 40px;
	height: 100%;
}

#todoapp input::-webkit-input-placeholder {
	font-style: italic;
}

#todoapp input:-moz-placeholder {
	font-style: italic;
	color: #a9a9a9;
}

#header {
	padding-top: 5px;
	border-radius: inherit;
}

#header:before {
	content: '';
	position: absolute;
	top: 0;
	right: 0;
	left: 0;
	height: 5px;
	z-index: 2;
	border-bottom: 1px solid #6c615c;
  #css3_backgroundLinearGradient({
     'to': 'bottom',
     'colors': [
      {'color': $theme.menuGradientColor, 'position': '0%'},
      {'color': $theme.menuBackgroundColor, 'position': '50%'}
    ]
  })
  box-shadow: 0px 1px 2px $theme.menuGradientColor;
	border-top-left-radius: 1px;
	border-top-right-radius: 1px;
}

#new-todo,
.edit {
	position: relative;
	margin: 0;
	width: 100%;
	font-size: 14px;
	font-family: inherit;
	line-height: 1.4em;
	border: 0;
	outline: none;
	color: inherit;
	padding: 6px;
	border: 1px solid #999;
	box-shadow: inset 0 -1px 5px 0 rgba(0, 0, 0, 0.2);
	-webkit-box-sizing: border-box;
	-moz-box-sizing: border-box;
	-ms-box-sizing: border-box;
	-o-box-sizing: border-box;
	box-sizing: border-box;
	-webkit-font-smoothing: antialiased;
	-moz-font-smoothing: antialiased;
	-ms-font-smoothing: antialiased;
	-o-font-smoothing: antialiased;
	font-smoothing: antialiased;
}

#new-todo {
	padding: 16px 16px 16px 60px;
	border: none;
	background: rgba(0, 0, 0, 0.02);
	z-index: 2;
	box-shadow: none;
}

#main {
	position: relative;
	z-index: 2;
	border-top: 1px dotted #adadad;
}

label[for='toggle-all'] {
	display: none;
}

#toggle-all {
	position: absolute;
	top: -42px;
	left: -4px;
	width: 40px;
	text-align: center;
	border: none; /* Mobile Safari */
}

#toggle-all:before {
	content: '»';
	font-size: 14px;
	color: #d9d9d9;
	padding: 0 25px 7px;
}

#toggle-all:checked:before {
	color: #737373;
}

#todo-list {
	margin: 0;
	padding: 0;
	list-style: none;
}

#todo-list li {
	position: relative;
	font-size: 14px;
	border-bottom: 1px dotted #ccc;
        line-height: 1;
}

#todo-list li:last-child {
	border-bottom: none;
}

#todo-list li.editing {
	border-bottom: none;
	padding: 0;
}

#todo-list li.editing .edit {
	display: block;
	width: 506px;
	padding: 13px 17px 12px 17px;
	margin: 0 0 0 43px;
}

#todo-list li.editing .view {
	display: none;
}

#todo-list li .toggle {
	text-align: center;
	width: 40px;
	/* auto, since non-WebKit browsers doesn't support input styling */
	height: auto;
	position: absolute;
	top: 0;
	bottom: 0;
	margin: auto 0;
	border: none; /* Mobile Safari */
	-webkit-appearance: none;
	/*-moz-appearance: none;*/
	-ms-appearance: none;
	-o-appearance: none;
	appearance: none;
}

#todo-list li .toggle:after {
	content: '✔';
	line-height: 43px; /* 40 + a couple of pixels visual adjustment */
	font-size: 14px;
	color: #d9d9d9;
	text-shadow: 0 -1px 0 #bfbfbf;
}

#todo-list li .toggle:checked:after {
	color: #85ada7;
	text-shadow: 0 1px 0 #669991;
	bottom: 1px;
	position: relative;
}

#todo-list li label {
        font-weight: normal;
	word-break: break-word;
        padding-top: 5px;
	margin-left: 45px;
	line-height: 1;
	-webkit-transition: color 0.4s;
	-moz-transition: color 0.4s;
	-ms-transition: color 0.4s;
	-o-transition: color 0.4s;
	transition: color 0.4s;
}

#todo-list li.completed label {
	color: #a9a9a9;
	text-decoration: line-through;
}

#todo-list li .destroy {
	display: none;
	position: absolute;
	top: 0;
	right: 10px;
	bottom: 0;
	width: 40px;
	height: 40px;
	margin: auto 0;
	font-size: 14px;
	color: #a88a8a;
	-webkit-transition: all 0.2s;
	-moz-transition: all 0.2s;
	-ms-transition: all 0.2s;
	-o-transition: all 0.2s;
	transition: all 0.2s;
}

#todo-list li .destroy:hover {
	text-shadow: 0 0 1px #000,
				 0 0 10px rgba(199, 107, 107, 0.8);
	-webkit-transform: scale(1.3);
	-moz-transform: scale(1.3);
	-ms-transform: scale(1.3);
	-o-transform: scale(1.3);
	transform: scale(1.3);
}

#todo-list li .destroy:after {
	content: '✖';
}

#todo-list li:hover .destroy {
	display: block;
}

#todo-list li .edit {
	display: none;
}

#todo-list li.editing:last-child {
	margin-bottom: -1px;
}

#footer {
	color: #777;
	padding: 0 15px;
	position: absolute;
	right: 0;
	bottom: -31px;
	left: 0;
	height: 20px;
	z-index: 1;
	text-align: center;
}

#footer:before {
	content: '';
	position: absolute;
	right: 0;
	bottom: 31px;
	left: 0;
	height: 50px;
	z-index: -1;
	box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3),
				0 6px 0 -3px rgba(255, 255, 255, 0.8),
				0 7px 1px -3px rgba(0, 0, 0, 0.3),
				0 43px 0 -6px rgba(255, 255, 255, 0.8),
				0 44px 2px -6px rgba(0, 0, 0, 0.2);
}

#todo-count {
	float: left;
	text-align: left;
}

#filters {
	margin: 0;
	padding: 0;
	list-style: none;
	position: absolute;
	right: 0;
	left: 0;
}

#filters li {
	display: inline;
}

#filters li a {
	color: #83756f;
	margin: 2px;
	text-decoration: none;
}

#filters li a.selected {
	font-weight: normal;
}

#clear-completed {
	float: right;
	position: relative;
	line-height: 14px;
	text-decoration: none;
	background: rgba(0, 0, 0, 0.1);
	font-size: 11px;
	padding: 0 10px;
	border-radius: 3px;
	box-shadow: 0 -1px 0 0 rgba(0, 0, 0, 0.2);
}

#clear-completed:hover {
	background: rgba(0, 0, 0, 0.15);
	box-shadow: 0 -1px 0 0 rgba(0, 0, 0, 0.3);
}

#info {
	margin: 65px auto 0;
	color: #a6a6a6;
	font-size: 12px;
	text-shadow: 0 1px 0 rgba(255, 255, 255, 0.7);
	text-align: center;
}

#info a {
	color: inherit;
}

/*
	Hack to remove background from Mobile Safari.
	Can't use it globally since it destroys checkboxes in Firefox and Opera
*/
@media screen and (-webkit-min-device-pixel-ratio:0) {
	#toggle-all,
	#todo-list li .toggle {
		background: none;
	}

	#todo-list li .toggle {
		height: 40px;
	}

	#toggle-all {
		top: -56px;
		left: -15px;
		width: 65px;
		height: 41px;
		-webkit-transform: rotate(90deg);
		transform: rotate(90deg);
		-webkit-appearance: none;
		appearance: none;
	}
}

.hidden{
	display:none;
}
</code>
    </property>
    <property>
      <contentType>CSS</contentType>
    </property>
    <property>
      <name>css</name>
    </property>
    <property>
      <parse>1</parse>
    </property>
    <property>
      <use>onDemand</use>
    </property>
  </object>
  <object>
    <name>TodoLists.TodoListMacro</name>
    <number>0</number>
    <className>XWiki.WikiMacroClass</className>
    <guid>c5210a93-0aad-425e-8bb2-fc48b6dbdaa2</guid>
    <class>
      <name>XWiki.WikiMacroClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <code>
        <disabled>0</disabled>
        <editor>Text</editor>
        <name>code</name>
        <number>9</number>
        <prettyName>Macro code</prettyName>
        <rows>20</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <contentDescription>
        <contenttype>PureText</contenttype>
        <disabled>0</disabled>
        <editor>PureText</editor>
        <name>contentDescription</name>
        <number>8</number>
        <prettyName>Content description (Not applicable for "No content" type)</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </contentDescription>
      <contentType>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>contentType</name>
        <number>7</number>
        <prettyName>Macro content type</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator>|</separator>
        <separators>|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>Optional|Mandatory|No content</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </contentType>
      <defaultCategory>
        <disabled>0</disabled>
        <name>defaultCategory</name>
        <number>4</number>
        <prettyName>Default category</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultCategory>
      <description>
        <contenttype>PureText</contenttype>
        <disabled>0</disabled>
        <editor>PureText</editor>
        <name>description</name>
        <number>3</number>
        <prettyName>Macro description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <id>
        <disabled>0</disabled>
        <name>id</name>
        <number>1</number>
        <prettyName>Macro id</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </id>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>2</number>
        <prettyName>Macro name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <supportsInlineMode>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>supportsInlineMode</name>
        <number>5</number>
        <prettyName>Supports inline mode</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </supportsInlineMode>
      <visibility>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>visibility</name>
        <number>6</number>
        <prettyName>Macro visibility</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator>|</separator>
        <separators>|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>Current User|Current Wiki|Global</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </visibility>
    </class>
    <property>
      <code>{{velocity}}
#set($width = $xcontext.macro.params.width)
#set($class = $xcontext.macro.params.class)
#set($center = $xcontext.macro.params.center)
#set($ok = $services.localization.use('document', 'TodoLists.TodoListsTranslations'))
## Add js and css
#set($ok = $xwiki.jsx.use("TodoLists.TodoListMacro", { "minify" : false}))
#set($ok = $xwiki.ssx.use("TodoLists.TodoListMacro"))
{{html clean="false"}}
&lt;div id="todoappdiv" style="#if($width &amp;&amp; $width!="")width: ${width};#end #if($center=="1" || $center=="true")margin: auto;#end" #if($class &amp;&amp; $clazss!="") class="${class}" #end&gt;&lt;/div&gt;
&lt;script type="text/x-handlebars" data-template-name="todos"&gt;
&lt;section id="todoapp"&gt;
      &lt;header id="header"&gt;
        {{input type="text" id="new-todo" placeholder="${services.localization.render('todolists.whatneedstobedone')}" 
              value=newTitle action="createTodo"}}
      &lt;/header&gt;

&lt;section id="main"&gt;
  {{outlet}}
  {{input type="checkbox" id="toggle-all" checked=allAreDone}}
&lt;/section&gt;
     &lt;footer id="footer"&gt;
&lt;span id="todo-count"&gt;
  &lt;strong&gt;{{remaining}}&lt;/strong&gt; {{inflection}} left
&lt;/span&gt;
        &lt;ul id="filters"&gt;
&lt;li&gt;
  {{#link-to "todos.index" activeClass="selected"}}${services.localization.render('todolists.all')}{{/link-to}}
&lt;/li&gt;
&lt;li&gt;
  {{#link-to "todos.active" activeClass="selected"}}${services.localization.render('todolists.active')}{{/link-to}}
&lt;/li&gt;
&lt;li&gt;
  {{#link-to "todos.completed" activeClass="selected"}}${services.localization.render('todolists.completed')}{{/link-to}}
&lt;/li&gt;
        &lt;/ul&gt;
{{\#if hasCompleted}}
  &lt;button id="clear-completed" {{action "clearCompleted"}}&gt;
    ${services.localization.render('todolists.clearcompleted')} ({{completed}})
  &lt;/button&gt;
{{/if}}
      &lt;/footer&gt;
    &lt;/section&gt;
&lt;/script&gt;
&lt;script type="text/x-handlebars" data-template-name="todos/index"&gt;
  &lt;ul id="todo-list"&gt;
    {{#each itemController="todo"}}
      &lt;li {{bind-attr class="isCompleted:completed isEditing:editing"}}&gt;
        {{\#if isEditing}}
          {{edit-todo class="edit" value=title focus-out="acceptChanges" insert-newline="acceptChanges"}}
        {{else}}
          {{input type="checkbox" checked=isCompleted class="toggle"}}
          &lt;label {{action "editTodo" on="doubleClick"}}&gt;{{title}}&lt;/label&gt;
          &lt;button {{action "removeTodo"}} class="destroy"&gt;&lt;/button&gt;
        {{/if}}
      &lt;/li&gt;
    {{/each}}
  &lt;/ul&gt;
&lt;/script&gt;
{{/html}}
{{/velocity}}</code>
    </property>
    <property>
      <contentDescription>List of todos in format 
Text|1
Text|0
Text|0</contentDescription>
    </property>
    <property>
      <contentType>Optional</contentType>
    </property>
    <property>
      <defaultCategory>content</defaultCategory>
    </property>
    <property>
      <description>TodoList with Javascript UI</description>
    </property>
    <property>
      <id>todolist</id>
    </property>
    <property>
      <name>todolist</name>
    </property>
    <property>
      <supportsInlineMode>0</supportsInlineMode>
    </property>
    <property>
      <visibility>Current Wiki</visibility>
    </property>
  </object>
  <object>
    <name>TodoLists.TodoListMacro</name>
    <number>0</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>18e69281-58b1-4a2c-9c81-567720bcc4ce</guid>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
    </class>
    <property>
      <defaultValue/>
    </property>
    <property>
      <description>Width of the todolist area in percentage or pixels</description>
    </property>
    <property>
      <mandatory>0</mandatory>
    </property>
    <property>
      <name>width</name>
    </property>
  </object>
  <object>
    <name>TodoLists.TodoListMacro</name>
    <number>1</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>d8942386-3d6e-4000-80f4-b414fad7d9a4</guid>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
    </class>
    <property>
      <defaultValue/>
    </property>
    <property>
      <description>Style Class to be used</description>
    </property>
    <property>
      <mandatory>0</mandatory>
    </property>
    <property>
      <name>class</name>
    </property>
  </object>
  <object>
    <name>TodoLists.TodoListMacro</name>
    <number>2</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>c9e568af-a555-4e06-8df0-ef90514ea2ad</guid>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
    </class>
    <property>
      <defaultValue/>
    </property>
    <property>
      <description>Wether the macro should be centered or not (1 or true)</description>
    </property>
    <property>
      <mandatory>0</mandatory>
    </property>
    <property>
      <name>center</name>
    </property>
  </object>
</xwikidoc>
